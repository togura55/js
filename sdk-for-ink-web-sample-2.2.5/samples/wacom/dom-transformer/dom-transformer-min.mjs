import"js-ext";var t="1.0.3";class e{constructor(t,e){this.type=t,this.element=e}reset(t,e){throw new Error(`${this.type}: reset should be implemented`)}update(t){throw new Error(`${this.type}: update should be implemented`)}}class i extends e{constructor(t){super("translate",t)}reset(t,e){this.lastPoint={x:t.clientX,y:t.clientY}}update(t){let e={x:t.clientX-this.lastPoint.x,y:t.clientY-this.lastPoint.y};return this.lastPoint={x:t.clientX,y:t.clientY},e}}function s(t,e){let i,s={};return Object.defineProperty(s,"x",{value:e.x-t.x,enumerable:!0}),Object.defineProperty(s,"y",{value:e.y-t.y,enumerable:!0}),Object.defineProperty(s,"length",{get:()=>(isNaN(i)&&(i=Math.sqrt(s.x*s.x+s.y*s.y)),i),enumerable:!0}),s}function r(t,e){let i=t.x*e.x+t.y*e.y,s=t.x*e.y-t.y*e.x;return Math.atan2(s,i)}class n extends e{constructor(t){super("rotate",t)}reset(t,e){let i=this.element.getBoundingClientRect();this.center={x:i.left+i.width/2,y:i.top+i.height/2},this.centerToMouse=s(this.center,{x:t.clientX,y:t.clientY})}update(t){let e=s(this.center,{x:t.clientX,y:t.clientY}),i=r(this.centerToMouse,e);return this.centerToMouse=e,i}}const h={T:"top",B:"bottom",L:"left",R:"right",TL:"top-left",TR:"top-right",BL:"bottom-left",BR:"bottom-right"};class a extends e{constructor(t,e=!1,i=!1){super("scale",t),this.rotation=e,this.attachHandles(i)}attachHandles(t){let e=[];(t?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]).forEach((t=>{let i=document.createElement("div");i.className=`resize-handle ${h[t]}`,i.dataset.type=t,i.onmouseover=()=>this.updateCursor(i),this.element.appendChild(i),e.push(i)})),this.handles=e}reset(t,e,i){switch(this.origin=e,this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.zeroPoint=DOMPoint.fromPoint({x:0,y:0}),this.handleType=t.currentTarget.dataset.type,this.handleType){case"TL":this.point=DOMPoint.fromPoint({x:-i.width/2,y:-i.height/2});break;case"T":this.point=DOMPoint.fromPoint({x:0,y:-i.height/2});break;case"TR":this.point=DOMPoint.fromPoint({x:i.width/2,y:-i.height/2});break;case"R":this.point=DOMPoint.fromPoint({x:i.width/2,y:0});break;case"BR":this.point=DOMPoint.fromPoint({x:i.width/2,y:i.height/2});break;case"B":this.point=DOMPoint.fromPoint({x:0,y:i.height/2});break;case"BL":this.point=DOMPoint.fromPoint({x:-i.width/2,y:i.height/2});break;case"L":this.point=DOMPoint.fromPoint({x:-i.width/2,y:0})}this.excludeRotation=!this.rotation||0==this.point.x||0==this.point.y}update(t,e){let i=this.zeroPoint.transform(e),n=this.point.transform(e),h={x:2*i.x-n.x,y:2*i.y-n.y},a=t.clientX,o=t.clientY,l=s(h,{x:a-this.offsetParent.x-this.origin.x,y:o-this.offsetParent.y-this.origin.y}),m=s(h,n),c=this.excludeRotation?0:r(m,l),d=l.length/m.length;return 0==this.point.x?d={x:1,y:d}:0==this.point.y&&(d={x:d,y:1}),{rotate:c,scale:d,anchor:h,handleType:this.handleType}}updateCursor(t){let e,i=this.element.getTransformStyle().rotate.angle,s=t.dataset.type;"TR"==s||"BL"==s?i+=Math.PI/4:"TL"==s||"BR"==s?i+=3*Math.PI/4:"L"!=s&&"R"!=s||(i+=Math.PI/2),i<0?i+=2*Math.PI:i>2*Math.PI&&(i-=2*Math.PI),e=i>Math.PI/8&&i<=3*Math.PI/8||i>=9*Math.PI/8&&i<=11*Math.PI/8?"nesw-resize":i>3*Math.PI/8&&i<=5*Math.PI/8||i>=11*Math.PI/8&&i<=13*Math.PI/8?"ew-resize":i>5*Math.PI/8&&i<=7*Math.PI/8||i>=13*Math.PI/8&&i<=15*Math.PI/8?"nwse-resize":"ns-resize",t.style.cursor=e}}class o extends e{constructor(t,e=!1){super("pinch",t),this.rotation=e}reset(t,e){this.origin=e,this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.lastPinch=this.createPinch(t)}update(t){let e=this.createPinch(t),i=s(this.lastPinch[0],this.lastPinch[1]),n=s(e[0],e[1]),h=(this.lastPinch[0].x+this.lastPinch[1].x)/2,a=(this.lastPinch[0].y+this.lastPinch[1].y)/2,o={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},l={x:o.x-h,y:o.y-a},m=this.rotation?r(i,n):0,c=n.length/i.length,d={x:o.x-this.offsetParent.x-this.origin.x,y:o.y-this.offsetParent.y-this.origin.y};return this.lastPinch=e,{anchor:d,center:o,origin:this.origin,scale:c,rotation:m,translation:l}}createPinch(t){let e=[];return e[0]={x:t.touches[0].clientX,y:t.touches[0].clientY},e[1]={x:t.touches[1].clientX,y:t.touches[1].clientY},e}}class l{constructor(t,e){this.element=t,this.options=e,this.attachEvents()}reset(t){this.origin=t}detachEvents(){this.element.removeEventListener("touchstart",this.listener.begin),this.element.removeEventListener("touchmove",this.listener.move),this.element.removeEventListener("touchend",this.listener.end)}attachEvents(){let t=new o(this.element,this.options.rotate);this.listener={begin:this.begin.bind(this,t),move:this.move.bind(this,t),end:this.end.bind(this,t)},this.element.addEventListener("touchstart",this.listener.begin,{passive:!1}),this.element.addEventListener("touchmove",this.listener.move,{passive:!1}),this.element.addEventListener("touchend",this.listener.end,{passive:!1})}dispatchEvent(t,e){t.cancelable&&t.preventDefault(),t.stopPropagation();let i=t.type.replace("touch","pinch").replace("move",""),s=new CustomEvent(i,{detail:e});this.element.dispatchEvent(s)}begin(t,e){if(this.active||1==e.touches.length)return;let i=Array.from(e.touches).filter((t=>t.target==this.element||this.element.contains(t.target)));i.length<2||(this.active=i.map((t=>t.identifier)),this.origin||this.reset(this.element.toRect().center),t.reset(e,this.origin),this.dispatchEvent(e))}move(t,e){if(!this.active)return;let i,s=t.update(e);Object.defineProperty(s,"transform",{get:function(){return i||(i=new DOMMatrix,i.preMultiplySelf(DOMMatrix.fromRotate(this.rotation,this.anchor)),i.preMultiplySelf(DOMMatrix.fromScale(this.scale,this.anchor)),i.preMultiplySelf(DOMMatrix.fromTranslate(this.translation))),i}}),this.dispatchEvent(e,s)}end(t,e){!this.active||Array.from(e.touches).filter((t=>this.active.includes(t.identifier))).length>=2||(this.dispatchEvent(e),delete this.active)}}const m=[];let c={register(t,e={}){this.unregister(t);let i=new l(t,e);return this.debug&&(i.debug=!0),m.push(i),i},unregister(t){let e=m.filter((e=>e.element==t)).first;e&&(e.detachEvents(),m.remove(e))}};class d{constructor(t,e){this.element=t,this.options=e,e.minSize?this.minSize=DOMSize.fromSize(e.minSize):this.minSize=DOMSize.fromSize({width:e.minWidth||50,height:e.minHeight||50}),this.maxSize=e.maxSize?DOMSize.fromSize(e.maxSize):void 0,this.restrictiveArea=e.restrictiveArea,this.phase=d.Phase.END,this.attachEvents()}attachTransformFrame(){this.frame=document.createElement("div"),this.frame.dataset.name="origin-frame",this.frame.style.backgroundColor="rgba(0, 255, 0, 0.2)",this.frame.style.display=this.element.style.display,this.frame.style.position="absolute",this.viewFrame=document.createElement("div"),this.viewFrame.dataset.name="view-frame",this.viewFrame.style.backgroundColor="rgba(255, 0, 0, 0.2)",this.viewFrame.style.display=this.element.style.display,this.viewFrame.style.position="absolute","loading"===document.readyState?addEventListener("DOMContentLoaded",(t=>this.reset.bind(this))):this.reset(),this.element.parentNode.insertBefore(this.frame,this.element),this.element.parentNode.insertBefore(this.viewFrame,this.frame)}open(t,e,i){if(this.reset(t),this.element.style.display="",this.debug&&(this.frame.style.display=""),this.phase=d.Phase.READY,e&&!e.isIdentity){let t;i?(t=this.getOriginTransform(i.transform,i.origin),t.multiplySelf(e)):t=e,this.transform(t)}}close(){this.phase!=d.Phase.END&&(this.dispatchEvent(d.Phase.END),this.element.style.display="none",this.debug&&(this.frame.style.display="none"))}reset(t){let e;t?t=t.ceil(!0):(t=this.element.toRect(),e=DOMMatrix.fromMatrix(this.element.getStyle("transform")),this.phase=d.Phase.READY);let i=Math.max(t.width,this.minSize.width),s=Math.max(t.height,this.minSize.height);this.maxSize&&(i=Math.min(i,this.maxSize.width),s=Math.min(s,this.maxSize.height)),this.bounds=new DOMRect(t.x,t.y,i,s),this.origin=this.bounds.center,this.matrix=new DOMMatrix,this.matrix.multiplicationType=DOMMatrix.MultiplicationType.PRE,this.originTranslate=DOMMatrix.fromTranslate({x:-this.origin.x,y:-this.origin.y}),this.viewTranslate=DOMMatrix.fromTranslate(this.origin),this.pincher.reset(this.bounds.center),this.debug&&(this.frame.style.left=this.bounds.left+"px",this.frame.style.top=this.bounds.top+"px",this.frame.style.width=this.bounds.width+"px",this.frame.style.height=this.bounds.height+"px"),this.applyUI(),e&&!e.isIdentity&&this.transform(e)}applyUI(){let t=this.matrix.decompose(),e=this.bounds.width*t.scale.x,i=this.bounds.height*t.scale.y,s=this.origin.x-e/2+t.translate.x,r=this.origin.y-i/2+t.translate.y;if(this.element.style.left=s+"px",this.element.style.top=r+"px",this.element.style.width=e+"px",this.element.style.height=i+"px",0==t.rotate.angle?this.element.style.transform="":this.element.style.transform="rotate("+t.rotate.angle+"rad)",this.debug){this.frame.style.transform=this.matrix.toString();let t=this.getViewTransform(),e=this.bounds.transform(t);this.viewFrame.dataset.matrix=t.toString(),this.viewFrame.style.left=e.left+"px",this.viewFrame.style.top=e.top+"px",this.viewFrame.style.width=e.width+"px",this.viewFrame.style.height=e.height+"px"}}detachEvents(){this.listeners.forEach((t=>{if("pinch"==t.type)return this.element.removeEventListener("pinchstart",t.event.begin),this.element.removeEventListener("pinch",t.event.move),this.element.removeEventListener("pinchend",t.event.end),void c.unregister(this.element);t.triggers.forEach((e=>{e.removeEventListener("mousedown",t.event.begin),e.removeEventListener("touchstart",t.event.begin),"scale"==t.type&&e.remove()})),document.removeEventListener("mousemove",t.event.move),document.removeEventListener("touchmove",t.event.move),document.removeEventListener("mouseup",t.event.end),document.removeEventListener("touchend",t.event.end)}))}attachEvents(){this.listeners=[];let t={};if(this.options.translate){let e=new i(this.element),s=this.getEventHandlers(e),r=this.options.translateHandle||this.element;this.attachEvent(r,s),this.listeners.push({type:e.type,triggers:[r],event:s}),t.translate=e}if(this.options.rotate){let e=new n(this.element),i=this.getEventHandlers(e);this.options.rotateHandles.forEach((t=>this.attachEvent(t,i))),this.listeners.push({type:e.type,triggers:this.options.rotateHandles,event:i}),t.rotate=e}if(this.options.scale){let e=new a(this.element,this.options.rotate,this.options.keepRatio),i=this.getEventHandlers(e);e.handles.forEach((t=>this.attachEvent(t,i))),this.listeners.push({type:e.type,triggers:e.handles,event:i}),t.scale=e}this.pincher=c.register(this.element,this.options);let e={begin:function(e){this.active&&this.end(t[this.active]),this.active="pinch"}.bind(this),move:function(t){this.transform(t.detail.transform)}.bind(this),end:function(t){delete this.active}.bind(this)};this.element.addEventListener("pinchstart",e.begin),this.element.addEventListener("pinch",e.move),this.element.addEventListener("pinchend",e.end),this.listeners.push({type:"pinch",event:e})}getEventHandlers(t){return{begin:this.begin.bind(this,t),move:this.move.bind(this,t),end:this.end.bind(this,t)}}attachEvent(t,e){t.addEventListener("mousedown",e.begin),document.addEventListener("mousemove",e.move),document.addEventListener("mouseup",e.end),t.addEventListener("touchstart",e.begin,{passive:!1}),document.addEventListener("touchmove",e.move,{passive:!1}),document.addEventListener("touchend",e.end,{passive:!1})}dispatchEvent(t,e="transform",i){let s;this.phase=t,t==d.Phase.UPDATE?(s={type:e,transform:this.options.origin?this.matrix:this.getViewTransform(this.matrix)},this.options.delta&&i&&(s.delta=this.options.origin?i:this.getViewTransform(i))):t==d.Phase.BEGIN&&(s={origin:this.origin});let r=new CustomEvent(t,{detail:s});this.element.dispatchEvent(r)}getTransform(){return this.options.origin?this.matrix:this.getViewTransform(this.matrix)}getViewTransform(t=this.matrix){let e=new DOMMatrix;return e.multiplicationType=DOMMatrix.MultiplicationType.PRE,e.multiplySelf(this.originTranslate),e.multiplySelf(t),e.multiplySelf(this.viewTranslate),e}getOriginTransform(t,e=this.origin){let i=DOMMatrix.fromTranslate({x:-e.x,y:-e.y}),s=DOMMatrix.fromTranslate(e),r=DOMMatrix.fromMatrix(t,DOMMatrix.MultiplicationType.PRE);return r.postMultiplySelf(s),r.preMultiplySelf(i),r}fixE(t){if(t.preventDefault(),t.stopPropagation(),t.changedTouches){let e;"touchstart"==t.type?(e=t.changedTouches[0],this.touchID=e.identifier):e=Array.from(t.changedTouches).filter((t=>t.identifier==this.touchID)).first,e&&(e.currentTarget=e.target),t=e}return t}begin(t,e){isFinite(e.button)&&0!=e.button||this.active||(e=this.fixE(e),"translate"==t.type&&e.currentTarget==this.element&&(this.element.style.cursor="move"),t.reset(e,this.origin,this.bounds.size),this.active=t.type)}move(t,e){if(this.active!=t.type)return;if(!(e=this.fixE(e)))return;let i=t.update(e,this.matrix);switch(this.handleType=i.handleType,t.type){case"translate":this.translate(i);break;case"rotate":this.rotate(i);break;case"scale":this.rotate(i.rotate,i.anchor),this.scale(i.scale,i.anchor)}}end(t,e){this.active==t.type&&(e&&!(e=this.fixE(e))||("translate"==t.type&&"move"==this.element.style.cursor&&(this.element.style.cursor=""),delete this.touchID,delete this.active))}translate(t){if(this.phase==d.Phase.END)return;if(isFinite(t)&&(t={x:t,y:t}),0==t.x&&0==t.y)return;let e=DOMMatrix.fromTranslate(t);this.transform(e,"translate")}rotate(t,e){if(this.phase==d.Phase.END)return;if(0==t)return;e||(e=this.getAnchor());let i=DOMMatrix.fromRotate(t,e);this.transform(i,"rotate")}scale(t,e){if(this.phase==d.Phase.END)return;if(isFinite(t)&&(t={x:t,y:t}),1==t.x&&1==t.y)return;e||(e=this.getAnchor());let i=DOMMatrix.fromScale(t,e);this.transform(i,"scale")}transform(t,e="transform"){t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t)),t.multiplicationType=this.matrix.multiplicationType;let i=this.matrix.multiply(t);if("scale"==e||"transform"==e){let t=i.decompose().scale,e=this.bounds.width*t.x,s=this.bounds.height*t.y;(e<this.minSize.width||s<this.minSize.height||this.maxSize&&(e>this.maxSize.width||s>this.maxSize.height))&&(i=null)}i&&(i=this.normalizeTransform(i)),i&&(this.matrix=i,this.applyUI(),t.isIdentity||(this.phase==d.Phase.READY&&this.dispatchEvent(d.Phase.BEGIN,e),this.dispatchEvent(d.Phase.UPDATE,e,t)))}normalizeTransform(t){if(!this.restrictiveArea)return t;let e=this.getViewTransform(t),i=new DOMPoint(this.bounds.left,this.bounds.top),s=new DOMPoint(this.bounds.right,this.bounds.top),r=new DOMPoint(this.bounds.right,this.bounds.bottom),n=new DOMPoint(this.bounds.left,this.bounds.bottom),h=i.transform(e),a=s.transform(e),o=r.transform(e),l=n.transform(e);if(this.handleType&&(!this.restrictiveArea.contains(h)||!this.restrictiveArea.contains(a)||!this.restrictiveArea.contains(o)||!this.restrictiveArea.contains(l)))return;let m=Math.min(h.x,a.x,o.x,l.x),c=Math.max(h.x,a.x,o.x,l.x),d=Math.min(h.y,a.y,o.y,l.y),p=Math.max(h.y,a.y,o.y,l.y),u=c-m,f=p-d,y=this.restrictiveArea.right-this.restrictiveArea.left,v=this.restrictiveArea.bottom-this.restrictiveArea.top,x=1,g=1;u>y&&(x=y/u),f>v&&(g=v/f);let M=Math.min(x,g);if(1!=M){let t=DOMMatrix.fromScale(M,this.getAnchor());h=h.transform(t),a=a.transform(t),o=o.transform(t),l=l.transform(t)}m=Math.min(h.x,a.x,o.x,l.x),c=Math.max(h.x,a.x,o.x,l.x),d=Math.min(h.y,a.y,o.y,l.y),p=Math.max(h.y,a.y,o.y,l.y);let P=0,b=0;m<this.restrictiveArea.left?P=this.restrictiveArea.left-m:c>this.restrictiveArea.left+this.restrictiveArea.width&&(P=this.restrictiveArea.left+this.restrictiveArea.width-c),d<this.restrictiveArea.top?b=this.restrictiveArea.top-d:p>this.restrictiveArea.top+this.restrictiveArea.height&&(b=this.restrictiveArea.top+this.restrictiveArea.height-p);let E=DOMMatrix.fromMatrix({tx:P,ty:b});h=h.transform(E),a=a.transform(E),o=o.transform(E),l=l.transform(E);let w=DOMMatrix.fromPoints([i,s,r],[h,a,o]);return this.getOriginTransform(w)}getAnchor(){return{x:this.matrix.tx,y:this.matrix.ty}}}d.Phase={READY:"ready",BEGIN:"transformstart",UPDATE:"transform",END:"transformend"};const p=[];let u=!1,f={register(t,e={}){if(!e.translate&&!e.scale&&!e.rotate)throw new Error("At least one of translate, scale and rotate is required");if(e.rotate){if(!e.rotateHandles)throw new Error("When rotate is available, rotateHandles option is required");if(0==e.rotateHandles.length)throw new Error("When rotate is available, at least one handle is required")}this.unregister(t);let i=new d(t,e);return u&&(i.debug=!0,i.attachTransformFrame()),p.push(i),i},unregister(t){let e=p.filter((e=>e.element==t)).first;e&&(e.detachEvents(),p.remove(e))}};Object.defineProperty(f,"debug",{get:function(){return u},set:function(t){u=t,c.debug=t},enumerable:!0});export{c as PinchEvent,f as TransformEvent,t as version};
