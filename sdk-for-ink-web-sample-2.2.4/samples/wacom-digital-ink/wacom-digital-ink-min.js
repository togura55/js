!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).DigitalInk={})}(this,(function(t){"use strict";"undefined"==typeof ClipperLib&&console.warn("digital-ink dependency clipper-lib not found, expected in global scope"),"undefined"==typeof poly2tri&&console.warn("digital-ink dependency poly2tri not found, expected in global scope"),"undefined"==typeof protobuf&&console.warn("digital-ink dependency protobufjs not found, expected in global scope"),"undefined"==typeof md5&&console.warn("digital-ink dependency js-md5 not found, expected in global scope");var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(t,e,r){return t(r={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&r.path)}},r.exports),r.exports}var n=r((function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e})),i=r((function(t){var e=function(t){var e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function s(t,e,r,n){var i=e&&e.prototype instanceof l?e:l,o=Object.create(i.prototype),a=new P(n||[]);return o._invoke=function(t,e,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return k()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=b(a,r);if(s){if(s===c)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=u(t,e,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}(t,r,a),o}function u(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=s;var c={};function l(){}function h(){}function f(){}var d={};d[i]=function(){return this};var p=Object.getPrototypeOf,y=p&&p(p(w([])));y&&y!==e&&r.call(y,i)&&(d=y);var v=f.prototype=l.prototype=Object.create(d);function g(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function m(t,e){var n;this._invoke=function(i,o){function a(){return new e((function(n,a){!function n(i,o,a,s){var c=u(t[i],t,o);if("throw"!==c.type){var l=c.arg,h=l.value;return h&&"object"==typeof h&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(h).then((function(t){l.value=t,a(l)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}(i,o,n,a)}))}return n=n?n.then(a,a):a()}}function b(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return c;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var n=u(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,c;var i=n.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,c):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function E(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(E,this),this.reset(!0)}function w(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:k}}function k(){return{value:void 0,done:!0}}return h.prototype=v.constructor=f,f.constructor=h,f[a]=h.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,a in t||(t[a]="GeneratorFunction")),t.prototype=Object.create(v),t},t.awrap=function(t){return{__await:t}},g(m.prototype),m.prototype[o]=function(){return this},t.AsyncIterator=m,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new m(s(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},g(v),v[a]="Generator",v[i]=function(){return this},v.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=w,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return a.type="throw",a.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(s&&u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),x(r),c}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;x(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:w(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),c}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}));function o(t,e,r,n,i,o,a){try{var s=t[o](a),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,i)}var a=function(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var a=t.apply(e,r);function s(t){o(a,n,i,s,u,"next",t)}function u(t){o(a,n,i,s,u,"throw",t)}s(void 0)}))}};"undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:void 0!==e&&(e.globalThis=e)),String.prototype.contains||(String.prototype.contains=function(t){return-1!=this.indexOf(t)}),String.prototype.startsWith||(String.prototype.startsWith=function(t){return this.length>=t.length&&this.substring(0,t.length)==t}),String.prototype.endsWith||(String.prototype.endsWith=function(t){return this.length>=t.length&&this.substring(this.length-t.length,this.length)==t}),String.prototype.charsCode=function(){return this.split("").reduce((function(t,e){return t+e.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(t){return-1!=this.toUpperCase().indexOf(t.toUpperCase())},String.prototype.toCharArray=function(t){for(var e=t?new Uint8Array(this.length):new Array(this.length),r=0;r<this.length;r++){var n=this.charCodeAt(r);n>255&&(e.bytes=!1),e[r]=n}return e},String.fromCharArray=function(t){var e="";try{e=String.fromCharCode.apply(null,t)}catch(n){for(var r=0;r<t.length;r++)e+=String.fromCharCode(t[r])}return e},String.prototype.pad=function(t,e){return this.length<t?new Array(t-this.length+1).join(e||"-")+this:this.toString()},Number.prototype.pad=function(t){return String(this).length<t?new Array(t-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){var t=new Float32Array(1);return t[0]=this,t[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(t){return this.indexOf(t)>-1},Array.prototype.clone=function(){return this.map((function(t){return Object.clone(t)}))},Array.prototype.unique=function(){var t=this;return this.filter((function(e,r){return t.indexOf(e)==r}))},Array.prototype.add=function(t){if(!this.contains(t))return this.push(t)},Array.prototype.insert=function(t,e){this.splice(t,0,e)},Array.prototype.remove=function(t){return this.removeAt(this.indexOf(t))},Array.prototype.removeAt=function(t){return t>-1&&this.splice(t,1),this},Array.prototype.replace=function(t,e,r){var n=this.indexOf(t);if(n>-1)if(!r&&e instanceof Array){for(var i=[n,1],o=0;o<e.length;o++)i.push(e[o]);this.splice.apply(this,i)}else this.splice(n,1,e);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach((function(t){var e=globalThis[t+"Array"];e?(e.from?Array.prototype["to"+t+"Array"]=function(){return e.from(this)}:Array.prototype["to"+t+"Array"]=function(){return new e(this)},Array.from?e.prototype.toArray=function(){return Array.from(this)}:e.prototype.toArray=function(){return Array.prototype.slice.call(this)},e.prototype.clone=function(){if("undefined"!=typeof SharedArrayBuffer&&this.buffer instanceof SharedArrayBuffer){var t=new SharedArrayBuffer(this.byteLength),r=new e(t);return r.set(this,this.byteOffset),r}return new e(this,this.byteOffset,this.length)},e.prototype.concat=function(){for(var t=this,e=this.length,r=this.length,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];i.forEach((function(r){if(t.constructor!=r.constructor)throw new Error("Concat array from wrong type detected - expected ".concat(t.constructor.name,", found ").concat(r.constructor.name));e+=r.length}));var a=new this.constructor(e);return a.set(this),i.forEach((function(t){a.set(t,r),r+=t.length})),a}):console.warn(t+"Array not found")}))},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(t,e){e||(e=function(){});var r=e.getArguments(),n=new Function("body","return function "+t+"("+r+") {return body.apply(this, arguments);};")(e);return n.toString=function(){return e.toString()},n.toSource=function(){return e.toSource()},n},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){var t=this.toString().match(/^function\s([\w$]+)/);return t?t[1]:""}}),Function.prototype.getArguments=function(){var t=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==t.length?[]:t.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(t){var e=arguments.callee.caller.arguments;this.getArguments().forEach((function(t,r){this[t]=e[r]}),t)},Function.prototype.createEnum=function(t,e){var r=this;if(this[t])throw new Error("Already exists key: "+t);this[t]=new Object;for(var n=[],i=function(i){var o,a=t+"_"+e[i],s=r[t];s[e[i]]=(o=Object.create(Object.prototype,{constructor:{value:Function.create(a)},type:{value:t},name:{value:e[i]},value:{value:i}}),Object.defineProperty(s,i,{get:function(){return o}}),o),n.push(s[e[i]])},o=0;o<e.length;o++)i(o);Object.defineProperty(this[t],"values",{value:n})},"undefined"==typeof AsyncFunction&&Object.defineProperty(globalThis,"AsyncFunction",{value:Object.getPrototypeOf(a(i.mark((function t(){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})))).constructor}),Object.equals=function(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;if(t instanceof Array||ArrayBuffer.isTypedArray(t))return t.length==e.length&&t.every((function(t,r){return Object.equals(t,e[r])}));for(var r in t)if(t.hasOwnProperty(r)){if(!e.hasOwnProperty(r))return!1;if(t[r]!==e[r]){if("object"!==n(t[r]))return!1;if(!Object.equals(t[r],e[r]))return!1}}for(var i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},Object.clone=function(t,e){var r=new Array;return function t(i){if(null===i)return null;if("object"!==n(i)||i.mutable)return i;if("function"==typeof i.clone)return i.clone();for(var o=0;o<r.length;o++)if(r[o][0]===i)return r[o][1];var a=Object.create(Object.getPrototypeOf(i));for(var s in r.push([i,a]),i)e&&"function"==typeof i[s]||i.hasOwnProperty(s)&&(a[s]=t(i[s]));return a}(t)},Object.toSource=function(t,e){if(t&&"object"==n(t)){var r=[];for(var i in t)t.hasOwnProperty(i)&&r.push("".concat(i,": ").concat(Object.toSource(t[i])));return(e?"".concat(e," = "):"")+"{"+r.join(", ")+"};"}if("function"==typeof t){var o=t.toString();return 0!=o.indexOf("function")&&(o="function "+o),o}return t},Object.nameAnonymousFunctions=function(t,e){for(var r in t)"function"!=typeof t[r]||t[r].name||("constructor"==r&&e?Object.defineProperty(t[r],"name",{value:e}):Object.defineProperty(t[r],"name",{value:r}))},JSON.toBase64=function(t){return btoa(JSON.stringify(t))},JSON.fromBase64=function(t){return JSON.parse(atob(t))},JSON.encode=function(t){return JSON.toBase64(t).toCharArray(!0)},JSON.decode=function(t){var e=String.fromCharArray(t);return JSON.fromBase64(e)},Math.toDegrees=function(t){return t*(180/this.PI)},Math.toRadians=function(t){return t*(this.PI/180)},Math.randomInt=function(t,e){return Math.floor(this.random()*(e-t+1))+t},"function"==typeof Worker&&(Worker.prototype.on=function(t,e){this["on".concat(t)]=function(r){var n="message"==t?r.data:r;e(n)}}),"function"==typeof DedicatedWorkerGlobalScope&&(DedicatedWorkerGlobalScope.prototype.on=function(t,e){this["on".concat(t)]=function(r){var n="message"==t?r.data:r;e(n)}}),"object"===("undefined"==typeof window?"undefined":n(window))&&(HTMLElement.prototype.getInlineStyle=function(t){return this.style[t]||this.style["-webkit-"+t]||this.style["-khtml-"+t]||this.style["-moz-"+t]||this.style["-ms-"+t]||this.style["-o-"+t]||""},HTMLElement.prototype.setStyle=function(t,e){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(r){this.style[r+"-"+t]=e}),this),this.style[t]=e},HTMLElement.prototype.getStyle=function(t){var e=t,r=t.startsWith("-");r&&(e=t.substring(1));for(var n=e.split("-"),i=n.length-1;i>0;i--)n[i]=n[i].substring(0,1).toUpperCase()+n[i].substring(1);e=n.join("");var o=this.style.display,a=this.style.visibility;"none"==o&&(this.style.visibility="hidden",this.style.display="");var s=window.getComputedStyle(this)[e];if(!r&&void 0===s)for(var u=["-webkit","-khtml","-moz","-ms","-o"],c=0;c<u.length&&"undefined"==(s=this.getStyle(u[c]+"-"+t));c++);return"none"==o&&(this.style.visibility=a,this.style.display="none"),s},HTMLElement.prototype.getMathStyle=function(t,e){var r=e?this.getInlineStyle(t):this.getStyle(t);return"auto"==r&&(r=0),parseFloat(r)},HTMLElement.prototype.getTransformStyle=function(){var t={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},e=this.getStyle("transform");if("none"!=e){var r=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),n=parseFloat(r[0]),i=parseFloat(r[1]),o=parseFloat(r[2]),a=parseFloat(r[3]),s=parseFloat(r[4]),u=parseFloat(r[5]);t.scale={x:Math.sqrt(n*n+o*o),y:Math.sqrt(a*a+i*i)},t.skew={angleX:Math.tan(o),angleY:Math.tan(i)},t.rotate={angle:Math.atan2(i,n)},t.translate={x:s,y:u},t.matrix={a:n,b:i,c:o,d:a,tx:s,ty:u}}return t},HTMLElement.prototype.toRect=function(){var t=this.style.display,e=this.style.visibility;"none"==t&&(this.style.visibility="hidden",this.style.display="");var r=this.offsetWidth,n=this.offsetHeight,i=this.offsetLeft,o=this.offsetTop,a=i+r,s=o+n,u=(i+a)/2,c=(o+s)/2,l=r/2,h=n/2,f=r+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),d=n+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom");return"none"==t&&(this.style.visibility=e,this.style.display="none"),Object.defineProperties({},{left:{value:i,enumerable:!0},top:{value:o,enumerable:!0},right:{value:a,enumerable:!0},bottom:{value:s,enumerable:!0},x:{value:i,enumerable:!0},y:{value:o,enumerable:!0},width:{value:r,enumerable:!0},height:{value:n,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},origin:{value:{x:l,y:h},enumerable:!0},size:{value:{width:r,height:n},enumerable:!0},outerSize:{value:{width:f,height:d},enumerable:!0}})},HTMLImageElement.prototype.toDataURL=function(t){var e=document.createElement("canvas");return e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0),e.toDataURL(t||"image/png")},HTMLImageElement.prototype.toBlob=function(t){return new Blob([this.getBytes(t).buffer],{type:t||"image/png"})},HTMLImageElement.prototype.getBytes=function(t){var e=this.toDataURL(t).split(",")[1];return atob(e).toCharArray(!0)},Image.fromBytes=function(t,e,r){var n=new Image;return n.onload=function(){URL.revokeObjectURL(this.src),e&&e.call(this)},n.src=URL.createObjectURL(new Blob([t.buffer||t],{type:"image/"+(r||"png")})),n},CanvasRenderingContext2D.prototype.clearCanvas=function(t){this.clearRect(0,0,this.canvas.width,this.canvas.height),t&&(this.fillStyle=t,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,r},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}var t=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}var t=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}));var s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function u(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var c=function(t,e,r){return e&&u(t.prototype,e),r&&u(t,r),t},l=function(){function t(){s(this,t)}return c(t,[{key:"getInkBuilder",value:function(t){throw new Error("InkController.getInkBuilder(pointerID) should be implemented")}},{key:"registerInputProvider",value:function(t,e){throw new Error("InkController.registerInputProvider(pointerID, isPrimary) should be implemented")}},{key:"reset",value:function(t){throw new Error("InkController.reset(sensorPoint) should be implemented")}},{key:"begin",value:function(t){throw new Error("InkController.begin(sensorPoint) should be implemented")}},{key:"move",value:function(t){throw new Error("InkController.move(sensorPoint) should be implemented")}},{key:"end",value:function(t){throw new Error("InkController.end(sensorPoint) should be implemented")}},{key:"abort",value:function(t){throw new Error("InkController.abort(pointerID) should be implemented")}},{key:"resize",value:function(){throw new Error("InkController.resize() should be implemented")}}]),t}();var h=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t},f=r((function(t){function e(r,n){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(r,n)}t.exports=e}));var d=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&f(t,e)};var p=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t};var y=function(t,e){return!e||"object"!==n(e)&&"function"!=typeof e?p(t):e},v=r((function(t){function e(r){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(r)}t.exports=e}));var g=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")};var m=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}},b=r((function(t){function e(r,n,i){return m()?t.exports=e=Reflect.construct:t.exports=e=function(t,e,r){var n=[null];n.push.apply(n,e);var i=new(Function.bind.apply(t,n));return r&&f(i,r.prototype),i},e.apply(null,arguments)}t.exports=e})),E=r((function(t){function e(r){var n="function"==typeof Map?new Map:void 0;return t.exports=e=function(t){if(null===t||!g(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(t))return n.get(t);n.set(t,e)}function e(){return b(t,arguments,v(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),f(e,t)},e(r)}t.exports=e}));Object.defineProperty(globalThis,"DIGITAL_INK_ENV",{value:"AUTO",enumerable:!0,configurable:!0});var x={version:"1.2.0"};Function.prototype.createEnum.call(x,"Type",["WEB","WORKER","NODE","SHELL"]),Function.prototype.createEnum.call(x,"Type2D",["SCREEN","OFFSCREEN"]),Function.prototype.createEnum.call(x,"TypeGL",["WEB","STACK"]),function(t){var e,r="BROWSER"!=DIGITAL_INK_ENV&&"object"===("undefined"==typeof process?"undefined":n(process))&&"function"==typeof require;e="object"===("undefined"==typeof window?"undefined":n(window))?"WEB":"function"==typeof importScripts?"WORKER":r?"NODE":"SHELL";var i="undefined"==typeof OffscreenCanvas?"OFFSCREEN":"SCREEN",o="undefined"==typeof WebGLRenderingContext?"STACK":"WEB";Object.defineProperty(x,"commonJS",{value:r,enumerable:!0}),Object.defineProperty(x,"type",{value:x.Type[e],enumerable:!0}),Object.defineProperty(x,"type2D",{value:x.Type2D[i],enumerable:!0}),Object.defineProperty(x,"typeGL",{value:x.TypeGL[o],enumerable:!0})}();var P=x.commonJS?require("js-md5"):md5,w=x.commonJS?require("long"):Long,k={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate:function(){var t=Date.now();return this.mask.replace(/[xy]/g,(function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?r:3&r|8).toString(16)}))},fromString:function(t){return this.fromBytes(new Uint8Array(P.arrayBuffer(t)))},toBytes:function(t){var e=[];return t.split("-").map((function(t,r){(r<3?t.match(/.{1,2}/g).reverse():t.match(/.{1,2}/g)).map((function(t){return e.push(parseInt(t,16))}))})),new Uint8Array(e)},fromBytes:function(t){var e=Array.from(t).map((function(t){return t.toString(16)})).map((function(t){return(1==t.length?"0":"")+t}));return e.slice(0,4).reverse().join("")+"-"+e.slice(4,6).reverse().join("")+"-"+e.slice(6,8).reverse().join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")},toUint32Array:function(t){var e=new Uint32Array(4),r=this.toBytes(t);return e[0]=new Uint32Array(r.slice(0,4).buffer)[0],e[1]=new Uint32Array(r.slice(4,8).buffer)[0],e[2]=new Uint32Array(r.slice(8,12).buffer)[0],e[3]=new Uint32Array(r.slice(12).buffer)[0],e},fromUint32Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toUint64Array:function(t){var e=new BigUint64Array(2),r=this.toBytes(t);return e[0]=new BigUint64Array(r.slice(0,8).buffer)[0],e[1]=new BigUint64Array(r.slice(8).buffer)[0],e},fromUint64Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toLongArray:function(t){var e=new Array(2),r=this.toBytes(t);return e[0]=w.fromBytes(r.slice(0,8)),e[1]=w.fromBytes(r.slice(8)),e},fromLongArray:function(t){var e=t[0].toBytes().concat(t[1].toBytes());return this.fromBytes(e)}};function R(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return S(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return S(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function S(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var I=function(){function t(e){var r=this;s(this,t),Object.defineProperty(this,"id",{get:function(){return e||(e=this.resolveID()),e},set:function(t){var r=e;e=t,this.updateID(r,e)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:function(){return"function"==typeof r.getMD5Message?t.Algorithm.MD5:t.Algorithm.GUID},enumerable:!0})}return c(t,null,[{key:"SEPARATOR",get:function(){return"\n"}}]),c(t,[{key:"resolveID",value:function(){if(this.algorithm==t.Algorithm.MD5){var e,r="",n=R(this.getMD5Message());try{for(n.s();!(e=n.n()).done;){var i=e.value;if(Array.isArray(i)){var o,a=R(i);try{for(a.s();!(o=a.n()).done;){r+=o.value,r+="\n"}}catch(t){a.e(t)}finally{a.f()}}else r+=i;r+="\n"}}catch(t){n.e(t)}finally{n.f()}if(!r)throw new Error("Empty MD5 message container found");return P(r)}return k.generate()}},{key:"updateID",value:function(t,e){}},{key:"invalidateID",value:function(){this.id=void 0}}],[{key:"getMD5Tokens",value:function(t){var e=[];return Object.keys(t).sort().forEach((function(r){return e.push(r,t[r])})),e}}]),t}();function T(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}I.createEnum("Algorithm",["GUID","MD5"]);var A=function(t){d(r,t);var e=T(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s(this,r),(n=e.call(this)).type=t,n.props=Object.assign({},i),n}return c(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,I.getMD5Tokens(this.props)]}}]),r}(I);A.createEnum("Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);var C=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n};var O=function(t){if(Array.isArray(t))return C(t)};var M=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var D=function(t,e){if(t){if("string"==typeof t)return C(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?C(t,e):void 0}};var N=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var L=function(t){return O(t)||M(t)||D(t)||N()},_=function(){function t(){s(this,t),this.path=[],this.phase=t.Phase.END;var e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return c(t,[{key:"add",value:function(e,r,n){var i;if(!this.move(e))throw new Error("Cannot move from phase ".concat(this.phase.name," to phase ").concat(e.name));var o=this.addImpl(r,n);return this.keepAllData&&(i=this.path).push.apply(i,L(o.added)),{added:this.getOutput(o.added,t.OutputType.ADDITION),predicted:this.getOutput(o.predicted,t.OutputType.PREDICTION)}}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"move",value:function(e){return(this.phase!=t.Phase.END||e==t.Phase.BEGIN)&&((this.phase!=t.Phase.BEGIN||e==t.Phase.UPDATE||e==t.Phase.END)&&((this.phase!=t.Phase.UPDATE||e==t.Phase.UPDATE||e==t.Phase.END)&&(e==t.Phase.BEGIN&&this.reset(),this.phase=e,!0)))}},{key:"reset",value:function(){this.path.clear(),this.phase=t.Phase.END}}]),t}();_.createEnum("Phase",["BEGIN","UPDATE","END"]),_.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA"]);var B="undefined"!=typeof Float32Array?Float32Array:Array,F=Math.random;function U(){var t=new B(16);return B!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function j(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],c=e[7],l=e[8],h=e[9],f=e[10],d=e[11],p=e[12],y=e[13],v=e[14],g=e[15],m=r*s-n*a,b=r*u-i*a,E=r*c-o*a,x=n*u-i*s,P=n*c-o*s,w=i*c-o*u,k=l*y-h*p,R=l*v-f*p,S=l*g-d*p,I=h*v-f*y,T=h*g-d*y,A=f*g-d*v,C=m*A-b*T+E*I+x*S-P*R+w*k;return C?(C=1/C,t[0]=(s*A-u*T+c*I)*C,t[1]=(i*T-n*A-o*I)*C,t[2]=(y*w-v*P+g*x)*C,t[3]=(f*P-h*w-d*x)*C,t[4]=(u*S-a*A-c*R)*C,t[5]=(r*A-i*S+o*R)*C,t[6]=(v*E-p*w-g*b)*C,t[7]=(l*w-f*E+d*b)*C,t[8]=(a*T-s*S+c*k)*C,t[9]=(n*S-r*T-o*k)*C,t[10]=(p*P-y*E+g*m)*C,t[11]=(h*E-l*P-d*m)*C,t[12]=(s*R-a*I-u*k)*C,t[13]=(r*I-n*R+i*k)*C,t[14]=(y*b-p*x-v*m)*C,t[15]=(l*x-h*b+f*m)*C,t):null}function G(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],l=e[7],h=e[8],f=e[9],d=e[10],p=e[11],y=e[12],v=e[13],g=e[14],m=e[15],b=r[0],E=r[1],x=r[2],P=r[3];return t[0]=b*n+E*s+x*h+P*y,t[1]=b*i+E*u+x*f+P*v,t[2]=b*o+E*c+x*d+P*g,t[3]=b*a+E*l+x*p+P*m,b=r[4],E=r[5],x=r[6],P=r[7],t[4]=b*n+E*s+x*h+P*y,t[5]=b*i+E*u+x*f+P*v,t[6]=b*o+E*c+x*d+P*g,t[7]=b*a+E*l+x*p+P*m,b=r[8],E=r[9],x=r[10],P=r[11],t[8]=b*n+E*s+x*h+P*y,t[9]=b*i+E*u+x*f+P*v,t[10]=b*o+E*c+x*d+P*g,t[11]=b*a+E*l+x*p+P*m,b=r[12],E=r[13],x=r[14],P=r[15],t[12]=b*n+E*s+x*h+P*y,t[13]=b*i+E*u+x*f+P*v,t[14]=b*o+E*c+x*d+P*g,t[15]=b*a+E*l+x*p+P*m,t}function Y(t,e,r){var n,i,o,a,s,u,c,l,h,f,d,p,y=r[0],v=r[1],g=r[2];return e===t?(t[12]=e[0]*y+e[4]*v+e[8]*g+e[12],t[13]=e[1]*y+e[5]*v+e[9]*g+e[13],t[14]=e[2]*y+e[6]*v+e[10]*g+e[14],t[15]=e[3]*y+e[7]*v+e[11]*g+e[15]):(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],l=e[7],h=e[8],f=e[9],d=e[10],p=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=c,t[7]=l,t[8]=h,t[9]=f,t[10]=d,t[11]=p,t[12]=n*y+s*v+h*g+e[12],t[13]=i*y+u*v+f*g+e[13],t[14]=o*y+c*v+d*g+e[14],t[15]=a*y+l*v+p*g+e[15]),t}function z(t,e,r,n,i,o,a){var s=1/(e-r),u=1/(n-i),c=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*s,t[13]=(i+n)*u,t[14]=(a+o)*c,t[15]=1,t}function X(){var t=new B(3);return B!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function V(t){var e=t[0],r=t[1],n=t[2];return Math.hypot(e,r,n)}function H(t,e,r){var n=new B(3);return n[0]=t,n[1]=e,n[2]=r,n}function q(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function Z(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function W(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function K(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.hypot(r,n,i)}function J(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}function Q(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n}function $(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var tt,et=q,rt=Z,nt=W,it=K,ot=J,at=V,st=Q,ut=(tt=X(),function(t,e,r,n,i,o){var a,s;for(e||(e=3),r||(r=0),s=n?Math.min(n*e+r,t.length):t.length,a=r;a<s;a+=e)tt[0]=t[a],tt[1]=t[a+1],tt[2]=t[a+2],i(tt,tt,o),t[a]=tt[0],t[a+1]=tt[1],t[a+2]=tt[2];return t}),ct=Object.freeze({__proto__:null,create:X,clone:function(t){var e=new B(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:V,fromValues:H,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtract:q,multiply:Z,divide:W,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},scaleAndAdd:function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t},distance:K,squaredDistance:J,squaredLength:Q,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:function(t,e){var r=e[0],n=e[1],i=e[2],o=r*r+n*n+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t},dot:$,cross:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],u=r[2];return t[0]=i*u-o*s,t[1]=o*a-n*u,t[2]=n*s-i*a,t},lerp:function(t,e,r,n){var i=e[0],o=e[1],a=e[2];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t[2]=a+n*(r[2]-a),t},hermite:function(t,e,r,n,i,o){var a=o*o,s=a*(2*o-3)+1,u=a*(o-2)+o,c=a*(o-1),l=a*(3-2*o);return t[0]=e[0]*s+r[0]*u+n[0]*c+i[0]*l,t[1]=e[1]*s+r[1]*u+n[1]*c+i[1]*l,t[2]=e[2]*s+r[2]*u+n[2]*c+i[2]*l,t},bezier:function(t,e,r,n,i,o){var a=1-o,s=a*a,u=o*o,c=s*a,l=3*o*s,h=3*u*a,f=u*o;return t[0]=e[0]*c+r[0]*l+n[0]*h+i[0]*f,t[1]=e[1]*c+r[1]*l+n[1]*h+i[1]*f,t[2]=e[2]*c+r[2]*l+n[2]*h+i[2]*f,t},random:function(t,e){e=e||1;var r=2*F()*Math.PI,n=2*F()-1,i=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*i,t[1]=Math.sin(r)*i,t[2]=n*e,t},transformMat4:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[3]*n+r[7]*i+r[11]*o+r[15];return a=a||1,t[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])/a,t[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])/a,t[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])/a,t},transformMat3:function(t,e,r){var n=e[0],i=e[1],o=e[2];return t[0]=n*r[0]+i*r[3]+o*r[6],t[1]=n*r[1]+i*r[4]+o*r[7],t[2]=n*r[2]+i*r[5]+o*r[8],t},transformQuat:function(t,e,r){var n=r[0],i=r[1],o=r[2],a=r[3],s=e[0],u=e[1],c=e[2],l=i*c-o*u,h=o*s-n*c,f=n*u-i*s,d=i*f-o*h,p=o*l-n*f,y=n*h-i*l,v=2*a;return l*=v,h*=v,f*=v,d*=2,p*=2,y*=2,t[0]=s+l+d,t[1]=u+h+p,t[2]=c+f+y,t},rotateX:function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[0],o[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),o[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},rotateY:function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),o[1]=i[1],o[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},rotateZ:function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),o[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),o[2]=i[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},angle:function(t,e){var r=t[0],n=t[1],i=t[2],o=e[0],a=e[1],s=e[2],u=Math.sqrt(r*r+n*n+i*i)*Math.sqrt(o*o+a*a+s*s),c=u&&$(t,e)/u;return Math.acos(Math.min(Math.max(c,-1),1))},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,e){var r=t[0],n=t[1],i=t[2],o=e[0],a=e[1],s=e[2];return Math.abs(r-o)<=1e-6*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-a)<=1e-6*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-s)<=1e-6*Math.max(1,Math.abs(i),Math.abs(s))},sub:et,mul:rt,div:nt,dist:it,sqrDist:ot,len:at,sqrLen:st,forEach:ut});function lt(){var t=new B(4);return B!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function ht(t,e,r,n){var i=new B(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=n,i}function ft(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function dt(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function pt(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function yt(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return Math.hypot(r,n,i,o)}function vt(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return r*r+n*n+i*i+o*o}function gt(t){var e=t[0],r=t[1],n=t[2],i=t[3];return Math.hypot(e,r,n,i)}function mt(t){var e=t[0],r=t[1],n=t[2],i=t[3];return e*e+r*r+n*n+i*i}function bt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Et(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*o+r[12]*a,t[1]=r[1]*n+r[5]*i+r[9]*o+r[13]*a,t[2]=r[2]*n+r[6]*i+r[10]*o+r[14]*a,t[3]=r[3]*n+r[7]*i+r[11]*o+r[15]*a,t}var xt=ft,Pt=dt,wt=pt,kt=yt,Rt=vt,St=gt,It=mt,Tt=function(){var t=lt();return function(e,r,n,i,o,a){var s,u;for(r||(r=4),n||(n=0),u=i?Math.min(i*r+n,e.length):e.length,s=n;s<u;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],o(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),At=Object.freeze({__proto__:null,create:lt,clone:function(t){var e=new B(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:ht,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},set:function(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:ft,multiply:dt,divide:pt,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},scaleAndAdd:function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t},distance:yt,squaredDistance:vt,length:gt,squaredLength:mt,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*r+n*n+i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),t[0]=r*a,t[1]=n*a,t[2]=i*a,t[3]=o*a,t},dot:bt,cross:function(t,e,r,n){var i=r[0]*n[1]-r[1]*n[0],o=r[0]*n[2]-r[2]*n[0],a=r[0]*n[3]-r[3]*n[0],s=r[1]*n[2]-r[2]*n[1],u=r[1]*n[3]-r[3]*n[1],c=r[2]*n[3]-r[3]*n[2],l=e[0],h=e[1],f=e[2],d=e[3];return t[0]=h*c-f*u+d*s,t[1]=-l*c+f*a-d*o,t[2]=l*u-h*a+d*i,t[3]=-l*s+h*o-f*i,t},lerp:function(t,e,r,n){var i=e[0],o=e[1],a=e[2],s=e[3];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t[2]=a+n*(r[2]-a),t[3]=s+n*(r[3]-s),t},random:function(t,e){var r,n,i,o,a,s;e=e||1;do{a=(r=2*F()-1)*r+(n=2*F()-1)*n}while(a>=1);do{s=(i=2*F()-1)*i+(o=2*F()-1)*o}while(s>=1);var u=Math.sqrt((1-a)/s);return t[0]=e*r,t[1]=e*n,t[2]=e*i*u,t[3]=e*o*u,t},transformMat4:Et,transformQuat:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],u=r[2],c=r[3],l=c*n+s*o-u*i,h=c*i+u*n-a*o,f=c*o+a*i-s*n,d=-a*n-s*i-u*o;return t[0]=l*c+d*-a+h*-u-f*-s,t[1]=h*c+d*-s+f*-a-l*-u,t[2]=f*c+d*-u+l*-s-h*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,e){var r=t[0],n=t[1],i=t[2],o=t[3],a=e[0],s=e[1],u=e[2],c=e[3];return Math.abs(r-a)<=1e-6*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-s)<=1e-6*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-u)<=1e-6*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(o-c)<=1e-6*Math.max(1,Math.abs(o),Math.abs(c))},sub:xt,mul:Pt,div:wt,dist:kt,sqrDist:Rt,len:St,sqrLen:It,forEach:Tt});function Ct(t,e,r,n,i,o,a,s){var u=new B(8);return u[0]=t,u[1]=e,u[2]=r,u[3]=n,u[4]=i,u[5]=o,u[6]=a,u[7]=s,u}function Ot(){var t=new B(2);return B!=Float32Array&&(t[0]=0,t[1]=0),t}function Mt(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Dt(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function Nt(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function Lt(t,e){var r=e[0]-t[0],n=e[1]-t[1];return Math.hypot(r,n)}function _t(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n}function Bt(t){var e=t[0],r=t[1];return Math.hypot(e,r)}function Ft(t){var e=t[0],r=t[1];return e*e+r*r}var Ut=Bt,jt=Mt,Gt=Dt,Yt=Nt,zt=Lt,Xt=_t,Vt=Ft,Ht=function(){var t=Ot();return function(e,r,n,i,o,a){var s,u;for(r||(r=2),n||(n=0),u=i?Math.min(i*r+n,e.length):e.length,s=n;s<u;s+=r)t[0]=e[s],t[1]=e[s+1],o(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),qt=Object.freeze({__proto__:null,create:Ot,clone:function(t){var e=new B(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var r=new B(2);return r[0]=t,r[1]=e,r},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:Mt,multiply:Dt,divide:Nt,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},max:function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},scaleAndAdd:function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t},distance:Lt,squaredDistance:_t,length:Bt,squaredLength:Ft,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var r=e[0],n=e[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t},lerp:function(t,e,r,n){var i=e[0],o=e[1];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t},random:function(t,e){e=e||1;var r=2*F()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},transformMat2:function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i,t[1]=r[1]*n+r[3]*i,t},transformMat2d:function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i+r[4],t[1]=r[1]*n+r[3]*i+r[5],t},transformMat3:function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[3]*i+r[6],t[1]=r[1]*n+r[4]*i+r[7],t},transformMat4:function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[4]*i+r[12],t[1]=r[1]*n+r[5]*i+r[13],t},rotate:function(t,e,r,n){var i=e[0]-r[0],o=e[1]-r[1],a=Math.sin(n),s=Math.cos(n);return t[0]=i*s-o*a+r[0],t[1]=i*a+o*s+r[1],t},angle:function(t,e){var r=t[0],n=t[1],i=e[0],o=e[1],a=Math.sqrt(r*r+n*n)*Math.sqrt(i*i+o*o),s=a&&(r*i+n*o)/a;return Math.acos(Math.min(Math.max(s,-1),1))},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,e){var r=t[0],n=t[1],i=e[0],o=e[1];return Math.abs(r-i)<=1e-6*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(n-o)<=1e-6*Math.max(1,Math.abs(n),Math.abs(o))},len:Ut,sub:jt,mul:Gt,div:Yt,dist:zt,sqrDist:Xt,sqrLen:Vt,forEach:Ht}),Zt=function(){function t(e,r,n,i){var o=this;if(s(this,t),isNaN(e))throw new Error("Invalid x found: ".concat(e));if(isNaN(r))throw new Error("Invalid y found: ".concat(r));var a=[e,r];isFinite(n)&&(a.push(n),isFinite(i)&&a.push(i)),this.value=a.toFloat32Array(),Object.defineProperty(this,"x",{get:function(){return o.value[0]},set:function(t){return o.value[0]=t},enumerable:!0}),Object.defineProperty(this,"y",{get:function(){return o.value[1]},set:function(t){return o.value[1]=t},enumerable:!0}),2==a.length?this.vec=qt:3==a.length?(this.vec=ct,Object.defineProperty(this,"z",{get:function(){return o.value[2]},set:function(t){return o.value[2]=t},enumerable:!0})):(this.vec=At,Object.defineProperty(this,"w",{get:function(){return o.value[3]},set:function(t){return o.value[3]=t},enumerable:!0}))}return c(t,[{key:"add",value:function(e){e instanceof t||(e=t.fromPoint(e));var r=this.vec.create();return this.vec.add(r,this.value,e.value),t.fromPoint(r)}},{key:"addSelf",value:function(e){return e instanceof t||(e=t.fromPoint(e)),this.vec.add(this.value,this.value,e.value),this}},{key:"subtract",value:function(e){e instanceof t||(e=t.fromPoint(e));var r=this.vec.create();return this.vec.subtract(r,this.value,e.value),t.fromPoint(r)}},{key:"subtractSelf",value:function(e){return e instanceof t||(e=t.fromPoint(e)),this.vec.subtract(this.value,this.value,e.value),this}},{key:"multiply",value:function(e){e instanceof t||(e=t.fromPoint(e));var r=this.vec.create();return this.vec.multiply(r,this.value,e.value),t.fromPoint(r)}},{key:"multiplySelf",value:function(e){return e instanceof t||(e=t.fromPoint(e)),this.vec.multiply(this.value,this.value,e.value),this}},{key:"divide",value:function(e){e instanceof t||(e=t.fromPoint(e));var r=this.vec.create();return this.vec.divide(r,this.value,e.value),t.fromPoint(r)}},{key:"divideSelf",value:function(e){return e instanceof t||(e=t.fromPoint(e)),this.vec.divide(this.value,this.value,e.value),this}},{key:"scale",value:function(e){var r=this.vec.create();return this.vec.scale(r,this.value,e),t.fromPoint(r)}},{key:"scaleSelf",value:function(t){return this.vec.scale(this.value,this.value,t),this}},{key:"abs",value:function(){return new t(Math.abs(this.x),Math.abs(this.y),isFinite(this.z)?Math.abs(this.z):void 0,isFinite(this.w)?Math.abs(this.w):void 0)}},{key:"absSelf",value:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),isFinite(this.z)&&(this.z=Math.abs(this.z)),isFinite(this.w)&&(this.w=Math.abs(this.w)),this}},{key:"transform",value:function(e){if(!e)return this;var r=this.vec.create();return this.vec.transformMat4(r,this.value,e.toFloat32Array()),t.fromPoint(r)}},{key:"transformSelf",value:function(t){return this.vec.transformMat4(this.value,this.value,t.toFloat32Array()),this}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){var t={x:this.x,y:this.y};return isFinite(this.z)&&(t.z=this.z,isFinite(this.w)&&(t.w=this.w)),t}},{key:"toString",value:function(){return"point(".concat(this.value.join(", "),")")}},{key:"clone",value:function(){return t.fromPoint(this)}}],[{key:"fromPoint",value:function(e){return Array.isArray(e)||ArrayBuffer.isTypedArray(e)?new t(e[0],e[1],e[2],e[3]):new t(e.x,e.y,e.z,e.w)}}]),t}(),Wt=0,Kt=1,Jt=4,Qt=5,$t=12,te=13,ee=function(){function t(){var e,r,n,i,o,a=this,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:U(),c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.MultiplicationType.PRE;s(this,t),Object.defineProperty(this,"value",{value:u,enumerable:!0}),Object.defineProperty(this,"multiplicationType",{value:c,enumerable:!0}),Object.defineProperty(this,"a",{get:function(){return a.value[Wt]},enumerable:!0}),Object.defineProperty(this,"b",{get:function(){return a.value[Kt]},enumerable:!0}),Object.defineProperty(this,"c",{get:function(){return a.value[Jt]},enumerable:!0}),Object.defineProperty(this,"d",{get:function(){return a.value[Qt]},enumerable:!0}),Object.defineProperty(this,"e",{get:function(){return a.value[$t]},enumerable:!0}),Object.defineProperty(this,"f",{get:function(){return a.value[te]},enumerable:!0}),Object.defineProperty(this,"tx",{get:function(){return a.value[$t]},enumerable:!0}),Object.defineProperty(this,"ty",{get:function(){return a.value[te]},enumerable:!0}),Object.defineProperty(this,"m11",{get:function(){return a.value[0]},enumerable:!0}),Object.defineProperty(this,"m12",{get:function(){return a.value[1]},enumerable:!0}),Object.defineProperty(this,"m13",{get:function(){return a.value[2]},enumerable:!0}),Object.defineProperty(this,"m14",{get:function(){return a.value[3]},enumerable:!0}),Object.defineProperty(this,"m21",{get:function(){return a.value[4]},enumerable:!0}),Object.defineProperty(this,"m22",{get:function(){return a.value[5]},enumerable:!0}),Object.defineProperty(this,"m23",{get:function(){return a.value[6]},enumerable:!0}),Object.defineProperty(this,"m24",{get:function(){return a.value[7]},enumerable:!0}),Object.defineProperty(this,"m31",{get:function(){return a.value[8]},enumerable:!0}),Object.defineProperty(this,"m32",{get:function(){return a.value[9]},enumerable:!0}),Object.defineProperty(this,"m33",{get:function(){return a.value[10]},enumerable:!0}),Object.defineProperty(this,"m34",{get:function(){return a.value[11]},enumerable:!0}),Object.defineProperty(this,"m41",{get:function(){return a.value[12]},enumerable:!0}),Object.defineProperty(this,"m42",{get:function(){return a.value[13]},enumerable:!0}),Object.defineProperty(this,"m43",{get:function(){return a.value[14]},enumerable:!0}),Object.defineProperty(this,"m44",{get:function(){return a.value[15]},enumerable:!0}),Object.defineProperty(this,"isIdentity",{get:function(){return 1==a.a&&0==a.b&&0==a.c&&1==a.d&&0==a.tx&&0==a.ty},enumerable:!0}),Object.defineProperty(this,"translateX",{get:function(){return a.tx},enumerable:!0}),Object.defineProperty(this,"translateY",{get:function(){return a.ty},enumerable:!0}),Object.defineProperty(this,"skewX",{get:function(){return isNaN(e)?Math.tan(a.c):e},enumerable:!0}),Object.defineProperty(this,"skewY",{get:function(){return isNaN(r)?Math.tan(a.b):r},enumerable:!0}),Object.defineProperty(this,"scaleX",{get:function(){return isNaN(n)?Math.sqrt(a.a*a.a+a.c*a.c):n},enumerable:!0}),Object.defineProperty(this,"scaleY",{get:function(){return isNaN(i)?Math.sqrt(a.d*a.d+a.b*a.b):i},enumerable:!0}),Object.defineProperty(this,"rotation",{get:function(){return isNaN(o)?Math.atan2(a.b,a.a):o},enumerable:!0}),this.reset=function(){e=void 0,r=void 0,n=void 0,i=void 0,o=void 0}}return c(t,[{key:"clone",value:function(){return new t(this.value.clone(),this.multiplicationType)}},{key:"translate",value:function(e){return this.multiply(t.fromTranslate(e))}},{key:"translateSelf",value:function(e){this.multiplySelf(t.fromTranslate(e))}},{key:"rotate",value:function(e,r){return this.multiply(t.fromRotate(e,r))}},{key:"rotateSelf",value:function(e,r){this.multiplySelf(t.fromRotate(e,r))}},{key:"scale",value:function(e,r){return this.multiply(t.fromScale(e,r))}},{key:"scaleSelf",value:function(e,r){this.multiplySelf(t.fromScale(e,r))}},{key:"multiply",value:function(e){var r=U();return this.multiplicationType==t.MultiplicationType.PRE?G(r,e.toFloat32Array(),this.value):G(r,this.value,e.toFloat32Array()),new t(r,this.multiplicationType)}},{key:"multiplySelf",value:function(e){this.multiplicationType==t.MultiplicationType.PRE?this.preMultiplySelf(e):this.postMultiplySelf(e)}},{key:"preMultiplySelf",value:function(t){G(this.value,t.toFloat32Array(),this.value),this.reset()}},{key:"postMultiplySelf",value:function(t){G(this.value,this.value,t.toFloat32Array()),this.reset()}},{key:"invert",value:function(){var e=U();return j(e,this.value),new t(e,this.multiplicationType)}},{key:"invertSelf",value:function(){j(this.value,this.value),this.reset()}},{key:"disassemble",value:function(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this.toJSON()}}},{key:"transformPoint",value:function(t){return Zt.fromPoint(t).transform(this)}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){return{a:this.a,b:this.b,c:this.c,d:this.d,tx:this.tx,ty:this.ty}}},{key:"toString",value:function(){return"matrix(".concat(this.a,", ").concat(this.b,", ").concat(this.c,", ").concat(this.d,", ").concat(this.tx,", ").concat(this.ty,")")}}],[{key:"fromString",value:function(e,r){var n=U();return"none"!=e&&(e=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),n[Wt]=parseFloat(e[0]),n[Kt]=parseFloat(e[1]),n[Jt]=parseFloat(e[2]),n[Qt]=parseFloat(e[3]),n[$t]=parseFloat(e[4]),n[te]=parseFloat(e[5])),new t(n,r)}},{key:"fromMatrix",value:function(e,r){if(!e)throw new Error("data not found, Matrix instance creation failed");if("function"==typeof e)throw new Error("data type function is not allowed");if(e instanceof t)return e;if(Array.isArray(e)&&(e=new Float32Array(e)),e instanceof Float32Array)return new t(e,r);if("string"==typeof e)return t.fromString(e,r);var n={a:1,b:0,c:0,d:1,tx:0,ty:0};isFinite(e.a)&&(n.a=e.a),isFinite(e.b)&&(n.b=e.b),isFinite(e.c)&&(n.c=e.c),isFinite(e.d)&&(n.d=e.d),n.tx=e.tx||e.e||e.dx||0,n.ty=e.ty||e.f||e.dy||0;var i=U();return i[Wt]=n.a,i[Kt]=n.b,i[Jt]=n.c,i[Qt]=n.d,i[$t]=n.tx,i[te]=n.ty,new t(i,r||e.multiplicationType)}},{key:"fromTranslate",value:function(e){var r=isFinite(e)?{tx:e,ty:e}:{tx:e.x,ty:e.y};return t.fromMatrix(r)}},{key:"fromRotate",value:function(e,r){var n=Math.sin(e),i=Math.cos(e),o={a:i,b:n,c:-n,d:i};return r&&(o.tx=r.x-r.x*i+r.y*n,o.ty=r.y-r.x*n-r.y*i),t.fromMatrix(o)}},{key:"fromScale",value:function(e,r){isFinite(e)&&(e={x:e,y:e});var n={a:e.x,d:e.y};return r&&(n.tx=r.x-r.x*e.x,n.ty=r.y-r.y*e.y),t.fromMatrix(n)}},{key:"multiply",value:function(e,r){var n=U();return G(n,e.value,r.value),new t(n)}}]),t}();ee.MultiplicationType=Object.freeze({PRE:"PRE",POST:"POST"});var re=function(){function t(e){var r=this;s(this,t),this.header=[],this.table=[],e.forEach((function(t){"string"==typeof t&&(t={name:t,title:t}),t.size=t.title.length,r.header.push(t)})),Object.defineProperty(this,"length",{get:function(){return r.table.length},enumerable:!0})}return c(t,[{key:"insert",value:function(t){this.table.push(t),this.header.forEach((function(e){var r=t[e.name];null!=r&&(e.size=Math.max(e.size,r.toString().length))}))}},{key:"build",value:function(){var t=this,e=[],r=this.header.length+1,n=[];return this.header.forEach((function(e){r+=e.size+2;var i=e.size-e.title.length,o=Math.floor(i/2),a=Math.ceil(i/2);n.push(t.getRepetedValue(o)+e.title+t.getRepetedValue(a))})),this.table.forEach((function(r){var n=[];t.header.forEach((function(e){var i=null==r[e.name]?"":r[e.name],o=e.size-i.toString().length;n.push(i+t.getRepetedValue(o))})),e.push(n)})),{delimiterLength:r,headerRow:n,content:e}}},{key:"getFormattedRow",value:function(t){var e="| ";return t.forEach((function(t){e+=t,e+=" | "})),e.trim()}},{key:"getRepetedValue",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ";return new Array(t+1).join(e)}},{key:"clear",value:function(){this.table.clear()}},{key:"toString",value:function(){var t=this,e="",r=this.build(),n=r.delimiterLength,i=r.headerRow,o=r.content;return e+=this.getRepetedValue(n,"="),e+="\n",e+=this.getFormattedRow(i),e+="\n",e+=this.getRepetedValue(n,"="),e+="\n",o.forEach((function(r){e+=t.getFormattedRow(r),e+="\n"})),e}}]),t}();function ne(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}if("object"===("undefined"==typeof window?"undefined":n(window))&&"undefined"==typeof TouchEvent){var ie=function(t){d(r,t);var e=ne(r);function r(){return s(this,r),e.apply(this,arguments)}return r}(E(Event));window.TouchEvent=ie}var oe={pointers:{mouse:["down","move","up"],touch:["start","move","end"]},inactive:[],open:function(t){if(!(t instanceof l))throw new Error("Argument doesn't implement InkController interface");this.inkController=t,this.canvas=t.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("touchcancel",this.abort,{passive:!0}),this.attachResize(),this.start()},reset:function(t){for(var e in this.pointers){var r=e==oe.PointerType.TOUCH?{passive:!0}:void 0,n=e+this.pointers[e][0];this.canvas.removeEventListener(n,this.begin),t.canvas.surface.addEventListener(n,this.begin,r)}this.dettachResize(),this.inkController=t,this.canvas=t.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("touchcancel",this.abort),delete this.canvas,delete this.inkController},start:function(t){var e=t?h({},t,this.pointers[t]):this.pointers;for(t in t&&this.inactive.remove(t),this.inactive.forEach((function(t){return delete e[t]})),e)for(var r=t==oe.PointerType.TOUCH?{passive:!0}:void 0,n=0;n<e[t].length;n++){var i=t+e[t][n];0==n?this.canvas.addEventListener(i,this.begin,r):addEventListener(i,2==n?this.end:this.move,r)}},stop:function(t){var e=t?h({},t,this.pointers[t]):this.pointers;for(t in t&&!this.inactive.includes(t)&&this.inactive.push(t),this.inactive.forEach((function(t){return delete e[t]})),t&&t!=oe.PointerType.MOUSE||clearTimeout(this.timeoutID),e)for(var r=0;r<e[t].length;r++){var n=t+e[t][r];0==r?this.canvas.removeEventListener(n,this.begin):removeEventListener(n,2==r?this.end:this.move)}},attachResize:function(){var t,e,r,n=this;this.inkController.resize&&(this.resize=(t=function(){return n.inkController.resize()},e=200,r=null,function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){t.apply(n,i)}),e)}),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(t){var e=this.provider;return(!t.type.endsWith("down")&&!t.type.endsWith("start")||(e||(e=this.getInputProvider(t)),!this.inactive.includes(e)))&&e==this.getInputProvider(t)},isInputExpected:function(t){var e=!1,r=t.changedTouches?Array.from(t.changedTouches).map((function(t){return t.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(e=t.type.endsWith("down")||t.type.endsWith("start")?!n.phase:!!n.phase),e},getSensorPoint:function(t){var e=void 0,r=t.changedTouches?Array.from(t.changedTouches).map((function(t){return t.identifier})):[],n=this.inkController.getInkBuilder(r);return n&&(e=this.createSensorPoint(t,n.pointerID)),e},createSensorPoint:function(t,e){var r=this.getOffset(t),n={x:r.x,y:r.y,z:void 0,timestamp:Math.floor(t.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,rotation:void 0},i={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(n,"phase",{value:_.Phase[t.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(n,"pointer",{value:i,enumerable:!0}),Object.defineProperty(n.pointer,"provider",{get:function(){return A.Type[this.type.toUpperCase()]},enumerable:!0}),t instanceof MouseEvent)i.type=oe.PointerType.MOUSE,i.button=t.button,i.buttons=t.buttons;else{if(!(t instanceof TouchEvent))throw new Error("Unexpected event detected: ".concat(t.constructor.name,". Expected event should be instance of MouseEvent or TouchEvent."));if(isNaN(e))throw new Error("pointerID is required for touch event");if(!(t=Array.from(t.changedTouches).filter((function(t){return t.identifier==e})).first))return null;isNaN(n.x)&&(n.x=t.offsetX||t.clientX),isNaN(n.y)&&(n.y=t.offsetY||t.clientY),i.id=t.identifier,i.type=oe.PointerType.TOUCH,n.pressure=t.force,n.radiusX=t.radiusX,n.radiusY=t.radiusY,n.rotation=Math.toRadians(t.rotationAngle)}return n},getOffset:function(t){if(t.changedTouches){var e=Array.from(t.changedTouches).map((function(t){return t.identifier})),r=this.inkController.getInkBuilder(e);t=r.pointerID!=t.changedTouches.item(0).identifier?Array.from(t.changedTouches).filter((function(t){return t.identifier==r.pointerID})).first:t.changedTouches.item(0)}var n=this.canvas.offsetParent;if(!n)return{x:0,y:0};"flex"==n.getStyle("display")&&(n=this.canvas);var i=n.getBoundingClientRect(),o={x:t.pageX-i.x,y:t.pageY-i.y};return this.inkController.transform&&(o=Zt.fromPoint(o).transform(this.inkController.transform.invert())),o},getInputProvider:function(t){return t.type.replace(/down|start|move|up|end/g,"")},begin:function(t){if(this.logSampleInput(t),!(t instanceof MouseEvent&&0!=t.button)&&this.isInputAllowed(t)){if(t instanceof TouchEvent){var e=Array.from(t.changedTouches).map((function(t){return t.identifier}));this.inkController.registerInputProvider(e)}if(this.isInputExpected(t)){this.provider||(this.provider=this.getInputProvider(t));var r=this.getSensorPoint(t);r&&this.inkController.begin(r)}}},move:function(t){if(this.isInputAllowed(t)&&this.isInputExpected(t)){this.logSampleInput(t);var e=this.getSensorPoint(t);e&&this.inkController.move(e)}},end:function(t){var e=this;if(this.isInputAllowed(t)&&this.isInputExpected(t)){this.logSampleInput(t);var r=this.getSensorPoint(t);r&&(this.inkController.end(r),t instanceof MouseEvent||this.inactive.includes(oe.PointerType.MOUSE)||(this.stop(oe.PointerType.MOUSE),this.timeoutID=setTimeout((function(){return e.start(oe.PointerType.MOUSE)}),500))),t.touches&&0!=t.touches.length||delete this.provider}},abort:function(t){if(delete this.provider,this.inkController.abort)if(t instanceof TouchEvent){var e=Array.from(t.changedTouches).map((function(t){return t.identifier}));this.inkController.abort(e)}else this.inkController.abort()},logSampleInput:function(t){if(this.debug){var e=t.type.endsWith("move"),r="mouseup"==t.type||"touchend"==t.type;e&&!this.debug.move||r&&!this.debug.end||(r&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new re(["type","id","pointerType","x","y","pressure","radius","rotation","timestamp"])),this.table.insert({type:t.type,id:t.changedTouches?t.changedTouches[0].identifier:void 0,pointerType:this.getInputProvider(t),x:t.changedTouches?t.changedTouches[0].clientX.toFixed(2):t.clientX,y:t.changedTouches?t.changedTouches[0].clientY.toFixed(2):t.clientY,pressure:t.changedTouches?t.changedTouches[0].force.toFixed(2):void 0,radius:t.changedTouches?t.changedTouches[0].radiusX.toFixed(2)+" / "+t.changedTouches[0].radiusY.toFixed(2):void 0,rotation:t.changedTouches?t.changedTouches[0].rotationAngle:t.twist,timestamp:t.timeStamp.toFixed(8)}),e||(console.log(this.table.toString()),this.table.clear()))}},PointerType:{MOUSE:"mouse",TOUCH:"touch"}},ae={inactive:[],open:function(t){if(!(t instanceof l))throw new Error("Argument doesn't implement InkController interface");this.inkController=t,this.canvas=t.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset:function(t){this.canvas.removeEventListener("pointerdown",this.begin),t.canvas.surface.addEventListener("pointerdown",this.begin),this.dettachResize(),this.inkController=t,this.canvas=t.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start:function(t){t?this.inactive.remove(t):(this.canvas.addEventListener("pointerdown",this.begin),addEventListener("pointermove",this.move),addEventListener("pointerup",this.end))},stop:function(t){t?this.inactive.includes(t)||this.inactive.push(t):(this.canvas.removeEventListener("pointerdown",this.begin),removeEventListener("pointermove",this.move),removeEventListener("pointerup",this.end))},attachResize:function(){var t,e,r,n=this;this.inkController.resize&&(this.resize=(t=function(){return n.inkController.resize()},e=200,r=null,function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){t.apply(n,i)}),e)}),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(t){var e=this.provider;if("pointerdown"==t.type){if(e||(e=this.getInputProvider(t)),this.inactive.includes(e))return!1;if(e==ae.PointerType.MOUSE){if(0!=t.button)return!1}else if(e==ae.PointerType.PEN&&0==t.pressure)return!1}return!0},isInputExpected:function(t){var e=!1,r=this.inkController.getInkBuilder(t.pointerId);return r&&(e="pointerdown"==t.type?!r.phase:!!r.phase),e},getSensorPoint:function(t){var e=void 0,r=this.inkController.getInkBuilder(t.pointerId);if(r){if(t.pointerId!=r.pointerID)throw new Error("Create sensor point failed, expected pointer with id: ".concat(r.pointerID,", found: ").concat(t.pointerId));if("pointerdown"==t.type){var n=this.getInputProvider(t);t.pointerType!=n?r.pointerType=n:delete r.pointerType}e=this.createSensorPoint(t,r.pointerType)}return e},createSensorPoint:function(t,e,r){var n=this;if(!(t instanceof PointerEvent))throw new Error("Unexpected event detected: ".concat(t.constructor.name,". Expected event should be instance of PointerEvent."));var i,o=this.getOffset(t),a={x:o.x,y:o.y,z:void 0,timestamp:Math.floor(t.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0};if(r?(Object.defineProperty(a,"phase",{value:r.phase,enumerable:!0}),i=r.pointer):(Object.defineProperty(a,"phase",{value:_.Phase[t.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),i={id:t.pointerId,type:e||t.pointerType,button:void 0,buttons:void 0},Object.defineProperty(i,"provider",{get:function(){return A.Type[this.type.toUpperCase()]},enumerable:!0}),"pen"!=i.type&&"mouse"!=i.type||(i.button=t.button,i.buttons=t.buttons)),Object.defineProperty(a,"pointer",{value:i,enumerable:!0}),"pen"!=i.type&&"touch"!=i.type||(a.pressure=t.pressure,a.rotation=Math.toRadians(t.twist)),"pen"==i.type?(a.tiltX=t.tiltX,a.tiltY=t.tiltY):"touch"==i.type&&(a.radiusX=t.width/2,a.radiusY=t.height/2),!r){if(t.getPredictedEvents){var s,u=t.getPredictedEvents();Object.defineProperty(a,"predicted",{get:function(){return s||(s=u.map((function(t){return n.createSensorPoint(t,e,a)}))),s},enumerable:!0})}if(t.getCoalescedEvents){var c,l=t.getCoalescedEvents();Object.defineProperty(a,"coalesced",{get:function(){return c||(c=l.map((function(t){return n.createSensorPoint(t,e,a)}))),c},enumerable:!0})}}return a},getOffset:function(t){var e=this.canvas.offsetParent;if(!e)return{x:0,y:0};"flex"==e.getStyle("display")&&(e=this.canvas);var r=e.getBoundingClientRect(),n={x:t.pageX-r.x,y:t.pageY-r.y};return this.inkController.transform&&(n=Zt.fromPoint(n).transform(this.inkController.transform.invert())),n},getInputProvider:function(t){return t.pointerType==ae.PointerType.MOUSE&&t.pressure>0&&.5!==t.pressure?ae.PointerType.PEN:t.pointerType},begin:function(t){if(this.logSampleInput(t),this.isInputAllowed(t)&&(this.inkController.registerInputProvider(t.pointerId,t.isPrimary),this.isInputExpected(t))){this.provider||(this.provider=this.getInputProvider(t));var e=this.getSensorPoint(t);e&&this.inkController.begin(e)}},move:function(t){if(this.isInputAllowed(t)&&this.isInputExpected(t)){this.logSampleInput(t);var e=this.getSensorPoint(t);e&&this.inkController.move(e)}},end:function(t){if(this.isInputAllowed(t)&&this.isInputExpected(t)){this.logSampleInput(t);var e=this.getSensorPoint(t);e&&this.inkController.end(e),delete this.provider}},abort:function(t){delete this.provider,this.inkController.abort&&this.inkController.abort(t.pointerId)},logSampleInput:function(t){this.debug&&("pointermove"!=t.type||this.debug.move)&&("pointerup"!=t.type||this.debug.end)&&(t.pointerType!=this.getInputProvider(t)&&(t.pen=!0),"pointerup"==t.type&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new re(["type","id","pointerType","x","y","pressure","radius","tilt","rotation","timestamp"])),this.table.insert({type:t.type,id:t.pointerId,pointerType:t.pen?"".concat(t.pointerType," / pen"):t.pointerType,x:t.clientX.toFixed(2),y:t.clientY.toFixed(2),pressure:t.pressure.toFixed(2),radius:(t.width/2).toFixed(2)+" / "+(t.height/2).toFixed(2),rotation:t.twist,tilt:isFinite(t.tiltX)?t.tiltX+" / "+t.tiltY:"",timestamp:t.timeStamp.toFixed(8)}),"pointermove"!=t.type&&(console.log(this.table.toString()),this.table.clear()))},PointerType:{PEN:"pen",MOUSE:"mouse",TOUCH:"touch"}};"object"===("undefined"==typeof window?"undefined":n(window))&&"undefined"==typeof PointerEvent&&(ae=oe);var se=ae;var ue=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=v(t)););return t},ce=r((function(t){function e(r,n,i){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=e=Reflect.get:t.exports=e=function(t,e,r){var n=ue(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(r):i.value}},e(r,n,i||r)}t.exports=e}));function le(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var he=function(t){d(r,t);var e=le(r);function r(t,n,i){var o;return s(this,r),(o=e.call(this,t,n,i)).red,o.green,o.blue,o.alpha,o.size,o.rotation,o.scaleX,o.scaleY,o.scaleZ,o.offsetX,o.offsetY,o.offsetZ,o.dX,o.dY,o}return c(r,[{key:"fill",value:function(t,e){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=n*t.length;t.forEach((function(t,n){return r.setProperty(t,e[i+n])}))}},{key:"getProperty",value:function(t){switch(t){case r.Property.X:return this.x;case r.Property.Y:return this.y;case r.Property.Z:return this.z;case r.Property.RED:return this.red;case r.Property.GREEN:return this.green;case r.Property.BLUE:return this.blue;case r.Property.ALPHA:return this.alpha;case r.Property.SIZE:return this.size;case r.Property.ROTATION:return this.rotation;case r.Property.SCALE_X:return this.scaleX;case r.Property.SCALE_Y:return this.scaleY;case r.Property.SCALE_Z:return this.scaleZ;case r.Property.OFFSET_X:return this.offsetX;case r.Property.OFFSET_Y:return this.offsetY;case r.Property.OFFSET_Z:return this.offsetZ;case r.Property.D_X:return this.dX;case r.Property.D_Y:return this.dY;default:throw console.warn(t),new Error("Invalid property found")}}},{key:"setProperty",value:function(t,e){r.setProperty(this,t,e)}},{key:"transform",value:function(t){if(!(t instanceof ee))throw new Error("matrix is instance of ".concat(t.constructor.name," - it should be instance of Matrix. Use Matrix.fromMatrix method to convert."));var e=t.scaleX,n=t.rotation,i=ce(v(r.prototype),"transform",this).call(this,t);this.x=i.x,this.y=i.y,this.z=i.z||0,this.size*=e,this.rotation+=n,this.scaleX*=e,this.scaleY*=e,this.scaleZ*=e,this.offsetX*=e,this.offsetY*=e,this.offsetZ*=e}},{key:"toArray",value:function(t){var e=this;return t.map((function(t){var r=e.getProperty(t);if(null==r||isNaN(r))throw new Error("Property ".concat(t.name," has invalid value ").concat(r));return r}))}},{key:"debug",value:function(){var t=this,e=[];return r.Property.values.forEach((function(r){var n=t.getProperty(r);null!=n&&isFinite(n)&&e.push(r.name,t.getProperty(r))})),e}}],[{key:"createInstance",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=Object.clone(i),a=n*t.length;t.forEach((function(t,n){return r.setProperty(o,t,e[a+n])}));var s=new r(o.x,o.y,o.z);return s.red=o.red,s.green=o.green,s.blue=o.blue,s.alpha=o.alpha,s.size=o.size,s.rotation=o.rotation||0,s.scaleX=o.scaleX||1,s.scaleY=o.scaleY||1,s.scaleZ=o.scaleZ||1,s.offsetX=o.offsetX||0,s.offsetY=o.offsetY||0,s.offsetZ=o.offsetZ||0,s.dX=o.dX,s.dY=o.dY,s}},{key:"setProperty",value:function(t,e,n){switch(e){case r.Property.X:t.x=n;break;case r.Property.Y:t.y=n;break;case r.Property.Z:t.z=n;break;case r.Property.RED:t.red=n;break;case r.Property.GREEN:t.green=n;break;case r.Property.BLUE:t.blue=n;break;case r.Property.ALPHA:t.alpha=n;break;case r.Property.SIZE:t.size=n;break;case r.Property.ROTATION:t.rotation=n;break;case r.Property.SCALE_X:t.scaleX=n;break;case r.Property.SCALE_Y:t.scaleY=n;break;case r.Property.SCALE_Z:t.scaleZ=n;break;case r.Property.OFFSET_X:t.offsetX=n;break;case r.Property.OFFSET_Y:t.offsetY=n;break;case r.Property.OFFSET_Z:t.offsetZ=n;break;case r.Property.D_X:t.dX=n;break;case r.Property.D_Y:t.dY=n;break;default:throw console.warn(e),new Error("Invalid property found")}}}]),r}(Zt);he.createEnum("Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);var fe=void 0;x.commonJS&&(fe=require("systeminformation"));var de=fe;function pe(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var ye=function(t){d(n,t);var e,r=pe(n);function n(){var t;return s(this,n),(t=r.call(this)).props={},t}return c(n,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",I.getMD5Tokens(this.props)]}}],[{key:"createInstance",value:(e=a(i.mark((function t(){var e,r,o,a=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=a.length>0&&void 0!==a[0]?a[0]:{},(r=new n).props["env.name"]=x.type.name,void 0!==de){t.next=7;break}r.props["user.agent"]=navigator.userAgent,t.next=15;break;case 7:return t.next=9,de.osInfo();case 9:o=t.sent,r.props["os.id"]=o.serial.toLowerCase(),r.props["os.name"]=o.codename,r.props["os.version"]=o.release,r.props["os.build"]=o.build,r.props["os.platform"]="".concat(o.distro," (").concat(o.platform," ").concat(o.arch,")");case 15:return Object.keys(e).forEach((function(t){return r.props[t]=e[t]})),t.abrupt("return",r);case 17:case"end":return t.stop()}}),t)}))),function(){return e.apply(this,arguments)})}]),n}(I),ve=96/("undefined"==typeof window?1:window.devicePixelRatio),ge={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*ve},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*ve},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*ve},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*ve},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*ve},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*ve},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*ve},DIP:{METER:.0254/ve,CENTIMETER:2.54/ve,MILLIMETER:25.4/ve,MICROMETER:25400/ve,INCH:1/ve,POINT:72/ve,PICA:6/ve,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Function.createEnum.call(ge,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Function.createEnum.call(ge,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);var me=Object.freeze({LENGTH:ge.Unit.METER,TIME:ge.Unit.SECOND,FORCE:ge.Unit.NEWTON,ANGLE:ge.Unit.RADIAN,NORMALIZED:ge.Unit.NORMALIZED,LOGICAL:ge.Unit.LOGICAL});ge.getChannelResolution=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=1,n=ge.getUnitMetric(t);return n!=ge.Metric.NORMALIZED&&n!=ge.Metric.LOGICAL&&(r=ge[me[n.name].name][t.name]/e),r},ge.convert=function(t,e,r,n){return e?r*ge[me[t.name].name][n.name]/e:r},ge.convertAny=function(t,e,r,n){return t*ge[e.name][r.name]/n},ge.getUnitMetric=function(t){switch(t){case ge.Unit.METER:case ge.Unit.CENTIMETER:case ge.Unit.MILLIMETER:case ge.Unit.MICROMETER:case ge.Unit.INCH:case ge.Unit.POINT:case ge.Unit.PICA:case ge.Unit.DIP:return ge.Metric.LENGTH;case ge.Unit.SECOND:case ge.Unit.MILLISECOND:case ge.Unit.MICROSECOND:case ge.Unit.NANOSECOND:return ge.Metric.TIME;case ge.Unit.RADIAN:case ge.Unit.DEGREE:return ge.Metric.ANGLE;case ge.Unit.NEWTON:return ge.Metric.FORCE;case ge.Unit.NORMALIZED:return ge.Metric.NORMALIZED;case ge.Unit.LOGICAL:return ge.Metric.LOGICAL;default:throw console.warn(t),new Error("Invalid unit found")}},ge.getUnit=function(t){return me[t.name]},ge.convertValue=function(t,e,r){return t*ge[e.name][r.name]},Object.freeze(ge);var be={longToByteArray:function(t){for(var e=[0,0,0,0,0,0,0,0],r=0;r<e.length;r++){var n=255&t;e[r]=n,t=(t-n)/256}return e},byteArrayToLong:function(t){for(var e=0,r=t.length-1;r>=0;r--)e=256*e+t[r];return e},crc32:function(){for(var t=new Uint32Array(256),e=256;e--;){for(var r=e,n=8;n--;)r=1&r?3988292384^r>>>1:r>>>1;t[e]=r}return function(e){for(var r=-1,n=0,i=e.length;n<i;n++)r=r>>>8^t[255&r^e[n]];return(-1^r)>>>0}}(),mapTo:function(t,e,r){return r.min+(be.clamp(t,e)-e.min)/(e.max-e.min)*(r.max-r.min)},clamp:function(t,e){return Math.min(Math.max(t,e.min),e.max)},comparator:function(){var t=Array.prototype.slice.call(arguments),e=function(t,e,r){var n="asc"===r?1:-1;return t>e?1*n:t<e?-1*n:0},r=function(t,e,r){return e.replace("[",".").replace("]","").split(".").forEach((function(e){return t=t[e]})),r?t.toLowerCase():t};return function(n,i){return t.map((function(t){return e(r(n,t.sortBy,t.ignoreCase),r(i,t.sortBy,t.ignoreCase),t.sortOrder)})).reduceRight((function(t,e){return e||t}))}},getPropName:function(t,e){var r=t.split("_"),n=r.first.toLowerCase();e&&(n=n.substring(0,1).toUpperCase()+n.substring(1));for(var i=1;i<r.length;i++)n+=r[i].substring(0,1),n+=r[i].substring(1).toLowerCase();return n},getEnumValueName:function(t){for(var e="",r=0;r<t.length;r++)r>0&&t[r]!=t[r].toLowerCase()&&(e+="_"),e+=t[r];return e.toUpperCase()}};function Ee(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var xe=function(t){d(r,t);var e=Ee(r);function r(t,n,i,o,a){var u;if(s(this,r),u=e.call(this),n==r.Metric.DIMENSIONLESS)i=1;else if(isNaN(i)){var c=ge.getUnit(n);i=ge.getChannelResolution(c)}return u.type=t,u.metric=n,u.resolution=i,u.min=o,u.max=a,t==r.Type.TIMESTAMP?u.precision=0:u.precision=2,Object.defineProperty(p(u),"name",{get:function(){return be.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}}),u}return c(r,[{key:"getMD5Message",value:function(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");var t=[];return t.push("SensorChannel"),t.push(this.context.inkProvider?this.context.inkProvider.id:""),t.push(this.context.device.id),t.push(this.type),t.push(this.metric.name),t.push(this.resolution.toFixed(4)),t.push((this.min||0).toFixed(4)),t.push((this.max||0).toFixed(4)),t.push(this.precision.toString()),t}}],[{key:"createCustomChannel",value:function(t,e,n,i,o,a){var s=new r(t,n,i,o,a);return s.precision=e,s}},{key:"createDefaultInstance",value:function(t,e){var n,i,o;switch(t){case r.Type.X:case r.Type.Y:case r.Type.Z:case r.Type.RADIUS_X:case r.Type.RADIUS_Y:n=ge.Unit.DIP;break;case r.Type.TIMESTAMP:n=ge.Unit.MILLISECOND;break;case r.Type.PRESSURE:n=ge.Unit.NORMALIZED,i=0,o=1;break;case r.Type.ALTITUDE:case r.Type.AZIMUTH:case r.Type.ROTATION:n=ge.Unit.RADIAN,i=0,o=2*Math.PI;break;default:console.error("SensorChannel: createDefaultInstance fails with ".concat(t," type"))}var a=ge.getChannelResolution(n),s=new r(t,ge.getUnitMetric(n),a,i,o);return s.unit=n,t!=r.Type.X&&t!=r.Type.Y||e.type!=A.Type.MOUSE||(s.precision=0),s}}]),r}(I);function Pe(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}xe.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),xe.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},xe.Metric=ge.Metric;var we=function(t){d(r,t);var e=Pe(r);function r(t,n){var i;s(this,r),(i=e.call(this)).device=t.freeze(),i.inkProvider=Object.freeze(n);var o,a,u=[];return Object.defineProperty(p(i),"channels",{get:function(){return u},set:function(t){var e=this;this.invalidateID(),u=[],t.forEach((function(t){return e.add(t)}))},enumerable:!0}),Object.defineProperty(p(i),"layout",{get:function(){return u.map((function(t){return t.name}))},set:function(t){this.invalidateID(),u=u.filter((function(e){return t.includes(e.name)}))},enumerable:!0}),Object.defineProperty(p(i),"samplingRate",{get:function(){return o},set:function(t){this.invalidateID(),o=t},enumerable:!0}),Object.defineProperty(p(i),"latency",{get:function(){return a},set:function(t){this.invalidateID(),a=t},enumerable:!0}),i}return c(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");var t=["SensorChannelsContext"].concat(L(this.channels.map((function(t){return t.id}))));return t.push(this.samplingRate||""),t.push(this.latency||""),t.push(this.inkProvider?this.inkProvider.id:""),t.push(this.device.id),t}},{key:"add",value:function(t){if((t.type==xe.Type.X||t.type==xe.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");t.context=this,Object.freeze(t),this.channels.push(t)}},{key:"get",value:function(t){return this.channels.filter((function(e){return e.id==t})).first}}],[{key:"createDefaultInstance",value:function(t,e){var n=new r(t,e);return n.channels=xe.defaults[e.type.name].map((function(t){return xe.createDefaultInstance(xe.Type[t],e)})),n}}]),r}(I);function ke(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Re=function(t){d(r,t);var e=ke(r);function r(){var t;s(this,r),t=e.call(this);var n=[];return Object.defineProperty(p(t),"channelsContexts",{get:function(){return n},set:function(t){this.invalidateID(),n=t},enumerable:!0}),t}return c(r,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext"].concat(L(this.channelsContexts.map((function(t){return t.id}))))}},{key:"addContext",value:function(t){if(!this.channelsContexts.includes(t)){if(this.channelsContexts.filter((function(e){return e.device==t.device})).length>0)throw new Error("Already exists channelsContext with device ".concat(t.device.id,". Device should be unique in scope of SensorContext."));t.inkProvider&&(this.inkChannelsContext=t),Object.freeze(t),this.channelsContexts.push(t)}}},{key:"getContext",value:function(t){return this.channelsContexts.filter((function(e){return e.id==t})).first}},{key:"getContextByChannelID",value:function(t){return this.channelsContexts.filter((function(e){return e.get(t)})).first}}],[{key:"createDefaultInstance",value:function(t,e){var n=new r;return n.addContext(we.createDefaultInstance(t,e)),n}}]),r}(I);function Se(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Ie=function(t){d(r,t);var e=Se(r);function r(t,n){var i;return s(this,r),(i=e.call(this)).environment=Object.freeze(t),i.sensorContext=Object.freeze(n),i}return c(r,[{key:"getMD5Message",value:function(){return["InputContext",this.environment.id,this.sensorContext.id]}},{key:"addChannelsContext",value:function(t){this.sensorContext.addContext(t)}}],[{key:"createDefaultInstance",value:function(t,e,n){return new r(t,Re.createDefaultInstance(e,n))}}]),r}(I);function Te(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Ae=function(t){d(r,t);var e=Te(r);function r(t){var n;return s(this,r),(n=e.call(this)).created=Date.now(),n.inkState=r.InkState.PLANE,n.context=t,n.streams=[],n}return c(r,[{key:"add",value:function(t){if(!this.context.sensorContext.getContextByChannelID(t.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");t.ink&&(this.inkStream=t),this.streams.push(t)}}]),r}(I);Ae.createEnum("InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);var Ce=function(){function t(e){s(this,t),this.channels=e,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:e.map((function(t){return t.name})),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}return c(t,[{key:"add",value:function(t,e){var r=this;e&&this.ignoredIndex.push(this.length),this.channels.forEach((function(e){var n=be.getPropName(e.name),i=t[n];if(e.type==xe.Type.ALTITUDE&&!("altitude"in t))throw new Error("SensorStream input data do not provides altitude");if(e.type==xe.Type.AZIMUTH&&!("azimuth"in t))throw new Error("SensorStream input data do not provides azimuth");r.data.push(i)}))}},{key:"get",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));for(var e={},r=0;r<this.stride;r++){var n=this.channels[r],i=be.getPropName(n.name),o=t*this.stride;e[i]=this.data[o+r]}return e}},{key:"getPipelineMapping",value:function(){var t=[];if(this.ignoredIndex.length>0)for(var e=0;e<this.length;e++)this.ignoredIndex.includes(e)||t.push(e);return t}}]),t}();function Oe(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Me=function(t){d(n,t);var e,r=Oe(n);function n(){var t;return s(this,n),(t=r.call(this)).props={},t.devices=[],t}return c(n,[{key:"freeze",value:function(){return Object.freeze(this.props),this}},{key:"getMD5Message",value:function(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",I.getMD5Tokens(this.props)]}},{key:"link",value:function(t){this.devices.push(t)}},{key:"getInkInputProvider",value:function(t){return new A(t)}},{key:"getInkSensorContext",value:function(t){var e=this.getInkInputProvider(t);return Re.createDefaultInstance(this,e)}},{key:"openStream",value:function(t){var e=this;if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");var r=A.Type[t.pointer.type.toUpperCase()],i=this.getInkSensorContext(r),o=new Ie(this.environment,i);i.inkChannelsContext.layout=n.getLayout(t),this.sensorData=new Ae(o),this.sensorData.add(new Ce(i.inkChannelsContext.channels)),this.sampleTimestamp=t.timestamp,this.devices.forEach((function(t){return t.openStream(e.sensorData)}))}},{key:"add",value:function(t,e){if(!this.sensorData)throw new Error("Open ink stream not found");this.sensorData.inkStream.add(Object.assign({},t,{timestamp:t.timestamp-this.sampleTimestamp}),e)}},{key:"closeStream",value:function(t){var e=this.sensorData;return this.devices.forEach((function(e){return e.closeStream(t)})),this.sensorData=null,this.sampleTimestamp=0,t?null:e}}],[{key:"getLayout",value:function(t){var e=[];return Object.keys(xe.Type).forEach((function(r){var i,o=xe.Type[r];i=o==xe.Type.ALTITUDE?"tiltX":o==xe.Type.AZIMUTH?"tiltY":be.getPropName(r),n.isValidInput(i,t)&&e.push(r)})),e}},{key:"isValidInput",value:function(t,e){var r=!1;return isFinite(e[t])&&(r=!0,"pressure"==t?(r=e.pressure>0&&"mouse"!=e.pointer.type)&&"touch"==e.pointer.type&&(r=.5!==e.pressure&&1!==e.pressure):"tiltX"==t||"tiltY"==t?r=0!=e.tiltX||0!=e.tiltY:"radiusX"==t||"radiusY"==t?r=e.radiusX!=e.radiusY||parseInt(e.radiusX)!=e.radiusX:"rotation"==t&&(r=0!=e.rotation)),r}},{key:"createInstance",value:(e=a(i.mark((function t(e){var r,n,o,a,s,u,c=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=b(this,L(Array.from(c).slice(1))),void 0!==de){t.next=5;break}r.props["dev.graphics.resolution"]="".concat(screen.width,"x").concat(screen.height),t.next=22;break;case 5:return t.next=7,de.system();case 7:return n=t.sent,t.next=10,de.cpu();case 10:return o=t.sent,t.next=13,de.graphics();case 13:a=t.sent,s=a.displays.filter((function(t){return t.main}))[0],u=a.controllers[0],r.props["dev.id"]=n.uuid.toLowerCase(),r.props["dev.manufacturer"]=n.manufacturer,r.props["dev.model"]=n.model,r.props["dev.cpu"]="".concat(o.manufacturer," ").concat(o.brand," ").concat(o.speed," - ").concat(o.cores," core(s)"),r.props["dev.graphics.display"]="".concat(s.model," ").concat(s.currentResX,"x").concat(s.currentResY," (").concat(s.pixeldepth," bit)"),r.props["dev.graphics.adapter"]="".concat(u.model," ").concat(u.vram," GB");case 22:return t.next=24,ye.createInstance(e);case 24:return r.environment=t.sent,t.abrupt("return",r);case 26:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})}]),n}(I),De=function(){function t(){s(this,t)}return c(t,null,[{key:"createCircle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};return t.createEllipse(e,r,r,n)}},{key:"createEllipse",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:0,y:0},i=[],o=2*Math.PI/t,a=0;a<t;a++){var s=a*o,u=e*Math.cos(s),c=r*Math.sin(s);i.push(n.x+u,n.y+c)}return i.toFloat32Array()}},{key:"createStar",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=[],n=1,i=2*Math.PI/t,o=0;o<t;o++){var a=o*i,s=n*Math.cos(a),u=n*Math.sin(a),c=e*Math.cos(a+i/2),l=e*Math.sin(a+i/2);r.push(s,u,c,l)}return r.toFloat32Array()}}]),t}(),Ne=function(){function t(e,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;s(this,t),this.red=e,this.green=r,this.blue=n,this.alpha=i}return c(t,[{key:"premultiply",value:function(){return new t(this.red/255*this.alpha,this.green/255*this.alpha,this.blue/255*this.alpha,this.alpha)}},{key:"postdivide",value:function(e,r,n,i){return new t(parseInt(255*e/i),parseInt(255*r/i),parseInt(255*n/i),i)}},{key:"equals",value:function(t){return t&&this.red==t.red&&this.green==t.green&&this.blue==t.blue&&this.alpha==t.alpha}},{key:"toRGB",value:function(){return 1==this.alpha?this:new t(this.red,this.green,this.blue)}},{key:"toRGBA",value:function(e){return new t(this.red,this.green,this.blue,e)}},{key:"toHSLA",value:function(){var t=this.red/255,e=this.green/255,r=this.blue/255,n=Math.min(t,e,r),i=Math.max(t,e,r),o=0,a=0,s=(i+n)/2;if(i!=n){var u=i-n;switch(a=u/(1-Math.abs(2*s-1)),i){case t:o=(e-r)/u%6;break;case e:o=(r-t)/u+2;break;case r:o=(t-e)/u+4}}return(o*=60)<0&&(o+=360),{hue:parseFloat(o.toFixed(0)),saturation:parseFloat((100*a).toFixed(2)),lightness:parseFloat((100*s).toFixed(2)),alpha:this.alpha}}},{key:"toArray",value:function(){return[this.red,this.green,this.blue,this.alpha]}},{key:"toJSON",value:function(){return{red:this.red,green:this.green,blue:this.blue,alpha:this.alpha}}},{key:"toString",value:function(){return 1==this.alpha?"rgb(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,")"):"rgba(".concat(this.red,", ").concat(this.green,", ").concat(this.blue,", ").concat(this.alpha,")")}}],[{key:"isColor",value:function(t){return t&&isFinite(t.red)&&isFinite(t.green)&&isFinite(t.blue)}},{key:"fromColor",value:function(e){var r,n,i,o;if("string"==typeof e){if(!e.startsWith("rgb")){if(e.startsWith("#"))return e=e.substring(1),new t(parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16));throw new Error("Unknown input found: ".concat(e,". Expected data starts with rgba, rgb or #."))}e=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),r=parseInt(e[0]),n=parseInt(e[1]),i=parseInt(e[2]),o=e[3]?parseInt(e[3]):1}else Array.isArray(e)?(r=e[0],n=e[1],i=e[2],o=e[3]):(r=e.red,n=e.green,i=e.blue,o=e.alpha);return new t(r,n,i,o)}},{key:"fromHSLA",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;e/=60,r/=100,n/=100;var o=(1-Math.abs(2*n-1))*r,a=o*(1-Math.abs(e%2-1)),s=0,u=0,c=0;e>=0&&e<1?(s=o,u=a):e>=1&&e<2?(s=a,u=o):e>=2&&e<3?(u=o,c=a):e>=3&&e<4?(u=a,c=o):e>=4&&e<5?(s=a,c=o):(s=o,c=a);var l=n-o/2;return s+=l,u+=l,c+=l,new t(Math.round(255*s),Math.round(255*u),Math.round(255*c),i)}},{key:"random",value:function(e){return new t(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),e?Math.random():1)}}]),t}();Ne.TRANSPERENT=new Ne(0,0,0,0),Ne.BLACK=new Ne(0,0,0,1),Ne.WHITE=new Ne(255,255,255,1),Ne.RED=new Ne(255,0,0,1),Ne.GREEN=new Ne(0,255,0,1),Ne.BLUE=new Ne(0,0,255,1);var Le=function(){function t(e,r,n,i){s(this,t);var o=e,a=r,u=e+n,c=r+i;Object.defineProperties(this,{left:{value:o,enumerable:!0},x:{value:e,enumerable:!0},bottom:{value:a,enumerable:!0},y:{value:r,enumerable:!0},right:{value:u,enumerable:!0},top:{value:c,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0}})}return c(t,[{key:"union",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of RectGL");return e?t.ofEdges(Math.min(this.left,e.left),Math.min(this.bottom,e.bottom),Math.max(this.right,e.right),Math.max(this.top,e.top)):this}},{key:"intersect",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of RectGL");if(!e)return null;var r=t.ofEdges(Math.max(this.left,e.left),Math.max(this.bottom,e.bottom),Math.min(this.right,e.right),Math.min(this.top,e.top));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(){return t.ofEdges(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}},{key:"floor",value:function(){return t.ofEdges(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}},{key:"toQuad",value:function(t){var e;if(t){var r=Zt.fromPoint({x:this.left,y:this.bottom}).transform(t),n=Zt.fromPoint({x:this.right,y:this.bottom}).transform(t),i=Zt.fromPoint({x:this.left,y:this.top}).transform(t),o=Zt.fromPoint({x:this.right,y:this.top}).transform(t);e=Ct(r.x,r.y,n.x,n.y,i.x,i.y,o.x,o.y)}else e=Ct(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return e}},{key:"toString",value:function(){return"gl-rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}}],[{key:"ofEdges",value:function(e,r,n,i){return new t(e,r,n-e,i-r)}},{key:"calculateBrushGLSegmentBounds",value:function(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,o=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}],a=.5*e.size,s=Math.abs(n*a);if(i){var u=new Zt(e.x,e.y,e.x,e.z);r=u.transform(i)}else r=e;var c=r.x,l=r.y,h=e.scaleX*a,f=e.scaleY*a,d=e.offsetX,p=-e.offsetY,y=Math.cos(e.rotation),v=Math.sin(e.rotation),g=Number.MAX_SAFE_INTEGER,m=Number.MIN_SAFE_INTEGER,b=Number.MAX_SAFE_INTEGER,E=Number.MIN_SAFE_INTEGER;return o.forEach((function(t){t.x=t.x*h+d,t.y=t.y*f+p;var e=y*t.x+v*t.y+c,r=-v*t.x+y*t.y+l,n=e-s;g=Math.min(g,n),m=Math.max(m,n),n=e+s,g=Math.min(g,n),m=Math.max(m,n);var i=r-s;b=Math.min(b,i),E=Math.max(E,i),i=r+s,b=Math.min(b,i),E=Math.max(E,i)})),t.ofEdges(g,b,m,E)}}]),t}();Object.defineProperty(Le,"SQURE",{value:Object.freeze([Object.freeze({x:-1,y:-1}),Object.freeze({x:1,y:-1}),Object.freeze({x:-1,y:1}),Object.freeze({x:1,y:1})]),enumerable:!0});var _e,Be=function(){function t(e,r,n,i){s(this,t);var o=e,a=r,u=e+n,c=r+i,l={x:(o+u)/2,y:(a+c)/2};Object.defineProperties(this,{left:{value:o,enumerable:!0},top:{value:a,enumerable:!0},right:{value:u,enumerable:!0},bottom:{value:c,enumerable:!0},x:{value:e,enumerable:!0},y:{value:r,enumerable:!0},width:{value:n,enumerable:!0},height:{value:i,enumerable:!0},center:{value:l,enumerable:!0},size:{value:{width:n,height:i},enumerable:!0}})}return c(t,[{key:"union",value:function(e){return e?t.ofEdges(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right),Math.max(this.bottom,e.bottom)):this}},{key:"intersect",value:function(e){if(!e)return null;var r=t.ofEdges(Math.max(this.left,e.left),Math.max(this.top,e.top),Math.min(this.right,e.right),Math.min(this.bottom,e.bottom));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(e){var r=Math.floor(this.left),n=Math.floor(this.top),i=Math.ceil(this.right),o=Math.ceil(this.bottom);if(e){var a=i-r,s=o-n;i=r+(a+=a%2),o=n+(s+=s%2)}return t.ofEdges(r,n,i,o)}},{key:"floor",value:function(e){var r=Math.ceil(this.left),n=Math.ceil(this.top),i=Math.floor(this.right),o=Math.floor(this.bottom);if(e){var a=i-r,s=o-n;i=r+(a-=a%2),o=n+(s-=s%2)}return t.ofEdges(r,n,i,o)}},{key:"contains",value:function(t){return this.left<=t.x&&this.right>=t.x&&this.top<=t.y&&this.bottom>=t.y}},{key:"transform",value:function(e){if(!e)return this;var r=Zt.fromPoint({x:this.left,y:this.top}).transform(e),n=Zt.fromPoint({x:this.right,y:this.top}).transform(e),i=Zt.fromPoint({x:this.left,y:this.bottom}).transform(e),o=Zt.fromPoint({x:this.right,y:this.bottom}).transform(e),a=Math.min(r.x,n.x,i.x,o.x),s=Math.min(r.y,n.y,i.y,o.y),u=Math.max(r.x,n.x,i.x,o.x),c=Math.max(r.y,n.y,i.y,o.y);return t.ofEdges(a,s,u,c)}},{key:"toPath",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ne.BLACK,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return{layout:[he.Property.X,he.Property.Y],size:e,color:t,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}},{key:"toGLRect",value:function(){return new Le(this.x,this.y,this.width,this.height)}},{key:"toString",value:function(){return"rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}},{key:"toJSON",value:function(){return{x:this.left,y:this.top,width:this.width,height:this.height}}}],[{key:"fromGLRect",value:function(e){if(!e)return null;if(!(e instanceof Le))throw new TypeError("rect must be instance of RectGL");return new t(e.left,e.bottom,e.width,e.height)}},{key:"isRect",value:function(t){return t&&isFinite(t.left)&&isFinite(t.top)&&isFinite(t.width)&&isFinite(t.height)}},{key:"fromRect",value:function(e){return new t(e.x,e.y,e.width,e.height)}},{key:"ofPolygon",value:function(e){return t.ofPolygons([e])}},{key:"ofPolygons",value:function(e){if(!e.length)return null;var r=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;return e.forEach((function(t){for(var e=0;e<t.length;e+=2){var a=t[e],s=t[e+1];r=Math.min(r,a),n=Math.min(n,s),i=Math.max(i,a),o=Math.max(o,s)}})),t.ofEdges(r,n,i,o)}},{key:"ofSpline",value:function(e,r){for(var n,i=0;i<e.length;i++)n=Le.calculateBrushGLSegmentBounds(e.getPoint(i),r).union(n);return t.fromGLRect(n)}},{key:"ofEdges",value:function(e,r,n,i){return new t(e,r,n-e,i-r)}},{key:"union",value:function(t,e){return t?e?t.union(e):t:e}},{key:"intersect",value:function(t,e){return t&&e?t.intersect(e):null}}]),t}(),Fe=function(){function t(){if(s(this,t),_e)throw new Error("URIResolver instance already available");_e=this,this.init()}return c(t,[{key:"init",value:function(){throw new Error("URIResolver: init should be implemented")}},{key:"get",value:function(t){return this[t]}},{key:"register",value:function(t,e){this[t]=e}},{key:"resolve",value:function(t){var e;if(t.includes("?")){var r=this[t.split("?")[0]];if(r){var n=t.split("?")[1],i=[];n.split("&").forEach((function(t){var e=t.split("=")[1],r=parseFloat(e);isFinite(r)?e=r:"true"==e?e=!0:"false"==e&&(e=!1),i.push(e)})),e=function(){return r.apply(void 0,L(Array.from(arguments).concat(i)))}}}else e=this[t];if(!e)throw new Error("Failed to resolve ".concat(t));return e}}]),t}();Object.defineProperty(Fe,"instance",{get:function(){return _e},enumerable:!0});var Ue=function(){function t(){s(this,t)}return c(t,null,[{key:"encode",value:function(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.Encoding.AUTO;if(n==t.Encoding.AUTO&&(n="undefined"==typeof Buffer?t.Encoding.ARRAY:t.Encoding.BUFFER),n==t.Encoding.NONE)r=e;else if(n==t.Encoding.ARRAY)r=e.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");var i=Buffer.from(e.buffer);switch(n){case t.Encoding.BUFFER:r=i.toJSON();break;case t.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}}return{encoding:n.name,type:e.constructor.name,points:r}}},{key:"decode",value:function(e){var r,n=t.Encoding[e.encoding];if(n==t.Encoding.NONE)r=e.points;else if(n==t.Encoding.ARRAY)r=e.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");var i;switch(n){case t.Encoding.BUFFER:i=Buffer.from(e.points);break;case t.Encoding.BASE64:i=Buffer.from(e.points,"base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}var o=new Uint8Array(i);r=new globalThis[e.type](o.buffer)}return r}},{key:"isTypedArrayData",value:function(t){return t&&t.encoding&&t.type&&t.type.endsWith("Array")}}]),t}();Ue.createEnum("Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);var je=function(){function t(e,r){s(this,t),this.name=e,Object.defineProperty(this,"value",{get:function(){if(!r){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(r=this.resolve(this.name)),!r){if(!Fe.instance)throw new Error("Resource URI ".concat(this.name," cannot be resolved. URIResolver not implemented yet. Please implement and instantiate."));r=Fe.instance.resolve(this.name)}if(!r)throw new Error("Resource URI ".concat(this.name," cannot be resolved. Please provide resource definition in URIResolver init implementation."))}return r},set:function(t){r=t},enumerable:!0})}return c(t,[{key:"toJSON",value:function(){var t=this.value;return ArrayBuffer.isTypedArray(t)?t=Ue.encode(t,this.encoding):"function"==typeof t&&(t=t()),{name:this.name,value:t}}}],[{key:"fromJSON",value:function(e){var r=e.value;return Ue.isTypedArrayData(r)&&(r=Ue.decode(r)),new t(e.name,r)}},{key:"getInstance",value:function(e,r){return new t(r,e)}}]),t}(),Ge=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;s(this,t),this.size=r,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return e||("function"==typeof(e=this.descriptor.shape.value)&&(e=e()),t.fitShape(e)),e},set:function(r){var n=this;if(!r)throw new Error("BrushPrototype: shape not found");Array.isArray(r)&&(r=r.toFloat32Array()),"string"==typeof r?r=new je(r):r instanceof Float32Array?r=je.getInstance(r):r instanceof je||(r=new je(r.name,r.value)),e=null,this.descriptor.shape=r,this.descriptor.shape.resolve=t.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:function(){return n.encoding},enumerable:!0})},enumerable:!0}),this.shape=e}return c(t,[{key:"toJSON",value:function(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}}],[{key:"fromJSON",value:function(e){return new t(je.fromJSON(e.shape),e.size)}},{key:"create",value:function(e){for(var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e,o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];switch(e){case t.Type.CIRCLE:r=De.createCircle.apply(De,a),i+="?precision=".concat(a[0]||"","&radius=").concat(a[1]||"");break;case t.Type.ELLIPSE:r=De.createEllipse.apply(De,a),i+="?precision=".concat(a[0]||"","&radiusX=").concat(a[1]||"","&radiusY=").concat(a[2]||"");break;case t.Type.STAR:r=De.createStar.apply(De,a),i+="?points=".concat(a[0]||"","&internalRadius=").concat(a[1]||"");break;default:console.error("Brush2D: createShape fails with ".concat(e," type"))}return new t({name:i,shape:r},n)}},{key:"resolve",value:function(e){var r,n=e.split("?"),i=n.first;if(Object.values(t.Type).includes(i)){var o=n.last.split("&"),a={};switch(o.forEach((function(t){a[t.substring(0,t.indexOf("="))]=t.substring(t.indexOf("=")+1)})),i){case t.Type.CIRCLE:var s=a.precision?parseInt(a.precision):void 0;r=De.createCircle(s);break;case t.Type.ELLIPSE:var u=a.precision?parseInt(a.precision):void 0,c=a.radiusX?parseFloat(a.radiusX):void 0,l=a.radiusY?parseFloat(a.radiusY):void 0;r=De.createEllipse(u,c,l);break;case t.Type.STAR:var h=a.points?parseInt(a.points):void 0,f=a.internalRadius?parseFloat(a.internalRadius):void 0;r=De.createStar(h,f);break;default:console.error("Brush2D: createShape fails with ".concat(i," type"))}}return r}},{key:"fitShape",value:function(e){t.centerShape(e);for(var r=Be.ofEdges(-1,-1,1,1),n=Be.ofPolygon(e),i=r.width/n.width,o=r.height/n.height,a=i>0&&o>0?Math.min(i,o):Math.max(i,o),s=0;s<e.length;s+=2)e[s]*=a,e[s+1]*=a}},{key:"centerShape",value:function(t){for(var e=Be.ofPolygon(t),r=0;r<t.length;r+=2)t[r]-=e.center.x,t[r+1]-=e.center.y}}]),t}();function Ye(t){return ze.apply(this,arguments)}function ze(){return(ze=a(i.mark((function t(e){var r,n,o,a,s=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:"binary",!(e instanceof Uint8Array)){t.next=3;break}return t.abrupt("return",e);case 3:return t.next=5,fetch(e,{mode:"no-cors"});case 5:if(o=t.sent,"json"!=r){t.next=12;break}return t.next=9,o.json();case 9:n=t.sent,t.next=28;break;case 12:if("text"!=r){t.next=18;break}return t.next=15,o.text();case 15:n=t.sent,t.next=28;break;case 18:if("blob"!=r){t.next=24;break}return t.next=21,o.blob();case 21:n=t.sent,t.next=28;break;case 24:return t.next=26,o.arrayBuffer();case 26:a=t.sent,n=new Uint8Array(a);case 28:return t.abrupt("return",n);case 29:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Xe(t){return new Promise((function(e,r){var n,i=new Image;i.crossOrigin="anonymous",i.onload=function(){if(x.type2D==x.Type2D.OFFSCREEN){var t=new OffscreenCanvas(i.width,i.height);t.getContext("2d").drawImage(i,0,0),e(t)}else n&&URL.revokeObjectURL(n),e(i)},i.onerror=r,"string"==typeof t?i.src=t:x.type2D==x.Type2D.OFFSCREEN?t instanceof Uint8Array?i.src=Buffer.from(t):t instanceof OffscreenCanvas?e(t):i.src=t:(t instanceof Uint8Array&&(t=t.buffer),t instanceof ArrayBuffer&&(t=new Blob([t],{type:"image/png"})),n=URL.createObjectURL(t),i.src=n)}))}function Ve(t){return He.apply(this,arguments)}function He(){return(He=a(i.mark((function t(e){var r;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("string"!=typeof e&&"undefined"!=typeof createImageBitmap){t.next=6;break}return t.next=3,Xe(e);case 3:r=t.sent,t.next=15;break;case 6:if(!(e instanceof ArrayBuffer||e instanceof Uint8Array)){t.next=12;break}return t.next=9,createImageBitmap(new Blob([e],{type:"image/png"}));case 9:r=t.sent,t.next=15;break;case 12:return t.next=14,createImageBitmap(e);case 14:r=t.sent;case 15:return t.abrupt("return",r);case 16:case"end":return t.stop()}}),t)})))).apply(this,arguments)}Ge.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var qe=Object.freeze({__proto__:null,loadFile:Ye,loadImage:Ve,saveAs:function(t,e){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/octet-stream";if(t instanceof Blob)r=URL.createObjectURL(t);else{var i;t instanceof ArrayBuffer?i=[t]:t.buffer?(t.byteLength<t.buffer.byteLength&&(t=new Uint8Array(t)),i=[t.buffer]):t instanceof Array&&(i=t);var o=new Blob(i,{type:n});r=URL.createObjectURL(o)}var a=document.createElement("a");a.href=r,a.download=e,a.appendChild(document.createTextNode(e)),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout((function(){URL.revokeObjectURL(r),a.remove()}),911)}});function Ze(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return We(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return We(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function We(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var Ke=function(){function t(e,r,n){var i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;s(this,t),isFinite(n)&&(o=n,n=void 0),o<=0&&(console.warn("Invalid spacing found ".concat(o,". It should be positive number.")),o=1),this.name=e,Object.defineProperty(this,"shape",{get:function(){return r},set:function(t){if(t instanceof Float32Array&&(t=new Ge(t)),!this.validate(t))throw console.warn(t),new Error("Brush2D: Invalid shape found");Array.isArray(t)&&(1==t.length?t=t.first:t.sort(be.comparator({sortBy:"size",sortOrder:"asc"}))),r=t},enumerable:!0}),this.shape=r,this.fill=n,this.spacing=o,Object.defineProperty(this,"encoding",{get:function(){return i},set:function(t){if(Array.isArray(this.shape)){var e,r=Ze(this.shape);try{for(r.s();!(e=r.n()).done;){e.value.encoding=t}}catch(t){r.e(t)}finally{r.f()}}else this.shape.encoding=t},enumerable:!0})}var e;return c(t,[{key:"validate",value:function(t){var e=!1;if(Array.isArray(t)){var r,n=Ze(t);try{for(n.s();!(r=n.n()).done;){if(!(e=r.value instanceof Ge))break}}catch(t){n.e(t)}finally{n.f()}}else e=t instanceof Ge;return e}},{key:"configure",value:(e=a(i.mark((function t(e){var r;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.pattern&&this.fill){t.next=2;break}return t.abrupt("return");case 2:if(e instanceof CanvasRenderingContext2D||e instanceof OffscreenCanvasRenderingContext2D){t.next=4;break}throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");case 4:return t.next=6,Ve(this.fill);case 6:r=t.sent,this.pattern=e.createPattern(r,"repeat");case 8:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})},{key:"selectShape",value:function(t){var e;if(Array.isArray(this.shape)){for(var r=1;r<this.shape.length;r++)if(this.shape[r].size>t){e=this.shape[r-1];break}e||(e=this.shape.last)}else e=this.shape;return e.shape}},{key:"toJSON",value:function(){var t=Array.isArray(this.shape)?this.shape:[this.shape];return{type:this.constructor.name,name:this.name,spacing:this.spacing,shape:t.map((function(t){return t.toJSON()}))}}}],[{key:"fromJSON",value:function(e){var r=1==e.shape.length?Ge.fromJSON(e.shape[0]):e.shape.map((function(t){return Ge.fromJSON(t)}));return new t(e.name,r,e.spacing)}}]),t}(),Je=function(){function t(){s(this,t),this.state={}}return c(t,null,[{key:"excludedProps",get:function(){return[he.Property.D_X,he.Property.D_Y]}},{key:"posProps",get:function(){return[he.Property.X,he.Property.Y,he.Property.Z]}},{key:"colorProps",get:function(){return[he.Property.RED,he.Property.GREEN,he.Property.BLUE,he.Property.ALPHA]}},{key:"transformProps",get:function(){return[he.Property.ROTATION,he.Property.SCALE_X,he.Property.SCALE_Y,he.Property.SCALE_Z,he.Property.OFFSET_X,he.Property.OFFSET_Y,he.Property.OFFSET_Z]}}]),c(t,[{key:"isLayoutPart",value:function(e){if(t.posProps.includes(e))return this.inputLayout.includes(e.name);if(this.brush instanceof Ke&&t.colorProps.includes(e))return!1;if(t.excludedProps.includes(e))return!1;if(this.basicMode&&t.transformProps.includes(e))return!1;var r=!1,n=be.getPropName(e.name),i=this.dynamics[n];if(i&&!i.disabled)if(i.dependencies&&i.dependencies.length>0){var o=this.inputLayout.map((function(t){return xe.Type[t]}));r=i.dependencies.filter((function(t){return o.includes(t)})).length>0}else r=!0;return r}},{key:"calculate",value:function(e,r,n){var i=this;for(var o in this.point=r.createPathPoint(),this.statics)this.point[o]=this.statics[o];return this.calculateProperty(he.Property.SIZE,e,r,n),t.colorProps.forEach((function(t){return i.calculateProperty(t,e,r,n)})),t.transformProps.forEach((function(t){return i.calculateTransform(t,e,r,n)})),this.point}},{key:"calculateProperty",value:function(e,r,n,i){if(this.layout.includes(e)){var o,a=be.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else if(this.inputLayout.includes("PRESSURE")){var c=n.pressure||r.pressure/2;o=t.mapTo(c,u.pressure,s.value)}else{var l=n.speed(r,i);o=t.mapTo(l,u.velocity,s.value)}this.point[be.getPropName(e.name)]=o}}},{key:"calculateTransform",value:function(e,r,n,i){if(this.layout.includes(e)){var o,a=be.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else{var c=s.dependencies||[];if(e==he.Property.ROTATION)if(c.includes(xe.Type.ROTATION)&&this.inputLayout.includes("ROTATION"))o=n.rotation;else{if(!c.includes(xe.Type.AZIMUTH)||!this.inputLayout.includes("AZIMUTH"))throw new Error("Property ".concat(e.name," is not configured properly. Dependencies are expected or resolve handler."));o=n.computeNearestAzimuthAngle(r)}else if(c.includes(xe.Type.ALTITUDE)&&this.inputLayout.includes("ALTITUDE")){n.cosAltitude||(n.cosAltitude=Math.cos(n.altitude));var l=n.cosAltitude;o=t.mapTo(l,u.altitude,s.value)}else{if(e!=he.Property.SCALE_X&&e!=he.Property.SCALE_Y||!c.includes(xe.Type.RADIUS_X)&&!c.includes(xe.Type.RADIUS_Y)||!this.inputLayout.includes("RADIUS_X")||!this.inputLayout.includes("RADIUS_Y"))throw new Error("Property ".concat(e.name," is not configured properly. Dependencies are expected or resolve handler."));var h=e==he.Property.SCALE_X?"radiusX":"radiusY",f=n[h];o=t.mapTo(f,u[h],s.value)}}if(isNaN(o))throw new Error("Property ".concat(e.name," has no value"));this.point[be.getPropName(e.name)]=o}}},{key:"reset",value:function(e,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.brush=r,this.dynamics=o,this.statics={},this.color=new Ne(0,0,0),this.inputLayout=Me.getLayout(e),this.layout=he.Property.values.filter((function(t){return i.isLayoutPart(t)})),this.debug&&console.log(e.pointer.type,this.inputLayout,this.layout.map((function(t){return t.name})),e),"size"in a){if(this.isLayoutPart(he.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=a.size}else{if(!this.isLayoutPart(he.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");if(0==e.pressure&&"pen"==e.pointer.type)throw new Error("Hover point detected. Should be handeled manually.")}t.colorProps.forEach((function(t){var e=be.getPropName(t.name);i.isLayoutPart(t)?i.color[e]=n[e]:(i.statics[e]=isFinite(a[e])?a[e]:n[e],i.color[e]=i.statics[e])})),t.transformProps.forEach((function(t){if(!i.isLayoutPart(t)){var e=be.getPropName(t.name);isFinite(a[e])&&(i.statics[e]=a[e])}})),this.resetState(e)}},{key:"resetState",value:function(e){var r=this;this.state={},[he.Property.SIZE].concat(t.colorProps).forEach((function(e){if(r.layout.includes(e)){var n=be.getPropName(e.name),i=r.dynamics[n],o={};if(i.resolve)o.resolve=t.resolveAction(i.resolve);else{if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));var a=r.clonePropertySettings(i.velocity,0,4e3);a.remap=t.resolveAction(a.remap||i.value.remap);var s=r.clonePropertySettings(i.pressure,0,1);s.remap=t.resolveAction(s.remap||i.value.remap),o.velocity=t.validateRange(n,a,{min:0,max:3e4}),o.pressure=t.validateRange(n,s,{min:0,max:1})}r.state[n]=o}})),t.transformProps.forEach((function(n){if(r.layout.includes(n)){var i=be.getPropName(n.name),o=r.dynamics[i],a={};if(o.resolve)a.resolve=t.resolveAction(o.resolve);else if(o.dependencies){if(o.dependencies.includes(xe.Type.ALTITUDE)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));var s=r.clonePropertySettings(o.altitude,0,Math.PI/2);s.remap=t.resolveAction(s.remap||o.value.remap),a.altitude=t.validateRange(i,s,{min:0,max:Math.PI/2})}if(n==he.Property.SCALE_X&&o.dependencies.includes(xe.Type.RADIUS_X)||n==he.Property.SCALE_Y&&o.dependencies.includes(xe.Type.RADIUS_Y)){if(!o.value)throw new Error("PathPointContext: dynamics ".concat(i," value property not found"));var u=n==he.Property.SCALE_X?"radiusX":"radiusY",c=e[u]<=1?0:1,l=e[u]<=1?1:50,h=e[u]<=1?{min:0,max:1,remap:o[u].remap}:o[u],f=r.clonePropertySettings(h,c,l);f.remap=t.resolveAction(f.remap||o.value.remap),a[u]=t.validateRange(i,f,{min:c,max:l})}}r.state[i]=a}}))}},{key:"clonePropertySettings",value:function(t,e,r){var n;return t?("min"in(n=Object.clone(t))||(n.min=e),"max"in n||(n.max=r)):n={min:e,max:r},n}}],[{key:"resolveAction",value:function(t){if(t)return"string"==typeof t?t=new je(t):"function"==typeof t?t=je.getInstance(t):t instanceof je||(t=new je(t.name,t.value)),t.value}},{key:"validateRange",value:function(t,e,r){if(e.min<r.min||e.max>r.max)throw new Error("".concat(t," config is out of range - (").concat(e.min,", ").concat(e.max,"), expected values interval - (").concat(r.min,", ").concat(r.max,")"));if(e.min>e.max)throw new Error("".concat(t," min ").concat(e.min," exceeds max ").concat(e.max));return e}},{key:"mapTo",value:function(t,e,r){var n=(be.clamp(t,e)-e.min)/(e.max-e.min);return e.remap&&(n=e.remap(n)),r.min+n*(r.max-r.min)}}]),t}(),Qe=x.commonJS?require("clipper-lib"):ClipperLib,$e=Qe.Clipper,tr=Qe.Paths,er=Qe.Path,rr=Qe.ClipType,nr=Qe.PolyType,ir=Qe.PolyFillType,or=function(){function t(e){s(this,t);var r=new tr;"number"==typeof e[0]&&(e=[e]);var n=Be.ofPolygons(e),i=65534/(n.width+1e-16),o=65534/(n.height+1e-16),a=Math.floor(Math.min(i,o)),u=n.left+32767/a,c=n.top+32767/a;e.forEach((function(t){for(var e=new er,n=0;n<t.length;n+=2){var i=(t[n]-u)*a,o=(t[n+1]-c)*a,s=i<0?Math.ceil(i):Math.floor(i),l=o<0?Math.ceil(o):Math.floor(o);e.push({X:s,Y:l})}r.push(e)})),this.subject=r,this.solution=new tr,this.bounds=n,this.transform={scale:a,offsetX:u,offsetY:c},this.filter=new Set}return c(t,[{key:"toPath2D",value:function(t){var e=this,r=[];return this.lastPoint={},this.lastSize=0,this.solution.forEach((function(n){var i=e.flatPath(n,t);i.length>0&&r.push(i)})),this.filter.clear(),r}},{key:"flatPath",value:function(t,e){var r=this,n=[];return t.forEach((function(t,i){e?(r.filter.add("".concat(t.X,"-").concat(t.Y)),r.filter.size>r.lastSize?(n.push(t.X/r.transform.scale+r.transform.offsetX,t.Y/r.transform.scale+r.transform.offsetY),r.lastSize++):r.debug&&console.warn("Duplicate point detected: {".concat(t.X,", ").concat(t.Y,"}"))):r.lastPoint.X!=t.X||r.lastPoint.Y!=t.Y?(n.push(t.X/r.transform.scale+r.transform.offsetX,t.Y/r.transform.scale+r.transform.offsetY),r.lastPoint=t):r.debug&&console.warn("Duplicate point detected: {".concat(t.X,", ").concat(t.Y,"}"))})),n.length<6&&(this.debug&&console.warn("Invalid contour found: [".concat(n.join(", "),"]")),n.clear()),n}},{key:"apply",value:function(t){var e=this,r=new tr;return"number"==typeof t[0]&&(t=[t]),t.forEach((function(t){for(var n=new er,i=0;i<t.length;i+=2){var o=(t[i]-e.transform.offsetX)*e.transform.scale,a=(t[i+1]-e.transform.offsetY)*e.transform.scale,s=o<0?Math.ceil(o):Math.floor(o),u=a<0?Math.ceil(a):Math.floor(a);n.push({X:s,Y:u})}r.push(n)})),r}}]),t}(),ar=function(){function t(e,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;s(this,t),Array.isArray(r)&&(r=t.allocateBuffer(r)),Object.defineProperty(this,"layout",{value:e,enumerable:!0}),Object.defineProperty(this,"points",{get:function(){return r},enumerable:!0}),Object.defineProperty(this,"stride",{value:e.length,enumerable:!0}),Object.defineProperty(this,"length",{value:r.length/e.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:i,enumerable:!0}),this.ts=o,this.tf=a,Object.defineProperty(this,"bounds",{get:function(){return Be.ofSpline(n,n.pointProps.scattering).ceil()},enumerable:!0}),this.restoreBuffer=function(t){if("undefined"!=typeof SharedArrayBuffer&&n.points.buffer instanceof SharedArrayBuffer)throw new Error("Underlying buffer is SharedArrayBuffer and cannot be restored");if(r.buffer.byteLength>0)throw new Error("Cannot restore buffer when underlying buffer is not empty");r=new Float32Array(t)},Object.defineProperty(this,"color",{get:function(){return Ne.isColor(this.pointProps)?Ne.fromColor(this.pointProps):void 0},set:function(t){t?(i.red=t.red,i.green=t.green,i.blue=t.blue,i.alpha=t.alpha):(i.red=void 0,i.green=void 0,i.blue=void 0,i.alpha=void 0)},enumerable:!0}),Object.defineProperty(this,"size",{get:function(){return i.size},set:function(t){i.size=t},enumerable:!0}),this.validate()}return c(t,[{key:"validate",value:function(){if(!this.layout.includes(he.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(he.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(he.Property.SIZE)&&isNaN(this.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}},{key:"validateSegmentsCount",value:function(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}},{key:"clone",value:function(){return new t(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}},{key:"getPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e=he.createInstance(this.layout,this.points,t,this.pointProps);return this.matrix&&e.transform(this.matrix),e}},{key:"setPoint",value:function(t,e){var r=this,n=t*this.stride;this.layout.forEach((function(t,i){return r.points[n+i]=e.getProperty(t)}))}},{key:"getPath",value:function(){for(var t=[],e=this.layout.indexOf(he.Property.X),r=this.layout.indexOf(he.Property.Y),n=0;n<this.length;n++)t.push(this.points[n*this.stride+e],this.points[n*this.stride+r]);return t}},{key:"slice",value:function(e,r,n,i){if(e<0||e>this.length-4)throw new Error("Invalid fromIndex ".concat(e," found. Ensure that fromIndex range is {0, ").concat(this.length-4,"}."));if(r<1||r+1>this.length)throw new Error("Invalid toIndex ".concat(r," found. Ensure that fromIndex range is {1, ").concat(this.length,"}."));if(r+1-e<4)throw new Error("Invalid range {".concat(e,", ").concat(r,"} found. At least 4 points are needed to define spline."));var o;if("undefined"!=typeof SharedArrayBuffer&&this.points.buffer instanceof SharedArrayBuffer){var a=this.points.subarray(e*this.stride,(r+1)*this.stride),s=new SharedArrayBuffer(a.length*Float32Array.BYTES_PER_ELEMENT);(o=new Float32Array(s)).set(a)}else o=this.points.slice(e*this.stride,(r+1)*this.stride);var u=new t(this.layout.slice(),o,Object.clone(this.pointProps),n,i);return u.randomSeed=this.randomSeed,u}},{key:"setTransform",value:function(t){this.matrix=t}},{key:"transform",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.matrix,e=0,r=0;r<this.length;r++){var n=this.getPoint(r);n.transform(t),this.setPoint(r,n),e=n.rotation}this.layout.includes(he.Property.ROTATION)||(0==e?delete this.pointProps.rotation:this.pointProps.rotation=e)}},{key:"toJSON",value:function(){return{type:"Spline",layout:this.layout.map((function(t){return t.name})),points:Ue.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}}],[{key:"allocateBuffer",value:function(t){if("undefined"==typeof SharedArrayBuffer)return t.toFloat32Array();var e=new SharedArrayBuffer(t.length*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(e);return r.set(t),r}},{key:"fromJSON",value:function(e){var r=Ue.decode(e.points),n=new t(e.layout.map((function(t){return he.Property[t]})),r,e.pointProps,e.ts,e.tf);return n.randomSeed=e.randomSeed,n}},{key:"createRect",value:function(e,r,n){var i=e.toPath(r,n);return new t(i.layout,i.points,{size:i.size,red:r.red,green:r.green,blue:r.blue,alpha:r.alpha})}}]),t}(),sr=function(){function t(){s(this,t),this.path=[],this.firstSegment=!1,this.lastSegment=!0;var e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return c(t,[{key:"add",value:function(e,r,n,i){var o;if(e&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");e&&this.path.clear(),this.firstSegment=e,this.lastSegment=r;var a=this.addImpl(n,i);return this.keepAllData&&(o=this.path).push.apply(o,L(a.added)),{added:this.getOutput(a.added,t.OutputType.ADDITION),predicted:this.getOutput(a.predicted,t.OutputType.PREDICTION)}}},{key:"get",value:function(e){this.reset(),this.firstSegment=!0,this.lastSegment=!0;var r=this.getImpl(e,t.OutputType.PROCESSOR);return this.getOutput(r,t.OutputType.PROCESSOR)}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}},{key:"getImpl",value:function(t){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"reset",value:function(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}]),t}();function ur(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}sr.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);var cr=function(t){d(r,t);var e=ur(r);function r(t,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return s(this,r),o=e.call(this,t,n,i),Object.defineProperty(p(o),"tValues",{value:Object.freeze(a),enumerable:!0}),Object.defineProperty(p(o),"ts",{get:function(){return a.first},enumerable:!0}),Object.defineProperty(p(o),"tf",{get:function(){return a.last},enumerable:!0}),delete o.segmentsCount,o}return c(r,[{key:"slice",get:function(){}}]),c(r,[{key:"validateSegmentsCount",value:function(){}},{key:"clone",value:function(){return new r(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.tValues.slice())}},{key:"getPointT",value:function(t){return this.tValues[t]}},{key:"toJSON",value:function(){return{type:"InterpolatedSpline",layout:this.layout.map((function(t){return t.name})),points:Ue.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}}],[{key:"fromJSON",value:function(t){var e=Ue.decode(t.points);return new r(t.layout.map((function(t){return he.Property[t]})),e,t.pointProps,t.tValues)}}]),r}(ar);function lr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var hr,fr,dr,pr,yr,vr,gr,mr,br,Er,xr,Pr,wr,kr,Rr,Sr,Ir,Tr=(hr=0,fr=-.5,dr=1,pr=-.5,yr=1,vr=0,gr=-2.5,mr=1.5,br=0,Er=.5,xr=2,Pr=-1.5,wr=0,kr=0,Rr=-.5,Sr=.5,(Ir=new B(16))[0]=hr,Ir[1]=fr,Ir[2]=dr,Ir[3]=pr,Ir[4]=yr,Ir[5]=vr,Ir[6]=gr,Ir[7]=mr,Ir[8]=br,Ir[9]=Er,Ir[10]=xr,Ir[11]=Pr,Ir[12]=wr,Ir[13]=kr,Ir[14]=Rr,Ir[15]=Sr,Ir),Ar=function(t){d(r,t);var e=lr(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return s(this,r),(t=e.call(this)).calculateDerivates=n,t.keepTValues=i,t.state={lastPointPosition:void 0,lastPointSize:0},t}return c(r,[{key:"initState",value:function(t){var e=this;this.state.layout={},t.layout.forEach((function(t,r){e.state.layout[t.name]={index:r,polynomials:lt()}})),this.keepTValues&&(this.state.tValues=[]),this.splineLayout=t.layout,this.pathPointProps=t.pointProps,this.scattering&&(this.pathPointProps.scattering=this.scattering),this.layout=this.calculateDerivates?t.layout.concat([he.Property.D_X,he.Property.D_Y]):t.layout,this.state.ready=!0}},{key:"addImpl",value:function(t,e){return{added:this.getImpl(t,r.OutputType.ADDITION),predicted:this.getImpl(e,r.OutputType.PREDICTION)}}},{key:"getImpl",value:function(t,e){if(!t)return[];var n;if(this.state.ready||this.initState(t),e==r.OutputType.PREDICTION){var i=Object.clone(this.state);delete this.state.tValues,this.resetState(),n=this.discretize(t),this.state=i}else n=this.discretize(t);return n}},{key:"getOutput",value:function(t,e){if(0!=t.length){var n=e==r.OutputType.PREDICTION?void 0:this.state.tValues;return n&&(n=n.slice()),new cr(this.layout,t,this.pathPointProps,n)}}},{key:"discretize",value:function(t){throw new Error("This method is abstract and should be implemented")}},{key:"storeLastPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.state.lastPointPosition=new Zt(this.getPropValue(he.Property.X,t,e),this.getPropValue(he.Property.Y,t,e),this.getPropValue(he.Property.Z,t,e)),this.state.lastPointSize=this.getPropValue(he.Property.SIZE,t,e)}},{key:"getPropValue",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.state.layout[t.name]?e[r+this.state.layout[t.name].index]:void 0}},{key:"calculatePolynomials",value:function(t,e){var r=this,n=this.splineLayout.length*(e+0),i=this.splineLayout.length*(e+1),o=this.splineLayout.length*(e+2),a=this.splineLayout.length*(e+3);this.splineLayout.forEach((function(e,s){var u=ht(t[n+s],t[i+s],t[o+s],t[a+s]);Et(r.state.layout[e.name].polynomials,u,Tr)}))}},{key:"samplePoint",value:function(t){var e=this,r=[],n=ht(1,t,t*t,t*t*t);return this.splineLayout.forEach((function(t){var i=bt(e.state.layout[t.name].polynomials,n);r.push(i)})),this.calculateDerivates&&(r.push(this.getDerivativeOf(this.state.layout.X.polynomials,n)),r.push(this.getDerivativeOf(this.state.layout.Y.polynomials,n))),r}},{key:"getDerivativeOf",value:function(t,e){return bt(ht(t[1],2*t[2],3*t[3],0),e)}},{key:"addT",value:function(t){this.state.tValues&&this.state.tValues.push(t)}},{key:"resetState",value:function(){}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.state.ready=!1,this.state.lastPointPosition=void 0,this.state.lastPointSize=0,delete this.state.tValues}}]),r}(sr);function Cr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Or,Mr=function(t){d(r,t);var e=Cr(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,i=arguments.length>1?arguments[1]:void 0,o=arguments.length>2?arguments[2]:void 0;return s(this,r),(t=e.call(this,i,o)).spacing=n,t}return c(r,[{key:"split",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,r=this.spacing;this.spacing=1,this.splitCount=e;var n=this.get(t);return this.spacing=r,delete this.splitCount,n}},{key:"discretize",value:function(t){for(var e=[],r=this.splitCount,n=Math.max(1,10*(this.spacing>1?1:this.spacing)),i=0;i<t.segmentsCount;i++){if(this.calculatePolynomials(t.points,i),isNaN(this.splitCount)){var o=t.getPoint(i+1),a=t.getPoint(i+2),s=Lt(o.value,a.value),u=this.pathPointProps.size;this.state.layout.SIZE&&(u=Math.min(o.size,a.size)),r=Math.floor(n*(s/u)/this.spacing)+1}for(var c=1/r,l=0;l<=r;l++){var h=!this.state.lastPointPosition,f=l/r;if(0==i&&f<t.ts){if(!(f+c>=t.ts))continue;f=t.ts,h=this.spacing<=1}if(i==t.segmentsCount-1&&f>=t.tf){if(!(f<t.tf+c))continue;f=t.tf,h=this.lastSegment&&this.spacing<=1}if(!(i>0&&0==f)){var d=this.samplePoint(f);if(!h&&this.state.lastPointPosition){var p=new Zt(this.getPropValue(he.Property.X,d),this.getPropValue(he.Property.Y,d),this.getPropValue(he.Property.Z,d)),y=this.state.lastPointPosition.vec.squaredDistance(this.state.lastPointPosition.value,p.value),v=(this.state.layout.SIZE?(this.state.lastPointSize+d[this.state.layout.SIZE.index])/2:this.pathPointProps.size)*this.spacing;h=y>=v*v}h&&(e.push.apply(e,L(d)),this.storeLastPoint(d),this.addT(f))}}}return this.state.tValues&&(0!=e.length&&this.state.tValues.first==t.ts||(e.unshift.apply(e,L(this.samplePoint(t.ts))),this.state.tValues.unshift(t.ts)),this.state.tValues.last!=t.tf&&(e.push.apply(e,L(this.samplePoint(t.tf))),this.state.tValues.push(t.tf))),e}}]),r}(Ar),Dr=function(){function t(){s(this,t)}return c(t,null,[{key:"union",value:function(t,e){var r=new or(t),n=new $e;return n.StrictlySimple=!0,n.AddPaths(r.subject,nr.ptSubject,!0),n.Execute(rr.ctUnion,r.solution,ir.pftNonZero,ir.pftNonZero),r.toPath2D(e)}},{key:"intersection",value:function(t,e){t instanceof or||(t=new or(t)),t.clip=t.apply(e);var r=new $e;return r.StrictlySimple=!0,r.AddPaths(t.subject,nr.ptSubject,!0),r.AddPaths(t.clip,nr.ptClip,!0),r.Execute(rr.ctIntersection,t.solution,ir.pftNonZero,ir.pftNonZero),t.solution.length>0?t:null}},{key:"createClipperPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=new er;r.scale=e;for(var n=0;n<t.length;n++){var i=n*t.stride;r.push({X:Math.round(t.points[i]*e),Y:Math.round(t.points[i+1]*e)})}return r}},{key:"containsPoint",value:function(t,e){var r={X:Math.round(e.x*t.scale),Y:Math.round(e.y*t.scale)};return 1==$e.PointInPolygon(r,t)}}]),t}(),Nr=function(){function t(){s(this,t),this.interpolator=new Mr(.1,!1,!0)}return c(t,[{key:"build",value:function(t,e,r){var n=this;return this.context=t,this.pathContext=new or(r),this.result={},this.holes=[],this.debug&&(e=e.unique()),e.sort(be.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),this.debug&&(this.table=new re([{name:"strokeID",title:"Stroke ID"},{name:"segmentIndex",title:"Segment Index"},{name:"splineIndex",title:"Spline Index"},{name:"pointIndex",title:"Point Index"},{name:"prevT",title:"Prev T"},{name:"t",title:"T Value"},{name:"nextT",title:"Next T"},{name:"ts",title:"Start T"},{name:"tf",title:"End T"},{name:"size",title:"Size"},{name:"shapeSize",title:"Shape Size"},{name:"hole",title:"HolePart"},{name:"nodeIndex",title:"Node Index"}])),e.forEach((function(t){n.isHolePart(t)?n.update(t):n.add(t),n.debug&&n.table.insert({strokeID:t.strokeID,segmentIndex:t.segmentIndex,splineIndex:t.splineIndex,pointIndex:t.pointIndex,prevT:t.prevT.toFixed(4),t:t.t.toFixed(4),nextT:t.nextT.toFixed(4),ts:t.spline.ts.toFixed(4),tf:t.spline.tf.toFixed(4),size:"".concat(t.bounds.width.toFixed(2)," / ").concat(t.bounds.height.toFixed(2)),shapeSize:"".concat(t.shapeBounds.width.toFixed(2)," / ").concat(t.shapeBounds.height.toFixed(2)),hole:t.hole,nodeIndex:t.nodeIndex})})),this.debug&&this.table.length>0&&console.log(this.table.toString()),this.narrow(),this.result}},{key:"add",value:function(t){this.holes=this.result[t.strokeID],this.holes||(this.holes=[],this.result[t.strokeID]=this.holes);var e=t.segmentIndex,r=t.segmentIndex,n=this.context.getNodes(t.strokeID).indexOf(t);this.holes.push({fromIndex:e,toIndex:r,fromTValue:t.prevT,toTValue:t.nextT,fromNodeIndex:n,toNodeIndex:n,strokeID:t.strokeID}),this.debug&&(t.hole=!1,t.nodeIndex=n)}},{key:"update",value:function(t){var e=this.holes.last;e.toIndex=t.segmentIndex,e.toTValue=t.nextT,e.toNodeIndex=this.context.getNodes(t.strokeID).indexOf(t),this.debug&&(t.hole=!0,t.nodeIndex=e.toNodeIndex)}},{key:"isHolePart",value:function(t){var e=this.holes.last;return!(!e||e.strokeID!=t.strokeID)&&(t.segmentIndex==e.toIndex&&t.prevT<=e.toTValue||t.segmentIndex==e.toIndex+1&&1==e.toTValue&&0==t.prevT)}},{key:"narrow",value:function(){var t=this;this.holes.forEach((function(e){var r,n=t.context.getNodes(e.strokeID),i=n[e.fromNodeIndex],o=n[e.toNodeIndex];r=e.toNodeIndex+1-e.fromNodeIndex<=2?t.extractT(i,"sf",i.prevT,o.nextT):{s:t.extractT(i,"s",i.prevT,i.nextT).s,f:t.extractT(o,"f",o.prevT,o.nextT).f},i.ts=r.s,o.tf=r.f,e.fromTValue=r.s,e.toTValue=r.f}))}},{key:"extractT",value:function(t,e,r,n){if(r==n)return{};for(var i,o={},a=e.startsWith("s"),s=new ar(t.spline.layout,t.spline.points,t.spline.pointProps,r,n),u=this.interpolator.get(s),c=0;c<u.length;c++){var l=u.getPoint(c),h=this.context.getBrushApplier(t.strokeID).applyBrush(l);if(Dr.intersection(this.pathContext,h)){if(a){if(o.s=i,e.endsWith("f")){i=u.getPointT(c),a=!1;continue}break}i=u.getPointT(c)}else if(a&&(i=u.getPointT(c)),!a&&(o.f=i,i))break}if(isNaN(o.s)&&(o.s=r),isNaN(o.f)&&(o.f=n),o.s==o.f){var f=u.tValues.indexOf(o.s);0==f?o.f=u.tValues[f+1]:o.s=u.tValues[f-1]}return o}}]),t}();Object.defineProperty(globalThis,"DIGITAL_INK_DEBUG",{get:function(){return Or},set:function(t){Or=t||{},se.debug=Or.InputListener,Je.prototype.debug=Or.PathPointContext,or.prototype.debug=Or.ClipperContext,Nr.prototype.debug=Or.HolesBuilder},enumerable:!0,configurable:!0});var Lr=Object.freeze({__proto__:null,vector:function(t,e){var r,n={};return Object.defineProperty(n,"x",{value:e.x-t.x,enumerable:!0}),Object.defineProperty(n,"y",{value:e.y-t.y,enumerable:!0}),Object.defineProperty(n,"length",{get:function(){return isNaN(r)&&(r=Math.sqrt(n.x*n.x+n.y*n.y)),r},enumerable:!0}),n},angle:function(t,e){var r=t.x*e.x+t.y*e.y,n=t.x*e.y-t.y*e.x;return Math.atan2(n,r)}}),_r=function(){function t(e){var r=this;s(this,t),this.phase=e.phase;var n=isNaN(e.altitude)||isNaN(e.azimuth)?void 0:{altitude:e.altitude,azimuth:e.azimuth};Object.defineProperty(this,"x",{value:e.x,enumerable:!0}),Object.defineProperty(this,"y",{value:e.y,enumerable:!0}),Object.defineProperty(this,"z",{value:e.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:e.timestamp,enumerable:!0}),Object.defineProperty(this,"force",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:e.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:e.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:e.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:function(){return n||(n=r.computeTilt(e)||{}),n.altitude},enumerable:!0}),Object.defineProperty(this,"azimuth",{get:function(){return n||(n=r.computeTilt(e)||{}),n.azimuth},enumerable:!0}),e.pointer&&Object.defineProperty(this,"pointer",{value:e.pointer,enumerable:!0}),this.computedAzimuth=void 0}return c(t,[{key:"createPathPoint",value:function(){return new he(this.x,this.y,this.z)}},{key:"computeTilt",value:function(t){if(!isNaN(t.tiltX)&&!isNaN(t.tiltY)){var e=t.tiltX,r=t.tiltY,n=Math.tan(Math.toRadians(e)),i=Math.tan(Math.toRadians(r)),o=Math.sqrt(n*n+i*i);return{altitude:Math.atan2(1,o),azimuth:Math.atan2(i,n)}}}},{key:"speed",value:function(e,r){var n={x:0,y:0,time:0};if((n=e&&!r?this.minus(e):r&&!e?r.minus(this):r.minus(e)).time>0)return t.getMagnitude(n.x,n.y)/(n.time/1e3);if(0==n.time)return 0;throw new Error("Speed out of range: ".concat(n.time))}},{key:"computeNearestAzimuthAngle",value:function(t){var e;if(isNaN(this.azimuth))return 0;if(t){if(isNaN(t.azimuth))return 0;var r=2*Math.PI,n=t.computedAzimuth||t.azimuth,i=parseInt(n/r),o=(e=this.azimuth+i*r)-n;o>=Math.PI?e-=r:o<-Math.PI&&(e+=r)}else e=this.azimuth;return this.computedAzimuth=e,e}},{key:"minus",value:function(t){return{x:this.x-t.x,y:this.y-t.y,time:this.timestamp-t.timestamp}}}],[{key:"getMagnitude",value:function(t,e){return Math.sqrt(t*t+e*e)}}]),t}();_r.createEnum("Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);var Br=function(){function t(){s(this,t),this.reset()}return c(t,[{key:"add",value:function(t,e,r){var n;t==_.Phase.BEGIN?this.reset(!0):t==_.Phase.END&&(this.last=!0),e&&(n=this.accumulatedAddition).push.apply(n,L(e)),r&&(this.lastPrediction=r)}},{key:"reset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.first=t,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}]),t}();function Fr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Ur=function(t){d(r,t);var e=Fr(r);function r(){var t,n;s(this,r);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return t=e.call.apply(e,[this].concat(o)),Object.defineProperty(p(t),"bounds",{get:function(){return n||(n=Be.ofPolygons(p(t)).ceil()),n},enumerable:!0}),t.resetBounds=function(){return n=null},t.shapesList=!1,t.holesClockwise=!1,t}return c(r,[{key:"clone",value:function(){return this.map((function(t){return t.slice()}))}},{key:"setTransform",value:function(t){this.matrix=t}},{key:"transform",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.matrix;this.forEach((function(e){for(var r=0;r<e.length;r+=2){var n=new Zt(e[r],e[r+1]);n.transformSelf(t),e[r]=n.x,e[r+1]=n.y}})),this.resetBounds()}},{key:"toArray",value:function(){return Array.from(this)}},{key:"toJSON",value:function(){return{type:"InkPath2D",contours:this.toArray(),shapesList:this.shapesList,holesClockwise:this.holesClockwise}}}],[{key:"fromJSON",value:function(t){if("InkPath2D"!=t.type)throw new Error("Invalid data found");var e=b(r,L(t.contours));return e.shapesList=t.shapesList,e.holesClockwise=t.holesClockwise,e}},{key:"fromArray",value:function(t){return b(r,L(t.slice(0)))}}]),r}(E(Array)),jr={stride:2,sort:function(t,e){return this.sortArrayPart(t,0,t.length-this.stride,e),t},partition:function(t,e,r,n){for(var i=t[r],o=t[r+1],a=e-this.stride,s=e;s<r;s+=2)n?n(i,o,t[s],t[s+1])&&(a+=this.stride,this.swap(t,a,s)):(i>t[s]||i==t[s]&&o>t[s+1])&&(a+=this.stride,this.swap(t,a,s));return this.swap(t,a+this.stride,r),a+this.stride},swap:function(t,e,r){var n=t[e],i=t[e+1];return t[e]=t[r],t[e+1]=t[r+1],t[r]=n,t[r+1]=i,t},sortArrayPart:function(t,e,r,n){if(e<r){var i=this.partition(t,e,r,n);this.sortArrayPart(t,e,i-this.stride,n),this.sortArrayPart(t,i+this.stride,r,n)}}},Gr={monotoneChain:function(t){var e=Gr.ARRAY_TYPE;if(e||(e=Array),t.length<=0)return new e;jr.sort(t);for(var r=new e(t.length),n=0,i=0;i<t.length;i+=2){for(;n>=4&&this.cross(r[n-4],r[n-3],r[n-2],r[n-1],t[i],t[i+1])<=0;)n-=2;r[n]=t[i],r[n+1]=t[i+1],n+=2}r=r.slice(0,n);var o,a=new e(t.length);n=0;for(var s=t.length-2;s>=0;s-=2){for(;n>=4&&this.cross(a[n-4],a[n-3],a[n-2],a[n-1],t[s],t[s+1])<=0;)n-=2;a[n]=t[s],a[n+1]=t[s+1],n+=2}return a=a.slice(0,n-2),e==Float32Array?((o=new Float32Array(a.length+r.length)).set(a),o.set(r,a.length)):o=a.concat(r),o},cross:function(t,e,r,n,i,o){return(r-t)*(o-e)-(n-e)*(i-t)}};function Yr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var zr=function(t){d(r,t);var e=Yr(r);function r(t,n){var i;return s(this,r),(i=e.call(this)).inputBuffer=[],i.hasPrediction=!0,Object.defineProperty(p(i),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(p(i),"pathPointCalculator",{get:function(){return n},set:function(t){n=t,this.reset()},enumerable:!0}),i}return c(r,[{key:"togglePrediction",value:function(t){this.hasPrediction=t}},{key:"addImpl",value:function(t,e){if(t.phase!=this.phase)throw new Error("The phase of the addition (".concat(t.phase.name,") doesn't match the phase of the PathProducer (").concat(this.phase.name,")"));var r=[],n=[];t&&this.inputBuffer.push(t);var i=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,o=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,a=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,s=this.calculate(i,o,a);return t&&s&&r.push.apply(r,L(s.toArray(this.layout))),this.phase==_.Phase.END?(s=this.calculate(o,a,null))&&r.push.apply(r,L(s.toArray(this.layout))):!this.hasPrediction||this.phase!=_.Phase.UPDATE&&null==e||(s=this.calculate(o,a,e))&&(n.push.apply(n,L(s.toArray(this.layout))),(s=this.calculate(a,e,null))&&n.push.apply(n,L(s.toArray(this.layout)))),{added:r,predicted:n}}},{key:"calculate",value:function(t,e,r){return e?this.pathPointCalculator(t,e,r):null}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.inputBuffer.clear()}}]),r}(_);function Xr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Vr=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933],Hr=function(t){d(r,t);var e=Xr(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15;return s(this,r),(n=e.call(this)).buffer=[],n.pointsCount=0,n.filter=Vr.slice(),Object.defineProperty(p(n),"dimsCount",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(p(n),"movingAverageWindowSize",{get:function(){return i},set:function(t){i=t,this.filter.length!=t&&(this.filter=r.resample(Vr,t)),this.predictionPointsCount=4*t/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),n.movingAverageWindowSize=i,n}return c(r,[{key:"addImpl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return{added:this.lastSegment?this.project(t):this.addSequence(t),predicted:this.project(e)}}},{key:"getImpl",value:function(t){return this.project(t)}},{key:"project",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));if(0==t.length)return[];var e=[],r=this.buffer.slice(),n=t.slice(0,t.length-this.dimsCount),i=this.addSequence(n);e.push.apply(e,L(i));for(var o=t.slice(t.length-this.dimsCount,t.length),a=this.predictionPointsCount,s=0;s<a;s++){var u=this.addPoint(o);a-s<=this.pointsCount&&e.push.apply(e,L(u))}return this.buffer=r,e}},{key:"addSequence",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));for(var e=[],r=t.length/this.dimsCount,n=0;n<r;n++){var i=this.addPoint(t.slice(n*this.dimsCount,(n+1)*this.dimsCount));e.push.apply(e,L(i))}return this.pointsCount+=r,e}},{key:"addPoint",value:function(t){var e;for((e=this.buffer).push.apply(e,L(t));this.buffer.length<this.windowSize*this.dimsCount;){var r;(r=this.buffer).unshift.apply(r,L(this.buffer.slice(0,this.dimsCount)))}for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}},{key:"filterBuffer",value:function(){for(var t=[],e=0;e<this.windowSize;e++)for(var r=0;r<this.dimsCount;r++)isNaN(t[r])&&(t[r]=0),t[r]+=this.buffer[e*this.dimsCount+r]*this.filter[e];return t}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.pointsCount=0,this.buffer.clear()}}],[{key:"resample",value:function(t,e){for(var r=new Float32Array(e),n=t.length/e,i=0,o=0;o<e;o++){var a=(t.length-1)*o/(e-1),s=Math.floor(a),u=Math.ceil(a),c=a-s,l=n*(t[s]*(1-c)+t[u]*c);i+=l,r[o]=l}for(var h=1/i,f=0;f<e;f++)r[f]*=h;return r}}]),r}(sr);function qr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Zr=function(t){d(r,t);var e=qr(r);function r(t){var n;return s(this,r),(n=e.call(this)).pathPointProps={},n.lastSpline=[],Object.defineProperty(p(n),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),n}return c(r,[{key:"addImpl",value:function(t,e){0==this.lastSpline.length&&t.length>0&&t.unshift.apply(t,L(t.slice(0,this.layout.length))),this.lastSegment&&(t.length>=this.layout.length?t.push.apply(t,L(t.slice(t.length-this.layout.length,t.length))):t.push.apply(t,L(this.getLastPart())));var r=this.getFirstPart();return this.lastSpline=r.concat(t),{added:t,predicted:this.getPredictedSpline(e)}}},{key:"getImpl",value:function(t){var e=[];return t.length>0&&(e.push.apply(e,L(t.slice(0,this.layout.length))),e.push.apply(e,L(t)),t.length>=this.layout.length&&e.push.apply(e,L(t.slice(t.length-this.layout.length,t.length)))),t}},{key:"getOutput",value:function(t,e){var r=e==sr.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:t;return 0==r.length?void 0:new ar(this.layout,r,this.pathPointProps,0,1)}},{key:"getFirstPart",value:function(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}},{key:"getLastPart",value:function(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}},{key:"getPredictedSpline",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];if(t.length>0){var r=this.getFirstPart();for(e.push.apply(e,L(r)),e.push.apply(e,L(t)),e.push.apply(e,L(e.slice(e.length-this.layout.length,e.length)));e.length<4*this.layout.length;)e.unshift(e.slice(0,this.layout.length))}return e}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.lastSpline.clear()}}]),r}(sr),Wr=function(){function t(e){s(this,t),this.key=e,this.height=1}return c(t,[{key:"leftRotate",value:function(){var e=this.right,r=e.left;return e.left=this,this.right=r,this.height=Math.max(t.height(this.left),t.height(this.right))+1,e.height=Math.max(t.height(e.left),t.height(e.right))+1,e}},{key:"rightRotate",value:function(){var e=this.left,r=e.right;return e.right=this,this.left=r,this.height=Math.max(t.height(this.left),t.height(this.right))+1,e.height=Math.max(t.height(e.left),t.height(e.right))+1,e}},{key:"getBalanceFactor",value:function(){return t.height(this.left)-t.height(this.right)}}],[{key:"height",value:function(t){return t?t.height:0}},{key:"minValue",value:function(t){if(t){for(var e=t;e.left;)e=e.left;return e.key}}},{key:"maxValue",value:function(t){if(t){for(var e=t;e.right;)e=e.right;return e.key}}}]),t}(),Kr=function(){function t(){s(this,t),this.count=0,this.hasKey=!1,this.root}return c(t,[{key:"min",value:function(){return Wr.minValue(this.root)}},{key:"max",value:function(){return Wr.maxValue(this.root)}},{key:"add",value:function(t){return this.hasKey=!1,this.root=this.insertNode(this.root,t),this.hasKey||this.count++,!this.hasKey}},{key:"insertNode",value:function(t,e){if(!t)return new Wr(e);if(e<t.key)t.left=this.insertNode(t.left,e);else{if(!(e>t.key))return this.hasKey=!0,t;t.right=this.insertNode(t.right,e)}if(!this.hasKey){t.height=1+Math.max(Wr.height(t.left),Wr.height(t.right));var r=t.getBalanceFactor();if(r>1){if(e<t.left.key)return t.rightRotate();if(e>t.left.key)return t.left=t.left.leftRotate(),t.rightRotate()}else if(r<-1){if(e>t.right.key)return t.leftRotate();if(e<t.right.key)return t.right=t.right.rightRotate(),t.leftRotate()}}return t}},{key:"contains",value:function(t){return this.containsNode(this.root,t)}},{key:"containsNode",value:function(t,e){return!!t&&(e<t.key?this.containsNode(t.left,e):!(e>t.key)||this.containsNode(t.right,e))}},{key:"printTree",value:function(){if(this.root)for(var t=[this.root],e=this.root.height;t.length>0;){var r=t.shift();e!=r.height&&console.log("-"),console.log("".concat(r.key," with height: ").concat(r.height,", balance: ").concat(r.getBalanceFactor())),e=r.height;var n=r.left,i=r.right;n&&t.push(n),i&&t.push(i)}}},{key:"toArray",value:function(){var e=[];return t.fillArray(e,this.root),e}}],[{key:"fillArray",value:function(t,e){e&&(this.fillArray(t,e.left),t.push(e.key),this.fillArray(t,e.right))}}]),t}(),Jr=function(){function t(){var e=this;s(this,t),this.tree=new Kr,Object.defineProperty(this,"length",{get:function(){return e.tree.count},enumerable:!0})}return c(t,[{key:"clear",value:function(){this.tree=new Kr}},{key:"add",value:function(t){return this.tree.add(t)}},{key:"includes",value:function(t){return this.tree.contains(t)}},{key:"min",value:function(){return this.tree.min()}},{key:"max",value:function(){return this.tree.max()}},{key:"toArray",value:function(){return this.tree.toArray()}}]),t}();function Qr(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var $r=function(t){d(r,t);var e=Qr(r);function r(t,n){var i;return s(this,r),(i=e.call(this,t,n)).state.segmentIndex=-1,i.state.lastSegmentIndex=-1,i.state.lastPointRotation=0,i.state.lastPointT=0,i.state.absAccumulatedErrorPos=0,i.state.absAccumulatedErrorS=0,i.setT=new Jr,Object.defineProperty(p(i),"errorThreshold",{get:function(){return this.error},set:function(t){this.error=t,this.errorDistSq=this.error*this.error,this.error10=10*this.error},enumerable:!0}),i.errorThreshold=.15,i}return c(r,[{key:"discretize",value:function(t){for(var e=[],r=t.segmentsCount,n=r-1,i=0;i<r;i++){this.calculatePolynomials(t.points,i);var o=this.calculateTParams(i==n,t.ts,t.tf);e.push.apply(e,L(this.samplePoints(o))),o.length>0&&(this.resetAccumulatedErrors(),this.storeLastPoint(e))}return e}},{key:"samplePoints",value:function(t){var e=this,r=[];return t.toArray().forEach((function(t){e.addT(t),r.push.apply(r,L(e.samplePoint(t)))})),r}},{key:"storeLastPoint",value:function(t){var e=t.length-this.layout.length;ce(v(r.prototype),"storeLastPoint",this).call(this,t,e),this.state.lastPointRotation=this.getPropValue(he.Property.ROTATION,t,e),this.state.lastPointT=this.setT.max(),this.state.lastSegmentIndex=this.state.segmentIndex}},{key:"calculateTParams",value:function(t,e,r){this.state.segmentIndex++;var n=0==this.state.segmentIndex?e:0,i=t?r:1;return this.setT.clear(),this.getTForPos(n,i),this.state.layout.SIZE&&this.getTForCubic(n,i,this.state.layout.SIZE.polynomials,this.error),this.mustAddStartT()&&this.setT.add(n),t&&this.setT.add(i),this.state.layout.ROTATION&&this.getTForRotation(n,i),this.setT}},{key:"mustAddStartT",value:function(){if(this.state.lastSegmentIndex<0)return!0;var t=this.state.lastPointT-(this.state.segmentIndex-this.state.lastSegmentIndex),e=this.setT.length>0?this.setT.min():1,r=this.getPosErrorAtT0(e,this.state.lastPointPosition);if(this.state.absAccumulatedErrorPos+=Math.abs(r),this.state.layout.SIZE){var n=this.getErrorAtT0(this.state.layout.SIZE.polynomials,e,t,this.state.lastPointSize);this.state.absAccumulatedErrorS+=Math.abs(n)}return this.state.absAccumulatedErrorPos>this.errorDistSq||this.state.absAccumulatedErrorS>this.error}},{key:"getPosErrorAtT0",value:function(t,e){var r=this.getTPoint(t),n=this.getTPoint(0);return this.minDistanceSq(e,r,n)}},{key:"getErrorAtT0",value:function(t,e,r,n){var i=r,o=n,a=e,s=this.cubicCalc(t,a),u=this.cubicCalc(t,0),c=o+(0-i)*(s-o)/(a-i);return Math.abs(u-c)}},{key:"getTForPos",value:function(t,e){var r=this.getTPoint(t),n=this.getTPoint(e),i=this.subdividePos(r,n);if(i.split)this.subdivideRecursivePos(r,i),this.setT.add(i.t),this.subdivideRecursivePos(i,n);else{var o=this.subdividePos(r,i),a=this.subdividePos(i,n);o.split&&(this.subdivideRecursivePos(r,o),this.setT.add(o.t),this.subdivideRecursivePos(o,i)),(o.split||a.split)&&this.setT.add(i.t),a.split&&(this.subdivideRecursivePos(i,a),this.setT.add(a.t),this.subdivideRecursivePos(a,n))}}},{key:"subdivideRecursivePos",value:function(t,e){var r=this.subdividePos(t,e);r.split&&(this.subdivideRecursivePos(t,r),this.setT.add(r.t),this.subdivideRecursivePos(r,e))}},{key:"subdividePos",value:function(t,e){var r=.5*(t.t+e.t),n=this.getTPoint(r),i=this.minDistanceSq(t,e,n),o=t.add(e).scaleSelf(.5),a=n.subtract(o).absSelf();return n.split=i>this.errorDistSq||a.x>this.error10||a.y>this.error10,this.state.layout.Z&&(n.split=n.split||a.z>this.error10),n}},{key:"getTForCubic",value:function(t,e,r,n){var i={v:this.cubicCalc(r,t),t:t},o={v:this.cubicCalc(r,e),t:e},a=this.subdivide(i,o,r);if(a.diff>n)this.subdivideRecursive(i,a,r,n),this.setT.add(a.t),this.subdivideRecursive(a,o,r,n);else{var s=this.subdivide(i,a,r),u=this.subdivide(a,o,r);s.diff>n&&(this.subdivideRecursive(i,s,r,n),this.setT.add(s.t),this.subdivideRecursive(s,a,r,n)),(s.diff>n||u.diff>n)&&this.setT.add(a.t),u.diff>n&&(this.subdivideRecursive(a,u,r,n),this.setT.add(u.t),this.subdivideRecursive(u,o,r,n))}}},{key:"subdivideRecursive",value:function(t,e,r,n){var i=this.subdivide(t,e,r);i.diff>n&&(this.subdivideRecursive(t,i,r,n),this.setT.add(i.t),this.subdivideRecursive(i,e,r,n))}},{key:"subdivide",value:function(t,e,r){var n=.5*(t.t+e.t),i=this.cubicCalc(r,n),o=.5*(t.v+e.v);return{v:i,t:n,diff:Math.abs(i-o)}}},{key:"getTForRotation",value:function(t,e){var r=this.state.layout.ROTATION.polynomials,n=this.state.lastPointRotation;this.state.lastSegmentIndex<0&&(n=this.cubicCalc(r,t));for(var i=.25*(e-t),o=0;o<4;o++){var a=t+o*i,s=this.cubicCalc(r,a);Math.abs(s-n)>.06&&(this.setT.add(a),n=s)}}},{key:"minDistanceSq",value:function(t,e,r){var n=r.vec,i=n.squaredDistance(t.value,e.value);if(0==i)return n.squaredDistance(r.value,t.value);var o=Math.max(0,Math.min(1,n.dot(r.subtract(t).value,e.subtract(t).value)/i)),a=e.subtract(t).scale(o).add(t);return n.squaredDistance(r.value,a.value)}},{key:"getTPoint",value:function(t){var e=new Zt(this.cubicCalc(this.state.layout.X.polynomials,t),this.cubicCalc(this.state.layout.Y.polynomials,t),this.state.layout.Z?this.cubicCalc(this.state.layout.Z.polynomials,t):void 0);return e.t=t,e}},{key:"cubicCalc",value:function(t,e){return t[0]+t[1]*e+t[2]*e*e+t[3]*e*e*e}},{key:"resetAccumulatedErrors",value:function(){this.state.absAccumulatedErrorPos=0,this.state.absAccumulatedErrorS=0}},{key:"resetState",value:function(){this.state.segmentIndex=-1,this.state.lastSegmentIndex=-1,this.state.lastPointT=0,this.state.lastPointRotation=0,this.resetAccumulatedErrors()}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.resetState()}}]),r}(Ar);function tn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var en=function(t){d(r,t);var e=tn(r);function r(t){var n;return s(this,r),n=e.call(this),Object.defineProperty(p(n),"brush",{get:function(){if(!t)throw new Error("brush not found");return t},set:function(e){t=e,this.reset()},enumerable:!0}),n}return c(r,[{key:"addImpl",value:function(t,e){return{added:this.generatePolygons(t),predicted:this.generatePolygons(e)}}},{key:"getImpl",value:function(t){return this.generatePolygons(t)}},{key:"getOutput",value:function(t,e){var r=b(Ur,L(t));return r.shapesList=this.brush.spacing>1,r}},{key:"generatePolygons",value:function(t){if(!t)return[];for(var e=[],r=0;r<t.length;r++){var n=t.getPoint(r),i=this.applyBrush(n);e.push(i)}return e}},{key:"applyBrush",value:function(t){for(var e=[],r=this.createTransform(t),n=this.brush.selectShape(r.maxScale),i=0;i<n.length;i+=2){var o=lt();Et(o,ht(n[i],n[i+1],0,1),r),e.push(o[0]/o[3],o[1]/o[3])}return e}},{key:"createTransform",value:function(t){if(isNaN(t.size))throw new Error("Size information not found.");var e=U(),r=t.size*t.scaleX,n=t.size*t.scaleY,i=t.size*t.scaleZ;return e.maxScale=Math.max(r,n,i),Y(e,e,H(t.x,t.y,t.z||0)),function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],u=e[3],c=e[4],l=e[5],h=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+c*n,t[1]=a*i+l*n,t[2]=s*i+h*n,t[3]=u*i+f*n,t[4]=c*i-o*n,t[5]=l*i-a*n,t[6]=h*i-s*n,t[7]=f*i-u*n}(e,e,t.rotation),Y(e,e,H(t.offsetX,t.offsetY,t.offsetZ)),function(t,e,r){var n=r[0],i=r[1],o=r[2];t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(e,e,H(r,n,i)),e}}]),r}(sr);function rn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var nn=function(t){d(r,t);var e=rn(r);function r(){var t;return s(this,r),(t=e.call(this)).lastPolygon=[],t}return c(r,[{key:"addImpl",value:function(t,e){return{added:this.getConvexHulls(t,!0),predicted:this.getConvexHulls(e)}}},{key:"getImpl",value:function(t){return this.getConvexHulls(t)}},{key:"getOutput",value:function(t,e){return b(Ur,L(t))}},{key:"getConvexHulls",value:function(t,e){var r=[],n=this.lastPolygon;return t.forEach((function(t){var e;(e=n).push.apply(e,L(t)),r.push(Gr.monotoneChain(n)),n=t})),e&&t.length>0&&(this.lastPolygon=t.last.slice()),r}},{key:"reset",value:function(){ce(v(r.prototype),"reset",this).call(this),this.lastPolygon.clear()}}]),r}(sr);function on(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var an=function(t){d(r,t);var e=on(r);function r(){var t;return s(this,r),(t=e.call(this)).processPrediction=!1,t.filterDuplicates=!1,t}return c(r,[{key:"addImpl",value:function(t,e){return{added:this.merge(t),predicted:this.processPrediction?this.merge(e):e}}},{key:"getImpl",value:function(t){return this.merge(t)}},{key:"getOutput",value:function(t,e){return b(Ur,L(t))}},{key:"merge",value:function(t){return t.length?Dr.union(t,this.filterDuplicates):[]}}]),r}(sr);function sn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var un=function(t){d(r,t);var e=sn(r);function r(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return s(this,r),(t=e.call(this)).epsilon=n,t}return c(r,[{key:"addImpl",value:function(t,e){return{added:this.simplify(t),predicted:e}}},{key:"getImpl",value:function(t){return this.simplify(t)}},{key:"getOutput",value:function(t,e){return b(Ur,L(t))}},{key:"simplify",value:function(t){var e=this;return t.map((function(t){return e.simplifyPolygonDouglasPeucker(t)}))}},{key:"simplifyPolygonDouglasPeucker",value:function(t){if(t.length<6)return t;t instanceof Float32Array&&(t=t.toArray());var e=this.simplifyPolylineDouglasPeucker(t.concat([t[0],t[1]]));return e.length<8?t:e.slice(0,e.length-2)}},{key:"simplifyPolylineDouglasPeucker",value:function(t){if(this.epsilon<=0)return[];if(t.length<4)return t;for(var e,n=0,i=0,o=2;o<t.length-2;o+=2){var a=r.perpendicularDistance(t[o],t[o+1],t[0],t[1],t[t.length-2],t[t.length-1]);a>n&&(i=o,n=a)}if(n>this.epsilon){var s=this.simplifyPolylineDouglasPeucker(t.slice(0,i+2)),u=this.simplifyPolylineDouglasPeucker(t.slice(i,t.length));e=s.concat(u.slice(2,u.length))}else e=[t[0],t[1],t[t.length-2],t[t.length-1]];return e}}],[{key:"perpendicularDistance",value:function(t,e,r,n,i,o){var a=t-r,s=i-r,u=a*(o-n)-s*(e-n);u*=u;var c=(a=i-r)*a+(s=o-n)*s;return c>0?Math.sqrt(u/c):Math.sqrt((r-t)*(r-t)+(n-e)*(n-e))}}]),r}(sr),cn=function(){function t(){var e=this;s(this,t),this.layout=[he.Property.X,he.Property.Y],this.pathSegment=new Br,this.pathProducer=new zr(this.layout,(function(t,e,r){return e.createPathPoint()})),this.smoother=new Hr(this.layout.length),this.splineProducer=new Zr(this.layout),this.distanceInterpolator=new Mr,this.curvatureInterpolator=new $r,this.brushApplier=new en,this.polygonMerger=new an,this.polygonSimplifier=new un,this.splineProducer.keepAllData=!0,this.phase=null,this.raster=!1,this.pathPointProps={},this.queue=Promise.resolve(),Object.defineProperty(this,"settings",{get:function(){return{brush:e.brush,layout:e.layout,pathPointProps:e.pathPointProps,pathPointCalculator:e.calculator,movingAverageWindowSize:e.smoother.movingAverageWindowSize,epsilon:e.polygonSimplifier.epsilon,mergePrediction:e.polygonMerger.processPrediction}},enumerable:!0})}return c(t,[{key:"configure",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.distanceInterpolator.keepAllData=!1,this.curvatureInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,t.brush&&(this.brush=t.brush,this.raster=!(this.brush instanceof Ke),this.raster||this.brush.spacing>1||t.basicMode?(this.splineInterpolator=this.distanceInterpolator,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.scattering=this.brush.scattering,this.splineInterpolator.calculateDerivates=this.raster):this.splineInterpolator=this.curvatureInterpolator,this.raster?this.splineInterpolator.keepAllData=!0:(this.brushApplier.brush=this.brush,this.brush.spacing>1?this.brushApplier.keepAllData=!0:this.polygonSimplifier.keepAllData=!0)),"basicMode"in t){if(t.basicMode&&this.raster)throw new Error("Basic mode is not supported for particles strokes");this.basicMode=t.basicMode}if(t.pathPointProps&&(this.pathPointProps=t.pathPointProps,this.splineProducer.pathPointProps=this.pathPointProps),t.pathPointCalculator&&(this.calculator=t.pathPointCalculator,this.pathProducer.pathPointCalculator=t.pathPointCalculator),t.layout){if(this.layout=t.layout,!this.raster){if(this.layout.includes(he.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(he.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(he.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(he.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(he.Property.RED)&&isNaN(this.pathPointProps.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(he.Property.GREEN)&&isNaN(this.pathPointProps.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(he.Property.BLUE)&&isNaN(this.pathPointProps.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(he.Property.ALPHA)&&isNaN(this.pathPointProps.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(he.Property.SIZE)&&isNaN(this.pathPointProps.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout}t.movingAverageWindowSize>0&&(this.smoother.movingAverageWindowSize=t.movingAverageWindowSize),t.errorThreshold>0&&(this.curvatureInterpolator.errorThreshold=t.errorThreshold),t.epsilon>0&&(this.polygonSimplifier.epsilon=t.epsilon),"mergePrediction"in t&&(this.polygonMerger.processPrediction=t.mergePrediction),t.onBuildComplete&&(this.onComplete=t.onBuildComplete),this.reset()}},{key:"add",value:function(t,e){if(!this.brush)throw new Error("InkBuilder instance is not configured properly, brush is not found");if(!this.layout)throw new Error("InkBuilder instance is not configured properly, layout is not found");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator is not found");if(!t.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=t.phase;var r,n=new _r(t);e&&(r=new _r(e)),this.device&&(this.phase==_.Phase.BEGIN&&this.device.openStream(t),this.device.add(n),this.phase==_.Phase.END&&(this.sensorData=this.device.closeStream()));var i=this.pathProducer.add(this.phase,n,r);this.pathSegment.add(this.phase,i.added,i.predicted)}},{key:"ignore",value:function(t){if(!t.phase)throw new Error("SensorPoint phase is not found");this.device&&t&&t.phase==_.Phase.UPDATE&&this.device.add(new _r(t),!0)}},{key:"build",value:function(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}},{key:"processSpline",value:function(t,e,r,n){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}},{key:"mergeAndSimplify",value:function(t,e,r){return r=this.polygonMerger.add(t,e,r.added,r.predicted),r=this.polygonSimplifier.add(t,e,r.added,r.predicted)}},{key:"getSensorData",value:function(){return this.sensorData}},{key:"getSpline",value:function(){return new ar(this.layout,this.splineProducer.allData.points,this.pathPointProps)}},{key:"getInkPath",value:function(t){var e;return this.raster?e=this.splineInterpolator.allData:this.basicMode||(this.brush.spacing>1?e=this.brushApplier.allData:(e=this.polygonSimplifier.allData,t&&(e=this.polygonMerger.merge(e),e=this.polygonSimplifier.simplify(e)))),e}},{key:"abort",value:function(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}},{key:"reset",value:function(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.distanceInterpolator.reset(),this.curvatureInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}},{key:"restart",value:function(){this.phase=void 0,this.pointerID=void 0}}]),t}();function ln(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}cn.Phase=_.Phase;var hn=function(t){d(r,t);var e=ln(r);function r(){var t;return s(this,r),(t=e.call(this)).convexHullChainProducer=new nn,t}return c(r,[{key:"build",value:function(){var t=this.buildSegment();return t.phase=this.phase,t.predicted&&(t.predicted.predicted=!0),this.onComplete&&this.onComplete(t),this.phase==_.Phase.END&&this.restart(),t}},{key:"buildSegment",value:function(){var t={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return t=this.smoother.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),t=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),t=this.processSegment(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),this.pathSegment.reset(),t}},{key:"processSegment",value:function(t,e,r,n){var i=this.splineInterpolator.add(t,e,r,n);return this.raster||this.basicMode||(i.added||i.predicted?(i=this.brushApplier.add(t,e,i.added,i.predicted),this.brush.spacing<=1&&(i=this.convexHullChainProducer.add(t,e,i.added,i.predicted),i=this.mergeAndSimplify(t,e,i))):i={added:i.added?i.added.points:new Ur,predicted:i.predicted?i.predicted.points:new Ur}),i}},{key:"processSpline",value:function(t,e){var r=this.splineInterpolator.get(t);return this.raster||(r?(r=this.brushApplier.get(r),this.brush.spacing<=1&&(this.polygonMerger.filterDuplicates=e,r=this.convexHullChainProducer.get(r),r=this.polygonMerger.get(r),r=this.polygonSimplifier.get(r))):r=new Ur),r}}]),r}(cn),fn=function(){function t(){s(this,t),this.state={},this.nextKey=0,this.workers=[],this.status=t.Status.CLOSED,this.lastPolygon}var e,r;return c(t,[{key:"open",value:(r=a(i.mark((function e(){var r,n,o,a,s,u=this;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.status==t.Status.CLOSED){e.next=2;break}throw new Error("Producer cannot be opened. Current status is ".concat(this.status.name,"."));case 2:for(r=new Blob(['\nlet QuickSort;\nlet ConvexHullProducer;\n\nlet worker = parseInt(self.name.replace(/^\\D+/g, ""));\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.imports) {\n\t\tmessage.imports.forEach(url => self.importScripts(url));\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\tself.postMessage({worker, ready: true});\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data);\n\tself.postMessage({worker, key: message.key, index: message.index, data: result}, [result.buffer]);\n}\n'],{type:"application/javascript"}),n=URL.createObjectURL(r),this.ready=0,this.imports=[{name:"QuickSort",value:jr},{name:"ConvexHullProducer",value:Gr}].map((function(t){return URL.createObjectURL(new Blob([Object.toSource(t.value,t.name)],{type:"application/javascript"}))})),o=navigator.hardwareConcurrency,a=function(t){var e=new Worker(n,{name:"ConvexHullChainWorker".concat(t)});e.name=t,e.onmessage=function(t){return u.recieve(t.data)},e.onerror=function(e){return u.recieveError(e,t)},u.workers.push(e)},s=0;s<o;s++)a(s);return URL.revokeObjectURL(n),this.status=t.Status.OPEN_IN_PROGRESS,e.abrupt("return",new Promise((function(t,e){u.workers.forEach((function(t){return t.postMessage({imports:u.imports})})),u.resolve=t})));case 12:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){this.workers.forEach((function(t){return t.terminate()})),this.workers.clear(),this.status=t.Status.CLOSED}},{key:"add",value:(e=a(i.mark((function e(r,n){var o,a,s,u=this,c=arguments;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=c.length>2&&void 0!==c[2]?c[2]:[],this.status==t.Status.OPEN){e.next=3;break}throw new Error("Producer is not opened yet. Current status is ".concat(this.status.name,"."));case 3:return a=this.nextKey++,s=this.lastPolygon,n.length>0&&(this.lastPolygon=n.last),r==_.Phase.END&&(this.lastPolygon=null),this.state[a]={addition:n,prediction:o,data:[].concat(L(n.slice()),L(o.slice())),queue:[].concat(L(n.slice()),L(o.slice())),lastPolygon:s,added:[],predicted:[],expected:n.length+o.length,processed:0},e.abrupt("return",new Promise((function(t,e){u.state[a].resolve=t,u.workers.forEach((function(t){return u.send(t.name,a)}))})));case 9:case"end":return e.stop()}}),e,this)}))),function(t,r){return e.apply(this,arguments)})},{key:"reset",value:function(){this.lastPolygon=null}},{key:"send",value:function(t,e){var r=this.state[e],n=r.queue.shift();if(n){var i=r.data.indexOf(n),o=(0==i?r.lastPolygon:r.data[i-1])||[];o.push.apply(o,L(n)),this.workers[t].postMessage({key:e,index:i,data:o})}}},{key:"recieve",value:function(e){if(e.ready)return this.ready++,void(this.ready==this.workers.length&&(this.imports.forEach((function(t){return URL.revokeObjectURL(t)})),this.resolve(),delete this.ready,delete this.resolve,this.status=t.Status.OPEN));var r,n,i=this.state[e.key];e.index>i.addition.length-1?(r=e.index-i.addition.length,n="predicted"):(r=e.index,n="added"),i[n][r]=e.data,i.processed++,i.processed==i.expected?(delete this.state[e.key],i.resolve({added:i.added,predicted:i.predicted})):this.send(e.worker,e.key)}},{key:"recieveError",value:function(t,e){console.warn("worker ".concat(e)),console.error(t)}}]),t}();fn.createEnum("Status",["OPEN","OPEN_IN_PROGRESS","CLOSED"]);var dn=function(){function t(){s(this,t),this.queue=Promise.resolve(),this.thenables=[]}var e;return c(t,[{key:"then",value:function(t,e,r){var n=this;return this.thenables.push(t),this.queue=this.queue.then((function(){return n.thenables.shift(),t.canceled?Promise.resolve():t.apply(void 0,arguments)})),e&&this.then((function(t){return e(t,r)})),this}},{key:"catch",value:function(t){return this.queue=this.queue.catch(t),this}},{key:"cancel",value:function(){this.thenables.forEach((function(t){return t.canceled=!0}))}},{key:"isEmpty",value:function(){return 0==this.thenables.length}}],[{key:"serial",value:(e=a(i.mark((function e(r,n){var o;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new t,r.forEach((function(t,e){return o.then(t,n,e)})),e.abrupt("return",o.queue);case 3:case"end":return e.stop()}}),e)}))),function(t,r){return e.apply(this,arguments)})}]),t}();function pn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var yn=[],vn=function(t){d(o,t);var e,r,n=pn(o);function o(){var t;return s(this,o),(t=n.call(this)).convexHullChainProducer=new fn,t.queue=Promise.resolve(),t.chainQueue=new dn,t}return c(o,[{key:"open",value:(r=a(i.mark((function t(){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.convexHullChainProducer.open();case 2:yn.push(this.convexHullChainProducer);case 3:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){yn.remove(this.convexHullChainProducer),this.convexHullChainProducer.close()}},{key:"add",value:function(t,e){if(!this.onComplete)throw new Error("InkBuilder instance is not configured properly, onBuildComplete is not found");this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),ce(v(o.prototype),"add",this).call(this,t,e)}},{key:"configure",value:function(t){var e=this;this.chainQueue.isEmpty()?ce(v(o.prototype),"configure",this).call(this,t):this.chainQueue.then((function(){return ce(v(o.prototype),"configure",e).call(e,t)}))}},{key:"build",value:function(){var t=this;if(this.phase){var e=this.phase;this.phase==_.Phase.END&&this.restart();var r=function(){return Promise.resolve().then((function(){return t.buildPhase=e,t.buildSegment()})).then((function(r){t.building=!1,t.aborted||(r.phase=e,r.predicted.predicted=!0,t.onComplete(r))}))};e==_.Phase.END?this.queue=this.queue.then(r):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=r())}}},{key:"buildChain",value:function(){var t=this;if(this.phase){var e=this.phase,r=this.getLastPathSegment();this.phase==_.Phase.END&&this.restart(),this.chainQueue.then((function(){return t.buildPhase=e,t.buildSegment(r)})).then((function(r){r.phase=e,r.predicted.predicted=!0,t.onComplete(r)}))}return this.chainQueue}},{key:"getLastPathSegment",value:function(){var t=this.pathSegment;return this.pathSegment=new Br,t}},{key:"buildSegment",value:function(t){t||(t=this.pathSegment);var e={added:t.accumulatedAddition,predicted:t.lastPrediction};e=this.smoother.add(t.first,t.last,e.added,e.predicted),e=this.splineProducer.add(t.first,t.last,e.added,e.predicted);var r=t.first,n=t.last;return t.reset(),this.processSegment(r,n,e.added,e.predicted)}},{key:"processSegment",value:function(t,e,r,n){var i=this,o=this.splineInterpolator.add(t,e,r,n);return this.raster?Promise.resolve(o):o.added||o.predicted?(o=this.brushApplier.add(t,e,o.added,o.predicted),this.brush.spacing<=1?this.convexHullChainProducer.add(this.phase,o.added,o.predicted).then((function(r){return i.mergeAndSimplify(t,e,r)})):Promise.resolve(o)):Promise.resolve({added:o.added?o.added.points:new Ur,predicted:o.predicted?o.predicted.points:new Ur})}},{key:"processSpline",value:(e=a(i.mark((function t(e,r){var n,o;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.splineInterpolator.get(e),this.raster){t.next=15;break}if(!n){t.next=14;break}if(n=this.brushApplier.get(n),!(this.brush.spacing<=1)){t.next=12;break}return this.polygonMerger.filterDuplicates=r,t.next=8,this.convexHullChainProducer.add(_.Phase.END,n);case 8:o=t.sent,n=o.added,n=this.polygonMerger.get(n),n=this.polygonSimplifier.get(n);case 12:t.next=15;break;case 14:n=new Ur;case 15:return t.abrupt("return",n);case 16:case"end":return t.stop()}}),t,this)}))),function(t,r){return e.apply(this,arguments)})},{key:"abort",value:function(){ce(v(o.prototype),"abort",this).call(this),this.buildPhase=null,this.chainQueue.cancel()}}],[{key:"closeAll",value:function(){yn.forEach((function(t){return t.close()})),yn.clear()}}]),o}(cn);function gn(){}gn.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};var mn=gn.BlendMode;function bn(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return En(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return En(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function En(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var xn=function(){function t(e,r){s(this,t),Object.defineProperty(this,"ctx",{value:e,enumerable:!0}),Object.defineProperty(this,"value",{value:r,enumerable:!0}),Object.defineProperty(this,"texture",{value:r,enumerable:!0})}var e;return c(t,[{key:"update",value:(e=a(i.mark((function t(e,r){var n,o,a,s,u,c,l;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(e)){t.next=26;break}n=[],o=bn(e),t.prev=4,o.s();case 6:if((a=o.n()).done){t.next=14;break}return s=a.value,t.next=10,Ve(s);case 10:u=t.sent,n.push(u);case 12:t.next=6;break;case 14:t.next=19;break;case 16:t.prev=16,t.t0=t.catch(4),o.e(t.t0);case 19:return t.prev=19,o.f(),t.finish(19);case 22:this.completeMipMap(n),this.fill(n,r),t.next=31;break;case 26:return c=e,t.next=29,Ve(c);case 29:l=t.sent,this.fill(l);case 31:case"end":return t.stop()}}),t,this,[[4,16,19,22]])}))),function(t,r){return e.apply(this,arguments)})},{key:"completeMipMap",value:function(t){if(t.sort((function(t,e){return e.width-t.width})),1!=t.last.width)for(var e=t.last.width;e>1;){e/=2;var r=new OffscreenCanvas(t.last.width/2,t.last.height/2);r.getContext("2d").drawImage(t.last,0,0,r.width,r.height),t.push(r)}}},{key:"fill",value:function(t,e){var r=this,n=this.ctx,i=this.value;if(n.bindTexture(n.TEXTURE_2D,i),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(t)){var o=t;this.size=[],o.forEach((function(t,e){n.texImage2D(n.TEXTURE_2D,e,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),r.size.push({width:t.width,height:t.height}),t.close&&t.close()})),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,e?n.LINEAR_MIPMAP_LINEAR:n.LINEAR_MIPMAP_NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)}else n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),this.size={width:t.width,height:t.height},t.close&&t.close();n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.bindTexture(n.TEXTURE_2D,null),this.logError(this.ctx,i.name)}},{key:"readPixels",value:function(){var t=this.ctx,e=this.value,r=function(r,n){var i=new Uint8Array(r.width*r.height*4);return t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,n),t.readPixels(0,0,r.width,r.height,t.RGBA,t.UNSIGNED_BYTE,i),i},n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n);var i=Array.isArray(this.size)?this.size.map(r):r(this.size,0);return t.deleteFramebuffer(n),i}},{key:"logError",value:function(){var t=this.ctx.getError();t>0&&console.error("WebGL error - ".concat(this.texture.name,": ").concat(t))}}],[{key:"createInstance",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.CLAMP_TO_EDGE,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.NEAREST,i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.bindTexture(e.TEXTURE_2D,null),new t(e,i)}},{key:"logGLError",value:function(t,e){var r=t.getError();r>0&&console.error("WebGL error - ".concat(e,": ").concat(r))}}]),t}();function Pn(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return wn(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return wn(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function wn(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var kn,Rn,Sn=function(){function t(e,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};s(this,t),this.name=e,this.spacing=o.spacing||.15,this.scattering=o.scattering||0,this.blendMode=o.blendMode||mn.SOURCE_OVER,this.rotationMode=o.rotationMode||t.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:function(){return{spacing:i.spacing,scattering:i.scattering,blendMode:i.blendMode,rotationMode:i.rotationMode}},enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:function(){return{randomize:i.randomizeFill,size:i.fillTextureSize,offset:i.fillTextureOffset}},enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return Array.isArray(i.descriptor.shape)?i.descriptor.shape.map((function(t){return t.value})):i.descriptor.shape.value},enumerable:!0}),Object.defineProperty(this,"fill",{get:function(){return i.descriptor.fill.value},enumerable:!0}),this.updateShape(r),this.updateFill(n,a)}var e,r,n,o,u,l,h;return c(t,[{key:"updateShape",value:(h=a(i.mark((function t(e){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Array.isArray(e)?e=e.map((function(t){return"string"==typeof t?je.getInstance(t):t instanceof je?t:new je(t.name,t.value)})):"string"==typeof e?e=je.getInstance(e):e instanceof je||(e=new je(e.name,e.value)),this.descriptor.shape=e,!this.ctx){t.next=5;break}return t.next=5,this.configureShape();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return h.apply(this,arguments)})},{key:"updateFill",value:(l=a(i.mark((function t(e){var r,n=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:{},this.randomizeFill=!("randomize"in r)||r.randomize,this.fillTextureSize=r.size,this.fillTextureOffset=r.offset||{x:0,y:0},!Array.isArray(e)){t.next=6;break}throw new Error("Mipmap is not compatible whith fill texture");case 6:if("string"==typeof e?e=je.getInstance(e):e instanceof je||(e=new je(e.name,e.value)),this.descriptor.fill=e,!this.ctx){t.next=11;break}return t.next=11,this.configureFill();case 11:case"end":return t.stop()}}),t,this)}))),function(t){return l.apply(this,arguments)})},{key:"configure",value:(u=a(i.mark((function t(e){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.ctx=e,t.next=3,this.configureShape();case 3:return t.next=5,this.configureFill();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return u.apply(this,arguments)})},{key:"configureShape",value:(o=a(i.mark((function t(){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.shapeTexture||(this.shapeTexture=xn.createInstance(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),t.next=3,this.shapeTexture.update(this.shape,this.spacing<=1);case 3:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})},{key:"configureFill",value:(n=a(i.mark((function t(){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.fillTexture||(this.fillTexture=xn.createInstance(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),t.next=3,this.fillTexture.update(this.fill);case 3:this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size);case 4:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"getShapeBinary",value:(r=a(i.mark((function t(){var e,r,n,o,a,s;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(this.shape)){t.next=24;break}r=[],n=Pn(this.shape),t.prev=3,n.s();case 5:if((o=n.n()).done){t.next=13;break}return a=o.value,t.next=9,Ye(a);case 9:s=t.sent,r.push(s);case 11:t.next=5;break;case 13:t.next=18;break;case 15:t.prev=15,t.t0=t.catch(3),n.e(t.t0);case 18:return t.prev=18,n.f(),t.finish(18);case 21:e=r,t.next=27;break;case 24:return t.next=26,Ye(this.shape);case 26:e=t.sent;case 27:return t.abrupt("return",e);case 28:case"end":return t.stop()}}),t,this,[[3,15,18,21]])}))),function(){return r.apply(this,arguments)})},{key:"getFillBinary",value:(e=a(i.mark((function t(){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Ye(this.fill);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"toJSON",value:function(){return{type:this.constructor.name,name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map((function(t){return t.toJSON()})):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}},{key:"equals",value:function(t){return t==this&&t.shapeTexture==this.shapeTexture&&t.fillTexture==this.fillTexture}},{key:"delete",value:function(){this.deleteShape(),this.deleteFill()}},{key:"deleteShape",value:function(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}},{key:"deleteFill",value:function(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}],[{key:"fromJSON",value:function(e){e.particleSettings.blendMode=mn[e.particleSettings.blendMode],e.particleSettings.rotationMode=t.RotationMode[e.particleSettings.rotationMode];var r=Array.isArray(e.shape)?e.shape.map((function(t){return je.fromJSON(t)})):je.fromJSON(e.shape),n=je.fromJSON(e.fill);return new t(e.name,r,n,e.particleSettings,e.fillTextureSettings)}}]),t}();function In(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}Sn.createEnum("RotationMode",["NONE","RANDOM","TRAJECTORY"]);var Tn=function(t){d(n,t);var e,r=In(n);function n(t,e,i,o){var a,u;return s(this,n),a=r.call(this,e.id),Object.defineProperty(p(a),"layout",{value:e.layout,enumerable:!0}),Object.defineProperty(p(a),"points",{get:function(){return e.points},enumerable:!0}),Object.defineProperty(p(a),"pointProps",{value:e.pointProps,enumerable:!0}),Object.defineProperty(p(a),"ts",{value:e.ts,enumerable:!0}),Object.defineProperty(p(a),"tf",{value:e.tf,enumerable:!0}),Object.defineProperty(p(a),"stride",{value:e.stride,enumerable:!0}),Object.defineProperty(p(a),"length",{value:e.length,enumerable:!0}),Object.defineProperty(p(a),"segmentsCount",{value:e.segmentsCount,enumerable:!0}),e.randomSeed&&Object.defineProperty(p(a),"randomSeed",{value:e.randomSeed,enumerable:!0}),Object.defineProperty(p(a),"color",{get:function(){return e.color},set:function(t){e.color=t,i&&(i.color=t)},enumerable:!0}),Object.defineProperty(p(a),"sensorData",{value:o,enumerable:!0}),Object.defineProperty(p(a),"spline",{value:e,enumerable:!0}),Object.defineProperty(p(a),"hasPath",{get:function(){return!!i},enumerable:!0}),Object.defineProperty(p(a),"path",{get:function(){return i||this.buildPath(),i},set:function(t){i=t},enumerable:!0}),Object.defineProperty(p(a),"bounds",{get:function(){return u||(u=this.path.bounds),this.matrix?u.transform(this.matrix).ceil():u},enumerable:!0}),a.reset=function(t,r){t&&(e=t),i=r,a.resetBounds()},a.resetBounds=function(){return u=null},Object.defineProperty(p(a),"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(p(a),"brush",{get:function(){return t||(t=this.descriptor.brush.value),t},set:function(r){if(this.reset(),"string"==typeof r?r=new je(r):r instanceof Ke||r instanceof Sn?r=new je(r.name,r):r instanceof je||(r=new je(r.name,r.value)),r instanceof Sn&&!e.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");t=null,this.descriptor.brush=r},enumerable:!0}),a.brush=t,a.renderMode=void 0,a.sensorDataOffset=0,a.sensorDataMapping=[],a}return c(n,[{key:"clone",value:function(){var t=new n(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return t.renderMode=this.renderMode,t.sensorDataOffset=this.sensorDataOffset,t.sensorDataMapping=this.sensorDataMapping.clone(),t}},{key:"init",value:(e=a(i.mark((function t(e){return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.pathProceessInProgress=!0,Rn){t.next=5;break}return Rn=new vn,t.next=5,Rn.open();case 5:return Rn.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&Rn.configure(e),t.next=9,Rn.processSpline(this.spline,this.target==n.Target.GL);case 9:this.path=t.sent,delete this.pathProceessInProgress;case 11:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})},{key:"buildPath",value:function(t){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");kn||(kn=new hn),kn.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),t&&kn.configure(t),this.path=kn.processSpline(this.spline,this.target==n.Target.GL)}},{key:"getSegment",value:function(t){var e=t,r=t+3,n=0==e?this.ts:0,i=r+1==this.length?this.tf:1;return this.spline.slice(e,r,n,i)}},{key:"getSensorPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e;if(this.sensorData){var r,n=this.sensorData.inkStream;if(n)this.sensorDataMapping.length>0?r=t>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[t]:(r=this.sensorDataOffset+t)>=n.length&&(r=n.length-1),(e=n.get(r)).index=r,e.timespan=e.timestamp,e.timestamp+=this.sensorData.created}return e}},{key:"getPoint",value:function(t){return this.spline.getPoint(t)}},{key:"setPoint",value:function(t,e){var r=this,n=t*this.stride;this.layout.forEach((function(t,i){return r.points[n+i]=e.getProperty(t)}))}},{key:"pointAt",value:function(t){return this.getPoint(t)}},{key:"getAverageWidth",value:function(){var t=0;if(this.layout.includes(he.Property.SIZE)){for(var e=0,r=0;r<this.length;r++)e+=this.getPoint(r).size;t=e/this.length}else t=this.pointProps.size;return t}},{key:"split",value:function(t){var e=this,r=t.map((function(t){return e.subStroke(t)}));return r.includes(this)||0==r.length?void 0:r}},{key:"subStroke",value:function(t){var e=t.fromIndex,r=t.toIndex,i=t.fromTValue,o=t.toTValue;if(0==e&&r+1==this.length&&i==this.ts&&o==this.tf)return this;var a=this.spline.slice(e,r,i,o),s=new n(this.descriptor.brush,a,void 0,this.sensorData);return s.renderMode=this.renderMode,this.sensorData&&(s.sensorDataOffset=this.sensorDataOffset+e,this.sensorDataMapping.length>0?s.sensorDataMapping=this.sensorDataMapping.slice(e,r+1):s.sensorDataMapping=[]),s}},{key:"transform",value:function(t){t||(t=this.matrix,this.matrix=null),t&&(this.spline.transform(t),this.hasPath&&this.path.transform(t),this.resetBounds())}},{key:"setTransform",value:function(t){this.matrix=t}}],[{key:"createInstance",value:function(t,e,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=i.color;u&&(delete i.color,(i=Object.assign({},i)).red=u.red,i.green=u.green,i.blue=u.blue,i.alpha=u.alpha);var c=new ar(r,e,i,a,s);return c.randomSeed=o,new n(t,c)}},{key:"validatePath",value:function(t){if(!t)return!1;if(0==t.length)return!1;if(t instanceof Ur)return!0;if(Array.isArray(t))throw new Error("path should be instance of InkPath2D");var e=!1,r=0,n=!1,i=t.pointProps,o=i.size,a=i.red,s=i.green,u=i.blue,c=i.alpha;if(!(t instanceof cr)){var l=t.points.length,h=t.layout.length;n=0==l||l<4*h,r=l%h}return 0!=r?console.error("The points array (length: ".concat(t.points.length,") does not refer to provided layout (").concat(t.layout.map((function(t){return t.name})).join(", "),")")):n?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!t.layout.includes(he.Property.SIZE)&&isNaN(o)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!t.layout.includes(he.Property.RED)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a RED property"):!t.layout.includes(he.Property.GREEN)&&isNaN(s)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!t.layout.includes(he.Property.BLUE)&&isNaN(u)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!t.layout.includes(he.Property.ALPHA)&&isNaN(c)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):e=!0,e}},{key:"decodeInkPath",value:function(t){if("InkPath2D"==t.type)return Ur.fromJSON(t);if("InterpolatedSpline"==t.type)return cr.fromJSON(t);throw new Error("Decode ink path faild. Cannot identify type: ".concat(t.type))}}]),n}(I);if(Tn.RenderMode=Object.assign.apply(Object,[{}].concat(L(Object.keys(mn).map((function(t){return h({},t,"will://rasterization/3.0/blend-mode/".concat(be.getPropName(t,!0)))}))))),Tn.RenderMode.get=function(t){return Tn.RenderMode[be.getEnumValueName(t.replace(/-/g,"_"))]},Tn.RenderMode.getBlendMode=function(t){return mn[Object.keys(Tn.RenderMode).filter((function(e){return Tn.RenderMode[e]==t})).first]},Tn.createEnum("Target",["2D","GL"]),x.type2D==x.Type2D.OFFSCREEN){var An=require("canvas"),Cn=An.Canvas,On=An.ImageData,Mn=An.Image;global.OffscreenCanvas=Cn,global.ImageData=On,global.Image=Mn}var Dn=function(){function t(e,r){s(this,t);var n={};"undefined"==typeof screen?(n.width=e,n.height=r):(n.width=Math.max(screen.width,screen.height),n.height=n.width),Object.defineProperty(this,"defaultSize",{value:n,enumerable:!0})}var e,r;return c(t,[{key:"setTransform",value:function(t){this.transform=t}},{key:"getExportCanvas",value:function(t){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}},{key:"toBlob",value:(r=a(i.mark((function t(e){var r,n,o,a=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=a.length>1&&void 0!==a[1]?a[1]:"image/png",n=a.length>2&&void 0!==a[2]?a[2]:.92,"undefined"!=typeof Blob){t.next=8;break}if("undefined"!=typeof Buffer){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");case 8:if(!(o=this.getExportCanvas(e)).toBlob){t.next=13;break}return t.abrupt("return",new Promise((function(t,e){return o.toBlob(t,r,n)})));case 13:return t.abrupt("return",o.convertToBlob({type:r,quality:n}));case 14:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"toBuffer",value:(e=a(i.mark((function t(e){var r,n,o,a,s,u=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:"image/png",n=u.length>2&&void 0!==u[2]?u[2]:{},"undefined"!=typeof Buffer){t.next=8;break}if("undefined"!=typeof Blob){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");case 8:return o=this.getExportCanvas(e),n.filters&&(a=Array.isArray(n.filters)?n.filters.slice():[n.filters],s=0,a.forEach((function(t){s|=o["PNG_FILTER_".concat(t.name)]})),Object.assign({},n,{filters:s})),t.abrupt("return",new Promise((function(t,e){return o.toBuffer((function(r,n){return r?e(r):t(n)}),r,n)})));case 11:case"end":return t.stop()}}),t,this)}))),function(t){return e.apply(this,arguments)})}]),t}();function Nn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}Dn.createEnum("PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);var Ln=function(t){d(r,t);var e=Nn(r);function r(t){var n;return s(this,r),n=e.call(this,t.canvas.width,t.canvas.height),Object.defineProperty(p(n),"surface",{value:t.canvas}),Object.defineProperty(p(n),"ctx",{value:t}),Object.defineProperty(p(n),"bounds",{get:function(){return new Be(0,0,n.width,n.height)},enumerable:!0}),n.ctx.getContextAttributes||(n.ctx.getContextAttributes=function(){return{}}),n}return c(r,[{key:"width",get:function(){return this.surface.width}},{key:"height",get:function(){return this.surface.height}}]),c(r,[{key:"clear",value:function(t,e){if(e){if(Ne.isColor(t))throw new Error("`clear` first argument should be Rectangle")}else Ne.isColor(t)&&(e=t,t=null);t||(t=this.bounds),this.ctx.clearRect(t.left,t.top,t.width,t.height),e&&(this.ctx.fillStyle=e.toString(),this.ctx.fillRect(t.left,t.top,t.width,t.height))}},{key:"draw",value:function(t){return this.drawStroke(t.brush,t.path,t.color,t.matrix)}},{key:"drawStroke",value:function(t,e,r,n){if(!Tn.validatePath(e))return null;if(e instanceof cr)return this.drawSpline(e,r);if(!(t instanceof Ke))throw new Error("Incompatible brush found. It should be Brush2D instance.");n?this.transform&&(n=this.transform.multiply(n)):n=this.transform;var i=e.bounds;return i&&(n&&(i=i.transform(n)),i=i.ceil()),(i=this.bounds.intersect(i))&&(this.ctx.save(),n?this.ctx.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty):(this.ctx.rect(i.left,i.top,i.width,i.height),this.ctx.clip()),e.holesClockwise=!0,this.drawPath(e,r.toRGB().toString()),t.pattern&&this.drawPath(e,t.pattern),this.ctx.restore()),i}},{key:"drawPath",value:function(t,e){var r=this;this.ctx.beginPath(),t.forEach((function(e,n){if(r.ctx.moveTo(e[0],e[1]),t.holesClockwise||0==n)for(var i=2;i<e.length;i+=2)r.ctx.lineTo(e[i],e[i+1]);else for(var o=e.length-2;o>=0;o-=2)r.ctx.lineTo(e[o],e[o+1]);r.ctx.closePath()})),e&&(this.ctx.fillStyle=e),this.ctx.fill()}},{key:"drawSpline",value:function(t,e){var r;e||(e=t.color),this.ctx.save(),this.ctx.fillStyle="rgb(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,")");for(var n=0;n<t.length;n++){var i=t.getPoint(n),o=i.size/2;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),r=Be.union(new Be(i.x-o,i.y-o,i.size,i.size),r)}return this.ctx.restore(),r.ceil()}},{key:"fill",value:function(t,e){var r;if(Be.isRect(t))r=t;else{if("number"==typeof t[0])t=new Ur(t);else if(!(t instanceof Ur))throw new Error("fill shape type missmatch, expected InkPath2D");r=t.bounds}return(r=this.bounds.intersect(r))&&(r=r.ceil(),this.ctx.fillStyle=e.toString(),Be.isRect(t)?this.ctx.fillRect(t.left,t.top,t.width,t.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.drawPath(t),this.ctx.restore())),r}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=mn.SOURCE_OVER),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");e.rect&&(e.sourceRect=e.rect,e.destinationRect=e.rect),this.ctx.save(),e.transform?this.ctx.setTransform(e.transform.a,e.transform.b,e.transform.c,e.transform.d,e.transform.tx,e.transform.ty):e.clipRect&&(this.ctx.rect(e.clipRect.left,e.clipRect.top,e.clipRect.width,e.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=e.mode,e.sourceRect&&e.destinationRect?this.ctx.drawImage(t.ctx.canvas,e.sourceRect.left,e.sourceRect.top,e.sourceRect.width,e.sourceRect.height,e.destinationRect.left,e.destinationRect.top,e.destinationRect.width,e.destinationRect.height):this.ctx.drawImage(t.ctx.canvas,0,0),this.ctx.restore()}},{key:"createImageData",value:function(t,e,r){return new ImageData(t,e,r)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.ctx.getImageData(t.x,t.y,t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.ctx.putImageData(t,e,r)}},{key:"readPixels",value:function(t){return this.getImageData(t).data}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e||(e=this.bounds),this.putImageData(this.createImageData(t,e.width,e.height),e.x,e.y)}},{key:"getExportCanvas",value:function(t){var e=this.surface;return t&&(t=t.intersect(this.bounds).ceil(),(e=new OffscreenCanvas(t.width,t.height)).getContext("2d").putImageData(this.getImageData(t),0,0)),e}},{key:"resize",value:function(t,e){this.surface.width=t,this.surface.height=e}}]),r}(Dn);function _n(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Bn=function(t){d(r,t);var e=_n(r);function r(t){return s(this,r),e.call(this,t)}return c(r,[{key:"createLayer",value:function(t,e){if(!t||!e){var r=this.defaultSize;t=r.width,e=r.height}var n=new OffscreenCanvas(t,e);return new Ln(n.getContext("2d",this.ctx.getContextAttributes()))}}],[{key:"createInstance",value:function(t,e,n,i){if(!t||"function"!=typeof t.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(e>0&&n>0&&(t.width=e,t.height=n),!(t.width>0&&t.width>0))throw new Error("width and height are required and should be positive whole numbers");return new r(t.getContext("2d",i))}}]),r}(Ln),Fn=function(){function t(e,r){var n=this;s(this,t),this.canvas=e,this.layer=r||e.createLayer(),this.preliminaryLayer=void 0,this.ownLayer=!r,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=Ne.TRANSPERENT,this.blendMode=mn.SOURCE_OVER,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,color:n.color,backgroundColor:n.backgroundColor,blendMode:n.blendMode,transform:n.transform}},enumerable:!0})}return c(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),"transform"in t&&this.setTransform(t.transform),this.restart=!0}},{key:"setTransform",value:function(t){this.transform=t,this.layer.setTransform(t),this.preliminaryLayer&&this.preliminaryLayer.setTransform(t)}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t instanceof Tn){var r=t,n=mn.SOURCE_OVER;if(!(r.brush instanceof Ke))throw new Error("Incompatible brush found. It should be Brush2D instance.");if(r.renderMode&&!(n=Tn.RenderMode.getBlendMode(r.renderMode)))return void console.warn("Cannot process ".concat(r.renderMode," render mode. Requres custom processing."));this.color=r.color,this.blendMode=n,this.reset(),r.target=Tn.Target["2D"];var i=this.layer.draw(r);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(t)){var o=this.layer.drawStroke(this.brush,t,this.color,t.matrix);o&&(this.incompleteStrokeBounds=o.union(this.incompleteStrokeBounds),this.strokeBounds=o.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.setTransform(this.transform)),e=this.preliminaryLayer):e=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:mn.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=e.drawStroke(this.brush,t,this.color,t.matrix),this.updatedArea=Be.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer||(this.alphaLayer=this.canvas.createLayer())),this.restart=!1}},{key:"validate",value:function(t){return t&&t.length>0}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=t||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,n=e.bounds.intersect(this.updatedArea);if(n){var i=this.color.alpha;i<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(e,{rect:n}),this.alphaLayer.ctx.globalAlpha=i,this.alphaLayer.blend(r,{mode:this.blendMode,rect:n}),e.clear(n),e.blend(this.alphaLayer,{rect:n})):e.blend(r,{mode:this.blendMode,rect:n})}this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=t||this.canvas;if(e=i.bounds.intersect(e||this.strokeBounds)){var o=this.color.alpha;o<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=o,this.alphaLayer.blend(n,{rect:e}),i.blend(this.alphaLayer,{mode:r,rect:e})):i.blend(n,{mode:r,rect:e})}}}},{key:"toStroke",value:function(t,e){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");var r=t.getSensorData(),n=t.getSpline(),i=t.getInkPath(e),o=new Tn(this.brush,n,i,r);return r&&(o.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=mn.SOURCE_OVER&&(o.renderMode=Tn.RenderMode.get(this.blendMode)),o}},{key:"delete",value:function(){console.warn("Not applicable with 2D API")}}]),t}(),Un=void 0;x.typeGL==x.TypeGL.STACK&&(Un=require("gl"));var jn=Un,Gn=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:150;s(this,t),this.width=e,this.height=r}return c(t,[{key:"getContext",value:function(){var t=arguments.length>1?arguments[1]:void 0;if(!this.context){var e=this.width,r=this.height;this.context=jn(e,r,t),this.context.canvas=this;var n=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:function(){return e},set:function(t){e=t,n.resize(e,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:function(){return e},set:function(t){r=t,n.resize(e,r)},enumerable:!0})}return this.context}},{key:"destroy",value:function(){this.context&&(this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context)}}]),t}(),Yn=jn?Gn:void 0;function zn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Xn=function(t){d(r,t);var e=zn(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(s(this,r),(n=e.call(this,t.gl.canvas.width,t.gl.canvas.height)).inkGLContext=t,n.gl=t.gl,n.scaleFactor=i.scaleFactor||1,n.flipY=!!i.flipY,n.useTextureStorage=!1,i.renderbuffer){if(!i.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");var o=n.initWithGLBuffers(i.framebuffer,i.renderbuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(o.width,o.height)}else if(i.framebuffer){var a=n.initWithGLFramebuffer(i.framebuffer);n.flipY=!0,n.ownGLResources=!!i.ownGLResources,n.setDimensions(a.width,a.height)}else if(i.texture){if(!(i.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");var u;if(n.texture=i.texture,n.useTextureStorage=!0,i.width>0&&i.height>0)u={width:i.width,height:i.height};else if(n.texture.image)u={width:n.texture.image.width,height:n.texture.image.height};else{if(!n.texture.size)throw new Error("`width` and `height` are required when `texture` is available");u=n.texture.size}n.ownGLResources=!!i.ownGLResources,n.setDimensions(u.width,u.height)}else{var c=Math.min(i.width||n.defaultSize.width,4e3),l=Math.min(i.height||n.defaultSize.height,4e3);if(n.setDimensions(c,l),i.display)n.framebuffer=null,n.renderbuffer=null,n.texture=null;else if(n.useTextureStorage=!i.useBuffersStorage,n.ownGLResources=!0,n.useTextureStorage){var h=n.inkGLContext.generateBuffersExt(n.storageWidth,n.storageHeight,n.gl.LINEAR,n.gl.UNSIGNED_BYTE);n.framebuffer=h.framebuffer,n.texture=h.texture}else{var f=n.inkGLContext.genFrameAndRenders(n.gl.RGBA8||n.gl.RGBA4,n.storageWidth,n.storageHeight);n.framebuffer=f.framebuffer,n.renderbuffer=f.renderbuffer}}return n.releaseRenderbuffer=!1,n.deleted=!1,n}return c(r,[{key:"initWithGLFramebuffer",value:function(t){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");var e,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return e=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(t,e)}},{key:"initWithGLBuffers",value:function(t,e){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(e instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");var r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,e);var n=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=t,this.renderbuffer=e,{width:n,height:i}}},{key:"setDimensions",value:function(t,e){var r=Math.ceil(t*this.scaleFactor),n=Math.ceil(e*this.scaleFactor),i=new Le(0,0,t,e),o=new Le(0,0,r,n);Object.defineProperties(this,{width:{value:t,enumerable:!0,configurable:!0},height:{value:e,enumerable:!0,configurable:!0},graphicsBounds:{value:i,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:n,enumerable:!0,configurable:!0},storageBounds:{value:o,enumerable:!0,configurable:!0}})}},{key:"resize",value:function(t,e){t>0&&e>0&&(this.width!=t||this.height!=e)&&(this.setDimensions(t,e),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}},{key:"fillTexture",value:function(t){if(!this.texture)throw new Error("Underlying layer is not texture based");new xn(this.gl,this.texture).fill(t)}},{key:"delete",value:function(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}},{key:"deleteLater",value:function(){var t=this;setTimeout((function(){return t.delete()}),0)}},{key:"isDeleted",value:function(){return this.deleted}}]),r}(Dn),Vn=function(){function t(e){s(this,t),this.randomSeed=e||parseInt(Date.now()/1e3)}return c(t,[{key:"copyTo",value:function(t){t.randomSeed=this.randomSeed}}]),t}();function Hn(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var qn=function(t){d(r,t);var e=Hn(r);function r(t,n){var i;return s(this,r),(i=e.call(this,t.inkGLContext,n)).convexHullChainProducer=new nn,i.polygonSimplifier=new un,Object.defineProperty(p(i),"inkContext",{value:t,enumerable:!0}),Object.defineProperty(p(i),"bounds",{get:function(){return Be.fromGLRect(i.graphicsBounds)},enumerable:!0}),i}return c(r,[{key:"clear",value:function(t,e){if(e){if(Ne.isColor(t))throw new Error("`clear` first argument should be Rect")}else Ne.isColor(t)?(e=t,t=null):e=Ne.TRANSPERENT;var r;if(Be.isRect(t)){if(!t.intersect(this.bounds))return;r=Be.fromRect(t).toGLRect()}Array.isArray(t)||t instanceof Float32Array?this.fill(t,e,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(e)),r&&this.inkContext.disableTargetClipRect()}},{key:"draw",value:function(t){var e,r=t.brush;return r instanceof Sn?isFinite(t.randomSeed)&&(e=new Vn(t.randomSeed)):e=t.color,this.drawStroke(r,t.path,e)}},{key:"drawStroke",value:function(t,e,r){if(!Tn.validatePath(e))return null;this.inkContext.setTarget(this);var n=this.inkContext.drawStroke(t,e,r);return n instanceof Le&&(n=Be.fromGLRect(n)),n}},{key:"fill",value:function(t,e){var r,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=!1;if(Be.isRect(t))r=t,t=new Ur(t.toPath().points),i=!0;else{if("number"==typeof t[0])t=new Ur(t);else if(!(t instanceof Ur))throw new Error("fill shape type missmatch, expected InkPath2D");r=t.bounds}if(r=this.bounds.intersect(r)){i||(t=this.convexHullChainProducer.get(t)),t=this.polygonSimplifier.get(t);var o=this.inkContext.triangulate(t);o.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(o,e,n)):r=void 0}return r?r.ceil():void 0}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=mn.SOURCE_OVER),e.rect&&!e.transform&&(e.sourceRect=e.rect,e.destinationRect=e.rect),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,Be.isRect(e.clipRect)?Be.fromRect(e.clipRect).toGLRect():void 0),"boolean"==typeof e.flipY&&(t.flipY=e.flipY),e.transform&&e.rect){var r=Be.fromRect(e.rect).toGLRect().toQuad(),n=Be.fromRect(e.rect).toGLRect().toQuad(e.transform);this.inkContext.drawLayer(t,r,n,e.mode)}else e.transform?this.inkContext.drawLayerWithTransform(t,e.transform,e.mode):e.sourceRect&&e.destinationRect?this.inkContext.drawLayer(t,Be.fromRect(e.sourceRect).toGLRect().toQuad(),Be.fromRect(e.destinationRect).toGLRect().toQuad(),e.mode):this.inkContext.drawLayerWithTransform(t,null,e.mode)}},{key:"createImageData",value:function(t,e,r){return t instanceof Uint8Array&&(t=new Uint8ClampedArray(t.buffer)),new ImageData(t,e,r)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.createImageData(this.readPixels(t,!0),t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.writePixels(t.data,new Be(e,r,t.width,t.height))}},{key:"readPixels",value:function(t,e){t&&(t=Be.fromRect(t).toGLRect()),this.inkContext.setTarget(this);var r=this.inkContext.readPixels(t);if(e)for(var n=0;n<r.length;n+=4){var i=r[n+3];r[n]=parseInt(255*r[n]/i),r[n+1]=parseInt(255*r[n+1]/i),r[n+2]=parseInt(255*r[n+2]/i)}return r}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e&&(e=Be.fromRect(e).toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(e,t)}},{key:"getExportCanvas",value:function(t){t=t?t.intersect(this.bounds).ceil():this.bounds;var e=new OffscreenCanvas(t.width,t.height);return e.getContext("2d").putImageData(this.getImageData(t),0,0),e}}]),r}(Xn),Zn=x.commonJS?require("poly2tri"):poly2tri,Wn=Zn.SweepContext,Kn=Zn.Point,Jn=function(){function t(e){if(s(this,t),!e)throw new Error("GL context is not available in current environment");var r;this.gl=e,this.program=null,this.programs=[],Object.defineProperty(this,"blendMode",{get:function(){return r},set:function(t){if(!t)throw new Error("blendMode is required");r!=t&&(this.activeBlendMode(t),r=t)},enumerable:!0}),Object.defineProperty(t,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(t,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(t,"SPRITES_BATCH_SIZE",{value:1e3,enumerable:!0})}return c(t,[{key:"init",value:function(t,e){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.blendMaxFallback=!this.gl.MAX&&!this.blendMinMaxExt,this.blendMode=mn.COPY,this.resize(t,e),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.onChange();for(var r=0;r<this.programs.length;r++)this.programs[r].init()}},{key:"getSupportedFloatPrecision",value:function(t){return this.gl.getShaderPrecisionFormat(t,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(t,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}},{key:"random",value:function(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}},{key:"setUniforms",value:function(t){var e=U();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),t?z(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):z(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=e,this.onChange()}},{key:"resize",value:function(t,e){this.gl.viewport(t.x,t.y,t.width,t.height),this.bounds=t,this.graphicsBox=e,this._clipRect=this.graphicsBox}},{key:"activeBlendMode",value:function(t){switch(t){case mn.COPY:this.gl.disable(this.gl.BLEND);break;case mn.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case mn.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case mn.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case mn.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case mn.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case mn.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case mn.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case mn.MIN:this.gl.enable(this.gl.BLEND),this.gl.MIN?this.gl.blendEquation(this.gl.MIN):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case mn.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case mn.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case mn.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: ".concat(t))}}},{key:"clearColorBuffer",value:function(t){this.gl.clearColor(t.red*t.alpha/255,t.green*t.alpha/255,t.blue*t.alpha/255,t.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"scissors",value:function(t){if(t&&!(t instanceof Le))throw new TypeError("rect must be undefined or instanceof RectGL");var e=this.gl.isEnabled(this.gl.SCISSOR_TEST);t?(e||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(t.x,t.y,t.width,t.height)):e&&this.gl.disable(this.gl.SCISSOR_TEST)}},{key:"isProgramActive",value:function(t){return this.program==t}},{key:"activateProgram",value:function(t){this.isProgramActive(t)?t.contextChanged&&(t.onContextChange(),t.contextChanged=!1):(this.program&&this.program.onDeactivate(),this.gl.useProgram(t.program),this.program=t,t.onActivate(),t.onContextChange(),t.contextChanged=!1)}},{key:"generateBuffersExt",value:function(t,e,r,n){var i=this.gl,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);var a=i.createTexture();return i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,n,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),{framebuffer:o,texture:a}}},{key:"genFrameAndRenders",value:function(t,e,r){var n=this.gl.createFramebuffer(),i=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,i),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,t,e,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,i),{framebuffer:n,renderbuffer:i}}},{key:"deleteBuffers",value:function(t,e){e&&this.gl.deleteTexture(e),t&&this.gl.deleteFramebuffer(t)}},{key:"deleteFrameAndRender",value:function(t,e){e&&this.gl.deleteRenderbuffer(e),t&&this.gl.deleteFramebuffer(t)}},{key:"onChange",value:function(){for(var t=0;t<this.programs.length;t++)this.programs[t].contextChanged=!0}},{key:"enableStencilBufferForBlending",value:function(t){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT),this.isStencilBufferAvailable()||this.attachStencilBufferForBlending(t)}},{key:"isStencilBufferAvailable",value:function(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}},{key:"attachStencilBufferForBlending",value:function(t){var e=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING);if(t.framebuffer==e){var r=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,t.width,t.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,r),t.renderbuffer=r,t.releaseRenderbuffer=!0}}},{key:"drawArrays",value:function(t,e,r){this.blendMode==mn.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawArrays.bind(this.gl,t,e,r)):this.gl.drawArrays(t,e,r)}},{key:"drawElements",value:function(t,e,r,n){this.blendMode==mn.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawElements.bind(this.gl,t,e,r,n)):this.gl.drawElements(t,e,r,n)}},{key:"drawBlendMaxFallback",value:function(t){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),t(),this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),t(),this.gl.disable(this.gl.STENCIL_TEST)}}],[{key:"random",value:function(t){return(1103515245*t+12345&2147483647)/2147483647}}]),t}(),Qn=function(){function t(e){s(this,t),Object.defineProperties(this,{inkGLContext:{value:e,enumerable:!0},gl:{value:e.gl,enumerable:!0}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}return c(t,[{key:"init",value:function(){}},{key:"compileShader",value:function(t,e){var r=this.gl.createShader(e);if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw new Error("".concat(this.constructor.name," could not compile shader: ").concat(this.gl.getShaderInfoLog(r)));return r}},{key:"createProgram",value:function(t,e){var r=this.gl.createProgram();if(this.gl.attachShader(r,t),this.gl.attachShader(r,e),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))throw new Error("".concat(this.constructor.name," failed to link: ").concat(this.gl.getProgramInfoLog(r)));return r}},{key:"onActivate",value:function(){}},{key:"onDeactivate",value:function(){}},{key:"onContextChange",value:function(){}},{key:"activate",value:function(){this.inkGLContext.activateProgram(this)}}]),t}();function $n(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var ti=function(t){d(r,t);var e=$n(r);function r(t){var n;return s(this,r),(n=e.call(this,t)).vertsBuffer=n.gl.createBuffer(),n.colorsBuffer=n.gl.createBuffer(),n}return c(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawVertices",value:function(t,e,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),t.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,t.length/2)}},{key:"drawPathVerticesPatch",value:function(t,e,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),t.length&&(this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(this.gl.TRIANGLES,0,t.length/2),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(this.gl.TRIANGLES,0,t.length/2))}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Jn.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}]),r}(Qn);function ei(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var ri=function(t){d(r,t);var e=ei(r);function r(t){var n;return s(this,r),(n=e.call(this,t)).destBuffer=n.gl.createBuffer(),n.srcBuffer=n.gl.createBuffer(),n}return c(r,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawTexture",value:function(t,e,r,n,i){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,n),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,i),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Jn.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tprecision ".concat(Jn.FRAGMENT_SHADER_PRECISION," float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t")}}]),r}(Qn);function ni(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var ii=function(t){d(r,t);var e=ni(r);function r(t){var n;return s(this,r),(n=e.call(this,t)).buffer=n.gl.createBuffer(),n.indexBuffer=n.gl.createBuffer(),n}return c(r,[{key:"init",value:function(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}},{key:"setBrush",value:function(t){this.brush=t,this.brushChanged=!0}},{key:"onActivate",value:function(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var t=19*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,t,0*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_xys,3,this.gl.FLOAT,!1,t,2*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteRotation,1,this.gl.FLOAT,!1,t,5*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteScaleAndOffset,4,this.gl.FLOAT,!1,t,6*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,t,10*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_velocity,2,this.gl.FLOAT,!1,t,14*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_transformParams,3,this.gl.FLOAT,!1,t,16*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.enableVertexAttribArray(this.a_xys),this.gl.enableVertexAttribArray(this.a_spriteRotation),this.gl.enableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.enableVertexAttribArray(this.a_color),this.gl.enableVertexAttribArray(this.a_velocity),this.gl.enableVertexAttribArray(this.a_transformParams)}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.disableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_color),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"updateTextures",value:function(){this.brushChanged&&(this.brushChanged=!1,this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture.value),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture.value),this.gl.uniform1i(this.u_fillTexture,1))}},{key:"drawSpritesBatch",value:function(t,e,r){var n,i=this;this.activate(),this.updateTextures();var o=e*Jn.SPRITES_BATCH_SIZE,a=o+Jn.SPRITES_BATCH_SIZE;a>t.length&&(a=o+t.length%Jn.SPRITES_BATCH_SIZE);for(var s=a-o,u=new Float32Array(76*s),c=new Uint16Array(6*s),l=this.brush.rotationMode==Sn.RotationMode.TRAJECTORY?1:0,h=function(e){var r=t.getPoint(e),a=76*(e-o),s=Le.calculateBrushGLSegmentBounds(r,i.brush.scattering);n=s.union(n);var c=r.red/255*r.alpha,h=r.green/255*r.alpha,f=r.blue/255*r.alpha;0==r.dX&&0==r.dY&&(r.dX=2*i.inkGLContext.random()-1,r.dY=2*i.inkGLContext.random()-1);var d=i.brush.rotationMode==Sn.RotationMode.RANDOM?2*i.inkGLContext.random()*Math.PI:0,p=(2*i.inkGLContext.random()-1)*i.brush.scattering;Le.SQURE.forEach((function(t,e){var n=a+19*e;u[n]=t.x,u[n+1]=t.y,u[n+2]=r.x,u[n+3]=r.y,u[n+4]=r.size,u[n+5]=r.rotation,u[n+6]=r.scaleX,u[n+7]=r.scaleY,u[n+8]=r.offsetX,u[n+9]=r.offsetY,u[n+10]=c,u[n+11]=h,u[n+12]=f,u[n+13]=r.alpha,u[n+14]=r.dX,u[n+15]=r.dY,u[n+16]=l,u[n+17]=d,u[n+18]=p}))},f=o;f<a;f++)h(f);for(var d=0,p=0;p<c.length;p+=6)c[p]=d,c[p+1]=d+1,c[p+2]=d+2,c[p+3]=d+2,c[p+4]=d+1,c[p+5]=d+3,d+=4;return this.gl.bufferData(this.gl.ARRAY_BUFFER,u,this.gl.STATIC_DRAW),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,c,this.gl.STATIC_DRAW),this.inkGLContext.drawElements(this.gl.TRIANGLES,c.length,this.gl.UNSIGNED_SHORT,0),n}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Jn.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(t){return"\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ".concat(t?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)",";\n\n\t\t\t}\n\t\t")}}]),r}(Qn),oi=function(){function t(e,r){s(this,t);var n=e.getContext("webgl2",r)||e.getContext("webgl",r);this.inkGLContext=new Jn(n),this.gl=this.inkGLContext.gl,this.simpleProgram=new ti(this.inkGLContext),this.textureProgram=new ri(this.inkGLContext),this.spriteProgram=new ii(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new Le(0,0,0,0),new Le(0,0,0,0))}return c(t,[{key:"createLayer",value:function(t,e){return new Xn(this.inkGLContext,t,e)}},{key:"drawLayerWithTransform",value:function(t,e,r){if(this.currentTarget){var n=t.graphicsBounds.toQuad(),i=t.graphicsBounds.toQuad(e);this.drawLayer(t,n,i,r)}}},{key:"drawLayer",value:function(t,e,r,n){if(this.currentTarget&&t.useTextureStorage){var i=U(),o=U(),a=this.currentTarget;a.flipY?z(o,0,a.width,a.height,0,1,-1):z(o,0,a.width,0,a.height,1,-1),t.flipY?z(i,-t.width,t.width,2*t.height,0,0,1):z(i,-t.width,t.width,-t.height,t.height,0,1),this.inkGLContext.blendMode=n,this.textureProgram.drawTexture(t.texture,r,e,o,i)}}},{key:"setTarget",value:function(t,e){var r=this.inkGLContext,n=r.gl;if(t&&!(t instanceof Xn))throw new TypeError("layer must be unset or instanceof InkLayer");if(e&&!(e instanceof Le))throw new TypeError("clipRect must be unset or instanceof RectGL");if(t){this.currentTarget=t;var i=new Le(0,0,t.storageWidth,t.storageHeight),o=new Le(0,0,t.width,t.height);r.resize(i,o),r.setUniforms(t.flipY),e?this.setTargetClipRect(e):this.disableTargetClipRect(),n.bindFramebuffer(n.FRAMEBUFFER,t.framebuffer)}}},{key:"clearColor",value:function(t){this.inkGLContext.clearColorBuffer(t)}},{key:"setTargetClipRect",value:function(t){var e=this.inkGLContext;t=t.floor().intersect(this.currentTarget.graphicsBounds),e._clipRect=t;var r=this.currentTarget.scaleFactor;t=this.currentTarget.flipY?new Le(t.x,this.currentTarget.storageHeight-t.top,t.width,t.height):new Le(t.x*r,t.y*r,t.width*r,t.height*r),e.scissors(t)}},{key:"disableTargetClipRect",value:function(){var t=this.inkGLContext;t.scissors(null),t._clipRect=t.graphicsBox}},{key:"drawStroke",value:function(t,e,r){return this.currentTarget?0==e.length?null:(this.inkGLContext.blendMaxFallback&&t.blendMode==mn.MAX&&this.inkGLContext.enableStencilBufferForBlending(this.currentTarget),t instanceof Sn?this.drawGL(t,e,r):this.draw2D(t,e,r)):null}},{key:"drawGL",value:function(t,e,r){var n,i=null,o=this.inkGLContext._clipRect;r&&(n=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),t.blendMode?this.inkGLContext.blendMode=t.blendMode:this.inkGLContext.blendMode=mn.SOURCE_OVER,this.spriteProgram.setBrush(t);for(var a=Math.ceil(e.length/Jn.SPRITES_BATCH_SIZE),s=0;s<a;s++){i=this.spriteProgram.drawSpritesBatch(e,s).union(i)}return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=n),(i=o.intersect(i))&&(i=i.ceil()),i}},{key:"draw2D",value:function(t,e,r){var n=this,i=this.currentTarget.bounds.intersect(e.bounds);if(!i)return null;if(t.spacing>1)e.forEach((function(t){var e=n.triangulate([t]);n.fillStroke(e,r)}));else{var o=this.triangulate(e);this.fillStroke(o,r)}return i}},{key:"triangulate",value:function(t){var e=[],r=[],n=0;t.forEach((function(t){for(var e=[],i=0;i<t.length;i+=2){var o=new Kn(t[i],t[i+1]);o.index=n++,e.push(o)}r.push(e)}));var i=new Wn(r.shift());r.forEach((function(t){return i.addHole(t)}));var o=[];try{i.triangulate(),o=i.getTriangles()}catch(t){console.warn(t)}return e.index=[],o.forEach((function(t){var r=t.getPoints().filter((function(t){return isFinite(t.index)}));3==r.length?r.forEach((function(t){e.push(t.x,t.y),e.index.push(t.index)})):console.warn("Undefined triangle:",t.getPoints())})),e}},{key:"fillStroke",value:function(t,e){this.fill(t,e,!0,!0)}},{key:"fill",value:function(t,e,r,n){e=e.premultiply();for(var i=r?4:1,o=i*i,a=1.01/o,s=1.25/i,u=r?new Ne(a*e.red,a*e.green,a*e.blue,a*e.alpha):e,c=new Float32Array(t.length*o),l=new Float32Array(2*t.length*o),h=0,f=0,d=0;d<i;d++)for(var p=0;p<i;p++)for(var y={x:d*s-(1.25-s)/2,y:p*s-(1.25-s)/2},v=0;v<t.length;v+=6)for(var g=[{x:t[v],y:t[v+1]},{x:t[v+2],y:t[v+3]},{x:t[v+4],y:t[v+5]}],m=0;m<3;m++)c[h++]=g[m%3].x+y.x,c[h++]=g[m%3].y+y.y,l[f++]=u.red,l[f++]=u.green,l[f++]=u.blue,l[f++]=u.alpha;var b=mn.SOURCE_OVER;n?b=mn.MAX:r?b=mn.LIGHTER:e.equals(Ne.TRANSPERENT)&&(b=mn.COPY),this.inkGLContext.blendMode=b,this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),n?this.simpleProgram.drawPathVerticesPatch(c,l):this.simpleProgram.drawVertices(c,l)}},{key:"readPixels",value:function(t){var e=this.currentTarget,r=this.inkGLContext.gl;if(t){if(!(t instanceof Le))throw new TypeError("box must be instance of RectGL")}else t=e.graphicsBounds;e.flipY&&(t=new Le(t.x,e.height-t.y-t.height,t.width,t.height)),this.setTarget(e);var n=new Uint8Array(t.width*t.height*4);return r.readPixels(parseInt(t.x*e.scaleFactor),parseInt(t.y*e.scaleFactor),parseInt(t.width*e.scaleFactor),parseInt(t.height*e.scaleFactor),r.RGBA,r.UNSIGNED_BYTE,n),n}},{key:"writePixels",value:function(t,e){if(t&&!(t instanceof Le))throw new TypeError("rect must be instance of RectGL");var r=this.currentTarget,n=this.inkGLContext.gl;if(t||(t=new Le(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");r.flipY&&(t=new Le(t.x,r.height-t.y-t.height,t.width,t.height));var i=new Le(t.x*r.scaleFactor,t.y*r.scaleFactor,t.width*r.scaleFactor,t.height*r.scaleFactor);n.finish(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r.texture),n.texSubImage2D(n.TEXTURE_2D,0,parseInt(i.x),parseInt(i.y),parseInt(i.width),parseInt(i.height),n.RGBA,n.UNSIGNED_BYTE,e)}}]),t}();function ai(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var si=function(t){d(n,t);var e,r=ai(n);function n(t){var e,i;s(this,n),i=r.call(this,t,{display:!0,width:t.inkGLContext.gl.canvas.width,height:t.inkGLContext.gl.canvas.height,flipY:x.typeGL==x.TypeGL.WEB}),Object.defineProperty(p(i),"surface",{value:t.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(p(i),"ctx",{value:t.inkGLContext.gl,enumerable:!0});var o=i.ctx.getContextAttributes();if("function"==typeof requestAnimationFrame&&!o.preserveDrawingBuffer){var a=i.createLayer();Object.defineProperty(p(i),"backbuffer",{value:a,enumerable:!0});i.frameID=requestAnimationFrame((function t(r){i.present&&(delete i.present,ce((e=p(i),v(n.prototype)),"blend",e).call(e,a,{mode:mn.COPY})),i.frameID=requestAnimationFrame(t)}))}return i}return c(n,[{key:"test",value:function(){var t=this;this.testBuffer||(this.testCnt=0,this.testBuffer=this.ctx.createBuffer()),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.testBuffer);var e=Date.now();this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([0,0,0,0,0,0,0,0]),this.ctx.DYNAMIC_DRAW),(e=Date.now()-e)>5&&this.testCnt<100?setTimeout((function(){t.testCnt++,t.test()}),100):(this.ctx.deleteBuffer(this.testBuffer),delete this.testBuffer,delete this.testCnt)}},{key:"createLayer",value:function(t){return new qn(this.inkContext,t)}},{key:"clear",value:function(t,e){this.backbuffer?(this.backbuffer.clear(t,e),this.present=!0):ce(v(n.prototype),"clear",this).call(this,t,e)}},{key:"draw",value:function(t,e){var r;return this.backbuffer?(r=this.backbuffer.draw(t,e),this.present=!0):r=ce(v(n.prototype),"draw",this).call(this,t,e),r}},{key:"drawStroke",value:function(t,e,r){var i;return this.backbuffer?(i=this.backbuffer.drawStroke(t,e,r),this.present=!0):i=ce(v(n.prototype),"drawStroke",this).call(this,t,e,r),i}},{key:"fill",value:function(t,e,r){var i;return this.backbuffer?(i=this.backbuffer.fill(t,e,r),this.present=!0):i=ce(v(n.prototype),"fill",this).call(this,t,e,r),i}},{key:"blend",value:function(t,e){this.backbuffer?(this.backbuffer.blend(t,e),this.present=!0):ce(v(n.prototype),"blend",this).call(this,t,e)}},{key:"readPixels",value:function(t,e){return this.backbuffer?this.backbuffer.readPixels(t,e):ce(v(n.prototype),"readPixels",this).call(this,t,e)}},{key:"writePixels",value:function(t,e){this.backbuffer?(this.backbuffer.writePixels(t,e),this.present=!0):ce(v(n.prototype),"writePixels",this).call(this,t,e)}},{key:"toBlob",value:(e=a(i.mark((function t(){var e,r,o,a=arguments;return i.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=a.length>0&&void 0!==a[0]?a[0]:this.bounds,r=a.length>1?a[1]:void 0,o=a.length>2?a[2]:void 0,!this.backbuffer){t.next=9;break}return t.next=6,this.backbuffer.toBlob(e,r,o);case 6:return t.abrupt("return",t.sent);case 9:return t.next=11,ce(v(n.prototype),"toBlob",this).call(this,e,r,o);case 11:return t.abrupt("return",t.sent);case 12:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"resize",value:function(t,e){ce(v(n.prototype),"resize",this).call(this,t,e),this.surface.width=t,this.surface.height=e}},{key:"delete",value:function(){"number"==typeof this.frameID&&cancelAnimationFrame(this.frameID),ce(v(n.prototype),"delete",this).call(this),this.backbuffer&&this.backbuffer.delete()}},{key:"deleteLater",value:function(){return ce(v(n.prototype),"deleteLater",this).call(this),this.backbuffer&&this.backbuffer.deleteLater(),this}}],[{key:"createInstance",value:function(t,e,r,i){if(!t||"function"!=typeof t.getContext)throw new Error("WebGL context provider is required");if(e>0&&r>0&&(t.width=e,t.height=r),!(t.width>0&&t.width>0))throw new Error("width and height are required and should be positive whole numbers");return new n(new oi(t,i))}}]),n}(qn),ui=function(){function t(e,r){var n=this;s(this,t),this.canvas=e;var i=r instanceof qn?r:void 0,o=r&&!i?r:new Object;this.layer=i||e.createLayer(o),this.preliminaryLayer=void 0,this.layerOptions=o,this.ownLayer=!i,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=Ne.TRANSPERENT,this.blendMode=mn.SOURCE_OVER,this.randomSeed=void 0,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,color:n.color,backgroundColor:n.backgroundColor,blendMode:n.blendMode,transform:n.transform,randomSeed:n.initialRandomSeed}},enumerable:!0})}return c(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),"transform"in t&&this.setTransform(t.transform),this.brush instanceof Sn&&isFinite(t.randomSeed)&&(this.initialRandomSeed=t.randomSeed),this.restart=!0}},{key:"setTransform",value:function(t){this.transform=t,this.layer.setTransform(t),this.preliminaryLayer&&this.preliminaryLayer.setTransform(t)}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),t instanceof Tn){var r,n=t,i=mn.SOURCE_OVER;if(n.renderMode&&!(i=Tn.RenderMode.getBlendMode(n.renderMode)))return void console.warn("Cannot process ".concat(n.renderMode," render mode. Requres custom processing."));this.blendMode=i,n.target=Tn.Target.GL,this.transform&&!this.transform.isIdentity&&(r=n.path.clone(),n.path.transform(this.transform));var o=this.layer.draw(n);r&&(n.path=r),this.strokeBounds=o,this.updatedArea=o,this.restart=!0}else{if(this.validate(t)){t.color&&this.color&&!t.color.equals(this.color)&&(t.color=this.color),this.transform&&!this.transform.isIdentity&&t.transform(this.transform);var a=this.brush instanceof Sn?this.strokeLastRendererdDrawContext:this.color,s=this.layer.drawStroke(this.brush,t,a);s&&(this.incompleteStrokeBounds=s.union(this.incompleteStrokeBounds),this.strokeBounds=s.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null,r=null;this.brush instanceof Sn?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),e=this.strokePrelimLastRenderedDrawContext):e=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.setTransform(this.transform)),r=this.preliminaryLayer):r=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:mn.COPY,rect:this.updatedArea}),t.color&&this.color&&!t.color.equals(this.color)&&(t.color=this.color),this.transform&&!this.transform.isIdentity&&t.transform(this.transform),this.preliminaryDirtyArea=r.drawStroke(this.brush,t,e),this.updatedArea=Be.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof Sn?(this.strokeLastRendererdDrawContext=new Vn(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new Vn),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}},{key:"validate",value:function(t){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return t&&t.length>0}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=t||this.canvas,n=r.bounds.intersect(this.updatedArea);n&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(e.getImageData(n),n,!1):r.blend(e,{mode:this.blendMode,rect:n})),this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=t||this.canvas;(e=i.bounds.intersect(e||this.strokeBounds))&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(n.getImageData(e),e,!0):i.blend(n,{mode:r,rect:e}))}}},{key:"toStroke",value:function(t){var e=t.getSensorData(),r=t.getSpline(),n=t.getInkPath();r.randomSeed=this.randomSeed;var i=new Tn(this.brush,r,n,e);return e&&(i.sensorDataMapping=e.inkStream.getPipelineMapping()),this.blendMode!=mn.SOURCE_OVER&&(i.renderMode=Tn.RenderMode.get(this.blendMode)),i}},{key:"delete",value:function(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}]),t}(),ci=function t(e,r,n){s(this,t),this.subject=e,this.predicate=r,this.object=n},li=function(){function t(){s(this,t),this.statements=[]}return c(t,[{key:"add",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];r.forEach((function(e){return t.statements.push(e)}))}},{key:"remove",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];r.forEach((function(e){return t.statements.remove(e)}))}},{key:"addTriple",value:function(t,e,r){this.statements.push(new ci(t,e,r))}},{key:"search",value:function(t){return this.statements.filter((function(e){var r=!0;return Object.keys(t).forEach((function(n){r=r&&e[n]==t[n]})),r}))}}]),t}(),hi=x.commonJS?require("protobufjs"):protobuf,fi={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};function di(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var pi=function(t){d(r,t);var e=di(r);function r(t){return s(this,r),e.call(this,t)}return r}(I);function yi(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var vi=function(t){d(r,t);var e=yi(r);function r(t){var n,i;return s(this,r),n=e.call(this,t),Object.defineProperty(p(n),"bounds",{get:function(){return i||(i=this.getBounds()),i},set:function(t){i=t},enumerable:!0}),Object.defineProperty(p(n),"root",{get:function(){for(var t=this.parent,e=this;t;)e=t,t=t.parent;return e},enumerable:!0}),n}return c(r,[{key:"updateID",value:function(t,e){var r=this.root.model;r&&r.updateRegistry(t,e)}},{key:"getBounds",value:function(){return this.content.bounds}},{key:"invalidateBounds",value:function(){this.bounds=void 0}},{key:"remove",value:function(){this.parent.removeChild(this)}}]),r}(pi);function gi(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var mi=function(t){d(r,t);var e=gi(r);function r(t){var n;return s(this,r),(n=e.call(this,t)).children=[],Object.defineProperty(p(n),"content",{value:n.children,enumerable:!0}),n}return c(r,[{key:"getBounds",value:function(){var t;return this.children.forEach((function(e){t=t?t.union(e.bounds):e.bounds})),t}},{key:"appendChild",value:function(t,e){if(!(t instanceof vi))throw new Error("Incompatible node found - ".concat(t.constructor.name,". It should be ink model Element."));if(e<0)throw new Error("Index should be a positive number");var r=t.parent;if(r&&t.parent.children.remove(t),t.parent=this,isFinite(e)&&e<this.children.length?this.children.insert(e,t):this.children.push(t),!r){var n=this.root.model;n&&n.register(t,e)}return this.invalidateBounds(),t}},{key:"removeChild",value:function(t){if(!this.children.includes(t))throw new Error("Node was not found");var e=this.root.model;e&&e.unregister(t),this.invalidateBounds(),this.children.remove(t)}},{key:"remove",value:function(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}]),r}(vi);function bi(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Ei=function(t){d(r,t);var e=bi(r);function r(t){var n;return s(this,r),n=e.call(this),Object.defineProperty(p(n),"content",{value:t,enumerable:!0}),n}return r}(vi),xi=function(){function t(e,r,n){s(this,t),this.model=e,this.type=r||e.type,this.tree=this.createGroup(n),this.tree.model=this,this.register(this.tree)}return c(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"createElement",value:function(t,e,r){var n=this.model.createElement(t,this);return n.fromPointIndex=e,n.toPointIndex=r,n}},{key:"createGroup",value:function(t){return this.model.createGroup(t,this)}},{key:"register",value:function(e){var r=this;if(e instanceof mi)e.children.forEach((function(t){return r.register(t)}));else if(e instanceof Ei){if(e.content instanceof Tn){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof Ae))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - ".concat(e.content.id))}this.model.index(e),this.updateKnowledgeGraph(e.id)}},{key:"unregister",value:function(t){var e=this;t instanceof mi&&t.children.forEach((function(t){return e.unregister(t)})),delete this.model.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t){if(t){var e=this.model.uriBuilder.buildNodeURI(t);if(this.model.registry[t]){var r,n;if(!this.knowledgeGraph)return;(r=this.model.knowledgeGraph).add.apply(r,L(this.knowledgeGraph.search({subject:e}))),(n=this.model.knowledgeGraph).add.apply(n,L(this.knowledgeGraph.search({object:e})))}else{var i,o;(i=this.model.knowledgeGraph).remove.apply(i,L(this.model.knowledgeGraph.search({subject:e}))),(o=this.model.knowledgeGraph).remove.apply(o,L(this.model.knowledgeGraph.search({object:e})))}}}}]),t}(),Pi=function(){function t(){s(this,t)}return c(t,[{key:"setInkModelURI",value:function(t){return this.inkModelURI=t,this}},{key:"setNodeID",value:function(t){return this.inkNodeID=t,this}},{key:"buildNodeURI",value:function(t,e){return this.reset().setInkModelURI(e).setNodeID(t).build()}},{key:"build",value:function(){var t="",e="";return this.inkModelURI&&(t=this.fixedEncodeURIComponent(this.inkModelURI),e="/"),e+="node/"+this.inkNodeID,"".concat("uim:").concat(t).concat(e)}},{key:"fixedEncodeURIComponent",value:function(t){return encodeURIComponent(t).replace(/[!'()*]/g,(function(t){return"%"+t.charCodeAt(0).toString(16)}))}},{key:"reset",value:function(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}]),t}(),wi=function(){function t(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Type.STROKE,n=arguments.length>1?arguments[1]:void 0;s(this,t),this.type=r,this.tree=this.createGroup(n),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new li,this.uriBuilder=new Pi,this.registry={},this.registry[this.tree.id]=this.tree,Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:function(){return e.type==t.Type.STROKE?e.content.slice():[]},enumerable:!0}),Object.defineProperty(this,"sensorData",{get:function(){return e.type==t.Type.STROKE?e.content.map((function(t){return t.sensorData})).filter((function(t){return!!t})):e.content},enumerable:!0}),Object.defineProperty(this,"brushes",{get:function(){var t={};return e.strokes.forEach((function(r){return t[r.brush.name]=e.registry[r.brush.name]||r.brush})),Object.values(t)},set:function(t){t.forEach((function(t){return e.registry[t.name]=t}))},enumerable:!0})}return c(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"removePath",value:function(t){t.nodeID&&this.registry[t.nodeID].remove()}},{key:"replacePath",value:function(t,e,r){var n=this;if(t.nodeID){var i=this.getItem(t.nodeID),o=i.parent||this.tree,a=e.map((function(t){return n.createElement(t)})),s=o.children.indexOf(i);if(r){var u=o.appendChild(this.createGroup(),s);a.forEach((function(t){return u.appendChild(t)}))}else a.forEach((function(t,e){return o.appendChild(t,s+e)}));this.removePath(t)}}},{key:"createElement",value:function(e,r){if(!e)throw new Error("Element content not found");var n=r?r.type:this.type;switch(n){case t.Type.STROKE:if(!(e instanceof Tn))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of Stroke."));break;case t.Type.SENSOR_DATA:if(!(e instanceof Ae))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of SensorData."));break;default:throw console.warn(n),new Error("Invalid ink model type found")}return new Ei(e)}},{key:"createGroup",value:function(t,e){return new mi(t)}},{key:"getItem",value:function(t){return this.registry[t]}},{key:"register",value:function(e,r){var n=this;if(e instanceof mi)e.children.forEach((function(t){return n.register(t)}));else if(e instanceof Ei){if(e.content instanceof Tn){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof Ae))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),isFinite(r)&&r<this.content.length?this.content.insert(r,e.content):this.content.push(e.content),this.index(e.content)}this.index(e),e instanceof pi&&!this.keepViews&&this.resetViews()}},{key:"updateRegistry",value:function(t,e){var r=this.registry[t];delete this.registry[t],this.registry[r.id]=r,this.updateKnowledgeGraph(t,e)}},{key:"unregister",value:function(t){var e=this;t instanceof pi&&this.resetViews(),t instanceof mi?t.children.forEach((function(t){return e.unregister(t)})):t instanceof Ei&&(delete t.content.nodeID,delete this.registry[t.content.id],this.content.remove(t.content)),t==this.tree?t.children.clear():delete this.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t,e){var r,n,i=this.uriBuilder.buildNodeURI(t),o=this.uriBuilder.buildNodeURI(e);o?(this.knowledgeGraph.search({subject:i}).forEach((function(t){return t.subject=o})),this.knowledgeGraph.search({object:i}).forEach((function(t){return t.object=o}))):((r=this.knowledgeGraph).remove.apply(r,L(this.knowledgeGraph.search({subject:i}))),(n=this.knowledgeGraph).remove.apply(n,L(this.knowledgeGraph.search({object:i}))))}},{key:"index",value:function(t){if(this.registry[t.id])throw new Error("Cannot register item with id ".concat(t.id,". Already is available item with such identifier."));this.registry[t.id]=t}},{key:"createView",value:function(t,e,r,n){var i=new xi(this,e,r);return i.name=t,this.views[t]=i,n&&(i.knowledgeGraph=n,i.updateKnowledgeGraph(r)),i}},{key:"resetViews",value:function(){for(var t in this.views)this.views[t].tree.remove(),delete this.views[t]}}]),t}();wi.createEnum("Type",["STROKE","SENSOR_DATA"]),xi.Type=wi.Type;var ki={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}},Ri=function(){function t(){s(this,t),this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}return c(t,[{key:"encodeInk",value:function(t){t&&this.encode(ki.headers.inkChunkFourCC,t)}},{key:"encode",value:function(t,e){var r=t instanceof Uint8Array?t:t.toCharArray().toUint8Array();if(r.length!=ki.fourCCLength)throw new Error('Invalid fourCC: "'.concat(t,'"'));if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(r,e))}},{key:"build",value:function(){var t=this,e=ki.headers,r=0;this.chunks.unshift(this.createChunk(ki.headers.headChunkFourCC,ki.version)),this.chunks.forEach((function(t){r+=t.length}));var n=e.formatFourCC.length+r,i=e.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+n,o=new ArrayBuffer(i);this.fileBytes=new Uint8Array(o),this.dataView=new DataView(o),this.byteOffset=0,this.fileBytes.set(e.riffFourCC,this.byteOffset),this.byteOffset+=e.riffFourCC.length,this.dataView.setUint32(this.byteOffset,n,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.formatFourCC,this.byteOffset),this.byteOffset+=e.formatFourCC.length,this.chunks.forEach((function(e){t.appendChunk(e),t.byteOffset+=e.length}))}},{key:"createChunk",value:function(t,e){var r=e.length,n=r%2;return{fourCC:t,bytes:e,size:r,length:t.length+Uint32Array.BYTES_PER_ELEMENT+r+n}}},{key:"appendChunk",value:function(t){this.fileBytes.set(t.fourCC,this.byteOffset);var e=this.byteOffset+t.fourCC.length;this.dataView.setUint32(e,t.size,!0),e+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(t.bytes,e)}},{key:"reset",value:function(){this.chunks=[],this.fileBytes=null}}]),t}(),Si=function(){function t(){s(this,t)}return c(t,[{key:"decode",value:function(t){var e=ki.headers;this.reset(t);var r=this.byteOffset+e.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,r),e.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=r,r=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;var n=this.dataView.getUint32(this.byteOffset,!0)+r;if(n%2!=0)throw new Error("Invalid RIFF file size");if(n!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=r,r=this.byteOffset+e.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,r),e.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=r;this.byteOffset<n;){var i=this.extractChunk();this.byteOffset+=i.length,Object.equals(i.fourCC,e.headChunkFourCC)?this.version=[i.bytes[0],i.bytes[1],i.bytes[2]]:Object.equals(i.fourCC,e.inkChunkFourCC)?this.ink=i.bytes:this.chunks.push({fourCC:String.fromCharArray(i.fourCC),bytes:i.bytes})}}},{key:"extractChunk",value:function(){var t,e,r=this.fileBytes.subarray(this.byteOffset,this.byteOffset+ki.fourCCLength),n=null,i=this.byteOffset+r.length,o=i;return i=o+Uint32Array.BYTES_PER_ELEMENT,t=this.dataView.getUint32(o,!0),i=(o=i)+t,t>0?(n=this.fileBytes.subarray(o,i),n=new Uint8Array(n,n.byteOffset,n.length)):n=new Uint8Array(0),{fourCC:r,bytes:n,size:t,length:(e=r.length+Uint32Array.BYTES_PER_ELEMENT+t)+e%2}}},{key:"reset",value:function(t){this.fileBytes=t,this.dataView=new DataView(t.buffer),this.byteOffset=0,this.chunks=[]}}]),t}();function Ii(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return Ti(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ti(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Ti(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var Ai=function(){function t(){s(this,t),t.format||(t.format=hi.Root.fromJSON(fi).WacomInkFormat3),this.riffEncoder=new Ri,this.riffDecoder=new Si}var e,r,n,o;return c(t,[{key:"encodeInkModel",value:(o=a(i.mark((function e(r){var n,o,a=this;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.structure=!0,e.t0=t.format.InkObject,e.t1=this.encodeInkInput(r.sensorData),e.t2=this.encodeInkData(r.strokes),e.next=6,this.encodeBrushes(r.brushes);case 6:return e.t3=e.sent,e.t4=this.encodeNodeTree(r),e.t5=Object.values(r.views).map((function(t){return a.encodeView(t)})),e.t6=this.encodeKnowledgeGraph(r.knowledgeGraph),e.t7=this.encodeMat4(r.transform),e.t8=this.encodeProperties(r.props),e.t9={inputData:e.t1,inkData:e.t2,brushes:e.t3,inkTree:e.t4,views:e.t5,knowledgeGraph:e.t6,transform:e.t7,properties:e.t8},n=e.t0.create.call(e.t0,e.t9),this.structure=!1,o=t.encode(n),this.riffEncoder.reset(),this.riffEncoder.encodeInk(o),e.abrupt("return",this.riffEncoder.data);case 19:case"end":return e.stop()}}),e,this)}))),function(t){return o.apply(this,arguments)})},{key:"decodeInkModel",value:function(e,r){var n=this;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.riffDecoder.decode(e);var i=t.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=i,r){var o=this.decodeKnowledgeGraph(i.knowledgeGraph);i.views.forEach((function(t){return n.decodeView(t,r,o)}))}else{var a=this.decodeInkInput(i.inputData),s=this.decodeBrushes(i.brushes),u=this.decodeInkData(i.inkData,s,a),c=i.inkTree.first,l=c.type==t.format.NodeType.STROKE_GROUP?wi.Type.STROKE:wi.Type.SENSOR_DATA,h=c.type==t.format.NodeType.STROKE_GROUP?u:a;r=new wi(l,c.id),this.decodeNodeTree(r,i.inkTree.slice(1),h),i.views.forEach((function(t){return n.decodeView(t,r)})),r.knowledgeGraph=this.decodeKnowledgeGraph(i.knowledgeGraph),r.props=this.decodeProperties(i.properties),r.transform=this.decodeMat4(i.transform),r.brushes=Object.values(s)}return delete this.structure,r}},{key:"encodeInkInput",value:function(e){var r=this,n={},i={},o={},a={},s={};e.forEach((function(t){var e=t.context;n[e.id]||(n[e.id]=e,s[e.environment.id]||(s[e.environment.id]=e.environment),i[e.sensorContext.id]||(i[e.sensorContext.id]=e.sensorContext,e.sensorContext.channelsContexts.forEach((function(t){o[t.device.id]||(o[t.device.id]=t.device),t.inkProvider&&(a[t.inkProvider.id]||(a[t.inkProvider.id]=t.inkProvider))}))))}));var u=t.format.InputData.create({sensorData:e.map((function(t){return r.encodeSensorData(t)})),inputContextData:t.format.InputContextData.create({inputContexts:Object.values(n).map((function(e){return t.format.InputContext.create({id:e.id,environmentID:e.environment.id,sensorContextID:e.sensorContext.id})})),sensorContexts:Object.values(i).map((function(e){return t.format.SensorContext.create({id:e.id,sensorChannelsContext:e.channelsContexts.map((function(e){return t.format.SensorChannelsContext.create({id:e.id,channels:e.channels.map((function(e){return t.format.SensorChannel.create({id:e.id,type:e.type,metric:t.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})})),samplingRateHint:isFinite(e.samplingRate)?t.format.Uint32.create({value:e.samplingRate}):void 0,latency:isFinite(e.latency)?t.format.Uint32.create({value:e.latency}):void 0,inkInputProviderID:e.inkProvider?e.inkProvider.id:null,inputDeviceID:e.device.id})}))})})),inkInputProviders:Object.values(a).map((function(e){return t.format.InkInputProvider.create({id:e.id,type:t.format.InkInputProviderType[e.type.name],properties:r.encodeProperties(e.props)})})),inputDevices:Object.values(o).map((function(e){return t.format.InputDevice.create({id:e.id,properties:r.encodeProperties(e.props)})})),environments:Object.values(s).map((function(e){return t.format.Environment.create({id:e.id,properties:r.encodeProperties(e.props)})}))})});return this.structure?u:t.encode(u)}},{key:"decodeInkInput",value:function(e){var r=this;if(e){var n=this.structure?e:t.format.InputData.decode(e),i={},o={},a={},s={},u={};return n.inputContextData.environments.forEach((function(t){var e=new ye;r.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("Environment decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),u[e.id]=e})),n.inputContextData.inkInputProviders.forEach((function(e){var n=r.decodeProperties(e.properties),i=new A(A.Type[t.format.InkInputProviderType[e.type]],n);Object.freeze(i),i.id!=e.id&&console.warn("InkInputProvider decode id missmatch - found ".concat(e.id,", expected ").concat(i.id)),s[i.id]=i})),n.inputContextData.inputDevices.forEach((function(t){var e=new Me;r.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("InputDevice decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),a[e.id]=e})),n.inputContextData.sensorContexts.forEach((function(e){var r=new Re;e.sensorChannelsContext.forEach((function(e){var n=new we(a[e.inputDeviceID],s[e.inkInputProviderID]);e.samplingRateHint&&(n.samplingRate=e.samplingRateHint.value),e.latency&&(n.latency=e.latency.value),e.channels.forEach((function(e){var r=xe.Metric[t.format.InkSensorMetricType[e.metric]],i=new xe(e.type,r,e.resolution,e.min,e.max);i.precision=e.precision,n.add(i),i.id!=e.id&&console.warn("SensorChannel decode id missmatch - found ".concat(e.id,", expected ").concat(i.id))})),r.addContext(n),n.id!=e.id&&console.warn("SensorChannelsContext decode id missmatch - found ".concat(e.id,", expected ").concat(n.id))})),Object.freeze(r),o[r.id]=r,r.id!=e.id&&console.warn("SensorContext decode id missmatch - found ".concat(e.id,", expected ").concat(r.id))})),n.inputContextData.inputContexts.forEach((function(t){var e=new Ie(u[t.environmentID],o[t.sensorContextID]);Object.freeze(e),e.id!=t.id&&console.warn("InputContext decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),i[e.id]=e})),n.sensorData.map((function(t){return r.decodeSensorData(t,i[t.inputContextID])}))}}},{key:"encodeSensorData",value:function(e){var r=t.format.SensorData.create({id:e.id,inputContextID:e.context.id,state:t.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach((function(e){var n={};e.channels.forEach((function(t){return n[t.id]=[]}));for(var i=function(t){var r=e.get(t);e.channels.forEach((function(t){n[t.id].push(r[be.getPropName(t.name)])}))},o=0;o<e.length;o++)i(o);e.channels.forEach((function(e){if(!("precision"in e))throw new Error("Precision not found for channel with id: ".concat(e.id));var i=t.format.ChannelData.create({sensorChannelID:e.id}),o=n[e.id],a=Math.pow(10,e.precision),s=Math.round(o[0]*a);i.values.push(s);for(var u=1;u<o.length;u++){var c=Math.round(o[u]*a);i.values.push(c-s),s=c}r.dataChannels.push(i)}))})),r}},{key:"decodeSensorData",value:function(e,r){var n=new Ae(r);n.id=e.id,n.created=parseInt(w.fromValue(e.timestamp).toString()),n.inkState=Ae.InkState[t.format.InkState[e.state]];var i={};return e.dataChannels.forEach((function(t){var e=r.sensorContext.getContextByChannelID(t.sensorChannelID);if(!e)throw new Error("Not found corresponding channel context for data with channelID ".concat(t.sensorChannelID));var n=e.get(t.sensorChannelID),o=Math.pow(10,n.precision),a=t.values[0],s=[];s.push(a/o);for(var u=1;u<t.values.length;u++){var c=a+t.values[u];s.push(c/o),a=c}i[t.sensorChannelID]=s})),r.sensorContext.channelsContexts.forEach((function(t){for(var e=i[t.channels.first.id].length,r=new Ce(t.channels),o=function(e){t.channels.forEach((function(t){var n=i[t.id];r.data.push(n[e])}))},a=0;a<e;a++)o(a);n.add(r)})),n}},{key:"encodeInkData",value:function(e){var r=this,n=t.format.InkData.create({strokes:e.map((function(t){return r.encodeStroke(t)}))});return this.structure?n:t.encode(n)}},{key:"decodeInkData",value:function(e,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(e){var o=this.structure?e:t.format.InkData.decode(e),a={};return i.forEach((function(t){return a[t.id]=t})),o.strokes.map((function(t){return n.decodeStroke(t,r,a)}))}}},{key:"encodeStroke",value:function(e){for(var r=t.format.Stroke.create({id:e.id,startParameter:e.ts,endParameter:e.tf}),n=function(t){var n=e.pointAt(t);e.layout.forEach((function(t){switch(t){case he.Property.X:r.splineX.push(n.x);break;case he.Property.Y:r.splineY.push(n.y);break;case he.Property.Z:r.splineZ.push(n.z);break;case he.Property.RED:r.red.push(n.red/255);break;case he.Property.GREEN:r.green.push(n.green/255);break;case he.Property.BLUE:r.blue.push(n.blue/255);break;case he.Property.ALPHA:r.alpha.push(n.alpha);break;case he.Property.SIZE:r.size.push(n.size);break;case he.Property.ROTATION:r.rotation.push(n.rotation);break;case he.Property.SCALE_X:r.scaleX.push(n.scaleX);break;case he.Property.SCALE_Y:r.scaleY.push(n.scaleY);break;case he.Property.SCALE_Z:r.scaleZ.push(n.scaleZ);break;case he.Property.OFFSET_X:r.offsetX.push(n.offsetX);break;case he.Property.OFFSET_Y:r.offsetY.push(n.offsetY);break;case he.Property.OFFSET_Z:r.offsetZ.push(n.offsetZ);break;default:throw new Error("Invalid layout property provided: ".concat(t))}}))},i=0;i<e.length;i++)n(i);return e.sensorData&&(r.sensorDataID=e.sensorData.id,r.sensorDataOffset=e.sensorDataOffset,r.sensorDataMapping=e.sensorDataMapping),r.style=t.format.Style.create({brushURI:e.brush.name,renderModeURI:e.renderMode,particlesRandomSeed:e.randomSeed,properties:this.encodePathPointProperties(e.pointProps)}),r}},{key:"decodeStroke",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0==t.splineX.length||0==t.splineY.length)throw new Error("Incomplete path definition");var n=[he.Property.X,he.Property.Y];t.splineZ.length>0&&n.push(he.Property.Z),t.red&&t.red.length>0&&n.push(he.Property.RED),t.green&&t.green.length>0&&n.push(he.Property.GREEN),t.blue&&t.blue.length>0&&n.push(he.Property.BLUE),t.alpha&&t.alpha.length>0&&n.push(he.Property.ALPHA),t.size.length>0&&n.push(he.Property.SIZE),t.rotation.length>0&&n.push(he.Property.ROTATION),t.scaleX.length>0&&n.push(he.Property.SCALE_X),t.scaleY.length>0&&n.push(he.Property.SCALE_Y),t.scaleZ.length>0&&n.push(he.Property.SCALE_Z),t.offsetX.length>0&&n.push(he.Property.OFFSET_X),t.offsetY.length>0&&n.push(he.Property.OFFSET_Y),t.offsetZ.length>0&&n.push(he.Property.OFFSET_Z);for(var i=t.splineX.length,o=n.length,a="undefined"==typeof SharedArrayBuffer?new Float32Array(i*o):new Float32Array(new SharedArrayBuffer(i*o*Float32Array.BYTES_PER_ELEMENT)),s=function(e){n.forEach((function(r,n){var i;switch(r){case he.Property.X:i=t.splineX[e];break;case he.Property.Y:i=t.splineY[e];break;case he.Property.Z:i=t.splineZ[e];break;case he.Property.RED:i=Math.round(255*t.red[e]);break;case he.Property.GREEN:i=Math.round(255*t.green[e]);break;case he.Property.BLUE:i=Math.round(255*t.blue[e]);break;case he.Property.ALPHA:i=t.alpha[e];break;case he.Property.SIZE:i=t.size[e];break;case he.Property.ROTATION:i=t.rotation[e];break;case he.Property.SCALE_X:i=t.scaleX[e];break;case he.Property.SCALE_Y:i=t.scaleY[e];break;case he.Property.SCALE_Z:i=t.scaleZ[e];break;case he.Property.OFFSET_X:i=t.offsetX[e];break;case he.Property.OFFSET_Y:i=t.offsetY[e];break;case he.Property.OFFSET_Z:i=t.offsetZ[e];break;default:throw new Error("Invalid layout property provided: ".concat(r.name))}a[e*o+n]=i}))},u=0;u<i;u++)s(u);var c=e[t.style.brushURI]||t.style.brushURI,l=this.decodePathPointProperties(t.style.properties),h=r[t.sensorDataID],f=new ar(n,a,l,t.startParameter,t.endParameter);f.randomSeed=t.style.particlesRandomSeed;var d=new Tn(c,f,void 0,h);return d.id=t.id,d.renderMode=t.style.renderModeURI,d.sensorDataOffset=t.sensorDataOffset,d.sensorDataMapping=t.sensorDataMapping,d}},{key:"encodeBrushes",value:(n=a(i.mark((function e(r){var n,o,a,s,u,c;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.format.Brushes.create(),o=Ii(r),e.prev=2,o.s();case 4:if((a=o.n()).done){e.next=17;break}if(!((s=a.value)instanceof Ke)){e.next=11;break}u=this.encodeBrush2D(s),n.vectorBrushes.push(u),e.next=15;break;case 11:return e.next=13,this.encodeBrushGL(s);case 13:c=e.sent,n.rasterBrushes.push(c);case 15:e.next=4;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),o.e(e.t0);case 22:return e.prev=22,o.f(),e.finish(22);case 25:return e.abrupt("return",this.structure?n:t.encode(n));case 26:case"end":return e.stop()}}),e,this,[[2,19,22,25]])}))),function(t){return n.apply(this,arguments)})},{key:"decodeBrushes",value:function(e){var r=this;if(e){var n=this.structure?e:t.format.Brushes.decode(e),i={};return n.vectorBrushes.forEach((function(t){return i[t.name]=r.decodeBrush2D(t)})),n.rasterBrushes.forEach((function(t){return i[t.name]=r.decodeBrushGL(t)})),this.structure?i:Object.values(i)}}},{key:"encodeBrush2D",value:function(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");var r=t.format.VectorBrush.create({name:e.name,spacing:e.spacing});return(Array.isArray(e.shape)?e.shape:[e.shape]).forEach((function(e){var n=t.format.BrushPrototype.create({size:e.size});if(e.descriptor.shape.name)n.shapeURI=e.descriptor.shape.name;else for(var i=0;i<e.shape.length;i+=2)n.coordX.push(e.shape[i]),n.coordY.push(e.shape[i+1]);r.prototype.push(n)})),r}},{key:"decodeBrush2D",value:function(t){var e=[];return t.prototype.forEach((function(t){var r;if(t.shapeURI)r=t.shapeURI;else{r=new Float32Array(2*t.coordX.length);for(var n=0;n<r.length/2;n++)r[2*n]=t.coordX[n],r[2*n+1]=t.coordY[n]}e.push(new Ge(r,t.size))})),new Ke(t.name,e,t.spacing)}},{key:"encodeBrushGL",value:(r=a(i.mark((function e(r){var n,o,a,s;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.name){e.next=2;break}throw new Error("Encode BrushGL failed. name property is required.");case 2:if(n={shape:[],shapeURI:[],fill:void 0,filleURI:void 0},!Array.isArray(r.shape)){e.next=11;break}if(!((o=r.descriptor.shape.map((function(t){return t.name})).filter((function(t){return t}))).length>0)){e.next=9;break}if(o.length==r.shape.length){e.next=8;break}throw new Error("Brush ".concat(r.name," shape names length do not match with brush mipmap"));case 8:n.shapeURI=o;case 9:e.next=12;break;case 11:r.descriptor.shape.name&&n.shapeURI.push(r.descriptor.shape.name);case 12:if(n.fillURI=r.descriptor.fill.name,0!=n.shapeURI.length&&n.fillURI){e.next=23;break}return e.next=16,r.getShapeBinary();case 16:return e.t0=e.sent,e.next=19,r.getFillBinary();case 19:e.t1=e.sent,a={shape:e.t0,fill:e.t1},0==n.shapeURI.length&&(Array.isArray(r.shape)?n.shape=a.shape:n.shape.push(a.shape)),n.fillURI||(n.fill=a.fill);case 23:return s=r.blendMode.replace(/-/g,"_").toUpperCase(),e.abrupt("return",t.format.RasterBrush.create({name:r.name,spacing:r.spacing,scattering:r.scattering,blendMode:t.format.BlendMode[s],rotationMode:t.format.RotationMode[r.rotationMode.name],shapeTexture:n.shape,shapeTextureURI:n.shapeURI,fillTexture:n.fill,fillTextureURI:n.fillURI,fillWidth:r.fillTextureSize.width,fillHeight:r.fillTextureSize.height,randomizeFill:r.randomizeFill}));case 25:case"end":return e.stop()}}),e)}))),function(t){return r.apply(this,arguments)})},{key:"decodeBrushGL",value:function(e){var r,n;if(e.shapeTextureURI.length>0)r=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map((function(t){return{name:t}}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");r=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map((function(t){return{value:t}}))}if(e.fillTextureURI)n={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");n={value:e.fillTexture}}return new Sn(e.name,r,n,{spacing:e.spacing,scattering:e.scattering,blendMode:mn[t.format.BlendMode[e.blendMode]],rotationMode:Sn.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}},{key:"encodeView",value:function(e){return t.format.View.create({name:e.name,tree:this.encodeNodeTree(e)})}},{key:"decodeView",value:function(e,r,n){var i=e.tree.first;if(!r.views[e.name]||r.views[e.name].tree.id!=e.tree[0].id){var o=i.type==t.format.NodeType.STROKE_GROUP?wi.Type.STROKE:wi.Type.SENSOR_DATA,a=r.createView(e.name,o,i.name,n);this.decodeNodeTree(a,e.tree.slice(1))}}},{key:"encodeNodeTree",value:function(t){var e=[];return e.push(this.encodeNode(t.type,t.tree,0)),this.addChildren(e,t,t.tree.children,1),e}},{key:"addChildren",value:function(t,e,r,n){var i=this;r.forEach((function(r){var o=r instanceof Ei?(e.model||e).content.indexOf(r.content):void 0;t.push(i.encodeNode(e.type,r,n,o)),r instanceof mi&&i.addChildren(t,e,r.children,n+1)}))}},{key:"encodeNode",value:function(e,r,n,i){var o=e.name;return r instanceof mi&&(o+="_GROUP"),t.format.Node.create({id:r.id,type:t.format.NodeType[o],depth:n,index:i,groupBoundingBox:r.bounds,chunkFromIndex:r.fromPointIndex,chunkToIndex:r.toPointIndex})}},{key:"decodeNodeTree",value:function(e,r,n){var i=e.tree,o=0;n||(n=(e.type==wi.Type.STROKE?this.structure.inkData.strokes:this.structure.inputData.sensorData).map((function(t){return e.model.getItem(t.id)})));var a,s=Ii(r);try{for(s.s();!(a=s.n()).done;){for(var u=a.value;o>=u.depth;)i=i.parent,o--;if(u.type==t.format.NodeType.STROKE_GROUP||u.type==t.format.NodeType.SENSOR_DATA_GROUP)i=i.appendChild(e.createGroup(u.id)),u.groupBoundingBox&&(i.bounds=new Be(u.groupBoundingBox.x,u.groupBoundingBox.y,u.groupBoundingBox.width,u.groupBoundingBox.height));else{var c=void 0;(c=u.chunkToIndex>u.chunkFromIndex?e.createElement(n[u.index],u.chunkFromIndex,u.chunkToIndex):e.createElement(n[u.index])).id=u.id,i=i.appendChild(c)}o=u.depth}}catch(t){s.e(t)}finally{s.f()}}},{key:"encodeProperties",value:function(e){return Object.keys(e).map((function(r){return t.format.Property.create({name:r,value:e[r]})}))}},{key:"decodeProperties",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.forEach((function(t){return e[t.name]=t.value})),e}},{key:"encodeKnowledgeGraph",value:function(e){if(e){var r=t.format.TripleStore.create({statements:e.statements.map((function(e){return t.format.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object})}))});return this.structure?r:t.encode(r)}}},{key:"decodeKnowledgeGraph",value:function(e){if(e){var r=new li,n=this.structure?e:t.format.TripleStore.decode(e);return n&&n.statements.forEach((function(t){return r.addTriple(t.subject,t.predicate,t.object)})),r}}},{key:"encodeMat4",value:function(e){if(e)return t.format.Matrix4.create({m00:e.m11,m01:e.m12,m02:e.m13,m03:e.m14,m10:e.m21,m11:e.m22,m12:e.m23,m13:e.m24,m20:e.m31,m21:e.m32,m22:e.m33,m23:e.m34,m30:e.m41,m31:e.m42,m32:e.m43,m33:e.m44})}},{key:"decodeMat4",value:function(t){if(t)return ee.fromMatrix([t.m00,t.m01,t.m02,t.m03,t.m10,t.m11,t.m12,t.m13,t.m20,t.m21,t.m22,t.m23,t.m30,t.m31,t.m32,t.m33])}},{key:"encodeTool",value:(e=a(i.mark((function e(r){var n,o,a,s,u,c=arguments;return i.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=c.length>1&&void 0!==c[1]?c[1]:{},o=c.length>2&&void 0!==c[2]?c[2]:{},a=c.length>3&&void 0!==c[3]?c[3]:mn.SOURCE_OVER,e.t0=t.format.Tool,e.t1=r instanceof Ke?this.encodeBrush2D(r):void 0,!(r instanceof Sn)){e.next=11;break}return e.next=8,this.encodeBrushGL(r);case 8:e.t2=e.sent,e.next=12;break;case 11:e.t2=void 0;case 12:return e.t3=e.t2,e.t4=t.format.PathPointContext.create({statics:this.encodePathPointProperties(o),dynamics:this.encodePathPointSettings(n)}),e.t5={vectorBrush:e.t1,rasterBrush:e.t3,context:e.t4},s=e.t0.create.call(e.t0,e.t5),a!=mn.SOURCE_OVER&&(u=a.replace(/-/g,"_").toUpperCase(),s.blendMode=t.format.BlendMode[u]),e.abrupt("return",t.encode(s));case 18:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)})},{key:"decodeTool",value:function(e){if(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var r=t.format.Tool.decode(e);return{brush:"vectorBrush"==r.brush?this.decodeBrush2D(r.vectorBrush):this.decodeBrushGL(r.rasterBrush),blendMode:mn[t.format.BlendMode[r.blendMode]],statics:this.decodePathPointProperties(r.context.statics),dynamics:this.decodePathPointSettings(r.context.dynamics)}}}},{key:"encodePathPointProperties",value:function(e){var r=t.format.PathPointProperties.create();for(var n in t.format.PathPointProperties.fields){var i=e[n];isFinite(i)&&("red"!=n&&"green"!=n&&"blue"!=n||(i/=255),r[n]=t.format.Float32.create({value:i}))}return r}},{key:"decodePathPointProperties",value:function(e){if(e){var r={};for(var n in t.format.PathPointProperties.fields){var i=e[n];if(i){var o=i.value;"red"!=n&&"green"!=n&&"blue"!=n||(o=Math.round(255*o)),r[n]=o}}return r}}},{key:"encodePathPointSettings",value:function(e){var r=t.format.PathPointSettings.create();for(var n in t.format.PathPointSettings.fields)e[n]&&!e[n].disabled&&(r[n]=this.encodePropertySettings(n,e[n]));return r}},{key:"decodePathPointSettings",value:function(e){if(e){var r={};for(var n in t.format.PathPointSettings.fields)e[n]&&(r[n]=this.decodePropertySettings(e[n]));return r}}},{key:"encodePropertySettings",value:function(e,r){var n=this,i=function(r){if(r)return t.format.Range.create({min:r.min,max:r.max,remapURI:n.getActionDescriptorName(e,"Remap",r.remap)})};return t.format.PropertySettings.create({value:i(r.value),velocity:i(r.velocity),pressure:i(r.pressure),altitude:i(r.altitude),radiusX:i(r.radiusX),radiusY:i(r.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",r.resolve),dependencies:(r.dependencies||[]).map((function(e){return t.format.InputPropertyType[e.name]}))})}},{key:"getActionDescriptorName",value:function(t,e,r){if(r){if("function"==typeof r)throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."));if("string"==typeof r)return r;if(r.name)return r.name;throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."))}}},{key:"decodePropertySettings",value:function(e){var r={},n=function(t,e){e&&(r[t]={min:e.min,max:e.max,remap:e.remapURI})};return n("value",e.value),n("velocity",e.velocity),n("pressure",e.pressure),n("altitude",e.altitude),n("radiusX",e.radiusX),n("radiusY",e.radiusY),r.resolve=e.resolveURI,e.dependencies.length>0&&(r.dependencies=e.dependencies.map((function(e){return xe.Type[t.format.InputPropertyType[e]]}))),r}}],[{key:"encode",value:function(t){return t.constructor.encode(t).finish()}}]),t}(),Ci=r((function(t,e){t.exports=function(){function t(t,n,i,o,a){!function t(r,n,i,o,a){for(;o>i;){if(o-i>600){var s=o-i+1,u=n-i+1,c=Math.log(s),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(s-l)/s)*(u-s/2<0?-1:1);t(r,n,Math.max(i,Math.floor(n-u*l/s+h)),Math.min(o,Math.floor(n+(s-u)*l/s+h)),a)}var f=r[n],d=i,p=o;for(e(r,i,n),a(r[o],f)>0&&e(r,i,o);d<p;){for(e(r,d,p),d++,p--;a(r[d],f)<0;)d++;for(;a(r[p],f)>0;)p--}0===a(r[i],f)?e(r,i,p):e(r,++p,o),p<=n&&(i=p+1),n<=p&&(o=p-1)}}(t,n,i||0,o||t.length-1,a||r)}function e(t,e,r){var n=t[e];t[e]=t[r],t[r]=n}function r(t,e){return t<e?-1:t>e?1:0}var n=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function i(t,e,r){if(!r)return e.indexOf(t);for(var n=0;n<e.length;n++)if(r(t,e[n]))return n;return-1}function o(t,e){a(t,0,t.children.length,e,t)}function a(t,e,r,n,i){i||(i=p(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o=e;o<r;o++){var a=t.children[o];s(i,t.leaf?n(a):a)}return i}function s(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function u(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function l(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function h(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function d(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(e,r,n,i,o){for(var a=[r,n];a.length;)if(!((n=a.pop())-(r=a.pop())<=i)){var s=r+Math.ceil((n-r)/i/2)*i;t(e,s,r,n,o),a.push(r,s,s,n)}}return n.prototype.all=function(){return this._all(this.data,[])},n.prototype.search=function(t){var e=this.data,r=[];if(!d(t,e))return r;for(var n=this.toBBox,i=[];e;){for(var o=0;o<e.children.length;o++){var a=e.children[o],s=e.leaf?n(a):a;d(t,s)&&(e.leaf?r.push(a):f(t,s)?this._all(a,r):i.push(a))}e=i.pop()}return r},n.prototype.collides=function(t){var e=this.data;if(!d(t,e))return!1;for(var r=[];e;){for(var n=0;n<e.children.length;n++){var i=e.children[n],o=e.leaf?this.toBBox(i):i;if(d(t,o)){if(e.leaf||f(t,o))return!0;r.push(i)}}e=r.pop()}return!1},n.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var n=this.data;this.data=r,r=n}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},n.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},n.prototype.clear=function(){return this.data=p([]),this},n.prototype.remove=function(t,e){if(!t)return this;for(var r,n,o,a=this.data,s=this.toBBox(t),u=[],c=[];a||u.length;){if(a||(a=u.pop(),n=u[u.length-1],r=c.pop(),o=!0),a.leaf){var l=i(t,a.children,e);if(-1!==l)return a.children.splice(l,1),u.push(a),this._condense(u),this}o||a.leaf||!f(a,s)?n?(r++,a=n.children[r],o=!1):a=null:(u.push(a),c.push(r),r=0,n=a,a=a.children[0])}return this},n.prototype.toBBox=function(t){return t},n.prototype.compareMinX=function(t,e){return t.minX-e.minX},n.prototype.compareMinY=function(t,e){return t.minY-e.minY},n.prototype.toJSON=function(){return this.data},n.prototype.fromJSON=function(t){return this.data=t,this},n.prototype._all=function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},n.prototype._build=function(t,e,r,n){var i,a=r-e+1,s=this._maxEntries;if(a<=s)return o(i=p(t.slice(e,r+1)),this.toBBox),i;n||(n=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,n-1))),(i=p([])).leaf=!1,i.height=n;var u=Math.ceil(a/s),c=u*Math.ceil(Math.sqrt(s));y(t,e,r,c,this.compareMinX);for(var l=e;l<=r;l+=c){var h=Math.min(l+c-1,r);y(t,l,h,u,this.compareMinY);for(var f=l;f<=h;f+=u){var d=Math.min(f+u-1,h);i.children.push(this._build(t,f,d,n-1))}}return o(i,this.toBBox),i},n.prototype._chooseSubtree=function(t,e,r,n){for(;n.push(e),!e.leaf&&n.length-1!==r;){for(var i=1/0,o=1/0,a=void 0,s=0;s<e.children.length;s++){var u=e.children[s],c=l(u),h=(f=t,d=u,(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-c);h<o?(o=h,i=c<i?c:i,a=u):h===o&&c<i&&(i=c,a=u)}e=a||e.children[0]}var f,d;return e},n.prototype._insert=function(t,e,r){var n=r?t:this.toBBox(t),i=[],o=this._chooseSubtree(n,this.data,e,i);for(o.children.push(t),s(o,n);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(n,i,e)},n.prototype._split=function(t,e){var r=t[e],n=r.children.length,i=this._minEntries;this._chooseSplitAxis(r,i,n);var a=this._chooseSplitIndex(r,i,n),s=p(r.children.splice(a,r.children.length-a));s.height=r.height,s.leaf=r.leaf,o(r,this.toBBox),o(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},n.prototype._splitRoot=function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},n.prototype._chooseSplitIndex=function(t,e,r){for(var n,i,o,s,u,c,h,f=1/0,d=1/0,p=e;p<=r-e;p++){var y=a(t,0,p,this.toBBox),v=a(t,p,r,this.toBBox),g=(i=y,o=v,s=Math.max(i.minX,o.minX),u=Math.max(i.minY,o.minY),c=Math.min(i.maxX,o.maxX),h=Math.min(i.maxY,o.maxY),Math.max(0,c-s)*Math.max(0,h-u)),m=l(y)+l(v);g<f?(f=g,n=p,d=m<d?m:d):g===f&&m<d&&(d=m,n=p)}return n||r-e},n.prototype._chooseSplitAxis=function(t,e,r){var n=t.leaf?this.compareMinX:u,i=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,r,n)<this._allDistMargin(t,e,r,i)&&t.children.sort(n)},n.prototype._allDistMargin=function(t,e,r,n){t.children.sort(n);for(var i=this.toBBox,o=a(t,0,e,i),u=a(t,r-e,r,i),c=h(o)+h(u),l=e;l<r-e;l++){var f=t.children[l];s(o,t.leaf?i(f):f),c+=h(o)}for(var d=r-e-1;d>=e;d--){var p=t.children[d];s(u,t.leaf?i(p):p),c+=h(u)}return c},n.prototype._adjustParentBBoxes=function(t,e,r){for(var n=r;n>=0;n--)s(e[n],t)},n.prototype._condense=function(t){for(var e=t.length-1,r=void 0;e>=0;e--)0===t[e].children.length?e>0?(r=t[e-1].children).splice(r.indexOf(t[e]),1):this.clear():o(t[e],this.toBBox)},n}()})),Oi=new Ne(255,165,0),Mi=new Ne(255,255,0),Di=new Ne(64,224,208),Ni=new Ne(255,0,255),Li=new Ne(139,0,139),_i=new Ne(128,0,128),Bi=new Ne(255,192,203),Fi=new Ne(128,128,128),Ui=function(){function t(e){s(this,t),this.tree=e,this.attach()}return c(t,[{key:"attach",value:function(){var t=this;"loading"==document.readyState?addEventListener("DOMContentLoaded",(function(e){return t.attach()})):(this.canvas=document.getElementById("rbush"),this.ctx=this.canvas.getContext("2d"))}},{key:"refresh",value:function(e){var r=this,n=[];t.allocateSegments(n,this.tree.data,0),this.ctx.clearRect(0,0,this.canvas.width+1,this.canvas.height+1);for(var i=function(t){var e=n[t];e.hulls?e.hulls.forEach((function(t){return r.drawShape(t,e.color)})):r.drawRect(e.bounds,e.color)},o=n.length-1;o>=0;o--)i(o)}},{key:"drawRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fi.toRGBA(.3);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.strokeRect(t.left,t.top,t.width,t.height)}},{key:"fillRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fi.toRGBA(.3);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.fillRect(t.left,t.top,t.width,t.height)}},{key:"fillPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ne.BLACK;this.ctx.fillStyle="rgba(".concat(r.red,", ").concat(r.green,", ").concat(r.blue,", ").concat(r.alpha,")"),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}},{key:"drawShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Li.toRGBA(.5);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.stroke()}},{key:"fillShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oi.toRGBA(.6);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.fill()}},{key:"drawPath",value:function(t){var e=this;"number"==typeof t[0]&&(t=[t]),this.ctx.beginPath(),t.forEach((function(t){e.ctx.moveTo(t[0],t[1]);for(var r=2;r<t.length;r+=2)e.ctx.lineTo(t[r],t[r+1]);e.ctx.closePath()}))}},{key:"drawRange",value:function(t){var e=this;t.forEach((function(t){return e.drawRect(t.bounds,_i)}))}},{key:"drawIntersection",value:function(t,e){var r=this;this.drawShape(t,Bi),e.forEach((function(e){r.fillShape(e.shape,Mi);var n=Dr.intersection(e.shape,t);if(n){var i=n.toPath2D();r.fillShape(i,Ne.BLACK)}}))}},{key:"drawSelection",value:function(t,e,r){this.fillRect(t),this.fillShape(e,Li.toRGBA(.5)),this.fillShape(r)}}],[{key:"allocateSegments",value:function(e,r,n){if(r){if(r.bounds){var i=r;0==r.depth?i.color=Ne.RED:1==r.depth?i.color=Di:2==r.depth?i.color=Ne.BLUE:3==r.depth?i.color=Ni:4==r.depth&&(i.color=Ne.GREEN),e.push(i)}if(r.children)if(10!==n)for(var o=0;o<r.children.length;o++)t.allocateSegments(e,r.children[o],n+1);else console.warn("depth 10")}}},{key:"getInstance",value:function(e){return t.instance||(t.instance=new t(e)),t.instance}}]),t}();function ji(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Gi=function(t){d(r,t);var e=ji(r);function r(){var t;s(this,r);for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))).detachCanvas(),t}return c(r,[{key:"toBBox",value:function(t){return{minX:t.bounds.left,minY:t.bounds.top,maxX:t.bounds.right,maxY:t.bounds.bottom}}},{key:"compareMinX",value:function(t,e){return t.bounds.x-e.bounds.x}},{key:"compareMinY",value:function(t,e){return t.bounds.y-e.bounds.y}},{key:"search",value:function(t){return ce(v(r.prototype),"search",this).call(this,{minX:t.left,minY:t.top,maxX:t.right,maxY:t.bottom})}},{key:"find",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.data,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(e){if(e.stroke){var i=!0;Object.keys(t).forEach((function(r){i=i&&e[r]==t[r]})),i&&n.push(e)}if(e.children){if(6!==r){for(var o=0;o<e.children.length;o++)this.find(t,e.children[o]||null,r+1,n);return n}console.warn("depth 6")}}}},{key:"attachCanvas",value:function(){this.canvas=Ui.getInstance(this)}},{key:"detachCanvas",value:function(){var t=this;this.canvas={},Object.getOwnPropertyNames(Ui.prototype).filter((function(t){return!["constructor","attach"].includes(t)})).forEach((function(e){t.canvas[e]=function(){}}))}}]),r}(Ci);function Yi(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return zi(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return zi(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function zi(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var Xi=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Mode.WHOLE_STROKE;s(this,t),this.mode=e,this.segmentInterpolator=new Mr(1,!1,!0),this.convexHullChainProducer=new nn,this.holesBuilder=new Nr}return c(t,[{key:"updateSegmentation",value:function(e){if(!this.context)throw new Error("Required spatial context not found");var r,n=[],i=!1,o=Yi(e);try{for(o.s();!(r=o.n()).done;){var a=r.value;if(0!=a.length){var s=Be.ofPolygon(a),u=this.context.search(s);if(u.length>0){var c,l,h=[],f=Yi(u);try{for(f.s();!(l=f.n()).done;){var d=l.value;if(0==d.depth){var p=this.context.getStroke(d.strokeID),y=this.buildStrokeSegments(p);this.context.updateTree(d,y),h=h.concat(y),i=!0}else if(1==d.depth){for(var v=[],g=this.segmentInterpolator.split(d.spline),m=this.context.getBrushApplier(d.strokeID).get(g),b=0;b<g.length-1;b++){var E=[m[b],m[b+1]];v.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:b,bounds:Be.ofPolygons(E),point:g.getPoint(b),spline:new ar(d.spline.layout,d.spline.points,d.spline.pointProps,g.getPointT(b),g.getPointT(b+1)),shapesPath:E,depth:2})}this.context.updateTree(d,v),h=h.concat(v),i=!0}else if(2==d.depth){this.convexHullChainProducer.reset();var x=this.convexHullChainProducer.get(d.shapesPath);d.depth=3,d.hulls=x,this.context.tree.canvas.refresh(),i=!0}else if(3==d.depth){if(Dr.intersection(d.hulls,a))if(this.mode==t.Mode.PARTIAL_STROKE){for(var P=[],w=this.segmentInterpolator.get(d.spline),k=this.context.getBrushApplier(d.strokeID).get(w),R=0;R<w.length;R++){var S=Be.ofPolygon(k[R]),I=S,T=d.spline,A=w.getPointT(R),C=w.getPointT(R-1),O=w.getPointT(R+1);if(isNaN(C)&&(C=d.spline.ts),isNaN(O)&&(O=d.spline.tf),S.width!=S.height){var M=Math.max(S.width,S.height);S=new Be(S.center.x-M/2,S.center.y-M/2,M,M)}P.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:d.splineIndex,pointIndex:R,bounds:S,point:w.getPoint(R),spline:T,prevT:C,t:A,nextT:O,shape:k[R],shapeBounds:I,depth:4})}this.context.updateTree(d,P),h=h.concat(P),i=!0}else n.push(d)}else Be.intersect(s,d.bounds)&&(d.affected=!0),n.push(d)}}catch(t){f.e(t)}finally{f.f()}if(h.length>0&&this.context.load(h),i)return this.updateSegmentation(e);(c=this.nodes).push.apply(c,n)}}}}catch(t){o.e(t)}finally{o.f()}}},{key:"buildStrokeSegments",value:function(e){for(var r=[],n=this.context.getBrushApplier(e.id),i=0;i<e.segmentsCount;i++){var o=t.buildStrokeSegment(e,i,n);r.push(o)}return r}},{key:"createIntervals",value:function(t,e){var r=this,n={intersected:{},selected:[]};if(0==e.length)return n;var i=this.holesBuilder.build(this.context,t,e),o=function(t){var e=r.context.getNodes(t),o=[],a=[];n.intersected[t]={intervals:o,holes:a},i[t].forEach((function(r,s){var u,c=0==r.fromIndex&&r.fromTValue==e.first.ts,l=r.toIndex==e.last.segmentIndex&&r.toTValue==e.last.tf;if(c&&l)return n.selected.push(t),void delete n.intersected[t];a.push(r),c?u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}:l?(o.last||o.push({fromIndex:0,fromTValue:e.first.spline.ts,fromNodeIndex:0}),o.last.toIndex=r.fromIndex+3,o.last.toTValue=r.fromTValue,o.last.toNodeIndex=r.fromNodeIndex):o.last?(o.last.toIndex=r.fromIndex+3,o.last.toTValue=r.fromTValue,o.last.toNodeIndex=r.fromNodeIndex,u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}):(o.push({fromIndex:0,fromTValue:e.first.spline.ts,toIndex:r.fromIndex+3,toTValue:r.fromTValue,fromNodeIndex:0,toNodeIndex:r.fromNodeIndex}),u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}),u&&o.push(u),s!=i[t].length-1||l||(o.last.toIndex=e.last.segmentIndex+3,o.last.toTValue=e.last.spline.tf,o.last.toNodeIndex=e.length-1);var h=[];o.forEach((function(t){if(1==t.fromTValue){var r=e.filter((function(e){return e.segmentIndex==t.fromIndex+1})).first,n=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push({fromNodeIndex:n.first.nodeIndex||e.indexOf(n.first),toNodeIndex:n.last.nodeIndex||e.indexOf(n.last),type:"OVERLAPPING_INC"}),t.fromIndex++,t.fromTValue=0,t.fromNodeIndex=e.indexOf(r)}if(0==t.toTValue){var i=t.toIndex-3,o=e.filter((function(t){return t.segmentIndex==i-1})).last,s=e.filter((function(t){return t.segmentIndex==i}));a.push({fromNodeIndex:s.first.nodeIndex||e.indexOf(s.first),toNodeIndex:s.last.nodeIndex||e.indexOf(s.last),type:"OVERLAPPING_DEC"}),t.toIndex--,t.toTValue=1,t.toNodeIndex=e.indexOf(o)}if(t.toIndex-t.fromIndex<3)h.push(t);else if(t.toIndex-t.fromIndex==3&&t.fromTValue==t.toTValue){var u=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push({fromNodeIndex:u.first.nodeIndex||e.indexOf(u.first),toNodeIndex:u.last.nodeIndex||e.indexOf(u.last),type:"INVALID"}),h.push(t)}})),h.forEach((function(t){return o.remove(t)}))}))};for(var a in i)o(a);return n}},{key:"reset",value:function(t){if(!t)throw new Error("Required spatial context not found");this.context=t,this.nodes=[]}}],[{key:"buildStrokeNode",value:function(t){return{strokeID:t.id,bounds:t.bounds,point:t.getPoint(0),depth:0}}},{key:"buildStrokeSegment",value:function(t,e,r){if(e<0||e>=t.segmentsCount)throw new Error("Invalid index ".concat(e," found. Ensure that index range is {0, ").concat(t.segmentsCount-1,"}."));var n=.166666666666,i=t.getSegment(e),o=i.getPoint(0),a=i.getPoint(1),s=i.getPoint(2),u=i.getPoint(3),c=-n*o.x+a.x+n*s.x,l=-n*o.y+a.y+n*s.y,h=+n*a.x+s.x-n*u.x,f=+n*a.y+s.y-n*u.y,d=a.toArray(t.layout).concat(s.toArray(t.layout)),p=new cr(t.layout,d,t.pointProps),y=r.get(p),v=Be.ofPolygon(y.first),g=Be.ofPolygon(y.last),m=Math.max(v.width,g.height),b=Math.max(v.height,g.height),E=Math.max(m,b),x=new Be(c-E/2,l-b/2,E,E),P=new Be(h-E/2,f-b/2,E,E),w=v.union(g).union(x).union(P);return{strokeID:t.id,segmentIndex:e,bounds:w,point:i.getPoint(0),spline:i,shapesPath:y,depth:1}}}]),t}();Xi.createEnum("Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);var Vi=function(){function t(){s(this,t),this.tree=new Gi,this.strokes={},this.brushAppliers={},this.nodes={}}return c(t,[{key:"add",value:function(t){t.brush instanceof Sn||(this.strokes[t.id]=t,this.loadStrokeNode(t))}},{key:"getStroke",value:function(t){return this.strokes[t]}},{key:"getBrushApplier",value:function(t){var e=this.strokes[t].brush;return this.brushAppliers[e.name]||(this.brushAppliers[e.name]=new en(e)),this.brushAppliers[e.name]}},{key:"getNodes",value:function(t){return this.nodes[t]}},{key:"loadStrokeNode",value:function(t){var e=Xi.buildStrokeNode(t);this.nodes[t.id]=[e],this.load(e)}},{key:"reload",value:function(t){this.unload(this.nodes[t.id]),this.loadStrokeNode(t)}},{key:"remove",value:function(t){var e="string"==typeof t?t:t.id;this.unload(this.nodes[e]),delete this.nodes[e],delete this.strokes[e]}},{key:"update",value:function(t,e){var r=this,n={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(t).forEach((function(i){var o=r.strokes[i],a=r.split(o,t[i]);a&&(n.intersected.push({stroke:o,strokes:a}),e||(n.dirtyArea=o.bounds.union(n.dirtyArea)),t[i].intervals.forEach((function(t,e){t.inside&&n.selected.push(a[e])})))})),n}},{key:"split",value:function(t,e){var r=this,n=e.intervals,i=e.holes;if(0==n.length)return[];var o=t.split(n);if(o){o.forEach((function(t){r.strokes[t.id]=t}));var a=[],s=[];return n.map((function(e){return r.nodes[t.id].slice(e.fromNodeIndex,e.toNodeIndex+1)})).forEach((function(e,i){var u,c,l=o[i],h=r.getBrushApplier(l.id),f=n[i].fromIndex,d=n[i].toIndex-3;if(l.ts!=e.first.spline.ts){var p=e.first.segmentIndex,y=r.nodes[t.id].filter((function(t){return t.segmentIndex==p}));e=e.filter((function(t){return t.segmentIndex!=p})),p>=f&&(u=Xi.buildStrokeSegment(l,p-f,h),a.push(u)),s.push.apply(s,L(y))}if(e.length>0&&l.tf!=e.last.spline.tf){var v=e.last.segmentIndex,g=r.nodes[t.id].filter((function(t){return t.segmentIndex==v}));e=e.filter((function(t){return t.segmentIndex!=v})),v<=d&&(c=Xi.buildStrokeSegment(l,v-f,h),a.push(c)),s.push.apply(s,L(g))}e.forEach((function(t){t.strokeID=l.id,t.segmentIndex-=f})),u&&e.unshift(u),c&&e.push(c),r.nodes[l.id]=e})),i.forEach((function(e){return s.push.apply(s,L(r.nodes[t.id].slice(e.fromNodeIndex,e.toNodeIndex+1)))})),this.unload(s),this.load(a),delete this.nodes[t.id],delete this.strokes[t.id],o}}},{key:"replace",value:function(t,e){var r=this;e.forEach((function(t){return r.add(t)})),this.remove(t)}},{key:"load",value:function(t){Array.isArray(t)||(t=[t]),0!=t.length&&(this.tree.load(t),this.tree.canvas.refresh())}},{key:"updateTree",value:function(t,e){this.tree.remove(t),this.nodes[t.strokeID].replace(t,e)}},{key:"unload",value:function(t){var e=this;Array.isArray(t)||(t=[t]),t.forEach((function(t){return e.tree.remove(t)})),this.tree.canvas.refresh()}},{key:"search",value:function(t){return this.tree.search(t)}},{key:"reset",value:function(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas.refresh()}}]),t}();function Hi(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var qi=function(t){d(r,t);var e=Hi(r);function r(t){return s(this,r),e.call(this,t)}return c(r,[{key:"intersect",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(t),this.mode==r.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,t):{intersected:{},selected:this.nodes.map((function(t){return t.strokeID})).unique()}}},{key:"intersectSegmentation",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,t)}}]),r}(Xi);function Zi(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=v(t);if(e){var i=v(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return y(this,r)}}var Wi=function(t){d(r,t);var e=Zi(r);function r(t){return s(this,r),e.call(this,t)}return c(r,[{key:"select",value:function(t){var e=this;if(!this.context)throw new Error("Required spatial context not found");var n={intersected:{},selected:[]},i=t.bounds,o=Dr.createClipperPath(t.spline);setTimeout((function(){return e.context.tree.canvas.drawSelection(i,t.points,t.path.first)}),1e3);var a=this.context.search(i),s=this.nodes.map((function(t){return t.strokeID})).unique(),u=a.map((function(t){return t.strokeID})).unique().filter((function(t){return!s.includes(t)}));if(this.mode==r.Mode.PARTIAL_STROKE){var c=t.spline.getPoint(0).toArray(t.layout),l=t.spline.getPoint(t.spline.length-1).toArray(t.layout),h=[].concat(L(c),L(c),L(l),L(l)),f=new Tn(t.brush,new ar(t.layout,h,t.pointProps));this.updateSegmentation(f.path);var d=this.createIntervals(this.nodes,t.path);n=d,s.forEach((function(t){var r=[];d.intersected[t]&&(r=d.intersected[t].intervals),r.forEach((function(r){var n=e.context.getNodes(t)[r.fromNodeIndex];r.inside=Dr.containsPoint(o,n.point)}))}))}else n.selected=s;return u.forEach((function(t){var r=e.context.getNodes(t)[0];Dr.containsPoint(o,r.point)&&n.selected.push(t)})),Object.defineProperty(n,"length",{get:function(){return Object.keys(n.intersected).length+n.selected.length},enumerable:!0}),n}}]),r}(Xi);t.BlendMode=mn,t.Brush2D=Ke,t.BrushApplier=en,t.BrushGL=Sn,t.BrushPrototype=Ge,t.Color=Ne,t.ConvexHullChainProducer=nn,t.ConvexHullProducer=Gr,t.CurvatureBasedInterpolator=$r,t.DistanceBasedInterpolator=Mr,t.Environment=ye,t.InkBuilder=hn,t.InkBuilderAsync=vn,t.InkCanvas2D=Bn,t.InkCanvasGL=si,t.InkCodec=Ai,t.InkController=l,t.InkInputProvider=A,t.InkModel=wi,t.InkPath2D=Ur,t.InputContext=Ie,t.InputDevice=Me,t.InputListener=se,t.InterpolatedSpline=cr,t.Intersector=qi,t.Matrix=ee,t.OffscreenCanvasGL=Yn,t.PathPoint=he,t.PathPointContext=Je,t.PathProducer=zr,t.PathSegment=Br,t.Point=Zt,t.PointerData=_r,t.Poly=Dr,t.PolygonMerger=an,t.PolygonSimplifier=un,t.Rect=Be,t.Scalar=ge,t.Selector=Wi,t.SemanticTriple=ci,t.SensorChannel=xe,t.SensorChannelsContext=we,t.SensorContext=Re,t.SensorData=Ae,t.SensorStream=Ce,t.ShapeFactory=De,t.Smoother=Hr,t.SpatialContext=Vi,t.Spline=ar,t.SplineProducer=Zr,t.Stroke=Tn,t.StrokeRenderer2D=Fn,t.StrokeRendererGL=ui,t.TextTable=re,t.TripleStore=li,t.TypedArrayCodec=Ue,t.URIResolver=Fe,t.fsx=qe,t.math=Lr,t.utils=be,t.uuid=k,t.version="1.2.0",Object.defineProperty(t,"__esModule",{value:!0})}));
