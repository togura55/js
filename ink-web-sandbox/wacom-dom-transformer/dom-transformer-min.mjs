if("undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:"undefined"!=typeof global&&(global.globalThis=global)),String.prototype.contains||(String.prototype.contains=function(t){return-1!=this.indexOf(t)}),String.prototype.startsWith||(String.prototype.startsWith=function(t){return this.length>=t.length&&this.substring(0,t.length)==t}),String.prototype.endsWith||(String.prototype.endsWith=function(t){return this.length>=t.length&&this.substring(this.length-t.length,this.length)==t}),String.prototype.charsCode=function(){return this.split("").reduce((function(t,e){return t+e.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(t){return-1!=this.toUpperCase().indexOf(t.toUpperCase())},String.prototype.toCharArray=function(t){let e=t?new Uint8Array(this.length):new Array(this.length);for(let t=0;t<this.length;t++){let i=this.charCodeAt(t);i>255&&(e.bytes=!1),e[t]=i}return e},String.fromCharArray=function(t){let e="";try{e=String.fromCharCode.apply(null,t)}catch(i){for(let i=0;i<t.length;i++)e+=String.fromCharCode(t[i])}return e},String.prototype.pad=function(t,e){return this.length<t?new Array(t-this.length+1).join(e||"-")+this:this.toString()},Number.prototype.pad=function(t){return String(this).length<t?new Array(t-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){let t=new Float32Array(1);return t[0]=this,t[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(t){return this.indexOf(t)>-1},Array.prototype.clone=function(){return this.map(t=>Object.clone(t))},Array.prototype.unique=function(){return this.filter((t,e)=>this.indexOf(t)==e)},Array.prototype.add=function(t){if(!this.contains(t))return this.push(t)},Array.prototype.insert=function(t,e){this.splice(t,0,e)},Array.prototype.remove=function(t){return this.removeAt(this.indexOf(t))},Array.prototype.removeAt=function(t){return t>-1&&this.splice(t,1),this},Array.prototype.replace=function(t,e,i){let n=this.indexOf(t);if(n>-1)if(!i&&e instanceof Array){let t=[n,1];for(let i=0;i<e.length;i++)t.push(e[i]);this.splice.apply(this,t)}else this.splice(n,1,e);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach(t=>{let e=globalThis[t+"Array"];e?(e.from?Array.prototype["to"+t+"Array"]=function(){return e.from(this)}:Array.prototype["to"+t+"Array"]=function(){return new e(this)},Array.from?e.prototype.toArray=function(){return Array.from(this)}:e.prototype.toArray=function(){return Array.prototype.slice.call(this)},e.prototype.clone=function(){return new e(this,this.byteOffset,this.length)},e.prototype.concat=function(...t){let e=this.length,i=this.length;t.forEach(t=>{if(this.constructor!=t.constructor)throw new Error(`Concat array from wrong type detected - expected ${this.constructor.name}, found ${t.constructor.name}`);e+=t.length});let n=new this.constructor(e);return n.set(this),t.forEach(t=>{n.set(t,i),i+=t.length}),n}):console.warn(t+"Array not found")})},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(t,e){e||(e=function(){});let i=e.getArguments(),n=new Function("body","return function "+t+"("+i+") {return body.apply(this, arguments);};")(e);return n.toString=function(){return e.toString()},n.toSource=function(){return e.toSource()},n},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){let t=this.toString().match(/^function\s([\w$]+)/);return t?t[1]:""}}),Function.prototype.getArguments=function(){let t=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==t.length?[]:t.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(t){let e=arguments.callee.caller.arguments;this.getArguments().forEach((function(t,i){this[t]=e[i]}),t)},Function.prototype.createEnum=function(t,e){if(this[t])throw new Error("Already exists key: "+t);this[t]=new Object;let i=[];for(let n=0;n<e.length;n++){let r=t+"_"+e[n],s=this[t];s[e[n]]=function(){let i=Object.create(Object.prototype,{constructor:{value:Function.create(r)},type:{value:t},name:{value:e[n]},value:{value:n}});return Object.defineProperty(s,n,{get:function(){return i}}),i}(),i.push(s[e[n]])}Object.defineProperty(this[t],"values",{value:i})},Object.equals=function(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;if(t instanceof Array||ArrayBuffer.isTypedArray(t))return t.length==e.length&&t.every((t,i)=>Object.equals(t,e[i]));for(let i in t)if(t.hasOwnProperty(i)){if(!e.hasOwnProperty(i))return!1;if(t[i]!==e[i]){if("object"!=typeof t[i])return!1;if(!Object.equals(t[i],e[i]))return!1}}for(let i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},Object.clone=function(t,e){let i=new Array;return function t(n){if(null===n)return null;if("object"!=typeof n||n.mutable)return n;if("function"==typeof n.clone)return n.clone();for(let t=0;t<i.length;t++)if(i[t][0]===n)return i[t][1];let r=Object.create(Object.getPrototypeOf(n));i.push([n,r]);for(let i in n)e&&"function"==typeof n[i]||n.hasOwnProperty(i)&&(r[i]=t(n[i]));return r}(t)},Object.toSource=function(t,e){if(t&&"object"==typeof t){let i=[];for(let e in t)t.hasOwnProperty(e)&&i.push(`${e}: ${Object.toSource(t[e])}`);return(e?e+" = ":"")+"{"+i.join(", ")+"};"}if("function"==typeof t){let e=t.toString();return 0!=e.indexOf("function")&&(e="function "+e),e}return t},Object.nameAnonymousFunctions=function(t,e){for(let i in t)"function"!=typeof t[i]||t[i].name||("constructor"==i&&e?Object.defineProperty(t[i],"name",{value:e}):Object.defineProperty(t[i],"name",{value:i}))},JSON.toBase64=function(t){return btoa(JSON.stringify(t))},JSON.fromBase64=function(t){return JSON.parse(atob(t))},JSON.encode=function(t){return JSON.toBase64(t).toCharArray(!0)},JSON.decode=function(t){let e=String.fromCharArray(t);return JSON.fromBase64(e)},Math.toDegrees=function(t){return t*(180/this.PI)},Math.toRadians=function(t){return t*(this.PI/180)},Math.randomInt=function(t,e){return Math.floor(this.random()*(e-t+1))+t},"object"==typeof window){if(HTMLElement.prototype.getInlineStyle=function(t){return this.style[t]||this.style["-webkit-"+t]||this.style["-khtml-"+t]||this.style["-moz-"+t]||this.style["-ms-"+t]||this.style["-o-"+t]||""},HTMLElement.prototype.setStyle=function(t,e){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(i){this.style[i+"-"+t]=e}),this),this.style[t]=e},HTMLElement.prototype.getStyle=function(t){let e=t,i=t.startsWith("-");i&&(e=t.substring(1));let n=e.split("-");for(let t=n.length-1;t>0;t--)n[t]=n[t].substring(0,1).toUpperCase()+n[t].substring(1);e=n.join("");let r=this.style.display,s=this.style.visibility;"none"==r&&(this.style.visibility="hidden",this.style.display="");let o=window.getComputedStyle(this)[e];if(!i&&void 0===o){let e=["-webkit","-khtml","-moz","-ms","-o"];for(let i=0;i<e.length&&(o=this.getStyle(e[i]+"-"+t),"undefined"==o);i++);}return"none"==r&&(this.style.visibility=s,this.style.display="none"),o},HTMLElement.prototype.getMathStyle=function(t,e){let i=e?this.getInlineStyle(t):this.getStyle(t);return"auto"==i&&(i=0),parseFloat(i)},HTMLElement.prototype.getTransformStyle=function(){let t={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},e=this.getStyle("transform");if("none"!=e){let i=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),n=parseFloat(i[0]),r=parseFloat(i[1]),s=parseFloat(i[2]),o=parseFloat(i[3]),a=parseFloat(i[4]),h=parseFloat(i[5]);t.scale={x:Math.sqrt(n*n+s*s),y:Math.sqrt(o*o+r*r)},t.skew={angleX:Math.tan(s),angleY:Math.tan(r)},t.rotate={angle:Math.atan2(r,n)},t.translate={x:a,y:h},t.matrix={a:n,b:r,c:s,d:o,tx:a,ty:h}}return t},HTMLElement.prototype.toRect=function(){let t=this.style.display,e=this.style.visibility;"none"==t&&(this.style.visibility="hidden",this.style.display="");let i=this.offsetWidth+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),n=this.offsetHeight+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom"),r=new DOMRect(this.offsetLeft,this.offsetTop,this.offsetWidth,this.offsetHeight);return r.outerSize=new DOMSize(i,n),"none"==t&&(this.style.visibility=e,this.style.display="none"),r},HTMLImageElement.prototype.toDataURL=function(t){let e=document.createElement("canvas");return e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0),e.toDataURL(t||"image/png")},HTMLImageElement.prototype.toBlob=function(t){return new Blob([this.getBytes(t).buffer],{type:t||"image/png"})},HTMLImageElement.prototype.getBytes=function(t){let e=this.toDataURL(t).split(",")[1];return atob(e).toCharArray(!0)},Image.fromBytes=function(t,e,i){let n=new Image;return n.onload=function(){URL.revokeObjectURL(this.src),e&&e.call(this)},n.src=URL.createObjectURL(new Blob([t.buffer||t],{type:"image/"+(i||"png")})),n},CanvasRenderingContext2D.prototype.clearCanvas=function(t){this.clearRect(0,0,this.canvas.width,this.canvas.height),t&&(this.fillStyle=t,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(t,e){let i=document.createElement("canvas");return i.width=t,i.height=e,i},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}let t=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio),t%10!=0&&(t%10>5?t+=10-t%10:t-=t%10)),t},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}let t=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio),t%10!=0&&(t%10>5?t+=10-t%10:t-=t%10)),t},configurable:!0}),"undefined"==typeof PointerEvent){class t extends Event{}window.PointerEvent=t}if("undefined"==typeof TouchEvent){class t extends Event{}window.TouchEvent=t}}window.DOMSize=function(t,e){this.width=t,this.height=e},DOMSize.prototype.toJSON=function(){return{width:this.width,height:this.height}},DOMPoint.prototype.transform=function(t){return t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t)),this.matrixTransform(t)},DOMPoint.prototype.toString=function(){return`point(${this.x}, ${this.y}, ${this.z})`},Object.defineProperty(DOMRect.prototype,"size",{get:function(){return new DOMSize(this.width,this.height)},enumerable:!0}),Object.defineProperty(DOMRect.prototype,"center",{get:function(){return new DOMPoint((this.left+this.right)/2,(this.top+this.bottom)/2)},enumerable:!0}),DOMRect.prototype.union=function(t){return t?DOMRect.ofEdges(Math.min(this.left,t.left),Math.min(this.top,t.top),Math.max(this.right,t.right),Math.max(this.bottom,t.bottom)):this},DOMRect.prototype.intersect=function(t){if(!t)return;let e=DOMRect.ofEdges(Math.max(this.left,t.left),Math.max(this.top,t.top),Math.min(this.right,t.right),Math.min(this.bottom,t.bottom));return e.width>0&&e.height>0?e:void 0},DOMRect.prototype.ceil=function(t){let e=Math.floor(this.left),i=Math.floor(this.top),n=Math.ceil(this.right),r=Math.ceil(this.bottom);if(t){let t=this.width,s=this.height;t+=t%2,s+=s%2,n=e+t,r=i+s}return DOMRect.ofEdges(e,i,n,r)},DOMRect.prototype.floor=function(t){let e=Math.ceil(this.left),i=Math.ceil(this.top),n=Math.floor(this.right),r=Math.floor(this.bottom);if(t){let t=this.width,s=this.height;t-=t%2,s-=s%2,n=e+t,r=i+s}return DOMRect.ofEdges(e,i,n,r)},DOMRect.prototype.contains=function(t){return this.left<=t.x&&this.right>=t.x&&this.top<=t.y&&this.bottom>=t.y},DOMRect.prototype.transform=function(t){t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t));let e=DOMPoint.fromPoint({x:this.left,y:this.top}).transform(t),i=DOMPoint.fromPoint({x:this.right,y:this.top}).transform(t),n=DOMPoint.fromPoint({x:this.left,y:this.bottom}).transform(t),r=DOMPoint.fromPoint({x:this.right,y:this.bottom}).transform(t),s=Math.min(e.x,i.x,n.x,r.x),o=Math.min(e.y,i.y,n.y,r.y),a=Math.max(e.x,i.x,n.x,r.x),h=Math.max(e.y,i.y,n.y,r.y);return DOMRect.ofEdges(s,o,a,h)},DOMRect.prototype.matrixTransform=DOMRect.prototype.transform,DOMRect.prototype.toPath=function(){let t=[];return t.push(this.left,this.top),t.push(this.right,this.top),t.push(this.right,this.bottom),t.push(this.left,this.bottom),t.push(this.left,this.top),t.toFloat32Array()},DOMRect.prototype.toString=function(){return`rect(${this.x}, ${this.y}, ${this.width}, ${this.height})`},DOMRect.ofEdges=(t,e,i,n)=>new DOMRect(t,e,i-t,n-e),Object.defineProperty(DOMMatrix.prototype,"tx",{get:function(){return this.e},enumerable:!0}),Object.defineProperty(DOMMatrix.prototype,"dx",{get:function(){return this.e},enumerable:!0}),Object.defineProperty(DOMMatrix.prototype,"ty",{get:function(){return this.f},enumerable:!0}),Object.defineProperty(DOMMatrix.prototype,"dy",{get:function(){return this.f},enumerable:!0}),Object.defineProperty(DOMMatrix.prototype,"multiplicationType",{value:"POST",enumerable:!0,writable:!0}),Object.defineProperty(DOMMatrix,"MultiplicationType",{value:{PRE:"PRE",POST:"POST"},enumerable:!0}),DOMMatrix.nativeFromMatrix=DOMMatrix.fromMatrix,DOMMatrix.prototype.invert=DOMMatrix.prototype.inverse,DOMMatrix.prototype.postMultiply=DOMMatrix.prototype.multiply,DOMMatrix.prototype.postMultiplySelf=DOMMatrix.prototype.multiplySelf,DOMMatrix.prototype.preMultiply=function(t){return t.postMultiply(this)},DOMMatrix.prototype.multiply=function(t){if(t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t)),this.multiplicationType==DOMMatrix.MultiplicationType.POST)return this.postMultiply(t);{let e=this.preMultiply(t);return e.multiplicationType=DOMMatrix.MultiplicationType.PRE,e}},DOMMatrix.prototype.multiplySelf=function(t){t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t)),this.multiplicationType==DOMMatrix.MultiplicationType.POST?this.postMultiplySelf(t):this.preMultiplySelf(t)},DOMMatrix.prototype.transformPoint=function(t){return DOMPoint.fromPoint(t).matrixTransform(this)},DOMMatrix.prototype.disassemble=function(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this}},DOMMatrix.fromMatrix=(t,e)=>{let i;return"string"==typeof t?i=new DOMMatrix(t):("e"in t||(t.e=t.tx||t.dx),"f"in t||(t.f=t.ty||t.dy),i=DOMMatrix.nativeFromMatrix(t)),i.multiplicationType=e||t.multiplicationType||DOMMatrix.MultiplicationType.POST,i},DOMMatrix.fromTranslate=t=>{let e=isFinite(t)?{tx:t,ty:t}:{tx:t.x,ty:t.y};return DOMMatrix.fromMatrix(e)},DOMMatrix.fromRotate=(t,e)=>{let i=Math.sin(t),n=Math.cos(t),r={a:n,b:i,c:-i,d:n};return e&&(r.tx=e.x-e.x*n+e.y*i,r.ty=e.y-e.x*i-e.y*n),DOMMatrix.fromMatrix(r)},DOMMatrix.fromScale=(t,e)=>{isFinite(t)&&(t={x:t,y:t});let i={a:t.x,d:t.y};return e&&(i.tx=e.x-e.x*t.x,i.ty=e.y-e.y*t.y),DOMMatrix.fromMatrix(i)};class t{constructor(t,e){this.type=t,this.element=e}reset(t,e){throw new Error(this.type+": reset should be implemented")}update(t){throw new Error(this.type+": update should be implemented")}}class e extends t{constructor(t){super("translate",t)}reset(t,e){this.lastPoint={x:t.clientX,y:t.clientY}}update(t){let e={x:t.clientX-this.lastPoint.x,y:t.clientY-this.lastPoint.y};return this.lastPoint={x:t.clientX,y:t.clientY},e}}function i(t,e){let i,n={};return Object.defineProperty(n,"x",{value:e.x-t.x,enumerable:!0}),Object.defineProperty(n,"y",{value:e.y-t.y,enumerable:!0}),Object.defineProperty(n,"length",{get:()=>(isNaN(i)&&(i=Math.sqrt(n.x*n.x+n.y*n.y)),i),enumerable:!0}),n}function n(t,e){let i=t.x*e.x+t.y*e.y,n=t.x*e.y-t.y*e.x;return Math.atan2(n,i)}class r extends t{constructor(t){super("rotate",t)}reset(t,e){let n=this.element.getBoundingClientRect();this.center={x:n.left+n.width/2,y:n.top+n.height/2},this.centerToMouse=i(this.center,{x:t.clientX,y:t.clientY})}update(t){let e=i(this.center,{x:t.clientX,y:t.clientY}),r=n(this.centerToMouse,e);return this.centerToMouse=e,r}}const s={T:"top",B:"bottom",L:"left",R:"right",TL:"top-left",TR:"top-right",BL:"bottom-left",BR:"bottom-right"};class o extends t{constructor(t,e=!1,i=!1){super("scale",t),this.rotation=e,this.attachHandles(i)}attachHandles(t){let e=[];(t?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]).forEach(t=>{let i=document.createElement("div");i.className="resize-handle "+s[t],i.type=t,i.onmouseover=()=>this.updateCursor(i),this.element.appendChild(i),e.push(i)}),this.handles=e}reset(t,e,i){switch(this.origin=e,this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.zeroPoint=DOMPoint.fromPoint({x:0,y:0}),t.currentTarget.type){case"TL":this.point=DOMPoint.fromPoint({x:-i.width/2,y:-i.height/2});break;case"T":this.point=DOMPoint.fromPoint({x:0,y:-i.height/2});break;case"TR":this.point=DOMPoint.fromPoint({x:i.width/2,y:-i.height/2});break;case"R":this.point=DOMPoint.fromPoint({x:i.width/2,y:0});break;case"BR":this.point=DOMPoint.fromPoint({x:i.width/2,y:i.height/2});break;case"B":this.point=DOMPoint.fromPoint({x:0,y:i.height/2});break;case"BL":this.point=DOMPoint.fromPoint({x:-i.width/2,y:i.height/2});break;case"L":this.point=DOMPoint.fromPoint({x:-i.width/2,y:0})}this.excludeRotation=!this.rotation||0==this.point.x||0==this.point.y}update(t,e){let r=this.zeroPoint.transform(e),s=this.point.transform(e),o={x:2*r.x-s.x,y:2*r.y-s.y},a=t.clientX,h=t.clientY,l=i(o,{x:a-this.offsetParent.x-this.origin.x,y:h-this.offsetParent.y-this.origin.y}),c=i(o,s),p=this.excludeRotation?0:n(c,l),u=l.length/c.length;return 0==this.point.x?u={x:1,y:u}:0==this.point.y&&(u={x:u,y:1}),{rotate:p,scale:u,point:o}}updateCursor(t){let e,i=this.element.getTransformStyle().rotate.angle;"TR"==t.type||"BL"==t.type?i+=Math.PI/4:"TL"==t.type||"BR"==t.type?i+=3*Math.PI/4:"L"!=t.type&&"R"!=t.type||(i+=Math.PI/2),i<0?i+=2*Math.PI:i>2*Math.PI&&(i-=2*Math.PI),e=i>Math.PI/8&&i<=3*Math.PI/8||i>=9*Math.PI/8&&i<=11*Math.PI/8?"nesw-resize":i>3*Math.PI/8&&i<=5*Math.PI/8||i>=11*Math.PI/8&&i<=13*Math.PI/8?"ew-resize":i>5*Math.PI/8&&i<=7*Math.PI/8||i>=13*Math.PI/8&&i<=15*Math.PI/8?"nwse-resize":"ns-resize",t.style.cursor=e}}class a extends t{constructor(t,e=!1){super("pinch",t),this.rotation=e}reset(t,e){this.origin=e,this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.lastPinch=this.createPinch(t)}update(t){let e=this.createPinch(t),r=i(this.lastPinch[0],this.lastPinch[1]),s=i(e[0],e[1]),o=(this.lastPinch[0].x+this.lastPinch[1].x)/2,a=(this.lastPinch[0].y+this.lastPinch[1].y)/2,h={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},l={x:h.x-o,y:h.y-a},c=this.rotation?n(r,s):0,p=s.length/r.length,u={x:h.x-this.offsetParent.x-this.origin.x,y:h.y-this.offsetParent.y-this.origin.y};return this.lastPinch=e,{pin:u,center:h,origin:this.origin,scale:p,rotation:c,translation:l}}createPinch(t){let e=[];return e[0]={x:t.touches[0].clientX,y:t.touches[0].clientY},e[1]={x:t.touches[1].clientX,y:t.touches[1].clientY},e}}class h{constructor(t,e){this.element=t,this.options=e,this.attachEvents()}reset(t){this.origin=t}detachEvents(){this.element.removeEventListener("touchstart",this.listener.begin),this.element.removeEventListener("touchmove",this.listener.move),this.element.removeEventListener("touchend",this.listener.end)}attachEvents(){let t=new a(this.element,this.options.rotate);this.listener={begin:this.begin.bind(this,t),move:this.move.bind(this,t),end:this.end.bind(this,t)},this.element.addEventListener("touchstart",this.listener.begin,{passive:!1}),this.element.addEventListener("touchmove",this.listener.move,{passive:!1}),this.element.addEventListener("touchend",this.listener.end,{passive:!1})}dispatchEvent(t,e){t.cancelable&&t.preventDefault(),t.stopPropagation();let i=t.type.replace("touch","pinch").replace("move",""),n=new CustomEvent(i,{detail:e});this.element.dispatchEvent(n)}begin(t,e){if(this.active||1==e.touches.length)return;let i=Array.from(e.touches).filter(t=>t.target==this.element||this.element.contains(t.target));i.length<2||(this.active=i.map(t=>t.identifier),this.origin||this.reset(this.element.toRect().center),t.reset(e,this.origin),this.dispatchEvent(e))}move(t,e){if(!this.active)return;let i,n=t.update(e);Object.defineProperty(n,"transform",{get:function(){return i||(i=new DOMMatrix,i.preMultiplySelf(DOMMatrix.fromRotate(this.rotation,this.pin)),i.preMultiplySelf(DOMMatrix.fromScale(this.scale,this.pin)),i.preMultiplySelf(DOMMatrix.fromTranslate(this.translation))),i}}),this.dispatchEvent(e,n)}end(t,e){!this.active||Array.from(e.touches).filter(t=>this.active.includes(t.identifier)).length>=2||(this.dispatchEvent(e),delete this.active)}}const l=[];let c={register(t,e={}){this.unregister(t);let i=new h(t,e);return this.debug&&(i.debug=!0),l.push(i),i},unregister(t){let e=l.filter(e=>e.element==t).first;e&&(e.detachEvents(),l.remove(e))}};class p{constructor(t,e){this.element=t,this.options=e,this.minWidth=this.options.minWidth||50,this.minHeight=this.options.minHeight||50,this.phase=p.Phase.END,this.attachEvents()}attachTransformFrame(){this.frame=document.createElement("div"),this.frame.style.backgroundColor="rgba(0, 255, 0, 0.2)",this.frame.style.display=this.element.style.display,this.frame.style.position="absolute","complete"===document.readyState||"loaded"===document.readyState?this.reset():addEventListener("DOMContentLoaded",t=>this.reset()),this.element.parentNode.insertBefore(this.frame,this.element)}open(t,e,i){if(this.reset(t),this.element.style.display="",this.debug&&(this.frame.style.display=""),this.phase=p.Phase.READY,e&&!e.isIdentity){let t=e;if(i){DOMMatrix.fromTranslate({x:-i.origin.x,y:-i.origin.y}),DOMMatrix.fromTranslate(i.origin);t=DOMMatrix.fromMatrix(i.transform),t.postMultiplySelf(this.viewTranslate),t.preMultiplySelf(this.originTranslate),t.multiplySelf(e)}this.transform(t)}}close(){this.phase!=p.Phase.END&&(this.dispatchEvent(p.Phase.END),this.element.style.display="none",this.debug&&(this.frame.style.display="none"))}reset(t){let e;t?t=t.ceil(!0):(t=this.element.toRect(),e=DOMMatrix.fromMatrix(this.element.getStyle("transform")),this.phase=p.Phase.READY);let i=t.width<this.minWidth?this.minWidth:t.width,n=t.height<this.minHeight?this.minHeight:t.height;this.bounds=new DOMRect(t.x,t.y,i,n),this.origin=this.bounds.center,this.matrix=new DOMMatrix,this.matrix.multiplicationType=DOMMatrix.MultiplicationType.PRE,this.originTranslate=DOMMatrix.fromTranslate({x:-this.origin.x,y:-this.origin.y}),this.viewTranslate=DOMMatrix.fromTranslate(this.origin),this.pincher.reset(this.bounds.center),this.debug&&(this.frame.style.left=this.bounds.left+"px",this.frame.style.top=this.bounds.top+"px",this.frame.style.width=this.bounds.width+"px",this.frame.style.height=this.bounds.height+"px"),this.applyUI(),e&&!e.isIdentity&&this.transform(e)}applyUI(){let t=this.matrix.disassemble(),e=this.bounds.width*t.scale.x,i=this.bounds.height*t.scale.y,n=this.origin.x-e/2+t.translate.x,r=this.origin.y-i/2+t.translate.y;this.element.style.left=n+"px",this.element.style.top=r+"px",this.element.style.width=e+"px",this.element.style.height=i+"px",0==t.rotate.angle?this.element.style.transform="":this.element.style.transform="rotate("+t.rotate.angle+"rad)",this.debug&&(this.frame.style.transform=this.matrix.toString())}detachEvents(){this.listeners.forEach(t=>{if("pinch"==t.type)return this.element.removeEventListener("pinchstart",t.event.begin),this.element.removeEventListener("pinch",t.event.move),this.element.removeEventListener("pinchend",t.event.end),void c.unregister(this.element);t.triggers.forEach(e=>{e.removeEventListener("mousedown",t.event.begin),e.removeEventListener("touchstart",t.event.begin),"scale"==t.type&&e.remove()}),document.removeEventListener("mousemove",t.event.move),document.removeEventListener("touchmove",t.event.move),document.removeEventListener("mouseup",t.event.end),document.removeEventListener("touchend",t.event.end)})}attachEvents(){this.listeners=[];let t={};if(this.options.translate){let i=new e(this.element),n=this.getEventHandlers(i),r=this.options.translateHandle||this.element;this.attachEvent(r,n),this.listeners.push({type:i.type,triggers:[r],event:n}),t.translate=i}if(this.options.rotate){let e=new r(this.element),i=this.getEventHandlers(e);this.options.rotateHandles.forEach(t=>this.attachEvent(t,i)),this.listeners.push({type:e.type,triggers:this.options.rotateHandles,event:i}),t.rotate=e}if(this.options.scale){let e=new o(this.element,this.options.rotate,this.options.keepRatio),i=this.getEventHandlers(e);e.handles.forEach(t=>this.attachEvent(t,i)),this.listeners.push({type:e.type,triggers:e.handles,event:i}),t.scale=e}this.pincher=c.register(this.element,this.options);let i={begin:function(e){this.active&&this.end(t[this.active]),this.active="pinch"}.bind(this),move:function(t){this.transform(t.detail.transform)}.bind(this),end:function(t){delete this.active}.bind(this)};this.element.addEventListener("pinchstart",i.begin),this.element.addEventListener("pinch",i.move),this.element.addEventListener("pinchend",i.end),this.listeners.push({type:"pinch",event:i})}getEventHandlers(t){return{begin:this.begin.bind(this,t),move:this.move.bind(this,t),end:this.end.bind(this,t)}}attachEvent(t,e){t.addEventListener("mousedown",e.begin),document.addEventListener("mousemove",e.move),document.addEventListener("mouseup",e.end),t.addEventListener("touchstart",e.begin,{passive:!1}),document.addEventListener("touchmove",e.move,{passive:!1}),document.addEventListener("touchend",e.end,{passive:!1})}dispatchEvent(t,e="transform",i){let n;this.phase=t,t==p.Phase.UPDATE?(n={type:e,transform:this.options.origin?this.matrix:this.getViewTransform(this.matrix)},this.options.delta&&i&&(n.delta=this.options.origin?i:this.getViewTransform(i))):t==p.Phase.BEGIN&&(n={origin:this.origin});let r=new CustomEvent(t,{detail:n});this.element.dispatchEvent(r)}getTransform(){return this.options.origin?this.matrix:this.getViewTransform(this.matrix)}getOriginTransform(){return this.matrix}getViewTransform(t=this.matrix){let e=new DOMMatrix;return e.multiplicationType=DOMMatrix.MultiplicationType.PRE,e.multiplySelf(this.originTranslate),e.multiplySelf(t),e.multiplySelf(this.viewTranslate),e}fixE(t){if(t.preventDefault(),t.stopPropagation(),t.changedTouches){let e;"touchstart"==t.type?(e=t.changedTouches[0],this.touchID=e.identifier):e=Array.from(t.changedTouches).filter(t=>t.identifier==this.touchID).first,e&&(e.currentTarget=e.target),t=e}return t}begin(t,e){isFinite(e.button)&&0!=e.button||this.active||(e=this.fixE(e),"translate"==t.type&&e.currentTarget==this.element&&(this.element.style.cursor="move"),t.reset(e,this.origin,this.bounds.size),this.active=t.type)}move(t,e){if(this.active!=t.type)return;if(!(e=this.fixE(e)))return;let i=t.update(e,this.matrix);switch(t.type){case"translate":this.translate(i);break;case"rotate":this.rotate(i);break;case"scale":this.rotate(i.rotate,i.point),this.scale(i.scale,i.point)}}end(t,e){this.active==t.type&&(e&&!(e=this.fixE(e))||("translate"==t.type&&"move"==this.element.style.cursor&&(this.element.style.cursor=""),delete this.touchID,delete this.active))}translate(t){if(this.phase==p.Phase.END)return;if(isFinite(t)&&(t={x:t,y:t}),0==t.x&&0==t.y)return;let e=DOMMatrix.fromTranslate(t);this.transform(e,"translate")}rotate(t,e){if(this.phase==p.Phase.END)return;if(0==t)return;e||(e=this.getAnchor());let i=DOMMatrix.fromRotate(t,e);this.transform(i,"rotate")}scale(t,e){if(this.phase==p.Phase.END)return;if(isFinite(t)&&(t={x:t,y:t}),1==t.x&&1==t.y)return;e||(e=this.getAnchor());let i=DOMMatrix.fromScale(t,e);this.transform(i,"scale")}transform(t,e="transform"){t instanceof DOMMatrix||(t=DOMMatrix.fromMatrix(t)),t.multiplicationType=this.matrix.multiplicationType;let i=this.matrix.multiply(t);if("scale"==e||"transform"==e){let t=i.disassemble().scale,e=this.bounds.width*t.x,n=this.bounds.height*t.y;if(e<this.minWidth||n<this.minHeight)return}this.matrix=i,this.applyUI(),t.isIdentity||(this.phase==p.Phase.READY&&this.dispatchEvent(p.Phase.BEGIN,e),this.dispatchEvent(p.Phase.UPDATE,e,t))}getAnchor(){return{x:this.matrix.tx,y:this.matrix.ty}}}p.Phase={READY:"ready",BEGIN:"transformstart",UPDATE:"transform",END:"transformend"};const u=[];let f=!1,y={register(t,e={}){if(!e.translate&&!e.scale&&!e.rotate)throw new Error("At least one of translate, scale and rotate is required");if(e.rotate){if(!e.rotateHandles)throw new Error("When rotate is available, rotateHandles option is required");if(0==e.rotateHandles.length)throw new Error("When rotate is available, at least one handle is required")}this.unregister(t);let i=new p(t,e);return f&&(i.debug=!0,i.attachTransformFrame()),u.push(i),i},unregister(t){let e=u.filter(e=>e.element==t).first;e&&(e.detachEvents(),u.remove(e))}};Object.defineProperty(y,"debug",{get:function(){return f},set:function(t){f=t,c.debug=t},enumerable:!0});export{c as PinchEvent,y as TransformEvent};
