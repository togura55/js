import"js-md5";import"long";import{vec2 as e,vec3 as t,vec4 as r,mat4 as i,quat2 as s}from"gl-matrix";import"clipper-lib";import"poly2tri";import"protobufjs";import n from"rbush";"undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:"undefined"!=typeof global&&(global.globalThis=global)),String.prototype.contains||(String.prototype.contains=function(e){return-1!=this.indexOf(e)}),String.prototype.startsWith||(String.prototype.startsWith=function(e){return this.length>=e.length&&this.substring(0,e.length)==e}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return this.length>=e.length&&this.substring(this.length-e.length,this.length)==e}),String.prototype.charsCode=function(){return this.split("").reduce((function(e,t){return e+t.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(e){return-1!=this.toUpperCase().indexOf(e.toUpperCase())},String.prototype.toCharArray=function(e){let t=e?new Uint8Array(this.length):new Array(this.length);for(let e=0;e<this.length;e++){let r=this.charCodeAt(e);r>255&&(t.bytes=!1),t[e]=r}return t},String.fromCharArray=function(e){let t="";try{t=String.fromCharCode.apply(null,e)}catch(r){for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r])}return t},String.prototype.pad=function(e,t){return this.length<e?new Array(e-this.length+1).join(t||"-")+this:this.toString()},Number.prototype.pad=function(e){return String(this).length<e?new Array(e-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){let e=new Float32Array(1);return e[0]=this,e[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(e){return this.indexOf(e)>-1},Array.prototype.clone=function(){return this.map(e=>Object.clone(e))},Array.prototype.unique=function(){return this.filter((e,t)=>this.indexOf(e)==t)},Array.prototype.add=function(e){if(!this.contains(e))return this.push(e)},Array.prototype.insert=function(e,t){this.splice(e,0,t)},Array.prototype.remove=function(e){return this.removeAt(this.indexOf(e))},Array.prototype.removeAt=function(e){return e>-1&&this.splice(e,1),this},Array.prototype.replace=function(e,t,r){let i=this.indexOf(e);if(i>-1)if(!r&&t instanceof Array){let e=[i,1];for(let r=0;r<t.length;r++)e.push(t[r]);this.splice.apply(this,e)}else this.splice(i,1,t);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach(e=>{let t=globalThis[e+"Array"];t?(t.from?Array.prototype["to"+e+"Array"]=function(){return t.from(this)}:Array.prototype["to"+e+"Array"]=function(){return new t(this)},Array.from?t.prototype.toArray=function(){return Array.from(this)}:t.prototype.toArray=function(){return Array.prototype.slice.call(this)},t.prototype.clone=function(){if("undefined"!=typeof SharedArrayBuffer&&this.buffer instanceof SharedArrayBuffer){let e=new SharedArrayBuffer(this.byteLength),r=new t(e);return r.set(this,this.byteOffset),r}return new t(this,this.byteOffset,this.length)},t.prototype.concat=function(...e){let t=this.length,r=this.length;e.forEach(e=>{if(this.constructor!=e.constructor)throw new Error(`Concat array from wrong type detected - expected ${this.constructor.name}, found ${e.constructor.name}`);t+=e.length});let i=new this.constructor(t);return i.set(this),e.forEach(e=>{i.set(e,r),r+=e.length}),i}):console.warn(e+"Array not found")})},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(e,t){t||(t=function(){});let r=t.getArguments(),i=new Function("body","return function "+e+"("+r+") {return body.apply(this, arguments);};")(t);return i.toString=function(){return t.toString()},i.toSource=function(){return t.toSource()},i},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){let e=this.toString().match(/^function\s([\w$]+)/);return e?e[1]:""}}),Function.prototype.getArguments=function(){let e=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==e.length?[]:e.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(e){let t=arguments.callee.caller.arguments;this.getArguments().forEach((function(e,r){this[e]=t[r]}),e)},Function.prototype.createEnum=function(e,t){if(this[e])throw new Error("Already exists key: "+e);this[e]=new Object;let r=[];for(let i=0;i<t.length;i++){let s=e+"_"+t[i],n=this[e];n[t[i]]=function(){let r=Object.create(Object.prototype,{constructor:{value:Function.create(s)},type:{value:e},name:{value:t[i]},value:{value:i}});return Object.defineProperty(n,i,{get:function(){return r}}),r}(),r.push(n[t[i]])}Object.defineProperty(this[e],"values",{value:r})},"undefined"==typeof AsyncFunction&&Object.defineProperty(globalThis,"AsyncFunction",{value:Object.getPrototypeOf((async function(){})).constructor}),Object.equals=function(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;if(e instanceof Array||ArrayBuffer.isTypedArray(e))return e.length==t.length&&e.every((e,r)=>Object.equals(e,t[r]));for(let r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!Object.equals(e[r],t[r]))return!1}}for(let r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0},Object.clone=function(e,t){let r=new Array;return function e(i){if(null===i)return null;if("object"!=typeof i||i.mutable)return i;if("function"==typeof i.clone)return i.clone();for(let e=0;e<r.length;e++)if(r[e][0]===i)return r[e][1];let s=Object.create(Object.getPrototypeOf(i));r.push([i,s]);for(let r in i)t&&"function"==typeof i[r]||i.hasOwnProperty(r)&&(s[r]=e(i[r]));return s}(e)},Object.toSource=function(e,t){if(e&&"object"==typeof e){let r=[];for(let t in e)e.hasOwnProperty(t)&&r.push(`${t}: ${Object.toSource(e[t])}`);return(t?t+" = ":"")+"{"+r.join(", ")+"};"}if("function"==typeof e){let t=e.toString();return 0!=t.indexOf("function")&&(t="function "+t),t}return e},Object.nameAnonymousFunctions=function(e,t){for(let r in e)"function"!=typeof e[r]||e[r].name||("constructor"==r&&t?Object.defineProperty(e[r],"name",{value:t}):Object.defineProperty(e[r],"name",{value:r}))},JSON.toBase64=function(e){return btoa(JSON.stringify(e))},JSON.fromBase64=function(e){return JSON.parse(atob(e))},JSON.encode=function(e){return JSON.toBase64(e).toCharArray(!0)},JSON.decode=function(e){let t=String.fromCharArray(e);return JSON.fromBase64(t)},Math.toDegrees=function(e){return e*(180/this.PI)},Math.toRadians=function(e){return e*(this.PI/180)},Math.randomInt=function(e,t){return Math.floor(this.random()*(t-e+1))+e},"function"==typeof Worker&&(Worker.prototype.on=function(e,t){this["on"+e]=r=>{let i="message"==e?r.data:r;t(i)}}),"function"==typeof DedicatedWorkerGlobalScope&&(DedicatedWorkerGlobalScope.prototype.on=function(e,t){this["on"+e]=r=>{let i="message"==e?r.data:r;t(i)}}),"object"==typeof window&&(HTMLElement.prototype.getInlineStyle=function(e){return this.style[e]||this.style["-webkit-"+e]||this.style["-khtml-"+e]||this.style["-moz-"+e]||this.style["-ms-"+e]||this.style["-o-"+e]||""},HTMLElement.prototype.setStyle=function(e,t){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(r){this.style[r+"-"+e]=t}),this),this.style[e]=t},HTMLElement.prototype.getStyle=function(e){let t=e,r=e.startsWith("-");r&&(t=e.substring(1));let i=t.split("-");for(let e=i.length-1;e>0;e--)i[e]=i[e].substring(0,1).toUpperCase()+i[e].substring(1);t=i.join("");let s=this.style.display,n=this.style.visibility;"none"==s&&(this.style.visibility="hidden",this.style.display="");let o=window.getComputedStyle(this)[t];if(!r&&void 0===o){let t=["-webkit","-khtml","-moz","-ms","-o"];for(let r=0;r<t.length&&(o=this.getStyle(t[r]+"-"+e),"undefined"==o);r++);}return"none"==s&&(this.style.visibility=n,this.style.display="none"),o},HTMLElement.prototype.getMathStyle=function(e,t){let r=t?this.getInlineStyle(e):this.getStyle(e);return"auto"==r&&(r=0),parseFloat(r)},HTMLElement.prototype.getTransformStyle=function(){let e={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},t=this.getStyle("transform");if("none"!=t){let r=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),i=parseFloat(r[0]),s=parseFloat(r[1]),n=parseFloat(r[2]),o=parseFloat(r[3]),a=parseFloat(r[4]),h=parseFloat(r[5]);e.scale={x:Math.sqrt(i*i+n*n),y:Math.sqrt(o*o+s*s)},e.skew={angleX:Math.tan(n),angleY:Math.tan(s)},e.rotate={angle:Math.atan2(s,i)},e.translate={x:a,y:h},e.matrix={a:i,b:s,c:n,d:o,tx:a,ty:h}}return e},HTMLElement.prototype.toRect=function(){let e=this.style.display,t=this.style.visibility;"none"==e&&(this.style.visibility="hidden",this.style.display="");let r=this.offsetWidth,i=this.offsetHeight,s=this.offsetLeft,n=this.offsetTop,o=s+r,a=n+i,h=(s+o)/2,l=(n+a)/2,u=r/2,d=i/2,c=r+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),p=i+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom");return"none"==e&&(this.style.visibility=t,this.style.display="none"),Object.defineProperties({},{left:{value:s,enumerable:!0},top:{value:n,enumerable:!0},right:{value:o,enumerable:!0},bottom:{value:a,enumerable:!0},x:{value:s,enumerable:!0},y:{value:n,enumerable:!0},width:{value:r,enumerable:!0},height:{value:i,enumerable:!0},center:{value:{x:h,y:l},enumerable:!0},origin:{value:{x:u,y:d},enumerable:!0},size:{value:{width:r,height:i},enumerable:!0},outerSize:{value:{width:c,height:p},enumerable:!0}})},HTMLImageElement.prototype.toDataURL=function(e){let t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.getContext("2d").drawImage(this,0,0),t.toDataURL(e||"image/png")},HTMLImageElement.prototype.toBlob=function(e){return new Blob([this.getBytes(e).buffer],{type:e||"image/png"})},HTMLImageElement.prototype.getBytes=function(e){let t=this.toDataURL(e).split(",")[1];return atob(t).toCharArray(!0)},Image.fromBytes=function(e,t,r){let i=new Image;return i.onload=function(){URL.revokeObjectURL(this.src),t&&t.call(this)},i.src=URL.createObjectURL(new Blob([e.buffer||e],{type:"image/"+(r||"png")})),i},CanvasRenderingContext2D.prototype.clearCanvas=function(e){this.clearRect(0,0,this.canvas.width,this.canvas.height),e&&(this.fillStyle=e,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(e,t){let r=document.createElement("canvas");return r.width=e,r.height=t,r},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}let e=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(e=Math.ceil(e*window.devicePixelRatio),e%10!=0&&(e%10>5?e+=10-e%10:e-=e%10)),e},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}let e=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(e=Math.ceil(e*window.devicePixelRatio),e%10!=0&&(e%10>5?e+=10-e%10:e-=e%10)),e},configurable:!0}));class o{getInkBuilder(e){throw new Error("InkController.getInkBuilder(pointerID) should be implemented")}registerInputProvider(e,t){throw new Error("InkController.registerInputProvider(pointerID, isPrimary) should be implemented")}reset(e){throw new Error("InkController.reset(sensorPoint) should be implemented")}begin(e){throw new Error("InkController.begin(sensorPoint) should be implemented")}move(e){throw new Error("InkController.move(sensorPoint) should be implemented")}end(e){throw new Error("InkController.end(sensorPoint) should be implemented")}abort(e){throw new Error("InkController.abort(pointerID) should be implemented")}resize(){throw new Error("InkController.resize() should be implemented")}}var a="1.2.0";Object.defineProperty(globalThis,"DIGITAL_INK_ENV",{value:"AUTO",enumerable:!0,configurable:!0});let h,l={version:"1.2.0"};Function.prototype.createEnum.call(l,"Type",["WEB","WORKER","NODE","SHELL"]),Function.prototype.createEnum.call(l,"Type2D",["SCREEN","OFFSCREEN"]),Function.prototype.createEnum.call(l,"TypeGL",["WEB","STACK"]),function(e){let t,r="BROWSER"!=DIGITAL_INK_ENV&&"object"==typeof process&&"function"==typeof require;t="object"==typeof window?"WEB":"function"==typeof importScripts?"WORKER":r?"NODE":"SHELL";let i="undefined"==typeof OffscreenCanvas?"OFFSCREEN":"SCREEN",s="undefined"==typeof WebGLRenderingContext?"STACK":"WEB";Object.defineProperty(l,"commonJS",{value:r,enumerable:!0}),Object.defineProperty(l,"type",{value:l.Type[t],enumerable:!0}),Object.defineProperty(l,"type2D",{value:l.Type2D[i],enumerable:!0}),Object.defineProperty(l,"typeGL",{value:l.TypeGL[s],enumerable:!0})}(),h=l.commonJS?require("js-md5"):md5;var u=h;let d;d=l.commonJS?require("long"):Long;var c=d;let p={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate(){let e=Date.now();return this.mask.replace(/[xy]/g,(function(t){let r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)}))},fromString(e){return this.fromBytes(new Uint8Array(u.arrayBuffer(e)))},toBytes(e){let t=[];return e.split("-").map((e,r)=>{(r<3?e.match(/.{1,2}/g).reverse():e.match(/.{1,2}/g)).map(e=>t.push(parseInt(e,16)))}),new Uint8Array(t)},fromBytes(e){let t=Array.from(e).map(e=>e.toString(16)).map(e=>(1==e.length?"0":"")+e);return t.slice(0,4).reverse().join("")+"-"+t.slice(4,6).reverse().join("")+"-"+t.slice(6,8).reverse().join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10).join("")},toUint32Array(e){let t=new Uint32Array(4),r=this.toBytes(e);return t[0]=new Uint32Array(r.slice(0,4).buffer)[0],t[1]=new Uint32Array(r.slice(4,8).buffer)[0],t[2]=new Uint32Array(r.slice(8,12).buffer)[0],t[3]=new Uint32Array(r.slice(12).buffer)[0],t},fromUint32Array(e){return this.fromBytes(new Uint8Array(e.buffer))},toUint64Array(e){let t=new BigUint64Array(2),r=this.toBytes(e);return t[0]=new BigUint64Array(r.slice(0,8).buffer)[0],t[1]=new BigUint64Array(r.slice(8).buffer)[0],t},fromUint64Array(e){return this.fromBytes(new Uint8Array(e.buffer))},toLongArray(e){let t=new Array(2),r=this.toBytes(e);return t[0]=c.fromBytes(r.slice(0,8)),t[1]=c.fromBytes(r.slice(8)),t},fromLongArray(e){let t=e[0].toBytes().concat(e[1].toBytes());return this.fromBytes(t)}};class f{static get SEPARATOR(){return"\n"}constructor(e){Object.defineProperty(this,"id",{get:function(){return e||(e=this.resolveID()),e},set:function(t){let r=e;e=t,this.updateID(r,e)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:()=>"function"==typeof this.getMD5Message?f.Algorithm.MD5:f.Algorithm.GUID,enumerable:!0})}resolveID(){if(this.algorithm==f.Algorithm.MD5){let e="",t=this.getMD5Message();for(let r of t){if(Array.isArray(r))for(let t of r)e+=t,e+="\n";else e+=r;e+="\n"}if(!e)throw new Error("Empty MD5 message container found");return u(e)}return p.generate()}updateID(e,t){}invalidateID(){this.id=void 0}static getMD5Tokens(e){let t=[];return Object.keys(e).sort().forEach(r=>t.push(r,e[r])),t}}f.createEnum("Algorithm",["GUID","MD5"]);class g extends f{constructor(e,t={}){super(),this.type=e,this.props=Object.assign({},t)}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,f.getMD5Tokens(this.props)]}}g.createEnum("Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);class m{constructor(){this.path=[],this.phase=m.Phase.END;let e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),m.OutputType.ALL_DATA)},enumerable:!0})}add(e,t,r){if(!this.move(e))throw new Error(`Cannot move from phase ${this.phase.name} to phase ${e.name}`);let i=this.addImpl(t,r);return this.keepAllData&&this.path.push(...i.added),{added:this.getOutput(i.added,m.OutputType.ADDITION),predicted:this.getOutput(i.predicted,m.OutputType.PREDICTION)}}addImpl(e,t){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}getOutput(e,t){return e}move(e){return(this.phase!=m.Phase.END||e==m.Phase.BEGIN)&&((this.phase!=m.Phase.BEGIN||e==m.Phase.UPDATE||e==m.Phase.END)&&((this.phase!=m.Phase.UPDATE||e==m.Phase.UPDATE||e==m.Phase.END)&&(e==m.Phase.BEGIN&&this.reset(),this.phase=e,!0)))}reset(){this.path.clear(),this.phase=m.Phase.END}}m.createEnum("Phase",["BEGIN","UPDATE","END"]),m.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA"]);class y{constructor(i,s,n,o){if(isNaN(i))throw new Error("Invalid x found: "+i);if(isNaN(s))throw new Error("Invalid y found: "+s);let a=[i,s];isFinite(n)&&(a.push(n),isFinite(o)&&a.push(o)),this.value=a.toFloat32Array(),Object.defineProperty(this,"x",{get:()=>this.value[0],set:e=>this.value[0]=e,enumerable:!0}),Object.defineProperty(this,"y",{get:()=>this.value[1],set:e=>this.value[1]=e,enumerable:!0}),2==a.length?this.vec=e:3==a.length?(this.vec=t,Object.defineProperty(this,"z",{get:()=>this.value[2],set:e=>this.value[2]=e,enumerable:!0})):(this.vec=r,Object.defineProperty(this,"w",{get:()=>this.value[3],set:e=>this.value[3]=e,enumerable:!0}))}add(e){e instanceof y||(e=y.fromPoint(e));let t=this.vec.create();return this.vec.add(t,this.value,e.value),y.fromPoint(t)}addSelf(e){return e instanceof y||(e=y.fromPoint(e)),this.vec.add(this.value,this.value,e.value),this}subtract(e){e instanceof y||(e=y.fromPoint(e));let t=this.vec.create();return this.vec.subtract(t,this.value,e.value),y.fromPoint(t)}subtractSelf(e){return e instanceof y||(e=y.fromPoint(e)),this.vec.subtract(this.value,this.value,e.value),this}multiply(e){e instanceof y||(e=y.fromPoint(e));let t=this.vec.create();return this.vec.multiply(t,this.value,e.value),y.fromPoint(t)}multiplySelf(e){return e instanceof y||(e=y.fromPoint(e)),this.vec.multiply(this.value,this.value,e.value),this}divide(e){e instanceof y||(e=y.fromPoint(e));let t=this.vec.create();return this.vec.divide(t,this.value,e.value),y.fromPoint(t)}divideSelf(e){return e instanceof y||(e=y.fromPoint(e)),this.vec.divide(this.value,this.value,e.value),this}scale(e){let t=this.vec.create();return this.vec.scale(t,this.value,e),y.fromPoint(t)}scaleSelf(e){return this.vec.scale(this.value,this.value,e),this}abs(){return new y(Math.abs(this.x),Math.abs(this.y),isFinite(this.z)?Math.abs(this.z):void 0,isFinite(this.w)?Math.abs(this.w):void 0)}absSelf(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),isFinite(this.z)&&(this.z=Math.abs(this.z)),isFinite(this.w)&&(this.w=Math.abs(this.w)),this}transform(e){if(!e)return this;let t=this.vec.create();return this.vec.transformMat4(t,this.value,e.toFloat32Array()),y.fromPoint(t)}transformSelf(e){return this.vec.transformMat4(this.value,this.value,e.toFloat32Array()),this}toFloat32Array(){return this.value}toJSON(){let e={x:this.x,y:this.y};return isFinite(this.z)&&(e.z=this.z,isFinite(this.w)&&(e.w=this.w)),e}toString(){return`point(${this.value.join(", ")})`}clone(){return y.fromPoint(this)}static fromPoint(e){return Array.isArray(e)||ArrayBuffer.isTypedArray(e)?new y(e[0],e[1],e[2],e[3]):new y(e.x,e.y,e.z,e.w)}}const b=0,E=1,P=4,x=5,w=12,v=13;class T{constructor(e=i.create(),t=T.MultiplicationType.PRE){let r,s,n,o,a;Object.defineProperty(this,"value",{value:e,enumerable:!0}),Object.defineProperty(this,"multiplicationType",{value:t,enumerable:!0}),Object.defineProperty(this,"a",{get:()=>this.value[b],enumerable:!0}),Object.defineProperty(this,"b",{get:()=>this.value[E],enumerable:!0}),Object.defineProperty(this,"c",{get:()=>this.value[P],enumerable:!0}),Object.defineProperty(this,"d",{get:()=>this.value[x],enumerable:!0}),Object.defineProperty(this,"e",{get:()=>this.value[w],enumerable:!0}),Object.defineProperty(this,"f",{get:()=>this.value[v],enumerable:!0}),Object.defineProperty(this,"tx",{get:()=>this.value[w],enumerable:!0}),Object.defineProperty(this,"ty",{get:()=>this.value[v],enumerable:!0}),Object.defineProperty(this,"m11",{get:()=>this.value[0],enumerable:!0}),Object.defineProperty(this,"m12",{get:()=>this.value[1],enumerable:!0}),Object.defineProperty(this,"m13",{get:()=>this.value[2],enumerable:!0}),Object.defineProperty(this,"m14",{get:()=>this.value[3],enumerable:!0}),Object.defineProperty(this,"m21",{get:()=>this.value[4],enumerable:!0}),Object.defineProperty(this,"m22",{get:()=>this.value[5],enumerable:!0}),Object.defineProperty(this,"m23",{get:()=>this.value[6],enumerable:!0}),Object.defineProperty(this,"m24",{get:()=>this.value[7],enumerable:!0}),Object.defineProperty(this,"m31",{get:()=>this.value[8],enumerable:!0}),Object.defineProperty(this,"m32",{get:()=>this.value[9],enumerable:!0}),Object.defineProperty(this,"m33",{get:()=>this.value[10],enumerable:!0}),Object.defineProperty(this,"m34",{get:()=>this.value[11],enumerable:!0}),Object.defineProperty(this,"m41",{get:()=>this.value[12],enumerable:!0}),Object.defineProperty(this,"m42",{get:()=>this.value[13],enumerable:!0}),Object.defineProperty(this,"m43",{get:()=>this.value[14],enumerable:!0}),Object.defineProperty(this,"m44",{get:()=>this.value[15],enumerable:!0}),Object.defineProperty(this,"isIdentity",{get:()=>1==this.a&&0==this.b&&0==this.c&&1==this.d&&0==this.tx&&0==this.ty,enumerable:!0}),Object.defineProperty(this,"translateX",{get:()=>this.tx,enumerable:!0}),Object.defineProperty(this,"translateY",{get:()=>this.ty,enumerable:!0}),Object.defineProperty(this,"skewX",{get:()=>isNaN(r)?Math.tan(this.c):r,enumerable:!0}),Object.defineProperty(this,"skewY",{get:()=>isNaN(s)?Math.tan(this.b):s,enumerable:!0}),Object.defineProperty(this,"scaleX",{get:()=>isNaN(n)?Math.sqrt(this.a*this.a+this.c*this.c):n,enumerable:!0}),Object.defineProperty(this,"scaleY",{get:()=>isNaN(o)?Math.sqrt(this.d*this.d+this.b*this.b):o,enumerable:!0}),Object.defineProperty(this,"rotation",{get:()=>isNaN(a)?Math.atan2(this.b,this.a):a,enumerable:!0}),this.reset=()=>{r=void 0,s=void 0,n=void 0,o=void 0,a=void 0}}clone(){return new T(this.value.clone(),this.multiplicationType)}translate(e){return this.multiply(T.fromTranslate(e))}translateSelf(e){this.multiplySelf(T.fromTranslate(e))}rotate(e,t){return this.multiply(T.fromRotate(e,t))}rotateSelf(e,t){this.multiplySelf(T.fromRotate(e,t))}scale(e,t){return this.multiply(T.fromScale(e,t))}scaleSelf(e,t){this.multiplySelf(T.fromScale(e,t))}multiply(e){let t=i.create();return this.multiplicationType==T.MultiplicationType.PRE?i.multiply(t,e.toFloat32Array(),this.value):i.multiply(t,this.value,e.toFloat32Array()),new T(t,this.multiplicationType)}multiplySelf(e){this.multiplicationType==T.MultiplicationType.PRE?this.preMultiplySelf(e):this.postMultiplySelf(e)}preMultiplySelf(e){i.multiply(this.value,e.toFloat32Array(),this.value),this.reset()}postMultiplySelf(e){i.multiply(this.value,this.value,e.toFloat32Array()),this.reset()}invert(){let e=i.create();return i.invert(e,this.value),new T(e,this.multiplicationType)}invertSelf(){i.invert(this.value,this.value),this.reset()}disassemble(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this.toJSON()}}transformPoint(e){return y.fromPoint(e).transform(this)}toFloat32Array(){return this.value}toJSON(){return{a:this.a,b:this.b,c:this.c,d:this.d,tx:this.tx,ty:this.ty}}toString(){return`matrix(${this.a}, ${this.b}, ${this.c}, ${this.d}, ${this.tx}, ${this.ty})`}static fromString(e,t){let r=i.create();return"none"!=e&&(e=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),r[b]=parseFloat(e[0]),r[E]=parseFloat(e[1]),r[P]=parseFloat(e[2]),r[x]=parseFloat(e[3]),r[w]=parseFloat(e[4]),r[v]=parseFloat(e[5])),new T(r,t)}static fromMatrix(e,t){if(!e)throw new Error("data not found, Matrix instance creation failed");if("function"==typeof e)throw new Error("data type function is not allowed");if(e instanceof T)return e;if(Array.isArray(e)&&(e=new Float32Array(e)),e instanceof Float32Array)return new T(e,t);if("string"==typeof e)return T.fromString(e,t);let r={a:1,b:0,c:0,d:1,tx:0,ty:0};isFinite(e.a)&&(r.a=e.a),isFinite(e.b)&&(r.b=e.b),isFinite(e.c)&&(r.c=e.c),isFinite(e.d)&&(r.d=e.d),r.tx=e.tx||e.e||e.dx||0,r.ty=e.ty||e.f||e.dy||0;let s=i.create();return s[b]=r.a,s[E]=r.b,s[P]=r.c,s[x]=r.d,s[w]=r.tx,s[v]=r.ty,new T(s,t||e.multiplicationType)}static fromTranslate(e){let t=isFinite(e)?{tx:e,ty:e}:{tx:e.x,ty:e.y};return T.fromMatrix(t)}static fromRotate(e,t){let r=Math.sin(e),i=Math.cos(e),s={a:i,b:r,c:-r,d:i};return t&&(s.tx=t.x-t.x*i+t.y*r,s.ty=t.y-t.x*r-t.y*i),T.fromMatrix(s)}static fromScale(e,t){isFinite(e)&&(e={x:e,y:e});let r={a:e.x,d:e.y};return t&&(r.tx=t.x-t.x*e.x,r.ty=t.y-t.y*e.y),T.fromMatrix(r)}static multiply(e,t){let r=i.create();return i.multiply(r,e.value,t.value),new T(r)}}T.MultiplicationType=Object.freeze({PRE:"PRE",POST:"POST"});class I{constructor(e){this.header=[],this.table=[],e.forEach(e=>{"string"==typeof e&&(e={name:e,title:e}),e.size=e.title.length,this.header.push(e)}),Object.defineProperty(this,"length",{get:()=>this.table.length,enumerable:!0})}insert(e){this.table.push(e),this.header.forEach(t=>{let r=e[t.name];null!=r&&(t.size=Math.max(t.size,r.toString().length))})}build(){let e=[],t=this.header.length+1,r=[];return this.header.forEach(e=>{t+=e.size+2;let i=e.size-e.title.length,s=Math.floor(i/2),n=Math.ceil(i/2);r.push(this.getRepetedValue(s)+e.title+this.getRepetedValue(n))}),this.table.forEach(t=>{let r=[];this.header.forEach(e=>{let i=null==t[e.name]?"":t[e.name],s=e.size-i.toString().length;r.push(i+this.getRepetedValue(s))}),e.push(r)}),{delimiterLength:t,headerRow:r,content:e}}getFormattedRow(e){let t="| ";return e.forEach(e=>{t+=e,t+=" | "}),t.trim()}getRepetedValue(e,t=" "){return new Array(e+1).join(t)}clear(){this.table.clear()}toString(){let e="",{delimiterLength:t,headerRow:r,content:i}=this.build();return e+=this.getRepetedValue(t,"="),e+="\n",e+=this.getFormattedRow(r),e+="\n",e+=this.getRepetedValue(t,"="),e+="\n",i.forEach(t=>{e+=this.getFormattedRow(t),e+="\n"}),e}}if("object"==typeof window&&"undefined"==typeof TouchEvent){class e extends Event{}window.TouchEvent=e}let S={pointers:{mouse:["down","move","up"],touch:["start","move","end"]},inactive:[],open(e){if(!(e instanceof o))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("touchcancel",this.abort,{passive:!0}),this.attachResize(),this.start()},reset(e){for(let t in this.pointers){let r=t==S.PointerType.TOUCH?{passive:!0}:void 0,i=t+this.pointers[t][0];this.canvas.removeEventListener(i,this.begin),e.canvas.surface.addEventListener(i,this.begin,r)}this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close(){this.stop(),this.dettachResize(),removeEventListener("touchcancel",this.abort),delete this.canvas,delete this.inkController},start(e){let t=e?{[e]:this.pointers[e]}:this.pointers;for(e in e&&this.inactive.remove(e),this.inactive.forEach(e=>delete t[e]),t){let r=e==S.PointerType.TOUCH?{passive:!0}:void 0;for(let i=0;i<t[e].length;i++){let s=e+t[e][i];0==i?this.canvas.addEventListener(s,this.begin,r):addEventListener(s,2==i?this.end:this.move,r)}}},stop(e){let t=e?{[e]:this.pointers[e]}:this.pointers;for(e in e&&!this.inactive.includes(e)&&this.inactive.push(e),this.inactive.forEach(e=>delete t[e]),e&&e!=S.PointerType.MOUSE||clearTimeout(this.timeoutID),t)for(let r=0;r<t[e].length;r++){let i=e+t[e][r];0==r?this.canvas.removeEventListener(i,this.begin):removeEventListener(i,2==r?this.end:this.move)}},attachResize(){var e,t,r;this.inkController.resize&&(this.resize=(e=()=>this.inkController.resize(),t=200,r=null,function(){var i=this,s=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(i,s)}),t)}),addEventListener("resize",this.resize))},dettachResize(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed(e){let t=this.provider;return(!e.type.endsWith("down")&&!e.type.endsWith("start")||(t||(t=this.getInputProvider(e)),!this.inactive.includes(t)))&&t==this.getInputProvider(e)},isInputExpected(e){let t=!1,r=e.changedTouches?Array.from(e.changedTouches).map(e=>e.identifier):[],i=this.inkController.getInkBuilder(r);return i&&(t=e.type.endsWith("down")||e.type.endsWith("start")?!i.phase:!!i.phase),t},getSensorPoint(e){let t=void 0,r=e.changedTouches?Array.from(e.changedTouches).map(e=>e.identifier):[],i=this.inkController.getInkBuilder(r);return i&&(t=this.createSensorPoint(e,i.pointerID)),t},createSensorPoint(e,t){let r=this.getOffset(e),i={x:r.x,y:r.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,rotation:void 0},s={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(i,"phase",{value:m.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(i,"pointer",{value:s,enumerable:!0}),Object.defineProperty(i.pointer,"provider",{get:function(){return g.Type[this.type.toUpperCase()]},enumerable:!0}),e instanceof MouseEvent)s.type=S.PointerType.MOUSE,s.button=e.button,s.buttons=e.buttons;else{if(!(e instanceof TouchEvent))throw new Error(`Unexpected event detected: ${e.constructor.name}. Expected event should be instance of MouseEvent or TouchEvent.`);if(isNaN(t))throw new Error("pointerID is required for touch event");if(!(e=Array.from(e.changedTouches).filter(e=>e.identifier==t).first))return null;isNaN(i.x)&&(i.x=e.offsetX||e.clientX),isNaN(i.y)&&(i.y=e.offsetY||e.clientY),s.id=e.identifier,s.type=S.PointerType.TOUCH,i.pressure=e.force,i.radiusX=e.radiusX,i.radiusY=e.radiusY,i.rotation=Math.toRadians(e.rotationAngle)}return i},getOffset(e){if(e.changedTouches){let t=Array.from(e.changedTouches).map(e=>e.identifier),r=this.inkController.getInkBuilder(t);e=r.pointerID!=e.changedTouches.item(0).identifier?Array.from(e.changedTouches).filter(e=>e.identifier==r.pointerID).first:e.changedTouches.item(0)}let t=this.canvas.offsetParent;if(!t)return{x:0,y:0};"flex"==t.getStyle("display")&&(t=this.canvas);let r=t.getBoundingClientRect(),i={x:e.pageX-r.x,y:e.pageY-r.y};return this.inkController.transform&&(i=y.fromPoint(i).transform(this.inkController.transform.invert())),i},getInputProvider:e=>e.type.replace(/down|start|move|up|end/g,""),begin(e){if(this.logSampleInput(e),e instanceof MouseEvent&&0!=e.button)return;if(!this.isInputAllowed(e))return;if(e instanceof TouchEvent){let t=Array.from(e.changedTouches).map(e=>e.identifier);this.inkController.registerInputProvider(t)}if(!this.isInputExpected(e))return;this.provider||(this.provider=this.getInputProvider(e));let t=this.getSensorPoint(e);t&&this.inkController.begin(t)},move(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;this.logSampleInput(e);let t=this.getSensorPoint(e);t&&this.inkController.move(t)},end(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;this.logSampleInput(e);let t=this.getSensorPoint(e);t&&(this.inkController.end(t),e instanceof MouseEvent||this.inactive.includes(S.PointerType.MOUSE)||(this.stop(S.PointerType.MOUSE),this.timeoutID=setTimeout(()=>this.start(S.PointerType.MOUSE),500))),e.touches&&0!=e.touches.length||delete this.provider},abort(e){if(delete this.provider,this.inkController.abort)if(e instanceof TouchEvent){let t=Array.from(e.changedTouches).map(e=>e.identifier);this.inkController.abort(t)}else this.inkController.abort()},logSampleInput(e){if(!this.debug)return;const t=e.type.endsWith("move"),r="mouseup"==e.type||"touchend"==e.type;t&&!this.debug.move||r&&!this.debug.end||(r&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new I(["type","id","pointerType","x","y","pressure","radius","rotation","timestamp"])),this.table.insert({type:e.type,id:e.changedTouches?e.changedTouches[0].identifier:void 0,pointerType:this.getInputProvider(e),x:e.changedTouches?e.changedTouches[0].clientX.toFixed(2):e.clientX,y:e.changedTouches?e.changedTouches[0].clientY.toFixed(2):e.clientY,pressure:e.changedTouches?e.changedTouches[0].force.toFixed(2):void 0,radius:e.changedTouches?e.changedTouches[0].radiusX.toFixed(2)+" / "+e.changedTouches[0].radiusY.toFixed(2):void 0,rotation:e.changedTouches?e.changedTouches[0].rotationAngle:e.twist,timestamp:e.timeStamp.toFixed(8)}),t||(console.log(this.table.toString()),this.table.clear()))},PointerType:{MOUSE:"mouse",TOUCH:"touch"}},R={inactive:[],open(e){if(!(e instanceof o))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset(e){this.canvas.removeEventListener("pointerdown",this.begin),e.canvas.surface.addEventListener("pointerdown",this.begin),this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start(e){e?this.inactive.remove(e):(this.canvas.addEventListener("pointerdown",this.begin),addEventListener("pointermove",this.move),addEventListener("pointerup",this.end))},stop(e){e?this.inactive.includes(e)||this.inactive.push(e):(this.canvas.removeEventListener("pointerdown",this.begin),removeEventListener("pointermove",this.move),removeEventListener("pointerup",this.end))},attachResize(){var e,t,r;this.inkController.resize&&(this.resize=(e=()=>this.inkController.resize(),t=200,r=null,function(){var i=this,s=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(i,s)}),t)}),addEventListener("resize",this.resize))},dettachResize(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed(e){let t=this.provider;if("pointerdown"==e.type){if(t||(t=this.getInputProvider(e)),this.inactive.includes(t))return!1;if(t==R.PointerType.MOUSE){if(0!=e.button)return!1}else if(t==R.PointerType.PEN&&0==e.pressure)return!1}return!0},isInputExpected(e){let t=!1,r=this.inkController.getInkBuilder(e.pointerId);return r&&(t="pointerdown"==e.type?!r.phase:!!r.phase),t},getSensorPoint(e){let t=void 0,r=this.inkController.getInkBuilder(e.pointerId);if(r){if(e.pointerId!=r.pointerID)throw new Error(`Create sensor point failed, expected pointer with id: ${r.pointerID}, found: ${e.pointerId}`);if("pointerdown"==e.type){let t=this.getInputProvider(e);e.pointerType!=t?r.pointerType=t:delete r.pointerType}t=this.createSensorPoint(e,r.pointerType)}return t},createSensorPoint(e,t,r){if(!(e instanceof PointerEvent))throw new Error(`Unexpected event detected: ${e.constructor.name}. Expected event should be instance of PointerEvent.`);let i,s=this.getOffset(e),n={x:s.x,y:s.y,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0};if(r?(Object.defineProperty(n,"phase",{value:r.phase,enumerable:!0}),i=r.pointer):(Object.defineProperty(n,"phase",{value:m.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),i={id:e.pointerId,type:t||e.pointerType,button:void 0,buttons:void 0},Object.defineProperty(i,"provider",{get:function(){return g.Type[this.type.toUpperCase()]},enumerable:!0}),"pen"!=i.type&&"mouse"!=i.type||(i.button=e.button,i.buttons=e.buttons)),Object.defineProperty(n,"pointer",{value:i,enumerable:!0}),"pen"!=i.type&&"touch"!=i.type||(n.pressure=e.pressure,n.rotation=Math.toRadians(e.twist)),"pen"==i.type?(n.tiltX=e.tiltX,n.tiltY=e.tiltY):"touch"==i.type&&(n.radiusX=e.width/2,n.radiusY=e.height/2),!r){if(e.getPredictedEvents){let r,i=e.getPredictedEvents();Object.defineProperty(n,"predicted",{get:()=>(r||(r=i.map(e=>this.createSensorPoint(e,t,n))),r),enumerable:!0})}if(e.getCoalescedEvents){let r,i=e.getCoalescedEvents();Object.defineProperty(n,"coalesced",{get:()=>(r||(r=i.map(e=>this.createSensorPoint(e,t,n))),r),enumerable:!0})}}return n},getOffset(e){let t=this.canvas.offsetParent;if(!t)return{x:0,y:0};"flex"==t.getStyle("display")&&(t=this.canvas);let r=t.getBoundingClientRect(),i={x:e.pageX-r.x,y:e.pageY-r.y};return this.inkController.transform&&(i=y.fromPoint(i).transform(this.inkController.transform.invert())),i},getInputProvider:e=>e.pointerType==R.PointerType.MOUSE&&e.pressure>0&&.5!==e.pressure?R.PointerType.PEN:e.pointerType,begin(e){if(this.logSampleInput(e),!this.isInputAllowed(e))return;if(this.inkController.registerInputProvider(e.pointerId,e.isPrimary),!this.isInputExpected(e))return;this.provider||(this.provider=this.getInputProvider(e));let t=this.getSensorPoint(e);t&&this.inkController.begin(t)},move(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;this.logSampleInput(e);let t=this.getSensorPoint(e);t&&this.inkController.move(t)},end(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;this.logSampleInput(e);let t=this.getSensorPoint(e);t&&this.inkController.end(t),delete this.provider},abort(e){delete this.provider,this.inkController.abort&&this.inkController.abort(e.pointerId)},logSampleInput(e){this.debug&&("pointermove"!=e.type||this.debug.move)&&("pointerup"!=e.type||this.debug.end)&&(e.pointerType!=this.getInputProvider(e)&&(e.pen=!0),"pointerup"==e.type&&this.table.length>0&&(console.log(this.table.toString()),this.table.clear()),this.table||(this.table=new I(["type","id","pointerType","x","y","pressure","radius","tilt","rotation","timestamp"])),this.table.insert({type:e.type,id:e.pointerId,pointerType:e.pen?e.pointerType+" / pen":e.pointerType,x:e.clientX.toFixed(2),y:e.clientY.toFixed(2),pressure:e.pressure.toFixed(2),radius:(e.width/2).toFixed(2)+" / "+(e.height/2).toFixed(2),rotation:e.twist,tilt:isFinite(e.tiltX)?e.tiltX+" / "+e.tiltY:"",timestamp:e.timeStamp.toFixed(8)}),"pointermove"!=e.type&&(console.log(this.table.toString()),this.table.clear()))},PointerType:{PEN:"pen",MOUSE:"mouse",TOUCH:"touch"}};"object"==typeof window&&"undefined"==typeof PointerEvent&&(R=S);var A=R;class C extends y{constructor(e,t,r){super(e,t,r),this.red,this.green,this.blue,this.alpha,this.size,this.rotation,this.scaleX,this.scaleY,this.scaleZ,this.offsetX,this.offsetY,this.offsetZ,this.dX,this.dY}static createInstance(e,t,r=0,i={}){let s=Object.clone(i),n=r*e.length;e.forEach((e,r)=>C.setProperty(s,e,t[n+r]));let o=new C(s.x,s.y,s.z);return o.red=s.red,o.green=s.green,o.blue=s.blue,o.alpha=s.alpha,o.size=s.size,o.rotation=s.rotation||0,o.scaleX=s.scaleX||1,o.scaleY=s.scaleY||1,o.scaleZ=s.scaleZ||1,o.offsetX=s.offsetX||0,o.offsetY=s.offsetY||0,o.offsetZ=s.offsetZ||0,o.dX=s.dX,o.dY=s.dY,o}fill(e,t,r=0){let i=r*e.length;e.forEach((e,r)=>this.setProperty(e,t[i+r]))}getProperty(e){switch(e){case C.Property.X:return this.x;case C.Property.Y:return this.y;case C.Property.Z:return this.z;case C.Property.RED:return this.red;case C.Property.GREEN:return this.green;case C.Property.BLUE:return this.blue;case C.Property.ALPHA:return this.alpha;case C.Property.SIZE:return this.size;case C.Property.ROTATION:return this.rotation;case C.Property.SCALE_X:return this.scaleX;case C.Property.SCALE_Y:return this.scaleY;case C.Property.SCALE_Z:return this.scaleZ;case C.Property.OFFSET_X:return this.offsetX;case C.Property.OFFSET_Y:return this.offsetY;case C.Property.OFFSET_Z:return this.offsetZ;case C.Property.D_X:return this.dX;case C.Property.D_Y:return this.dY;default:throw console.warn(e),new Error("Invalid property found")}}setProperty(e,t){C.setProperty(this,e,t)}static setProperty(e,t,r){switch(t){case C.Property.X:e.x=r;break;case C.Property.Y:e.y=r;break;case C.Property.Z:e.z=r;break;case C.Property.RED:e.red=r;break;case C.Property.GREEN:e.green=r;break;case C.Property.BLUE:e.blue=r;break;case C.Property.ALPHA:e.alpha=r;break;case C.Property.SIZE:e.size=r;break;case C.Property.ROTATION:e.rotation=r;break;case C.Property.SCALE_X:e.scaleX=r;break;case C.Property.SCALE_Y:e.scaleY=r;break;case C.Property.SCALE_Z:e.scaleZ=r;break;case C.Property.OFFSET_X:e.offsetX=r;break;case C.Property.OFFSET_Y:e.offsetY=r;break;case C.Property.OFFSET_Z:e.offsetZ=r;break;case C.Property.D_X:e.dX=r;break;case C.Property.D_Y:e.dY=r;break;default:throw console.warn(t),new Error("Invalid property found")}}transform(e){if(!(e instanceof T))throw new Error(`matrix is instance of ${e.constructor.name} - it should be instance of Matrix. Use Matrix.fromMatrix method to convert.`);let t=e.scaleX,r=e.rotation,i=super.transform(e);this.x=i.x,this.y=i.y,this.z=i.z||0,this.size*=t,this.rotation+=r,this.scaleX*=t,this.scaleY*=t,this.scaleZ*=t,this.offsetX*=t,this.offsetY*=t,this.offsetZ*=t}toArray(e){return e.map(e=>{let t=this.getProperty(e);if(null==t||isNaN(t))throw new Error(`Property ${e.name} has invalid value ${t}`);return t})}debug(){let e=[];return C.Property.values.forEach(t=>{let r=this.getProperty(t);null!=r&&isFinite(r)&&e.push(t.name,this.getProperty(t))}),e}}C.createEnum("Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);let O=void 0;l.commonJS&&(O=require("systeminformation"));var D=O;class M extends f{constructor(){super(),this.props={}}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",f.getMD5Tokens(this.props)]}static async createInstance(e={}){let t=new M;if(t.props["env.name"]=l.type.name,void 0===D)t.props["user.agent"]=navigator.userAgent;else{let e=await D.osInfo();t.props["os.id"]=e.serial.toLowerCase(),t.props["os.name"]=e.codename,t.props["os.version"]=e.release,t.props["os.build"]=e.build,t.props["os.platform"]=`${e.distro} (${e.platform} ${e.arch})`}return Object.keys(e).forEach(r=>t.props[r]=e[r]),t}}const N=96/("undefined"==typeof window?1:window.devicePixelRatio),k={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*N},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*N},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*N},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*N},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*N},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*N},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*N},DIP:{METER:.0254/N,CENTIMETER:2.54/N,MILLIMETER:25.4/N,MICROMETER:25400/N,INCH:1/N,POINT:72/N,PICA:6/N,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Function.createEnum.call(k,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Function.createEnum.call(k,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);const L=Object.freeze({LENGTH:k.Unit.METER,TIME:k.Unit.SECOND,FORCE:k.Unit.NEWTON,ANGLE:k.Unit.RADIAN,NORMALIZED:k.Unit.NORMALIZED,LOGICAL:k.Unit.LOGICAL});k.getChannelResolution=function(e,t=1){let r=1,i=k.getUnitMetric(e);return i!=k.Metric.NORMALIZED&&i!=k.Metric.LOGICAL&&(r=k[L[i.name].name][e.name]/t),r},k.convert=function(e,t,r,i){return t?r*k[L[e.name].name][i.name]/t:r},k.convertAny=function(e,t,r,i){return e*k[t.name][r.name]/i},k.getUnitMetric=function(e){switch(e){case k.Unit.METER:case k.Unit.CENTIMETER:case k.Unit.MILLIMETER:case k.Unit.MICROMETER:case k.Unit.INCH:case k.Unit.POINT:case k.Unit.PICA:case k.Unit.DIP:return k.Metric.LENGTH;case k.Unit.SECOND:case k.Unit.MILLISECOND:case k.Unit.MICROSECOND:case k.Unit.NANOSECOND:return k.Metric.TIME;case k.Unit.RADIAN:case k.Unit.DEGREE:return k.Metric.ANGLE;case k.Unit.NEWTON:return k.Metric.FORCE;case k.Unit.NORMALIZED:return k.Metric.NORMALIZED;case k.Unit.LOGICAL:return k.Metric.LOGICAL;default:throw console.warn(e),new Error("Invalid unit found")}},k.getUnit=function(e){return L[e.name]},k.convertValue=function(e,t,r){return e*k[t.name][r.name]},Object.freeze(k);let _,F={longToByteArray(e){let t=[0,0,0,0,0,0,0,0];for(let r=0;r<t.length;r++){let i=255&e;t[r]=i,e=(e-i)/256}return t},byteArrayToLong(e){let t=0;for(let r=e.length-1;r>=0;r--)t=256*t+e[r];return t},crc32:function(){let e=new Uint32Array(256);for(let t=256;t--;){let r=t;for(let e=8;e--;)r=1&r?3988292384^r>>>1:r>>>1;e[t]=r}return function(t){let r=-1;for(let i=0,s=t.length;i<s;i++)r=r>>>8^e[255&r^t[i]];return(-1^r)>>>0}}(),mapTo:(e,t,r)=>r.min+(F.clamp(e,t)-t.min)/(t.max-t.min)*(r.max-r.min),clamp:(e,t)=>Math.min(Math.max(e,t.min),t.max),comparator(){let e=Array.prototype.slice.call(arguments),t=function(e,t,r){return t.replace("[",".").replace("]","").split(".").forEach(t=>e=e[t]),r?e.toLowerCase():e};return function(r,i){return e.map(e=>function(e,t,r){let i="asc"===r?1:-1;return e>t?1*i:e<t?-1*i:0}(t(r,e.sortBy,e.ignoreCase),t(i,e.sortBy,e.ignoreCase),e.sortOrder)).reduceRight((function(e,t){return t||e}))}},getPropName(e,t){let r=e.split("_"),i=r.first.toLowerCase();t&&(i=i.substring(0,1).toUpperCase()+i.substring(1));for(let e=1;e<r.length;e++)i+=r[e].substring(0,1),i+=r[e].substring(1).toLowerCase();return i},getEnumValueName(e){let t="";for(let r=0;r<e.length;r++)r>0&&e[r]!=e[r].toLowerCase()&&(t+="_"),t+=e[r];return t.toUpperCase()}};class B extends f{constructor(e,t,r,i,s){if(super(),t==B.Metric.DIMENSIONLESS)r=1;else if(isNaN(r)){let e=k.getUnit(t);r=k.getChannelResolution(e)}this.type=e,this.metric=t,this.resolution=r,this.min=i,this.max=s,e==B.Type.TIMESTAMP?this.precision=0:this.precision=2,Object.defineProperty(this,"name",{get:function(){return F.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}})}getMD5Message(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");let e=[];return e.push("SensorChannel"),e.push(this.context.inkProvider?this.context.inkProvider.id:""),e.push(this.context.device.id),e.push(this.type),e.push(this.metric.name),e.push(this.resolution.toFixed(4)),e.push((this.min||0).toFixed(4)),e.push((this.max||0).toFixed(4)),e.push(this.precision.toString()),e}static createCustomChannel(e,t,r,i,s,n){let o=new B(e,r,i,s,n);return o.precision=t,o}static createDefaultInstance(e,t){let r,i,s;switch(e){case B.Type.X:case B.Type.Y:case B.Type.Z:case B.Type.RADIUS_X:case B.Type.RADIUS_Y:r=k.Unit.DIP;break;case B.Type.TIMESTAMP:r=k.Unit.MILLISECOND;break;case B.Type.PRESSURE:r=k.Unit.NORMALIZED,i=0,s=1;break;case B.Type.ALTITUDE:case B.Type.AZIMUTH:case B.Type.ROTATION:r=k.Unit.RADIAN,i=0,s=2*Math.PI;break;default:console.error(`SensorChannel: createDefaultInstance fails with ${e} type`)}let n=k.getChannelResolution(r),o=k.getUnitMetric(r),a=new B(e,o,n,i,s);return a.unit=r,e!=B.Type.X&&e!=B.Type.Y||t.type!=g.Type.MOUSE||(a.precision=0),a}}B.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),B.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},B.Metric=k.Metric;class U extends f{constructor(e,t){super(),this.device=e.freeze(),this.inkProvider=Object.freeze(t);let r,i,s=[];Object.defineProperty(this,"channels",{get:function(){return s},set:function(e){this.invalidateID(),s=[],e.forEach(e=>this.add(e))},enumerable:!0}),Object.defineProperty(this,"layout",{get:function(){return s.map(e=>e.name)},set:function(e){this.invalidateID(),s=s.filter(t=>e.includes(t.name))},enumerable:!0}),Object.defineProperty(this,"samplingRate",{get:function(){return r},set:function(e){this.invalidateID(),r=e},enumerable:!0}),Object.defineProperty(this,"latency",{get:function(){return i},set:function(e){this.invalidateID(),i=e},enumerable:!0})}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");let e=["SensorChannelsContext",...this.channels.map(e=>e.id)];return e.push(this.samplingRate||""),e.push(this.latency||""),e.push(this.inkProvider?this.inkProvider.id:""),e.push(this.device.id),e}add(e){if((e.type==B.Type.X||e.type==B.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");e.context=this,Object.freeze(e),this.channels.push(e)}get(e){return this.channels.filter(t=>t.id==e).first}static createDefaultInstance(e,t){let r=new U(e,t);return r.channels=B.defaults[t.type.name].map(e=>B.createDefaultInstance(B.Type[e],t)),r}}class j extends f{constructor(){super();let e=[];Object.defineProperty(this,"channelsContexts",{get:function(){return e},set:function(t){this.invalidateID(),e=t},enumerable:!0})}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext",...this.channelsContexts.map(e=>e.id)]}addContext(e){if(!this.channelsContexts.includes(e)){if(this.channelsContexts.filter(t=>t.device==e.device).length>0)throw new Error(`Already exists channelsContext with device ${e.device.id}. Device should be unique in scope of SensorContext.`);e.inkProvider&&(this.inkChannelsContext=e),Object.freeze(e),this.channelsContexts.push(e)}}getContext(e){return this.channelsContexts.filter(t=>t.id==e).first}getContextByChannelID(e){return this.channelsContexts.filter(t=>t.get(e)).first}static createDefaultInstance(e,t){let r=new j;return r.addContext(U.createDefaultInstance(e,t)),r}}class G extends f{constructor(e,t){super(),this.environment=Object.freeze(e),this.sensorContext=Object.freeze(t)}getMD5Message(){return["InputContext",this.environment.id,this.sensorContext.id]}addChannelsContext(e){this.sensorContext.addContext(e)}static createDefaultInstance(e,t,r){let i=j.createDefaultInstance(t,r);return new G(e,i)}}class z extends f{constructor(e){super(),this.created=Date.now(),this.inkState=z.InkState.PLANE,this.context=e,this.streams=[]}add(e){if(!this.context.sensorContext.getContextByChannelID(e.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");e.ink&&(this.inkStream=e),this.streams.push(e)}}z.createEnum("InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);class Y{constructor(e){this.channels=e,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:e.map(e=>e.name),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}add(e,t){t&&this.ignoredIndex.push(this.length),this.channels.forEach(t=>{let r=F.getPropName(t.name),i=e[r];if(t.type==B.Type.ALTITUDE&&!("altitude"in e))throw new Error("SensorStream input data do not provides altitude");if(t.type==B.Type.AZIMUTH&&!("azimuth"in e))throw new Error("SensorStream input data do not provides azimuth");this.data.push(i)})}get(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t={};for(let r=0;r<this.stride;r++){let i=this.channels[r],s=F.getPropName(i.name),n=e*this.stride;t[s]=this.data[n+r]}return t}getPipelineMapping(){let e=[];if(this.ignoredIndex.length>0)for(let t=0;t<this.length;t++)this.ignoredIndex.includes(t)||e.push(t);return e}}class X extends f{constructor(){super(),this.props={},this.devices=[]}freeze(){return Object.freeze(this.props),this}getMD5Message(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",f.getMD5Tokens(this.props)]}link(e){this.devices.push(e)}getInkInputProvider(e){return new g(e)}getInkSensorContext(e){let t=this.getInkInputProvider(e);return j.createDefaultInstance(this,t)}openStream(e){if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");let t=g.Type[e.pointer.type.toUpperCase()],r=this.getInkSensorContext(t),i=new G(this.environment,r);r.inkChannelsContext.layout=X.getLayout(e),this.sensorData=new z(i),this.sensorData.add(new Y(r.inkChannelsContext.channels)),this.sampleTimestamp=e.timestamp,this.devices.forEach(e=>e.openStream(this.sensorData))}add(e,t){if(!this.sensorData)throw new Error("Open ink stream not found");this.sensorData.inkStream.add(Object.assign({},e,{timestamp:e.timestamp-this.sampleTimestamp}),t)}closeStream(e){let t=this.sensorData;return this.devices.forEach(t=>t.closeStream(e)),this.sensorData=null,this.sampleTimestamp=0,e?null:t}static getLayout(e){let t=[];return Object.keys(B.Type).forEach(r=>{let i,s=B.Type[r];i=s==B.Type.ALTITUDE?"tiltX":s==B.Type.AZIMUTH?"tiltY":F.getPropName(r),X.isValidInput(i,e)&&t.push(r)}),t}static isValidInput(e,t){let r=!1;return isFinite(t[e])&&(r=!0,"pressure"==e?(r=t.pressure>0&&"mouse"!=t.pointer.type,r&&"touch"==t.pointer.type&&(r=.5!==t.pressure&&1!==t.pressure)):"tiltX"==e||"tiltY"==e?r=0!=t.tiltX||0!=t.tiltY:"radiusX"==e||"radiusY"==e?r=t.radiusX!=t.radiusY||parseInt(t.radiusX)!=t.radiusX:"rotation"==e&&(r=0!=t.rotation)),r}static async createInstance(e){let t=new this(...Array.from(arguments).slice(1));if(void 0===D)t.props["dev.graphics.resolution"]=`${screen.width}x${screen.height}`;else{let e=await D.system(),r=await D.cpu(),i=await D.graphics(),s=i.displays.filter(e=>e.main)[0],n=i.controllers[0];t.props["dev.id"]=e.uuid.toLowerCase(),t.props["dev.manufacturer"]=e.manufacturer,t.props["dev.model"]=e.model,t.props["dev.cpu"]=`${r.manufacturer} ${r.brand} ${r.speed} - ${r.cores} core(s)`,t.props["dev.graphics.display"]=`${s.model} ${s.currentResX}x${s.currentResY} (${s.pixeldepth} bit)`,t.props["dev.graphics.adapter"]=`${n.model} ${n.vram} GB`}return t.environment=await M.createInstance(e),t}}class V{static createCircle(e=20,t=1,r={x:0,y:0}){return V.createEllipse(e,t,t,r)}static createEllipse(e=20,t=1,r=.5,i={x:0,y:0}){let s=[],n=2*Math.PI/e;for(let o=0;o<e;o++){let e=o*n,a=t*Math.cos(e),h=r*Math.sin(e);s.push(i.x+a,i.y+h)}return s.toFloat32Array()}static createStar(e=5,t=.5){let r=[],i=2*Math.PI/e;for(let s=0;s<e;s++){let e=s*i,n=1*Math.cos(e),o=1*Math.sin(e),a=t*Math.cos(e+i/2),h=t*Math.sin(e+i/2);r.push(n,o,a,h)}return r.toFloat32Array()}}class ${constructor(e,t,r,i=1){this.red=e,this.green=t,this.blue=r,this.alpha=i}premultiply(){let e=this.red/255*this.alpha,t=this.green/255*this.alpha,r=this.blue/255*this.alpha;return new $(e,t,r,this.alpha)}postdivide(e,t,r,i){let s=parseInt(255*e/i),n=parseInt(255*t/i),o=parseInt(255*r/i);return new $(s,n,o,i)}equals(e){return e&&this.red==e.red&&this.green==e.green&&this.blue==e.blue&&this.alpha==e.alpha}toRGB(){return 1==this.alpha?this:new $(this.red,this.green,this.blue)}toRGBA(e){return new $(this.red,this.green,this.blue,e)}toHSLA(){let e=this.red/255,t=this.green/255,r=this.blue/255,i=Math.min(e,t,r),s=Math.max(e,t,r),n=0,o=0,a=(s+i)/2;if(s!=i){let h=s-i;switch(o=h/(1-Math.abs(2*a-1)),s){case e:n=(t-r)/h%6;break;case t:n=(r-e)/h+2;break;case r:n=(e-t)/h+4}}return n*=60,n<0&&(n+=360),{hue:parseFloat(n.toFixed(0)),saturation:parseFloat((100*o).toFixed(2)),lightness:parseFloat((100*a).toFixed(2)),alpha:this.alpha}}toArray(){return[this.red,this.green,this.blue,this.alpha]}toJSON(){return{red:this.red,green:this.green,blue:this.blue,alpha:this.alpha}}toString(){return 1==this.alpha?`rgb(${this.red}, ${this.green}, ${this.blue})`:`rgba(${this.red}, ${this.green}, ${this.blue}, ${this.alpha})`}static isColor(e){return e&&isFinite(e.red)&&isFinite(e.green)&&isFinite(e.blue)}static fromColor(e){let t,r,i,s;if("string"==typeof e){if(!e.startsWith("rgb")){if(e.startsWith("#"))return e=e.substring(1),new $(parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16));throw new Error(`Unknown input found: ${e}. Expected data starts with rgba, rgb or #.`)}e=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),t=parseInt(e[0]),r=parseInt(e[1]),i=parseInt(e[2]),s=e[3]?parseInt(e[3]):1}else Array.isArray(e)?(t=e[0],r=e[1],i=e[2],s=e[3]):(t=e.red,r=e.green,i=e.blue,s=e.alpha);return new $(t,r,i,s)}static fromHSLA(e=0,t=0,r=0,i){e/=60,t/=100,r/=100;let s=(1-Math.abs(2*r-1))*t,n=s*(1-Math.abs(e%2-1)),o=0,a=0,h=0;e>=0&&e<1?(o=s,a=n):e>=1&&e<2?(o=n,a=s):e>=2&&e<3?(a=s,h=n):e>=3&&e<4?(a=n,h=s):e>=4&&e<5?(o=n,h=s):(o=s,h=n);let l=r-s/2;return o+=l,a+=l,h+=l,new $(Math.round(255*o),Math.round(255*a),Math.round(255*h),i)}static random(e){return new $(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),e?Math.random():1)}}$.TRANSPERENT=new $(0,0,0,0),$.BLACK=new $(0,0,0,1),$.WHITE=new $(255,255,255,1),$.RED=new $(255,0,0,1),$.GREEN=new $(0,255,0,1),$.BLUE=new $(0,0,255,1);class H{constructor(e,t,r,i){let s=e,n=t,o=e+r,a=t+i;Object.defineProperties(this,{left:{value:s,enumerable:!0},x:{value:e,enumerable:!0},bottom:{value:n,enumerable:!0},y:{value:t,enumerable:!0},right:{value:o,enumerable:!0},top:{value:a,enumerable:!0},width:{value:r,enumerable:!0},height:{value:i,enumerable:!0}})}union(e){if(e&&!(e instanceof H))throw new TypeError("rect must be instance of RectGL");return e?H.ofEdges(Math.min(this.left,e.left),Math.min(this.bottom,e.bottom),Math.max(this.right,e.right),Math.max(this.top,e.top)):this}intersect(e){if(e&&!(e instanceof H))throw new TypeError("rect must be instance of RectGL");if(!e)return null;let t=H.ofEdges(Math.max(this.left,e.left),Math.max(this.bottom,e.bottom),Math.min(this.right,e.right),Math.min(this.top,e.top));return t.width>0&&t.height>0?t:null}ceil(){return H.ofEdges(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}floor(){return H.ofEdges(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}toQuad(e){let t;if(e){let r=y.fromPoint({x:this.left,y:this.bottom}).transform(e),i=y.fromPoint({x:this.right,y:this.bottom}).transform(e),n=y.fromPoint({x:this.left,y:this.top}).transform(e),o=y.fromPoint({x:this.right,y:this.top}).transform(e);t=s.fromValues(r.x,r.y,i.x,i.y,n.x,n.y,o.x,o.y)}else t=s.fromValues(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return t}toString(){return`gl-rect(${this.x}, ${this.y}, ${this.width}, ${this.height})`}static ofEdges(e,t,r,i){return new H(e,t,r-e,i-t)}static calculateBrushGLSegmentBounds(e,t=0,r){let i,s=.5*e.size,n=Math.abs(t*s);if(r){i=new y(e.x,e.y,e.x,e.z).transform(r)}else i=e;let o=i.x,a=i.y,h=e.scaleX*s,l=e.scaleY*s,u=e.offsetX,d=-e.offsetY,c=Math.cos(e.rotation),p=Math.sin(e.rotation),f=Number.MAX_SAFE_INTEGER,g=Number.MIN_SAFE_INTEGER,m=Number.MAX_SAFE_INTEGER,b=Number.MIN_SAFE_INTEGER;return[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}].forEach(e=>{e.x=e.x*h+u,e.y=e.y*l+d;let t=c*e.x+p*e.y+o,r=-p*e.x+c*e.y+a,i=t-n;f=Math.min(f,i),g=Math.max(g,i),i=t+n,f=Math.min(f,i),g=Math.max(g,i);let s=r-n;m=Math.min(m,s),b=Math.max(b,s),s=r+n,m=Math.min(m,s),b=Math.max(b,s)}),H.ofEdges(f,m,g,b)}}Object.defineProperty(H,"SQURE",{value:Object.freeze([Object.freeze({x:-1,y:-1}),Object.freeze({x:1,y:-1}),Object.freeze({x:-1,y:1}),Object.freeze({x:1,y:1})]),enumerable:!0});class q{constructor(e,t,r,i){let s=e,n=t,o=e+r,a=t+i,h={x:(s+o)/2,y:(n+a)/2};Object.defineProperties(this,{left:{value:s,enumerable:!0},top:{value:n,enumerable:!0},right:{value:o,enumerable:!0},bottom:{value:a,enumerable:!0},x:{value:e,enumerable:!0},y:{value:t,enumerable:!0},width:{value:r,enumerable:!0},height:{value:i,enumerable:!0},center:{value:h,enumerable:!0},size:{value:{width:r,height:i},enumerable:!0}})}union(e){return e?q.ofEdges(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right),Math.max(this.bottom,e.bottom)):this}intersect(e){if(!e)return null;let t=q.ofEdges(Math.max(this.left,e.left),Math.max(this.top,e.top),Math.min(this.right,e.right),Math.min(this.bottom,e.bottom));return t.width>0&&t.height>0?t:null}ceil(e){let t=Math.floor(this.left),r=Math.floor(this.top),i=Math.ceil(this.right),s=Math.ceil(this.bottom);if(e){let e=i-t,n=s-r;e+=e%2,n+=n%2,i=t+e,s=r+n}return q.ofEdges(t,r,i,s)}floor(e){let t=Math.ceil(this.left),r=Math.ceil(this.top),i=Math.floor(this.right),s=Math.floor(this.bottom);if(e){let e=i-t,n=s-r;e-=e%2,n-=n%2,i=t+e,s=r+n}return q.ofEdges(t,r,i,s)}contains(e){return this.left<=e.x&&this.right>=e.x&&this.top<=e.y&&this.bottom>=e.y}transform(e){if(!e)return this;let t=y.fromPoint({x:this.left,y:this.top}).transform(e),r=y.fromPoint({x:this.right,y:this.top}).transform(e),i=y.fromPoint({x:this.left,y:this.bottom}).transform(e),s=y.fromPoint({x:this.right,y:this.bottom}).transform(e),n=Math.min(t.x,r.x,i.x,s.x),o=Math.min(t.y,r.y,i.y,s.y),a=Math.max(t.x,r.x,i.x,s.x),h=Math.max(t.y,r.y,i.y,s.y);return q.ofEdges(n,o,a,h)}toPath(e=$.BLACK,t=1){return{layout:[C.Property.X,C.Property.Y],size:t,color:e,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}toGLRect(){return new H(this.x,this.y,this.width,this.height)}toString(){return`rect(${this.x}, ${this.y}, ${this.width}, ${this.height})`}toJSON(){return{x:this.left,y:this.top,width:this.width,height:this.height}}static fromGLRect(e){if(!e)return null;if(!(e instanceof H))throw new TypeError("rect must be instance of RectGL");return new q(e.left,e.bottom,e.width,e.height)}static isRect(e){return e&&isFinite(e.left)&&isFinite(e.top)&&isFinite(e.width)&&isFinite(e.height)}static fromRect(e){return new q(e.x,e.y,e.width,e.height)}static ofPolygon(e){return q.ofPolygons([e])}static ofPolygons(e){if(!e.length)return null;let t=Number.MAX_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;return e.forEach(e=>{for(let n=0;n<e.length;n+=2){let o=e[n],a=e[n+1];t=Math.min(t,o),r=Math.min(r,a),i=Math.max(i,o),s=Math.max(s,a)}}),q.ofEdges(t,r,i,s)}static ofSpline(e,t){let r;for(let i=0;i<e.length;i++)r=H.calculateBrushGLSegmentBounds(e.getPoint(i),t).union(r);return q.fromGLRect(r)}static ofEdges(e,t,r,i){return new q(e,t,r-e,i-t)}static union(e,t){return e?t?e.union(t):e:t}static intersect(e,t){return e&&t?e.intersect(t):null}}class Z{constructor(){if(_)throw new Error("URIResolver instance already available");_=this,this.init()}init(){throw new Error("URIResolver: init should be implemented")}get(e){return this[e]}register(e,t){this[e]=t}resolve(e){let t;if(e.includes("?")){let r=this[e.split("?")[0]];if(r){let i=e.split("?")[1],s=[];i.split("&").forEach(e=>{let t=e.split("=")[1],r=parseFloat(t);isFinite(r)?t=r:"true"==t?t=!0:"false"==t&&(t=!1),s.push(t)}),t=function(){return r(...Array.from(arguments).concat(s))}}}else t=this[e];if(!t)throw new Error("Failed to resolve "+e);return t}}Object.defineProperty(Z,"instance",{get:()=>_,enumerable:!0});class W{static encode(e,t=W.Encoding.AUTO){let r;if(t==W.Encoding.AUTO&&(t="undefined"==typeof Buffer?W.Encoding.ARRAY:W.Encoding.BUFFER),t==W.Encoding.NONE)r=e;else if(t==W.Encoding.ARRAY)r=e.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");let i=Buffer.from(e.buffer);switch(t){case W.Encoding.BUFFER:r=i.toJSON();break;case W.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: "+t.name)}}return{encoding:t.name,type:e.constructor.name,points:r}}static decode(e){let t,r=W.Encoding[e.encoding];if(r==W.Encoding.NONE)t=e.points;else if(r==W.Encoding.ARRAY)t=e.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");let i;switch(r){case W.Encoding.BUFFER:i=Buffer.from(e.points);break;case W.Encoding.BASE64:i=Buffer.from(e.points,"base64");break;default:throw new Error("Invalid encoding provided: "+r.name)}let s=new Uint8Array(i);t=new globalThis[e.type](s.buffer)}return t}static isTypedArrayData(e){return e&&e.encoding&&e.type&&e.type.endsWith("Array")}}W.createEnum("Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);class K{constructor(e,t){this.name=e,Object.defineProperty(this,"value",{get:function(){if(!t){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(t=this.resolve(this.name)),!t){if(!Z.instance)throw new Error(`Resource URI ${this.name} cannot be resolved. URIResolver not implemented yet. Please implement and instantiate.`);t=Z.instance.resolve(this.name)}if(!t)throw new Error(`Resource URI ${this.name} cannot be resolved. Please provide resource definition in URIResolver init implementation.`)}return t},set:function(e){t=e},enumerable:!0})}toJSON(){let e=this.value;return ArrayBuffer.isTypedArray(e)?e=W.encode(e,this.encoding):"function"==typeof e&&(e=e()),{name:this.name,value:e}}static fromJSON(e){let t=e.value;return W.isTypedArrayData(t)&&(t=W.decode(t)),new K(e.name,t)}static getInstance(e,t){return new K(t,e)}}class J{constructor(e,t=0){this.size=t,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return e||("function"==typeof(e=this.descriptor.shape.value)&&(e=e()),J.fitShape(e)),e},set:function(t){if(!t)throw new Error("BrushPrototype: shape not found");Array.isArray(t)&&(t=t.toFloat32Array()),"string"==typeof t?t=new K(t):t instanceof Float32Array?t=K.getInstance(t):t instanceof K||(t=new K(t.name,t.value)),e=null,this.descriptor.shape=t,this.descriptor.shape.resolve=J.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:()=>this.encoding,enumerable:!0})},enumerable:!0}),this.shape=e}toJSON(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}static fromJSON(e){let t=K.fromJSON(e.shape);return new J(t,e.size)}static create(e,t=0,...r){let i,s=e;switch(e){case J.Type.CIRCLE:i=V.createCircle(...r),s+=`?precision=${r[0]||""}&radius=${r[1]||""}`;break;case J.Type.ELLIPSE:i=V.createEllipse(...r),s+=`?precision=${r[0]||""}&radiusX=${r[1]||""}&radiusY=${r[2]||""}`;break;case J.Type.STAR:i=V.createStar(...r),s+=`?points=${r[0]||""}&internalRadius=${r[1]||""}`;break;default:console.error(`Brush2D: createShape fails with ${e} type`)}return new J({name:s,shape:i},t)}static resolve(e){let t,r=e.split("?"),i=r.first;if(Object.values(J.Type).includes(i)){let e=r.last.split("&"),s={};switch(e.forEach(e=>{s[e.substring(0,e.indexOf("="))]=e.substring(e.indexOf("=")+1)}),i){case J.Type.CIRCLE:{let e=s.precision?parseInt(s.precision):void 0;t=V.createCircle(e);break}case J.Type.ELLIPSE:{let e=s.precision?parseInt(s.precision):void 0,r=s.radiusX?parseFloat(s.radiusX):void 0,i=s.radiusY?parseFloat(s.radiusY):void 0;t=V.createEllipse(e,r,i);break}case J.Type.STAR:{let e=s.points?parseInt(s.points):void 0,r=s.internalRadius?parseFloat(s.internalRadius):void 0;t=V.createStar(e,r);break}default:console.error(`Brush2D: createShape fails with ${i} type`)}}return t}static fitShape(e){J.centerShape(e);let t=q.ofEdges(-1,-1,1,1),r=q.ofPolygon(e),i=t.width/r.width,s=t.height/r.height,n=i>0&&s>0?Math.min(i,s):Math.max(i,s);for(let t=0;t<e.length;t+=2)e[t]*=n,e[t+1]*=n}static centerShape(e){let t=q.ofPolygon(e);for(let r=0;r<e.length;r+=2)e[r]-=t.center.x,e[r+1]-=t.center.y}}async function Q(e,t="binary"){if(e instanceof Uint8Array)return e;let r,i=await fetch(e,{mode:"no-cors"});if("json"==t)r=await i.json();else if("text"==t)r=await i.text();else if("blob"==t)r=await i.blob();else{let e=await i.arrayBuffer();r=new Uint8Array(e)}return r}async function ee(e){let t;return t="string"==typeof e||"undefined"==typeof createImageBitmap?await function(e){return new Promise((t,r)=>{let i,s=new Image;s.crossOrigin="anonymous",s.onload=()=>{if(l.type2D==l.Type2D.OFFSCREEN){const e=new OffscreenCanvas(s.width,s.height);e.getContext("2d").drawImage(s,0,0),t(e)}else i&&URL.revokeObjectURL(i),t(s)},s.onerror=r,"string"==typeof e?s.src=e:l.type2D==l.Type2D.OFFSCREEN?e instanceof Uint8Array?s.src=Buffer.from(e):e instanceof OffscreenCanvas?t(e):s.src=e:(e instanceof Uint8Array&&(e=e.buffer),e instanceof ArrayBuffer&&(e=new Blob([e],{type:"image/png"})),i=URL.createObjectURL(e),s.src=i)})}(e):e instanceof ArrayBuffer||e instanceof Uint8Array?await createImageBitmap(new Blob([e],{type:"image/png"})):await createImageBitmap(e),t}J.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var te=Object.freeze({__proto__:null,loadFile:Q,loadImage:ee,saveAs:function(e,t,r="application/octet-stream"){let i;if(e instanceof Blob)i=URL.createObjectURL(e);else{let t;e instanceof ArrayBuffer?t=[e]:e.buffer?(e.byteLength<e.buffer.byteLength&&(e=new Uint8Array(e)),t=[e.buffer]):e instanceof Array&&(t=e);let s=new Blob(t,{type:r});i=URL.createObjectURL(s)}let s=document.createElement("a");s.href=i,s.download=t,s.appendChild(document.createTextNode(t)),s.style.display="none",document.body.appendChild(s),s.click(),setTimeout((function(){URL.revokeObjectURL(i),s.remove()}),911)}});class re{constructor(e,t,r,i=1){isFinite(r)&&(i=r,r=void 0),i<=0&&(console.warn(`Invalid spacing found ${i}. It should be positive number.`),i=1),this.name=e,Object.defineProperty(this,"shape",{get:function(){return t},set:function(e){if(e instanceof Float32Array&&(e=new J(e)),!this.validate(e))throw console.warn(e),new Error("Brush2D: Invalid shape found");Array.isArray(e)&&(1==e.length?e=e.first:e.sort(F.comparator({sortBy:"size",sortOrder:"asc"}))),t=e},enumerable:!0}),this.shape=t,this.fill=r,this.spacing=i,Object.defineProperty(this,"encoding",{get:function(){},set:function(e){if(Array.isArray(this.shape))for(let t of this.shape)t.encoding=e;else this.shape.encoding=e},enumerable:!0})}validate(e){let t=!1;if(Array.isArray(e)){for(let r of e)if(t=r instanceof J,!t)break}else t=e instanceof J;return t}async configure(e){if(this.pattern||!this.fill)return;if(!(e instanceof CanvasRenderingContext2D||e instanceof OffscreenCanvasRenderingContext2D))throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");let t=await ee(this.fill);this.pattern=e.createPattern(t,"repeat")}selectShape(e){let t;if(Array.isArray(this.shape)){for(let r=1;r<this.shape.length;r++)if(this.shape[r].size>e){t=this.shape[r-1];break}t||(t=this.shape.last)}else t=this.shape;return t.shape}toJSON(){let e=Array.isArray(this.shape)?this.shape:[this.shape];return{type:this.constructor.name,name:this.name,spacing:this.spacing,shape:e.map(e=>e.toJSON())}}static fromJSON(e){let t=1==e.shape.length?J.fromJSON(e.shape[0]):e.shape.map(e=>J.fromJSON(e));return new re(e.name,t,e.spacing)}}class ie{static get excludedProps(){return[C.Property.D_X,C.Property.D_Y]}static get posProps(){return[C.Property.X,C.Property.Y,C.Property.Z]}static get colorProps(){return[C.Property.RED,C.Property.GREEN,C.Property.BLUE,C.Property.ALPHA]}static get transformProps(){return[C.Property.ROTATION,C.Property.SCALE_X,C.Property.SCALE_Y,C.Property.SCALE_Z,C.Property.OFFSET_X,C.Property.OFFSET_Y,C.Property.OFFSET_Z]}constructor(){this.state={}}isLayoutPart(e){if(ie.posProps.includes(e))return this.inputLayout.includes(e.name);if(this.brush instanceof re&&ie.colorProps.includes(e))return!1;if(ie.excludedProps.includes(e))return!1;if(this.basicMode&&ie.transformProps.includes(e))return!1;let t=!1,r=F.getPropName(e.name),i=this.dynamics[r];if(i&&!i.disabled)if(i.dependencies&&i.dependencies.length>0){let e=this.inputLayout.map(e=>B.Type[e]);t=i.dependencies.filter(t=>e.includes(t)).length>0}else t=!0;return t}calculate(e,t,r){this.point=t.createPathPoint();for(let e in this.statics)this.point[e]=this.statics[e];return this.calculateProperty(C.Property.SIZE,e,t,r),ie.colorProps.forEach(i=>this.calculateProperty(i,e,t,r)),ie.transformProps.forEach(i=>this.calculateTransform(i,e,t,r)),this.point}calculateProperty(e,t,r,i){if(!this.layout.includes(e))return;let s,n=F.getPropName(e.name),o=this.dynamics[n],a=this.state[n];if("function"==typeof a.resolve)s=a.resolve(t,r,i);else if(this.inputLayout.includes("PRESSURE")){let e=r.pressure||t.pressure/2;s=ie.mapTo(e,a.pressure,o.value)}else{let e=r.speed(t,i);s=ie.mapTo(e,a.velocity,o.value)}this.point[F.getPropName(e.name)]=s}calculateTransform(e,t,r,i){if(!this.layout.includes(e))return;let s,n=F.getPropName(e.name),o=this.dynamics[n],a=this.state[n];if("function"==typeof a.resolve)s=a.resolve(t,r,i);else{let i=o.dependencies||[];if(e==C.Property.ROTATION)if(i.includes(B.Type.ROTATION)&&this.inputLayout.includes("ROTATION"))s=r.rotation;else{if(!i.includes(B.Type.AZIMUTH)||!this.inputLayout.includes("AZIMUTH"))throw new Error(`Property ${e.name} is not configured properly. Dependencies are expected or resolve handler.`);s=r.computeNearestAzimuthAngle(t)}else if(i.includes(B.Type.ALTITUDE)&&this.inputLayout.includes("ALTITUDE")){r.cosAltitude||(r.cosAltitude=Math.cos(r.altitude));let e=r.cosAltitude;s=ie.mapTo(e,a.altitude,o.value)}else{if(e!=C.Property.SCALE_X&&e!=C.Property.SCALE_Y||!i.includes(B.Type.RADIUS_X)&&!i.includes(B.Type.RADIUS_Y)||!this.inputLayout.includes("RADIUS_X")||!this.inputLayout.includes("RADIUS_Y"))throw new Error(`Property ${e.name} is not configured properly. Dependencies are expected or resolve handler.`);{let t=e==C.Property.SCALE_X?"radiusX":"radiusY",i=r[t];s=ie.mapTo(i,a[t],o.value)}}}if(isNaN(s))throw new Error(`Property ${e.name} has no value`);this.point[F.getPropName(e.name)]=s}reset(e,t,r,i={},s={}){if(this.brush=t,this.dynamics=i,this.statics={},this.color=new $(0,0,0),this.inputLayout=X.getLayout(e),this.layout=C.Property.values.filter(e=>this.isLayoutPart(e)),this.debug&&console.log(e.pointer.type,this.inputLayout,this.layout.map(e=>e.name),e),"size"in s){if(this.isLayoutPart(C.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=s.size}else{if(!this.isLayoutPart(C.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");if(0==e.pressure&&"pen"==e.pointer.type)throw new Error("Hover point detected. Should be handeled manually.")}ie.colorProps.forEach(e=>{let t=F.getPropName(e.name);this.isLayoutPart(e)?this.color[t]=r[t]:(this.statics[t]=isFinite(s[t])?s[t]:r[t],this.color[t]=this.statics[t])}),ie.transformProps.forEach(e=>{if(this.isLayoutPart(e))return;let t=F.getPropName(e.name);isFinite(s[t])&&(this.statics[t]=s[t])}),this.resetState(e)}resetState(e){this.state={},[C.Property.SIZE].concat(ie.colorProps).forEach(e=>{if(!this.layout.includes(e))return;let t=F.getPropName(e.name),r=this.dynamics[t],i={};if(r.resolve)i.resolve=ie.resolveAction(r.resolve);else{if(!r.value)throw new Error(`PathPointContext: dynamics ${t} value property not found`);let e=this.clonePropertySettings(r.velocity,0,4e3);e.remap=ie.resolveAction(e.remap||r.value.remap);let s=this.clonePropertySettings(r.pressure,0,1);s.remap=ie.resolveAction(s.remap||r.value.remap),i.velocity=ie.validateRange(t,e,{min:0,max:3e4}),i.pressure=ie.validateRange(t,s,{min:0,max:1})}this.state[t]=i}),ie.transformProps.forEach(t=>{if(!this.layout.includes(t))return;let r=F.getPropName(t.name),i=this.dynamics[r],s={};if(i.resolve)s.resolve=ie.resolveAction(i.resolve);else if(i.dependencies){if(i.dependencies.includes(B.Type.ALTITUDE)){if(!i.value)throw new Error(`PathPointContext: dynamics ${r} value property not found`);let e=this.clonePropertySettings(i.altitude,0,Math.PI/2);e.remap=ie.resolveAction(e.remap||i.value.remap),s.altitude=ie.validateRange(r,e,{min:0,max:Math.PI/2})}if(t==C.Property.SCALE_X&&i.dependencies.includes(B.Type.RADIUS_X)||t==C.Property.SCALE_Y&&i.dependencies.includes(B.Type.RADIUS_Y)){if(!i.value)throw new Error(`PathPointContext: dynamics ${r} value property not found`);let n=t==C.Property.SCALE_X?"radiusX":"radiusY",o=e[n]<=1?0:1,a=e[n]<=1?1:50,h=e[n]<=1?{min:0,max:1,remap:i[n].remap}:i[n],l=this.clonePropertySettings(h,o,a);l.remap=ie.resolveAction(l.remap||i.value.remap),s[n]=ie.validateRange(r,l,{min:o,max:a})}}this.state[r]=s})}clonePropertySettings(e,t,r){let i;return e?(i=Object.clone(e),"min"in i||(i.min=t),"max"in i||(i.max=r)):i={min:t,max:r},i}static resolveAction(e){if(e)return"string"==typeof e?e=new K(e):"function"==typeof e?e=K.getInstance(e):e instanceof K||(e=new K(e.name,e.value)),e.value}static validateRange(e,t,r){if(t.min<r.min||t.max>r.max)throw new Error(`${e} config is out of range - (${t.min}, ${t.max}), expected values interval - (${r.min}, ${r.max})`);if(t.min>t.max)throw new Error(`${e} min ${t.min} exceeds max ${t.max}`);return t}static mapTo(e,t,r){let i=(F.clamp(e,t)-t.min)/(t.max-t.min);return t.remap&&(i=t.remap(i)),r.min+i*(r.max-r.min)}}let se;se=l.commonJS?require("clipper-lib"):ClipperLib;const{Clipper:ne,Paths:oe,Path:ae,ClipType:he,PolyType:le,PolyFillType:ue}=se;class de{constructor(e){let t=new oe;"number"==typeof e[0]&&(e=[e]);let r=q.ofPolygons(e),i=65534/(r.width+1e-16),s=65534/(r.height+1e-16),n=Math.floor(Math.min(i,s)),o=r.left+32767/n,a=r.top+32767/n;e.forEach(e=>{let r=new ae;for(let t=0;t<e.length;t+=2){let i=(e[t]-o)*n,s=(e[t+1]-a)*n,h=i<0?Math.ceil(i):Math.floor(i),l=s<0?Math.ceil(s):Math.floor(s);r.push({X:h,Y:l})}t.push(r)}),this.subject=t,this.solution=new oe,this.bounds=r,this.transform={scale:n,offsetX:o,offsetY:a},this.filter=new Set}toPath2D(e){let t=[];return this.lastPoint={},this.lastSize=0,this.solution.forEach(r=>{let i=this.flatPath(r,e);i.length>0&&t.push(i)}),this.filter.clear(),t}flatPath(e,t){let r=[];return e.forEach((e,i)=>{t?(this.filter.add(`${e.X}-${e.Y}`),this.filter.size>this.lastSize?(r.push(e.X/this.transform.scale+this.transform.offsetX,e.Y/this.transform.scale+this.transform.offsetY),this.lastSize++):this.debug&&console.warn(`Duplicate point detected: {${e.X}, ${e.Y}}`)):this.lastPoint.X!=e.X||this.lastPoint.Y!=e.Y?(r.push(e.X/this.transform.scale+this.transform.offsetX,e.Y/this.transform.scale+this.transform.offsetY),this.lastPoint=e):this.debug&&console.warn(`Duplicate point detected: {${e.X}, ${e.Y}}`)}),r.length<6&&(this.debug&&console.warn(`Invalid contour found: [${r.join(", ")}]`),r.clear()),r}apply(e){let t=new oe;return"number"==typeof e[0]&&(e=[e]),e.forEach(e=>{let r=new ae;for(let t=0;t<e.length;t+=2){let i=(e[t]-this.transform.offsetX)*this.transform.scale,s=(e[t+1]-this.transform.offsetY)*this.transform.scale,n=i<0?Math.ceil(i):Math.floor(i),o=s<0?Math.ceil(s):Math.floor(s);r.push({X:n,Y:o})}t.push(r)}),t}}class ce{constructor(e,t,r={},i=0,s=1){Array.isArray(t)&&(t=ce.allocateBuffer(t)),Object.defineProperty(this,"layout",{value:e,enumerable:!0}),Object.defineProperty(this,"points",{get:()=>t,enumerable:!0}),Object.defineProperty(this,"stride",{value:e.length,enumerable:!0}),Object.defineProperty(this,"length",{value:t.length/e.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:r,enumerable:!0}),this.ts=i,this.tf=s,Object.defineProperty(this,"bounds",{get:()=>q.ofSpline(this,this.pointProps.scattering).ceil(),enumerable:!0}),this.restoreBuffer=e=>{if("undefined"!=typeof SharedArrayBuffer&&this.points.buffer instanceof SharedArrayBuffer)throw new Error("Underlying buffer is SharedArrayBuffer and cannot be restored");if(t.buffer.byteLength>0)throw new Error("Cannot restore buffer when underlying buffer is not empty");t=new Float32Array(e)},Object.defineProperty(this,"color",{get:function(){return $.isColor(this.pointProps)?$.fromColor(this.pointProps):void 0},set:function(e){e?(r.red=e.red,r.green=e.green,r.blue=e.blue,r.alpha=e.alpha):(r.red=void 0,r.green=void 0,r.blue=void 0,r.alpha=void 0)},enumerable:!0}),Object.defineProperty(this,"size",{get:function(){return r.size},set:function(e){r.size=e},enumerable:!0}),this.validate()}static allocateBuffer(e){if("undefined"==typeof SharedArrayBuffer)return e.toFloat32Array();{let t=new SharedArrayBuffer(e.length*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(t);return r.set(e),r}}validate(){if(!this.layout.includes(C.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(C.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(C.Property.SIZE)&&isNaN(this.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}validateSegmentsCount(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}clone(){return new ce(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}getPoint(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t=C.createInstance(this.layout,this.points,e,this.pointProps);return this.matrix&&t.transform(this.matrix),t}setPoint(e,t){let r=e*this.stride;this.layout.forEach((e,i)=>this.points[r+i]=t.getProperty(e))}getPath(){let e=[],t=this.layout.indexOf(C.Property.X),r=this.layout.indexOf(C.Property.Y);for(let i=0;i<this.length;i++)e.push(this.points[i*this.stride+t],this.points[i*this.stride+r]);return e}slice(e,t,r,i){if(e<0||e>this.length-4)throw new Error(`Invalid fromIndex ${e} found. Ensure that fromIndex range is {0, ${this.length-4}}.`);if(t<1||t+1>this.length)throw new Error(`Invalid toIndex ${t} found. Ensure that fromIndex range is {1, ${this.length}}.`);if(t+1-e<4)throw new Error(`Invalid range {${e}, ${t}} found. At least 4 points are needed to define spline.`);let s;if("undefined"!=typeof SharedArrayBuffer&&this.points.buffer instanceof SharedArrayBuffer){let r=this.points.subarray(e*this.stride,(t+1)*this.stride),i=new SharedArrayBuffer(r.length*Float32Array.BYTES_PER_ELEMENT);s=new Float32Array(i),s.set(r)}else s=this.points.slice(e*this.stride,(t+1)*this.stride);let n=new ce(this.layout.slice(),s,Object.clone(this.pointProps),r,i);return n.randomSeed=this.randomSeed,n}setTransform(e){this.matrix=e}transform(e=this.matrix){let t=0;for(let r=0;r<this.length;r++){let i=this.getPoint(r);i.transform(e),this.setPoint(r,i),t=i.rotation}this.layout.includes(C.Property.ROTATION)||(0==t?delete this.pointProps.rotation:this.pointProps.rotation=t)}toJSON(){return{type:"Spline",layout:this.layout.map(e=>e.name),points:W.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}static fromJSON(e){let t=W.decode(e.points),r=new ce(e.layout.map(e=>C.Property[e]),t,e.pointProps,e.ts,e.tf);return r.randomSeed=e.randomSeed,r}static createRect(e,t,r){let i=e.toPath(t,r);return new ce(i.layout,i.points,{size:i.size,red:t.red,green:t.green,blue:t.blue,alpha:t.alpha})}}class pe{constructor(){this.path=[],this.firstSegment=!1,this.lastSegment=!0;let e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),pe.OutputType.ALL_DATA)},enumerable:!0})}add(e,t,r,i){if(e&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");e&&this.path.clear(),this.firstSegment=e,this.lastSegment=t;let s=this.addImpl(r,i);return this.keepAllData&&this.path.push(...s.added),{added:this.getOutput(s.added,pe.OutputType.ADDITION),predicted:this.getOutput(s.predicted,pe.OutputType.PREDICTION)}}get(e){this.reset(),this.firstSegment=!0,this.lastSegment=!0;let t=this.getImpl(e,pe.OutputType.PROCESSOR);return this.getOutput(t,pe.OutputType.PROCESSOR)}addImpl(e,t){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}getImpl(e){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}getOutput(e,t){return e}reset(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}pe.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);class fe extends ce{get slice(){}constructor(e,t,r,i=[]){super(e,t,r),Object.defineProperty(this,"tValues",{value:Object.freeze(i),enumerable:!0}),Object.defineProperty(this,"ts",{get:function(){return i.first},enumerable:!0}),Object.defineProperty(this,"tf",{get:function(){return i.last},enumerable:!0}),delete this.segmentsCount}validateSegmentsCount(){}clone(){return new fe(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.tValues.slice())}getPointT(e){return this.tValues[e]}toJSON(){return{type:"InterpolatedSpline",layout:this.layout.map(e=>e.name),points:W.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}static fromJSON(e){let t=W.decode(e.points);return new fe(e.layout.map(e=>C.Property[e]),t,e.pointProps,e.tValues)}}const ge=i.fromValues(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5);class me extends pe{constructor(e=!1,t=!1){super(),this.calculateDerivates=e,this.keepTValues=t,this.state={lastPointPosition:void 0,lastPointSize:0}}initState(e){this.state.layout={},e.layout.forEach((e,t)=>{this.state.layout[e.name]={index:t,polynomials:r.create()}}),this.keepTValues&&(this.state.tValues=[]),this.splineLayout=e.layout,this.pathPointProps=e.pointProps,this.scattering&&(this.pathPointProps.scattering=this.scattering),this.layout=this.calculateDerivates?e.layout.concat([C.Property.D_X,C.Property.D_Y]):e.layout,this.state.ready=!0}addImpl(e,t){return{added:this.getImpl(e,me.OutputType.ADDITION),predicted:this.getImpl(t,me.OutputType.PREDICTION)}}getImpl(e,t){if(!e)return[];let r;if(this.state.ready||this.initState(e),t==me.OutputType.PREDICTION){let t=Object.clone(this.state);delete this.state.tValues,this.resetState(),r=this.discretize(e),this.state=t}else r=this.discretize(e);return r}getOutput(e,t){if(0!=e.length){let r=t==me.OutputType.PREDICTION?void 0:this.state.tValues;return r&&(r=r.slice()),new fe(this.layout,e,this.pathPointProps,r)}}discretize(e){throw new Error("This method is abstract and should be implemented")}storeLastPoint(e,t=0){this.state.lastPointPosition=new y(this.getPropValue(C.Property.X,e,t),this.getPropValue(C.Property.Y,e,t),this.getPropValue(C.Property.Z,e,t)),this.state.lastPointSize=this.getPropValue(C.Property.SIZE,e,t)}getPropValue(e,t,r=0){return this.state.layout[e.name]?t[r+this.state.layout[e.name].index]:void 0}calculatePolynomials(e,t){let i=this.splineLayout.length*(t+0),s=this.splineLayout.length*(t+1),n=this.splineLayout.length*(t+2),o=this.splineLayout.length*(t+3);this.splineLayout.forEach((t,a)=>{let h=r.fromValues(e[i+a],e[s+a],e[n+a],e[o+a]);r.transformMat4(this.state.layout[t.name].polynomials,h,ge)})}samplePoint(e){let t=[],i=r.fromValues(1,e,e*e,e*e*e);return this.splineLayout.forEach(e=>{let s=r.dot(this.state.layout[e.name].polynomials,i);t.push(s)}),this.calculateDerivates&&(t.push(this.getDerivativeOf(this.state.layout.X.polynomials,i)),t.push(this.getDerivativeOf(this.state.layout.Y.polynomials,i))),t}getDerivativeOf(e,t){let i=r.fromValues(e[1],2*e[2],3*e[3],0);return r.dot(i,t)}addT(e){this.state.tValues&&this.state.tValues.push(e)}resetState(){}reset(){super.reset(),this.state.ready=!1,this.state.lastPointPosition=void 0,this.state.lastPointSize=0,delete this.state.tValues}}class ye extends me{constructor(e=.1,t,r){super(t,r),this.spacing=e}split(e,t=8){let r=this.spacing;this.spacing=1,this.splitCount=t;let i=this.get(e);return this.spacing=r,delete this.splitCount,i}discretize(t){let r=[],i=this.splitCount,s=Math.max(1,10*(this.spacing>1?1:this.spacing));for(let n=0;n<t.segmentsCount;n++){if(this.calculatePolynomials(t.points,n),isNaN(this.splitCount)){let r=t.getPoint(n+1),o=t.getPoint(n+2),a=e.distance(r.value,o.value),h=this.pathPointProps.size;this.state.layout.SIZE&&(h=Math.min(r.size,o.size)),i=Math.floor(s*(a/h)/this.spacing)+1}let o=1/i;for(let e=0;e<=i;e++){let s=!this.state.lastPointPosition,a=e/i;if(0==n&&a<t.ts){if(!(a+o>=t.ts))continue;a=t.ts,s=this.spacing<=1}if(n==t.segmentsCount-1&&a>=t.tf){if(!(a<t.tf+o))continue;a=t.tf,s=this.lastSegment&&this.spacing<=1}if(n>0&&0==a)continue;let h=this.samplePoint(a);if(!s&&this.state.lastPointPosition){let e=new y(this.getPropValue(C.Property.X,h),this.getPropValue(C.Property.Y,h),this.getPropValue(C.Property.Z,h)),t=this.state.lastPointPosition.vec.squaredDistance(this.state.lastPointPosition.value,e.value),r=(this.state.layout.SIZE?(this.state.lastPointSize+h[this.state.layout.SIZE.index])/2:this.pathPointProps.size)*this.spacing;s=t>=r*r}s&&(r.push(...h),this.storeLastPoint(h),this.addT(a))}}return this.state.tValues&&(0!=r.length&&this.state.tValues.first==t.ts||(r.unshift(...this.samplePoint(t.ts)),this.state.tValues.unshift(t.ts)),this.state.tValues.last!=t.tf&&(r.push(...this.samplePoint(t.tf)),this.state.tValues.push(t.tf))),r}}class be{static union(e,t){let r=new de(e),i=new ne;return i.StrictlySimple=!0,i.AddPaths(r.subject,le.ptSubject,!0),i.Execute(he.ctUnion,r.solution,ue.pftNonZero,ue.pftNonZero),r.toPath2D(t)}static intersection(e,t){e instanceof de||(e=new de(e)),e.clip=e.apply(t);let r=new ne;return r.StrictlySimple=!0,r.AddPaths(e.subject,le.ptSubject,!0),r.AddPaths(e.clip,le.ptClip,!0),r.Execute(he.ctIntersection,e.solution,ue.pftNonZero,ue.pftNonZero),e.solution.length>0?e:null}static createClipperPath(e,t=32){let r=new ae;r.scale=t;for(let i=0;i<e.length;i++){let s=i*e.stride;r.push({X:Math.round(e.points[s]*t),Y:Math.round(e.points[s+1]*t)})}return r}static containsPoint(e,t){let r={X:Math.round(t.x*e.scale),Y:Math.round(t.y*e.scale)};return 1==ne.PointInPolygon(r,e)}}class Ee{constructor(){this.interpolator=new ye(.1,!1,!0)}build(e,t,r){return this.context=e,this.pathContext=new de(r),this.result={},this.holes=[],this.debug&&(t=t.unique()),t.sort(F.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),this.debug&&(this.table=new I([{name:"strokeID",title:"Stroke ID"},{name:"segmentIndex",title:"Segment Index"},{name:"splineIndex",title:"Spline Index"},{name:"pointIndex",title:"Point Index"},{name:"prevT",title:"Prev T"},{name:"t",title:"T Value"},{name:"nextT",title:"Next T"},{name:"ts",title:"Start T"},{name:"tf",title:"End T"},{name:"size",title:"Size"},{name:"shapeSize",title:"Shape Size"},{name:"hole",title:"HolePart"},{name:"nodeIndex",title:"Node Index"}])),t.forEach(e=>{this.isHolePart(e)?this.update(e):this.add(e),this.debug&&this.table.insert({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:e.splineIndex,pointIndex:e.pointIndex,prevT:e.prevT.toFixed(4),t:e.t.toFixed(4),nextT:e.nextT.toFixed(4),ts:e.spline.ts.toFixed(4),tf:e.spline.tf.toFixed(4),size:`${e.bounds.width.toFixed(2)} / ${e.bounds.height.toFixed(2)}`,shapeSize:`${e.shapeBounds.width.toFixed(2)} / ${e.shapeBounds.height.toFixed(2)}`,hole:e.hole,nodeIndex:e.nodeIndex})}),this.debug&&this.table.length>0&&console.log(this.table.toString()),this.narrow(),this.result}add(e){this.holes=this.result[e.strokeID],this.holes||(this.holes=[],this.result[e.strokeID]=this.holes);let t=e.segmentIndex,r=e.segmentIndex,i=this.context.getNodes(e.strokeID).indexOf(e);this.holes.push({fromIndex:t,toIndex:r,fromTValue:e.prevT,toTValue:e.nextT,fromNodeIndex:i,toNodeIndex:i,strokeID:e.strokeID}),this.debug&&(e.hole=!1,e.nodeIndex=i)}update(e){let t=this.holes.last;t.toIndex=e.segmentIndex,t.toTValue=e.nextT,t.toNodeIndex=this.context.getNodes(e.strokeID).indexOf(e),this.debug&&(e.hole=!0,e.nodeIndex=t.toNodeIndex)}isHolePart(e){let t=this.holes.last;return!(!t||t.strokeID!=e.strokeID)&&(e.segmentIndex==t.toIndex&&e.prevT<=t.toTValue||e.segmentIndex==t.toIndex+1&&1==t.toTValue&&0==e.prevT)}narrow(){this.holes.forEach(e=>{let t,r=this.context.getNodes(e.strokeID),i=r[e.fromNodeIndex],s=r[e.toNodeIndex];t=e.toNodeIndex+1-e.fromNodeIndex<=2?this.extractT(i,"sf",i.prevT,s.nextT):{s:this.extractT(i,"s",i.prevT,i.nextT).s,f:this.extractT(s,"f",s.prevT,s.nextT).f},i.ts=t.s,s.tf=t.f,e.fromTValue=t.s,e.toTValue=t.f})}extractT(e,t,r,i){if(r==i)return{};let s,n={},o=t.startsWith("s"),a=new ce(e.spline.layout,e.spline.points,e.spline.pointProps,r,i),h=this.interpolator.get(a);for(let r=0;r<h.length;r++){let i=h.getPoint(r),a=this.context.getBrushApplier(e.strokeID).applyBrush(i);if(be.intersection(this.pathContext,a)){if(o){if(n.s=s,t.endsWith("f")){s=h.getPointT(r),o=!1;continue}break}s=h.getPointT(r)}else if(o&&(s=h.getPointT(r)),!o&&(n.f=s,s))break}if(isNaN(n.s)&&(n.s=r),isNaN(n.f)&&(n.f=i),n.s==n.f){let e=h.tValues.indexOf(n.s);0==e?n.f=h.tValues[e+1]:n.s=h.tValues[e-1]}return n}}let Pe;Object.defineProperty(globalThis,"DIGITAL_INK_DEBUG",{get:()=>Pe,set:function(e){Pe=e||{},A.debug=Pe.InputListener,ie.prototype.debug=Pe.PathPointContext,de.prototype.debug=Pe.ClipperContext,Ee.prototype.debug=Pe.HolesBuilder},enumerable:!0,configurable:!0});var xe=Object.freeze({__proto__:null,vector:function(e,t){let r,i={};return Object.defineProperty(i,"x",{value:t.x-e.x,enumerable:!0}),Object.defineProperty(i,"y",{value:t.y-e.y,enumerable:!0}),Object.defineProperty(i,"length",{get:()=>(isNaN(r)&&(r=Math.sqrt(i.x*i.x+i.y*i.y)),r),enumerable:!0}),i},angle:function(e,t){let r=e.x*t.x+e.y*t.y,i=e.x*t.y-e.y*t.x;return Math.atan2(i,r)}});class we{constructor(e){this.phase=e.phase;let t=isNaN(e.altitude)||isNaN(e.azimuth)?void 0:{altitude:e.altitude,azimuth:e.azimuth};Object.defineProperty(this,"x",{value:e.x,enumerable:!0}),Object.defineProperty(this,"y",{value:e.y,enumerable:!0}),Object.defineProperty(this,"z",{value:e.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:e.timestamp,enumerable:!0}),Object.defineProperty(this,"force",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:e.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:e.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:e.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:()=>(t||(t=this.computeTilt(e)||{}),t.altitude),enumerable:!0}),Object.defineProperty(this,"azimuth",{get:()=>(t||(t=this.computeTilt(e)||{}),t.azimuth),enumerable:!0}),e.pointer&&Object.defineProperty(this,"pointer",{value:e.pointer,enumerable:!0}),this.computedAzimuth=void 0}createPathPoint(){return new C(this.x,this.y,this.z)}computeTilt(e){if(isNaN(e.tiltX)||isNaN(e.tiltY))return;let{tiltX:t,tiltY:r}=e,i=Math.tan(Math.toRadians(t)),s=Math.tan(Math.toRadians(r)),n=Math.sqrt(i*i+s*s);return{altitude:Math.atan2(1,n),azimuth:Math.atan2(s,i)}}speed(e,t){let r={x:0,y:0,time:0};if(r=e&&!t?this.minus(e):t&&!e?t.minus(this):t.minus(e),r.time>0)return we.getMagnitude(r.x,r.y)/(r.time/1e3);if(0==r.time)return 0;throw new Error("Speed out of range: "+r.time)}computeNearestAzimuthAngle(e){let t;if(isNaN(this.azimuth))return 0;if(e){if(isNaN(e.azimuth))return 0;let r=2*Math.PI,i=e.computedAzimuth||e.azimuth,s=parseInt(i/r);t=this.azimuth+s*r;let n=t-i;n>=Math.PI?t-=r:n<-Math.PI&&(t+=r)}else t=this.azimuth;return this.computedAzimuth=t,t}minus(e){return{x:this.x-e.x,y:this.y-e.y,time:this.timestamp-e.timestamp}}static getMagnitude(e,t){return Math.sqrt(e*e+t*t)}}we.createEnum("Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);class ve{constructor(){this.reset()}add(e,t,r){e==m.Phase.BEGIN?this.reset(!0):e==m.Phase.END&&(this.last=!0),t&&this.accumulatedAddition.push(...t),r&&(this.lastPrediction=r)}reset(e=!1){this.first=e,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}class Te extends Array{constructor(...e){let t;super(...e),Object.defineProperty(this,"bounds",{get:()=>(t||(t=q.ofPolygons(this).ceil()),t),enumerable:!0}),this.resetBounds=()=>t=null,this.shapesList=!1,this.holesClockwise=!1}clone(){return this.map(e=>e.slice())}setTransform(e){this.matrix=e}transform(e=this.matrix){this.forEach(t=>{for(let r=0;r<t.length;r+=2){let i=new y(t[r],t[r+1]);i.transformSelf(e),t[r]=i.x,t[r+1]=i.y}}),this.resetBounds()}toArray(){return Array.from(this)}toJSON(){return{type:"InkPath2D",contours:this.toArray(),shapesList:this.shapesList,holesClockwise:this.holesClockwise}}static fromJSON(e){if("InkPath2D"!=e.type)throw new Error("Invalid data found");let t=new Te(...e.contours);return t.shapesList=e.shapesList,t.holesClockwise=e.holesClockwise,t}static fromArray(e){return new Te(...e.slice(0))}}let Ie={stride:2,sort(e,t){return this.sortArrayPart(e,0,e.length-this.stride,t),e},partition(e,t,r,i){let s=e[r],n=e[r+1],o=t-this.stride;for(let a=t;a<r;a+=2)i?i(s,n,e[a],e[a+1])&&(o+=this.stride,this.swap(e,o,a)):(s>e[a]||s==e[a]&&n>e[a+1])&&(o+=this.stride,this.swap(e,o,a));return this.swap(e,o+this.stride,r),o+this.stride},swap(e,t,r){let i=e[t],s=e[t+1];return e[t]=e[r],e[t+1]=e[r+1],e[r]=i,e[r+1]=s,e},sortArrayPart(e,t,r,i){if(t<r){let s=this.partition(e,t,r,i);this.sortArrayPart(e,t,s-this.stride,i),this.sortArrayPart(e,s+this.stride,r,i)}}},Se={monotoneChain(e){let t=Se.ARRAY_TYPE;if(t||(t=Array),e.length<=0)return new t;Ie.sort(e);let r=new t(e.length),i=0;for(let t=0;t<e.length;t+=2){for(;i>=4&&this.cross(r[i-4],r[i-3],r[i-2],r[i-1],e[t],e[t+1])<=0;)i-=2;r[i]=e[t],r[i+1]=e[t+1],i+=2}r=r.slice(0,i);let s,n=new t(e.length);i=0;for(let t=e.length-2;t>=0;t-=2){for(;i>=4&&this.cross(n[i-4],n[i-3],n[i-2],n[i-1],e[t],e[t+1])<=0;)i-=2;n[i]=e[t],n[i+1]=e[t+1],i+=2}return n=n.slice(0,i-2),t==Float32Array?(s=new Float32Array(n.length+r.length),s.set(n),s.set(r,n.length)):s=n.concat(r),s},cross:(e,t,r,i,s,n)=>(r-e)*(n-t)-(i-t)*(s-e)};class Re extends m{constructor(e,t){super(),this.inputBuffer=[],this.hasPrediction=!0,Object.defineProperty(this,"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"pathPointCalculator",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0})}togglePrediction(e){this.hasPrediction=e}addImpl(e,t){if(e.phase!=this.phase)throw new Error(`The phase of the addition (${e.phase.name}) doesn't match the phase of the PathProducer (${this.phase.name})`);let r=[],i=[];e&&this.inputBuffer.push(e);let s=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,n=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,o=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,a=this.calculate(s,n,o);return e&&a&&r.push(...a.toArray(this.layout)),this.phase==m.Phase.END?(a=this.calculate(n,o,null),a&&r.push(...a.toArray(this.layout))):!this.hasPrediction||this.phase!=m.Phase.UPDATE&&null==t||(a=this.calculate(n,o,t),a&&(i.push(...a.toArray(this.layout)),a=this.calculate(o,t,null),a&&i.push(...a.toArray(this.layout)))),{added:r,predicted:i}}calculate(e,t,r){return t?this.pathPointCalculator(e,t,r):null}reset(){super.reset(),this.inputBuffer.clear()}}const Ae=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933];class Ce extends pe{constructor(e,t=15){super(),this.buffer=[],this.pointsCount=0,this.filter=Ae.slice(),Object.defineProperty(this,"dimsCount",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"movingAverageWindowSize",{get:function(){return t},set:function(e){t=e,this.filter.length!=e&&(this.filter=Ce.resample(Ae,e)),this.predictionPointsCount=4*e/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),this.movingAverageWindowSize=t}addImpl(e=[],t=[]){return{added:this.lastSegment?this.project(e):this.addSequence(e),predicted:this.project(t)}}getImpl(e){return this.project(e)}project(e){if(e.length%this.dimsCount!=0)throw new Error(`Points size ('${e.length}') must be multiple of the dimensions count ('${this.dimsCount}').`);if(0==e.length)return[];let t=[],r=this.buffer.slice(),i=e.slice(0,e.length-this.dimsCount),s=this.addSequence(i);t.push(...s);let n=e.slice(e.length-this.dimsCount,e.length),o=this.predictionPointsCount;for(let e=0;e<o;e++){let r=this.addPoint(n);o-e<=this.pointsCount&&t.push(...r)}return this.buffer=r,t}addSequence(e){if(e.length%this.dimsCount!=0)throw new Error(`Points size ('${e.length}') must be multiple of the dimensions count ('${this.dimsCount}').`);let t=[],r=e.length/this.dimsCount;for(let i=0;i<r;i++){let r=this.addPoint(e.slice(i*this.dimsCount,(i+1)*this.dimsCount));t.push(...r)}return this.pointsCount+=r,t}addPoint(e){for(this.buffer.push(...e);this.buffer.length<this.windowSize*this.dimsCount;)this.buffer.unshift(...this.buffer.slice(0,this.dimsCount));for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}filterBuffer(){let e=[];for(let t=0;t<this.windowSize;t++)for(let r=0;r<this.dimsCount;r++)isNaN(e[r])&&(e[r]=0),e[r]+=this.buffer[t*this.dimsCount+r]*this.filter[t];return e}reset(){super.reset(),this.pointsCount=0,this.buffer.clear()}static resample(e,t){let r=new Float32Array(t),i=e.length/t,s=0;for(let n=0;n<t;n++){let o=(e.length-1)*n/(t-1),a=Math.floor(o),h=Math.ceil(o),l=o-a,u=i*(e[a]*(1-l)+e[h]*l);s+=u,r[n]=u}let n=1/s;for(let e=0;e<t;e++)r[e]*=n;return r}}class Oe extends pe{constructor(e){super(),this.pathPointProps={},this.lastSpline=[],Object.defineProperty(this,"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0})}addImpl(e,t){0==this.lastSpline.length&&e.length>0&&e.unshift(...e.slice(0,this.layout.length)),this.lastSegment&&(e.length>=this.layout.length?e.push(...e.slice(e.length-this.layout.length,e.length)):e.push(...this.getLastPart()));let r=this.getFirstPart();return this.lastSpline=r.concat(e),{added:e,predicted:this.getPredictedSpline(t)}}getImpl(e){let t=[];return e.length>0&&(t.push(...e.slice(0,this.layout.length)),t.push(...e),e.length>=this.layout.length&&t.push(...e.slice(e.length-this.layout.length,e.length))),e}getOutput(e,t){let r=t==pe.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:e;return 0==r.length?void 0:new ce(this.layout,r,this.pathPointProps,0,1)}getFirstPart(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}getLastPart(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}getPredictedSpline(e=[]){let t=[];if(e.length>0){let r=this.getFirstPart();for(t.push(...r),t.push(...e),t.push(...t.slice(t.length-this.layout.length,t.length));t.length<4*this.layout.length;)t.unshift(t.slice(0,this.layout.length))}return t}reset(){super.reset(),this.lastSpline.clear()}}class De{constructor(e){this.key=e,this.height=1}leftRotate(){let e=this.right,t=e.left;return e.left=this,this.right=t,this.height=Math.max(De.height(this.left),De.height(this.right))+1,e.height=Math.max(De.height(e.left),De.height(e.right))+1,e}rightRotate(){let e=this.left,t=e.right;return e.right=this,this.left=t,this.height=Math.max(De.height(this.left),De.height(this.right))+1,e.height=Math.max(De.height(e.left),De.height(e.right))+1,e}getBalanceFactor(){return De.height(this.left)-De.height(this.right)}static height(e){return e?e.height:0}static minValue(e){if(!e)return;let t=e;for(;t.left;)t=t.left;return t.key}static maxValue(e){if(!e)return;let t=e;for(;t.right;)t=t.right;return t.key}}class Me{constructor(){this.count=0,this.hasKey=!1,this.root}min(){return De.minValue(this.root)}max(){return De.maxValue(this.root)}add(e){return this.hasKey=!1,this.root=this.insertNode(this.root,e),this.hasKey||this.count++,!this.hasKey}insertNode(e,t){if(!e)return new De(t);if(t<e.key)e.left=this.insertNode(e.left,t);else{if(!(t>e.key))return this.hasKey=!0,e;e.right=this.insertNode(e.right,t)}if(!this.hasKey){e.height=1+Math.max(De.height(e.left),De.height(e.right));let r=e.getBalanceFactor();if(r>1){if(t<e.left.key)return e.rightRotate();if(t>e.left.key)return e.left=e.left.leftRotate(),e.rightRotate()}else if(r<-1){if(t>e.right.key)return e.leftRotate();if(t<e.right.key)return e.right=e.right.rightRotate(),e.leftRotate()}}return e}contains(e){return this.containsNode(this.root,e)}containsNode(e,t){return!!e&&(t<e.key?this.containsNode(e.left,t):!(t>e.key)||this.containsNode(e.right,t))}printTree(){if(!this.root)return;let e=[this.root],t=this.root.height;for(;e.length>0;){let r=e.shift();t!=r.height&&console.log("-"),console.log(`${r.key} with height: ${r.height}, balance: ${r.getBalanceFactor()}`),t=r.height;let i=r.left,s=r.right;i&&e.push(i),s&&e.push(s)}}toArray(){let e=[];return Me.fillArray(e,this.root),e}static fillArray(e,t){t&&(this.fillArray(e,t.left),e.push(t.key),this.fillArray(e,t.right))}}class Ne{constructor(){this.tree=new Me,Object.defineProperty(this,"length",{get:()=>this.tree.count,enumerable:!0})}clear(){this.tree=new Me}add(e){return this.tree.add(e)}includes(e){return this.tree.contains(e)}min(){return this.tree.min()}max(){return this.tree.max()}toArray(){return this.tree.toArray()}}class ke extends me{constructor(e,t){super(e,t),this.state.segmentIndex=-1,this.state.lastSegmentIndex=-1,this.state.lastPointRotation=0,this.state.lastPointT=0,this.state.absAccumulatedErrorPos=0,this.state.absAccumulatedErrorS=0,this.setT=new Ne,Object.defineProperty(this,"errorThreshold",{get:function(){return this.error},set:function(e){this.error=e,this.errorDistSq=this.error*this.error,this.error10=10*this.error},enumerable:!0}),this.errorThreshold=.15}discretize(e){let t=[],r=e.segmentsCount,i=r-1;for(let s=0;s<r;s++){this.calculatePolynomials(e.points,s);let r=this.calculateTParams(s==i,e.ts,e.tf);t.push(...this.samplePoints(r)),r.length>0&&(this.resetAccumulatedErrors(),this.storeLastPoint(t))}return t}samplePoints(e){let t=[];return e.toArray().forEach(e=>{this.addT(e),t.push(...this.samplePoint(e))}),t}storeLastPoint(e){let t=e.length-this.layout.length;super.storeLastPoint(e,t),this.state.lastPointRotation=this.getPropValue(C.Property.ROTATION,e,t),this.state.lastPointT=this.setT.max(),this.state.lastSegmentIndex=this.state.segmentIndex}calculateTParams(e,t,r){this.state.segmentIndex++;let i=0==this.state.segmentIndex?t:0,s=e?r:1;return this.setT.clear(),this.getTForPos(i,s),this.state.layout.SIZE&&this.getTForCubic(i,s,this.state.layout.SIZE.polynomials,this.error),this.mustAddStartT()&&this.setT.add(i),e&&this.setT.add(s),this.state.layout.ROTATION&&this.getTForRotation(i,s),this.setT}mustAddStartT(){if(this.state.lastSegmentIndex<0)return!0;let e=this.state.lastPointT-(this.state.segmentIndex-this.state.lastSegmentIndex),t=this.setT.length>0?this.setT.min():1,r=this.getPosErrorAtT0(t,this.state.lastPointPosition);if(this.state.absAccumulatedErrorPos+=Math.abs(r),this.state.layout.SIZE){let r=this.getErrorAtT0(this.state.layout.SIZE.polynomials,t,e,this.state.lastPointSize);this.state.absAccumulatedErrorS+=Math.abs(r)}return this.state.absAccumulatedErrorPos>this.errorDistSq||this.state.absAccumulatedErrorS>this.error}getPosErrorAtT0(e,t){let r=this.getTPoint(e),i=this.getTPoint(0);return this.minDistanceSq(t,r,i)}getErrorAtT0(e,t,r,i){let s=r,n=i,o=t,a=this.cubicCalc(e,o),h=this.cubicCalc(e,0),l=n+(0-s)*(a-n)/(o-s);return Math.abs(h-l)}getTForPos(e,t){let r=this.getTPoint(e),i=this.getTPoint(t),s=this.subdividePos(r,i);if(s.split)this.subdivideRecursivePos(r,s),this.setT.add(s.t),this.subdivideRecursivePos(s,i);else{let e=this.subdividePos(r,s),t=this.subdividePos(s,i);e.split&&(this.subdivideRecursivePos(r,e),this.setT.add(e.t),this.subdivideRecursivePos(e,s)),(e.split||t.split)&&this.setT.add(s.t),t.split&&(this.subdivideRecursivePos(s,t),this.setT.add(t.t),this.subdivideRecursivePos(t,i))}}subdivideRecursivePos(e,t){let r=this.subdividePos(e,t);r.split&&(this.subdivideRecursivePos(e,r),this.setT.add(r.t),this.subdivideRecursivePos(r,t))}subdividePos(e,t){let r=.5*(e.t+t.t),i=this.getTPoint(r),s=this.minDistanceSq(e,t,i),n=e.add(t).scaleSelf(.5),o=i.subtract(n).absSelf();return i.split=s>this.errorDistSq||o.x>this.error10||o.y>this.error10,this.state.layout.Z&&(i.split=i.split||o.z>this.error10),i}getTForCubic(e,t,r,i){let s={v:this.cubicCalc(r,e),t:e},n={v:this.cubicCalc(r,t),t:t},o=this.subdivide(s,n,r);if(o.diff>i)this.subdivideRecursive(s,o,r,i),this.setT.add(o.t),this.subdivideRecursive(o,n,r,i);else{let e=this.subdivide(s,o,r),t=this.subdivide(o,n,r);e.diff>i&&(this.subdivideRecursive(s,e,r,i),this.setT.add(e.t),this.subdivideRecursive(e,o,r,i)),(e.diff>i||t.diff>i)&&this.setT.add(o.t),t.diff>i&&(this.subdivideRecursive(o,t,r,i),this.setT.add(t.t),this.subdivideRecursive(t,n,r,i))}}subdivideRecursive(e,t,r,i){let s=this.subdivide(e,t,r);s.diff>i&&(this.subdivideRecursive(e,s,r,i),this.setT.add(s.t),this.subdivideRecursive(s,t,r,i))}subdivide(e,t,r){let i=.5*(e.t+t.t),s=this.cubicCalc(r,i),n=.5*(e.v+t.v);return{v:s,t:i,diff:Math.abs(s-n)}}getTForRotation(e,t){let r=this.state.layout.ROTATION.polynomials,i=this.state.lastPointRotation;this.state.lastSegmentIndex<0&&(i=this.cubicCalc(r,e));let s=.25*(t-e);for(let t=0;t<4;t++){let n=e+t*s,o=this.cubicCalc(r,n);Math.abs(o-i)>.06&&(this.setT.add(n),i=o)}}minDistanceSq(e,t,r){let i=r.vec,s=i.squaredDistance(e.value,t.value);if(0==s)return i.squaredDistance(r.value,e.value);let n=Math.max(0,Math.min(1,i.dot(r.subtract(e).value,t.subtract(e).value)/s)),o=t.subtract(e).scale(n).add(e);return i.squaredDistance(r.value,o.value)}getTPoint(e){let t=new y(this.cubicCalc(this.state.layout.X.polynomials,e),this.cubicCalc(this.state.layout.Y.polynomials,e),this.state.layout.Z?this.cubicCalc(this.state.layout.Z.polynomials,e):void 0);return t.t=e,t}cubicCalc(e,t){return e[0]+e[1]*t+e[2]*t*t+e[3]*t*t*t}resetAccumulatedErrors(){this.state.absAccumulatedErrorPos=0,this.state.absAccumulatedErrorS=0}resetState(){this.state.segmentIndex=-1,this.state.lastSegmentIndex=-1,this.state.lastPointT=0,this.state.lastPointRotation=0,this.resetAccumulatedErrors()}reset(){super.reset(),this.resetState()}}class Le extends pe{constructor(e){super(),Object.defineProperty(this,"brush",{get:function(){if(!e)throw new Error("brush not found");return e},set:function(t){e=t,this.reset()},enumerable:!0})}addImpl(e,t){return{added:this.generatePolygons(e),predicted:this.generatePolygons(t)}}getImpl(e){return this.generatePolygons(e)}getOutput(e,t){let r=new Te(...e);return r.shapesList=this.brush.spacing>1,r}generatePolygons(e){if(!e)return[];let t=[];for(let r=0;r<e.length;r++){let i=e.getPoint(r),s=this.applyBrush(i);t.push(s)}return t}applyBrush(e){let t=[],i=this.createTransform(e),s=this.brush.selectShape(i.maxScale);for(let e=0;e<s.length;e+=2){let n=r.create(),o=r.fromValues(s[e],s[e+1],0,1);r.transformMat4(n,o,i),t.push(n[0]/n[3],n[1]/n[3])}return t}createTransform(e){if(isNaN(e.size))throw new Error("Size information not found.");let r=i.create(),s=e.size*e.scaleX,n=e.size*e.scaleY,o=e.size*e.scaleZ;return r.maxScale=Math.max(s,n,o),i.translate(r,r,t.fromValues(e.x,e.y,e.z||0)),i.rotateZ(r,r,e.rotation),i.translate(r,r,t.fromValues(e.offsetX,e.offsetY,e.offsetZ)),i.scale(r,r,t.fromValues(s,n,o)),r}}class _e extends pe{constructor(){super(),this.lastPolygon=[]}addImpl(e,t){return{added:this.getConvexHulls(e,!0),predicted:this.getConvexHulls(t)}}getImpl(e){return this.getConvexHulls(e)}getOutput(e,t){return new Te(...e)}getConvexHulls(e,t){let r=[],i=this.lastPolygon;return e.forEach(e=>{i.push(...e),r.push(Se.monotoneChain(i)),i=e}),t&&e.length>0&&(this.lastPolygon=e.last.slice()),r}reset(){super.reset(),this.lastPolygon.clear()}}class Fe extends pe{constructor(){super(),this.processPrediction=!1,this.filterDuplicates=!1}addImpl(e,t){return{added:this.merge(e),predicted:this.processPrediction?this.merge(t):t}}getImpl(e){return this.merge(e)}getOutput(e,t){return new Te(...e)}merge(e){return e.length?be.union(e,this.filterDuplicates):[]}}class Be extends pe{constructor(e=.1){super(),this.epsilon=e}addImpl(e,t){return{added:this.simplify(e),predicted:t}}getImpl(e){return this.simplify(e)}getOutput(e,t){return new Te(...e)}simplify(e){return e.map(e=>this.simplifyPolygonDouglasPeucker(e))}simplifyPolygonDouglasPeucker(e){if(e.length<6)return e;e instanceof Float32Array&&(e=e.toArray());let t=this.simplifyPolylineDouglasPeucker(e.concat([e[0],e[1]]));return t.length<8?e:t.slice(0,t.length-2)}simplifyPolylineDouglasPeucker(e){if(this.epsilon<=0)return[];if(e.length<4)return e;let t,r=0,i=0;for(let t=2;t<e.length-2;t+=2){let s=Be.perpendicularDistance(e[t],e[t+1],e[0],e[1],e[e.length-2],e[e.length-1]);s>r&&(i=t,r=s)}if(r>this.epsilon){let r=this.simplifyPolylineDouglasPeucker(e.slice(0,i+2)),s=this.simplifyPolylineDouglasPeucker(e.slice(i,e.length));t=r.concat(s.slice(2,s.length))}else t=[e[0],e[1],e[e.length-2],e[e.length-1]];return t}static perpendicularDistance(e,t,r,i,s,n){let o=e-r,a=s-r,h=o*(n-i)-a*(t-i);h*=h,o=s-r,a=n-i;let l=o*o+a*a;return l>0?Math.sqrt(h/l):Math.sqrt((r-e)*(r-e)+(i-t)*(i-t))}}class Ue{constructor(){this.layout=[C.Property.X,C.Property.Y],this.pathSegment=new ve,this.pathProducer=new Re(this.layout,(e,t,r)=>t.createPathPoint()),this.smoother=new Ce(this.layout.length),this.splineProducer=new Oe(this.layout),this.distanceInterpolator=new ye,this.curvatureInterpolator=new ke,this.brushApplier=new Le,this.polygonMerger=new Fe,this.polygonSimplifier=new Be,this.splineProducer.keepAllData=!0,this.phase=null,this.raster=!1,this.pathPointProps={},this.queue=Promise.resolve(),Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,layout:this.layout,pathPointProps:this.pathPointProps,pathPointCalculator:this.calculator,movingAverageWindowSize:this.smoother.movingAverageWindowSize,epsilon:this.polygonSimplifier.epsilon,mergePrediction:this.polygonMerger.processPrediction}),enumerable:!0})}configure(e={}){if(this.distanceInterpolator.keepAllData=!1,this.curvatureInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,e.brush&&(this.brush=e.brush,this.raster=!(this.brush instanceof re),this.raster||this.brush.spacing>1||e.basicMode?(this.splineInterpolator=this.distanceInterpolator,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.scattering=this.brush.scattering,this.splineInterpolator.calculateDerivates=this.raster):this.splineInterpolator=this.curvatureInterpolator,this.raster?this.splineInterpolator.keepAllData=!0:(this.brushApplier.brush=this.brush,this.brush.spacing>1?this.brushApplier.keepAllData=!0:this.polygonSimplifier.keepAllData=!0)),"basicMode"in e){if(e.basicMode&&this.raster)throw new Error("Basic mode is not supported for particles strokes");this.basicMode=e.basicMode}if(e.pathPointProps&&(this.pathPointProps=e.pathPointProps,this.splineProducer.pathPointProps=this.pathPointProps),e.pathPointCalculator&&(this.calculator=e.pathPointCalculator,this.pathProducer.pathPointCalculator=e.pathPointCalculator),e.layout){if(this.layout=e.layout,!this.raster){if(this.layout.includes(C.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(C.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(C.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(C.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(C.Property.RED)&&isNaN(this.pathPointProps.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(C.Property.GREEN)&&isNaN(this.pathPointProps.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(C.Property.BLUE)&&isNaN(this.pathPointProps.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(C.Property.ALPHA)&&isNaN(this.pathPointProps.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(C.Property.SIZE)&&isNaN(this.pathPointProps.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout}e.movingAverageWindowSize>0&&(this.smoother.movingAverageWindowSize=e.movingAverageWindowSize),e.errorThreshold>0&&(this.curvatureInterpolator.errorThreshold=e.errorThreshold),e.epsilon>0&&(this.polygonSimplifier.epsilon=e.epsilon),"mergePrediction"in e&&(this.polygonMerger.processPrediction=e.mergePrediction),e.onBuildComplete&&(this.onComplete=e.onBuildComplete),this.reset()}add(e,t){if(!this.brush)throw new Error("InkBuilder instance is not configured properly, brush is not found");if(!this.layout)throw new Error("InkBuilder instance is not configured properly, layout is not found");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator is not found");if(!e.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=e.phase;let r,i=new we(e);t&&(r=new we(t)),this.device&&(this.phase==m.Phase.BEGIN&&this.device.openStream(e),this.device.add(i),this.phase==m.Phase.END&&(this.sensorData=this.device.closeStream()));let s=this.pathProducer.add(this.phase,i,r);this.pathSegment.add(this.phase,s.added,s.predicted)}ignore(e){if(!e.phase)throw new Error("SensorPoint phase is not found");this.device&&e&&e.phase==m.Phase.UPDATE&&this.device.add(new we(e),!0)}build(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}processSpline(e,t,r,i){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}mergeAndSimplify(e,t,r){return r=this.polygonMerger.add(e,t,r.added,r.predicted),r=this.polygonSimplifier.add(e,t,r.added,r.predicted)}getSensorData(){return this.sensorData}getSpline(){return new ce(this.layout,this.splineProducer.allData.points,this.pathPointProps)}getInkPath(e){let t;return this.raster?t=this.splineInterpolator.allData:this.basicMode||(this.brush.spacing>1?t=this.brushApplier.allData:(t=this.polygonSimplifier.allData,e&&(t=this.polygonMerger.merge(t),t=this.polygonSimplifier.simplify(t)))),t}abort(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}reset(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.distanceInterpolator.reset(),this.curvatureInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}restart(){this.phase=void 0,this.pointerID=void 0}}Ue.Phase=m.Phase;class je extends Ue{constructor(){super(),this.convexHullChainProducer=new _e}build(){let e=this.buildSegment();return e.phase=this.phase,e.predicted&&(e.predicted.predicted=!0),this.onComplete&&this.onComplete(e),this.phase==m.Phase.END&&this.restart(),e}buildSegment(){let e={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return e=this.smoother.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),e=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),e=this.processSegment(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),this.pathSegment.reset(),e}processSegment(e,t,r,i){let s=this.splineInterpolator.add(e,t,r,i);return this.raster||this.basicMode||(s.added||s.predicted?(s=this.brushApplier.add(e,t,s.added,s.predicted),this.brush.spacing<=1&&(s=this.convexHullChainProducer.add(e,t,s.added,s.predicted),s=this.mergeAndSimplify(e,t,s))):s={added:s.added?s.added.points:new Te,predicted:s.predicted?s.predicted.points:new Te}),s}processSpline(e,t){let r=this.splineInterpolator.get(e);return this.raster||(r?(r=this.brushApplier.get(r),this.brush.spacing<=1&&(this.polygonMerger.filterDuplicates=t,r=this.convexHullChainProducer.get(r),r=this.polygonMerger.get(r),r=this.polygonSimplifier.get(r))):r=new Te),r}}class Ge{constructor(){this.state={},this.nextKey=0,this.workers=[],this.status=Ge.Status.CLOSED,this.lastPolygon}async open(){if(this.status!=Ge.Status.CLOSED)throw new Error(`Producer cannot be opened. Current status is ${this.status.name}.`);let e=new Blob(['\nlet QuickSort;\nlet ConvexHullProducer;\n\nlet worker = parseInt(self.name.replace(/^\\D+/g, ""));\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.imports) {\n\t\tmessage.imports.forEach(url => self.importScripts(url));\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\tself.postMessage({worker, ready: true});\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data);\n\tself.postMessage({worker, key: message.key, index: message.index, data: result}, [result.buffer]);\n}\n'],{type:"application/javascript"}),t=URL.createObjectURL(e);this.ready=0,this.imports=[{name:"QuickSort",value:Ie},{name:"ConvexHullProducer",value:Se}].map(e=>URL.createObjectURL(new Blob([Object.toSource(e.value,e.name)],{type:"application/javascript"})));let r=navigator.hardwareConcurrency;for(let e=0;e<r;e++){let r=new Worker(t,{name:"ConvexHullChainWorker"+e});r.name=e,r.onmessage=e=>this.recieve(e.data),r.onerror=t=>this.recieveError(t,e),this.workers.push(r)}return URL.revokeObjectURL(t),this.status=Ge.Status.OPEN_IN_PROGRESS,new Promise((e,t)=>{this.workers.forEach(e=>e.postMessage({imports:this.imports})),this.resolve=e})}close(){this.workers.forEach(e=>e.terminate()),this.workers.clear(),this.status=Ge.Status.CLOSED}async add(e,t,r=[]){if(this.status!=Ge.Status.OPEN)throw new Error(`Producer is not opened yet. Current status is ${this.status.name}.`);let i=this.nextKey++,s=this.lastPolygon;return t.length>0&&(this.lastPolygon=t.last),e==m.Phase.END&&(this.lastPolygon=null),this.state[i]={addition:t,prediction:r,data:[...t.slice(),...r.slice()],queue:[...t.slice(),...r.slice()],lastPolygon:s,added:[],predicted:[],expected:t.length+r.length,processed:0},new Promise((e,t)=>{this.state[i].resolve=e,this.workers.forEach(e=>this.send(e.name,i))})}reset(){this.lastPolygon=null}send(e,t){let r=this.state[t],i=r.queue.shift();if(!i)return;let s=r.data.indexOf(i),n=(0==s?r.lastPolygon:r.data[s-1])||[];n.push(...i),this.workers[e].postMessage({key:t,index:s,data:n})}recieve(e){if(e.ready)return this.ready++,void(this.ready==this.workers.length&&(this.imports.forEach(e=>URL.revokeObjectURL(e)),this.resolve(),delete this.ready,delete this.resolve,this.status=Ge.Status.OPEN));let t,r,i=this.state[e.key];e.index>i.addition.length-1?(t=e.index-i.addition.length,r="predicted"):(t=e.index,r="added"),i[r][t]=e.data,i.processed++,i.processed==i.expected?(delete this.state[e.key],i.resolve({added:i.added,predicted:i.predicted})):this.send(e.worker,e.key)}recieveError(e,t){console.warn("worker "+t),console.error(e)}}Ge.createEnum("Status",["OPEN","OPEN_IN_PROGRESS","CLOSED"]);class ze{constructor(){this.queue=Promise.resolve(),this.thenables=[]}then(e,t,r){return this.thenables.push(e),this.queue=this.queue.then((...t)=>(this.thenables.shift(),e.canceled?Promise.resolve():e(...t))),t&&this.then(e=>t(e,r)),this}catch(e){return this.queue=this.queue.catch(e),this}cancel(){this.thenables.forEach(e=>e.canceled=!0)}isEmpty(){return 0==this.thenables.length}static async serial(e,t){let r=new ze;return e.forEach((e,i)=>r.then(e,t,i)),r.queue}}const Ye=[];class Xe extends Ue{constructor(){super(),this.convexHullChainProducer=new Ge,this.queue=Promise.resolve(),this.chainQueue=new ze}async open(){await this.convexHullChainProducer.open(),Ye.push(this.convexHullChainProducer)}close(){Ye.remove(this.convexHullChainProducer),this.convexHullChainProducer.close()}add(e,t){if(!this.onComplete)throw new Error("InkBuilder instance is not configured properly, onBuildComplete is not found");this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),super.add(e,t)}configure(e){this.chainQueue.isEmpty()?super.configure(e):this.chainQueue.then(()=>super.configure(e))}build(){if(this.phase){let e=this.phase;this.phase==m.Phase.END&&this.restart();let t=()=>Promise.resolve().then(()=>(this.buildPhase=e,this.buildSegment())).then(t=>{this.building=!1,this.aborted||(t.phase=e,t.predicted.predicted=!0,this.onComplete(t))});e==m.Phase.END?this.queue=this.queue.then(t):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=t())}}buildChain(){if(this.phase){let e=this.phase,t=this.getLastPathSegment();this.phase==m.Phase.END&&this.restart(),this.chainQueue.then(()=>(this.buildPhase=e,this.buildSegment(t))).then(t=>{t.phase=e,t.predicted.predicted=!0,this.onComplete(t)})}return this.chainQueue}getLastPathSegment(){let e=this.pathSegment;return this.pathSegment=new ve,e}buildSegment(e){e||(e=this.pathSegment);let t={added:e.accumulatedAddition,predicted:e.lastPrediction};t=this.smoother.add(e.first,e.last,t.added,t.predicted),t=this.splineProducer.add(e.first,e.last,t.added,t.predicted);let r=e.first,i=e.last;return e.reset(),this.processSegment(r,i,t.added,t.predicted)}processSegment(e,t,r,i){let s=this.splineInterpolator.add(e,t,r,i);return this.raster?Promise.resolve(s):s.added||s.predicted?(s=this.brushApplier.add(e,t,s.added,s.predicted),this.brush.spacing<=1?this.convexHullChainProducer.add(this.phase,s.added,s.predicted).then(r=>this.mergeAndSimplify(e,t,r)):Promise.resolve(s)):Promise.resolve({added:s.added?s.added.points:new Te,predicted:s.predicted?s.predicted.points:new Te})}async processSpline(e,t){let r=this.splineInterpolator.get(e);if(!this.raster)if(r){if(r=this.brushApplier.get(r),this.brush.spacing<=1){this.polygonMerger.filterDuplicates=t,r=(await this.convexHullChainProducer.add(m.Phase.END,r)).added,r=this.polygonMerger.get(r),r=this.polygonSimplifier.get(r)}}else r=new Te;return r}abort(){super.abort(),this.buildPhase=null,this.chainQueue.cancel()}static closeAll(){Ye.forEach(e=>e.close()),Ye.clear()}}function Ve(){}Ve.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};const $e=Ve.BlendMode;class He{constructor(e,t){Object.defineProperty(this,"ctx",{value:e,enumerable:!0}),Object.defineProperty(this,"value",{value:t,enumerable:!0}),Object.defineProperty(this,"texture",{value:t,enumerable:!0})}async update(e,t){if(Array.isArray(e)){let r=[],i=e;for(let e of i){let t=await ee(e);r.push(t)}this.completeMipMap(r),this.fill(r,t)}else{let t=e,r=await ee(t);this.fill(r)}}completeMipMap(e){if(e.sort((e,t)=>t.width-e.width),1==e.last.width)return;let t=e.last.width;for(;t>1;){t/=2;let r=new OffscreenCanvas(e.last.width/2,e.last.height/2);r.getContext("2d").drawImage(e.last,0,0,r.width,r.height),e.push(r)}}fill(e,t){let r=this.ctx,i=this.value;if(r.bindTexture(r.TEXTURE_2D,i),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(e)){let i=e;this.size=[],i.forEach((e,t)=>{r.texImage2D(r.TEXTURE_2D,t,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),this.size.push({width:e.width,height:e.height}),e.close&&e.close()}),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,t?r.LINEAR_MIPMAP_LINEAR:r.LINEAR_MIPMAP_NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)}else r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),this.size={width:e.width,height:e.height},e.close&&e.close();r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.bindTexture(r.TEXTURE_2D,null),this.logError(this.ctx,i.name)}readPixels(){let e=this.ctx,t=this.value,r=(r,i)=>{let s=new Uint8Array(r.width*r.height*4);return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,i),e.readPixels(0,0,r.width,r.height,e.RGBA,e.UNSIGNED_BYTE,s),s},i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);let s=Array.isArray(this.size)?this.size.map(r):r(this.size,0);return e.deleteFramebuffer(i),s}logError(){let e=this.ctx.getError();e>0&&console.error(`WebGL error - ${this.texture.name}: ${e}`)}static createInstance(e,t=e.CLAMP_TO_EDGE,r=e.NEAREST){let i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.bindTexture(e.TEXTURE_2D,null),new He(e,i)}static logGLError(e,t){let r=e.getError();r>0&&console.error(`WebGL error - ${t}: ${r}`)}}class qe{constructor(e,t,r,i={},s={}){this.name=e,this.spacing=i.spacing||.15,this.scattering=i.scattering||0,this.blendMode=i.blendMode||$e.SOURCE_OVER,this.rotationMode=i.rotationMode||qe.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:()=>({spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode,rotationMode:this.rotationMode}),enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:()=>({randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}),enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:()=>Array.isArray(this.descriptor.shape)?this.descriptor.shape.map(e=>e.value):this.descriptor.shape.value,enumerable:!0}),Object.defineProperty(this,"fill",{get:()=>this.descriptor.fill.value,enumerable:!0}),this.updateShape(t),this.updateFill(r,s)}async updateShape(e){Array.isArray(e)?e=e.map(e=>"string"==typeof e?K.getInstance(e):e instanceof K?e:new K(e.name,e.value)):"string"==typeof e?e=K.getInstance(e):e instanceof K||(e=new K(e.name,e.value)),this.descriptor.shape=e,this.ctx&&await this.configureShape()}async updateFill(e,t={}){if(this.randomizeFill=!("randomize"in t)||t.randomize,this.fillTextureSize=t.size,this.fillTextureOffset=t.offset||{x:0,y:0},Array.isArray(e))throw new Error("Mipmap is not compatible whith fill texture");"string"==typeof e?e=K.getInstance(e):e instanceof K||(e=new K(e.name,e.value)),this.descriptor.fill=e,this.ctx&&await this.configureFill()}async configure(e){this.ctx=e,await this.configureShape(),await this.configureFill()}async configureShape(){this.shapeTexture||(this.shapeTexture=He.createInstance(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),await this.shapeTexture.update(this.shape,this.spacing<=1)}async configureFill(){this.fillTexture||(this.fillTexture=He.createInstance(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),await this.fillTexture.update(this.fill),this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size)}async getShapeBinary(){let e;if(Array.isArray(this.shape)){let t=[];for(let e of this.shape){let r=await Q(e);t.push(r)}e=t}else e=await Q(this.shape);return e}async getFillBinary(){return await Q(this.fill)}toJSON(){return{type:this.constructor.name,name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map(e=>e.toJSON()):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}static fromJSON(e){e.particleSettings.blendMode=$e[e.particleSettings.blendMode],e.particleSettings.rotationMode=qe.RotationMode[e.particleSettings.rotationMode];let t=Array.isArray(e.shape)?e.shape.map(e=>K.fromJSON(e)):K.fromJSON(e.shape),r=K.fromJSON(e.fill);return new qe(e.name,t,r,e.particleSettings,e.fillTextureSettings)}equals(e){return e==this&&e.shapeTexture==this.shapeTexture&&e.fillTexture==this.fillTexture}delete(){this.deleteShape(),this.deleteFill()}deleteShape(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}deleteFill(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}let Ze,We;qe.createEnum("RotationMode",["NONE","RANDOM","TRAJECTORY"]);class Ke extends f{constructor(e,t,r,i){let s;super(t.id),Object.defineProperty(this,"layout",{value:t.layout,enumerable:!0}),Object.defineProperty(this,"points",{get:()=>t.points,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:t.pointProps,enumerable:!0}),Object.defineProperty(this,"ts",{value:t.ts,enumerable:!0}),Object.defineProperty(this,"tf",{value:t.tf,enumerable:!0}),Object.defineProperty(this,"stride",{value:t.stride,enumerable:!0}),Object.defineProperty(this,"length",{value:t.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:t.segmentsCount,enumerable:!0}),t.randomSeed&&Object.defineProperty(this,"randomSeed",{value:t.randomSeed,enumerable:!0}),Object.defineProperty(this,"color",{get:function(){return t.color},set:function(e){t.color=e,r&&(r.color=e)},enumerable:!0}),Object.defineProperty(this,"sensorData",{value:i,enumerable:!0}),Object.defineProperty(this,"spline",{value:t,enumerable:!0}),Object.defineProperty(this,"hasPath",{get:()=>!!r,enumerable:!0}),Object.defineProperty(this,"path",{get:function(){return r||this.buildPath(),r},set:function(e){r=e},enumerable:!0}),Object.defineProperty(this,"bounds",{get:function(){return s||(s=this.path.bounds),this.matrix?s.transform(this.matrix).ceil():s},enumerable:!0}),this.reset=(e,i)=>{e&&(t=e),r=i,this.resetBounds()},this.resetBounds=()=>s=null,Object.defineProperty(this,"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(this,"brush",{get:function(){return e||(e=this.descriptor.brush.value),e},set:function(r){if(this.reset(),"string"==typeof r?r=new K(r):r instanceof re||r instanceof qe?r=new K(r.name,r):r instanceof K||(r=new K(r.name,r.value)),r instanceof qe&&!t.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");e=null,this.descriptor.brush=r},enumerable:!0}),this.brush=e,this.renderMode=void 0,this.sensorDataOffset=0,this.sensorDataMapping=[]}clone(){let e=new Ke(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return e.renderMode=this.renderMode,e.sensorDataOffset=this.sensorDataOffset,e.sensorDataMapping=this.sensorDataMapping.clone(),e}async init(e){this.pathProceessInProgress=!0,We||(We=new Xe,await We.open()),We.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&We.configure(e),this.path=await We.processSpline(this.spline,this.target==Ke.Target.GL),delete this.pathProceessInProgress}buildPath(e){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");Ze||(Ze=new je),Ze.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&Ze.configure(e),this.path=Ze.processSpline(this.spline,this.target==Ke.Target.GL)}getSegment(e){let t=e,r=e+3,i=0==t?this.ts:0,s=r+1==this.length?this.tf:1;return this.spline.slice(t,r,i,s)}getSensorPoint(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t;if(this.sensorData){let r=this.sensorData.inkStream;if(r){let i;this.sensorDataMapping.length>0?i=e>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[e]:(i=this.sensorDataOffset+e,i>=r.length&&(i=r.length-1)),t=r.get(i),t.index=i,t.timespan=t.timestamp,t.timestamp+=this.sensorData.created}}return t}getPoint(e){return this.spline.getPoint(e)}setPoint(e,t){let r=e*this.stride;this.layout.forEach((e,i)=>this.points[r+i]=t.getProperty(e))}pointAt(e){return this.getPoint(e)}getAverageWidth(){let e=0;if(this.layout.includes(C.Property.SIZE)){let t=0;for(let e=0;e<this.length;e++)t+=this.getPoint(e).size;e=t/this.length}else e=this.pointProps.size;return e}split(e){let t=e.map(e=>this.subStroke(e));return t.includes(this)||0==t.length?void 0:t}subStroke(e){let{fromIndex:t,toIndex:r,fromTValue:i,toTValue:s}=e;if(0==t&&r+1==this.length&&i==this.ts&&s==this.tf)return this;{let e=this.spline.slice(t,r,i,s),n=new Ke(this.descriptor.brush,e,void 0,this.sensorData);return n.renderMode=this.renderMode,this.sensorData&&(n.sensorDataOffset=this.sensorDataOffset+t,this.sensorDataMapping.length>0?n.sensorDataMapping=this.sensorDataMapping.slice(t,r+1):n.sensorDataMapping=[]),n}}transform(e){e||(e=this.matrix,this.matrix=null),e&&(this.spline.transform(e),this.hasPath&&this.path.transform(e),this.resetBounds())}setTransform(e){this.matrix=e}static createInstance(e,t,r,i={},s,n=0,o=1){let a=i.color;a&&(delete i.color,(i=Object.assign({},i)).red=a.red,i.green=a.green,i.blue=a.blue,i.alpha=a.alpha);let h=new ce(r,t,i,n,o);return h.randomSeed=s,new Ke(e,h)}static validatePath(e){if(!e)return!1;if(0==e.length)return!1;if(e instanceof Te)return!0;if(Array.isArray(e))throw new Error("path should be instance of InkPath2D");let t=!1,r=0,i=!1,{size:s,red:n,green:o,blue:a,alpha:h}=e.pointProps;if(!(e instanceof fe)){let t=e.points.length,s=e.layout.length;i=0==t||t<4*s,r=t%s}return 0!=r?console.error(`The points array (length: ${e.points.length}) does not refer to provided layout (${e.layout.map(e=>e.name).join(", ")})`):i?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!e.layout.includes(C.Property.SIZE)&&isNaN(s)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!e.layout.includes(C.Property.RED)&&isNaN(n)?console.error("Either the color property must be set or the path layout must include a RED property"):!e.layout.includes(C.Property.GREEN)&&isNaN(o)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!e.layout.includes(C.Property.BLUE)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!e.layout.includes(C.Property.ALPHA)&&isNaN(h)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):t=!0,t}static decodeInkPath(e){if("InkPath2D"==e.type)return Te.fromJSON(e);if("InterpolatedSpline"==e.type)return fe.fromJSON(e);throw new Error("Decode ink path faild. Cannot identify type: "+e.type)}}if(Ke.RenderMode=Object.assign({},...Object.keys($e).map(e=>({[e]:"will://rasterization/3.0/blend-mode/"+F.getPropName(e,!0)}))),Ke.RenderMode.get=e=>Ke.RenderMode[F.getEnumValueName(e.replace(/-/g,"_"))],Ke.RenderMode.getBlendMode=e=>$e[Object.keys(Ke.RenderMode).filter(t=>Ke.RenderMode[t]==e).first],Ke.createEnum("Target",["2D","GL"]),l.type2D==l.Type2D.OFFSCREEN){const{Canvas:e,ImageData:t,Image:r}=require("canvas");global.OffscreenCanvas=e,global.ImageData=t,global.Image=r}class Je{constructor(e,t){let r={};"undefined"==typeof screen?(r.width=e,r.height=t):(r.width=Math.max(screen.width,screen.height),r.height=r.width),Object.defineProperty(this,"defaultSize",{value:r,enumerable:!0})}setTransform(e){this.transform=e}getExportCanvas(e){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}async toBlob(e,t="image/png",r=.92){if("undefined"==typeof Blob)throw"undefined"==typeof Buffer?new Error("Current environment do not have neither Blob nor Buffer support."):new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");let i=this.getExportCanvas(e);return i.toBlob?new Promise((e,s)=>i.toBlob(e,t,r)):i.convertToBlob({type:t,quality:r})}async toBuffer(e,t="image/png",r={}){if("undefined"==typeof Buffer)throw"undefined"==typeof Blob?new Error("Current environment do not have neither Blob nor Buffer support."):new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");let i=this.getExportCanvas(e);if(r.filters){let e=Array.isArray(r.filters)?r.filters.slice():[r.filters],t=0;e.forEach(e=>{t|=i["PNG_FILTER_"+e.name]}),Object.assign({},r,{filters:t})}return new Promise((e,s)=>i.toBuffer((t,r)=>t?s(t):e(r),t,r))}}Je.createEnum("PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);class Qe extends Je{get width(){return this.surface.width}get height(){return this.surface.height}constructor(e){super(e.canvas.width,e.canvas.height),Object.defineProperty(this,"surface",{value:e.canvas}),Object.defineProperty(this,"ctx",{value:e}),Object.defineProperty(this,"bounds",{get:()=>new q(0,0,this.width,this.height),enumerable:!0}),this.ctx.getContextAttributes||(this.ctx.getContextAttributes=()=>({}))}clear(e,t){if(t){if($.isColor(e))throw new Error("`clear` first argument should be Rectangle")}else $.isColor(e)&&(t=e,e=null);e||(e=this.bounds),this.ctx.clearRect(e.left,e.top,e.width,e.height),t&&(this.ctx.fillStyle=t.toString(),this.ctx.fillRect(e.left,e.top,e.width,e.height))}draw(e){return this.drawStroke(e.brush,e.path,e.color,e.matrix)}drawStroke(e,t,r,i){if(!Ke.validatePath(t))return null;if(t instanceof fe)return this.drawSpline(t,r);if(!(e instanceof re))throw new Error("Incompatible brush found. It should be Brush2D instance.");i?this.transform&&(i=this.transform.multiply(i)):i=this.transform;let s=t.bounds;return s&&(i&&(s=s.transform(i)),s=s.ceil()),s=this.bounds.intersect(s),s&&(this.ctx.save(),i?this.ctx.setTransform(i.a,i.b,i.c,i.d,i.tx,i.ty):(this.ctx.rect(s.left,s.top,s.width,s.height),this.ctx.clip()),t.holesClockwise=!0,this.drawPath(t,r.toRGB().toString()),e.pattern&&this.drawPath(t,e.pattern),this.ctx.restore()),s}drawPath(e,t){this.ctx.beginPath(),e.forEach((t,r)=>{if(this.ctx.moveTo(t[0],t[1]),e.holesClockwise||0==r)for(let e=2;e<t.length;e+=2)this.ctx.lineTo(t[e],t[e+1]);else for(let e=t.length-2;e>=0;e-=2)this.ctx.lineTo(t[e],t[e+1]);this.ctx.closePath()}),t&&(this.ctx.fillStyle=t),this.ctx.fill()}drawSpline(e,t){let r;t||(t=e.color),this.ctx.save(),this.ctx.fillStyle=`rgb(${t.red}, ${t.green}, ${t.blue})`;for(let t=0;t<e.length;t++){let i=e.getPoint(t),s=i.size/2;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),r=q.union(new q(i.x-s,i.y-s,i.size,i.size),r)}return this.ctx.restore(),r.ceil()}fill(e,t){let r;if(q.isRect(e))r=e;else{if("number"==typeof e[0])e=new Te(e);else if(!(e instanceof Te))throw new Error("fill shape type missmatch, expected InkPath2D");r=e.bounds}return r=this.bounds.intersect(r),r&&(r=r.ceil(),this.ctx.fillStyle=t.toString(),q.isRect(e)?this.ctx.fillRect(e.left,e.top,e.width,e.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.drawPath(e),this.ctx.restore())),r}blend(e,t={}){if(t.mode||(t.mode=$e.SOURCE_OVER),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");t.rect&&(t.sourceRect=t.rect,t.destinationRect=t.rect),this.ctx.save(),t.transform?this.ctx.setTransform(t.transform.a,t.transform.b,t.transform.c,t.transform.d,t.transform.tx,t.transform.ty):t.clipRect&&(this.ctx.rect(t.clipRect.left,t.clipRect.top,t.clipRect.width,t.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=t.mode,t.sourceRect&&t.destinationRect?this.ctx.drawImage(e.ctx.canvas,t.sourceRect.left,t.sourceRect.top,t.sourceRect.width,t.sourceRect.height,t.destinationRect.left,t.destinationRect.top,t.destinationRect.width,t.destinationRect.height):this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}createImageData(e,t,r){return new ImageData(e,t,r)}getImageData(e){return e||(e=this.bounds),this.ctx.getImageData(e.x,e.y,e.width,e.height)}putImageData(e,t=0,r=0){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.ctx.putImageData(e,t,r)}readPixels(e){return this.getImageData(e).data}writePixels(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t||(t=this.bounds),this.putImageData(this.createImageData(e,t.width,t.height),t.x,t.y)}getExportCanvas(e){let t=this.surface;return e&&(e=e.intersect(this.bounds).ceil(),t=new OffscreenCanvas(e.width,e.height),t.getContext("2d").putImageData(this.getImageData(e),0,0)),t}resize(e,t){this.surface.width=e,this.surface.height=t}}class et extends Qe{constructor(e){super(e)}static createInstance(e,t,r,i){if(!e||"function"!=typeof e.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(t>0&&r>0&&(e.width=t,e.height=r),!(e.width>0&&e.width>0))throw new Error("width and height are required and should be positive whole numbers");return new et(e.getContext("2d",i))}createLayer(e,t){if(!e||!t){let r=this.defaultSize;e=r.width,t=r.height}let r=new OffscreenCanvas(e,t);return new Qe(r.getContext("2d",this.ctx.getContextAttributes()))}}class tt{constructor(e,t){this.canvas=e,this.layer=t||e.createLayer(),this.preliminaryLayer=void 0,this.ownLayer=!t,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=$.TRANSPERENT,this.blendMode=$e.SOURCE_OVER,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,color:this.color,backgroundColor:this.backgroundColor,blendMode:this.blendMode,transform:this.transform}),enumerable:!0})}configure(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),"transform"in e&&this.setTransform(e.transform),this.restart=!0}setTransform(e){this.transform=e,this.layer.setTransform(e),this.preliminaryLayer&&this.preliminaryLayer.setTransform(e)}draw(e,t=!1){if(e instanceof Ke){let t=e,r=$e.SOURCE_OVER;if(!(t.brush instanceof re))throw new Error("Incompatible brush found. It should be Brush2D instance.");if(t.renderMode&&(r=Ke.RenderMode.getBlendMode(t.renderMode),!r))return void console.warn(`Cannot process ${t.renderMode} render mode. Requres custom processing.`);this.color=t.color,this.blendMode=r,this.reset(),t.target=Ke.Target["2D"];let i=this.layer.draw(t);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(e)){let t=this.layer.drawStroke(this.brush,e,this.color,e.matrix);t&&(this.incompleteStrokeBounds=t.union(this.incompleteStrokeBounds),this.strokeBounds=t.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.restart=!0)}}drawPreliminary(e){if(!this.validate(e))return;let t=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.setTransform(this.transform)),t=this.preliminaryLayer):t=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:$e.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=t.drawStroke(this.brush,e,this.color,e.matrix),this.updatedArea=q.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}abort(){this.restart=!0}reset(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer||(this.alphaLayer=this.canvas.createLayer())),this.restart=!1}validate(e){return e&&e.length>0}blendUpdatedArea(e){if(!this.updatedArea)return;let t=e||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,i=t.bounds.intersect(this.updatedArea);if(i){let e=this.color.alpha;e<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(t,{rect:i}),this.alphaLayer.ctx.globalAlpha=e,this.alphaLayer.blend(r,{mode:this.blendMode,rect:i}),t.clear(i),t.blend(this.alphaLayer,{rect:i})):t.blend(r,{mode:this.blendMode,rect:i})}this.incompleteStrokeBounds=null,this.updatedArea=null}blendStroke(e,t,r){if(!this.strokeBounds)return;r||(r=this.blendMode);let i=this.layer,s=e||this.canvas;if(t=s.bounds.intersect(t||this.strokeBounds)){let e=this.color.alpha;e<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=e,this.alphaLayer.blend(i,{rect:t}),s.blend(this.alphaLayer,{mode:r,rect:t})):s.blend(i,{mode:r,rect:t})}}toStroke(e,t){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");let r=e.getSensorData(),i=e.getSpline(),s=e.getInkPath(t),n=new Ke(this.brush,i,s,r);return r&&(n.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=$e.SOURCE_OVER&&(n.renderMode=Ke.RenderMode.get(this.blendMode)),n}delete(){console.warn("Not applicable with 2D API")}}let rt=void 0;l.typeGL==l.TypeGL.STACK&&(rt=require("gl"));var it=rt;var st=it?class{constructor(e=300,t=150){this.width=e,this.height=t}getContext(e="webgl",t){if(!this.context){let e=this.width,r=this.height;this.context=it(e,r,t),this.context.canvas=this;let i=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:()=>e,set:t=>{e=t,i.resize(e,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:()=>e,set:t=>{r=t,i.resize(e,r)},enumerable:!0})}return this.context}destroy(){if(this.context){this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context}}}:void 0;class nt extends Je{constructor(e,t={}){if(super(e.gl.canvas.width,e.gl.canvas.height),this.inkGLContext=e,this.gl=e.gl,this.scaleFactor=t.scaleFactor||1,this.flipY=!!t.flipY,this.useTextureStorage=!1,t.renderbuffer){if(!t.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");let e=this.initWithGLBuffers(t.framebuffer,t.renderbuffer);this.flipY=!0,this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else if(t.framebuffer){let e=this.initWithGLFramebuffer(t.framebuffer);this.flipY=!0,this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else if(t.texture){if(!(t.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");let e;if(this.texture=t.texture,this.useTextureStorage=!0,t.width>0&&t.height>0)e={width:t.width,height:t.height};else if(this.texture.image)e={width:this.texture.image.width,height:this.texture.image.height};else{if(!this.texture.size)throw new Error("`width` and `height` are required when `texture` is available");e=this.texture.size}this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else{let e=Math.min(t.width||this.defaultSize.width,4e3),r=Math.min(t.height||this.defaultSize.height,4e3);if(this.setDimensions(e,r),t.display)this.framebuffer=null,this.renderbuffer=null,this.texture=null;else if(this.useTextureStorage=!t.useBuffersStorage,this.ownGLResources=!0,this.useTextureStorage){let e=this.inkGLContext.generateBuffersExt(this.storageWidth,this.storageHeight,this.gl.LINEAR,this.gl.UNSIGNED_BYTE);this.framebuffer=e.framebuffer,this.texture=e.texture}else{let e=this.inkGLContext.genFrameAndRenders(this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight);this.framebuffer=e.framebuffer,this.renderbuffer=e.renderbuffer}}this.releaseRenderbuffer=!1,this.deleted=!1}initWithGLFramebuffer(e){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");let t,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return t=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(e,t)}initWithGLBuffers(e,t){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(t instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");let r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t);let i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),s=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=e,this.renderbuffer=t,{width:i,height:s}}setDimensions(e,t){let r=Math.ceil(e*this.scaleFactor),i=Math.ceil(t*this.scaleFactor),s=new H(0,0,e,t),n=new H(0,0,r,i);Object.defineProperties(this,{width:{value:e,enumerable:!0,configurable:!0},height:{value:t,enumerable:!0,configurable:!0},graphicsBounds:{value:s,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:i,enumerable:!0,configurable:!0},storageBounds:{value:n,enumerable:!0,configurable:!0}})}resize(e,t){e>0&&t>0&&(this.width!=e||this.height!=t)&&(this.setDimensions(e,t),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}fillTexture(e){if(!this.texture)throw new Error("Underlying layer is not texture based");new He(this.gl,this.texture).fill(e)}delete(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}deleteLater(){setTimeout(()=>this.delete(),0)}isDeleted(){return this.deleted}}class ot{constructor(e){this.randomSeed=e||parseInt(Date.now()/1e3)}copyTo(e){e.randomSeed=this.randomSeed}}class at extends nt{constructor(e,t){super(e.inkGLContext,t),this.convexHullChainProducer=new _e,this.polygonSimplifier=new Be,Object.defineProperty(this,"inkContext",{value:e,enumerable:!0}),Object.defineProperty(this,"bounds",{get:()=>q.fromGLRect(this.graphicsBounds),enumerable:!0})}clear(e,t){if(t){if($.isColor(e))throw new Error("`clear` first argument should be Rect")}else $.isColor(e)?(t=e,e=null):t=$.TRANSPERENT;let r;if(q.isRect(e)){if(!e.intersect(this.bounds))return;r=q.fromRect(e).toGLRect()}Array.isArray(e)||e instanceof Float32Array?this.fill(e,t,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(t)),r&&this.inkContext.disableTargetClipRect()}draw(e){let t,r=e.brush;return r instanceof qe?isFinite(e.randomSeed)&&(t=new ot(e.randomSeed)):t=e.color,this.drawStroke(r,e.path,t)}drawStroke(e,t,r){if(!Ke.validatePath(t))return null;this.inkContext.setTarget(this);let i=this.inkContext.drawStroke(e,t,r);return i instanceof H&&(i=q.fromGLRect(i)),i}fill(e,t,r=!0){let i,s=!1;if(q.isRect(e))i=e,e=new Te(e.toPath().points),s=!0;else{if("number"==typeof e[0])e=new Te(e);else if(!(e instanceof Te))throw new Error("fill shape type missmatch, expected InkPath2D");i=e.bounds}if(i=this.bounds.intersect(i),i){s||(e=this.convexHullChainProducer.get(e)),e=this.polygonSimplifier.get(e);let n=this.inkContext.triangulate(e);n.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(n,t,r)):i=void 0}return i?i.ceil():void 0}blend(e,t={}){if(t.mode||(t.mode=$e.SOURCE_OVER),t.rect&&!t.transform&&(t.sourceRect=t.rect,t.destinationRect=t.rect),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,q.isRect(t.clipRect)?q.fromRect(t.clipRect).toGLRect():void 0),"boolean"==typeof t.flipY&&(e.flipY=t.flipY),t.transform&&t.rect){let r=q.fromRect(t.rect).toGLRect().toQuad(),i=q.fromRect(t.rect).toGLRect().toQuad(t.transform);this.inkContext.drawLayer(e,r,i,t.mode)}else t.transform?this.inkContext.drawLayerWithTransform(e,t.transform,t.mode):t.sourceRect&&t.destinationRect?this.inkContext.drawLayer(e,q.fromRect(t.sourceRect).toGLRect().toQuad(),q.fromRect(t.destinationRect).toGLRect().toQuad(),t.mode):this.inkContext.drawLayerWithTransform(e,null,t.mode)}createImageData(e,t,r){return e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),new ImageData(e,t,r)}getImageData(e){return e||(e=this.bounds),this.createImageData(this.readPixels(e,!0),e.width,e.height)}putImageData(e,t=0,r=0){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.writePixels(e.data,new q(t,r,e.width,e.height))}readPixels(e,t){e&&(e=q.fromRect(e).toGLRect()),this.inkContext.setTarget(this);let r=this.inkContext.readPixels(e);if(t)for(let e=0;e<r.length;e+=4){let t=r[e+3];r[e]=parseInt(255*r[e]/t),r[e+1]=parseInt(255*r[e+1]/t),r[e+2]=parseInt(255*r[e+2]/t)}return r}writePixels(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t&&(t=q.fromRect(t).toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(t,e)}getExportCanvas(e){e=e?e.intersect(this.bounds).ceil():this.bounds;let t=new OffscreenCanvas(e.width,e.height);return t.getContext("2d").putImageData(this.getImageData(e),0,0),t}}let ht;ht=l.commonJS?require("poly2tri"):poly2tri;const{SweepContext:lt,Point:ut}=ht;class dt{constructor(e){if(!e)throw new Error("GL context is not available in current environment");let t;this.gl=e,this.program=null,this.programs=[],Object.defineProperty(this,"blendMode",{get:function(){return t},set:function(e){if(!e)throw new Error("blendMode is required");t!=e&&(this.activeBlendMode(e),t=e)},enumerable:!0}),Object.defineProperty(dt,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(dt,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(dt,"SPRITES_BATCH_SIZE",{value:1e3,enumerable:!0})}init(e,t){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.blendMaxFallback=!this.gl.MAX&&!this.blendMinMaxExt,this.blendMode=$e.COPY,this.resize(e,t),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.onChange();for(let e=0;e<this.programs.length;e++)this.programs[e].init()}getSupportedFloatPrecision(e){return this.gl.getShaderPrecisionFormat(e,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(e,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}random(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}static random(e){return(1103515245*e+12345&2147483647)/2147483647}setUniforms(e){let t=i.create();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),e?i.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):i.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=t,this.onChange()}resize(e,t){this.gl.viewport(e.x,e.y,e.width,e.height),this.bounds=e,this.graphicsBox=t,this._clipRect=this.graphicsBox}activeBlendMode(e){switch(e){case $e.COPY:this.gl.disable(this.gl.BLEND);break;case $e.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case $e.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case $e.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case $e.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case $e.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case $e.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case $e.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case $e.MIN:this.gl.enable(this.gl.BLEND),this.gl.MIN?this.gl.blendEquation(this.gl.MIN):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case $e.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case $e.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case $e.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: "+e)}}clearColorBuffer(e){this.gl.clearColor(e.red*e.alpha/255,e.green*e.alpha/255,e.blue*e.alpha/255,e.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}scissors(e){if(e&&!(e instanceof H))throw new TypeError("rect must be undefined or instanceof RectGL");let t=this.gl.isEnabled(this.gl.SCISSOR_TEST);e?(t||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(e.x,e.y,e.width,e.height)):t&&this.gl.disable(this.gl.SCISSOR_TEST)}isProgramActive(e){return this.program==e}activateProgram(e){this.isProgramActive(e)?e.contextChanged&&(e.onContextChange(),e.contextChanged=!1):(this.program&&this.program.onDeactivate(),this.gl.useProgram(e.program),this.program=e,e.onActivate(),e.onContextChange(),e.contextChanged=!1)}generateBuffersExt(e,t,r,i){let s=this.gl,n=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,n);let o=s.createTexture();return s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,i,null),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,o,0),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),{framebuffer:n,texture:o}}genFrameAndRenders(e,t,r){let i=this.gl.createFramebuffer(),s=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,s),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,e,t,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,s),{framebuffer:i,renderbuffer:s}}deleteBuffers(e,t){t&&this.gl.deleteTexture(t),e&&this.gl.deleteFramebuffer(e)}deleteFrameAndRender(e,t){t&&this.gl.deleteRenderbuffer(t),e&&this.gl.deleteFramebuffer(e)}onChange(){for(let e=0;e<this.programs.length;e++)this.programs[e].contextChanged=!0}enableStencilBufferForBlending(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT),this.isStencilBufferAvailable()||this.attachStencilBufferForBlending(e)}isStencilBufferAvailable(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}attachStencilBufferForBlending(e){let t=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING);if(e.framebuffer==t){let t=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.STENCIL_INDEX8,e.width,e.height),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.RENDERBUFFER,t),e.renderbuffer=t,e.releaseRenderbuffer=!0}}drawArrays(e,t,r){this.blendMode==$e.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawArrays.bind(this.gl,e,t,r)):this.gl.drawArrays(e,t,r)}drawElements(e,t,r,i){this.blendMode==$e.MAX&&this.blendMaxFallback?this.drawBlendMaxFallback(this.gl.drawElements.bind(this.gl,e,t,r,i)):this.gl.drawElements(e,t,r,i)}drawBlendMaxFallback(e){this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),e(),this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),e(),this.gl.disable(this.gl.STENCIL_TEST)}}class ct{constructor(e){Object.defineProperties(this,{inkGLContext:{value:e,enumerable:!0},gl:{value:e.gl,enumerable:!0}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}init(){}compileShader(e,t){let r=this.gl.createShader(t);if(this.gl.shaderSource(r,e),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw new Error(`${this.constructor.name} could not compile shader: ${this.gl.getShaderInfoLog(r)}`);return r}createProgram(e,t){let r=this.gl.createProgram();if(this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS))throw new Error(`${this.constructor.name} failed to link: ${this.gl.getProgramInfoLog(r)}`);return r}onActivate(){}onDeactivate(){}onContextChange(){}activate(){this.inkGLContext.activateProgram(this)}}class pt extends ct{constructor(e){super(e),this.vertsBuffer=this.gl.createBuffer(),this.colorsBuffer=this.gl.createBuffer()}init(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}onContextChange(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}onDeactivate(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}drawVertices(e,t,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),e.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,e.length/2)}drawPathVerticesPatch(e,t,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),e.length&&(this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length/2),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length/2))}static getVertexShader(){return`\n\t\t\tprecision ${dt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t`}static getFragmentShader(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}class ft extends ct{constructor(e){super(e),this.destBuffer=this.gl.createBuffer(),this.srcBuffer=this.gl.createBuffer()}init(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}onDeactivate(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}drawTexture(e,t,r,i,s){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,i),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,s),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}static getVertexShader(){return`\n\t\t\tprecision ${dt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t`}static getFragmentShader(){return`\n\t\t\tprecision ${dt.FRAGMENT_SHADER_PRECISION} float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t`}}class gt extends ct{constructor(e){super(e),this.buffer=this.gl.createBuffer(),this.indexBuffer=this.gl.createBuffer()}init(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}setBrush(e){this.brush=e,this.brushChanged=!0}onActivate(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);let e=19*Float32Array.BYTES_PER_ELEMENT;this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,e,0*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_xys,3,this.gl.FLOAT,!1,e,2*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteRotation,1,this.gl.FLOAT,!1,e,5*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_spriteScaleAndOffset,4,this.gl.FLOAT,!1,e,6*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,e,10*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_velocity,2,this.gl.FLOAT,!1,e,14*Float32Array.BYTES_PER_ELEMENT),this.gl.vertexAttribPointer(this.a_transformParams,3,this.gl.FLOAT,!1,e,16*Float32Array.BYTES_PER_ELEMENT),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.enableVertexAttribArray(this.a_xys),this.gl.enableVertexAttribArray(this.a_spriteRotation),this.gl.enableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.enableVertexAttribArray(this.a_color),this.gl.enableVertexAttribArray(this.a_velocity),this.gl.enableVertexAttribArray(this.a_transformParams)}onContextChange(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}onDeactivate(){this.gl.disableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_color),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}updateTextures(){this.brushChanged&&(this.brushChanged=!1,this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture.value),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture.value),this.gl.uniform1i(this.u_fillTexture,1))}drawSpritesBatch(e,t,r){let i;this.activate(),this.updateTextures();let s=t*dt.SPRITES_BATCH_SIZE,n=s+dt.SPRITES_BATCH_SIZE;n>e.length&&(n=s+e.length%dt.SPRITES_BATCH_SIZE);let o=n-s,a=new Float32Array(76*o),h=new Uint16Array(6*o),l=this.brush.rotationMode==qe.RotationMode.TRAJECTORY?1:0;for(let t=s;t<n;t++){let r=e.getPoint(t),n=76*(t-s);i=H.calculateBrushGLSegmentBounds(r,this.brush.scattering).union(i);let o=r.red/255*r.alpha,h=r.green/255*r.alpha,u=r.blue/255*r.alpha;0==r.dX&&0==r.dY&&(r.dX=2*this.inkGLContext.random()-1,r.dY=2*this.inkGLContext.random()-1);let d=this.brush.rotationMode==qe.RotationMode.RANDOM?2*this.inkGLContext.random()*Math.PI:0,c=(2*this.inkGLContext.random()-1)*this.brush.scattering;H.SQURE.forEach((e,t)=>{let i=n+19*t;a[i]=e.x,a[i+1]=e.y,a[i+2]=r.x,a[i+3]=r.y,a[i+4]=r.size,a[i+5]=r.rotation,a[i+6]=r.scaleX,a[i+7]=r.scaleY,a[i+8]=r.offsetX,a[i+9]=r.offsetY,a[i+10]=o,a[i+11]=h,a[i+12]=u,a[i+13]=r.alpha,a[i+14]=r.dX,a[i+15]=r.dY,a[i+16]=l,a[i+17]=d,a[i+18]=c})}let u=0;for(let e=0;e<h.length;e+=6)h[e]=u,h[e+1]=u+1,h[e+2]=u+2,h[e+3]=u+2,h[e+4]=u+1,h[e+5]=u+3,u+=4;return this.gl.bufferData(this.gl.ARRAY_BUFFER,a,this.gl.STATIC_DRAW),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,h,this.gl.STATIC_DRAW),this.inkGLContext.drawElements(this.gl.TRIANGLES,h.length,this.gl.UNSIGNED_SHORT,0),i}static getVertexShader(){return`\n\t\t\tprecision ${dt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t`}static getFragmentShader(e){return`\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ${e?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)"};\n\n\t\t\t}\n\t\t`}}class mt{constructor(e,t){let r=e.getContext("webgl2",t)||e.getContext("webgl",t);this.inkGLContext=new dt(r),this.gl=this.inkGLContext.gl,this.simpleProgram=new pt(this.inkGLContext),this.textureProgram=new ft(this.inkGLContext),this.spriteProgram=new gt(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new H(0,0,0,0),new H(0,0,0,0))}createLayer(e,t){return new nt(this.inkGLContext,e,t)}drawLayerWithTransform(e,t,r){if(!this.currentTarget)return;let i=e.graphicsBounds.toQuad(),s=e.graphicsBounds.toQuad(t);this.drawLayer(e,i,s,r)}drawLayer(e,t,r,s){if(!this.currentTarget)return;if(!e.useTextureStorage)return;let n=i.create(),o=i.create(),a=this.currentTarget;a.flipY?i.ortho(o,0,a.width,a.height,0,1,-1):i.ortho(o,0,a.width,0,a.height,1,-1),e.flipY?i.ortho(n,-e.width,e.width,2*e.height,0,0,1):i.ortho(n,-e.width,e.width,-e.height,e.height,0,1),this.inkGLContext.blendMode=s,this.textureProgram.drawTexture(e.texture,r,t,o,n)}setTarget(e,t){let r=this.inkGLContext,i=r.gl;if(e&&!(e instanceof nt))throw new TypeError("layer must be unset or instanceof InkLayer");if(t&&!(t instanceof H))throw new TypeError("clipRect must be unset or instanceof RectGL");if(e){this.currentTarget=e;let s=new H(0,0,e.storageWidth,e.storageHeight),n=new H(0,0,e.width,e.height);r.resize(s,n),r.setUniforms(e.flipY),t?this.setTargetClipRect(t):this.disableTargetClipRect(),i.bindFramebuffer(i.FRAMEBUFFER,e.framebuffer)}}clearColor(e){this.inkGLContext.clearColorBuffer(e)}setTargetClipRect(e){let t=this.inkGLContext;e=e.floor().intersect(this.currentTarget.graphicsBounds),t._clipRect=e;let r=this.currentTarget.scaleFactor;e=this.currentTarget.flipY?new H(e.x,this.currentTarget.storageHeight-e.top,e.width,e.height):new H(e.x*r,e.y*r,e.width*r,e.height*r),t.scissors(e)}disableTargetClipRect(){let e=this.inkGLContext;e.scissors(null),e._clipRect=e.graphicsBox}drawStroke(e,t,r){return this.currentTarget?0==t.length?null:(this.inkGLContext.blendMaxFallback&&e.blendMode==$e.MAX&&this.inkGLContext.enableStencilBufferForBlending(this.currentTarget),e instanceof qe?this.drawGL(e,t,r):this.draw2D(e,t,r)):null}drawGL(e,t,r){let i,s=null,n=this.inkGLContext._clipRect;r&&(i=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),e.blendMode?this.inkGLContext.blendMode=e.blendMode:this.inkGLContext.blendMode=$e.SOURCE_OVER,this.spriteProgram.setBrush(e);let o=Math.ceil(t.length/dt.SPRITES_BATCH_SIZE);for(let e=0;e<o;e++){s=this.spriteProgram.drawSpritesBatch(t,e).union(s)}return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=i),s=n.intersect(s),s&&(s=s.ceil()),s}draw2D(e,t,r){let i=this.currentTarget.bounds.intersect(t.bounds);if(!i)return null;if(e.spacing>1)t.forEach(e=>{let t=this.triangulate([e]);this.fillStroke(t,r)});else{let e=this.triangulate(t);this.fillStroke(e,r)}return i}triangulate(e){let t=[],r=[],i=0;e.forEach(e=>{let t=[];for(let r=0;r<e.length;r+=2){let s=new ut(e[r],e[r+1]);s.index=i++,t.push(s)}r.push(t)});let s=new lt(r.shift());r.forEach(e=>s.addHole(e));let n=[];try{s.triangulate(),n=s.getTriangles()}catch(e){console.warn(e)}return t.index=[],n.forEach(e=>{let r=e.getPoints().filter(e=>isFinite(e.index));3==r.length?r.forEach(e=>{t.push(e.x,e.y),t.index.push(e.index)}):console.warn("Undefined triangle:",e.getPoints())}),t}fillStroke(e,t){this.fill(e,t,!0,!0)}fill(e,t,r,i){t=t.premultiply();let s=r?4:1,n=s*s,o=1.01/n,a=1.25/s,h=r?new $(o*t.red,o*t.green,o*t.blue,o*t.alpha):t,l=new Float32Array(e.length*n),u=new Float32Array(2*e.length*n),d=0,c=0;for(let t=0;t<s;t++)for(let r=0;r<s;r++){let i={x:t*a-(1.25-a)/2,y:r*a-(1.25-a)/2};for(let t=0;t<e.length;t+=6){let r=[{x:e[t],y:e[t+1]},{x:e[t+2],y:e[t+3]},{x:e[t+4],y:e[t+5]}];for(let e=0;e<3;e++)l[d++]=r[e%3].x+i.x,l[d++]=r[e%3].y+i.y,u[c++]=h.red,u[c++]=h.green,u[c++]=h.blue,u[c++]=h.alpha}}let p=$e.SOURCE_OVER;i?p=$e.MAX:r?p=$e.LIGHTER:t.equals($.TRANSPERENT)&&(p=$e.COPY),this.inkGLContext.blendMode=p,this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),i?this.simpleProgram.drawPathVerticesPatch(l,u):this.simpleProgram.drawVertices(l,u)}readPixels(e){let t=this.currentTarget,r=this.inkGLContext.gl;if(e){if(!(e instanceof H))throw new TypeError("box must be instance of RectGL")}else e=t.graphicsBounds;t.flipY&&(e=new H(e.x,t.height-e.y-e.height,e.width,e.height)),this.setTarget(t);let i=new Uint8Array(e.width*e.height*4);return r.readPixels(parseInt(e.x*t.scaleFactor),parseInt(e.y*t.scaleFactor),parseInt(e.width*t.scaleFactor),parseInt(e.height*t.scaleFactor),r.RGBA,r.UNSIGNED_BYTE,i),i}writePixels(e,t){if(e&&!(e instanceof H))throw new TypeError("rect must be instance of RectGL");let r=this.currentTarget,i=this.inkGLContext.gl;if(e||(e=new H(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");{r.flipY&&(e=new H(e.x,r.height-e.y-e.height,e.width,e.height));let s=new H(e.x*r.scaleFactor,e.y*r.scaleFactor,e.width*r.scaleFactor,e.height*r.scaleFactor);i.finish(),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,r.texture),i.texSubImage2D(i.TEXTURE_2D,0,parseInt(s.x),parseInt(s.y),parseInt(s.width),parseInt(s.height),i.RGBA,i.UNSIGNED_BYTE,t)}}}class yt extends at{constructor(e){super(e,{display:!0,width:e.inkGLContext.gl.canvas.width,height:e.inkGLContext.gl.canvas.height,flipY:l.typeGL==l.TypeGL.WEB}),Object.defineProperty(this,"surface",{value:e.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(this,"ctx",{value:e.inkGLContext.gl,enumerable:!0});let t=this.ctx.getContextAttributes();if("function"==typeof requestAnimationFrame&&!t.preserveDrawingBuffer){let e=this.createLayer();Object.defineProperty(this,"backbuffer",{value:e,enumerable:!0});let t=r=>{this.present&&(delete this.present,super.blend(e,{mode:$e.COPY})),this.frameID=requestAnimationFrame(t)};this.frameID=requestAnimationFrame(t)}}test(){this.testBuffer||(this.testCnt=0,this.testBuffer=this.ctx.createBuffer()),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.testBuffer);let e=Date.now();this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([0,0,0,0,0,0,0,0]),this.ctx.DYNAMIC_DRAW),e=Date.now()-e,e>5&&this.testCnt<100?setTimeout(()=>{this.testCnt++,this.test()},100):(this.ctx.deleteBuffer(this.testBuffer),delete this.testBuffer,delete this.testCnt)}createLayer(e){return new at(this.inkContext,e)}clear(e,t){this.backbuffer?(this.backbuffer.clear(e,t),this.present=!0):super.clear(e,t)}draw(e,t){let r;return this.backbuffer?(r=this.backbuffer.draw(e,t),this.present=!0):r=super.draw(e,t),r}drawStroke(e,t,r){let i;return this.backbuffer?(i=this.backbuffer.drawStroke(e,t,r),this.present=!0):i=super.drawStroke(e,t,r),i}fill(e,t,r){let i;return this.backbuffer?(i=this.backbuffer.fill(e,t,r),this.present=!0):i=super.fill(e,t,r),i}blend(e,t){this.backbuffer?(this.backbuffer.blend(e,t),this.present=!0):super.blend(e,t)}readPixels(e,t){return this.backbuffer?this.backbuffer.readPixels(e,t):super.readPixels(e,t)}writePixels(e,t){this.backbuffer?(this.backbuffer.writePixels(e,t),this.present=!0):super.writePixels(e,t)}async toBlob(e=this.bounds,t,r){return this.backbuffer?await this.backbuffer.toBlob(e,t,r):await super.toBlob(e,t,r)}resize(e,t){super.resize(e,t),this.surface.width=e,this.surface.height=t}delete(){"number"==typeof this.frameID&&cancelAnimationFrame(this.frameID),super.delete(),this.backbuffer&&this.backbuffer.delete()}deleteLater(){return super.deleteLater(),this.backbuffer&&this.backbuffer.deleteLater(),this}static createInstance(e,t,r,i){if(!e||"function"!=typeof e.getContext)throw new Error("WebGL context provider is required");if(t>0&&r>0&&(e.width=t,e.height=r),!(e.width>0&&e.width>0))throw new Error("width and height are required and should be positive whole numbers");let s=new mt(e,i);return new yt(s)}}class bt{constructor(e,t){this.canvas=e;let r=t instanceof at?t:void 0,i=t&&!r?t:new Object;this.layer=r||e.createLayer(i),this.preliminaryLayer=void 0,this.layerOptions=i,this.ownLayer=!r,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=$.TRANSPERENT,this.blendMode=$e.SOURCE_OVER,this.randomSeed=void 0,this.transform=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,color:this.color,backgroundColor:this.backgroundColor,blendMode:this.blendMode,transform:this.transform,randomSeed:this.initialRandomSeed}),enumerable:!0})}configure(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),"transform"in e&&this.setTransform(e.transform),this.brush instanceof qe&&isFinite(e.randomSeed)&&(this.initialRandomSeed=e.randomSeed),this.restart=!0}setTransform(e){this.transform=e,this.layer.setTransform(e),this.preliminaryLayer&&this.preliminaryLayer.setTransform(e)}draw(e,t=!1){if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),e instanceof Ke){let t,r=e,i=$e.SOURCE_OVER;if(r.renderMode&&(i=Ke.RenderMode.getBlendMode(r.renderMode),!i))return void console.warn(`Cannot process ${r.renderMode} render mode. Requres custom processing.`);this.blendMode=i,r.target=Ke.Target.GL,this.transform&&!this.transform.isIdentity&&(t=r.path.clone(),r.path.transform(this.transform));let s=this.layer.draw(r);t&&(r.path=t),this.strokeBounds=s,this.updatedArea=s,this.restart=!0}else{if(this.validate(e)){e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color),this.transform&&!this.transform.isIdentity&&e.transform(this.transform);let t=this.brush instanceof qe?this.strokeLastRendererdDrawContext:this.color,r=this.layer.drawStroke(this.brush,e,t);r&&(this.incompleteStrokeBounds=r.union(this.incompleteStrokeBounds),this.strokeBounds=r.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.restart=!0)}}drawPreliminary(e){if(!this.validate(e))return;let t=null,r=null;this.brush instanceof qe?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),t=this.strokePrelimLastRenderedDrawContext):t=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.setTransform(this.transform)),r=this.preliminaryLayer):r=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:$e.COPY,rect:this.updatedArea}),e.color&&this.color&&!e.color.equals(this.color)&&(e.color=this.color),this.transform&&!this.transform.isIdentity&&e.transform(this.transform),this.preliminaryDirtyArea=r.drawStroke(this.brush,e,t),this.updatedArea=q.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}abort(){this.restart=!0}reset(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof qe?(this.strokeLastRendererdDrawContext=new ot(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new ot),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}validate(e){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return e&&e.length>0}blendUpdatedArea(e){if(!this.updatedArea)return;let t=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=e||this.canvas,i=r.bounds.intersect(this.updatedArea);i&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(t.getImageData(i),i,!1):r.blend(t,{mode:this.blendMode,rect:i})),this.incompleteStrokeBounds=null,this.updatedArea=null}blendStroke(e,t,r){if(!this.strokeBounds)return;r||(r=this.blendMode);let i=this.layer,s=e||this.canvas;(t=s.bounds.intersect(t||this.strokeBounds))&&("function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(i.getImageData(t),t,!0):s.blend(i,{mode:r,rect:t}))}toStroke(e){let t=e.getSensorData(),r=e.getSpline(),i=e.getInkPath();r.randomSeed=this.randomSeed;let s=new Ke(this.brush,r,i,t);return t&&(s.sensorDataMapping=t.inkStream.getPipelineMapping()),this.blendMode!=$e.SOURCE_OVER&&(s.renderMode=Ke.RenderMode.get(this.blendMode)),s}delete(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}class Et{constructor(e,t,r){this.subject=e,this.predicate=t,this.object=r}}class Pt{constructor(){this.statements=[]}add(...e){e.forEach(e=>this.statements.push(e))}remove(...e){e.forEach(e=>this.statements.remove(e))}addTriple(e,t,r){this.statements.push(new Et(e,t,r))}search(e){return this.statements.filter(t=>{let r=!0;return Object.keys(e).forEach(i=>{r=r&&t[i]==e[i]}),r})}}let xt;xt=l.commonJS?require("protobufjs"):protobuf;var wt=xt,vt={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};class Tt extends f{constructor(e){super(e)}}class It extends Tt{constructor(e){let t;super(e),Object.defineProperty(this,"bounds",{get:function(){return t||(t=this.getBounds()),t},set:function(e){t=e},enumerable:!0}),Object.defineProperty(this,"root",{get:function(){let e=this.parent,t=this;for(;e;)t=e,e=e.parent;return t},enumerable:!0})}updateID(e,t){let r=this.root.model;r&&r.updateRegistry(e,t)}getBounds(){return this.content.bounds}invalidateBounds(){this.bounds=void 0}remove(){this.parent.removeChild(this)}}class St extends It{constructor(e){super(e),this.children=[],Object.defineProperty(this,"content",{value:this.children,enumerable:!0})}getBounds(){let e;return this.children.forEach(t=>{e=e?e.union(t.bounds):t.bounds}),e}appendChild(e,t){if(!(e instanceof It))throw new Error(`Incompatible node found - ${e.constructor.name}. It should be ink model Element.`);if(t<0)throw new Error("Index should be a positive number");let r=e.parent;if(r&&e.parent.children.remove(e),e.parent=this,isFinite(t)&&t<this.children.length?this.children.insert(t,e):this.children.push(e),!r){let r=this.root.model;r&&r.register(e,t)}return this.invalidateBounds(),e}removeChild(e){if(!this.children.includes(e))throw new Error("Node was not found");let t=this.root.model;t&&t.unregister(e),this.invalidateBounds(),this.children.remove(e)}remove(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}class Rt extends It{constructor(e){super(),Object.defineProperty(this,"content",{value:e,enumerable:!0})}}class At{constructor(e,t,r){this.model=e,this.type=t||e.type,this.tree=this.createGroup(r),this.tree.model=this,this.register(this.tree)}addPath(e,t){return t||(t=this.tree),t.appendChild(this.createElement(e))}createElement(e,t,r){let i=this.model.createElement(e,this);return i.fromPointIndex=t,i.toPointIndex=r,i}createGroup(e){return this.model.createGroup(e,this)}register(e){if(e instanceof St)e.children.forEach(e=>this.register(e));else if(e instanceof Rt){if(e.content instanceof Ke){if(this.type!=At.Type.STROKE)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of Stroke.`)}else{if(!(e.content instanceof z))throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be ${this.type.name}.`);if(this.type!=At.Type.SENSOR_DATA)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of SensorData.`)}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - "+e.content.id)}this.model.index(e),this.updateKnowledgeGraph(e.id)}unregister(e){e instanceof St&&e.children.forEach(e=>this.unregister(e)),delete this.model.registry[e.id],this.updateKnowledgeGraph(e.id)}updateKnowledgeGraph(e){if(!e)return;let t=this.model.uriBuilder.buildNodeURI(e);if(this.model.registry[e]){if(!this.knowledgeGraph)return;this.model.knowledgeGraph.add(...this.knowledgeGraph.search({subject:t})),this.model.knowledgeGraph.add(...this.knowledgeGraph.search({object:t}))}else this.model.knowledgeGraph.remove(...this.model.knowledgeGraph.search({subject:t})),this.model.knowledgeGraph.remove(...this.model.knowledgeGraph.search({object:t}))}}class Ct{constructor(){}setInkModelURI(e){return this.inkModelURI=e,this}setNodeID(e){return this.inkNodeID=e,this}buildNodeURI(e,t){return this.reset().setInkModelURI(t).setNodeID(e).build()}build(){let e="",t="";return this.inkModelURI&&(e=this.fixedEncodeURIComponent(this.inkModelURI),t="/"),t+="node/"+this.inkNodeID,`uim:${e}${t}`}fixedEncodeURIComponent(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}reset(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}class Ot{constructor(e=Ot.Type.STROKE,t){this.type=e,this.tree=this.createGroup(t),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new Pt,this.uriBuilder=new Ct,this.registry={},this.registry[this.tree.id]=this.tree,Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:()=>this.type==Ot.Type.STROKE?this.content.slice():[],enumerable:!0}),Object.defineProperty(this,"sensorData",{get:()=>this.type==Ot.Type.STROKE?this.content.map(e=>e.sensorData).filter(e=>!!e):this.content,enumerable:!0}),Object.defineProperty(this,"brushes",{get:()=>{let e={};return this.strokes.forEach(t=>e[t.brush.name]=this.registry[t.brush.name]||t.brush),Object.values(e)},set:e=>{e.forEach(e=>this.registry[e.name]=e)},enumerable:!0})}addPath(e,t){return t||(t=this.tree),t.appendChild(this.createElement(e))}removePath(e){e.nodeID&&this.registry[e.nodeID].remove()}replacePath(e,t,r){if(!e.nodeID)return;let i=this.getItem(e.nodeID),s=i.parent||this.tree,n=t.map(e=>this.createElement(e)),o=s.children.indexOf(i);if(r){let e=s.appendChild(this.createGroup(),o);n.forEach(t=>e.appendChild(t))}else n.forEach((e,t)=>s.appendChild(e,o+t));this.removePath(e)}createElement(e,t){if(!e)throw new Error("Element content not found");let r=t?t.type:this.type;switch(r){case Ot.Type.STROKE:if(!(e instanceof Ke))throw new Error(`Incompatible element content found - ${e.constructor.name}. Content should be instance of Stroke.`);break;case Ot.Type.SENSOR_DATA:if(!(e instanceof z))throw new Error(`Incompatible element content found - ${e.constructor.name}. Content should be instance of SensorData.`);break;default:throw console.warn(r),new Error("Invalid ink model type found")}return new Rt(e)}createGroup(e,t){return new St(e)}getItem(e){return this.registry[e]}register(e,t){if(e instanceof St)e.children.forEach(e=>this.register(e));else if(e instanceof Rt){if(e.content instanceof Ke){if(this.type!=Ot.Type.STROKE)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of Stroke.`)}else{if(!(e.content instanceof z))throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be ${this.type.name}.`);if(this.type!=Ot.Type.SENSOR_DATA)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of SensorData.`)}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),isFinite(t)&&t<this.content.length?this.content.insert(t,e.content):this.content.push(e.content),this.index(e.content)}this.index(e),e instanceof Tt&&!this.keepViews&&this.resetViews()}updateRegistry(e,t){let r=this.registry[e];delete this.registry[e],this.registry[r.id]=r,this.updateKnowledgeGraph(e,t)}unregister(e){e instanceof Tt&&this.resetViews(),e instanceof St?e.children.forEach(e=>this.unregister(e)):e instanceof Rt&&(delete e.content.nodeID,delete this.registry[e.content.id],this.content.remove(e.content)),e==this.tree?e.children.clear():delete this.registry[e.id],this.updateKnowledgeGraph(e.id)}updateKnowledgeGraph(e,t){let r=this.uriBuilder.buildNodeURI(e),i=this.uriBuilder.buildNodeURI(t);i?(this.knowledgeGraph.search({subject:r}).forEach(e=>e.subject=i),this.knowledgeGraph.search({object:r}).forEach(e=>e.object=i)):(this.knowledgeGraph.remove(...this.knowledgeGraph.search({subject:r})),this.knowledgeGraph.remove(...this.knowledgeGraph.search({object:r})))}index(e){if(this.registry[e.id])throw new Error(`Cannot register item with id ${e.id}. Already is available item with such identifier.`);this.registry[e.id]=e}createView(e,t,r,i){let s=new At(this,t,r);return s.name=e,this.views[e]=s,i&&(s.knowledgeGraph=i,s.updateKnowledgeGraph(r)),s}resetViews(){for(let e in this.views)this.views[e].tree.remove(),delete this.views[e]}}Ot.createEnum("Type",["STROKE","SENSOR_DATA"]),At.Type=Ot.Type;var Dt={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}};class Mt{constructor(){this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}encodeInk(e){e&&this.encode(Dt.headers.inkChunkFourCC,e)}encode(e,t){let r=e instanceof Uint8Array?e:e.toCharArray().toUint8Array();if(r.length!=Dt.fourCCLength)throw new Error(`Invalid fourCC: "${e}"`);if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(r,t))}build(){let e=Dt.headers,t=0;this.chunks.unshift(this.createChunk(Dt.headers.headChunkFourCC,Dt.version)),this.chunks.forEach(e=>{t+=e.length});let r=e.formatFourCC.length+t,i=e.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+r,s=new ArrayBuffer(i);this.fileBytes=new Uint8Array(s),this.dataView=new DataView(s),this.byteOffset=0,this.fileBytes.set(e.riffFourCC,this.byteOffset),this.byteOffset+=e.riffFourCC.length,this.dataView.setUint32(this.byteOffset,r,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.formatFourCC,this.byteOffset),this.byteOffset+=e.formatFourCC.length,this.chunks.forEach(e=>{this.appendChunk(e),this.byteOffset+=e.length})}createChunk(e,t){let r=t.length,i=r%2;return{fourCC:e,bytes:t,size:r,length:e.length+Uint32Array.BYTES_PER_ELEMENT+r+i}}appendChunk(e){this.fileBytes.set(e.fourCC,this.byteOffset);let t=this.byteOffset+e.fourCC.length;this.dataView.setUint32(t,e.size,!0),t+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.bytes,t)}reset(){this.chunks=[],this.fileBytes=null}}class Nt{decode(e){let t=Dt.headers;this.reset(e);let r=this.byteOffset+t.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=r,r=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;let i=this.dataView.getUint32(this.byteOffset,!0)+r;if(i%2!=0)throw new Error("Invalid RIFF file size");if(i!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=r,r=this.byteOffset+t.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=r;this.byteOffset<i;){let e=this.extractChunk();this.byteOffset+=e.length,Object.equals(e.fourCC,t.headChunkFourCC)?this.version=[e.bytes[0],e.bytes[1],e.bytes[2]]:Object.equals(e.fourCC,t.inkChunkFourCC)?this.ink=e.bytes:this.chunks.push({fourCC:String.fromCharArray(e.fourCC),bytes:e.bytes})}}extractChunk(){let e=this.fileBytes.subarray(this.byteOffset,this.byteOffset+Dt.fourCCLength),t=null,r=0,i=0,s=0,n=this.byteOffset+e.length,o=n;return n=o+Uint32Array.BYTES_PER_ELEMENT,r=this.dataView.getUint32(o,!0),o=n,n=o+r,r>0?(t=this.fileBytes.subarray(o,n),t=new Uint8Array(t,t.byteOffset,t.length)):t=new Uint8Array(0),i=e.length+Uint32Array.BYTES_PER_ELEMENT+r,s=i%2,{fourCC:e,bytes:t,size:r,length:i+s}}reset(e){this.fileBytes=e,this.dataView=new DataView(e.buffer),this.byteOffset=0,this.chunks=[]}}class kt{constructor(){kt.format||(kt.format=wt.Root.fromJSON(vt).WacomInkFormat3),this.riffEncoder=new Mt,this.riffDecoder=new Nt}static encode(e){return e.constructor.encode(e).finish()}async encodeInkModel(e){this.structure=!0;let t=kt.format.InkObject.create({inputData:this.encodeInkInput(e.sensorData),inkData:this.encodeInkData(e.strokes),brushes:await this.encodeBrushes(e.brushes),inkTree:this.encodeNodeTree(e),views:Object.values(e.views).map(e=>this.encodeView(e)),knowledgeGraph:this.encodeKnowledgeGraph(e.knowledgeGraph),transform:this.encodeMat4(e.transform),properties:this.encodeProperties(e.props)});this.structure=!1;let r=kt.encode(t);return this.riffEncoder.reset(),this.riffEncoder.encodeInk(r),this.riffEncoder.data}decodeInkModel(e,t){e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.riffDecoder.decode(e);let r=kt.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=r,t){let e=this.decodeKnowledgeGraph(r.knowledgeGraph);r.views.forEach(r=>this.decodeView(r,t,e))}else{let e=this.decodeInkInput(r.inputData),i=this.decodeBrushes(r.brushes),s=this.decodeInkData(r.inkData,i,e),n=r.inkTree.first,o=n.type==kt.format.NodeType.STROKE_GROUP?Ot.Type.STROKE:Ot.Type.SENSOR_DATA,a=n.type==kt.format.NodeType.STROKE_GROUP?s:e;t=new Ot(o,n.id),this.decodeNodeTree(t,r.inkTree.slice(1),a),r.views.forEach(e=>this.decodeView(e,t)),t.knowledgeGraph=this.decodeKnowledgeGraph(r.knowledgeGraph),t.props=this.decodeProperties(r.properties),t.transform=this.decodeMat4(r.transform),t.brushes=Object.values(i)}return delete this.structure,t}encodeInkInput(e){let t={},r={},i={},s={},n={};e.forEach(e=>{let o=e.context;t[o.id]||(t[o.id]=o,n[o.environment.id]||(n[o.environment.id]=o.environment),r[o.sensorContext.id]||(r[o.sensorContext.id]=o.sensorContext,o.sensorContext.channelsContexts.forEach(e=>{i[e.device.id]||(i[e.device.id]=e.device),e.inkProvider&&(s[e.inkProvider.id]||(s[e.inkProvider.id]=e.inkProvider))})))});let o=kt.format.InputData.create({sensorData:e.map(e=>this.encodeSensorData(e)),inputContextData:kt.format.InputContextData.create({inputContexts:Object.values(t).map(e=>kt.format.InputContext.create({id:e.id,environmentID:e.environment.id,sensorContextID:e.sensorContext.id})),sensorContexts:Object.values(r).map(e=>kt.format.SensorContext.create({id:e.id,sensorChannelsContext:e.channelsContexts.map(e=>kt.format.SensorChannelsContext.create({id:e.id,channels:e.channels.map(e=>kt.format.SensorChannel.create({id:e.id,type:e.type,metric:kt.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})),samplingRateHint:isFinite(e.samplingRate)?kt.format.Uint32.create({value:e.samplingRate}):void 0,latency:isFinite(e.latency)?kt.format.Uint32.create({value:e.latency}):void 0,inkInputProviderID:e.inkProvider?e.inkProvider.id:null,inputDeviceID:e.device.id}))})),inkInputProviders:Object.values(s).map(e=>kt.format.InkInputProvider.create({id:e.id,type:kt.format.InkInputProviderType[e.type.name],properties:this.encodeProperties(e.props)})),inputDevices:Object.values(i).map(e=>kt.format.InputDevice.create({id:e.id,properties:this.encodeProperties(e.props)})),environments:Object.values(n).map(e=>kt.format.Environment.create({id:e.id,properties:this.encodeProperties(e.props)}))})});return this.structure?o:kt.encode(o)}decodeInkInput(e){if(!e)return;let t=this.structure?e:kt.format.InputData.decode(e),r={},i={},s={},n={},o={};return t.inputContextData.environments.forEach(e=>{let t=new M;this.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn(`Environment decode id missmatch - found ${e.id}, expected ${t.id}`),o[t.id]=t}),t.inputContextData.inkInputProviders.forEach(e=>{let t=this.decodeProperties(e.properties),r=new g(g.Type[kt.format.InkInputProviderType[e.type]],t);Object.freeze(r),r.id!=e.id&&console.warn(`InkInputProvider decode id missmatch - found ${e.id}, expected ${r.id}`),n[r.id]=r}),t.inputContextData.inputDevices.forEach(e=>{let t=new X;this.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn(`InputDevice decode id missmatch - found ${e.id}, expected ${t.id}`),s[t.id]=t}),t.inputContextData.sensorContexts.forEach(e=>{let t=new j;e.sensorChannelsContext.forEach(e=>{let r=new U(s[e.inputDeviceID],n[e.inkInputProviderID]);e.samplingRateHint&&(r.samplingRate=e.samplingRateHint.value),e.latency&&(r.latency=e.latency.value),e.channels.forEach(e=>{let t=B.Metric[kt.format.InkSensorMetricType[e.metric]],i=new B(e.type,t,e.resolution,e.min,e.max);i.precision=e.precision,r.add(i),i.id!=e.id&&console.warn(`SensorChannel decode id missmatch - found ${e.id}, expected ${i.id}`)}),t.addContext(r),r.id!=e.id&&console.warn(`SensorChannelsContext decode id missmatch - found ${e.id}, expected ${r.id}`)}),Object.freeze(t),i[t.id]=t,t.id!=e.id&&console.warn(`SensorContext decode id missmatch - found ${e.id}, expected ${t.id}`)}),t.inputContextData.inputContexts.forEach(e=>{let t=new G(o[e.environmentID],i[e.sensorContextID]);Object.freeze(t),t.id!=e.id&&console.warn(`InputContext decode id missmatch - found ${e.id}, expected ${t.id}`),r[t.id]=t}),t.sensorData.map(e=>this.decodeSensorData(e,r[e.inputContextID]))}encodeSensorData(e){let t=kt.format.SensorData.create({id:e.id,inputContextID:e.context.id,state:kt.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach(e=>{let r={};e.channels.forEach(e=>r[e.id]=[]);for(let t=0;t<e.length;t++){let i=e.get(t);e.channels.forEach(e=>{r[e.id].push(i[F.getPropName(e.name)])})}e.channels.forEach(e=>{if(!("precision"in e))throw new Error("Precision not found for channel with id: "+e.id);let i=kt.format.ChannelData.create({sensorChannelID:e.id}),s=r[e.id],n=10**e.precision,o=Math.round(s[0]*n);i.values.push(o);for(let e=1;e<s.length;e++){let t=Math.round(s[e]*n);i.values.push(t-o),o=t}t.dataChannels.push(i)})}),t}decodeSensorData(e,t){let r=new z(t);r.id=e.id,r.created=parseInt(c.fromValue(e.timestamp).toString()),r.inkState=z.InkState[kt.format.InkState[e.state]];let i={};return e.dataChannels.forEach(e=>{let r=t.sensorContext.getContextByChannelID(e.sensorChannelID);if(!r)throw new Error("Not found corresponding channel context for data with channelID "+e.sensorChannelID);let s=10**r.get(e.sensorChannelID).precision,n=e.values[0],o=[];o.push(n/s);for(let t=1;t<e.values.length;t++){let r=n+e.values[t];o.push(r/s),n=r}i[e.sensorChannelID]=o}),t.sensorContext.channelsContexts.forEach(e=>{let t=i[e.channels.first.id].length,s=new Y(e.channels);for(let r=0;r<t;r++)e.channels.forEach(e=>{let t=i[e.id];s.data.push(t[r])});r.add(s)}),r}encodeInkData(e){let t=kt.format.InkData.create({strokes:e.map(e=>this.encodeStroke(e))});return this.structure?t:kt.encode(t)}decodeInkData(e,t,r=[]){if(!e)return;let i=this.structure?e:kt.format.InkData.decode(e),s={};return r.forEach(e=>s[e.id]=e),i.strokes.map(e=>this.decodeStroke(e,t,s))}encodeStroke(e){let t=kt.format.Stroke.create({id:e.id,startParameter:e.ts,endParameter:e.tf});for(let r=0;r<e.length;r++){let i=e.pointAt(r);e.layout.forEach(e=>{switch(e){case C.Property.X:t.splineX.push(i.x);break;case C.Property.Y:t.splineY.push(i.y);break;case C.Property.Z:t.splineZ.push(i.z);break;case C.Property.RED:t.red.push(i.red/255);break;case C.Property.GREEN:t.green.push(i.green/255);break;case C.Property.BLUE:t.blue.push(i.blue/255);break;case C.Property.ALPHA:t.alpha.push(i.alpha);break;case C.Property.SIZE:t.size.push(i.size);break;case C.Property.ROTATION:t.rotation.push(i.rotation);break;case C.Property.SCALE_X:t.scaleX.push(i.scaleX);break;case C.Property.SCALE_Y:t.scaleY.push(i.scaleY);break;case C.Property.SCALE_Z:t.scaleZ.push(i.scaleZ);break;case C.Property.OFFSET_X:t.offsetX.push(i.offsetX);break;case C.Property.OFFSET_Y:t.offsetY.push(i.offsetY);break;case C.Property.OFFSET_Z:t.offsetZ.push(i.offsetZ);break;default:throw new Error("Invalid layout property provided: "+e)}})}return e.sensorData&&(t.sensorDataID=e.sensorData.id,t.sensorDataOffset=e.sensorDataOffset,t.sensorDataMapping=e.sensorDataMapping),t.style=kt.format.Style.create({brushURI:e.brush.name,renderModeURI:e.renderMode,particlesRandomSeed:e.randomSeed,properties:this.encodePathPointProperties(e.pointProps)}),t}decodeStroke(e,t={},r={}){if(0==e.splineX.length||0==e.splineY.length)throw new Error("Incomplete path definition");let i=[C.Property.X,C.Property.Y];e.splineZ.length>0&&i.push(C.Property.Z),e.red&&e.red.length>0&&i.push(C.Property.RED),e.green&&e.green.length>0&&i.push(C.Property.GREEN),e.blue&&e.blue.length>0&&i.push(C.Property.BLUE),e.alpha&&e.alpha.length>0&&i.push(C.Property.ALPHA),e.size.length>0&&i.push(C.Property.SIZE),e.rotation.length>0&&i.push(C.Property.ROTATION),e.scaleX.length>0&&i.push(C.Property.SCALE_X),e.scaleY.length>0&&i.push(C.Property.SCALE_Y),e.scaleZ.length>0&&i.push(C.Property.SCALE_Z),e.offsetX.length>0&&i.push(C.Property.OFFSET_X),e.offsetY.length>0&&i.push(C.Property.OFFSET_Y),e.offsetZ.length>0&&i.push(C.Property.OFFSET_Z);let s=e.splineX.length,n=i.length,o="undefined"==typeof SharedArrayBuffer?new Float32Array(s*n):new Float32Array(new SharedArrayBuffer(s*n*Float32Array.BYTES_PER_ELEMENT));for(let t=0;t<s;t++)i.forEach((r,i)=>{let s;switch(r){case C.Property.X:s=e.splineX[t];break;case C.Property.Y:s=e.splineY[t];break;case C.Property.Z:s=e.splineZ[t];break;case C.Property.RED:s=Math.round(255*e.red[t]);break;case C.Property.GREEN:s=Math.round(255*e.green[t]);break;case C.Property.BLUE:s=Math.round(255*e.blue[t]);break;case C.Property.ALPHA:s=e.alpha[t];break;case C.Property.SIZE:s=e.size[t];break;case C.Property.ROTATION:s=e.rotation[t];break;case C.Property.SCALE_X:s=e.scaleX[t];break;case C.Property.SCALE_Y:s=e.scaleY[t];break;case C.Property.SCALE_Z:s=e.scaleZ[t];break;case C.Property.OFFSET_X:s=e.offsetX[t];break;case C.Property.OFFSET_Y:s=e.offsetY[t];break;case C.Property.OFFSET_Z:s=e.offsetZ[t];break;default:throw new Error("Invalid layout property provided: "+r.name)}o[t*n+i]=s});let a=t[e.style.brushURI]||e.style.brushURI,h=this.decodePathPointProperties(e.style.properties),l=r[e.sensorDataID],u=new ce(i,o,h,e.startParameter,e.endParameter);u.randomSeed=e.style.particlesRandomSeed;let d=new Ke(a,u,void 0,l);return d.id=e.id,d.renderMode=e.style.renderModeURI,d.sensorDataOffset=e.sensorDataOffset,d.sensorDataMapping=e.sensorDataMapping,d}async encodeBrushes(e){let t=kt.format.Brushes.create();for(let r of e)if(r instanceof re){let e=this.encodeBrush2D(r);t.vectorBrushes.push(e)}else{let e=await this.encodeBrushGL(r);t.rasterBrushes.push(e)}return this.structure?t:kt.encode(t)}decodeBrushes(e){if(!e)return;let t=this.structure?e:kt.format.Brushes.decode(e),r={};return t.vectorBrushes.forEach(e=>r[e.name]=this.decodeBrush2D(e)),t.rasterBrushes.forEach(e=>r[e.name]=this.decodeBrushGL(e)),this.structure?r:Object.values(r)}encodeBrush2D(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");let t=kt.format.VectorBrush.create({name:e.name,spacing:e.spacing});return(Array.isArray(e.shape)?e.shape:[e.shape]).forEach(e=>{let r=kt.format.BrushPrototype.create({size:e.size});if(e.descriptor.shape.name)r.shapeURI=e.descriptor.shape.name;else for(let t=0;t<e.shape.length;t+=2)r.coordX.push(e.shape[t]),r.coordY.push(e.shape[t+1]);t.prototype.push(r)}),t}decodeBrush2D(e){let t=[];return e.prototype.forEach(e=>{let r;if(e.shapeURI)r=e.shapeURI;else{r=new Float32Array(2*e.coordX.length);for(let t=0;t<r.length/2;t++)r[2*t]=e.coordX[t],r[2*t+1]=e.coordY[t]}t.push(new J(r,e.size))}),new re(e.name,t,e.spacing)}async encodeBrushGL(e){if(!e.name)throw new Error("Encode BrushGL failed. name property is required.");let t={shape:[],shapeURI:[],fill:void 0,filleURI:void 0};if(Array.isArray(e.shape)){let r=e.descriptor.shape.map(e=>e.name).filter(e=>e);if(r.length>0){if(r.length!=e.shape.length)throw new Error(`Brush ${e.name} shape names length do not match with brush mipmap`);t.shapeURI=r}}else e.descriptor.shape.name&&t.shapeURI.push(e.descriptor.shape.name);if(t.fillURI=e.descriptor.fill.name,0==t.shapeURI.length||!t.fillURI){let r={shape:await e.getShapeBinary(),fill:await e.getFillBinary()};0==t.shapeURI.length&&(Array.isArray(e.shape)?t.shape=r.shape:t.shape.push(r.shape)),t.fillURI||(t.fill=r.fill)}let r=e.blendMode.replace(/-/g,"_").toUpperCase();return kt.format.RasterBrush.create({name:e.name,spacing:e.spacing,scattering:e.scattering,blendMode:kt.format.BlendMode[r],rotationMode:kt.format.RotationMode[e.rotationMode.name],shapeTexture:t.shape,shapeTextureURI:t.shapeURI,fillTexture:t.fill,fillTextureURI:t.fillURI,fillWidth:e.fillTextureSize.width,fillHeight:e.fillTextureSize.height,randomizeFill:e.randomizeFill})}decodeBrushGL(e){let t,r;if(e.shapeTextureURI.length>0)t=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map(e=>({name:e}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");t=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map(e=>({value:e}))}if(e.fillTextureURI)r={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");r={value:e.fillTexture}}return new qe(e.name,t,r,{spacing:e.spacing,scattering:e.scattering,blendMode:$e[kt.format.BlendMode[e.blendMode]],rotationMode:qe.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}encodeView(e){return kt.format.View.create({name:e.name,tree:this.encodeNodeTree(e)})}decodeView(e,t,r){let i=e.tree.first;if(!t.views[e.name]||t.views[e.name].tree.id!=e.tree[0].id){let s=i.type==kt.format.NodeType.STROKE_GROUP?Ot.Type.STROKE:Ot.Type.SENSOR_DATA,n=t.createView(e.name,s,i.name,r);this.decodeNodeTree(n,e.tree.slice(1))}}encodeNodeTree(e){let t=[];return t.push(this.encodeNode(e.type,e.tree,0)),this.addChildren(t,e,e.tree.children,1),t}addChildren(e,t,r,i){r.forEach(r=>{let s=r instanceof Rt?(t.model||t).content.indexOf(r.content):void 0;e.push(this.encodeNode(t.type,r,i,s)),r instanceof St&&this.addChildren(e,t,r.children,i+1)})}encodeNode(e,t,r,i){let s=e.name;return t instanceof St&&(s+="_GROUP"),kt.format.Node.create({id:t.id,type:kt.format.NodeType[s],depth:r,index:i,groupBoundingBox:t.bounds,chunkFromIndex:t.fromPointIndex,chunkToIndex:t.toPointIndex})}decodeNodeTree(e,t,r){let i=e.tree,s=0;r||(r=(e.type==Ot.Type.STROKE?this.structure.inkData.strokes:this.structure.inputData.sensorData).map(t=>e.model.getItem(t.id)));for(let n of t){for(;s>=n.depth;)i=i.parent,s--;if(n.type==kt.format.NodeType.STROKE_GROUP||n.type==kt.format.NodeType.SENSOR_DATA_GROUP)i=i.appendChild(e.createGroup(n.id)),n.groupBoundingBox&&(i.bounds=new q(n.groupBoundingBox.x,n.groupBoundingBox.y,n.groupBoundingBox.width,n.groupBoundingBox.height));else{let t;t=n.chunkToIndex>n.chunkFromIndex?e.createElement(r[n.index],n.chunkFromIndex,n.chunkToIndex):e.createElement(r[n.index]),t.id=n.id,i=i.appendChild(t)}s=n.depth}}encodeProperties(e){return Object.keys(e).map(t=>kt.format.Property.create({name:t,value:e[t]}))}decodeProperties(e,t={}){return e.forEach(e=>t[e.name]=e.value),t}encodeKnowledgeGraph(e){if(!e)return;let t=kt.format.TripleStore.create({statements:e.statements.map(e=>kt.format.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object}))});return this.structure?t:kt.encode(t)}decodeKnowledgeGraph(e){if(!e)return;let t=new Pt,r=this.structure?e:kt.format.TripleStore.decode(e);return r&&r.statements.forEach(e=>t.addTriple(e.subject,e.predicate,e.object)),t}encodeMat4(e){if(e)return kt.format.Matrix4.create({m00:e.m11,m01:e.m12,m02:e.m13,m03:e.m14,m10:e.m21,m11:e.m22,m12:e.m23,m13:e.m24,m20:e.m31,m21:e.m32,m22:e.m33,m23:e.m34,m30:e.m41,m31:e.m42,m32:e.m43,m33:e.m44})}decodeMat4(e){if(e)return T.fromMatrix([e.m00,e.m01,e.m02,e.m03,e.m10,e.m11,e.m12,e.m13,e.m20,e.m21,e.m22,e.m23,e.m30,e.m31,e.m32,e.m33])}async encodeTool(e,t={},r={},i=$e.SOURCE_OVER){let s=kt.format.Tool.create({vectorBrush:e instanceof re?this.encodeBrush2D(e):void 0,rasterBrush:e instanceof qe?await this.encodeBrushGL(e):void 0,context:kt.format.PathPointContext.create({statics:this.encodePathPointProperties(r),dynamics:this.encodePathPointSettings(t)})});if(i!=$e.SOURCE_OVER){let e=i.replace(/-/g,"_").toUpperCase();s.blendMode=kt.format.BlendMode[e]}return kt.encode(s)}decodeTool(e){if(!e)return;e instanceof ArrayBuffer&&(e=new Uint8Array(e));let t=kt.format.Tool.decode(e);return{brush:"vectorBrush"==t.brush?this.decodeBrush2D(t.vectorBrush):this.decodeBrushGL(t.rasterBrush),blendMode:$e[kt.format.BlendMode[t.blendMode]],statics:this.decodePathPointProperties(t.context.statics),dynamics:this.decodePathPointSettings(t.context.dynamics)}}encodePathPointProperties(e){let t=kt.format.PathPointProperties.create();for(let r in kt.format.PathPointProperties.fields){let i=e[r];isFinite(i)&&("red"!=r&&"green"!=r&&"blue"!=r||(i/=255),t[r]=kt.format.Float32.create({value:i}))}return t}decodePathPointProperties(e){if(!e)return;let t={};for(let r in kt.format.PathPointProperties.fields){let i=e[r];if(i){let e=i.value;"red"!=r&&"green"!=r&&"blue"!=r||(e=Math.round(255*e)),t[r]=e}}return t}encodePathPointSettings(e){let t=kt.format.PathPointSettings.create();for(let r in kt.format.PathPointSettings.fields)e[r]&&!e[r].disabled&&(t[r]=this.encodePropertySettings(r,e[r]));return t}decodePathPointSettings(e){if(!e)return;let t={};for(let r in kt.format.PathPointSettings.fields)e[r]&&(t[r]=this.decodePropertySettings(e[r]));return t}encodePropertySettings(e,t){let r=t=>{if(t)return kt.format.Range.create({min:t.min,max:t.max,remapURI:this.getActionDescriptorName(e,"Remap",t.remap)})};return kt.format.PropertySettings.create({value:r(t.value),velocity:r(t.velocity),pressure:r(t.pressure),altitude:r(t.altitude),radiusX:r(t.radiusX),radiusY:r(t.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",t.resolve),dependencies:(t.dependencies||[]).map(e=>kt.format.InputPropertyType[e.name])})}getActionDescriptorName(e,t,r){if(r){if("function"==typeof r)throw new Error(`Encode '${e}' property failed. ${t} action name property is required. Please provide ActionDescriptor for it's definition.`);if("string"==typeof r)return r;if(r.name)return r.name;throw new Error(`Encode '${e}' property failed. ${t} action name property is required. Please provide ActionDescriptor for it's definition.`)}}decodePropertySettings(e){let t={},r=(e,r)=>{r&&(t[e]={min:r.min,max:r.max,remap:r.remapURI})};return r("value",e.value),r("velocity",e.velocity),r("pressure",e.pressure),r("altitude",e.altitude),r("radiusX",e.radiusX),r("radiusY",e.radiusY),t.resolve=e.resolveURI,e.dependencies.length>0&&(t.dependencies=e.dependencies.map(e=>B.Type[kt.format.InputPropertyType[e]])),t}}const Lt=new $(255,165,0),_t=new $(255,255,0),Ft=new $(64,224,208),Bt=new $(255,0,255),Ut=new $(139,0,139),jt=new $(128,0,128),Gt=new $(255,192,203),zt=new $(128,128,128);class Yt{constructor(e){this.tree=e,this.attach()}attach(){"loading"==document.readyState?addEventListener("DOMContentLoaded",e=>this.attach()):(this.canvas=document.getElementById("rbush"),this.ctx=this.canvas.getContext("2d"))}refresh(e){let t=[];Yt.allocateSegments(t,this.tree.data,0),this.ctx.clearRect(0,0,this.canvas.width+1,this.canvas.height+1);for(let e=t.length-1;e>=0;e--){let r=t[e];r.hulls?r.hulls.forEach(e=>this.drawShape(e,r.color)):this.drawRect(r.bounds,r.color)}}drawRect(e,t=zt.toRGBA(.3)){this.ctx.strokeStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.ctx.strokeRect(e.left,e.top,e.width,e.height)}fillRect(e,t=zt.toRGBA(.3)){this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.ctx.fillRect(e.left,e.top,e.width,e.height)}fillPoint(e,t=5,r=$.BLACK){this.ctx.fillStyle=`rgba(${r.red}, ${r.green}, ${r.blue}, ${r.alpha})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}drawShape(e,t=Ut.toRGBA(.5)){this.ctx.strokeStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.drawPath(e),this.ctx.stroke()}fillShape(e,t=Lt.toRGBA(.6)){this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.drawPath(e),this.ctx.fill()}drawPath(e){"number"==typeof e[0]&&(e=[e]),this.ctx.beginPath(),e.forEach(e=>{this.ctx.moveTo(e[0],e[1]);for(let t=2;t<e.length;t+=2)this.ctx.lineTo(e[t],e[t+1]);this.ctx.closePath()})}drawRange(e){e.forEach(e=>this.drawRect(e.bounds,jt))}drawIntersection(e,t){this.drawShape(e,Gt),t.forEach(t=>{this.fillShape(t.shape,_t);let r=be.intersection(t.shape,e);if(r){let e=r.toPath2D();this.fillShape(e,$.BLACK)}})}drawSelection(e,t,r){this.fillRect(e),this.fillShape(t,Ut.toRGBA(.5)),this.fillShape(r)}static allocateSegments(e,t,r){if(t){if(t.bounds){let r=t;0==t.depth?r.color=$.RED:1==t.depth?r.color=Ft:2==t.depth?r.color=$.BLUE:3==t.depth?r.color=Bt:4==t.depth&&(r.color=$.GREEN),e.push(r)}if(t.children)if(10!==r)for(let i=0;i<t.children.length;i++)Yt.allocateSegments(e,t.children[i],r+1);else console.warn("depth 10")}}static getInstance(e){return Yt.instance||(Yt.instance=new Yt(e)),Yt.instance}}class Xt extends n{constructor(...e){super(...e),this.detachCanvas()}toBBox(e){return{minX:e.bounds.left,minY:e.bounds.top,maxX:e.bounds.right,maxY:e.bounds.bottom}}compareMinX(e,t){return e.bounds.x-t.bounds.x}compareMinY(e,t){return e.bounds.y-t.bounds.y}search(e){return super.search({minX:e.left,minY:e.top,maxX:e.right,maxY:e.bottom})}find(e,t=this.data,r=0,i=[]){if(t){if(t.stroke){let r=!0;Object.keys(e).forEach(i=>{r=r&&t[i]==e[i]}),r&&i.push(t)}if(t.children){if(6!==r){for(let s=0;s<t.children.length;s++)this.find(e,t.children[s]||null,r+1,i);return i}console.warn("depth 6")}}}attachCanvas(){this.canvas=Yt.getInstance(this)}detachCanvas(){this.canvas={},Object.getOwnPropertyNames(Yt.prototype).filter(e=>!["constructor","attach"].includes(e)).forEach(e=>{this.canvas[e]=()=>{}})}}class Vt{constructor(e=Vt.Mode.WHOLE_STROKE){this.mode=e,this.segmentInterpolator=new ye(1,!1,!0),this.convexHullChainProducer=new _e,this.holesBuilder=new Ee}updateSegmentation(e){if(!this.context)throw new Error("Required spatial context not found");let t=[],r=!1;for(let i of e){if(0==i.length)continue;let s=q.ofPolygon(i),n=this.context.search(s);if(n.length>0){let o=[];for(let e of n)if(0==e.depth){let t=this.context.getStroke(e.strokeID),i=this.buildStrokeSegments(t);this.context.updateTree(e,i),o=o.concat(i),r=!0}else if(1==e.depth){let t=[],i=this.segmentInterpolator.split(e.spline),s=this.context.getBrushApplier(e.strokeID).get(i);for(let r=0;r<i.length-1;r++){let n=[s[r],s[r+1]];t.push({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:r,bounds:q.ofPolygons(n),point:i.getPoint(r),spline:new ce(e.spline.layout,e.spline.points,e.spline.pointProps,i.getPointT(r),i.getPointT(r+1)),shapesPath:n,depth:2})}this.context.updateTree(e,t),o=o.concat(t),r=!0}else if(2==e.depth){this.convexHullChainProducer.reset();let t=this.convexHullChainProducer.get(e.shapesPath);e.depth=3,e.hulls=t,this.context.tree.canvas.refresh(),r=!0}else if(3==e.depth){if(be.intersection(e.hulls,i))if(this.mode==Vt.Mode.PARTIAL_STROKE){let t=[],i=this.segmentInterpolator.get(e.spline),s=this.context.getBrushApplier(e.strokeID).get(i);for(let r=0;r<i.length;r++){let n=q.ofPolygon(s[r]),o=n,a=e.spline,h=i.getPointT(r),l=i.getPointT(r-1),u=i.getPointT(r+1);if(isNaN(l)&&(l=e.spline.ts),isNaN(u)&&(u=e.spline.tf),n.width!=n.height){let e=Math.max(n.width,n.height);n=new q(n.center.x-e/2,n.center.y-e/2,e,e)}t.push({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:e.splineIndex,pointIndex:r,bounds:n,point:i.getPoint(r),spline:a,prevT:l,t:h,nextT:u,shape:s[r],shapeBounds:o,depth:4})}this.context.updateTree(e,t),o=o.concat(t),r=!0}else t.push(e)}else q.intersect(s,e.bounds)&&(e.affected=!0),t.push(e);if(o.length>0&&this.context.load(o),r)return this.updateSegmentation(e);this.nodes.push(...t)}}}static buildStrokeNode(e){return{strokeID:e.id,bounds:e.bounds,point:e.getPoint(0),depth:0}}buildStrokeSegments(e){let t=[],r=this.context.getBrushApplier(e.id);for(let i=0;i<e.segmentsCount;i++){let s=Vt.buildStrokeSegment(e,i,r);t.push(s)}return t}static buildStrokeSegment(e,t,r){if(t<0||t>=e.segmentsCount)throw new Error(`Invalid index ${t} found. Ensure that index range is {0, ${e.segmentsCount-1}}.`);const i=.166666666666;let s=e.getSegment(t),n=s.getPoint(0),o=s.getPoint(1),a=s.getPoint(2),h=s.getPoint(3),l=-i*n.x+o.x+i*a.x,u=-i*n.y+o.y+i*a.y,d=+i*o.x+a.x-i*h.x,c=+i*o.y+a.y-i*h.y,p=o.toArray(e.layout).concat(a.toArray(e.layout)),f=new fe(e.layout,p,e.pointProps),g=r.get(f),m=q.ofPolygon(g.first),y=q.ofPolygon(g.last),b=Math.max(m.width,y.height),E=Math.max(m.height,y.height),P=Math.max(b,E),x=new q(l-P/2,u-E/2,P,P),w=new q(d-P/2,c-E/2,P,P),v=m.union(y).union(x).union(w);return{strokeID:e.id,segmentIndex:t,bounds:v,point:s.getPoint(0),spline:s,shapesPath:g,depth:1}}createIntervals(e,t){let r={intersected:{},selected:[]};if(0==t.length)return r;let i=this.holesBuilder.build(this.context,e,t);for(let e in i){let t=this.context.getNodes(e),s=[],n=[];r.intersected[e]={intervals:s,holes:n},i[e].forEach((o,a)=>{let h,l=0==o.fromIndex&&o.fromTValue==t.first.ts,u=o.toIndex==t.last.segmentIndex&&o.toTValue==t.last.tf;if(l&&u)return r.selected.push(e),void delete r.intersected[e];n.push(o),l?h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}:u?(s.last||s.push({fromIndex:0,fromTValue:t.first.spline.ts,fromNodeIndex:0}),s.last.toIndex=o.fromIndex+3,s.last.toTValue=o.fromTValue,s.last.toNodeIndex=o.fromNodeIndex):s.last?(s.last.toIndex=o.fromIndex+3,s.last.toTValue=o.fromTValue,s.last.toNodeIndex=o.fromNodeIndex,h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}):(s.push({fromIndex:0,fromTValue:t.first.spline.ts,toIndex:o.fromIndex+3,toTValue:o.fromTValue,fromNodeIndex:0,toNodeIndex:o.fromNodeIndex}),h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}),h&&s.push(h),a!=i[e].length-1||u||(s.last.toIndex=t.last.segmentIndex+3,s.last.toTValue=t.last.spline.tf,s.last.toNodeIndex=t.length-1);let d=[];s.forEach(e=>{if(1==e.fromTValue){let r=t.filter(t=>t.segmentIndex==e.fromIndex+1).first,i=t.filter(t=>t.segmentIndex==e.fromIndex);n.push({fromNodeIndex:i.first.nodeIndex||t.indexOf(i.first),toNodeIndex:i.last.nodeIndex||t.indexOf(i.last),type:"OVERLAPPING_INC"}),e.fromIndex++,e.fromTValue=0,e.fromNodeIndex=t.indexOf(r)}if(0==e.toTValue){let r=e.toIndex-3,i=t.filter(e=>e.segmentIndex==r-1).last,s=t.filter(e=>e.segmentIndex==r);n.push({fromNodeIndex:s.first.nodeIndex||t.indexOf(s.first),toNodeIndex:s.last.nodeIndex||t.indexOf(s.last),type:"OVERLAPPING_DEC"}),e.toIndex--,e.toTValue=1,e.toNodeIndex=t.indexOf(i)}if(e.toIndex-e.fromIndex<3)d.push(e);else if(e.toIndex-e.fromIndex==3&&e.fromTValue==e.toTValue){let r=t.filter(t=>t.segmentIndex==e.fromIndex);n.push({fromNodeIndex:r.first.nodeIndex||t.indexOf(r.first),toNodeIndex:r.last.nodeIndex||t.indexOf(r.last),type:"INVALID"}),d.push(e)}}),d.forEach(e=>s.remove(e))})}return r}reset(e){if(!e)throw new Error("Required spatial context not found");this.context=e,this.nodes=[]}}Vt.createEnum("Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);class $t{constructor(){this.tree=new Xt,this.strokes={},this.brushAppliers={},this.nodes={}}add(e){e.brush instanceof qe||(this.strokes[e.id]=e,this.loadStrokeNode(e))}getStroke(e){return this.strokes[e]}getBrushApplier(e){let t=this.strokes[e].brush;return this.brushAppliers[t.name]||(this.brushAppliers[t.name]=new Le(t)),this.brushAppliers[t.name]}getNodes(e){return this.nodes[e]}loadStrokeNode(e){let t=Vt.buildStrokeNode(e);this.nodes[e.id]=[t],this.load(t)}reload(e){this.unload(this.nodes[e.id]),this.loadStrokeNode(e)}remove(e){let t="string"==typeof e?e:e.id;this.unload(this.nodes[t]),delete this.nodes[t],delete this.strokes[t]}update(e,t){let r={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(e).forEach(i=>{let s=this.strokes[i],n=this.split(s,e[i]);n&&(r.intersected.push({stroke:s,strokes:n}),t||(r.dirtyArea=s.bounds.union(r.dirtyArea)),e[i].intervals.forEach((e,t)=>{e.inside&&r.selected.push(n[t])}))}),r}split(e,t){let{intervals:r,holes:i}=t;if(0==r.length)return[];let s=e.split(r);if(!s)return;s.forEach(e=>{this.strokes[e.id]=e});let n=[],o=[];return r.map(t=>this.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)).forEach((t,i)=>{let a,h,l=s[i],u=this.getBrushApplier(l.id),d=r[i].fromIndex,c=r[i].toIndex-3;if(l.ts!=t.first.spline.ts){let r=t.first.segmentIndex,i=this.nodes[e.id].filter(e=>e.segmentIndex==r);t=t.filter(e=>e.segmentIndex!=r),r>=d&&(a=Vt.buildStrokeSegment(l,r-d,u),n.push(a)),o.push(...i)}if(t.length>0&&l.tf!=t.last.spline.tf){let r=t.last.segmentIndex,i=this.nodes[e.id].filter(e=>e.segmentIndex==r);t=t.filter(e=>e.segmentIndex!=r),r<=c&&(h=Vt.buildStrokeSegment(l,r-d,u),n.push(h)),o.push(...i)}t.forEach(e=>{e.strokeID=l.id,e.segmentIndex-=d}),a&&t.unshift(a),h&&t.push(h),this.nodes[l.id]=t}),i.forEach(t=>o.push(...this.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1))),this.unload(o),this.load(n),delete this.nodes[e.id],delete this.strokes[e.id],s}replace(e,t){t.forEach(e=>this.add(e)),this.remove(e)}load(e){Array.isArray(e)||(e=[e]),0!=e.length&&(this.tree.load(e),this.tree.canvas.refresh())}updateTree(e,t){this.tree.remove(e),this.nodes[e.strokeID].replace(e,t)}unload(e){Array.isArray(e)||(e=[e]),e.forEach(e=>this.tree.remove(e)),this.tree.canvas.refresh()}search(e){return this.tree.search(e)}reset(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas.refresh()}}class Ht extends Vt{constructor(e){super(e)}intersect(e){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(e),this.mode==Ht.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,e):{intersected:{},selected:this.nodes.map(e=>e.strokeID).unique()}}intersectSegmentation(e){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,e)}}class qt extends Vt{constructor(e){super(e)}select(e){if(!this.context)throw new Error("Required spatial context not found");let t={intersected:{},selected:[]},r=e.bounds,i=be.createClipperPath(e.spline);setTimeout(()=>this.context.tree.canvas.drawSelection(r,e.points,e.path.first),1e3);let s=this.context.search(r),n=this.nodes.map(e=>e.strokeID).unique(),o=s.map(e=>e.strokeID).unique().filter(e=>!n.includes(e));if(this.mode==qt.Mode.PARTIAL_STROKE){let r=e.spline.getPoint(0).toArray(e.layout),s=e.spline.getPoint(e.spline.length-1).toArray(e.layout),o=[...r,...r,...s,...s],a=new Ke(e.brush,new ce(e.layout,o,e.pointProps));this.updateSegmentation(a.path);let h=this.createIntervals(this.nodes,e.path);t=h,n.forEach(e=>{let t=[];h.intersected[e]&&(t=h.intersected[e].intervals),t.forEach(t=>{let r=this.context.getNodes(e)[t.fromNodeIndex];t.inside=be.containsPoint(i,r.point)})})}else t.selected=n;return o.forEach(e=>{let r=this.context.getNodes(e)[0];be.containsPoint(i,r.point)&&t.selected.push(e)}),Object.defineProperty(t,"length",{get:()=>Object.keys(t.intersected).length+t.selected.length,enumerable:!0}),t}}export{$e as BlendMode,re as Brush2D,Le as BrushApplier,qe as BrushGL,J as BrushPrototype,$ as Color,_e as ConvexHullChainProducer,Se as ConvexHullProducer,ke as CurvatureBasedInterpolator,ye as DistanceBasedInterpolator,M as Environment,je as InkBuilder,Xe as InkBuilderAsync,et as InkCanvas2D,yt as InkCanvasGL,kt as InkCodec,o as InkController,g as InkInputProvider,Ot as InkModel,Te as InkPath2D,G as InputContext,X as InputDevice,A as InputListener,fe as InterpolatedSpline,Ht as Intersector,T as Matrix,st as OffscreenCanvasGL,C as PathPoint,ie as PathPointContext,Re as PathProducer,ve as PathSegment,y as Point,we as PointerData,be as Poly,Fe as PolygonMerger,Be as PolygonSimplifier,q as Rect,k as Scalar,qt as Selector,Et as SemanticTriple,B as SensorChannel,U as SensorChannelsContext,j as SensorContext,z as SensorData,Y as SensorStream,V as ShapeFactory,Ce as Smoother,$t as SpatialContext,ce as Spline,Oe as SplineProducer,Ke as Stroke,tt as StrokeRenderer2D,bt as StrokeRendererGL,I as TextTable,Pt as TripleStore,W as TypedArrayCodec,Z as URIResolver,te as fsx,xe as math,F as utils,p as uuid,a as version};
