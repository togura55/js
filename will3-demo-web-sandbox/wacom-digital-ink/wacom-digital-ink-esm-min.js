import*as e from"gl-matrix";import"clipper-lib";import"js-md5";import"long";import"poly2tri";import"protobufjs";import t from"rbush";if("undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:"undefined"!=typeof global&&(global.globalThis=global)),String.prototype.contains||(String.prototype.contains=function(e){return-1!=this.indexOf(e)}),String.prototype.startsWith||(String.prototype.startsWith=function(e){return this.length>=e.length&&this.substring(0,e.length)==e}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return this.length>=e.length&&this.substring(this.length-e.length,this.length)==e}),String.prototype.charsCode=function(){return this.split("").reduce((function(e,t){return e+t.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(e){return-1!=this.toUpperCase().indexOf(e.toUpperCase())},String.prototype.toCharArray=function(e){let t=e?new Uint8Array(this.length):new Array(this.length);for(let e=0;e<this.length;e++){let r=this.charCodeAt(e);r>255&&(t.bytes=!1),t[e]=r}return t},String.fromCharArray=function(e){let t="";try{t=String.fromCharCode.apply(null,e)}catch(r){for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r])}return t},String.prototype.pad=function(e,t){return this.length<e?new Array(e-this.length+1).join(t||"-")+this:this.toString()},Number.prototype.pad=function(e){return String(this).length<e?new Array(e-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){let e=new Float32Array(1);return e[0]=this,e[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(e){return this.indexOf(e)>-1},Array.prototype.clone=function(){return this.map(e=>Object.clone(e))},Array.prototype.unique=function(){return this.filter((e,t)=>this.indexOf(e)==t)},Array.prototype.add=function(e){if(!this.contains(e))return this.push(e)},Array.prototype.insert=function(e,t){this.splice(e,0,t)},Array.prototype.remove=function(e){return this.removeAt(this.indexOf(e))},Array.prototype.removeAt=function(e){return e>-1&&this.splice(e,1),this},Array.prototype.replace=function(e,t,r){let i=this.indexOf(e);if(i>-1)if(!r&&t instanceof Array){let e=[i,1];for(let r=0;r<t.length;r++)e.push(t[r]);this.splice.apply(this,e)}else this.splice(i,1,t);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach(e=>{let t=globalThis[e+"Array"];t?(t.from?Array.prototype["to"+e+"Array"]=function(){return t.from(this)}:Array.prototype["to"+e+"Array"]=function(){return new t(this)},Array.from?t.prototype.toArray=function(){return Array.from(this)}:t.prototype.toArray=function(){return Array.prototype.slice.call(this)},t.prototype.clone=function(){return new t(this,this.byteOffset,this.length)},t.prototype.concat=function(...e){let t=this.length,r=this.length;e.forEach(e=>{if(this.constructor!=e.constructor)throw new Error(`Concat array from wrong type detected - expected ${this.constructor.name}, found ${e.constructor.name}`);t+=e.length});let i=new this.constructor(t);return i.set(this),e.forEach(e=>{i.set(e,r),r+=e.length}),i}):console.warn(e+"Array not found")})},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(e,t){t||(t=function(){});let r=t.getArguments(),i=new Function("body","return function "+e+"("+r+") {return body.apply(this, arguments);};")(t);return i.toString=function(){return t.toString()},i.toSource=function(){return t.toSource()},i},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){let e=this.toString().match(/^function\s([\w$]+)/);return e?e[1]:""}}),Function.prototype.getArguments=function(){let e=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==e.length?[]:e.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(e){let t=arguments.callee.caller.arguments;this.getArguments().forEach((function(e,r){this[e]=t[r]}),e)},Function.prototype.createEnum=function(e,t){if(this[e])throw new Error("Already exists key: "+e);this[e]=new Object;let r=[];for(let i=0;i<t.length;i++){let s=e+"_"+t[i],n=this[e];n[t[i]]=function(){let r=Object.create(Object.prototype,{constructor:{value:Function.create(s)},type:{value:e},name:{value:t[i]},value:{value:i}});return Object.defineProperty(n,i,{get:function(){return r}}),r}(),r.push(n[t[i]])}Object.defineProperty(this[e],"values",{value:r})},Object.equals=function(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;if(e instanceof Array||ArrayBuffer.isTypedArray(e))return e.length==t.length&&e.every((e,r)=>Object.equals(e,t[r]));for(let r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!Object.equals(e[r],t[r]))return!1}}for(let r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0},Object.clone=function(e,t){let r=new Array;return function e(i){if(null===i)return null;if("object"!=typeof i||i.mutable)return i;if("function"==typeof i.clone)return i.clone();for(let e=0;e<r.length;e++)if(r[e][0]===i)return r[e][1];let s=Object.create(Object.getPrototypeOf(i));r.push([i,s]);for(let r in i)t&&"function"==typeof i[r]||i.hasOwnProperty(r)&&(s[r]=e(i[r]));return s}(e)},Object.toSource=function(e,t){if(e&&"object"==typeof e){let r=[];for(let t in e)e.hasOwnProperty(t)&&r.push(`${t}: ${Object.toSource(e[t])}`);return(t?t+" = ":"")+"{"+r.join(", ")+"};"}if("function"==typeof e){let t=e.toString();return 0!=t.indexOf("function")&&(t="function "+t),t}return e},Object.nameAnonymousFunctions=function(e,t){for(let r in e)"function"!=typeof e[r]||e[r].name||("constructor"==r&&t?Object.defineProperty(e[r],"name",{value:t}):Object.defineProperty(e[r],"name",{value:r}))},JSON.toBase64=function(e){return btoa(JSON.stringify(e))},JSON.fromBase64=function(e){return JSON.parse(atob(e))},JSON.encode=function(e){return JSON.toBase64(e).toCharArray(!0)},JSON.decode=function(e){let t=String.fromCharArray(e);return JSON.fromBase64(t)},Math.toDegrees=function(e){return e*(180/this.PI)},Math.toRadians=function(e){return e*(this.PI/180)},Math.randomInt=function(e,t){return Math.floor(this.random()*(t-e+1))+e},function(){if("undefined"!=typeof ENVIRONMENT)return ENVIRONMENT;let e;return e="object"==typeof window?"WEB":"function"==typeof importScripts?"WORKER":"object"==typeof process&&"function"==typeof require?"NODE":"SHELL",Function.prototype.createEnum.call(globalThis,"EnvironmentType",["WEB","WORKER","NODE","SHELL"]),Object.defineProperty(globalThis,"ENVIRONMENT",{value:EnvironmentType[e],enumerable:!0}),ENVIRONMENT}()==EnvironmentType.WEB){if(HTMLElement.prototype.getInlineStyle=function(e){return this.style[e]||this.style["-webkit-"+e]||this.style["-khtml-"+e]||this.style["-moz-"+e]||this.style["-ms-"+e]||this.style["-o-"+e]||""},HTMLElement.prototype.setStyle=function(e,t){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(r){this.style[r+"-"+e]=t}),this),this.style[e]=t},HTMLElement.prototype.getStyle=function(e){let t=e,r=e.startsWith("-");r&&(t=e.substring(1));let i=t.split("-");for(let e=i.length-1;e>0;e--)i[e]=i[e].substring(0,1).toUpperCase()+i[e].substring(1);t=i.join("");let s=window.getComputedStyle?document.defaultView.getComputedStyle(this,null)[t]:this.currentStyle[t];if(!r&&void 0===s){let t=["-webkit","-khtml","-moz","-ms","-o"];for(let r=0;r<t.length&&(s=this.getStyle(t[r]+"-"+e),"undefined"==s);r++);}return s},HTMLElement.prototype.getMathStyle=function(e,t){let r=t?this.getInlineStyle(e):this.getStyle(e);return"auto"==r&&(r=0),parseFloat(r)},HTMLElement.prototype.getTransformStyle=function(){let e={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},t=this.getStyle("transform");if("none"!=t){let r=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(/,\s*/g),i=parseFloat(r[0]),s=parseFloat(r[1]),n=parseFloat(r[2]),o=parseFloat(r[3]),a=parseFloat(r[4]),h=parseFloat(r[5]);e.scale={x:Math.sqrt(i*i+n*n),y:Math.sqrt(o*o+s*s)},e.skew={angleX:Math.tan(n),angleY:Math.tan(s)},e.rotate={angle:Math.atan2(s,i)},e.translate={x:a,y:h},e.matrix={a:i,b:s,c:n,d:o,tx:a,ty:h}}return e},HTMLElement.prototype.toRect=function(){let e=new Object,t=this.getBoundingClientRect();return e.width=this.offsetWidth,e.height=this.offsetHeight,e.left=this.offsetLeft,e.top=this.offsetTop,e.right=e.left+e.width,e.bottom=e.top+e.height,e.scaleFactor=Math.max(e.width,e.height)/Math.min(e.width,e.height),e.offsetWidth=this.offsetWidth,e.offsetHeight=this.offsetHeight,e.fullWidth=this.offsetWidth+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),e.fullHeight=this.offsetHeight+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom"),e.center={x:e.width/2,y:e.height/2},e.rotationFrameWidth=t.width,e.rotationFrameHeight=t.height,e.rotationCenter={x:t.width/2,y:t.height/2},Object.defineProperty(e,"x",{value:e.left,enumerable:!0}),Object.defineProperty(e,"y",{value:e.top,enumerable:!0}),e.centerOnParent={x:e.left+e.rotationCenter.x,y:e.top+e.rotationCenter.y},e.centerOnScreen={x:t.left+e.rotationCenter.x,y:t.top+e.rotationCenter.y},e},HTMLImageElement.prototype.toDataURL=function(e){let t=document.createElement("canvas");return t.width=this.width,t.height=this.height,t.getContext("2d").drawImage(this,0,0),t.toDataURL(e||"image/png")},HTMLImageElement.prototype.toBlob=function(e){return new Blob([this.getBytes(e).buffer],{type:e||"image/png"})},HTMLImageElement.prototype.getBytes=function(e){let t=this.toDataURL(e).split(",")[1];return atob(t).toCharArray(!0)},Image.fromBytes=function(e,t,r){let i=new Image;return i.onload=function(){URL.revokeObjectURL(this.src),t&&t.call(this)},i.src=URL.createObjectURL(new Blob([e.buffer||e],{type:"image/"+(r||"png")})),i},CanvasRenderingContext2D.prototype.clearCanvas=function(e){this.clearRect(0,0,this.canvas.width,this.canvas.height),e&&(this.fillStyle=e,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(e,t){let r=document.createElement("canvas");return r.width=e,r.height=t,r},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}let e=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(e=Math.ceil(e*window.devicePixelRatio),e%10!=0&&(e%10>5?e+=10-e%10:e-=e%10)),e},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}let e=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(e=Math.ceil(e*window.devicePixelRatio),e%10!=0&&(e%10>5?e+=10-e%10:e-=e%10)),e},configurable:!0}),function(){try{"x"in document.createElement("div").getBoundingClientRect()||Object.extend(HTMLElement.prototype,{getBoundingClientRect:function(){let e=this.super.getBoundingClientRect();return e.x=e.left,e.y=e.top,e}})}catch(e){}}(),"undefined"==typeof createImageBitmap&&(window.createImageBitmap=function(e){return new Promise((t,r)=>{let i,s=new Image;s.crossOrigin="anonymous",e instanceof HTMLCanvasElement?e.toBlob(e=>{i=e,s.src=URL.createObjectURL(i)}):e instanceof Blob?(i=e,s.src=URL.createObjectURL(i)):s.src=e,s.onload=()=>{i&&URL.revokeObjectURL(i),t(s)},s.onerror=r})}),"undefined"==typeof PointerEvent){class e extends Event{}window.PointerEvent=e}if("undefined"==typeof TouchEvent){class e extends Event{}window.TouchEvent=e}}let r,i={DEBUG:!1,GL_ANTI_ALIASING_SIZE:1.25,stroke:{generateID:void 0},setOwnBackbuffer(e){this.ownBackbuffer=e},setDefaultLayerSize(e,t){if(e>4e3)throw new Error("Max texture size width (4000) exceeded: "+e);if(t>4e3)throw new Error("Max texture size height (4000) exceeded: "+t);t||(t=e),this.DEFAULT_LAYER_SIZE={width:e,height:t}},setDefaultScaleFactor(e){if(!(e>0&&e<=1))throw new Error("Scale factor should be a number between 0 and 1: "+e);this.DEFAULT_SCALE_FACTOR=e}};class s{constructor(){if(r)throw new Error("URIResolver instance already available");r=this,this.init()}init(){throw new Error("URIResolver: init should be implemented")}get(e){return this[e]}register(e,t){this[e]=t}resolve(e){let t;if(e.includes("?")){let r=this[e.split("?")[0]];if(r){let i=e.split("?")[1],s=[];i.split("&").forEach(e=>{let t=e.split("=")[1],r=parseFloat(t);isFinite(r)?t=r:"true"==t?t=!0:"false"==t&&(t=!1),s.push(t)}),t=function(){return r(...Array.from(arguments).concat(s))}}}else t=this[e];if(!t)throw new Error("Failed to resolve "+e);return t}}Object.defineProperty(s,"instance",{get:()=>r,enumerable:!0});let n={TRANSPERENT:{red:0,green:0,blue:0,alpha:0},BLACK:{red:0,green:0,blue:0,alpha:1},WHITE:{red:255,green:255,blue:255,alpha:1},RED:{red:255,green:0,blue:0,alpha:1},GREEN:{red:0,green:255,blue:0,alpha:1},BLUE:{red:0,green:0,blue:255,alpha:1},init(e){e.ready||(Object.defineProperty(e,"ready",{value:!0}),Object.defineProperty(e,"asRGB",{get:function(){return n.from(this.red,this.green,this.blue)}}),Object.defineProperty(e,"asHSLA",{get:function(){return n.toHSLA(this)}}),Object.defineProperty(e,"asHex",{get:function(){return n.toHex(this)}}),Object.defineProperty(e,"asArray",{get:function(){return n.toArray(this)}}))},from(e,t,r,i=1){var s=e;if(e instanceof Array){var n=e;s=n[0],t=n[1],r=n[2],i=n[3]}var o={red:s,green:t,blue:r,alpha:i};return this.init(o),o},premultiply:e=>({red:e.red/255*e.alpha,green:e.green/255*e.alpha,blue:e.blue/255*e.alpha,alpha:e.alpha}),postdivide(e,t,r,i){let s=parseInt(255*e/i),o=parseInt(255*t/i),a=parseInt(255*r/i);return n.from(s,o,a,i)},equals:(e,t)=>!(!n.is(e)&&!n.is(t))&&(e.red==t.red&&e.green==t.green&&e.blue==t.blue&&e.alpha==t.alpha),is:e=>e&&"red"in e&&"green"in e&&"blue"in e,toArray:e=>[e.red,e.green,e.blue,e.alpha],fromHSLA(e=0,t=0,r=0,i){e/=60,t/=100,r/=100;let s=(1-Math.abs(2*r-1))*t,o=s*(1-Math.abs(e%2-1)),a=0,h=0,l=0;e>=0&&e<1?(a=s,h=o):e>=1&&e<2?(a=o,h=s):e>=2&&e<3?(h=s,l=o):e>=3&&e<4?(h=o,l=s):e>=4&&e<5?(a=o,l=s):(a=s,l=o);let d=r-s/2;return a+=d,h+=d,l+=d,n.from(Math.round(255*a),Math.round(255*h),Math.round(255*l),i)},toHSLA(e){let t=e.red/255,r=e.green/255,i=e.blue/255,s=Math.min(t,r,i),n=Math.max(t,r,i),o=0,a=0,h=(n+s)/2;if(n!=s){let e=n-s;switch(a=e/(1-Math.abs(2*h-1)),n){case t:o=(r-i)/e%6;break;case r:o=(i-t)/e+2;break;case i:o=(t-r)/e+4}}return o*=60,o<0&&(o+=360),{hue:parseFloat(o.toFixed(0)),saturation:parseFloat((100*a).toFixed(2)),lightness:parseFloat((100*h).toFixed(2)),alpha:e.alpha}},fromHex:e=>(e=e.substring(1),n.from(parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16))),toHex:e=>"#"+e.red.toString(16).pad(2,"0")+e.green.toString(16).pad(2,"0")+e.blue.toString(16).pad(2,"0"),random:e=>n.from(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),e?Math.random():1)};!function(){for(let e in n)"object"==typeof n[e]&&n.init(n[e])}();const{glMatrix:o,mat2d:a,mat4:h}=e,l={m00:0,m01:1,m02:2,m03:3,m10:4,m11:5,m12:6,m13:7,m20:8,m21:9,m22:10,m23:11,m30:12,m31:13,m32:14,m33:15},d={a:0,b:1,c:4,d:5,dx:12,dy:13};function u(e,t){let r=h.create(),i=isNaN(e)?e.x:e,s=isNaN(e)?e.y:e;return r[d.a]=i,r[d.b]=0,r[d.c]=0,r[d.d]=s,r[d.dx]=t.x-t.x*i,r[d.dy]=t.y-t.y*s,r}function c(e,t){let r=h.create(),i=Math.sin(e),s=Math.cos(e);return r[d.a]=s,r[d.b]=i,r[d.c]=-i,r[d.d]=s,r[d.dx]=t.x-t.x*s+t.y*i,r[d.dy]=t.y-t.x*i-t.y*s,r}function p(e,t,r){let i=h.create(),s=u(t,r),n=c(e,r);return h.multiply(i,s,n),i}function f(e){let t=h.create(),r=e.getStyle("transform");return"none"!=r&&(r=r.substring(r.indexOf("(")+1,r.indexOf(")")).split(/,\s*/g),t[d.a]=parseFloat(r[0]),t[d.b]=parseFloat(r[1]),t[d.c]=parseFloat(r[2]),t[d.d]=parseFloat(r[3]),t[d.dx]=parseFloat(r[4]),t[d.dy]=parseFloat(r[5])),t}function g(e){let t=m(e);return o.ARRAY_TYPE==Float32Array&&(t=t.toArray()),"matrix("+t.join(", ")+")"}function m(e){return a.fromValues(e[d.a],e[d.b],e[d.c],e[d.d],e[d.dx],e[d.dy])}var y=Object.freeze({__proto__:null,MAT4_INDEX:l,MAT2D_INDEX:d,makeScaleAtPoint:u,makeRotationAroundPoint:c,makeTransformAroundPoint:p,fromCSS:f,toCSS:g,toMat2D:m});const{vec3:E,mat4:b}=e;class x{constructor(e,t,r){this.x=e,this.y=t,isFinite(r)&&(this.z=r),this.red,this.green,this.blue,this.alpha,this.size,this.rotation,this.scaleX,this.scaleY,this.scaleZ,this.offsetX,this.offsetY,this.offsetZ,this.dX,this.dY}static createInstance(e={},t={}){let r=new x;return r.x=t.x,r.y=t.y,r.z=t.z,r.red=e.red,r.green=e.green,r.blue=e.blue,r.alpha=e.alpha,r.size=e.size,r.rotation=e.rotation||0,r.scaleX=e.scaleX||1,r.scaleY=e.scaleY||1,r.scaleZ=e.scaleZ||1,r.offsetX=e.offsetX||0,r.offsetY=e.offsetY||0,r.offsetZ=e.offsetZ||0,r}fill(e,t,r=0){let i=e.length;e.forEach((e,s)=>this.setProperty(e,t[r*i+s]))}getProperty(e){switch(e){case x.Property.X:return this.x;case x.Property.Y:return this.y;case x.Property.Z:return this.z;case x.Property.RED:return this.red;case x.Property.GREEN:return this.green;case x.Property.BLUE:return this.blue;case x.Property.ALPHA:return this.alpha;case x.Property.SIZE:return this.size;case x.Property.ROTATION:return this.rotation;case x.Property.SCALE_X:return this.scaleX;case x.Property.SCALE_Y:return this.scaleY;case x.Property.SCALE_Z:return this.scaleZ;case x.Property.OFFSET_X:return this.offsetX;case x.Property.OFFSET_Y:return this.offsetY;case x.Property.OFFSET_Z:return this.offsetZ;case x.Property.D_X:return this.dX;case x.Property.D_Y:return this.dY;default:throw console.warn(e),new Error("Invalid property found")}}setProperty(e,t){switch(e){case x.Property.X:this.x=t;break;case x.Property.Y:this.y=t;break;case x.Property.Z:this.z=t;break;case x.Property.RED:this.red=t;break;case x.Property.GREEN:this.green=t;break;case x.Property.BLUE:this.blue=t;break;case x.Property.ALPHA:this.alpha=t;break;case x.Property.SIZE:this.size=t;break;case x.Property.ROTATION:this.rotation=t;break;case x.Property.SCALE_X:this.scaleX=t;break;case x.Property.SCALE_Y:this.scaleY=t;break;case x.Property.SCALE_Z:this.scaleZ=t;break;case x.Property.OFFSET_X:this.offsetX=t;break;case x.Property.OFFSET_Y:this.offsetY=t;break;case x.Property.OFFSET_Z:this.offsetZ=t;break;case x.Property.D_X:this.dX=t;break;case x.Property.D_Y:this.dY=t;break;default:throw console.warn(e),new Error("Invalid property found")}}transform(e){let t=(e[d.a]**2+e[d.c]**2)**.5,r=E.fromValues(this.x,this.y,this.z||0);E.transformMat4(r,r,e),this.x=r[0],this.y=r[1],this.z=r[2],this.size*=t,this.scaleX*=t,this.scaleY*=t,this.scaleZ*=t,this.offsetX*=t,this.offsetY*=t,this.offsetZ*=t}asArray(e){return e.map(e=>{let t=this.getProperty(e);if(null==t||!isFinite(t))throw new Error(`Property ${e.name} has invalid value ${t}`);return t})}debug(){let e=[];return x.Property.values.forEach(t=>{let r=this.getProperty(t);null!=r&&isFinite(r)&&e.push(t.name,this.getProperty(t))}),e}}x.createEnum("Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);const{quat2:P,vec2:w,mat4:T}=e;class R{constructor(e,t,r,i){let s=r-e,n=t-i,o=(e+r)/2,a=(i+t)/2;Object.defineProperties(this,{left:{value:e,enumerable:!0},x:{value:e,enumerable:!0},bottom:{value:t,enumerable:!0},y:{value:t,enumerable:!0},right:{value:r,enumerable:!0},top:{value:i,enumerable:!0},width:{value:r-e,enumerable:!0},height:{value:i-t,enumerable:!0},center:{value:{x:o,y:a},enumerable:!0},size:{value:{width:s,height:n},enumerable:!0}})}union(e){if(e&&!(e instanceof R))throw new TypeError("rect must be instance of GLRect");return e?new R(Math.min(this.left,e.left),Math.min(this.bottom,e.bottom),Math.max(this.right,e.right),Math.max(this.top,e.top)):this}intersect(e){if(e&&!(e instanceof R))throw new TypeError("rect must be instance of GLRect");if(!e)return null;let t=new R(Math.max(this.left,e.left),Math.max(this.bottom,e.bottom),Math.min(this.right,e.right),Math.min(this.top,e.top));return t.width>0&&t.height>0?t:null}ceil(){return new R(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}floor(){return new R(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}toQuad(e){let t;if(e){let r=w.fromValues(this.left,this.bottom),i=w.fromValues(this.right,this.bottom),s=w.fromValues(this.left,this.top),n=w.fromValues(this.right,this.top);w.transformMat4(r,r,e),w.transformMat4(i,i,e),w.transformMat4(s,s,e),w.transformMat4(n,n,e),t=P.fromValues(r[0],r[1],i[0],i[1],s[0],s[1],n[0],n[1])}else t=P.fromValues(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return t}static makeWithSize(e,t,r,i){return new R(e,t,e+r,t+i)}static calculateBrushGLSegmentBounds(e,t,r=T.create()){let i=.5*e.size,s=Math.abs(t*i),n=w.fromValues(e.x,e.y);w.transformMat4(n,n,r);let o=n[0],a=n[1],h=e.scaleX*i,l=e.scaleY*i,d=e.offsetX,u=-e.offsetY,c=Math.cos(e.rotation),p=Math.sin(e.rotation),f=Number.MAX_SAFE_INTEGER,g=Number.MIN_SAFE_INTEGER,m=Number.MAX_SAFE_INTEGER,y=Number.MIN_SAFE_INTEGER;return[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}].forEach(e=>{e.x=e.x*h+d,e.y=e.y*l+u;let t=c*e.x+p*e.y+o,r=-p*e.x+c*e.y+a,i=t-s;f=Math.min(f,i),g=Math.max(g,i),i=t+s,f=Math.min(f,i),g=Math.max(g,i);let n=r-s;m=Math.min(m,n),y=Math.max(y,n),n=r+s,m=Math.min(m,n),y=Math.max(y,n)}),R.makeWithSize(f,m,g-f,y-m)}}class I{constructor(e,t,r,i){let s=r-e,n=i-t,o=(e+r)/2,a=(t+i)/2;Object.defineProperties(this,{left:{value:e,enumerable:!0},top:{value:t,enumerable:!0},right:{value:r,enumerable:!0},bottom:{value:i,enumerable:!0},x:{value:e,enumerable:!0},y:{value:t,enumerable:!0},width:{value:s,enumerable:!0},height:{value:n,enumerable:!0},center:{value:{x:o,y:a},enumerable:!0},size:{value:{width:s,height:n},enumerable:!0}})}union(e){if(e&&!(e instanceof I))throw new TypeError("rect must be instance of Rect");return e?new I(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right),Math.max(this.bottom,e.bottom)):this}intersect(e){if(!e)return null;if(!(e instanceof I))throw new TypeError("rect must be instance of Rect");let t=new I(Math.max(this.left,e.left),Math.max(this.top,e.top),Math.min(this.right,e.right),Math.min(this.bottom,e.bottom));return t.width>0&&t.height>0?t:null}ceil(e){let t=Math.floor(this.left),r=Math.floor(this.top),i=Math.ceil(this.right),s=Math.ceil(this.bottom);if(e){let e=i-t,n=s-r;e+=e%2,n+=n%2,i=t+e,s=r+n}return new I(t,r,i,s)}floor(e){let t=Math.ceil(this.left),r=Math.ceil(this.top),i=Math.floor(this.right),s=Math.floor(this.bottom);if(e){let e=i-t,n=s-r;e-=e%2,n-=n%2,i=t+e,s=r+n}return new I(t,r,i,s)}contains(e){return this.left<=e.x&&this.right>=e.x&&this.top<=e.y&&this.bottom>=e.y}toPath(e=n.BLACK,t=1){return{layout:[x.Property.X,x.Property.Y],size:t,color:e,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}toGLRect(){return R.makeWithSize(this.x,this.y,this.width,this.height)}static fromGLRect(e){if(!e)return null;if(!(e instanceof R))throw new TypeError("rect must be instance of GLRect");return I.makeWithSize(e.left,e.bottom,e.width,e.height)}static ofPolygon(e){return I.ofPolygons([e])}static ofPolygons(e){if(!e.length)return null;let t=Number.MAX_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;return e.forEach(e=>{for(let n=0;n<e.length;n+=2){let o=e[n],a=e[n+1];t=Math.min(t,o),r=Math.min(r,a),i=Math.max(i,o),s=Math.max(s,a)}}),I.make(t,r,i,s)}static ofSpline(e,t,r){let i;for(let s=0;s<e.length;s++)i=R.calculateBrushGLSegmentBounds(e.getPoint(s),t,r).union(i);return I.fromGLRect(i)}static ofEdges(e,t,r,i){return new I(e,t,r,i)}static create(e,t,r,i){return new I(e,t,e+r,t+i)}static make(e,t,r,i){return new I(e,t,r,i)}static makeWithSize(e,t,r,i){return new I(e,t,e+r,t+i)}static union(e,t){return e?t?e.union(t):e:t}static intersect(e,t){return e&&t?e.intersect(t):null}}let v;v=ENVIRONMENT==EnvironmentType.NODE?require("clipper-lib"):ClipperLib;const{Clipper:S,Paths:A,Path:C,ClipType:O,PolyType:M,PolyFillType:D}=v;class N{constructor(e){let t=new A;"number"==typeof e[0]&&(e=[e]);let r=I.ofPolygons(e),i=65534/(r.width+1e-16),s=65534/(r.height+1e-16),n=Math.floor(Math.min(i,s)),o=r.left+32767/n,a=r.top+32767/n;e.forEach(e=>{let r=new C;for(let t=0;t<e.length;t+=2){let i=(e[t]-o)*n,s=(e[t+1]-a)*n,h=i<0?Math.ceil(i):Math.floor(i),l=s<0?Math.ceil(s):Math.floor(s);r.push({X:h,Y:l})}t.push(r)}),this.subject=t,this.solution=new A,this.bounds=r,this.transform={scale:n,offsetX:o,offsetY:a}}toPath2D(){return this.lastPoint={},this.solution.map(e=>this.flatPath(e))}flatPath(e){let t=[];return e.forEach(e=>{this.lastPoint.X==e.X&&this.lastPoint.Y==e.Y||(t.push(e.X/this.transform.scale+this.transform.offsetX,e.Y/this.transform.scale+this.transform.offsetY),this.lastPoint=e)}),t}apply(e){let t=new A;return"number"==typeof e[0]&&(e=[e]),e.forEach(e=>{let r=new C;for(let t=0;t<e.length;t+=2){let i=(e[t]-this.transform.offsetX)*this.transform.scale,s=(e[t+1]-this.transform.offsetY)*this.transform.scale,n=i<0?Math.ceil(i):Math.floor(i),o=s<0?Math.ceil(s):Math.floor(s);r.push({X:n,Y:o})}t.push(r)}),t}}class L{static union(e){let t=new N(e),r=new S;return r.StrictlySimple=!0,r.AddPaths(t.subject,M.ptSubject,!0),r.Execute(O.ctUnion,t.solution,D.pftNonZero,D.pftNonZero),t.toPath2D()}static intersection(e,t){e instanceof N||(e=new N(e)),e.clip=e.apply(t);let r=new S;return r.StrictlySimple=!0,r.AddPaths(e.subject,M.ptSubject,!0),r.AddPaths(e.clip,M.ptClip,!0),r.Execute(O.ctIntersection,e.solution,D.pftNonZero,D.pftNonZero),e.solution.length>0?e:null}static createClipperPath(e,t=32){let r=new C;r.scale=t;for(let i=0;i<e.length;i++){let s=i*e.stride;r.push({X:Math.round(e.points[s]*t),Y:Math.round(e.points[s+1]*t)})}return r}static containsPoint(e,t){let r={X:Math.round(t.x*e.scale),Y:Math.round(t.y*e.scale)};return 1==S.PointInPolygon(r,e)}}async function k(e,t="binary"){if(e instanceof Uint8Array)return e;let r,i=await fetch(e,{mode:"no-cors"});if("json"==t)r=await i.json();else if("text"==t)r=await i.text();else if("blob"==t)r=await i.blob();else{let e=await i.arrayBuffer();r=new Uint8Array(e)}return r}async function B(e){let t;return t="string"==typeof e||ENVIRONMENT==EnvironmentType.NODE?await function(e){return new Promise((t,r)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>{if(ENVIRONMENT==EnvironmentType.NODE){const e=new OffscreenCanvas(i.width,i.height);e.getContext("2d").drawImage(i,0,0),t(e)}else t(i)},i.onerror=r,"string"==typeof e?i.src=e:ENVIRONMENT==EnvironmentType.NODE?e instanceof Uint8Array?i.src=Buffer.from(e):i.src=e:i.src=URL.createObjectURL(e)})}(e):e instanceof ArrayBuffer||e instanceof Uint8Array?await createImageBitmap(new Blob([e],{type:"image/png"})):await createImageBitmap(e),t}async function _(e){let t,r;if(Array.isArray(e.shape)){let r=[];for(let t of e.shape){let e=await k(t);r.push(e)}t=r}else t=await k(e.shape);return r=await k(e.fill),{shape:t,fill:r}}var F=Object.freeze({__proto__:null,loadFile:k,loadImage:B,loadBrushGLBinary:_,saveAs:function(e,t,r="application/octet-stream"){let i;if(e instanceof Blob)i=URL.createObjectURL(e);else{let t;e instanceof ArrayBuffer?t=[e]:e.buffer?(e.byteLength<e.buffer.byteLength&&(e=new Uint8Array(e)),t=[e.buffer]):e instanceof Array&&(t=e);let s=new Blob(t,{type:r});i=URL.createObjectURL(s)}let s=document.createElement("a");s.href=i,s.download=t,s.appendChild(document.createTextNode(t)),s.style.display="none",document.body.appendChild(s),s.click(),setTimeout((function(){URL.revokeObjectURL(i),s.remove()}),911)}});function U(e,t){let r,i={};return Object.defineProperty(i,"x",{value:t.x-e.x,enumerable:!0}),Object.defineProperty(i,"y",{value:t.y-e.y,enumerable:!0}),Object.defineProperty(i,"length",{get:()=>(isNaN(r)&&(r=Math.sqrt(i.x*i.x+i.y*i.y)),r),enumerable:!0}),i}function j(e,t){let r=e.x*t.x+e.y*t.y,i=e.x*t.y-e.y*t.x;return Math.atan2(i,r)}var G=Object.freeze({__proto__:null,vector:U,angle:j});const{vec3:Y,mat2d:X,mat4:z}=e,V=d;function H(e){return Y.fromValues(e.x,e.y,e.z||0)}function W(e){let t=z.create();return e&&(t[V.a]=e.a||1,t[V.b]=e.b||0,t[V.c]=e.c||0,t[V.d]=e.d||1,t[V.dx]=e.dx||e.tx||0,t[V.dy]=e.dy||e.ty||0),t}function $(e,t,r=0){let i=e;arguments.length>1&&(i={x:e,y:t,z:r});let s=W(),n=H(i);return z.fromTranslation(s,n),s}function Z(e,t,r){return p(e,t,r)}function q(e,t){let r=H(e);return Y.transformMat4(r,r,t),{x:r[0],y:r[1],z:r[2]}}function K(e,t){let r=q({x:e.left,y:e.top},t),i=q({x:e.right,y:e.top},t),s=q({x:e.left,y:e.bottom},t),n=q({x:e.right,y:e.bottom},t),o=Math.min(r.x,i.x,s.x,n.x),a=Math.min(r.y,i.y,s.y,n.y),h=Math.max(r.x,i.x,s.x,n.x),l=Math.max(r.y,i.y,s.y,n.y);return new I(o,a,h,l)}function J(e,t){let r=W();return z.multiply(r,e,t),r}function Q(e){let t=W();return z.invert(t,e),t}var ee=Object.freeze({__proto__:null,makeGLPoint:H,makeGLMatrix:W,isIdentity:function(e){return 1==e[V.a]&&0==e[V.b]&&0==e[V.c]&&1==e[V.d]&&0==e[V.dx]&&0==e[V.dy]},makeTranslate:$,makeScaleAtPoint:function(e,t){return u(e,t)},makeRotationAroundPoint:function(e,t){return c(e,t)},makeTransformAroundPoint:Z,transformPoint:q,transformRect:K,multiply:J,invert:Q});class te{constructor(e){this.header=[],this.table=[],e.forEach(e=>{"string"==typeof e&&(e={name:e,title:e}),e.size=e.title.length,this.header.push(e)})}insert(e){this.table.push(e),this.header.forEach(t=>{let r=e[t.name];null!=r&&(t.size=Math.max(t.size,r.toString().length))})}build(){let e=[],t=this.header.length+1,r=[];this.header.forEach(e=>{t+=e.size+2;let i=e.size-e.title.length,s=Math.floor(i/2),n=Math.ceil(i/2);r.push(this.getRepetedValue(s)+e.title+this.getRepetedValue(n))}),this.table.forEach(t=>{let r=[];this.header.forEach(e=>{let i=null==t[e.name]?"":t[e.name],s=e.size-i.toString().length;r.push(i+this.getRepetedValue(s))}),e.push(r)});let i="";return i+=this.getRepetedValue(t,"="),i+="\n",i+=this.getFormattedRow(r),i+="\n",i+=this.getRepetedValue(t,"="),i+="\n",e.forEach(e=>{i+=this.getFormattedRow(e),i+="\n"}),i}getFormattedRow(e){let t="| ";return e.forEach(e=>{t+=e,t+=" | "}),t.trim()}getRepetedValue(e,t=" "){return new Array(e+1).join(t)}}let re={longToByteArray(e){let t=[0,0,0,0,0,0,0,0];for(let r=0;r<t.length;r++){let i=255&e;t[r]=i,e=(e-i)/256}return t},byteArrayToLong(e){let t=0;for(let r=e.length-1;r>=0;r--)t=256*t+e[r];return t},crc32:function(){let e=new Uint32Array(256);for(let t=256;t--;){let r=t;for(let e=8;e--;)r=1&r?3988292384^r>>>1:r>>>1;e[t]=r}return function(t){let r=-1;for(let i=0,s=t.length;i<s;i++)r=r>>>8^e[255&r^t[i]];return(-1^r)>>>0}}(),mapTo:(e,t,r)=>r.min+(re.clamp(e,t)-t.min)/(t.max-t.min)*(r.max-r.min),clamp:(e,t)=>Math.min(Math.max(e,t.min),t.max),comparator(){let e=Array.prototype.slice.call(arguments),t=function(e,t,r){return t.replace("[",".").replace("]","").split(".").forEach(t=>e=e[t]),r?e.toLowerCase():e};return function(r,i){return e.map(e=>function(e,t,r){let i="asc"===r?1:-1;return e>t?1*i:e<t?-1*i:0}(t(r,e.sortBy,e.ignoreCase),t(i,e.sortBy,e.ignoreCase),e.sortOrder)).reduceRight((function(e,t){return t||e}))}},getPropName(e,t){let r=e.split("_"),i=r.first.toLowerCase();t&&(i=i.substring(0,1).toUpperCase()+i.substring(1));for(let e=1;e<r.length;e++)i+=r[e].substring(0,1),i+=r[e].substring(1).toLowerCase();return i},getEnumValueName(e){let t="";for(let r=0;r<e.length;r++)r>0&&e[r]!=e[r].toLowerCase()&&(t+="_"),t+=e[r];return t.toUpperCase()}};class ie{getInkBuilder(e=[]){throw new Error("InkController.getInkBuilder(changedTouches = []) should be implemented")}registerTouches(e){throw new Error("InkController.registerTouches(changedTouches) should be implemented")}reset(e){throw new Error("InkController.reset(sensorPoint) should be implemented")}begin(e){throw new Error("InkController.begin(sensorPoint) should be implemented")}move(e){throw new Error("InkController.move(sensorPoint) should be implemented")}end(e){throw new Error("InkController.end(sensorPoint) should be implemented")}abort(){throw new Error("InkController.abort(sensorPoint) should be implemented")}resize(){throw new Error("InkController.resize(sensorPoint) should be implemented")}}const{vec3:se,mat4:ne}=e;let oe={pointers:{pointer:["down","move","up"],mouse:["down","move","up"],touch:["start","move","end"]},open(e){if(!(e instanceof ie))throw new Error("Argument doesn't implement InkController interface");this.inkController=e,this.canvas=e.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset(e){for(let t in this.pointers){let r="touch"==t?{passive:!0}:void 0,i=t+this.pointers[t][0];this.canvas.removeEventListener(i,this.begin),e.canvas.surface.addEventListener(i,this.begin,r)}this.dettachResize(),this.inkController=e,this.canvas=e.canvas.surface,this.attachResize()},close(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start(e){let t=e?{[e]:this.pointers[e]}:this.pointers;for(e in t){let r="touch"==e?{passive:!0}:void 0;for(let i=0;i<t[e].length;i++){let s=e+t[e][i];0==i?this.canvas.addEventListener(s,this.begin,r):addEventListener(s,2==i?this.end:this.move,r)}}},stop(e){let t=e?{[e]:this.pointers[e]}:this.pointers;for(e in e&&"mouse"!=e||clearTimeout(this.timeoutID),t)for(let r=0;r<t[e].length;r++){let i=e+t[e][r];0==r?this.canvas.removeEventListener(i,this.begin):removeEventListener(i,2==r?this.end:this.move)}},attachResize(){var e,t,r;this.inkController.resize&&(this.resize=(e=()=>this.inkController.resize(),t=200,r=null,function(){var i=this,s=arguments;clearTimeout(r),r=setTimeout((function(){e.apply(i,s)}),t)}),addEventListener("resize",this.resize))},dettachResize(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed(e){return this.provider==this.getInputProvider(e)&&(!e.pointerType||"pen"==e.pointerType)},isInputExpected(e){let t=!1,r=this.inkController.getInkBuilder(e.changedTouches);return r&&(t=e.type.endsWith("down")||e.type.endsWith("start")?!r.phase:!!r.phase),t},getSensorPoint(e){let t=void 0,r=this.inkController.getInkBuilder(e.changedTouches);if(r){let i=this.getOffset(e);t=r.createSensorPoint(e,i.x,i.y)}return t},getOffset(e){if(e.changedTouches){let t=this.inkController.getInkBuilder(e.changedTouches);e=t.touchID!=e.changedTouches.item(0).identifier?Array.from(e.changedTouches).filter(e=>e.identifier==t.touchID).first:e.changedTouches.item(0)}let t=this.canvas.offsetParent;if(!t)return{x:0,y:0};let r=t.getBoundingClientRect(),i={x:e.pageX-r.x,y:e.pageY-r.y};if(this.inkController.transform){let e=ne.create();ne.invert(e,this.inkController.transform);let t=se.fromValues(i.x,i.y,0);se.transformMat4(t,t,e),i.x=t[0],i.y=t[1]}return i},getInputProvider:e=>e.pointerType?e.pointerType:e.type.replace(/down|start|move|up|end/g,""),begin(e){if(e instanceof MouseEvent&&0!=e.button)return;if(this.provider||(this.provider=this.getInputProvider(e)),!this.isInputAllowed(e))return;if(e instanceof TouchEvent&&this.inkController.registerTouches(e.changedTouches),!this.isInputExpected(e))return;let t=this.getSensorPoint(e);t&&this.inkController.begin(t)},move(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;let t=this.getSensorPoint(e);t&&this.inkController.move(t)},end(e){if(!this.isInputAllowed(e)||!this.isInputExpected(e))return;let t=this.getSensorPoint(e);t&&(this.inkController.end(t),e instanceof MouseEvent||(this.stop("mouse"),this.timeoutID=setTimeout(()=>this.start("mouse"),500))),e.touches&&0!=e.touches.length||delete this.provider},abort(e){delete this.provider,this.inkController.abort&&this.inkController.abort(e)}},ae={init:e=>[e.options.Translate.Handle||e],start(e){this.lastPoint={x:e.clientX,y:e.clientY}},move(e){return this.delta={x:e.clientX-this.lastPoint.x,y:e.clientY-this.lastPoint.y},this.lastPoint={x:e.clientX,y:e.clientY},$(this.delta)},end(e){}},he={init(e){let t=[],r=e.options.Scale;return isNaN(r.MinWidth)&&(r.MinWidth=50),isNaN(r.MinHeight)&&(r.MinHeight=50),(r.KeepRatio?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]).forEach(r=>{let i=document.createElement("div");i.className="ResizeHandle "+r,i.type=r,i.root=e,i.onmouseover=function(){he.updateCursor(this)},e.appendChild(i),t.push(i)}),t},start(e){switch(this.origin=this.obj.frame.toRect(),this.center={x:this.origin.left+this.origin.width/2,y:this.origin.top+this.origin.height/2},this.offsetParent=this.obj.offsetParent.getBoundingClientRect(),e.currentTarget.type){case"TL":this.point={x:-this.origin.width/2,y:-this.origin.height/2};break;case"T":this.point={x:0,y:-this.origin.height/2};break;case"TR":this.point={x:this.origin.width/2,y:-this.origin.height/2};break;case"R":this.point={x:this.origin.width/2,y:0};break;case"BR":this.point={x:this.origin.width/2,y:this.origin.height/2};break;case"B":this.point={x:0,y:this.origin.height/2};break;case"BL":this.point={x:-this.origin.width/2,y:this.origin.height/2};break;case"L":this.point={x:-this.origin.width/2,y:0}}this.options.ExcludeRotation instanceof Function?this.excludeRotation=this.options.ExcludeRotation.call({}):this.excludeRotation=!!this.options.ExcludeRotation,this.excludeRotation=this.excludeRotation||0==this.point.x||0==this.point.y},move(e){let t=he.Transformer,r=q({x:0,y:0},t.transform),i=q(this.point,t.transform),s={x:2*r.x-i.x,y:2*r.y-i.y},n=U(s,{x:e.clientX-this.offsetParent.x-this.center.x,y:e.clientY-this.offsetParent.y-this.center.y}),o=U(s,i),a=this.excludeRotation?0:j(o,n),h=n.length/o.length;0==this.point.x?h={x:1,y:h}:0==this.point.y&&(h={x:h,y:1});let l=Z(a,h,s),d=J(l,t.transform),u=K(this.origin,d);return(u.width<this.options.MinWidth||u.height<this.options.MinHeight)&&(l=null),l},end(e){},updateCursor(e){let t,r=e.root.getTransformStyle().rotate.angle;"TR"==e.type||"BL"==e.type?r+=Math.PI/4:"TL"==e.type||"BR"==e.type?r+=3*Math.PI/4:"L"!=e.type&&"R"!=e.type||(r+=Math.PI/2),r<0?r+=2*Math.PI:r>2*Math.PI&&(r-=2*Math.PI),t=r>Math.PI/8&&r<=3*Math.PI/8||r>=9*Math.PI/8&&r<=11*Math.PI/8?"nesw-resize":r>3*Math.PI/8&&r<=5*Math.PI/8||r>=11*Math.PI/8&&r<=13*Math.PI/8?"ew-resize":r>5*Math.PI/8&&r<=7*Math.PI/8||r>=13*Math.PI/8&&r<=15*Math.PI/8?"nwse-resize":"ns-resize",e.style.cursor=t}},le={init:e=>e.options.Rotate.Handles,start(e){let t=this.obj.getBoundingClientRect();this.center={x:t.left+t.width/2,y:t.top+t.height/2},this.centerToMouse=U(this.center,{x:e.clientX,y:e.clientY})},move(e){let t=U(this.center,{x:e.clientX,y:e.clientY}),r=j(this.centerToMouse,t);if(0==r)return null;this.centerToMouse=t;let i=le.Transformer;return c(r,{x:i.transform[d.dx],y:i.transform[d.dy]})},end(e){}},de={start(e){},move:e=>e.detail.transform,end(e){}};const{vec3:ue,mat4:ce}=e;let pe={elements:[],initEvents(e){e.addEventListener("touchstart",(function(e){2==e.touches.length&&(this!=e.touches[0].target&&!this.contains(e.touches[0].target)||this!=e.touches[1].target&&!this.contains(e.touches[1].target)||(pe.element=this,pe.options=this.options,pe.start(e),pe.fireEvent(e,"start")))}),{passive:!1}),e.addEventListener("touchmove",(function(e){if(pe.element!=this)return;let t=pe.move(e);pe.fireEvent(e,"",t)}),{passive:!1}),e.addEventListener("touchend",(function(e){pe.element&&pe.element==this&&e.touches.length<2&&(pe.end(e),pe.fireEvent(e,"end"),pe.element=null)}),{passive:!1})},start(e){let t=(this.element.frame||this.element).toRect();this.center={x:t.left+t.width/2,y:t.top+t.height/2},this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.lastPinch=this.createPinch(e),this.options.Transform.ExcludeRotation instanceof Function?this.excludeRotation=this.options.Transform.ExcludeRotation():this.excludeRotation=!!this.options.Transform.ExcludeRotation},move(e){let t=this.createPinch(e),r=U(this.lastPinch[0],this.lastPinch[1]),i=U(t[0],t[1]),s=(this.lastPinch[0].x+this.lastPinch[1].x)/2,n=(this.lastPinch[0].y+this.lastPinch[1].y)/2,o=(t[0].x+t[1].x)/2,a=(t[0].y+t[1].y)/2,h={x:o-s,y:a-n},l=this.excludeRotation?0:j(r,i),d=i.length/r.length,u={x:o-this.offsetParent.x-this.center.x,y:a-this.offsetParent.y-this.center.y};this.lastPinch=t;let c,f={pin:u,origin:this.center,scale:d,rotation:l,translation:h};return Object.defineProperty(f,"transform",{get:function(){return c||(c=p(this.rotation,this.scale,this.pin),ce.translate(c,c,ue.fromValues(this.translation.x,this.translation.y,0))),c}}),f},end(e){},createPinch(e){let t=[];return t[0]={x:e.touches[0].clientX,y:e.touches[0].clientY},t[1]={x:e.touches[1].clientX,y:e.touches[1].clientY},t},fireEvent(e,t,r){e.cancelable&&e.preventDefault(),e.stopPropagation();let i=new CustomEvent("pinch"+t,{detail:r});i.touches=e.touches,i.changedTouches=e.changedTouches,this.element.dispatchEvent(i)}},fe={register:(e,t)=>pe.elements.contains(e)?(e.options.Transform=Object.assign(e.options.Transform,t),!1):(e.options||(e.options={}),e.options.Transform=t||{},pe.elements.push(e),pe.initEvents(e),!0)},ge={Translate:ae,Scale:he,Rotate:le,Transform:de,add(e,t,r){if(t.options||(t.options={}),e in t.options)throw new Error(e+" transform already added on this object");t.options[e]=r||{},ge.initTransformFrame(t),ge[e].Transformer=ge.Transformer;let i=ge[e].init(t);ge.attachEvents(i,e,t)},attachEvents(e,t,r){e.forEach(e=>{e.addEventListener("dragstart",e=>{e.preventDefault(),e.stopPropagation()}),e.addEventListener("mousedown",e=>{0==e.button&&ge.start(e,t,r)}),document.addEventListener("mousemove",e=>{ge.move(e,t)}),document.addEventListener("mouseup",e=>{ge.end(e,t)}),e.addEventListener("touchstart",e=>{ge.TransformTransform||ge.start(e,t,r)},{passive:!1}),document.addEventListener("touchmove",e=>{ge.move(e,t)},{passive:!1}),document.addEventListener("touchend",e=>{ge.end(e,t)},{passive:!1})});let i=!1;r.options.Scale&&(i=r.options.Scale.ExcludeRotation),i||(i=!r.options.Rotate),fe.register(r,{ExcludeRotation:i})&&(r.addEventListener("pinchstart",e=>{ge.TranslateTransform&&ge.end(e,"Translate",!0),ge.ScaleTransform&&ge.end(e,"Scale",!0),ge.RotateTransform&&ge.end(e,"Rotate",!0),ge.start(e,"Transform",r)}),r.addEventListener("pinch",e=>{ge.move(e,"Transform")}),r.addEventListener("pinchend",e=>{ge.end(e,"Transform")}))},start(e,t,r){if(ge.TransformTransform||ge.TranslateTransform||ge.ScaleTransform||ge.RotateTransform)return;e=this.fixE(e,t);let i=ge[t];i.obj=r,i.options=r.options[t],i.transform=W();let s=r.frame.toRect();i.originCenter={x:s.left+s.width/2,y:s.top+s.height/2},ge.Transformer.transform=f(r.frame);let n=ge[t].start(e),o=new CustomEvent("TransformStart",{detail:n});i.obj.dispatchEvent(o),this[t+"Transform"]=!0},move(e,t){if(!this[t+"Transform"])return;if("Transform"!=t&&e.touches&&e.touches[0].identifier!=e.changedTouches[0].identifier)return;e=this.fixE(e,t);let r=ge[t],i=r.move(e);if(i){let e=ge.Transformer;e.transform=J(i,e.transform);let t=W(),s=$(-r.originCenter.x,-r.originCenter.y);r.obj.transform&&(t=J(r.obj.transform,t)),t=J(s,t),t=J(i,t),t=J(Q(s),t),r.obj.transform&&(t=J(Q(r.obj.transform),t));let n=new CustomEvent("Transform",{detail:t});r.obj.dispatchEvent(n),r.obj.frame.style.transform=g(e.transform),this.applyUI(r.obj)}},end(e,t,r){if(!this[t+"Transform"])return;if(!r&&"Transform"!=t&&e.touches&&e.touches[0]&&e.touches[0].identifier!=e.changedTouches[0].identifier)return;e=this.fixE(e,t);let i=ge[t],s=i.end(e),n=new CustomEvent("TransformEnd",{detail:s});i.obj.dispatchEvent(n),this[t+"Transform"]=!1},initTransformFrame(e){if(e.frame)return;e.frame=document.createElement("div"),e.frame.style.display=e.style.display,e.frame.style.position="absolute",e.frame.style.left=e.style.left,e.frame.style.top=e.style.top,e.frame.style.width=e.style.width,e.frame.style.height=e.style.height,e.parentNode.insertBefore(e.frame,e),new MutationObserver(t=>{let r={};t.last.oldValue.split("; ").forEach(e=>{let t=e.replace(";","").split(": ");r[t[0]]=t[1]});let i=t.last.target.style.display,s=r.display||"";i!=s&&("none"==s?(e.frame.style.left=e.style.left,e.frame.style.top=e.style.top,e.frame.style.width=e.style.width,e.frame.style.height=e.style.height,e.style.transform&&(e.frame.style.transform=e.style.transform,e.style.transform=""),e.frame.style.visibility="hidden",e.frame.style.display="",ge.applyUI(e),e.frame.style.visibility=""):e.frame.style.display="none")}).observe(e,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})},applyUI(e){let t=e.frame.getTransformStyle(),r=e.frame.getMathStyle("left"),i=e.frame.getMathStyle("top"),s=e.frame.getMathStyle("width"),n=e.frame.getMathStyle("height"),o=r+s/2,a=i+n/2;s*=t.scale.x,n*=t.scale.y,r=o-s/2+t.translate.x,i=a-n/2+t.translate.y,e.style.left=r+"px",e.style.top=i+"px",e.style.width=s+"px",e.style.height=n+"px",0==t.rotate.angle?e.style.transform="":e.style.transform="rotate("+t.rotate.angle+"rad)"},fixE(e,t){if(e.preventDefault(),e.stopPropagation(),"Transform"!=t&&e.changedTouches){let t=e.changedTouches[0];t.currentTarget=t.target,e=t}return e}},me={addTranslate(e,t){ge.add("Translate",e,t)},addScale(e,t){ge.add("Scale",e,t)},addRotate(e,t){ge.add("Rotate",e,t)}};ge.Transformer=me;let ye={init(e,t,r){t.removeEventListener("mousedown",e.start),t.addEventListener("mousedown",e.start),t.removeEventListener("touchstart",e.start),t.addEventListener("touchstart",e.start),r||this.attachOnTransformEvents(e,t.root)},attachOnTransformEvents(e,t){t["on"+e.name+"Start"]=new Function,t["on"+e.name+"End"]=new Function,t["on"+e.name]=new Function},onStart(e){document.addEventListener("mousemove",e.move),document.addEventListener("mouseup",e.end),document.addEventListener("touchmove",e.move),document.addEventListener("touchend",e.end)},onEnd(e){document.removeEventListener("mousemove",e.move),document.removeEventListener("mouseup",e.end),document.removeEventListener("touchmove",e.move),document.removeEventListener("touchend",e.end)},fixE:e=>((e=e||window.event).changedTouches&&(e=e.changedTouches[0]),e)},Ee={name:"Drag",obj:null,init(e,t,r){r||(r={}),r.Axis||(r.Axis="XY"),e.options=r,e.root=t||e,e.hmode=!!r.SwapHorzRef,e.vmode=!!r.SwapVertRef,ye.init(Ee,e)},start(e){e=ye.fixE(e);let t=Ee.obj=this,r=t.root.toRect((t.vmode?"T":"B")+(t.hmode?"L":"R")),i=parseInt(r.x),s=parseInt(r.y);return t.sx=i,t.sy=s,t.lx=e.clientX,t.ly=e.clientY,t.root.onDragStart(i,s,t),ye.onStart(Ee),!1},move(e){e=ye.fixE(e);let t=Ee.obj,r=t.root.toRect((t.vmode?"T":"B")+(t.hmode?"L":"R")),i=parseInt(r.x),s=parseInt(r.y),n=t.options.Axis.contains("X")?i+(e.clientX-t.lx)*(t.hmode?1:-1):t.sx,o=t.options.Axis.contains("Y")?s+(e.clientY-t.ly)*(t.vmode?1:-1):t.sy;return!isNaN(t.options.MinX)&&n<t.options.MinX?n=t.options.MinX:isNaN(t.options.MaxX)||(t.options.MaxPreserveSize&&t.options.MaxX<n+r.offsetWidth?n=t.options.MaxX-r.offsetWidth:n>t.options.MaxX&&(n=t.options.MaxX)),!isNaN(t.options.MinY)&&o<t.options.MinY?o=t.options.MinY:isNaN(t.options.MaxY)||(t.options.MaxPreserveSize&&t.options.MaxY<o+r.offsetHeight?o=t.options.MaxY-r.offsetHeight:o>t.options.MaxY&&(o=t.options.MaxY)),t.options.XMapper?n=t.options.XMapper(s):t.options.YMapper&&(o=t.options.YMapper(i)),n||(n=i),o||(o=s),t.root.style[t.hmode?"left":"right"]=n+"px",t.root.style[t.vmode?"top":"bottom"]=o+"px",t.lx=e.clientX,t.ly=e.clientY,t.root.onDrag(n,o,t),!1},end(){let e=Ee.obj;ye.onEnd(Ee),e.root.onDragEnd(parseInt(e.root.style[e.hmode?"left":"right"]),parseInt(e.root.style[e.vmode?"top":"bottom"]),e),Ee.obj=null}},be={name:"Resize",handle:null,init(e,t){if(e.options)return;t||(t={}),isNaN(t.MinWidth)&&(t.MinWidth=50),isNaN(t.MinHeight)&&(t.MinHeight=50),e.options=t;let r=t.Handles||(t.KeepRatio?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]);for(let t=0;t<r.length;t++){let i=document.createElement("div");i.className="ResizeHandle "+r[t],i.type=r[t],i.root=e,e.appendChild(i),ye.init(be,i,!0)}ye.attachOnTransformEvents(be,e)},start(e){e=ye.fixE(e);let t=be.handle=this,r=this.root,i=r.toRect();return r.sw=i.width,r.sh=i.height,r.sx=i.left,r.sy=i.top,r.lx=e.clientX,r.ly=e.clientY,r.onResizeStart(r.sx,r.sy,r.sw,r.sh,t),ye.onStart(be),!1},move(e){e=ye.fixE(e);let t=be.handle,r=t.root,i=r.toRect(),s=e.clientX-r.lx,n=e.clientY-r.ly,o=i.left,a=i.top,h=i.width,l=i.height;if(t.type.endsWith("L")&&(o+=s,h-=s),t.type.startsWith("T")&&(a+=n,l-=n),t.type.endsWith("R")&&(h+=s),t.type.startsWith("B")&&(l+=n),!isNaN(r.options.MinX)&&o<r.options.MinX?(t.type.endsWith("L")&&(h+=o-r.options.MinX),o=r.options.MinX):!isNaN(r.options.MaxX)&&r.options.MaxX<o+h&&(h=r.options.MaxX-o),!isNaN(r.options.MinY)&&a<r.options.MinY?(t.type.startsWith("T")&&(l+=a-r.options.MinY),a=r.options.MinY):!isNaN(r.options.MaxY)&&r.options.MaxY<a+l&&(l=r.options.MaxY-a),h<r.options.MinWidth?(t.type.endsWith("L")&&(o+=h-r.options.MinWidth),h=r.options.MinWidth):!isNaN(r.options.MaxWidth)&&h>r.options.MaxWidth&&(t.type.endsWith("L")&&(o+=h-r.options.MaxWidth),h=r.options.MaxWidth),l<r.options.MinHeight?(t.type.startsWith("T")&&(a+=l-r.options.MinHeight),l=r.options.MinHeight):r.options.MaxHeight&&l>r.options.MaxHeight&&(t.type.startsWith("T")&&(a+=l-r.options.MaxHeight),l=r.options.MaxHeight),r.options.KeepRatio){let e={x:o,y:a,width:h,height:l};Math.abs(s)>Math.abs(n)?be.keepRatioByWidth(e,h):Math.abs(s)<Math.abs(n)&&be.keepRatioByHeight(e,l),o=e.x,a=e.y,h=e.width,l=e.height}return r.style.left=o+"px",r.style.top=a+"px",r.style.width=h+"px",r.style.height=l+"px",r.onResize(o,a,h,l,t),r.lx=e.clientX,r.ly=e.clientY,!1},end(){let e=be.handle,t=e.root;ye.onEnd(be);let r=t.toRect();t.onResizeEnd(r.left,r.top,r.width,r.height,e),be.handle=null},keepRatioByWidth(e,t,r){let i=be.handle,s=i.root,n=t/s.sw*s.sh,o=e.y;r||(n<s.options.MinHeight?(n=s.options.MinHeight,be.keepRatioByHeight(e,n,!0)):n>s.options.MaxHeight&&(n=s.options.MaxHeight,be.keepRatioByHeight(e,n,!0))),i.type.startsWith("T")&&(o-=n-e.height,!r&&!isNaN(s.options.MinY)&&o<s.options.MinY&&(n+=o-s.options.MinY,o=s.options.MinY,be.keepRatioByHeight(e,n,!0))),!r&&!isNaN(s.options.MaxY)&&s.options.MaxY<o+n&&(n=s.options.MaxY-o,be.keepRatioByHeight(e,n,!0)),e.y=o,e.height=n},keepRatioByHeight(e,t,r){let i=be.handle,s=i.root,n=t/s.sh*s.sw,o=e.x;r||(n<s.options.MinWidth?(n=s.options.MinWidth,be.keepRatioByWidth(e,n,!0)):n>s.options.MaxWidth&&(n=s.options.MaxWidth,be.keepRatioByWidth(e,n,!0))),i.type.endsWith("L")&&(o-=n-e.width,!r&&!isNaN(s.options.MinX)&&o<s.options.MinX&&(n+=o-s.options.MinX,o=s.options.MinX,be.keepRatioByWidth(e,n,!0))),!r&&!isNaN(s.options.MaxX)&&s.options.MaxX<o+n&&(n=s.options.MaxX-o,be.keepRatioByWidth(e,n,!0)),e.x=o,e.width=n}};const xe=96/("undefined"==typeof window?1:window.devicePixelRatio),Pe={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*xe},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*xe},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*xe},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*xe},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*xe},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*xe},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*xe},DIP:{METER:.0254/xe,CENTIMETER:2.54/xe,MILLIMETER:25.4/xe,MICROMETER:25400/xe,INCH:1/xe,POINT:72/xe,PICA:6/xe,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Function.createEnum.call(Pe,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Function.createEnum.call(Pe,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);const we=Object.freeze({LENGTH:Pe.Unit.METER,TIME:Pe.Unit.SECOND,FORCE:Pe.Unit.NEWTON,ANGLE:Pe.Unit.RADIAN,NORMALIZED:Pe.Unit.NORMALIZED,LOGICAL:Pe.Unit.LOGICAL});Pe.getChannelResolution=function(e,t=1){let r=1,i=Pe.getUnitMetric(e);return i!=Pe.Metric.NORMALIZED&&i!=Pe.Metric.LOGICAL&&(r=Pe[we[i.name].name][e.name]/t),r},Pe.convert=function(e,t,r,i){return t?r*Pe[we[e.name].name][i.name]/t:r},Pe.convertAny=function(e,t,r,i){return e*Pe[t.name][r.name]/i},Pe.getUnitMetric=function(e){switch(e){case Pe.Unit.METER:case Pe.Unit.CENTIMETER:case Pe.Unit.MILLIMETER:case Pe.Unit.MICROMETER:case Pe.Unit.INCH:case Pe.Unit.POINT:case Pe.Unit.PICA:case Pe.Unit.DIP:return Pe.Metric.LENGTH;case Pe.Unit.SECOND:case Pe.Unit.MILLISECOND:case Pe.Unit.MICROSECOND:case Pe.Unit.NANOSECOND:return Pe.Metric.TIME;case Pe.Unit.RADIAN:case Pe.Unit.DEGREE:return Pe.Metric.ANGLE;case Pe.Unit.NEWTON:return Pe.Metric.FORCE;case Pe.Unit.NORMALIZED:return Pe.Metric.NORMALIZED;case Pe.Unit.LOGICAL:return Pe.Metric.LOGICAL;default:throw console.warn(e),new Error("Invalid unit found")}},Pe.getUnit=function(e){return we[e.name]},Pe.convertValue=function(e,t,r){return e*Pe[t.name][r.name]},Object.freeze(Pe);let Te={};ENVIRONMENT==EnvironmentType.NODE&&(Te=require("systeminformation"));var Re=Te;let Ie;Ie=ENVIRONMENT==EnvironmentType.NODE?require("js-md5"):md5;var ve=Ie;let Se;Se=ENVIRONMENT==EnvironmentType.NODE?require("long"):Long;var Ae=Se;let Ce={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate(){let e=Date.now();return this.mask.replace(/[xy]/g,(function(t){let r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)}))},fromString(e){return this.fromBytes(new Uint8Array(ve.arrayBuffer(e)))},toBytes(e){let t=[];return e.split("-").map((e,r)=>{(r<3?e.match(/.{1,2}/g).reverse():e.match(/.{1,2}/g)).map(e=>t.push(parseInt(e,16)))}),new Uint8Array(t)},fromBytes(e){let t=Array.from(e).map(e=>e.toString(16)).map(e=>(1==e.length?"0":"")+e);return t.slice(0,4).reverse().join("")+"-"+t.slice(4,6).reverse().join("")+"-"+t.slice(6,8).reverse().join("")+"-"+t.slice(8,10).join("")+"-"+t.slice(10).join("")},toUint32Array(e){let t=new Uint32Array(4),r=this.toBytes(e);return t[0]=new Uint32Array(r.slice(0,4).buffer)[0],t[1]=new Uint32Array(r.slice(4,8).buffer)[0],t[2]=new Uint32Array(r.slice(8,12).buffer)[0],t[3]=new Uint32Array(r.slice(12).buffer)[0],t},fromUint32Array(e){return this.fromBytes(new Uint8Array(e.buffer))},toUint64Array(e){let t=new BigUint64Array(2),r=this.toBytes(e);return t[0]=new BigUint64Array(r.slice(0,8).buffer)[0],t[1]=new BigUint64Array(r.slice(8).buffer)[0],t},fromUint64Array(e){return this.fromBytes(new Uint8Array(e.buffer))},toLongArray(e){let t=new Array(2),r=this.toBytes(e);return t[0]=Ae.fromBytes(r.slice(0,8)),t[1]=Ae.fromBytes(r.slice(8)),t},fromLongArray(e){let t=e[0].toBytes().concat(e[1].toBytes());return this.fromBytes(t)}};class Oe{static get SEPARATOR(){return"\n"}constructor(e){Object.defineProperty(this,"id",{get:function(){return e||(e=this.resolveID()),e},set:function(t){let r=e;e=t,this.updateID(r,e)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:()=>"function"==typeof this.getMD5Message?Oe.Algorithm.MD5:Oe.Algorithm.GUID,enumerable:!0})}resolveID(){if(this.algorithm==Oe.Algorithm.MD5){let e="",t=this.getMD5Message();for(let r of t){if(Array.isArray(r))for(let t of r)e+=t,e+="\n";else e+=r;e+="\n"}if(!e)throw new Error("Empty MD5 message container found");return ve(e)}return Ce.generate()}updateID(e,t){}invalidateID(){this.id=void 0}static getMD5Tokens(e){let t=[];return Object.keys(e).sort().forEach(r=>t.push(r,e[r])),t}}Oe.createEnum("Algorithm",["GUID","MD5"]);class Me extends Oe{constructor(){super(),this.props={}}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",Oe.getMD5Tokens(this.props)]}static async createInstance(e={}){let t=new Me;if(t.props["env.name"]=ENVIRONMENT.name,ENVIRONMENT==EnvironmentType.WEB||ENVIRONMENT==EnvironmentType.WORKER)t.props["user.agent"]=navigator.userAgent;else{if(ENVIRONMENT!=EnvironmentType.NODE)throw new Error(`Environment.createDefaultInstance is not supported under ${ENVIRONMENT.name} environment`);await Re.osInfo().then(e=>{t.props["os.id"]=e.serial.toLowerCase(),t.props["os.name"]=e.codename,t.props["os.version"]=e.release,t.props["os.build"]=e.build,t.props["os.platform"]=`${e.distro} (${e.platform} ${e.arch})`})}return Object.keys(e).forEach(r=>t.props[r]=e[r]),t}}class De extends Oe{constructor(e,t={}){super(),this.type=e,this.props=Object.assign({},t)}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,Oe.getMD5Tokens(this.props)]}}De.createEnum("Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);class Ne extends Oe{constructor(e,t,r,i,s){if(super(),t==Ne.Metric.DIMENSIONLESS)r=1;else if(isNaN(r)){let e=Pe.getUnit(t);r=Pe.getChannelResolution(e)}this.type=e,this.metric=t,this.resolution=r,this.min=i,this.max=s,e==Ne.Type.TIMESTAMP?this.precision=0:this.precision=2,Object.defineProperty(this,"name",{get:function(){return re.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}})}getMD5Message(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");let e=[];return e.push("SensorChannel"),e.push(this.context.inkProvider?this.context.inkProvider.id:""),e.push(this.context.device.id),e.push(this.type),e.push(this.metric.name),e.push(this.resolution.toFixed(4)),e.push((this.min||0).toFixed(4)),e.push((this.max||0).toFixed(4)),e.push(this.precision.toString()),e}static createCustomChannel(e,t,r,i,s,n){let o=new Ne(e,r,i,s,n);return o.precision=t,o}static createDefaultInstance(e,t){let r,i,s;switch(e){case Ne.Type.X:case Ne.Type.Y:case Ne.Type.Z:case Ne.Type.RADIUS_X:case Ne.Type.RADIUS_Y:r=Pe.Unit.DIP;break;case Ne.Type.TIMESTAMP:r=Pe.Unit.MILLISECOND;break;case Ne.Type.PRESSURE:r=Pe.Unit.NORMALIZED,i=0,s=1;break;case Ne.Type.ALTITUDE:case Ne.Type.AZIMUTH:case Ne.Type.ROTATION:r=Pe.Unit.RADIAN,i=0,s=2*Math.PI;break;default:console.error(`SensorChannel: createDefaultInstance fails with ${e} type`)}let n=Pe.getChannelResolution(r),o=Pe.getUnitMetric(r),a=new Ne(e,o,n,i,s);return a.unit=r,e!=Ne.Type.X&&e!=Ne.Type.Y||t.type!=De.Type.MOUSE||(a.precision=0),a}}Ne.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),Ne.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},Ne.Metric=Pe.Metric;class Le extends Oe{constructor(e,t){super(),this.device=e.freeze(),this.inkProvider=Object.freeze(t);let r,i,s=[];Object.defineProperty(this,"channels",{get:function(){return s},set:function(e){this.invalidateID(),s=[],e.forEach(e=>this.add(e))},enumerable:!0}),Object.defineProperty(this,"layout",{get:function(){return s.map(e=>e.name)},set:function(e){this.invalidateID(),s=s.filter(t=>e.includes(t.name))},enumerable:!0}),Object.defineProperty(this,"samplingRate",{get:function(){return r},set:function(e){this.invalidateID(),r=e},enumerable:!0}),Object.defineProperty(this,"latency",{get:function(){return i},set:function(e){this.invalidateID(),i=e},enumerable:!0})}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");let e=["SensorChannelsContext",...this.channels.map(e=>e.id)];return e.push(this.samplingRate||""),e.push(this.latency||""),e.push(this.inkProvider?this.inkProvider.id:""),e.push(this.device.id),e}add(e){if((e.type==Ne.Type.X||e.type==Ne.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");e.context=this,Object.freeze(e),this.channels.push(e)}get(e){return this.channels.filter(t=>t.id==e).first}static createDefaultInstance(e,t){let r=new Le(e,t);return r.channels=Ne.defaults[t.type.name].map(e=>Ne.createDefaultInstance(Ne.Type[e],t)),r}}class ke extends Oe{constructor(){super();let e=[];Object.defineProperty(this,"channelsContexts",{get:function(){return e},set:function(t){this.invalidateID(),e=t},enumerable:!0})}getMD5Message(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext",...this.channelsContexts.map(e=>e.id)]}addContext(e){if(!this.channelsContexts.includes(e)){if(this.channelsContexts.filter(t=>t.device==e.device).length>0)throw new Error(`Already exists channelsContext with device ${e.device.id}. Device should be unique in scope of SensorContext.`);e.inkProvider&&(this.inkChannelsContext=e),Object.freeze(e),this.channelsContexts.push(e)}}getContext(e){return this.channelsContexts.filter(t=>t.id==e).first}getContextByChannelID(e){return this.channelsContexts.filter(t=>t.get(e)).first}static createDefaultInstance(e,t){let r=new ke;return r.addContext(Le.createDefaultInstance(e,t)),r}}class Be extends Oe{constructor(e,t){super(),this.environment=Object.freeze(e),this.sensorContext=Object.freeze(t)}getMD5Message(){return["InputContext",this.environment.id,this.sensorContext.id]}addChannelsContext(e){this.sensorContext.addContext(e)}static createDefaultInstance(e,t,r){let i=ke.createDefaultInstance(t,r);return new Be(e,i)}}class _e extends Oe{constructor(e){super(),this.created=Date.now(),this.inkState=_e.InkState.PLANE,this.context=e,this.streams=[]}add(e){if(!this.context.sensorContext.getContextByChannelID(e.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");e.ink&&(this.inkStream=e),this.streams.push(e)}}_e.createEnum("InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);class Fe{constructor(e){this.channels=e,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:e.map(e=>e.name),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}add(e,t){t&&this.ignoredIndex.push(this.length),this.channels.forEach(t=>{let r=re.getPropName(t.name),i=e[r];if(t.type==Ne.Type.ALTITUDE&&!("altitude"in e))throw new Error("SensorStream input data do not provides altitude");if(t.type==Ne.Type.AZIMUTH&&!("azimuth"in e))throw new Error("SensorStream input data do not provides azimuth");this.data.push(i)})}get(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t={};for(let r=0;r<this.stride;r++){let i=this.channels[r],s=re.getPropName(i.name),n=e*this.stride;"force"==s?(t.pressure=this.data[n+r],Object.defineProperty(t,"force",{value:this.pressure,enumerable:!0})):t[s]=this.data[n+r]}return t}getPipelineMapping(){let e=[];if(this.ignoredIndex.length>0)for(let t=0;t<this.length;t++)this.ignoredIndex.includes(t)||e.push(t);return e}}class Ue extends Oe{constructor(){super(),this.props={},this.devices=[]}freeze(){return Object.freeze(this.props),this}getMD5Message(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",Oe.getMD5Tokens(this.props)]}link(e){this.devices.push(e)}getInkInputProvider(e){return new De(e)}getInkSensorContext(e){let t=this.getInkInputProvider(e);return ke.createDefaultInstance(this,t)}openStream(e){if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");let t=De.Type[e.pointer.type.toUpperCase()],r=this.getInkSensorContext(t),i=new Be(this.environment,r);r.inkChannelsContext.layout=Ue.getLayout(e),this.sensorData=new _e(i),this.sensorData.add(new Fe(r.inkChannelsContext.channels)),this.sampleTimestamp=e.timestamp,this.devices.forEach(e=>e.openStream(this.sensorData))}add(e,t){if(!this.sensorData)throw new Error("Open ink stream not found");this.sensorData.inkStream.add(Object.assign({},e,{timestamp:e.timestamp-this.sampleTimestamp}),t)}closeStream(e){let t=this.sensorData;return this.devices.forEach(t=>t.closeStream(e)),this.sensorData=null,this.sampleTimestamp=0,e?null:t}static getLayout(e){let t=[];return Object.keys(Ne.Type).forEach(r=>{let i,s=Ne.Type[r];i=s==Ne.Type.ALTITUDE?"tiltX":s==Ne.Type.AZIMUTH?"tiltY":re.getPropName(r),isFinite(e[i])&&t.push(r)}),t}static async createInstance(e){let t=new this(...Array.from(arguments).slice(1));if(ENVIRONMENT==EnvironmentType.WEB)t.props["dev.graphics.resolution"]=`${screen.width}x${screen.height}`;else if(ENVIRONMENT==EnvironmentType.NODE)await Re.system().then(e=>(t.props["dev.id"]=e.uuid.toLowerCase(),t.props["dev.manufacturer"]=e.manufacturer,t.props["dev.model"]=e.model,Re.cpu())).then(e=>(t.props["dev.cpu"]=`${e.manufacturer} ${e.brand} ${e.speed} - ${e.cores} core(s)`,Re.graphics())).then(e=>{let r=e.displays.filter(e=>e.main)[0],i=e.controllers[0];return t.props["dev.graphics.display"]=`${r.model} ${r.currentResX}x${r.currentResY} (${r.pixeldepth} bit)`,t.props["dev.graphics.adapter"]=`${i.model} ${i.vram} GB`,Re.osInfo()});else if(ENVIRONMENT==EnvironmentType.WORKER)throw new Error(`InputDevice.createDefaultInstance is not supported under ${ENVIRONMENT.name} environment`);return t.environment=await Me.createInstance(e),t}}class je{constructor(e){let t;this.phase=e.phase,Object.defineProperty(this,"x",{value:e.x,enumerable:!0}),Object.defineProperty(this,"y",{value:e.y,enumerable:!0}),Object.defineProperty(this,"z",{value:e.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:e.timestamp,enumerable:!0}),Object.defineProperty(this,"force",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:e.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:e.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:e.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:e.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:()=>(t||(t=this.computeTilt(e.tiltX,e.tiltY)||{}),t.altitude),enumerable:!0}),Object.defineProperty(this,"azimuth",{get:()=>(t||(t=this.computeTilt(e.tiltX,e.tiltY)||{}),t.azimuth),enumerable:!0}),e.pointer&&Object.defineProperty(this,"pointer",{value:e.pointer,enumerable:!0}),this.computedAzimuth=void 0}createPathPoint(){return new x(this.x,this.y,this.z)}computeTilt(e,t){if(!isFinite(e)||!isFinite(t))return;let r=Math.tan(Math.toRadians(e)),i=Math.tan(Math.toRadians(t)),s=Math.sqrt(r*r+i*i);return{altitude:Math.atan2(1,s),azimuth:Math.atan2(i,r)}}speed(e,t){let r={x:0,y:0,time:0};if(r=e&&!t?this.minus(e):t&&!e?t.minus(this):t.minus(e),r.time>0)return je.getMagnitude(r.x,r.y)/(r.time/1e3);if(0==r.time)return 0;throw new Error("Out of range "+r.time)}static getMagnitude(e,t){return Math.sqrt(e*e+t*t)}computeNearestAzimuthAngle(e){let t;if(isNaN(this.azimuth))return 0;if(e){if(isNaN(e.azimuth))return 0;let r=2*Math.PI,i=e.computedAzimuth||e.azimuth,s=parseInt(i/r);t=this.azimuth+s*r;let n=t-i;n>=Math.PI?t-=r:n<-Math.PI&&(t+=r)}else t=this.azimuth;return this.computedAzimuth=t,t}minus(e){return{x:this.x-e.x,y:this.y-e.y,time:this.timestamp-e.timestamp}}}je.createEnum("Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);class Ge{static createCircle(e=20,t=1,r={x:0,y:0}){return Ge.createEllipse(e,t,t,r)}static createEllipse(e=20,t=1,r=.5,i={x:0,y:0}){let s=[],n=2*Math.PI/e;for(let o=0;o<e;o++){let e=o*n,a=t*Math.cos(e),h=r*Math.sin(e);s.push(i.x+a,i.y+h)}return s.toFloat32Array()}static createStar(e=5,t=.5){let r=[],i=2*Math.PI/e;for(let s=0;s<e;s++){let e=s*i,n=1*Math.cos(e),o=1*Math.sin(e),a=t*Math.cos(e+i/2),h=t*Math.sin(e+i/2);r.push(n,o,a,h)}return r.toFloat32Array()}}class Ye{static encode(e,t=Ye.Encoding.AUTO){let r;if(t==Ye.Encoding.AUTO&&(t="undefined"==typeof Buffer?Ye.Encoding.ARRAY:Ye.Encoding.BUFFER),t==Ye.Encoding.NONE)r=e;else if(t==Ye.Encoding.ARRAY)r=e.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");let i=Buffer.from(e.buffer);switch(t){case Ye.Encoding.BUFFER:r=i.toJSON();break;case Ye.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: "+t.name)}}return{encoding:t.name,type:e.constructor.name,points:r}}static decode(e){let t,r=Ye.Encoding[e.encoding];if(r==Ye.Encoding.NONE)t=e.points;else if(r==Ye.Encoding.ARRAY)t=e.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");let i;switch(r){case Ye.Encoding.BUFFER:i=Buffer.from(e.points);break;case Ye.Encoding.BASE64:i=Buffer.from(e.points,"base64");break;default:throw new Error("Invalid encoding provided: "+r.name)}let s=new Uint8Array(i);t=new globalThis[e.type](s.buffer)}return t}static isTypedArrayData(e){return e&&e.encoding&&e.type&&e.type.endsWith("Array")}}Ye.createEnum("Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);class Xe{constructor(e,t){this.name=e,Object.defineProperty(this,"value",{get:function(){if(!t){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(t=this.resolve(this.name)),!t){if(!s.instance)throw new Error(`Resource URI ${this.name} cannot be resolved. URIResolver not implemented yet. Please implement and instantiate.`);t=s.instance.resolve(this.name)}if(!t)throw new Error(`Resource URI ${this.name} cannot be resolved. Please provide resource definition in URIResolver init implementation.`)}return t},set:function(e){t=e},enumerable:!0})}toJSON(){let e=this.value;return ArrayBuffer.isTypedArray(e)?e=Ye.encode(e,this.encoding):"function"==typeof e&&(e=e()),{name:this.name,value:e}}static fromJSON(e){let t=e.value;return Ye.isTypedArrayData(t)&&(t=Ye.decode(t)),new Xe(e.name,t)}static getInstance(e,t){return new Xe(t,e)}}class ze{constructor(e,t=0){this.size=t,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return e||("function"==typeof(e=this.descriptor.shape.value)&&(e=e()),ze.fitShape(e)),e},set:function(t){if(!t)throw new Error("BrushPrototype: shape not found");Array.isArray(t)&&(t=t.toFloat32Array()),"string"==typeof t?t=new Xe(t):t instanceof Float32Array?t=Xe.getInstance(t):t instanceof Xe||(t=new Xe(t.name,t.value)),e=null,this.descriptor.shape=t,this.descriptor.shape.resolve=ze.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:()=>this.encoding,enumerable:!0})},enumerable:!0}),this.shape=e}toJSON(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}static fromJSON(e){let t=Xe.fromJSON(e.shape);return new ze(t,e.size)}static create(e,t=0,...r){let i,s=e;switch(e){case ze.Type.CIRCLE:i=Ge.createCircle(...r),s+=`?precision=${r[0]||""}&radius=${r[1]||""}`;break;case ze.Type.ELLIPSE:i=Ge.createEllipse(...r),s+=`?precision=${r[0]||""}&radiusX=${r[1]||""}&radiusY=${r[2]||""}`;break;case ze.Type.STAR:i=Ge.createStar(...r),s+=`?points=${r[0]||""}&internalRadius=${r[1]||""}`;break;default:console.error(`Brush2D: createShape fails with ${e} type`)}return new ze({name:s,shape:i},t)}static resolve(e){let t,r=e.split("?"),i=r.first;if(Object.values(ze.Type).includes(i)){let e=r.last.split("&"),s={};switch(e.forEach(e=>{s[e.substring(0,e.indexOf("="))]=e.substring(e.indexOf("=")+1)}),i){case ze.Type.CIRCLE:{let e=s.precision?parseInt(s.precision):void 0;t=Ge.createCircle(e);break}case ze.Type.ELLIPSE:{let e=s.precision?parseInt(s.precision):void 0,r=s.radiusX?parseFloat(s.radiusX):void 0,i=s.radiusY?parseFloat(s.radiusY):void 0;t=Ge.createEllipse(e,r,i);break}case ze.Type.STAR:{let e=s.points?parseInt(s.points):void 0,r=s.internalRadius?parseFloat(s.internalRadius):void 0;t=Ge.createStar(e,r);break}default:console.error(`Brush2D: createShape fails with ${i} type`)}}return t}static fitShape(e){ze.centerShape(e);let t=new I(-1,-1,1,1),r=I.ofPolygon(e),i=t.width/r.width,s=t.height/r.height,n=i>0&&s>0?Math.min(i,s):Math.max(i,s);for(let t=0;t<e.length;t+=2)e[t]*=n,e[t+1]*=n}static centerShape(e){let t=I.ofPolygon(e);for(let r=0;r<e.length;r+=2)e[r]-=t.center.x,e[r+1]-=t.center.y}}ze.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};class Ve{constructor(e,t,r,i=1){isFinite(r)&&(i=r,r=void 0),i<=0&&(console.warn(`Invalid spacing found ${i}. It should be positive number.`),i=1),this.name=e,Object.defineProperty(this,"shape",{get:function(){return t},set:function(e){if(e instanceof Float32Array&&(e=new ze(e)),!this.validate(e))throw console.warn(e),new Error("Brush2D: Invalid shape found");Array.isArray(e)&&(1==e.length?e=e.first:e.sort(re.comparator({sortBy:"size",sortOrder:"asc"}))),t=e},enumerable:!0}),this.shape=t,this.fill=r,this.spacing=i,Object.defineProperty(this,"encoding",{get:function(){},set:function(e){if(Array.isArray(this.shape))for(let t of this.shape)t.encoding=e;else this.shape.encoding=e},enumerable:!0})}validate(e){let t=!1;if(Array.isArray(e)){for(let r of e)if(t=r instanceof ze,!t)break}else t=e instanceof ze;return t}async configure(e){if(this.pattern||!this.fill)return;if(!(e instanceof CanvasRenderingContext2D||e instanceof OffscreenCanvasRenderingContext2D))throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");let t=await B(this.fill);this.pattern=e.createPattern(t,"repeat")}selectShape(e){let t;if(Array.isArray(this.shape)){for(let r=1;r<this.shape.length;r++)if(this.shape[r].size>e){t=this.shape[r-1];break}t||(t=this.shape.last)}else t=this.shape;return t.shape}toJSON(){let e=Array.isArray(this.shape)?this.shape:[this.shape];return{type:this.constructor.name,name:this.name,spacing:this.spacing,shape:e.map(e=>e.toJSON())}}static fromJSON(e){let t=1==e.shape.length?ze.fromJSON(e.shape[0]):e.shape.map(e=>ze.fromJSON(e));return new Ve(e.name,t,e.spacing)}}class He{static get excludedProps(){return[x.Property.D_X,x.Property.D_Y]}static get posProps(){return[x.Property.X,x.Property.Y,x.Property.Z]}static get colorProps(){return[x.Property.RED,x.Property.GREEN,x.Property.BLUE,x.Property.ALPHA]}static get transformProps(){return[x.Property.ROTATION,x.Property.SCALE_X,x.Property.SCALE_Y,x.Property.SCALE_Z,x.Property.OFFSET_X,x.Property.OFFSET_Y,x.Property.OFFSET_Z]}constructor(){this.state={}}isLayoutPart(e){if(He.posProps.includes(e))return this.inputLayout.includes(e.name);if(this.brush instanceof Ve&&He.colorProps.includes(e))return!1;if(He.excludedProps.includes(e))return!1;if(this.basicMode&&He.transformProps.includes(e))return!1;let t=!1,r=re.getPropName(e.name),i=this.dynamics[r];if(i&&!i.disabled)if(i.dependencies){let e=this.inputLayout.map(e=>Ne.Type[e]);t=i.dependencies.filter(t=>e.includes(t)).length>0}else t=!0;return t}calculate(e,t,r){this.point=t.createPathPoint();for(let e in this.statics)this.point[e]=this.statics[e];return this.calculateProperty(x.Property.SIZE,e,t,r),He.colorProps.forEach(i=>this.calculateProperty(i,e,t,r)),He.transformProps.forEach(i=>this.calculateTransform(i,e,t,r)),this.point}calculateProperty(e,t,r,i){if(!this.layout.includes(e))return;let s,n=re.getPropName(e.name),o=this.dynamics[n],a=this.state[n];if("function"==typeof a.resolve)s=a.resolve(t,r,i);else if(isFinite(r.pressure)||t&&isFinite(t.pressure)){let e=r.pressure||t.pressure/2;s=He.mapTo(e,a.pressure,o.value)}else{let e=r.speed(t,i);s=He.mapTo(e,a.velocity,o.value)}this.point[re.getPropName(e.name)]=s}calculateTransform(e,t,r,i){if(!this.layout.includes(e))return;let s,n=re.getPropName(e.name),o=this.dynamics[n],a=this.state[n];if("function"==typeof a.resolve)s=a.resolve(t,r,i);else if(o.dependencies)if(e==x.Property.ROTATION)isFinite(r.rotation)?s=r.rotation:isFinite(r.azimuth)&&(s=r.computeNearestAzimuthAngle(t));else if(o.dependencies.includes(Ne.Type.ALTITUDE)&&isFinite(r.altitude)){r.cosAltitude||(r.cosAltitude=Math.cos(r.altitude));let e=r.cosAltitude;s=He.mapTo(e,a.altitude,o.value)}else if((e==x.Property.SCALE_X||e==x.Property.SCALE_Y)&&(o.dependencies.includes(Ne.Type.RADIUS_X)||o.dependencies.includes(Ne.Type.RADIUS_Y)))if(isFinite(r.radiusX)&&isFinite(r.radiusY)){let t=e==x.Property.SCALE_X?"radiusX":"radiusY",i=r[t];s=He.mapTo(i,a[t],o.value)}else s=1;if(!isFinite(s))throw new Error(`Property ${e.name} has no value`);this.point[re.getPropName(e.name)]=s}reset(e,t,r,i={},s={}){if(this.brush=t,this.dynamics=i,this.statics={},this.color={},this.inputLayout=Ue.getLayout(e),this.layout=x.Property.values.filter(e=>this.isLayoutPart(e)),"size"in s){if(this.isLayoutPart(x.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=s.size}else if(!this.isLayoutPart(x.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");He.colorProps.forEach(e=>{let t=re.getPropName(e.name);this.isLayoutPart(e)?this.color[t]=r[t]:(this.statics[t]=isFinite(s[t])?s[t]:r[t],this.color[t]=this.statics[t])}),n.init(this.color),He.transformProps.forEach(e=>{if(this.isLayoutPart(e))return;let t=re.getPropName(e.name);isFinite(s[t])&&(this.statics[t]=s[t])}),this.resetState()}resetState(){this.state={},[x.Property.SIZE].concat(He.colorProps).forEach(e=>{if(!this.layout.includes(e))return;let t=re.getPropName(e.name),r=this.dynamics[t],i={};if(r.resolve)i.resolve=He.resolveAction(r.resolve);else{if(!r.value)throw new Error(`PathPointContext: dynamics ${t} value property not found`);let e=Object.clone(r.velocity)||{min:0,max:4e3};e.remap=He.resolveAction(e.remap||r.value.remap);let s=Object.clone(r.pressure)||{min:0,max:1};s.remap=He.resolveAction(s.remap||r.value.remap),i.velocity=He.validateRange(t,e,{min:0,max:3e4}),i.pressure=He.validateRange(t,s,{min:0,max:1})}this.state[t]=i}),He.transformProps.forEach(e=>{if(!this.layout.includes(e))return;let t=re.getPropName(e.name),r=this.dynamics[t],i={};if(r.resolve)i.resolve=He.resolveAction(r.resolve);else if(r.dependencies){if(r.dependencies.includes(Ne.Type.ALTITUDE)){if(!r.value)throw new Error(`PathPointContext: dynamics ${t} value property not found`);let e=Object.clone(r.altitude)||{min:0,max:Math.PI/2};e.remap=He.resolveAction(e.remap||r.value.remap),i.altitude=He.validateRange(t,e,{min:0,max:Math.PI/2})}if(e==x.Property.SCALE_X&&r.dependencies.includes(Ne.Type.RADIUS_X)||e==x.Property.SCALE_Y&&r.dependencies.includes(Ne.Type.RADIUS_Y)){if(!r.value)throw new Error(`PathPointContext: dynamics ${t} value property not found`);let s=e==x.Property.SCALE_X?"radiusX":"radiusY",n=Object.clone(r[s])||{min:0,max:50};n.remap=He.resolveAction(n.remap||r.value.remap),i[s]=He.validateRange(t,n,{min:0,max:50})}}this.state[t]=i})}static resolveAction(e){if(e)return"string"==typeof e?e=new Xe(e):"function"==typeof e?e=Xe.getInstance(e):e instanceof Xe||(e=new Xe(e.name,e.value)),e.value}static validateRange(e,t,r){if(t.min<r.min||t.max>r.max)throw new Error(`${e} config is out of range - (${t.min}, ${t.max}), expected values interval - (${r.min}, ${r.max})`);if(t.min>t.max)throw new Error(`${e} min ${t.min} exceeds max ${t.max}`);return t}static mapTo(e,t,r){let i=(re.clamp(e,t)-t.min)/(t.max-t.min);return t.remap&&(i=t.remap(i)),r.min+i*(r.max-r.min)}}class We{constructor(){this.path=[],this.phase=We.Phase.END;let e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),We.OutputType.ALL_DATA)},enumerable:!0})}add(e,t,r){if(!this.move(e))throw new Error(`Cannot move from phase ${this.phase.name} to phase ${e.name}`);let i=this.addImpl(t,r);return this.keepAllData&&this.path.push(...i.added),{added:this.getOutput(i.added,We.OutputType.ADDITION),predicted:this.getOutput(i.predicted,We.OutputType.PREDICTION)}}addImpl(e,t){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}getOutput(e,t){return e}move(e){return(this.phase!=We.Phase.END||e==We.Phase.BEGIN)&&((this.phase!=We.Phase.BEGIN||e==We.Phase.UPDATE||e==We.Phase.END)&&((this.phase!=We.Phase.UPDATE||e==We.Phase.UPDATE||e==We.Phase.END)&&(e==We.Phase.BEGIN&&this.reset(),this.phase=e,!0)))}reset(){this.path.clear(),this.phase=We.Phase.END}}We.createEnum("Phase",["BEGIN","UPDATE","END"]),We.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA"]);class $e{constructor(){this.reset()}add(e,t,r){e==We.Phase.BEGIN?this.reset(!0):e==We.Phase.END&&(this.last=!0),t&&this.accumulatedAddition.push(...t),r&&(this.lastPrediction=r)}reset(e=!1){this.first=e,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}class Ze{constructor(e,t,r={},i=0,s=1){Array.isArray(t)&&(t=t.toFloat32Array()),Object.defineProperty(this,"layout",{value:e,enumerable:!0}),Object.defineProperty(this,"points",{get:()=>t,enumerable:!0}),Object.defineProperty(this,"stride",{value:e.length,enumerable:!0}),Object.defineProperty(this,"length",{value:t.length/e.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:r,enumerable:!0}),this.ts=i,this.tf=s,this.restoreBuffer=e=>t=new Float32Array(e),Object.defineProperty(this,"color",{get:function(){let{red:e,green:t,blue:r,alpha:i}=this.pointProps;return isFinite(e)&&isFinite(t)&&isFinite(r)?n.from(e,t,r,i):void 0},set:function(e){e?(r.red=e.red,r.green=e.green,r.blue=e.blue,r.alpha=e.alpha):(r.red=void 0,r.green=void 0,r.blue=void 0,r.alpha=void 0)},enumerable:!0}),Object.defineProperty(this,"size",{get:function(){return r.size},set:function(e){r.size=e},enumerable:!0}),this.validate()}validate(){if(!this.layout.includes(x.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(x.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(x.Property.SIZE)&&isNaN(this.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}validateSegmentsCount(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}clone(){return new Ze(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}getPoint(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t=x.createInstance(this.pointProps);return t.fill(this.layout,this.points,e),this.transform&&t.transform(this.transform),t}getPath(){let e=[],t=this.layout.indexOf(x.Property.X),r=this.layout.indexOf(x.Property.Y);for(let i=0;i<this.length;i++)e.push(this.points[i*this.stride+t],this.points[i*this.stride+r]);return e}slice(e,t,r,i){if(e<0||e>this.length-4)throw new Error(`Invalid fromIndex ${e} found. Ensure that fromIndex range is {0, ${this.length-4}}.`);if(t<1||t+1>this.length)throw new Error(`Invalid toIndex ${t} found. Ensure that fromIndex range is {1, ${this.length}}.`);if(t+1-e<4)throw new Error(`Invalid range {${e}, ${t}} found. At least 4 points are needed to define spline.`);let s=this.points.slice(e*this.stride,(t+1)*this.stride),n=new Ze(this.layout.slice(),s,Object.clone(this.pointProps),r,i);return n.randomSeed=this.randomSeed,n}toJSON(){return{layout:this.layout.map(e=>e.name),points:Ye.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}static fromJSON(e){let t=Ye.decode(e.points),r=new Ze(e.layout.map(e=>x.Property[e]),t,e.pointProps,e.ts,e.tf);return r.randomSeed=e.randomSeed,r}static createRect(e,t,r){let i=e.toPath(t,r);return new Ze(i.layout,i.points,{size:i.size,red:t.red,green:t.green,blue:t.blue,alpha:t.alpha})}}class qe extends Ze{get slice(){}constructor(e,t,r,i=[]){super(e,t,r),Object.defineProperty(this,"tValues",{value:Object.freeze(i),enumerable:!0}),Object.defineProperty(this,"ts",{get:function(){return i.first},enumerable:!0}),Object.defineProperty(this,"tf",{get:function(){return i.last},enumerable:!0}),delete this.segmentsCount}validateSegmentsCount(){}getPointT(e){return this.tValues[e]}getBounds(e){return I.ofSpline(this,e)}toJSON(){return{layout:this.layout.map(e=>e.name),points:Ye.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}static fromJSON(e){let t=Ye.decode(e.points);return new qe(e.layout.map(e=>x.Property[e]),t,e.pointProps,e.tValues)}}let Ke={stride:2,sort(e,t){return this.sortArrayPart(e,0,e.length-this.stride,t),e},partition(e,t,r,i){let s=e[r],n=e[r+1],o=t-this.stride;for(let a=t;a<r;a+=2)i?i(s,n,e[a],e[a+1])&&(o+=this.stride,this.swap(e,o,a)):(s>e[a]||s==e[a]&&n>e[a+1])&&(o+=this.stride,this.swap(e,o,a));return this.swap(e,o+this.stride,r),o+this.stride},swap(e,t,r){let i=e[t],s=e[t+1];return e[t]=e[r],e[t+1]=e[r+1],e[r]=i,e[r+1]=s,e},sortArrayPart(e,t,r,i){if(t<r){let s=this.partition(e,t,r,i);this.sortArrayPart(e,t,s-this.stride,i),this.sortArrayPart(e,s+this.stride,r,i)}}},Je={monotoneChain(e){let t=Je.ARRAY_TYPE;if(t||(t=Array),e.length<=0)return new t;Ke.sort(e);let r=new t(e.length),i=0;for(let t=0;t<e.length;t+=2){for(;i>=4&&this.cross(r[i-4],r[i-3],r[i-2],r[i-1],e[t],e[t+1])<=0;)i-=2;r[i]=e[t],r[i+1]=e[t+1],i+=2}r=r.slice(0,i);let s,n=new t(e.length);i=0;for(let t=e.length-2;t>=0;t-=2){for(;i>=4&&this.cross(n[i-4],n[i-3],n[i-2],n[i-1],e[t],e[t+1])<=0;)i-=2;n[i]=e[t],n[i+1]=e[t+1],i+=2}return n=n.slice(0,i-2),t==Float32Array?(s=new Float32Array(n.length+r.length),s.set(n),s.set(r,n.length)):s=n.concat(r),s},cross:(e,t,r,i,s,n)=>(r-e)*(n-t)-(i-t)*(s-e)};class Qe extends We{constructor(e,t){super(),this.inputBuffer=[],this.hasPrediction=!0,Object.defineProperty(this,"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"pathPointCalculator",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0})}togglePrediction(e){this.hasPrediction=e}addImpl(e,t){if(e.phase!=this.phase)throw new Error(`The phase of the addition (${e.phase.name}) doesn't match the phase of the PathProducer (${this.phase.name})`);let r=[],i=[];e&&this.inputBuffer.push(e);let s=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,n=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,o=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,a=this.calculate(s,n,o);return e&&a&&r.push(...a.asArray(this.layout)),this.phase==We.Phase.END?(a=this.calculate(n,o,null),a&&r.push(...a.asArray(this.layout))):!this.hasPrediction||this.phase!=We.Phase.UPDATE&&null==t||(a=this.calculate(n,o,t),a&&(i.push(...a.asArray(this.layout)),a=this.calculate(o,t,null),a&&i.push(...a.asArray(this.layout)))),{added:r,predicted:i}}calculate(e,t,r){return t?this.pathPointCalculator(e,t,r):null}reset(){super.reset(),this.inputBuffer.clear()}}class et{constructor(){this.path=[],this.firstSegment=!1,this.lastSegment=!0;let e=!1;Object.defineProperty(this,"keepAllData",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),et.OutputType.ALL_DATA)},enumerable:!0})}add(e,t,r,i){if(e&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");e&&this.path.clear(),this.firstSegment=e,this.lastSegment=t;let s=this.addImpl(r,i);return this.keepAllData&&this.path.push(...s.added),{added:this.getOutput(s.added,et.OutputType.ADDITION),predicted:this.getOutput(s.predicted,et.OutputType.PREDICTION)}}get(e){this.reset(),this.firstSegment=!0,this.lastSegment=!0;let t=this.getImpl(e);return this.getOutput(t,et.OutputType.PROCESSOR)}addImpl(e,t){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}getImpl(e){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}getOutput(e,t){return e}reset(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}et.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);const tt=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933];class rt extends et{constructor(e,t=15){super(),this.buffer=[],this.pointsCount=0,this.filter=tt.slice(),Object.defineProperty(this,"dimsCount",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"movingAverageWindowSize",{get:function(){return t},set:function(e){t=e,this.filter.length!=e&&(this.filter=rt.resample(tt,e)),this.predictionPointsCount=4*e/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),this.movingAverageWindowSize=t}addImpl(e=[],t=[]){return{added:this.lastSegment?this.project(e):this.addSequence(e),predicted:this.project(t)}}getImpl(e){return this.project(e)}project(e){if(e.length%this.dimsCount!=0)throw new Error(`Points size ('${e.length}') must be multiple of the dimensions count ('${this.dimsCount}').`);if(0==e.length)return[];let t=[],r=this.buffer.slice(),i=e.slice(0,e.length-this.dimsCount),s=this.addSequence(i);t.push(...s);let n=e.slice(e.length-this.dimsCount,e.length),o=this.predictionPointsCount;for(let e=0;e<o;e++){let r=this.addPoint(n);o-e<=this.pointsCount&&t.push(...r)}return this.buffer=r,t}addSequence(e){if(e.length%this.dimsCount!=0)throw new Error(`Points size ('${e.length}') must be multiple of the dimensions count ('${this.dimsCount}').`);let t=[],r=e.length/this.dimsCount;for(let i=0;i<r;i++){let r=this.addPoint(e.slice(i*this.dimsCount,(i+1)*this.dimsCount));t.push(...r)}return this.pointsCount+=r,t}addPoint(e){for(this.buffer.push(...e);this.buffer.length<this.windowSize*this.dimsCount;)this.buffer.unshift(...this.buffer.slice(0,this.dimsCount));for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}filterBuffer(){let e=[];for(let t=0;t<this.windowSize;t++)for(let r=0;r<this.dimsCount;r++)isNaN(e[r])&&(e[r]=0),e[r]+=this.buffer[t*this.dimsCount+r]*this.filter[t];return e}reset(){super.reset(),this.pointsCount=0,this.buffer.clear()}static resample(e,t){let r=new Array(t),i=e.length/t;for(let s=0;s<t;s++){let n=(e.length-1)*s/(t-1),o=Math.floor(n),a=Math.ceil(n),h=n-o,l=e[o]*(1-h)+e[a]*h;l*=i,r[s]=l}return r}}class it extends et{constructor(e){super(),this.pathPointProps={},this.lastSpline=[],Object.defineProperty(this,"layout",{get:function(){return e},set:function(t){e=t,this.reset()},enumerable:!0})}addImpl(e,t){0==this.lastSpline.length&&e.length>0&&e.unshift(...e.slice(0,this.layout.length)),this.lastSegment&&(e.length>=this.layout.length?e.push(...e.slice(e.length-this.layout.length,e.length)):e.push(...this.getLastPart()));let r=this.getFirstPart();return this.lastSpline=r.concat(e),{added:e,predicted:this.getPredictedSpline(t)}}getImpl(e){let t=[];return e.length>0&&(t.push(...e.slice(0,this.layout.length)),t.push(...e),e.length>=this.layout.length&&t.push(...e.slice(e.length-this.layout.length,e.length))),e}getOutput(e,t){let r=t==et.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:e;return 0==r.length?void 0:new Ze(this.layout,r,this.pathPointProps,0,1)}getFirstPart(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}getLastPart(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}getPredictedSpline(e=[]){let t=[];if(e.length>0){let r=this.getFirstPart();for(t.push(...r),t.push(...e),t.push(...t.slice(t.length-this.layout.length,t.length));t.length<4*this.layout.length;)t.unshift(t.slice(0,this.layout.length))}return t}reset(){super.reset(),this.lastSpline.clear()}}const{vec4:st,mat4:nt}=e,ot=nt.fromValues(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5);class at extends et{constructor(e=.1,t=8,r=!1,i=!1){let s;super(),this.spacing=e,this.splitCount=t,this.interpolateByLength=r,this.calculateDerivates=i,this.sizeScaleFactor=1,this.lastPoint=[],Object.defineProperty(this,"inputLayout",{get:function(){return s},set:function(e){s=e,this.inputStride=e.length,this.layout=this.calculateDerivates?e.concat([x.Property.D_X,x.Property.D_Y]):e,this.layoutIndex={},this.layout.indexed||(this.layout=new Proxy(this.layout,{get:function(e,t,r){if("indexed"==t)return!0;if("target"==t)return e;if("getIndex"==t){let t=e.index;return t||(t={},e.forEach((e,r)=>t[e.name]=r),e.index=t),e=>e.name in t?t[e.name]:-1}return Reflect.get(...arguments)}})),this.polynomials=[];for(let e=0;e<this.inputStride;e++)this.polynomials.push(st.create())},enumerable:!0}),this.c=st.create(),this.coefficientsVector=st.create(),this.coefficientDerivatesVector=st.create()}addImpl(e,t){return{added:this.getDiscretizedPath(e,!0),predicted:this.getDiscretizedPath(t,!1)}}getImpl(e){return this.getDiscretizedPath(e)}getOutput(e){return 0==e.length?void 0:new qe(this.layout.target,e,this.pathPointProps,this.tValues)}getDiscretizedPath(e,t){if(this.keepTValues&&(this.tValues=[]),!e)return[];let r=this.discretize(e);return t&&r.length>0&&(this.lastPoint=r.slice(r.length-this.layout.length,r.length)),r}discretize(e){if(this.lastPoint.length>0&&this.lastPoint.length!=this.layout.length)throw new Error("Incorrect or missing last point");0==this.lastPoint.length&&(this.inputLayout=e.layout,this.pathPointProps=e.pointProps);let t=[],r=this.splitCount,i=Math.max(1,10*(this.spacing>1?1:this.spacing)),s=this.lastPoint;for(let n=0;n<e.segmentsCount;n++){let o=this.inputStride*(n+0),a=this.inputStride*(n+1),h=this.inputStride*(n+2),l=this.inputStride*(n+3);for(let t=0;t<this.inputStride;t++){let r=e.points[o+t],i=e.points[a+t],s=e.points[h+t],n=e.points[l+t];st.set(this.c,r,i,s,n),st.transformMat4(this.polynomials[t],this.c,ot)}if(this.interpolateByLength){let t=e.points[a+this.layout.getIndex(x.Property.X)],s=e.points[a+this.layout.getIndex(x.Property.Y)],n=e.points[h+this.layout.getIndex(x.Property.X)],o=e.points[h+this.layout.getIndex(x.Property.Y)],l=Math.sqrt((n-t)*(n-t)+(o-s)*(o-s)),d=this.pathPointProps.size;if(-1!=this.layout.getIndex(x.Property.SIZE)){let t=e.points[a+this.layout.getIndex(x.Property.SIZE)],r=e.points[h+this.layout.getIndex(x.Property.SIZE)];d=Math.min(t,r)}r=Math.floor(i*(l/d)/this.spacing)+1}let d=1/r;for(let i=0;i<=r;i++){let o=0==s.length,a=i/r;if(0==n&&a<e.ts){if(!(a+d>=e.ts))continue;a=e.ts,o=this.spacing<=1}if(n==e.segmentsCount-1&&a>=e.tf){if(!(a<e.tf+d))continue;a=e.tf,o=this.lastSegment&&this.spacing<=1}if(n>0&&0==a)continue;let h=this.samplePoint(a);if(!o&&s.length>0){let e=this.distanceSqrd(s,h,this.inputLayout),t=this.layout.getIndex(x.Property.SIZE),r=(-1==t?this.pathPointProps.size:(s[t]+h[t])/2)*this.spacing;o=e>=r*r}o&&(t.push(...h),s=h,this.keepTValues&&this.tValues.push(a))}}return this.keepTValues&&(0!=t.length&&this.tValues.first==e.ts||(t.unshift(...this.samplePoint(e.ts)),this.tValues.unshift(e.ts)),this.tValues.last!=e.tf&&(t.push(...this.samplePoint(e.tf)),this.tValues.push(e.tf))),t}samplePoint(e){let t=[];st.set(this.coefficientsVector,1,e,e*e,e*e*e);for(let e=0;e<this.inputStride;e++){let r=this.polynomials[e],i=st.dot(r,this.coefficientsVector);e==this.layout.getIndex(x.Property.SIZE)&&(i*=this.sizeScaleFactor),t.push(i)}return this.calculateDerivates&&(t.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(x.Property.X)])),t.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(x.Property.Y)]))),t}getDerivativeOf(e){return st.set(this.coefficientDerivatesVector,e[1],2*e[2],3*e[3],0),st.dot(this.coefficientDerivatesVector,this.coefficientsVector)}distanceSqrd(e,t){let r=e[this.layout.getIndex(x.Property.X)]-t[this.layout.getIndex(x.Property.X)],i=e[this.layout.getIndex(x.Property.Y)]-t[this.layout.getIndex(x.Property.Y)];return r*r+i*i}reset(){super.reset(),this.lastPoint.clear()}}const{vec3:ht,vec4:lt,mat4:dt}=e;class ut extends et{constructor(e){super(),Object.defineProperty(this,"brush",{get:function(){if(!e)throw new Error("brush not found");return e},set:function(t){e=t,this.reset()},enumerable:!0})}addImpl(e,t){return{added:this.generatePolygons(e),predicted:this.generatePolygons(t)}}getImpl(e){return this.generatePolygons(e)}generatePolygons(e){if(!e)return[];let t=[];for(let r=0;r<e.length;r++){let i=e.getPoint(r),s=this.applyBrush(i);t.push(s)}return t}applyBrush(e){let t=[],r=this.createTransform(e),i=this.brush.selectShape(r.maxScale);for(let e=0;e<i.length;e+=2){let s=lt.create(),n=lt.fromValues(i[e],i[e+1],0,1);lt.transformMat4(s,n,r),t.push(s[0]/s[3],s[1]/s[3])}return t}createTransform(e){if(isNaN(e.size))throw new Error("Size information not found.");let t=dt.create(),r=e.size*e.scaleX,i=e.size*e.scaleY,s=e.size*e.scaleZ;return t.maxScale=Math.max(r,i,s),dt.translate(t,t,ht.fromValues(e.x,e.y,e.z||0)),dt.rotateZ(t,t,e.rotation),dt.translate(t,t,ht.fromValues(e.offsetX,e.offsetY,e.offsetZ)),dt.scale(t,t,ht.fromValues(r,i,s)),t}}class ct extends et{constructor(){super(),this.lastPolygon=[]}addImpl(e,t){return{added:this.getConvexHulls(e,!0),predicted:this.getConvexHulls(t)}}getImpl(e){return this.getConvexHulls(e)}getConvexHulls(e,t){let r=[],i=this.lastPolygon;return e.forEach(e=>{i.push(...e),r.push(Je.monotoneChain(i)),i=e}),t&&e.length>0&&(this.lastPolygon=e.last.slice()),r}reset(){super.reset(),this.lastPolygon.clear()}}class pt extends et{constructor(){super(),this.processPrediction=!1}addImpl(e,t){return{added:this.merge(e),predicted:this.processPrediction?this.merge(t):t}}getImpl(e){return this.merge(e)}merge(e){return e.length?L.union(e):[]}}class ft extends et{constructor(e=.1){super(),this.epsilon=e}addImpl(e,t){return{added:this.simplify(e),predicted:t}}getImpl(e){return this.simplify(e)}simplify(e){return e.map(e=>this.simplifyPolygonDouglasPeucker(e))}simplifyPolygonDouglasPeucker(e){if(e.length<6)return e;e instanceof Float32Array&&(e=e.toArray());let t=this.simplifyPolylineDouglasPeucker(e.concat([e[0],e[1]]));return t.length<8?e:t.slice(0,t.length-2)}simplifyPolylineDouglasPeucker(e){if(this.epsilon<=0)return[];if(e.length<4)return e;let t,r=0,i=0;for(let t=2;t<e.length-2;t+=2){let s=ft.perpendicularDistance(e[t],e[t+1],e[0],e[1],e[e.length-2],e[e.length-1]);s>r&&(i=t,r=s)}if(r>this.epsilon){let r=this.simplifyPolylineDouglasPeucker(e.slice(0,i+2)),s=this.simplifyPolylineDouglasPeucker(e.slice(i,e.length));t=r.concat(s.slice(2,s.length))}else t=[e[0],e[1],e[e.length-2],e[e.length-1]];return t}static perpendicularDistance(e,t,r,i,s,n){let o=e-r,a=s-r,h=o*(n-i)-a*(t-i);h*=h,o=s-r,a=n-i;let l=o*o+a*a;return l>0?Math.sqrt(h/l):Math.sqrt((r-e)*(r-e)+(i-t)*(i-t))}}class gt{constructor(){this.layout=[x.Property.X,x.Property.Y],this.pathSegment=new $e,this.pathProducer=new Qe(this.layout,(e,t,r)=>t.createPathPoint()),this.smoother=new rt(this.layout.length),this.splineProducer=new it(this.layout),this.splineInterpolator=new at,this.brushApplier=new ut,this.polygonMerger=new pt,this.polygonSimplifier=new ft,this.splineProducer.keepAllData=!0,this.phase=null,this.raster=!1,this.pathPointProps={},this.queue=Promise.resolve(),Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,layout:this.layout,pathPointProps:this.pathPointProps,pathPointCalculator:this.calculator,movingAverageWindowSize:this.smoother.movingAverageWindowSize,splitCount:this.splineInterpolator.splitCount,epsilon:this.polygonSimplifier.epsilon,mergePrediction:this.polygonMerger.processPrediction}),enumerable:!0})}configure(e={}){if(this.splineInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,e.brush&&(this.brush=e.brush,this.raster=!(this.brush instanceof Ve),this.splineInterpolator.calculateDerivates=this.raster,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.interpolateByLength=this.raster,this.raster?this.splineInterpolator.keepAllData=!0:(this.brushApplier.brush=this.brush,this.brush.spacing>1?this.brushApplier.keepAllData=!0:this.polygonSimplifier.keepAllData=!0)),"basicMode"in e){if(e.basicMode&&this.raster)throw new Error("Basic mode is not supported for particles strokes");this.basicMode=e.basicMode}if(e.pathPointProps&&(this.pathPointProps=e.pathPointProps,this.splineProducer.pathPointProps=this.pathPointProps),e.pathPointCalculator&&(this.calculator=e.pathPointCalculator,this.pathProducer.pathPointCalculator=e.pathPointCalculator),e.layout){if(this.layout=e.layout,!this.raster){if(this.layout.includes(x.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(x.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(x.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(x.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(x.Property.RED)&&isNaN(this.pathPointProps.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(x.Property.GREEN)&&isNaN(this.pathPointProps.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(x.Property.BLUE)&&isNaN(this.pathPointProps.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(x.Property.ALPHA)&&isNaN(this.pathPointProps.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(x.Property.SIZE)&&isNaN(this.pathPointProps.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout}e.movingAverageWindowSize>0&&(this.smoother.movingAverageWindowSize=e.movingAverageWindowSize),e.splitCount>0&&(this.splineInterpolator.splitCount=e.splitCount),e.epsilon>0&&(this.polygonSimplifier.epsilon=e.epsilon),"interpolateByLength"in e&&(this.splineInterpolator.interpolateByLength=e.interpolateByLength),"mergePrediction"in e&&(this.polygonMerger.processPrediction=e.mergePrediction),e.onBuildComplete&&(this.onComplete=e.onBuildComplete),this.reset()}createSensorPoint(e,t,r){let i={x:t,y:r,touchID:this.touchID};return gt.createPoint(e,i)}static createPoint(e,t={}){let r={x:t.x||e.offsetX||e.clientX,y:t.y||e.offsetY||e.clientY,z:void 0,timestamp:Math.floor(e.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0},i={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(r,"phase",{value:We.Phase[e.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(r,"force",{get:function(){return this.pressure},enumerable:!0}),Object.defineProperty(r,"pointer",{value:i,enumerable:!0}),Object.defineProperty(r.pointer,"provider",{get:function(){return De.Type[this.type.toUpperCase()]},enumerable:!0}),e instanceof PointerEvent)i.id=e.pointerId,i.type=e.pointerType,"pen"!=e.pointerType&&"mouse"!=e.pointerType||(i.button=e.button,i.buttons=e.buttons),"pen"!=e.pointerType&&"touch"!=e.pointerType||e.twist>0&&(r.rotation=Math.toRadians(e.twist)),"pen"==e.pointerType?(r.pressure=e.pressure,r.tiltX=e.tiltX,r.tiltY=e.tiltY):"touch"==e.pointerType&&e.pressure>0&&(r.pressure=e.pressure);else if(e instanceof MouseEvent)i.type="mouse",i.button=e.button,i.buttons=e.buttons;else{if(!(e instanceof TouchEvent))throw new Error(`Unexpected event detected: ${e.constructor.name}. Expected event should be instance of PointerEvent, MouseEvent or TouchEvent.`);if(!("touchID"in t))throw new Error("props.touchID is required for touch event");if(!(e=Array.from(e.changedTouches).filter(e=>e.identifier==t.touchID).first))return null;r.x||(r.x=e.offsetX||e.clientX),r.y||(r.y=e.offsetY||e.clientY),i.id=e.identifier,i.type="touch",e.force>0&&.5!==e.force&&(r.pressure=e.force),e.radiusX>0&&e.radiusY>0&&e.radiusX!=e.radiusY&&(r.radiusX=e.radiusX,r.radiusY=e.radiusY),e.rotationAngle>0&&(r.rotation=Math.toRadians(e.rotationAngle))}return r}add(e,t){if(!this.brush)throw new Error("InkBuilder instance is not configured properly, brush is not found");if(!this.layout)throw new Error("InkBuilder instance is not configured properly, layout is not found");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator is not found");if(!e.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=e.phase;let r=new je(e),i=t?new je(t):null;this.device&&(this.phase==We.Phase.BEGIN&&this.device.openStream(e),this.device.add(r),this.phase==We.Phase.END&&(this.sensorData=this.device.closeStream()));let s=this.pathProducer.add(this.phase,r,i);this.pathSegment.add(this.phase,s.added,s.predicted)}ignore(e){if(!e.phase)throw new Error("SensorPoint phase is not found");this.device&&e&&e.phase==We.Phase.UPDATE&&this.device.add(new je(e),!0)}build(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}processSpline(e,t,r,i){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}mergeAndSimplify(e,t,r){return r=this.polygonMerger.add(e,t,r.added,r.predicted),r=this.polygonSimplifier.add(e,t,r.added,r.predicted)}getSensorData(){return this.sensorData}getSpline(){return new Ze(this.layout,this.splineProducer.allData.points,this.pathPointProps)}getInkPath(e){let t;return this.raster?t=this.splineInterpolator.allData:this.basicMode||(this.splineInterpolator.spacing>1?t=this.brushApplier.allData:(t=this.polygonSimplifier.allData,e&&(t=this.polygonMerger.merge(t),t=this.polygonSimplifier.simplify(t)))),t}abort(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}reset(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.splineInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}restart(){this.phase=void 0,this.touchID=void 0}}gt.Phase=We.Phase;class mt extends gt{constructor(){super(),this.convexHullChainProducer=new ct}build(){let e=this.buildSegment();return e.phase=this.phase,e.predicted&&(e.predicted.predicted=!0),this.onComplete&&this.onComplete(e),this.phase==We.Phase.END&&this.restart(),e}buildSegment(){let e={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return this.basicMode||(e=this.smoother.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted)),e=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),e=this.processSegment(this.pathSegment.first,this.pathSegment.last,e.added,e.predicted),this.pathSegment.reset(),e}processSegment(e,t,r,i){let s=this.splineInterpolator.add(e,t,r,i);return this.raster||this.basicMode||(s.added||s.predicted?(s=this.brushApplier.add(e,t,s.added,s.predicted),this.splineInterpolator.spacing<=1&&(s=this.convexHullChainProducer.add(e,t,s.added,s.predicted),s=this.mergeAndSimplify(e,t,s))):s={added:s.added?s.added.points:[],predicted:s.predicted?s.predicted.points:[]}),s}processSpline(e){return this.processSegment(!0,!0,e).added}}let yt=0;class Et{constructor(){this.results={},this.next=0,this.lastPolygon,this.init()}init(){let e=new Blob(['\n// let workerID;\n\nlet QuickSort;\nlet ConvexHullProducer;\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.init) {\n\t\t// workerID = message.index;\n\t\timportClasses(message.imports);\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data, message.type);\n\tself.postMessage({key: message.key, type: message.type, index: message.index, data: result}, [result.buffer]);\n}\n\nfunction importClasses(imports) {\n\tlet blob = new Blob(imports, {type: "application/javascript"});\n\tlet url = URL.createObjectURL(blob);\n\n\tself.importScripts(url);\n\n\tURL.revokeObjectURL(url);\n}\n'],{type:"application/javascript"}),t=URL.createObjectURL(e);this.workers=[new Worker(t),new Worker(t),new Worker(t),new Worker(t)],URL.revokeObjectURL(t);let r=[Object.toSource(Ke,"QuickSort"),Object.toSource(Je,"ConvexHullProducer")];this.workers.forEach((e,t)=>{e.addEventListener("message",e=>this.recieve(e.data)),e.addEventListener("error",e=>this.recieveError(e,t),!1),e.postMessage({init:!0,index:t,imports:r})})}add(e,t,r=[]){let i=yt++,s=this.lastPolygon;return t.length>0&&(this.lastPolygon=t.last),e==We.Phase.END&&(this.lastPolygon=null),this.results[i]={added:[],predicted:[],expected:t.length+r.length,processed:0},new Promise((e,n)=>{this.results[i].resolve=e,this.send(i,"added",s,t),this.send(i,"predicted",t.last,r)})}reset(){this.lastPolygon=null}send(e,t,r,i){let s=[];r&&(s=r),i.forEach((r,i)=>{s.push(...r);let n=this.workers[this.next%this.workers.length];this.next++,n.postMessage({key:e,type:t,index:i,data:s}),s=r})}recieve(e){let t=this.results[e.key];t[e.type][e.index]=e.data,t.processed++,t.processed==t.expected&&(delete this.results[e.key],t.resolve({added:t.added,predicted:t.predicted}))}recieveError(e,t){console.warn("worker "+t),console.error(e)}close(){this.workers.forEach(e=>e.terminate())}}class bt{constructor(){this.queue=Promise.resolve(),this.thenables=[]}then(e,t,r){return this.thenables.push(e),this.queue=this.queue.then((...t)=>(this.thenables.shift(),e.canceled?Promise.resolve():e(...t))),t&&this.then(e=>t(e,r)),this}catch(e){return this.queue=this.queue.catch(e),this}cancel(){this.thenables.forEach(e=>e.canceled=!0)}isEmpty(){return 0==this.thenables.length}static async serial(e,t){let r=new bt;return e.forEach((e,i)=>r.then(e,t,i)),r.queue}}const xt=[];class Pt extends gt{constructor(){super(),this.convexHullChainProducer=new Et,xt.push(this.convexHullChainProducer),this.queue=Promise.resolve(),this.chainQueue=new bt}add(e,t){if(!this.onComplete)throw new Error("InkBuilder instance is not configured properly, onBuildComplete is not found");this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),super.add(e,t)}configure(e){this.chainQueue.isEmpty()?super.configure(e):this.chainQueue.then(()=>super.configure(e))}build(){if(this.phase){let e=this.phase;this.phase==We.Phase.END&&this.restart();let t=()=>Promise.resolve().then(()=>(this.buildPhase=e,this.buildSegment())).then(t=>{this.building=!1,this.aborted||(t.phase=e,t.predicted.predicted=!0,this.onComplete(t))});e==We.Phase.END?this.queue=this.queue.then(t):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=t())}}buildChain(){if(this.phase){let e=this.phase,t=this.getLastPathSegment();this.phase==We.Phase.END&&this.restart(),this.chainQueue.then(()=>(this.buildPhase=e,this.buildSegment(t))).then(t=>{t.phase=e,t.predicted.predicted=!0,this.onComplete(t)})}return this.chainQueue}getLastPathSegment(){let e=this.pathSegment;return this.pathSegment=new $e,e}buildSegment(e){let t;e||(e=this.pathSegment),t=this.smoother.add(e.first,e.last,e.accumulatedAddition,e.lastPrediction),t=this.splineProducer.add(e.first,e.last,t.added,t.predicted);let r=e.first,i=e.last;return e.reset(),this.processSegment(r,i,t.added,t.predicted)}processSegment(e,t,r,i){let s=this.splineInterpolator.add(e,t,r,i);return this.raster?Promise.resolve(s):s.added||s.predicted?(s=this.brushApplier.add(e,t,s.added,s.predicted),this.splineInterpolator.spacing<=1?this.convexHullChainProducer.add(this.phase,s.added,s.predicted).then(r=>this.mergeAndSimplify(e,t,r)):Promise.resolve(s)):Promise.resolve({added:s.added?s.added.points:[],predicted:s.predicted?s.predicted.points:[]})}async processSpline(e){return await this.processSegment(!0,!0,e).added}abort(){super.abort(),this.buildPhase=null,this.chainQueue.cancel()}static closeAll(){xt.forEach(e=>e.close()),xt.clear()}}function wt(){}wt.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};const Tt=wt.BlendMode;let Rt={createTexture(e,t,r){t||(t=e.CLAMP_TO_EDGE),r||(r=e.NEAREST);let i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.bindTexture(e.TEXTURE_2D,null),i},async fillTexture(e,t,r){if(Array.isArray(r)){let i=[],s=r;for(let e of s){let t=await B(e);i.push(t)}await Rt.completeMipMap(i),Rt.initTexture(e,t,i)}else{let i=r,s=await B(i);Rt.initTexture(e,t,s)}},async completeMipMap(e){if(e.sort((e,t)=>t.width-e.width),1==e.last.width)return;let t=e.last.width;for(;t>1;){t/=2;let r=new OffscreenCanvas(e.last.width/2,e.last.height/2);r.getContext("2d").drawImage(e.last,0,0,r.width,r.height);let i=await createImageBitmap(r);e.push(i)}},initTexture(e,t,r){if(e.bindTexture(e.TEXTURE_2D,t),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(r)){let i=r;t.size=[],i.forEach((r,i)=>{e.texImage2D(e.TEXTURE_2D,i,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r),t.size.push({width:r.width,height:r.height}),r.close&&r.close()}),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)}else e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r),t.size={width:r.width,height:r.height},r.close&&r.close();e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.bindTexture(e.TEXTURE_2D,null),this.logGLError(e,t.name)},readTexturePixels(e,t,r){let i=new Uint8Array(r.width*r.height*4),s=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.readPixels(r.left,r.top,r.width,r.height,e.RGBA,e.UNSIGNED_BYTE,i),e.deleteFramebuffer(s),i},logGLError(e,t){let r=e.getError();r>0&&console.error("WebGL error - "+t+": "+r)}};class It{constructor(e,t,r,i={},s={}){this.name=e,this.spacing=i.spacing||.15,this.scattering=i.scattering||0,this.blendMode=i.blendMode||Tt.SOURCE_OVER,this.rotationMode=i.rotationMode||It.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:()=>({spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode,rotationMode:this.rotationMode}),enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:()=>({randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}),enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:()=>Array.isArray(this.descriptor.shape)?this.descriptor.shape.map(e=>e.value):this.descriptor.shape.value,enumerable:!0}),Object.defineProperty(this,"fill",{get:()=>this.descriptor.fill.value,enumerable:!0}),this.updateShape(t),this.updateFill(r,s)}async updateShape(e){Array.isArray(e)?e=e.map(e=>"string"==typeof e?Xe.getInstance(e):e instanceof Xe?e:new Xe(e.name,e.src)):"string"==typeof e?e=Xe.getInstance(e):e instanceof Xe||(e=new Xe(e.name,e.value)),this.descriptor.shape=e,this.ctx&&await this.configureShape()}async updateFill(e,t={}){if(this.randomizeFill=!("randomize"in t)||t.randomize,this.fillTextureSize=t.size,this.fillTextureOffset=t.offset||{x:0,y:0},Array.isArray(e))throw new Error("Mipmap is not compatible whith fill texture");"string"==typeof e?e=Xe.getInstance(e):e instanceof Xe||(e=new Xe(e.name,e.value)),this.descriptor.fill=e,this.ctx&&await this.configureFill()}async configure(e){this.ctx=e,await this.configureShape(),await this.configureFill()}async configureShape(){this.shapeTexture||(this.shapeTexture=Rt.createTexture(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),await Rt.fillTexture(this.ctx,this.shapeTexture,this.shape)}async configureFill(){this.fillTexture||(this.fillTexture=Rt.createTexture(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),await Rt.fillTexture(this.ctx,this.fillTexture,this.fill),this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size)}toJSON(){return{type:this.constructor.name,name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map(e=>e.toJSON()):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}static fromJSON(e){e.particleSettings.blendMode=Tt[e.particleSettings.blendMode],e.particleSettings.rotationMode=It.RotationMode[e.particleSettings.rotationMode];let t=Array.isArray(e.shape)?e.shape.map(e=>Xe.fromJSON(e)):Xe.fromJSON(e.shape),r=Xe.fromJSON(e.fill);return new It(e.name,t,r,e.particleSettings,e.fillTextureSettings)}equals(e){return e==this&&e.shapeTexture==this.shapeTexture&&e.fillTexture==this.fillTexture}delete(){this.deleteShape(),this.deleteFill()}deleteShape(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}deleteFill(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}It.createEnum("RotationMode",["NONE","RANDOM","TRAJECTORY"]);const{mat4:vt}=e;let St,At;class Ct extends Oe{static get config(){return i.stroke}constructor(e,t,r,i){let s;super(t.id),Object.defineProperty(this,"layout",{value:t.layout,enumerable:!0}),Object.defineProperty(this,"points",{get:()=>t.points,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:t.pointProps,enumerable:!0}),Object.defineProperty(this,"ts",{value:t.ts,enumerable:!0}),Object.defineProperty(this,"tf",{value:t.tf,enumerable:!0}),Object.defineProperty(this,"stride",{value:t.stride,enumerable:!0}),Object.defineProperty(this,"length",{value:t.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:t.segmentsCount,enumerable:!0}),t.randomSeed&&Object.defineProperty(this,"randomSeed",{value:t.randomSeed,enumerable:!0}),Object.defineProperty(this,"color",{get:function(){return t.color},set:function(e){t.color=e,r&&(r.color=e)},enumerable:!0}),Object.defineProperty(this,"sensorData",{value:i,enumerable:!0}),Object.defineProperty(this,"spline",{value:t,enumerable:!0}),Object.defineProperty(this,"path",{get:function(){return r||this.buildPath(),r},set:function(e){r=e},enumerable:!0}),Object.defineProperty(this,"bounds",{get:function(){return s||(s=this.brush instanceof It?this.path.getBounds(this.brush.scattering):I.ofPolygons(this.path),s=s.ceil()),this.matrix?K(s,this.matrix):s},enumerable:!0}),this.reset=()=>{r=null,s=null},Object.defineProperty(this,"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(this,"brush",{get:function(){return e||(e=this.descriptor.brush.value),e},set:function(r){if(this.reset(),"string"==typeof r?r=new Xe(r):r instanceof Ve||r instanceof It?r=new Xe(r.name,r):r instanceof Xe||(r=new Xe(r.name,r.value)),r instanceof It&&!t.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");e=null,this.descriptor.brush=r},enumerable:!0}),this.brush=e,this.renderMode=void 0,this.sensorDataOffset=0,this.sensorDataMapping=[]}resolveID(){return"function"==Ct.config.generateID?Ct.config.generateID(this):super.resolveID()}clone(){let e=new Ct(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return e.renderMode=this.renderMode,e.sensorDataOffset=this.sensorDataOffset,e.sensorDataMapping=this.sensorDataMapping.clone(),e}async init(e){this.pathProceessInProgress=!0,At||(At=new Pt),At.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&At.configure(e),this.path=await At.processSpline(this.spline),delete this.pathProceessInProgress}buildPath(e){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");St||(St=new mt),St.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&St.configure(e),this.path=St.processSpline(this.spline)}getSegment(e){let t=e,r=e+3,i=0==t?this.ts:0,s=r+1==this.length?this.tf:1;return this.spline.slice(t,r,i,s)}getSensorPoint(e){if(e>=this.length||e<0)throw new Error(`Index ${e} out of range - (0, ${this.length-1})`);let t;if(this.sensorData){let r=this.sensorData.inkStream;if(r){let i;this.sensorDataMapping.length>0?i=e>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[e]:(i=this.sensorDataOffset+e,i>=r.length&&(i=r.length-1)),t=r.get(i),t.index=i}}return t}getPoint(e){return this.spline.getPoint(e)}setPoint(e,t){let r=e*this.stride;this.layout.forEach((e,i)=>this.points[r+i]=t.getProperty(e))}pointAt(e){return this.getPoint(e)}getAverageWidth(){let e=0;if(this.layout.includes(x.Property.SIZE)){let t=0;for(let e=0;e<this.length;e++)t+=this.getPoint(e).size;e=t/this.length}else e=this.pointProps.size;return e}split(e){let t=e.map(e=>this.subStroke(e));return t.includes(this)||0==t.length?void 0:t}subStroke(e){let{fromIndex:t,toIndex:r,fromTValue:i,toTValue:s}=e;if(0==t&&r+1==this.length&&i==this.ts&&s==this.tf)return this;{let e=this.spline.slice(t,r,i,s),n=new Ct(this.descriptor.brush,e,void 0,this.sensorData);return n.renderMode=this.renderMode,this.sensorData&&(n.sensorDataOffset=this.sensorDataOffset+t,this.sensorDataMapping.length>0?n.sensorDataMapping=this.sensorDataMapping.slice(t,r+1):n.sensorDataMapping=[]),n}}transform(e){if(e||(e=this.matrix,delete this.matrix),e){for(let t=0;t<this.length;t++){let r=this.getPoint(t);r.transform(e),this.setPoint(t,r)}this.reset()}}updateTransform(e){this.matrix||(this.matrix=vt.create()),vt.multiply(this.matrix,this.matrix,e)}setTransform(e){this.matrix=e}static createInstance(e,t,r,i={},s,n=0,o=1){let a=i.color;a&&(delete(i=Object.assign({},i)).color,i.red=a.red,i.green=a.green,i.blue=a.blue,i.alpha=a.alpha);let h=new Ze(r,t,i,n,o);return h.randomSeed=s,new Ct(e,h)}static validatePath(e){if(!e)return!1;if(0==e.length)return!1;if(Array.isArray(e))return!0;let t=!1,r=0,i=!1,{size:s,red:n,green:o,blue:a,alpha:h}=e.pointProps;if(!(e instanceof qe)){let t=e.points.length,s=e.layout.length;i=0==t||t<4*s,r=t%s}return 0!=r?console.error(`The points array (length: ${e.points.length}) does not refer to provided layout (${e.layout.map(e=>e.name).join(", ")})`):i?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!e.layout.includes(x.Property.SIZE)&&isNaN(s)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!e.layout.includes(x.Property.RED)&&isNaN(n)?console.error("Either the color property must be set or the path layout must include a RED property"):!e.layout.includes(x.Property.GREEN)&&isNaN(o)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!e.layout.includes(x.Property.BLUE)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!e.layout.includes(x.Property.ALPHA)&&isNaN(h)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):t=!0,t}static configure(e,t){i[e]=t}}Ct.RenderMode=Object.assign({},...Object.keys(Tt).map(e=>({[e]:"will://rasterization/3.0/blend-mode/"+re.getPropName(e,!0)}))),Ct.RenderMode.get=e=>Ct.RenderMode[re.getEnumValueName(e.replace(/-/g,"_"))],Ct.RenderMode.getBlendMode=e=>Tt[Object.keys(Ct.RenderMode).filter(t=>Ct.RenderMode[t]==e).first];let Ot={};if(ENVIRONMENT==EnvironmentType.NODE){Ot=require("canvas");const{Canvas:e,ImageData:t,Image:r}=Ot;global.OffscreenCanvas=e,global.ImageData=t,global.Image=r}class Mt{constructor(){}getExportCanvas(e){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}async toBlob(e,t="image/png",r=.92){if("undefined"==typeof Blob)throw"undefined"==typeof Buffer?new Error("Current environment do not have neither Blob nor Buffer support."):new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");let i=this.getExportCanvas(e);return i.toBlob?new Promise((e,s)=>i.toBlob(e,t,r)):i.convertToBlob({type:t,quality:r})}async toBuffer(e,t="image/png",r={}){if("undefined"==typeof Buffer)throw"undefined"==typeof Blob?new Error("Current environment do not have neither Blob nor Buffer support."):new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");let i=this.getExportCanvas(e);if(r.filters){let e=Array.isArray(r.filters)?r.filters.slice():[r.filters],t=0;e.forEach(e=>{t|=i["PNG_FILTER_"+e.name]}),Object.assign({},r,{filters:t})}return new Promise((e,s)=>i.toBuffer((t,r)=>t?s(t):e(r),t,r))}}Mt.createEnum("PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);class Dt extends Mt{get width(){return this.surface.width}get height(){return this.surface.height}constructor(e){super(),Object.defineProperty(this,"surface",{value:e.canvas}),Object.defineProperty(this,"ctx",{value:e}),Object.defineProperty(this,"bounds",{get:()=>I.create(0,0,this.width,this.height),enumerable:!0})}clear(e,t){if(t){if(n.is(e))throw new Error("`clear` first argument should be Rectangle")}else n.is(e)&&(t=e,e=null);e||(e=this.bounds),this.ctx.clearRect(e.left,e.top,e.width,e.height),t&&(this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.ctx.fillRect(e.left,e.top,e.width,e.height))}draw(e){return this.drawStroke(e.brush,e.path,e.color,e.matrix)}drawStroke(e,t,r,i){if(t instanceof qe)return this.drawSpline(t,r);if(!Ct.validatePath(t))return null;let s=I.ofPolygons(t);return s=this.bounds.intersect(s),s&&(s=s.ceil(),this.ctx.save(),i?(s=K(s,i),this.ctx.setTransform(i[d.a],i[d.b],i[d.c],i[d.d],i[d.dx],i[d.dy])):(this.ctx.rect(s.left,s.top,s.width,s.height),this.ctx.clip()),t.holesClockwise=!0,this.drawPath(t,`rgb(${r.red}, ${r.green}, ${r.blue})`),e.pattern&&this.drawPath(t,e.pattern),this.ctx.restore()),s}drawPath(e,t){this.ctx.beginPath(),e.forEach((t,r)=>{if(this.ctx.moveTo(t[0],t[1]),e.holesClockwise||0==r)for(let e=2;e<t.length;e+=2)this.ctx.lineTo(t[e],t[e+1]);else for(let e=t.length-2;e>=0;e-=2)this.ctx.lineTo(t[e],t[e+1]);this.ctx.closePath()}),t&&(this.ctx.fillStyle=t),this.ctx.fill()}drawSpline(e,t){let r;t||(t=e.color),this.ctx.save(),this.ctx.fillStyle=`rgb(${t.red}, ${t.green}, ${t.blue})`;for(let t=0;t<e.length;t++){let i=e.getPoint(t),s=i.size/2;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),r=I.create(i.x-s,i.y-s,i.size,i.size).union(r)}return this.ctx.restore(),r.ceil()}fill(e,t){let r;return e instanceof I?r=e:("number"==typeof e[0]&&(e=[e]),r=I.ofPolygons(e)),r=this.bounds.intersect(r),r&&(r=r.ceil(),this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,e instanceof I?this.ctx.fillRect(e.left,e.top,e.width,e.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.drawPath(e),this.ctx.restore())),r}blend(e,t={}){if(t.mode||(t.mode=Tt.SOURCE_OVER),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");t.rect&&(t.sourceRect=t.rect,t.destinationRect=t.rect),this.ctx.save(),t.transform?this.ctx.setTransform(t.transform[d.a],t.transform[d.b],t.transform[d.c],t.transform[d.d],t.transform[d.dx],t.transform[d.dy]):t.clipRect&&(this.ctx.rect(t.clipRect.left,t.clipRect.top,t.clipRect.width,t.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=t.mode,t.sourceRect&&t.destinationRect?this.ctx.drawImage(e.ctx.canvas,t.sourceRect.left,t.sourceRect.top,t.sourceRect.width,t.sourceRect.height,t.destinationRect.left,t.destinationRect.top,t.destinationRect.width,t.destinationRect.height):this.ctx.drawImage(e.ctx.canvas,0,0),this.ctx.restore()}createImageData(e,t,r){return new ImageData(e,t,r)}getImageData(e){return e||(e=this.bounds),this.ctx.getImageData(e.x,e.y,e.width,e.height)}putImageData(e,t=0,r=0){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.ctx.putImageData(e,t,r)}readPixels(e){return this.getImageData(e).data}writePixels(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t||(t=this.bounds),this.putImageData(this.createImageData(e,t.width,t.height),t.x,t.y)}getExportCanvas(e){let t=this.surface;return e&&(e=e.intersect(this.bounds).ceil(),t=new OffscreenCanvas(e.width,e.height),t.getContext("2d").putImageData(this.getImageData(e),0,0)),t}resize(e,t){this.surface.width=e,this.surface.height=t}}class Nt extends Dt{constructor(e){super(e)}static createInstance(e,t,r){if(!e||"function"!=typeof e.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(!(t>0&&r>0))throw new Error("width and height are required and should be positive whole numbers");if("undefined"!=typeof screen){let t=Math.max(screen.width,screen.height);e.width=t,e.height=t}return e.width=t,e.height=r,new Nt(e.getContext("2d"))}createLayer(e,t){e&&t||("undefined"==typeof screen?(e=this.surface.width,t=this.surface.height):t=e=Math.max(screen.width,screen.height));let r=new OffscreenCanvas(e,t);return new Dt(r.getContext("2d"))}}class Lt{constructor(e,t){this.canvas=e,this.layer=t||e.createLayer(),this.ownLayer=!t,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=n.TRANSPERENT,this.blendMode=Tt.SOURCE_OVER,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,color:this.color,backgroundColor:this.backgroundColor,blendMode:this.blendMode}),enumerable:!0})}configure(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),this.restart=!0}draw(e,t=!1){if(e instanceof Ct){let t=e,r=Tt.SOURCE_OVER;if(t.renderMode&&(r=Ct.RenderMode.getBlendMode(t.renderMode),!r))return void console.warn(`Cannot process ${t.renderMode} render mode. Requres custom processing.`);this.color=t.color,this.blendMode=r,this.reset();let i=this.layer.draw(t);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(e)){let t=this.layer.drawStroke(this.brush,e,this.color);t&&(this.incompleteStrokeBounds=t.union(this.incompleteStrokeBounds),this.strokeBounds=t.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}drawPreliminary(e){if(!this.validate(e))return;let t=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.clear()),t=this.preliminaryLayer):t=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:Tt.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=t.drawStroke(this.brush,e,this.color),this.updatedArea=I.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}abort(){this.restart=!0}reset(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer||(this.alphaLayer=this.canvas.createLayer())),this.restart=!1}validate(e){return e&&e.length>0}blendUpdatedArea(e){if(!this.updatedArea)return;let t=e||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,i=t.bounds.intersect(this.updatedArea);if(i){let e=this.color.alpha;e<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(t,{rect:i}),this.alphaLayer.ctx.globalAlpha=e,this.alphaLayer.blend(r,{mode:this.blendMode,rect:i}),t.clear(i),t.blend(this.alphaLayer,{rect:i})):t.blend(r,{mode:this.blendMode,rect:i.ceil()})}this.incompleteStrokeBounds=null,this.updatedArea=null}blendStroke(e,t,r){if(!this.strokeBounds)return;r||(r=this.blendMode);let i=this.layer,s=e||this.canvas;if(t=s.bounds.intersect(t||this.strokeBounds)){let e=this.color.alpha;e<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=e,this.alphaLayer.blend(i,{rect:t}),s.blend(this.alphaLayer,{mode:r,rect:t})):s.blend(i,{mode:r,rect:t.ceil()})}}toStroke(e,t){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");let r=e.getSensorData(),i=e.getSpline(),s=e.getInkPath(t),n=new Ct(this.brush,i,s,r);return r&&(n.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=Tt.SOURCE_OVER&&(n.renderMode=Ct.RenderMode.get(this.blendMode)),n}delete(){console.warn("Not applicable with 2D API")}}let kt={};ENVIRONMENT==EnvironmentType.NODE&&(kt=require("gl"));var Bt=kt;class _t{constructor(e=0,t=0){this.width=e,this.height=t}getContext(e,t){if(!this.context){let e=this.width,r=this.height;this.context=Bt(e,r,t),this.context.canvas=this;let i=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:()=>e,set:t=>{e=t,i.resize(e,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:()=>e,set:t=>{r=t,i.resize(e,r)},enumerable:!0})}return this.context}destroy(){if(this.context){this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context}}}class Ft extends Mt{constructor(e,t={},r={}){if(super(),this.inkGLContext=e,this.gl=e.gl,this.scaleFactor=t.scaleFactor||1,this.flipY=!!t.flipY,this.useTextureStorage=!1,t.renderbuffer){if(!t.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");let e=this.initWithGLBuffers(t.framebuffer,t.renderbuffer);this.flipY=!0,this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else if(t.framebuffer){let e=this.initWithGLFramebuffer(t.framebuffer);this.flipY=!0,this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else if(t.texture){if(!(t.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");let e;if(this.texture=t.texture,this.useTextureStorage=!0,t.width>0&&t.height>0)e={width:t.width,height:t.height};else{if(!this.texture.image)throw new Error("`width` and `height` are required when `texture` is available");e={width:this.texture.image.width,height:this.texture.image.height}}this.ownGLResources=!!t.ownGLResources,this.setDimensions(e.width,e.height)}else{let e=t.width||r.width,i=t.height||r.height;if(!e)throw new Error("width is required");if(!i)throw new Error("height is required");if(this.setDimensions(e,i),t.display)this.framebuffer=null,this.renderbuffer=null,this.texture=null;else if(this.useTextureStorage=!t.useBuffersStorage,this.ownGLResources=!0,this.useTextureStorage){let e=this.inkGLContext.generateBuffersExt(this.storageWidth,this.storageHeight,this.gl.LINEAR,this.gl.UNSIGNED_BYTE);this.framebuffer=e.framebuffer,this.texture=e.texture}else{let e=this.inkGLContext.genFrameAndRenders(this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight);this.framebuffer=e.framebuffer,this.renderbuffer=e.renderbuffer}}this.releaseRenderbuffer=!1,this.deleted=!1}initWithGLFramebuffer(e){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");let t,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return t=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(e,t)}initWithGLBuffers(e,t){if(!(e instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(t instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");let r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t);let i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),s=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=e,this.renderbuffer=t,{width:i,height:s}}setDimensions(e,t){let r=Math.ceil(e*this.scaleFactor),i=Math.ceil(t*this.scaleFactor),s=R.makeWithSize(0,0,e,t),n=R.makeWithSize(0,0,r,i);Object.defineProperties(this,{width:{value:e,enumerable:!0,configurable:!0},height:{value:t,enumerable:!0,configurable:!0},graphicsBounds:{value:s,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:i,enumerable:!0,configurable:!0},storageBounds:{value:n,enumerable:!0,configurable:!0}})}resize(e,t){e>0&&t>0&&(this.width!=e||this.height!=t)&&(this.setDimensions(e,t),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}delete(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}deleteLater(){setTimeout(()=>this.delete(),0)}isDeleted(){return this.deleted}}class Ut{constructor(e=Date.now()){this.randomSeed=e}copyTo(e){e.randomSeed=this.randomSeed}}class jt extends Ft{constructor(e,t,r){super(e.inkGLContext,t,r),this.convexHullChainProducer=new ct,this.polygonSimplifier=new ft,Object.defineProperty(this,"inkContext",{value:e,enumerable:!0}),Object.defineProperty(this,"bounds",{get:()=>I.fromGLRect(this.graphicsBounds),enumerable:!0})}clear(e,t){if(t){if(n.is(e))throw new Error("`clear` first argument should be Rect")}else n.is(e)?(t=e,e=null):t=n.TRANSPERENT;let r;e instanceof I&&(r=e.toGLRect()),Array.isArray(e)||e instanceof Float32Array?this.fill(e,t,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(t)),r&&this.inkContext.disableTargetClipRect()}draw(e){let t,r=e.brush;return r instanceof It?isFinite(e.randomSeed)&&(t=new Ut(e.randomSeed)):t=e.color,this.drawStroke(r,e.path,t)}drawStroke(e,t,r){if(!Ct.validatePath(t))return null;this.inkContext.setTarget(this);let i=this.inkContext.drawStroke(e,t,r);return e instanceof It?I.fromGLRect(i):I.ofPolygons(t).ceil()}fill(e,t,r=!0){let i,s;if(e instanceof I?(i=[e.toPath().points],s=e):("number"==typeof e[0]&&(e=[e]),i=e,s=I.ofPolygons(i)),s=this.bounds.intersect(s),s){let n=i;Array.isArray(e)&&(n=this.convexHullChainProducer.get(n)),n=this.polygonSimplifier.get(n);let o=this.inkContext.triangulate(n);o.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(o,t,r)):s=void 0}return s?s.ceil():void 0}blend(e,t={}){if(t.mode||(t.mode=Tt.SOURCE_OVER),t.rect&&!t.transform&&(t.sourceRect=t.rect,t.destinationRect=t.rect),t.transform&&t.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(t.sourceRect&&!t.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(t.destinationRect&&!t.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,t.clipRect?t.clipRect.toGLRect():void 0),"boolean"==typeof t.flipY&&(e.flipY=t.flipY),t.transform&&t.rect){let r=t.rect.toGLRect().toQuad(),i=t.rect.toGLRect().toQuad(t.transform);this.inkContext.drawLayer(e,r,i,t.mode)}else t.transform?this.inkContext.drawLayerWithTransform(e,t.transform,t.mode):t.sourceRect&&t.destinationRect?this.inkContext.drawLayer(e,t.sourceRect.toGLRect().toQuad(),t.destinationRect.toGLRect().toQuad(),t.mode):this.inkContext.drawLayerWithTransform(e,null,t.mode)}createImageData(e,t,r){return e instanceof Uint8Array&&(e=new Uint8ClampedArray(e.buffer)),new ImageData(e,t,r)}getImageData(e){return e||(e=this.bounds),this.createImageData(this.readPixels(e,!0),e.width,e.height)}putImageData(e,t=0,r=0){if(!(e instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.writePixels(e.data,I.create(t,r,e.width,e.height))}readPixels(e,t){e&&(e=e.toGLRect()),this.inkContext.setTarget(this);let r=this.inkContext.readPixels(e);if(t)for(let e=0;e<r.length;e+=4){let t=r[e+3];r[e]=parseInt(255*r[e]/t),r[e+1]=parseInt(255*r[e+1]/t),r[e+2]=parseInt(255*r[e+2]/t)}return r}writePixels(e,t){if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");t&&(t=t.toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(t,e)}getExportCanvas(e){e=e?e.intersect(this.bounds).ceil():this.bounds;let t=new OffscreenCanvas(e.width,e.height);return t.getContext("2d").putImageData(this.getImageData(e),0,0),t}}let Gt;Gt=ENVIRONMENT==EnvironmentType.NODE?require("poly2tri"):poly2tri;const{SweepContext:Yt,Point:Xt}=Gt,{mat4:zt}=e;class Vt{constructor(e){if(!e)throw new Error("GL context is not available in current environment");this.gl=e,this.currentProgram=null,this.programs=[],Object.defineProperty(Vt,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(Vt,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0})}init(e,t){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.bUseStencilBufferForBlending=!1,this.currentBlendMode=Tt.COPY,this.resize(e,t),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.genStaticVBOs(),this.onChange();for(let e=0;e<this.programs.length;e++)this.programs[e].init()}getSupportedFloatPrecision(e){return this.gl.getShaderPrecisionFormat(e,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(e,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}random(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}static random(e){return(1103515245*e+12345&2147483647)/2147483647}setUniforms(e){let t=zt.create();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),e?zt.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):zt.ortho(t,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=t,this.onChange()}resize(e,t){this.textureWidth=parseInt(Math.ceil(e.width)),this.textureHeight=parseInt(Math.ceil(e.height)),this.gl.viewport(e.x,e.y,e.width,e.height),this.bounds=e,this.graphicsBox=t,this._clipRect=this.graphicsBox}genStaticVBOs(){this.fullScreenQuad2dBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.fullScreenQuad2dBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.gl.STATIC_DRAW);let e=[];for(let t=0;t<=1024;t++)e.push(t,1,1),e.push(t,-1,1);for(let t=0;t<=1024;t++)e.push(t,1,1),e.push(t,1,0);for(let t=0;t<=1024;t++)e.push(t,-1,1),e.push(t,-1,0);this.strokeSegmentBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.strokeSegmentBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW),e=[-1,1];for(let t=0;t<=1024;t++)e.push(t,1);for(let t=0;t<=1024;t++)e.push(t,1),e.push(t,0);this.circleBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.circleBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(e),this.gl.STATIC_DRAW),this.destBuffer=this.gl.createBuffer(),this.srcBuffer=this.gl.createBuffer(),this.vertsBuffer=this.gl.createBuffer(),this.colorsBuffer=this.gl.createBuffer()}blendMode(e){if(e!=this.currentBlendMode){switch(e){case Tt.COPY:this.gl.disable(this.gl.BLEND);break;case Tt.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case Tt.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case Tt.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case Tt.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case Tt.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case Tt.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case Tt.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Tt.MIN:this.gl.enable(this.gl.BLEND),this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Tt.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Tt.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Tt.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: "+e)}this.currentBlendMode=e}}clearColorbuffer(e){this.gl.clearColor(e.red*e.alpha/255,e.green*e.alpha/255,e.blue*e.alpha/255,e.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}scissors(e){if(e&&!(e instanceof R))throw new TypeError("rect must be undefined or instanceof GLRect");let t=this.gl.isEnabled(this.gl.SCISSOR_TEST);e?(t||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(e.x,e.y,e.width,e.height)):t&&this.gl.disable(this.gl.SCISSOR_TEST)}isProgramActive(e){return this.currentProgram==e}activateProgram(e){this.isProgramActive(e)?e.contextChanged&&(e.onContextChange(),e.contextChanged=!1):(this.currentProgram&&this.currentProgram.onDeactivate(),this.gl.useProgram(e.program),this.currentProgram=e,e.onActivate(),e.onContextChange(),e.contextChanged=!1)}generateBuffersExt(e,t,r,i){let s=this.gl,n=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,n);let o=s.createTexture();return s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,i,null),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,o,0),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),{framebuffer:n,texture:o}}genFrameAndRenders(e,t,r){let i=this.gl.createFramebuffer(),s=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,s),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,e,t,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,s),{framebuffer:i,renderbuffer:s}}deleteBuffers(e,t){t&&this.gl.deleteTexture(t),e&&this.gl.deleteFramebuffer(e)}deleteFrameAndRender(e,t){t&&this.gl.deleteRenderbuffer(t),e&&this.gl.deleteFramebuffer(e)}onChange(){for(let e=0;e<this.programs.length;e++)this.programs[e].contextChanged=!0}isStencilBufferAvailable(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}enableStencilBufferForBlending(){this.bUseStencilBufferForBlending=!0,this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)}disableStencilBufferForBlending(){this.bUseStencilBufferForBlending=!1}shouldUseStencilBufferForBlending(){return this.bUseStencilBufferForBlending}drawArrays(e,t,r){this.currentBlendMode!=Tt.MAX||this.blendMinMaxExt?this.gl.drawArrays(e,t,r):(this.shouldUseStencilBufferForBlending()&&(this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(e,t,r),this.shouldUseStencilBufferForBlending()&&(this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(e,t,r),this.shouldUseStencilBufferForBlending()&&this.gl.disable(this.gl.STENCIL_TEST))}}class Ht{constructor(e){Object.defineProperties(this,{inkGLContext:{value:e},gl:{value:e.gl}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}init(){}compileShader(e,t){let r=this.inkGLContext.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw new Error("could not compile shader:"+r.getShaderInfoLog(i));return i}createProgram(e,t){let r=this.inkGLContext.gl,i=r.createProgram();if(r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))throw new Error("program filed to link:"+r.getProgramInfoLog(i));return i}onActivate(){}onDeactivate(){}onContextChange(){}activate(){this.inkGLContext.activateProgram(this)}}class Wt extends Ht{init(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}onContextChange(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}onDeactivate(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}drawVertices(e,t,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),e.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,e.length/2)}static getVertexShader(){return`\n\t\t\tprecision ${Vt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t`}static getFragmentShader(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}class $t extends Ht{init(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}onDeactivate(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}drawTexture(e,t,r,i,s){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,i),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,s),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}static getVertexShader(){return`\n\t\t\tprecision ${Vt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t`}static getFragmentShader(){return`\n\t\t\tprecision ${Vt.FRAGMENT_SHADER_PRECISION} float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t`}}class Zt extends Ht{init(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}setBrush(e){this.brush=e,this.brushChanged=!0}onActivate(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.fullScreenQuad2dBuffer),this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_color)}onContextChange(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}onDeactivate(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}drawSprite(e){this.activate(),this.brushChanged&&(this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture),this.gl.uniform1i(this.u_fillTexture,1),this.brushChanged=!1);let t=Math.min(1,Math.max(0,e.alpha)),r=e.red/255*t,i=e.green/255*t,s=e.blue/255*t;this.gl.vertexAttrib4f(this.a_color,r,i,s,t),0==e.dX&&0==e.dY&&(e.dX=2*this.inkGLContext.random()-1,e.dY=2*this.inkGLContext.random()-1),this.gl.vertexAttrib2f(this.a_velocity,e.dX,e.dY);let n=this.brush.rotationMode==It.RotationMode.TRAJECTORY?1:0,o=this.brush.rotationMode==It.RotationMode.RANDOM?2*this.inkGLContext.random()*Math.PI:0,a=(2*this.inkGLContext.random()-1)*this.brush.scattering;this.gl.vertexAttrib3f(this.a_transformParams,n,o,a),this.gl.vertexAttrib1f(this.a_spriteRotation,e.rotation),this.gl.vertexAttrib4f(this.a_spriteScaleAndOffset,e.scaleX,e.scaleY,e.offsetX,e.offsetY),this.gl.vertexAttrib3f(this.a_xys,e.x,e.y,e.size),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}static getVertexShader(){return`\n\t\t\tprecision ${Vt.VERTEX_SHADER_PRECISION} float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t`}static getFragmentShader(e){return`\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ${e?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)"};\n\n\t\t\t}\n\t\t`}}const{mat4:qt}=e;class Kt{constructor(e,t){let r=e.getContext("webgl2",t)||e.getContext("webgl",t);this.inkGLContext=new Vt(r),this.gl=this.inkGLContext.gl,this.simpleProgram=new Wt(this.inkGLContext),this.textureProgram=new $t(this.inkGLContext),this.spriteProgram=new Zt(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new R(0,0,0,0),new R(0,0,0,0))}createLayer(e,t){return new Ft(this.inkGLContext,e,t)}drawLayerWithTransform(e,t,r){if(!this.currentTarget)return;let i=e.graphicsBounds.toQuad(),s=e.graphicsBounds.toQuad(t);this.drawLayer(e,i,s,r)}drawLayer(e,t,r,i){if(!this.currentTarget)return;if(!e.useTextureStorage)return;let s=qt.create(),n=qt.create(),o=this.currentTarget;o.flipY?qt.ortho(n,0,o.width,o.height,0,1,-1):qt.ortho(n,0,o.width,0,o.height,1,-1),e.flipY?qt.ortho(s,-e.width,e.width,2*e.height,0,0,1):qt.ortho(s,-e.width,e.width,-e.height,e.height,0,1),this.inkGLContext.blendMode(i),this.textureProgram.drawTexture(e.texture,r,t,n,s)}setTarget(e,t){let r=this.inkGLContext,i=r.gl;if(e&&!(e instanceof Ft))throw new TypeError("layer must be unset or instanceof InkLayer");if(t&&!(t instanceof R))throw new TypeError("clipRect must be unset or instanceof GLRect");if(e){this.currentTarget=e;let s=new R(0,0,e.storageWidth,e.storageHeight),n=new R(0,0,e.width,e.height);r.resize(s,n),r.setUniforms(e.flipY),t?this.setTargetClipRect(t):this.disableTargetClipRect(),i.bindFramebuffer(i.FRAMEBUFFER,e.framebuffer)}}clearColor(e){this.inkGLContext.clearColorbuffer(e)}setTargetClipRect(e){let t=this.inkGLContext;e=e.floor().intersect(this.currentTarget.graphicsBounds),t._clipRect=e;let r=this.currentTarget.scaleFactor;e=this.currentTarget.flipY?R.makeWithSize(e.x,this.currentTarget.storageHeight-e.top,e.width,e.height):R.makeWithSize(e.x*r,e.y*r,e.width*r,e.height*r),t.scissors(e)}disableTargetClipRect(){let e=this.inkGLContext;e.scissors(null),e._clipRect=e.graphicsBox}drawStroke(e,t,r){return this.currentTarget?0==t.length?null:e instanceof It?this.drawGL(e,t,r):this.draw2D(e,t,r):null}drawGL(e,t,r){let i,s=null,n=this.inkGLContext._clipRect;r&&(i=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),e.randomizeFill&&(e.fillTextureOffset={x:this.inkGLContext.random(),y:this.inkGLContext.random()}),e.blendMode?this.inkGLContext.blendMode(e.blendMode):this.inkGLContext.blendMode(Tt.SOURCE_OVER),this.spriteProgram.setBrush(e);for(let r=0;r<t.length;r++){let i=t.getPoint(r),o=R.calculateBrushGLSegmentBounds(i,e.scattering).intersect(n);o&&(this.spriteProgram.drawSprite(i),s=o.union(s))}return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=i),s?s.ceil():null}draw2D(e,t,r){if(e.spacing>1)t.forEach(e=>{let t=this.triangulate([e]);this.fillStroke(t,r)});else{let e=this.triangulate(t);this.fillStroke(e,r)}}triangulate(e){let t=[],r=[];e.forEach(e=>{let t=[];for(let r=0;r<e.length;r+=2)t.push(new Xt(e[r],e[r+1]));r.push(t)});let i=new Yt(r.shift());r.forEach(e=>i.addHole(e));let s=[];try{i.triangulate(),s=i.getTriangles()}catch(e){console.warn(e)}return s.forEach(e=>{e.getPoints().forEach(e=>{t.push(e.x,e.y)})}),t}fillStroke(e,t){this.fill(e,t,!0,!0)}fill(e,t,r,s){t=n.premultiply(t);let o=r?4:1,a=i.GL_ANTI_ALIASING_SIZE,h=o*o,l=1.01/h,d=a/o,u=new Float32Array(e.length*h),c=new Float32Array(2*e.length*h),p=0,f=0;for(let r=0;r<o;r++)for(let i=0;i<o;i++){let s=l,n={x:r*d-(a-d)/2,y:i*d-(a-d)/2};for(let r=0;r<e.length;r+=6){let i=[{x:e[r],y:e[r+1]},{x:e[r+2],y:e[r+3]},{x:e[r+4],y:e[r+5]}];for(let e=0;e<3;e++)u[p++]=i[e%3].x+n.x,u[p++]=i[e%3].y+n.y,c[f++]=s*t.red,c[f++]=s*t.green,c[f++]=s*t.blue,c[f++]=s*t.alpha}}let g=Tt.SOURCE_OVER;s?g=Tt.MAX:r?g=Tt.LIGHTER:n.equals(t,n.TRANSPERENT)&&(g=Tt.COPY),this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),this.inkGLContext.blendMode(g),this.simpleProgram.drawVertices(u,c)}readPixels(e){let t=this.currentTarget,r=this.inkGLContext.gl;if(e){if(!(e instanceof R))throw new TypeError("box must be instance of GLRect")}else e=t.graphicsBounds;t.flipY&&(e=R.makeWithSize(e.x,t.height-e.y-e.height,e.width,e.height)),this.setTarget(t);let i=new Uint8Array(e.width*e.height*4);return r.readPixels(parseInt(e.x*t.scaleFactor),parseInt(e.y*t.scaleFactor),parseInt(e.width*t.scaleFactor),parseInt(e.height*t.scaleFactor),r.RGBA,r.UNSIGNED_BYTE,i),i}writePixels(e,t){if(e&&!(e instanceof R))throw new TypeError("rect must be instance of GLRect");let r=this.currentTarget,i=this.inkGLContext.gl;if(e||(e=R.makeWithSize(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");{r.flipY&&(e=R.makeWithSize(e.x,r.height-e.y-e.height,e.width,e.height));let s=R.makeWithSize(e.x*r.scaleFactor,e.y*r.scaleFactor,e.width*r.scaleFactor,e.height*r.scaleFactor);i.finish(),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,r.texture),i.texSubImage2D(i.TEXTURE_2D,0,parseInt(s.x),parseInt(s.y),parseInt(s.width),parseInt(s.height),i.RGBA,i.UNSIGNED_BYTE,t)}}}class Jt extends jt{constructor(e){if(super(e,{display:!0,width:e.inkGLContext.gl.canvas.width,height:e.inkGLContext.gl.canvas.height,flipY:ENVIRONMENT==EnvironmentType.WEB||ENVIRONMENT==EnvironmentType.WORKER}),Object.defineProperty(this,"surface",{value:e.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(this,"ctx",{value:e.inkGLContext.gl,enumerable:!0}),"function"==typeof requestAnimationFrame&&!e.attributes.preserveDrawingBuffer&&!i.ownBackbuffer){let e=this.createLayer();Object.defineProperty(this,"backbuffer",{value:e,enumerable:!0});let t=r=>{this.present&&(delete this.present,super.blend(e,{mode:Tt.COPY})),this.frameID=requestAnimationFrame(t)};this.frameID=requestAnimationFrame(t)}}test(){this.testBuffer||(this.testCnt=0,this.testBuffer=this.ctx.createBuffer()),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.testBuffer);let e=Date.now();this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([0,0,0,0,0,0,0,0]),this.ctx.DYNAMIC_DRAW),e=Date.now()-e,e>5&&this.testCnt<100?setTimeout(()=>{this.testCnt++,this.test()},100):(this.ctx.deleteBuffer(this.testBuffer),delete this.testBuffer,delete this.testCnt)}static createInstance(e,t,r,s){if(!e||"function"!=typeof e.getContext)throw new Error("WebGL context provider is required");if(!(t>0&&r>0))throw new Error("width and height are required and should be positive whole numbers");if("object"==typeof screen){let t=Math.max(screen.width,screen.height);e.width=t,e.height=t}e.width=t,e.height=r,i.DEFAULT_LAYER_SIZE||("object"==typeof screen?i.setDefaultLayerSize(Math.max(screen.width,screen.height)):i.setDefaultLayerSize(t,r)),i.DEFAULT_SCALE_FACTOR||i.setDefaultScaleFactor(1);let n=new Kt(e,s);return n.attributes=s||{},new Jt(n)}createLayer(e){return new jt(this.inkContext,e,{width:i.DEFAULT_LAYER_SIZE.width,height:i.DEFAULT_LAYER_SIZE.height,scaleFactor:i.DEFAULT_SCALE_FACTOR})}clear(e,t){this.backbuffer?(this.backbuffer.clear(e,t),this.present=!0):super.clear(e,t)}draw(e,t){let r;return this.backbuffer?(r=this.backbuffer.draw(e,t),this.present=!0):r=super.draw(e,t),r}drawStroke(e,t,r){let i;return this.backbuffer?(i=this.backbuffer.drawStroke(e,t,r),this.present=!0):i=super.drawStroke(e,t,r),i}fill(e,t,r){let i;return this.backbuffer?(i=this.backbuffer.fill(e,t,r),this.present=!0):i=super.fill(e,t,r),i}blend(e,t){this.backbuffer?(this.backbuffer.blend(e,t),this.present=!0):super.blend(e,t)}readPixels(e,t){return this.backbuffer?this.backbuffer.readPixels(e,t):super.readPixels(e,t)}writePixels(e,t){this.backbuffer?(this.backbuffer.writePixels(e,t),this.present=!0):super.writePixels(e,t)}async toBlob(e=this.bounds,t,r){return this.backbuffer?await this.backbuffer.toBlob(e,t,r):await super.toBlob(e,t,r)}resize(e,t){super.resize(e,t),this.surface.width=e,this.surface.height=t}delete(){ENVIRONMENT==EnvironmentType.WEB&&cancelAnimationFrame(this.frameID),super.delete(),this.backbuffer&&this.backbuffer.delete()}deleteLater(){return super.deleteLater(),this.backbuffer&&this.backbuffer.deleteLater(),this}}class Qt{constructor(e,t){this.canvas=e;let r=t instanceof jt?t:void 0,i=t&&!r?t:new Object;this.layer=r||e.createLayer(i),this.layerOptions=i,this.ownLayer=!r,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=n.TRANSPERENT,this.blendMode=Tt.SOURCE_OVER,this.randomSeed=void 0,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:()=>({brush:this.brush,color:this.color,backgroundColor:this.backgroundColor,blendMode:this.blendMode,randomSeed:this.initialRandomSeed}),enumerable:!0})}configure(e){e.brush&&(this.brush=e.brush),e.color&&(this.color=e.color),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.blendMode&&(this.blendMode=e.blendMode),this.brush instanceof It&&isFinite(e.randomSeed)&&(this.initialRandomSeed=e.randomSeed),this.restart=!0}draw(e,t=!1){if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),e instanceof Ct){let t=e,r=Tt.SOURCE_OVER;if(t.renderMode&&(r=Ct.RenderMode.getBlendMode(t.renderMode),!r))return void console.warn(`Cannot process ${t.renderMode} render mode. Requres custom processing.`);this.blendMode=r;let i=this.layer.draw(t);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(this.validate(e)){let t=this.brush instanceof It?this.strokeLastRendererdDrawContext:this.color,r=this.layer.drawStroke(this.brush,e,t);r&&(this.incompleteStrokeBounds=r.union(this.incompleteStrokeBounds),this.strokeBounds=r.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,t&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}drawPreliminary(e){if(!this.validate(e))return;let t=null,r=null;this.brush instanceof It?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),t=this.strokePrelimLastRenderedDrawContext):t=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.clear()),r=this.preliminaryLayer):r=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:Tt.COPY,rect:this.updatedArea}),this.preliminaryDirtyArea=r.drawStroke(this.brush,e,t),this.updatedArea=I.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}abort(){this.restart=!0}reset(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof It?(this.strokeLastRendererdDrawContext=new Ut(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new Ut),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}validate(e){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return!!e}blendUpdatedArea(e){if(!this.updatedArea)return;let t=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=e||this.canvas,i=r.bounds.intersect(this.updatedArea);i&&(i=i.ceil(),"function"==typeof this.streamUpdatedArea?this.stream(t,i,!1):r.blend(t,{mode:this.blendMode,rect:i})),this.incompleteStrokeBounds=null,this.updatedArea=null}blendStroke(e,t,r){if(!this.strokeBounds)return;r||(r=this.blendMode);let i=this.layer,s=e||this.canvas;(t=s.bounds.intersect(t||this.strokeBounds))&&(t=t.ceil(),"function"==typeof this.streamUpdatedArea?this.stream(i,t,!0):s.blend(i,{mode:r,rect:t}))}stream(e,t,r){let i=new OffscreenCanvas(t.width,t.height).getContext("2d"),s=e.readPixels(t,!0),n=i.createImageData(t.width,t.height);n.data.set(s),this.streamUpdatedArea(n,t,r)}toStroke(e){let t=e.getSensorData(),r=e.getSpline(),i=e.getInkPath();r.randomSeed=this.randomSeed;let s=new Ct(this.brush,r,i,t);return t&&(s.sensorDataMapping=t.inkStream.getPipelineMapping()),this.blendMode!=Tt.SOURCE_OVER&&(s.renderMode=Ct.RenderMode.get(this.blendMode)),s}delete(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}class er{constructor(e,t,r){this.subject=e,this.predicate=t,this.object=r}}class tr{constructor(){this.statements=[]}add(...e){e.forEach(e=>this.statements.push(e))}remove(...e){e.forEach(e=>this.statements.remove(e))}addTriple(e,t,r){this.statements.push(new er(e,t,r))}search(e){return this.statements.filter(t=>{let r=!0;return Object.keys(e).forEach(i=>{r=r&&t[i]==e[i]}),r})}}let rr;rr=ENVIRONMENT==EnvironmentType.NODE?require("protobufjs"):protobuf;var ir=rr,sr={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};class nr extends Oe{constructor(e){super(e)}}class or extends nr{constructor(e){let t;super(e),Object.defineProperty(this,"bounds",{get:function(){return t||(t=this.getBounds()),t},set:function(e){t=e},enumerable:!0}),Object.defineProperty(this,"root",{get:function(){let e=this.parent,t=this;for(;e;)t=e,e=e.parent;return t},enumerable:!0})}updateID(e,t){let r=this.root.model;r&&r.updateRegistry(e,t)}getBounds(){return this.content.bounds}invalidateBounds(){this.bounds=void 0}remove(){this.parent.removeChild(this)}}class ar extends or{constructor(e){super(e),this.children=[],Object.defineProperty(this,"content",{value:this.children,enumerable:!0})}getBounds(){let e;return this.children.forEach(t=>{e=e?e.union(t.bounds):t.bounds}),e}appendChild(e,t){if(!(e instanceof or))throw new Error(`Incompatible node found - ${e.constructor.name}. It should be ink model Element.`);if(t<0)throw new Error("Index should be a positive number");let r=e.parent;if(r&&e.parent.children.remove(e),e.parent=this,"number"==typeof t&&t<this.children.length?this.children.insert(t,e):this.children.push(e),!r){let t=this.root.model;t&&t.register(e)}return this.invalidateBounds(),e}removeChild(e){if(!this.children.includes(e))throw new Error("Node was not found");let t=this.root.model;t&&t.unregister(e),this.invalidateBounds(),this.children.remove(e)}remove(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}class hr extends or{constructor(e){super(),Object.defineProperty(this,"content",{value:e,enumerable:!0})}}class lr{constructor(e,t,r){this.model=e,this.type=t||e.type,this.tree=this.createGroup(r),this.tree.model=this,this.register(this.tree)}addPath(e,t){return t||(t=this.tree),t.appendChild(this.createElement(e))}createElement(e,t,r){let i=this.model.createElement(e,this);return i.fromPointIndex=t,i.toPointIndex=r,i}createGroup(e){return this.model.createGroup(e,this)}register(e){if(e instanceof ar)e.children.forEach(e=>this.register(e));else if(e instanceof hr){if(e.content instanceof Ct){if(this.type!=lr.Type.STROKE)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of Stroke.`)}else{if(!(e.content instanceof _e))throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be ${this.type.name}.`);if(this.type!=lr.Type.SENSOR_DATA)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of SensorData.`)}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - "+e.content.id)}this.model.index(e),this.updateKnowledgeGraph(e.id)}unregister(e){e instanceof ar&&e.children.forEach(e=>this.unregister(e)),delete this.model.registry[e.id],this.updateKnowledgeGraph(e.id)}updateKnowledgeGraph(e){if(!e)return;let t=this.model.uriBuilder.buildNodeURI(e);if(this.model.registry[e]){if(!this.knowledgeGraph)return;this.model.knowledgeGraph.add(...this.knowledgeGraph.search({subject:t})),this.model.knowledgeGraph.add(...this.knowledgeGraph.search({object:t}))}else this.model.knowledgeGraph.remove(...this.model.knowledgeGraph.search({subject:t})),this.model.knowledgeGraph.remove(...this.model.knowledgeGraph.search({object:t}))}}class dr{constructor(){}setInkModelURI(e){return this.inkModelURI=e,this}setNodeID(e){return this.inkNodeID=e,this}buildNodeURI(e,t){return this.reset().setInkModelURI(t).setNodeID(e).build()}build(){let e="",t="";return this.inkModelURI&&(e=this.fixedEncodeURIComponent(this.inkModelURI),t="/"),t+="node/"+this.inkNodeID,`uim:${e}${t}`}fixedEncodeURIComponent(e){return encodeURIComponent(e).replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}reset(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}class ur{constructor(e=ur.Type.STROKE,t){this.type=e,this.tree=this.createGroup(t),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new tr,this.uriBuilder=new dr,this.registry={},this.registry[this.tree.id]=this.tree,Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:()=>this.type==ur.Type.STROKE?this.content:[],enumerable:!0}),Object.defineProperty(this,"sensorData",{get:()=>this.type==ur.Type.STROKE?this.content.map(e=>e.sensorData).filter(e=>!!e):this.content,enumerable:!0}),Object.defineProperty(this,"brushes",{get:()=>{let e={};return this.strokes.forEach(t=>e[t.brush.name]=this.registry[t.brush.name]||t.brush),Object.values(e)},set:e=>{e.forEach(e=>this.registry[e.name]=e)},enumerable:!0})}addPath(e,t){return t||(t=this.tree),t.appendChild(this.createElement(e))}removePath(e){e.nodeID&&this.registry[e.nodeID].remove()}replacePath(e,t,r){if(!e.nodeID)return;let i=this.getItem(e.nodeID),s=i.parent||this.tree,n=t.map(e=>this.createElement(e)),o=s.children.indexOf(i);if(r){let e=s.appendChild(this.createGroup(),o);n.forEach(t=>e.appendChild(t))}else n.forEach((e,t)=>s.appendChild(e,o+t));this.removePath(e)}createElement(e,t){if(!e)throw new Error("Element content not found");let r=t?t.type:this.type;switch(r){case ur.Type.STROKE:if(!(e instanceof Ct))throw new Error(`Incompatible element content found - ${e.constructor.name}. Content should be instance of Stroke.`);break;case ur.Type.SENSOR_DATA:if(!(e instanceof _e))throw new Error(`Incompatible element content found - ${e.constructor.name}. Content should be instance of SensorData.`);break;default:throw console.warn(r),new Error("Invalid ink model type found")}return new hr(e)}createGroup(e,t){return new ar(e)}getItem(e){return this.registry[e]}register(e){if(e instanceof ar)e.children.forEach(e=>this.register(e));else if(e instanceof hr){if(e.content instanceof Ct){if(this.type!=ur.Type.STROKE)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of Stroke.`)}else{if(!(e.content instanceof _e))throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be ${this.type.name}.`);if(this.type!=ur.Type.SENSOR_DATA)throw new Error(`Incompatible element content found - ${e.content.constructor.name}. Content should be instance of SensorData.`)}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),this.content.push(e.content),this.index(e.content)}this.index(e),e instanceof nr&&!this.keepViews&&this.resetViews()}updateRegistry(e,t){let r=this.registry[e];delete this.registry[e],this.registry[r.id]=r,this.updateKnowledgeGraph(e,t)}unregister(e){e instanceof nr&&this.resetViews(),e instanceof ar?e.children.forEach(e=>this.unregister(e)):e instanceof hr&&(delete e.content.nodeID,delete this.registry[e.content.id],this.content.remove(e.content)),e==this.tree?e.children.clear():delete this.registry[e.id],this.updateKnowledgeGraph(e.id)}updateKnowledgeGraph(e,t){let r=this.uriBuilder.buildNodeURI(e),i=this.uriBuilder.buildNodeURI(t);i?(this.knowledgeGraph.search({subject:r}).forEach(e=>e.subject=i),this.knowledgeGraph.search({object:r}).forEach(e=>e.object=i)):(this.knowledgeGraph.remove(...this.knowledgeGraph.search({subject:r})),this.knowledgeGraph.remove(...this.knowledgeGraph.search({object:r})))}index(e){if(this.registry[e.id])throw new Error(`Cannot register item with id ${e.id}. Already is available item with such identifier.`);this.registry[e.id]=e}createView(e,t,r,i){let s=new lr(this,t,r);return s.name=e,this.views[e]=s,i&&(s.knowledgeGraph=i,s.updateKnowledgeGraph(r)),s}resetViews(){for(let e in this.views)this.views[e].tree.remove(),delete this.views[e]}}ur.createEnum("Type",["STROKE","SENSOR_DATA"]),lr.Type=ur.Type;var cr={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}};class pr{constructor(){this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}encodeInk(e){e&&this.encode(cr.headers.inkChunkFourCC,e)}encode(e,t){let r=e instanceof Uint8Array?e:e.toCharArray().toUint8Array();if(r.length!=cr.fourCCLength)throw new Error(`Invalid fourCC: "${e}"`);if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(r,t))}build(){let e=cr.headers,t=0;this.chunks.unshift(this.createChunk(cr.headers.headChunkFourCC,cr.version)),this.chunks.forEach(e=>{t+=e.length});let r=e.formatFourCC.length+t,i=e.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+r,s=new ArrayBuffer(i);this.fileBytes=new Uint8Array(s),this.dataView=new DataView(s),this.byteOffset=0,this.fileBytes.set(e.riffFourCC,this.byteOffset),this.byteOffset+=e.riffFourCC.length,this.dataView.setUint32(this.byteOffset,r,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.formatFourCC,this.byteOffset),this.byteOffset+=e.formatFourCC.length,this.chunks.forEach(e=>{this.appendChunk(e),this.byteOffset+=e.length})}createChunk(e,t){let r=t.length,i=r%2;return{fourCC:e,bytes:t,size:r,length:e.length+Uint32Array.BYTES_PER_ELEMENT+r+i}}appendChunk(e){this.fileBytes.set(e.fourCC,this.byteOffset);let t=this.byteOffset+e.fourCC.length;this.dataView.setUint32(t,e.size,!0),t+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.bytes,t)}reset(){this.chunks=[],this.fileBytes=null}}class fr{decode(e){let t=cr.headers;this.reset(e);let r=this.byteOffset+t.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=r,r=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;let i=this.dataView.getUint32(this.byteOffset,!0)+r;if(i%2!=0)throw new Error("Invalid RIFF file size");if(i!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=r,r=this.byteOffset+t.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,r),t.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=r;this.byteOffset<i;){let e=this.extractChunk();this.byteOffset+=e.length,Object.equals(e.fourCC,t.headChunkFourCC)?this.version=[e.bytes[0],e.bytes[1],e.bytes[2]]:Object.equals(e.fourCC,t.inkChunkFourCC)?this.ink=e.bytes:this.chunks.push({fourCC:String.fromCharArray(e.fourCC),bytes:e.bytes})}}extractChunk(){let e=this.fileBytes.subarray(this.byteOffset,this.byteOffset+cr.fourCCLength),t=null,r=0,i=0,s=0,n=this.byteOffset+e.length,o=n;return n=o+Uint32Array.BYTES_PER_ELEMENT,r=this.dataView.getUint32(o,!0),o=n,n=o+r,r>0?(t=this.fileBytes.subarray(o,n),t=new Uint8Array(t,t.byteOffset,t.length)):t=new Uint8Array(0),i=e.length+Uint32Array.BYTES_PER_ELEMENT+r,s=i%2,{fourCC:e,bytes:t,size:r,length:i+s}}reset(e){this.fileBytes=e,this.dataView=new DataView(e.buffer),this.byteOffset=0,this.chunks=[]}}const{mat4:gr}=e;class mr{constructor(){mr.format||(mr.format=ir.Root.fromJSON(sr).WacomInkFormat3),this.riffEncoder=new pr,this.riffDecoder=new fr}static encode(e){return e.constructor.encode(e).finish()}async encodeInkModel(e){this.structure=!0;let t=mr.format.InkObject.create({inputData:this.encodeInkInput(e.sensorData),inkData:this.encodeInkData(e.strokes),brushes:await this.encodeBrushes(e.brushes),inkTree:this.encodeNodeTree(e),views:Object.values(e.views).map(e=>this.encodeView(e)),knowledgeGraph:this.encodeKnowledgeGraph(e.knowledgeGraph),transform:this.encodeMat4(e.transform),properties:this.encodeProperties(e.props)});this.structure=!1;let r=mr.encode(t);return this.riffEncoder.reset(),this.riffEncoder.encodeInk(r),this.riffEncoder.data}decodeInkModel(e,t){e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.riffDecoder.decode(e);let r=mr.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=!0,t){let e=this.decodeKnowledgeGraph(r.knowledgeGraph);r.views.forEach(r=>this.decodeView(r,t,e))}else{let e=this.decodeInkInput(r.inputData),i=this.decodeBrushes(r.brushes),s=this.decodeInkData(r.inkData,i,e),n=r.inkTree.first,o=n.type==mr.format.NodeType.STROKE_GROUP?ur.Type.STROKE:ur.Type.SENSOR_DATA,a=n.type==mr.format.NodeType.STROKE_GROUP?s:Object.values(e);t=new ur(o,n.id),this.decodeNodeTree(t,r.inkTree.slice(1),a),r.views.forEach(e=>this.decodeView(e,t)),t.knowledgeGraph=this.decodeKnowledgeGraph(r.knowledgeGraph),t.props=this.decodeProperties(r.properties),t.transform=this.decodeMat4(r.transform),t.brushes=Object.values(i)}return this.structure=!1,t}encodeInkInput(e){let t={},r={},i={},s={},n={};e.forEach(e=>{let o=e.context;t[o.id]||(t[o.id]=o,n[o.environment.id]||(n[o.environment.id]=o.environment),r[o.sensorContext.id]||(r[o.sensorContext.id]=o.sensorContext,o.sensorContext.channelsContexts.forEach(e=>{i[e.device.id]||(i[e.device.id]=e.device),e.inkProvider&&(s[e.inkProvider.id]||(s[e.inkProvider.id]=e.inkProvider))})))});let o=mr.format.InputData.create({sensorData:e.map(e=>this.encodeSensorData(e)),inputContextData:mr.format.InputContextData.create({inputContexts:Object.values(t).map(e=>mr.format.InputContext.create({id:e.id,environmentID:e.environment.id,sensorContextID:e.sensorContext.id})),sensorContexts:Object.values(r).map(e=>mr.format.SensorContext.create({id:e.id,sensorChannelsContext:e.channelsContexts.map(e=>mr.format.SensorChannelsContext.create({id:e.id,channels:e.channels.map(e=>mr.format.SensorChannel.create({id:e.id,type:e.type,metric:mr.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})),samplingRateHint:isFinite(e.samplingRate)?mr.format.Uint32.create({value:e.samplingRate}):void 0,latency:isFinite(e.latency)?mr.format.Uint32.create({value:e.latency}):void 0,inkInputProviderID:e.inkProvider?e.inkProvider.id:null,inputDeviceID:e.device.id}))})),inkInputProviders:Object.values(s).map(e=>mr.format.InkInputProvider.create({id:e.id,type:mr.format.InkInputProviderType[e.type.name],properties:this.encodeProperties(e.props)})),inputDevices:Object.values(i).map(e=>mr.format.InputDevice.create({id:e.id,properties:this.encodeProperties(e.props)})),environments:Object.values(n).map(e=>mr.format.Environment.create({id:e.id,properties:this.encodeProperties(e.props)}))})});return this.structure?o:mr.encode(o)}decodeInkInput(e){if(!e)return;let t=this.structure?e:mr.format.InputData.decode(e),r={},i={},s={},n={},o={};if(t.inputContextData.environments.forEach(e=>{let t=new Me;this.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn(`Environment decode id missmatch - found ${e.id}, expected ${t.id}`),o[t.id]=t}),t.inputContextData.inkInputProviders.forEach(e=>{let t=this.decodeProperties(e.properties),r=new De(De.Type[mr.format.InkInputProviderType[e.type]],t);Object.freeze(r),r.id!=e.id&&console.warn(`InkInputProvider decode id missmatch - found ${e.id}, expected ${r.id}`),n[r.id]=r}),t.inputContextData.inputDevices.forEach(e=>{let t=new Ue;this.decodeProperties(e.properties,t.props),Object.freeze(t),t.id!=e.id&&console.warn(`InputDevice decode id missmatch - found ${e.id}, expected ${t.id}`),s[t.id]=t}),t.inputContextData.sensorContexts.forEach(e=>{let t=new ke;e.sensorChannelsContext.forEach(e=>{let r=new Le(s[e.inputDeviceID],n[e.inkInputProviderID]);e.samplingRateHint&&(r.samplingRate=e.samplingRateHint.value),e.latency&&(r.latency=e.latency.value),e.channels.forEach(e=>{let t=Ne.Metric[mr.format.InkSensorMetricType[e.metric]],i=new Ne(e.type,t,e.resolution,e.min,e.max);i.precision=e.precision,r.add(i),i.id!=e.id&&console.warn(`SensorChannel decode id missmatch - found ${e.id}, expected ${i.id}`)}),t.addContext(r),r.id!=e.id&&console.warn(`SensorChannelsContext decode id missmatch - found ${e.id}, expected ${r.id}`)}),Object.freeze(t),i[t.id]=t,t.id!=e.id&&console.warn(`SensorContext decode id missmatch - found ${e.id}, expected ${t.id}`)}),t.inputContextData.inputContexts.forEach(e=>{let t=new Be(o[e.environmentID],i[e.sensorContextID]);Object.freeze(t),t.id!=e.id&&console.warn(`InputContext decode id missmatch - found ${e.id}, expected ${t.id}`),r[t.id]=t}),this.structure){let e={};return t.sensorData.forEach(t=>e[t.id]=this.decodeSensorData(t,r[t.inputContextID])),e}return t.sensorData.map(e=>this.decodeSensorData(e,r[e.inputContextID]))}encodeSensorData(e){let t=mr.format.SensorData.create({id:e.id,inputContextID:e.context.id,state:mr.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach(e=>{let r={};e.channels.forEach(e=>r[e.id]=[]);for(let t=0;t<e.length;t++){let i=e.get(t);e.channels.forEach(e=>{r[e.id].push(i[re.getPropName(e.name)])})}e.channels.forEach(e=>{if(!("precision"in e))throw new Error("Precision not found for channel with id: "+e.id);let i=mr.format.ChannelData.create({sensorChannelID:e.id}),s=r[e.id],n=10**e.precision,o=Math.round(s[0]*n);i.values.push(o);for(let e=1;e<s.length;e++){let t=Math.round(s[e]*n);i.values.push(t-o),o=t}t.dataChannels.push(i)})}),t}decodeSensorData(e,t){let r=new _e(t);r.id=e.id,r.created=e.created,r.inkState=_e.InkState[mr.format.InkState[e.state]];let i={};return e.dataChannels.forEach(e=>{let r=t.sensorContext.getContextByChannelID(e.sensorChannelID);if(!r)throw new Error("Not found corresponding channel context for data with channelID "+e.sensorChannelID);let s=10**r.get(e.sensorChannelID).precision,n=e.values[0],o=[];o.push(n/s);for(let t=1;t<e.values.length;t++){let r=n+e.values[t];o.push(r/s),n=r}i[e.sensorChannelID]=o}),t.sensorContext.channelsContexts.forEach(e=>{let t=i[e.channels.first.id].length,s=new Fe(e.channels);for(let r=0;r<t;r++)e.channels.forEach(e=>{let t=i[e.id];s.data.push(t[r])});r.add(s)}),r}encodeInkData(e){let t=mr.format.InkData.create({strokes:e.map(e=>this.encodeStroke(e))});return this.structure?t:mr.encode(t)}decodeInkData(e,t,r){if(!e)return;return(this.structure?e:mr.format.InkData.decode(e)).strokes.map(e=>this.decodeStroke(e,t,r))}encodeStroke(e){let t=mr.format.Stroke.create({id:e.id,startParameter:e.ts,endParameter:e.tf});for(let r=0;r<e.length;r++){let i=e.pointAt(r);e.layout.forEach(e=>{switch(e){case x.Property.X:t.splineX.push(i.x);break;case x.Property.Y:t.splineY.push(i.y);break;case x.Property.Z:t.splineZ.push(i.z);break;case x.Property.RED:t.red.push(i.red/255);break;case x.Property.GREEN:t.green.push(i.green/255);break;case x.Property.BLUE:t.blue.push(i.blue/255);break;case x.Property.ALPHA:t.alpha.push(i.alpha);break;case x.Property.SIZE:t.size.push(i.size);break;case x.Property.ROTATION:t.rotation.push(i.rotation);break;case x.Property.SCALE_X:t.scaleX.push(i.scaleX);break;case x.Property.SCALE_Y:t.scaleY.push(i.scaleY);break;case x.Property.SCALE_Z:t.scaleZ.push(i.scaleZ);break;case x.Property.OFFSET_X:t.offsetX.push(i.offsetX);break;case x.Property.OFFSET_Y:t.offsetY.push(i.offsetY);break;case x.Property.OFFSET_Z:t.offsetZ.push(i.offsetZ);break;default:throw new Error("Invalid layout property provided: "+e)}})}return e.sensorData&&(t.sensorDataID=e.sensorData.id,t.sensorDataOffset=e.sensorDataOffset,t.sensorDataMapping=e.sensorDataMapping),t.style=mr.format.Style.create({brushURI:e.brush.name,renderModeURI:e.renderMode,particlesRandomSeed:e.randomSeed,properties:this.encodePathPointProperties(e.pointProps)}),t}decodeStroke(e,t={},r={}){if(0==e.splineX.length||0==e.splineY.length)throw new Error("Incomplete path definition");let i=[x.Property.X,x.Property.Y];e.splineZ.length>0&&i.push(x.Property.Z),e.red&&e.red.length>0&&i.push(x.Property.RED),e.green&&e.green.length>0&&i.push(x.Property.GREEN),e.blue&&e.blue.length>0&&i.push(x.Property.BLUE),e.alpha&&e.alpha.length>0&&i.push(x.Property.ALPHA),e.size.length>0&&i.push(x.Property.SIZE),e.rotation.length>0&&i.push(x.Property.ROTATION),e.scaleX.length>0&&i.push(x.Property.SCALE_X),e.scaleY.length>0&&i.push(x.Property.SCALE_Y),e.scaleZ.length>0&&i.push(x.Property.SCALE_Z),e.offsetX.length>0&&i.push(x.Property.OFFSET_X),e.offsetY.length>0&&i.push(x.Property.OFFSET_Y),e.offsetZ.length>0&&i.push(x.Property.OFFSET_Z);let s=e.splineX.length,n=i.length,o=new Float32Array(s*n);for(let t=0;t<s;t++)i.forEach((r,i)=>{let s;switch(r){case x.Property.X:s=e.splineX[t];break;case x.Property.Y:s=e.splineY[t];break;case x.Property.Z:s=e.splineZ[t];break;case x.Property.RED:s=Math.round(255*e.red[t]);break;case x.Property.GREEN:s=Math.round(255*e.green[t]);break;case x.Property.BLUE:s=Math.round(255*e.blue[t]);break;case x.Property.ALPHA:s=e.alpha[t];break;case x.Property.SIZE:s=e.size[t];break;case x.Property.ROTATION:s=e.rotation[t];break;case x.Property.SCALE_X:s=e.scaleX[t];break;case x.Property.SCALE_Y:s=e.scaleY[t];break;case x.Property.SCALE_Z:s=e.scaleZ[t];break;case x.Property.OFFSET_X:s=e.offsetX[t];break;case x.Property.OFFSET_Y:s=e.offsetY[t];break;case x.Property.OFFSET_Z:s=e.offsetZ[t];break;default:throw new Error("Invalid layout property provided: "+r.name)}o[t*n+i]=s});let a=t[e.style.brushURI]||e.style.brushURI,h=this.decodePathPointProperties(e.style.properties),l=r[e.sensorDataID],d=new Ze(i,o,h,e.startParameter,e.endParameter);d.randomSeed=e.style.particlesRandomSeed;let u=new Ct(a,d,void 0,l);return u.id=e.id,u.renderMode=e.style.renderModeURI,u.sensorDataOffset=e.sensorDataOffset,u.sensorDataMapping=e.sensorDataMapping,u}async encodeBrushes(e){let t=mr.format.Brushes.create();for(let r of e)if(r instanceof Ve){let e=this.encodeBrush2D(r);t.vectorBrushes.push(e)}else{let e=await this.encodeBrushGL(r);t.rasterBrushes.push(e)}return this.structure?t:mr.encode(t)}decodeBrushes(e){if(!e)return;let t=this.structure?e:mr.format.Brushes.decode(e),r={};return t.vectorBrushes.forEach(e=>r[e.name]=this.decodeBrush2D(e)),t.rasterBrushes.forEach(e=>r[e.name]=this.decodeBrushGL(e)),this.structure?r:Object.values(r)}encodeBrush2D(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");let t=mr.format.VectorBrush.create({name:e.name,spacing:e.spacing});return(Array.isArray(e.shape)?e.shape:[e.shape]).forEach(e=>{let r=mr.format.BrushPrototype.create({size:e.size});if(e.descriptor.shape.name)r.shapeURI=e.descriptor.shape.name;else for(let t=0;t<e.shape.length;t+=2)r.coordX.push(e.shape[t]),r.coordY.push(e.shape[t+1]);t.prototype.push(r)}),t}decodeBrush2D(e){let t=[];return e.prototype.forEach(e=>{let r;if(e.shapeURI)r=e.shapeURI;else{r=new Float32Array(2*e.coordX.length);for(let t=0;t<r.length/2;t++)r[2*t]=e.coordX[t],r[2*t+1]=e.coordY[t]}t.push(new ze(r,e.size))}),new Ve(e.name,t,e.spacing)}async encodeBrushGL(e){if(!e.name)throw new Error("Encode BrushGL failed. name property is required.");let t={shape:[],shapeURI:[],fill:void 0,filleURI:void 0};if(Array.isArray(e.shape)){let r=e.descriptor.shape.map(e=>e.name).filter(e=>e);if(r.length>0){if(r.length!=e.shape.length)throw new Error(`Brush ${e.name} shape names length do not match with brush mipmap`);t.shapeURI=r}}else e.descriptor.shape.name&&t.shapeURI.push(e.descriptor.shape.name);if(t.fillURI=e.descriptor.fill.name,0==t.shapeURI.length||!t.fillURI){let r=await _(e);0==t.shapeURI.length&&(Array.isArray(e.shape)?t.shape=r.shape:t.shape.push(r.shape)),t.fillURI||(t.fill=r.fill)}let r=e.blendMode.replace(/-/g,"_").toUpperCase();return mr.format.RasterBrush.create({name:e.name,spacing:e.spacing,scattering:e.scattering,blendMode:mr.format.BlendMode[r],rotationMode:mr.format.RotationMode[e.rotationMode.name],shapeTexture:t.shape,shapeTextureURI:t.shapeURI,fillTexture:t.fill,fillTextureURI:t.fillURI,fillWidth:e.fillTextureSize.width,fillHeight:e.fillTextureSize.height,randomizeFill:e.randomizeFill})}decodeBrushGL(e){let t,r;if(e.shapeTextureURI.length>0)t=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map(e=>({name:e}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");t=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map(e=>({value:e}))}if(e.fillTextureURI)r={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");r={value:e.fillTexture}}return new It(e.name,t,r,{spacing:e.spacing,scattering:e.scattering,blendMode:Tt[mr.format.BlendMode[e.blendMode]],rotationMode:It.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}encodeView(e){return mr.format.View.create({name:e.name,tree:this.encodeNodeTree(e)})}decodeView(e,t,r){let i=e.tree.first,s=i.type==mr.format.NodeType.STROKE_GROUP?ur.Type.STROKE:ur.Type.SENSOR_DATA,n=i.type==mr.format.NodeType.STROKE_GROUP?t.strokes:t.sensorData;if(!t.views[e.name]||t.views[e.name].tree.id!=e.tree[0].id){let o=t.createView(e.name,s,i.name,r);this.decodeNodeTree(o,e.tree.slice(1),n)}}encodeNodeTree(e){let t=[];return t.push(this.encodeNode(e.type,e.tree,0)),this.addChildren(t,e,e.tree.children,1),t}addChildren(e,t,r,i){r.forEach(r=>{let s=r instanceof hr?(t.model||t).content.indexOf(r.content):void 0;e.push(this.encodeNode(t.type,r,i,s)),r instanceof ar&&this.addChildren(e,t,r.children,i+1)})}encodeNode(e,t,r,i){let s=e.name;return t instanceof ar&&(s+="_GROUP"),mr.format.Node.create({id:t.id,type:mr.format.NodeType[s],depth:r,index:i,groupBoundingBox:t.bounds,chunkFromIndex:t.fromPointIndex,chunkToIndex:t.toPointIndex})}decodeNodeTree(e,t,r){let i=e.tree,s=0;for(let n of t){for(;s>=n.depth;)i=i.parent,s--;if(n.type==mr.format.NodeType.STROKE_GROUP||n.type==mr.format.NodeType.SENSOR_DATA_GROUP)i=i.appendChild(e.createGroup(n.id)),n.groupBoundingBox&&(i.bounds=I.create(n.groupBoundingBox.x,n.groupBoundingBox.y,n.groupBoundingBox.width,n.groupBoundingBox.height));else{let t;t=n.chunkToIndex>n.chunkFromIndex?e.createElement(r[n.index],n.chunkFromIndex,n.chunkToIndex):e.createElement(r[n.index]),t.id=n.id,i=i.appendChild(t)}s=n.depth}}encodeProperties(e){return Object.keys(e).map(t=>mr.format.Property.create({name:t,value:e[t]}))}decodeProperties(e,t={}){return e.forEach(e=>t[e.name]=e.value),t}encodeKnowledgeGraph(e){if(!e)return;let t=mr.format.TripleStore.create({statements:e.statements.map(e=>mr.format.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object}))});return this.structure?t:mr.encode(t)}decodeKnowledgeGraph(e){if(!e)return;let t=new tr,r=this.structure?e:mr.format.TripleStore.decode(e);return r&&r.statements.forEach(e=>t.addTriple(e.subject,e.predicate,e.object)),t}encodeMat4(e){if(e)return mr.format.Matrix4.create({m00:e[l.m00],m01:e[l.m01],m02:e[l.m02],m03:e[l.m03],m10:e[l.m10],m11:e[l.m11],m12:e[l.m12],m13:e[l.m13],m20:e[l.m20],m21:e[l.m21],m22:e[l.m22],m23:e[l.m23],m30:e[l.m30],m31:e[l.m31],m32:e[l.m32],m33:e[l.m33]})}decodeMat4(e){if(e)return gr.fromValues(e.m00,e.m01,e.m02,e.m03,e.m10,e.m11,e.m12,e.m13,e.m20,e.m21,e.m22,e.m23,e.m30,e.m31,e.m32,e.m33)}async encodeTool(e,t={},r={},i=Tt.SOURCE_OVER){let s=mr.format.Tool.create({vectorBrush:e instanceof Ve?this.encodeBrush2D(e):void 0,rasterBrush:e instanceof It?await this.encodeBrushGL(e):void 0,context:mr.format.PathPointContext.create({statics:this.encodePathPointProperties(r),dynamics:this.encodePathPointSettings(t)})});if(i!=Tt.SOURCE_OVER){let e=i.replace(/-/g,"_").toUpperCase();s.blendMode=mr.format.BlendMode[e]}return mr.encode(s)}decodeTool(e){if(!e)return;e instanceof ArrayBuffer&&(e=new Uint8Array(e));let t=mr.format.Tool.decode(e);return{brush:"vectorBrush"==t.brush?this.decodeBrush2D(t.vectorBrush):this.decodeBrushGL(t.rasterBrush),blendMode:Tt[mr.format.BlendMode[t.blendMode]],statics:this.decodePathPointProperties(t.context.statics),dynamics:this.decodePathPointSettings(t.context.dynamics)}}encodePathPointProperties(e){let t=mr.format.PathPointProperties.create();for(let r in mr.format.PathPointProperties.fields){let i=e[r];isFinite(i)&&("red"!=r&&"green"!=r&&"blue"!=r||(i/=255),t[r]=mr.format.Float32.create({value:i}))}return t}decodePathPointProperties(e){if(!e)return;let t={};for(let r in mr.format.PathPointProperties.fields){let i=e[r];if(i){let e=i.value;"red"!=r&&"green"!=r&&"blue"!=r||(e=Math.round(255*e)),t[r]=e}}return t}encodePathPointSettings(e){let t=mr.format.PathPointSettings.create();for(let r in mr.format.PathPointSettings.fields)e[r]&&!e[r].disabled&&(t[r]=this.encodePropertySettings(r,e[r]));return t}decodePathPointSettings(e){if(!e)return;let t={};for(let r in mr.format.PathPointSettings.fields)e[r]&&(t[r]=this.decodePropertySettings(e[r]));return t}encodePropertySettings(e,t){let r=t=>{if(t)return mr.format.Range.create({min:t.min,max:t.max,remapURI:this.getActionDescriptorName(e,"Remap",t.remap)})};return mr.format.PropertySettings.create({value:r(t.value),velocity:r(t.velocity),pressure:r(t.pressure),altitude:r(t.altitude),radiusX:r(t.radiusX),radiusY:r(t.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",t.resolve),dependencies:(t.dependencies||[]).map(e=>mr.format.InputPropertyType[e.name])})}getActionDescriptorName(e,t,r){if(r){if("function"==typeof r)throw new Error(`Encode '${e}' property failed. ${t} action name property is required. Please provide ActionDescriptor for it's definition.`);if("string"==typeof r)return r;if(r.name)return r.name;throw new Error(`Encode '${e}' property failed. ${t} action name property is required. Please provide ActionDescriptor for it's definition.`)}}decodePropertySettings(e){let t={},r=(e,r)=>{r&&(t[e]={min:r.min,max:r.max,remap:r.remapURI})};return r("value",e.value),r("velocity",e.velocity),r("pressure",e.pressure),r("altitude",e.altitude),r("radiusX",e.radiusX),r("radiusY",e.radiusY),t.resolve=e.resolveURI,e.dependencies.length>0&&(t.dependencies=e.dependencies.map(e=>Ne.Type[mr.format.InputPropertyType[e]])),t}}class yr{constructor(e){this.tree=e,this.attach()}attach(){"loading"==document.readyState?addEventListener("DOMContentLoaded",e=>this.attach()):(this.canvas=document.getElementById("rbush"),this.ctx=this.canvas.getContext("2d"))}refresh(e){let t=[];yr.allocateSegments(t,this.tree.data,0),this.ctx.clearRect(0,0,this.canvas.width+1,this.canvas.height+1);for(let e=t.length-1;e>=0;e--){let r=t[e];r.hulls?r.hulls.forEach(e=>this.drawShape(e,r.color)):this.drawRect(r.bounds,r.color)}}drawRect(e,t=n.from(128,128,128,.3)){this.ctx.strokeStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.ctx.strokeRect(e.left,e.top,e.width,e.height)}fillRect(e,t=n.from(128,128,128,.3)){this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.ctx.fillRect(e.left,e.top,e.width,e.height)}fillPoint(e,t=5,r=n.BLACK){this.ctx.fillStyle=`rgba(${r.red}, ${r.green}, ${r.blue}, ${r.alpha})`,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}drawShape(e,t=n.from(139,0,139,.5)){this.ctx.strokeStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.drawPath(e),this.ctx.stroke()}fillShape(e,t=n.from(236,189,50,.6)){this.ctx.fillStyle=`rgba(${t.red}, ${t.green}, ${t.blue}, ${t.alpha})`,this.drawPath(e),this.ctx.fill()}drawPath(e){"number"==typeof e[0]&&(e=[e]),this.ctx.beginPath(),e.forEach(e=>{this.ctx.moveTo(e[0],e[1]);for(let t=2;t<e.length;t+=2)this.ctx.lineTo(e[t],e[t+1]);this.ctx.closePath()})}drawRange(e){e.forEach(e=>this.drawRect(e.bounds,n.fromHex("#800080")))}drawIntersection(e,t){this.drawShape(e,n.fromHex("#ffc0cb")),t.forEach(t=>{this.fillShape(t.shape,n.fromHex("#ffff00"));let r=L.intersection(t.shape,e);if(r){let e=r.toPath2D();this.fillShape(e,n.BLACK)}})}drawSelection(e,t,r){this.fillRect(e),this.fillShape(t,n.from(139,0,139,.5)),this.fillShape(r)}static allocateSegments(e,t,r){if(t){if(t.bounds){let r=t;1==t.depth?r.color=n.RED:2==t.depth?r.color=n.BLUE:3==t.depth?r.color=n.RED:4==t.depth?r.color=n.GREEN:t.depth,e.push(r)}if(t.children)if(10!==r)for(let i=0;i<t.children.length;i++)yr.allocateSegments(e,t.children[i],r+1);else console.warn("depth 10")}}static getInstance(e){return yr.instance||(yr.instance=new yr(e)),yr.instance}}class Er extends t{constructor(...e){super(...e),this.detachCanvas()}toBBox(e){return{minX:e.bounds.left,minY:e.bounds.top,maxX:e.bounds.right,maxY:e.bounds.bottom}}compareMinX(e,t){return e.bounds.x-t.bounds.x}compareMinY(e,t){return e.bounds.y-t.bounds.y}search(e){return super.search({minX:e.left,minY:e.top,maxX:e.right,maxY:e.bottom})}find(e,t=this.data,r=0,i=[]){if(t){if(t.stroke){let r=!0;Object.keys(e).forEach(i=>{r=r&&t[i]==e[i]}),r&&i.push(t)}if(t.children){if(6!==r){for(let s=0;s<t.children.length;s++)this.find(e,t.children[s]||null,r+1,i);return i}console.warn("depth 6")}}}attachCanvas(){this.canvas=yr.getInstance(this)}detachCanvas(){this.canvas={},Object.getOwnPropertyNames(yr.prototype).filter(e=>!["constructor","attach"].includes(e)).forEach(e=>{this.canvas[e]=()=>{}})}}class br{constructor(){this.tree=new Er,this.strokes={},this.brushAppliers={},this.nodes={}}add(e){if(e.brush instanceof It)return;this.strokes[e.id]=e;let t=this.buildStrokeSegments(e);this.load(t)}buildStrokeSegments(e){let t=[];this.nodes[e.id]=t;for(let r=0;r<e.segmentsCount;r++){let i=this.buildStrokeSegment(e,r);t.push(i)}return t}buildStrokeSegment(e,t){if(t<0||t>=e.segmentsCount)throw new Error(`Invalid index ${t} found. Ensure that index range is {0, ${e.segmentsCount-1}}.`);const r=.166666666666;let i=e.getSegment(t),s=i.getPoint(0),n=i.getPoint(1),o=i.getPoint(2),a=i.getPoint(3),h=-r*s.x+n.x+r*o.x,l=-r*s.y+n.y+r*o.y,d=+r*n.x+o.x-r*a.x,u=+r*n.y+o.y-r*a.y,c=n.asArray(e.layout).concat(o.asArray(e.layout)),p=new qe(e.layout,c,e.pointProps),f=this.getBrushApplier(e.id).get(p),g=I.ofPolygon(f.first),m=I.ofPolygon(f.last),y=Math.max(g.width,m.height),E=Math.max(g.height,m.height),b=Math.max(y,E),x=I.create(h-b/2,l-E/2,b,b),P=I.create(d-b/2,u-E/2,b,b),w=g.union(m).union(x).union(P);return{strokeID:e.id,segmentIndex:t,bounds:w,point:i.getPoint(0),spline:i,shapesPath:f,depth:1}}getStroke(e){return this.strokes[e]}getBrushApplier(e){let t=this.strokes[e].brush;return this.brushAppliers[t.name]||(this.brushAppliers[t.name]=new ut(t)),this.brushAppliers[t.name]}getNodes(e){return this.nodes[e]}reload(e){this.unload(this.nodes[e.id]);let t=this.buildStrokeSegments(e);this.load(t)}remove(e){this.unload(this.nodes[e.id]),delete this.nodes[e.id],delete this.strokes[e.id]}update(e){let t={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(e).forEach(r=>{let i=this.strokes[r],s=this.split(i,e[r]);s&&(t.intersected.push({stroke:i,strokes:s}),t.dirtyArea=i.bounds.union(t.dirtyArea),e[r].intervals.forEach((e,r)=>{e.inside&&t.selected.push(s[r])}))}),t}split(e,t){let{intervals:r,dropoutSegments:i}=t;if(0==r.length)return[];let s=e.split(r);if(!s)return;s.forEach(e=>{this.strokes[e.id]=e});let n=[],o=[];return r.map(t=>this.nodes[e.id].slice(t.fromNodeIndex,t.toNodeIndex+1)).forEach((t,i)=>{let a,h,l=s[i],d=r[i].fromIndex,u=r[i].toIndex-3;if(l.ts!=t.first.spline.ts){let r=t.first.segmentIndex,i=this.nodes[e.id].filter(e=>e.segmentIndex==r);t=t.filter(e=>e.segmentIndex!=r),r>=d&&(a=this.buildStrokeSegment(l,r-d),n.push(a)),o.push(...i)}if(t.length>0&&l.tf!=t.last.spline.tf){let r=t.last.segmentIndex,i=this.nodes[e.id].filter(e=>e.segmentIndex==r);t=t.filter(e=>e.segmentIndex!=r),r<=u&&(h=this.buildStrokeSegment(l,r-d),n.push(h)),o.push(...i)}t.forEach(e=>{e.strokeID=l.id,e.segmentIndex-=d}),a&&t.unshift(a),h&&t.push(h),this.nodes[l.id]=t}),i.push(...o),this.unload(i),this.load(n),delete this.nodes[e.id],delete this.strokes[e.id],s}replace(e,t){t.forEach(e=>this.add(e)),this.remove(e)}load(e){0!=e.length&&(this.tree.load(e),this.tree.canvas.refresh())}updateTree(e,t){this.tree.remove(e),this.nodes[e.strokeID].replace(e,t)}unload(e){Array.isArray(e)||(e=[e]),e.forEach(e=>this.tree.remove(e)),this.tree.canvas.refresh()}search(e){return this.tree.search(e)}reset(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas.refresh()}}class xr{constructor(e){this.interpolator=e}build(e,t,r){return this.context=e,this.pathContext=new N(r),this.result={},this.holes=[],(t=t.unique()).sort(re.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),t.forEach(e=>{this.isHolePart(e)?this.update(e):this.add(e)}),this.narrow(),this.result}add(e){this.holes=this.result[e.strokeID],this.holes||(this.holes=[],this.result[e.strokeID]=this.holes);let t=e.segmentIndex,r=e.segmentIndex,i=this.context.getNodes(e.strokeID).indexOf(e);this.holes.push({fromIndex:t,toIndex:r,fromTValue:e.prevT,toTValue:e.nextT,fromNodeIndex:i,toNodeIndex:i,strokeID:e.strokeID,nodes:[e]})}update(e){let t=this.holes.last;t.toIndex=e.segmentIndex,t.toTValue=e.nextT,t.toNodeIndex=this.context.getNodes(e.strokeID).indexOf(e),t.nodes.push(e)}isHolePart(e){let t=this.holes.last;return!(!t||t.strokeID!=e.strokeID)&&(e.segmentIndex==t.toIndex&&e.prevT<=t.toTValue||e.segmentIndex==t.toIndex+1&&1==t.toTValue&&0==e.prevT)}narrow(){this.holes.forEach(e=>{let t,r=e.nodes.first,i=e.nodes.last;t=e.nodes.length<=2?this.extractT(r,"sf",r.prevT,i.nextT):{s:this.extractT(r,"s",r.prevT,r.nextT).s,f:this.extractT(i,"f",i.prevT,i.nextT).f},r.ts=t.s,i.tf=t.f,e.fromTValue=t.s,e.toTValue=t.f})}extractT(e,t,r,i){if(r==i)return{};let s,n={},o=t.startsWith("s");this.interpolator.spacing=.1;let a=new Ze(e.spline.layout,e.spline.points,e.spline.pointProps,r,i),h=this.interpolator.get(a);for(let r=0;r<h.length;r++){let i=h.getPoint(r),a=this.context.getBrushApplier(e.strokeID).applyBrush(i);if(L.intersection(this.pathContext,a)){if(o){if(n.s=s,t.endsWith("f")){s=h.getPointT(r),o=!1;continue}break}s=h.getPointT(r)}else if(o&&(s=h.getPointT(r)),!o&&(n.f=s,s))break}if(isNaN(n.s)&&(n.s=r),isNaN(n.f)&&(n.f=i),n.s==n.f){let e=h.tValues.indexOf(n.s);0==e?n.f=h.tValues[e+1]:n.s=h.tValues[e-1]}return n}}class Pr{constructor(e=Pr.Mode.WHOLE_STROKE){this.mode=e,this.splineInterpolator=new at(1,8,!1),this.splineInterpolator.keepTValues=!0,this.segmentInterpolator=new at(1,8,!0),this.segmentInterpolator.keepTValues=!0,this.convexHullChainProducer=new ct,this.holesBuilder=new xr(this.segmentInterpolator)}updateSegmentation(e){let t=[],r=!1;for(let i of e){if(0==i.length)continue;let s=I.ofPolygon(i),n=this.context.search(s);if(n.length>0){let o=[];for(let e of n)if(1==e.depth){let t=[],i=this.splineInterpolator.get(e.spline),s=this.context.getBrushApplier(e.strokeID).get(i);for(let r=0;r<i.length-1;r++){let n=[s[r],s[r+1]];t.push({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:r,bounds:I.ofPolygons(n),point:i.getPoint(r),spline:new Ze(e.spline.layout,e.spline.points,e.spline.pointProps,i.getPointT(r),i.getPointT(r+1)),shapesPath:n,depth:2})}this.context.updateTree(e,t),o=o.concat(t),r=!0}else if(2==e.depth){this.convexHullChainProducer.reset();let t=this.convexHullChainProducer.get(e.shapesPath);e.depth=3,e.hulls=t,this.context.tree.canvas.refresh(),r=!0}else if(3==e.depth){if(L.intersection(e.hulls,i))if(this.mode==Pr.Mode.PARTIAL_STROKE){let t=[];this.segmentInterpolator.spacing=1;let i=this.segmentInterpolator.get(e.spline),s=this.context.getBrushApplier(e.strokeID).get(i);for(let r=0;r<i.length;r++){let n=I.ofPolygon(s[r]),o=n,a=e.spline,h=i.getPointT(r),l=i.getPointT(r-1),d=i.getPointT(r+1);if(isNaN(l)&&(l=e.spline.ts),isNaN(d)&&(d=e.spline.tf),n.width!=n.height){let e=Math.max(n.width,n.height);n=I.create(n.center.x-e/2,n.center.y-e/2,e,e)}t.push({strokeID:e.strokeID,segmentIndex:e.segmentIndex,splineIndex:e.splineIndex,pointIndex:r,bounds:n,point:i.getPoint(r),spline:a,prevT:l,t:h,nextT:d,shape:s[r],shapeBounds:o,depth:4})}this.context.updateTree(e,t),o=o.concat(t),r=!0}else t.push(e)}else I.intersect(s,e.bounds)&&(e.affected=!0),t.push(e);if(o.length>0&&this.context.load(o),r)return this.updateSegmentation(e);this.nodes.push(...t)}}}createIntervals(e,t){let r={intersected:{},selected:[]};if(0==t.length)return r;let i=this.holesBuilder.build(this.context,e,t);for(let e in i){let t=this.context.getNodes(e),s=[],n=[];r.intersected[e]={intervals:s,dropoutSegments:n},i[e].forEach((o,a)=>{let h,l=0==o.fromIndex&&o.fromTValue==t.first.ts,d=o.toIndex==t.last.segmentIndex&&o.toTValue==t.last.tf;if(l&&d)return r.selected.push(e),void delete r.intersected[e];n.push(...o.nodes),l?h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}:d?(s.last||s.push({fromIndex:0,fromTValue:t.first.spline.ts,fromNodeIndex:0}),s.last.toIndex=o.fromIndex+3,s.last.toTValue=o.fromTValue,s.last.toNodeIndex=o.fromNodeIndex):s.last?(s.last.toIndex=o.fromIndex+3,s.last.toTValue=o.fromTValue,s.last.toNodeIndex=o.fromNodeIndex,h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}):(s.push({fromIndex:0,fromTValue:t.first.spline.ts,toIndex:o.fromIndex+3,toTValue:o.fromTValue,fromNodeIndex:0,toNodeIndex:o.fromNodeIndex}),h={fromIndex:o.toIndex,fromTValue:o.toTValue,fromNodeIndex:o.toNodeIndex}),h&&s.push(h),a!=i[e].length-1||d||(s.last.toIndex=t.last.segmentIndex+3,s.last.toTValue=t.last.spline.tf,s.last.toNodeIndex=t.length-1);let u=[];s.forEach(e=>{if(1==e.fromTValue){let r=t.filter(t=>t.segmentIndex==e.fromIndex+1).first,i=t.filter(t=>t.segmentIndex==e.fromIndex);n.push(...i),e.fromIndex++,e.fromTValue=0,e.fromNodeIndex=t.indexOf(r)}if(0==e.toTValue){let r=e.toIndex-3,i=t.filter(e=>e.segmentIndex==r-1).last,s=t.filter(e=>e.segmentIndex==r);n.push(...s),e.toIndex--,e.toTValue=1,e.toNodeIndex=t.indexOf(i)}if(e.toIndex-e.fromIndex<3)u.push(e);else if(e.toIndex-e.fromIndex==3&&e.fromTValue==e.toTValue){let r=t.filter(t=>t.segmentIndex==e.fromIndex);n.push(...r),u.push(e)}}),u.forEach(e=>{s.remove(e)})})}return r}reset(e){if(!e)throw new Error("Required spatial context not found");this.context=e,this.nodes=[]}}Pr.createEnum("Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);class wr extends Pr{constructor(e){super(e)}intersect2(e){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,e)}intersect(e){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(e),this.mode==wr.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,e):{intersected:{},selected:this.nodes.map(e=>e.strokeID)}}}class Tr extends Pr{constructor(e){super(e)}select(e){if(!this.context)throw new Error("Required spatial context not found");let t={intersected:{},selected:[]},r=e.bounds,i=L.createClipperPath(e.spline);setTimeout(()=>this.context.tree.canvas.drawSelection(r,e.points,e.path.first),1e3);let s=this.context.search(r),n=this.nodes.map(e=>e.strokeID).unique(),o=s.map(e=>e.strokeID).unique().filter(e=>!n.includes(e));if(this.mode==Tr.Mode.PARTIAL_STROKE){let r=this.createIntervals(this.nodes,e.path);t=r,n.forEach(e=>{let t=[];r.intersected[e]&&(t=r.intersected[e].intervals),t.forEach(t=>{let r=this.context.getNodes(e)[t.fromNodeIndex];t.inside=L.containsPoint(i,r.point)})})}else t.selected=n;return o.forEach(e=>{let r=this.context.getNodes(e)[0];L.containsPoint(i,r.point)&&t.selected.push(e)}),t}}export{Tt as BlendMode,Ve as Brush2D,ut as BrushApplier,It as BrushGL,ze as BrushPrototype,n as Color,ct as ConvexHullChainProducer,Je as ConvexHullProducer,Ee as Drag,Me as Environment,Rt as GLTools,mt as InkBuilder,Pt as InkBuilderAsync,Nt as InkCanvas2D,Jt as InkCanvasGL,mr as InkCodec,ie as InkController,De as InkInputProvider,ur as InkModel,Be as InputContext,Ue as InputDevice,oe as InputListener,qe as InterpolatedSpline,wr as Intersector,ee as MatTools,_t as OffscreenCanvasGL,x as PathPoint,He as PathPointContext,Qe as PathProducer,$e as PathSegment,fe as PinchEvent,je as PointerData,L as Poly,pt as PolygonMerger,ft as PolygonSimplifier,I as Rect,be as Resize,Pe as Scalar,Tr as Selector,er as SemanticTriple,Ne as SensorChannel,Le as SensorChannelsContext,ke as SensorContext,_e as SensorData,Fe as SensorStream,Ge as ShapeFactory,rt as Smoother,br as SpatialContext,Ze as Spline,at as SplineInterpolator,it as SplineProducer,Ct as Stroke,Lt as StrokeRenderer2D,Qt as StrokeRendererGL,te as TextTable,me as Transformer,tr as TripleStore,Ye as TypedArrayCodec,s as URIResolver,i as config,F as fsx,y as mat4x,G as math,re as utils};
