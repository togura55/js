var DigitalInk=function(t){"use strict";"undefined"==typeof ClipperLib&&console.warn("digital-ink dependency clipper-lib not found, expected in global scope"),"undefined"==typeof poly2tri&&console.warn("digital-ink dependency poly2tri not found, expected in global scope"),"undefined"==typeof protobuf&&console.warn("digital-ink dependency protobufjs not found, expected in global scope"),"undefined"==typeof md5&&console.warn("digital-ink dependency js-md5 not found, expected in global scope");var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(t,e){return t(e={exports:{}},e.exports),e.exports}var i=r((function(t){function e(n,r){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(n,r)}t.exports=e}));var o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)},a=r((function(t){function e(n){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(n)}t.exports=e}));var s=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t};var u=function(t,e){return!e||"object"!==a(e)&&"function"!=typeof e?s(t):e},c=r((function(t){function e(n){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(n)}t.exports=e}));var h=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")};var l,f=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}},d=r((function(t){function e(n,r,o){return f()?t.exports=e=Reflect.construct:t.exports=e=function(t,e,n){var r=[null];r.push.apply(r,e);var o=new(Function.bind.apply(t,r));return n&&i(o,n.prototype),o},e.apply(null,arguments)}t.exports=e})),p=r((function(t){function e(n){var r="function"==typeof Map?new Map:void 0;return t.exports=e=function(t){if(null===t||!h(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(t))return r.get(t);r.set(t,e)}function e(){return d(t,arguments,c(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i(e,t)},e(n)}t.exports=e}));function y(t){return function(){var e,n=c(t);if(v()){var r=c(this).constructor;e=Reflect.construct(n,arguments,r)}else e=n.apply(this,arguments);return u(this,e)}}function v(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}if("undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:void 0!==n&&(n.globalThis=n)),String.prototype.contains||(String.prototype.contains=function(t){return-1!=this.indexOf(t)}),String.prototype.startsWith||(String.prototype.startsWith=function(t){return this.length>=t.length&&this.substring(0,t.length)==t}),String.prototype.endsWith||(String.prototype.endsWith=function(t){return this.length>=t.length&&this.substring(this.length-t.length,this.length)==t}),String.prototype.charsCode=function(){return this.split("").reduce((function(t,e){return t+e.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(t){return-1!=this.toUpperCase().indexOf(t.toUpperCase())},String.prototype.toCharArray=function(t){for(var e=t?new Uint8Array(this.length):new Array(this.length),n=0;n<this.length;n++){var r=this.charCodeAt(n);r>255&&(e.bytes=!1),e[n]=r}return e},String.fromCharArray=function(t){var e="";try{e=String.fromCharCode.apply(null,t)}catch(r){for(var n=0;n<t.length;n++)e+=String.fromCharCode(t[n])}return e},String.prototype.pad=function(t,e){return this.length<t?new Array(t-this.length+1).join(e||"-")+this:this.toString()},Number.prototype.pad=function(t){return String(this).length<t?new Array(t-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){var t=new Float32Array(1);return t[0]=this,t[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(t){return this.indexOf(t)>-1},Array.prototype.clone=function(){return this.map((function(t){return Object.clone(t)}))},Array.prototype.unique=function(){var t=this;return this.filter((function(e,n){return t.indexOf(e)==n}))},Array.prototype.add=function(t){if(!this.contains(t))return this.push(t)},Array.prototype.insert=function(t,e){this.splice(t,0,e)},Array.prototype.remove=function(t){return this.removeAt(this.indexOf(t))},Array.prototype.removeAt=function(t){return t>-1&&this.splice(t,1),this},Array.prototype.replace=function(t,e,n){var r=this.indexOf(t);if(r>-1)if(!n&&e instanceof Array){for(var i=[r,1],o=0;o<e.length;o++)i.push(e[o]);this.splice.apply(this,i)}else this.splice(r,1,e);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach((function(t){var e=globalThis[t+"Array"];e?(e.from?Array.prototype["to"+t+"Array"]=function(){return e.from(this)}:Array.prototype["to"+t+"Array"]=function(){return new e(this)},Array.from?e.prototype.toArray=function(){return Array.from(this)}:e.prototype.toArray=function(){return Array.prototype.slice.call(this)},e.prototype.clone=function(){return new e(this,this.byteOffset,this.length)},e.prototype.concat=function(){for(var t=this,e=this.length,n=this.length,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];i.forEach((function(n){if(t.constructor!=n.constructor)throw new Error("Concat array from wrong type detected - expected ".concat(t.constructor.name,", found ").concat(n.constructor.name));e+=n.length}));var a=new this.constructor(e);return a.set(this),i.forEach((function(t){a.set(t,n),n+=t.length})),a}):console.warn(t+"Array not found")}))},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(t,e){e||(e=function(){});var n=e.getArguments(),r=new Function("body","return function "+t+"("+n+") {return body.apply(this, arguments);};")(e);return r.toString=function(){return e.toString()},r.toSource=function(){return e.toSource()},r},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){var t=this.toString().match(/^function\s([\w$]+)/);return t?t[1]:""}}),Function.prototype.getArguments=function(){var t=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==t.length?[]:t.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(t){var e=arguments.callee.caller.arguments;this.getArguments().forEach((function(t,n){this[t]=e[n]}),t)},Function.prototype.createEnum=function(t,e){var n=this;if(this[t])throw new Error("Already exists key: "+t);this[t]=new Object;for(var r=[],i=function(i){var o,a=t+"_"+e[i],s=n[t];s[e[i]]=(o=Object.create(Object.prototype,{constructor:{value:Function.create(a)},type:{value:t},name:{value:e[i]},value:{value:i}}),Object.defineProperty(s,i,{get:function(){return o}}),o),r.push(s[e[i]])},o=0;o<e.length;o++)i(o);Object.defineProperty(this[t],"values",{value:r})},Object.equals=function(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;if(t instanceof Array||ArrayBuffer.isTypedArray(t))return t.length==e.length&&t.every((function(t,n){return Object.equals(t,e[n])}));for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!==a(t[n]))return!1;if(!Object.equals(t[n],e[n]))return!1}}for(var r in e)if(e.hasOwnProperty(r)&&!t.hasOwnProperty(r))return!1;return!0},Object.clone=function(t,e){var n=new Array;return function t(r){if(null===r)return null;if("object"!==a(r)||r.mutable)return r;if("function"==typeof r.clone)return r.clone();for(var i=0;i<n.length;i++)if(n[i][0]===r)return n[i][1];var o=Object.create(Object.getPrototypeOf(r));for(var s in n.push([r,o]),r)e&&"function"==typeof r[s]||r.hasOwnProperty(s)&&(o[s]=t(r[s]));return o}(t)},Object.toSource=function(t,e){if(t&&"object"==a(t)){var n=[];for(var r in t)t.hasOwnProperty(r)&&n.push("".concat(r,": ").concat(Object.toSource(t[r])));return(e?"".concat(e," = "):"")+"{"+n.join(", ")+"};"}if("function"==typeof t){var i=t.toString();return 0!=i.indexOf("function")&&(i="function "+i),i}return t},Object.nameAnonymousFunctions=function(t,e){for(var n in t)"function"!=typeof t[n]||t[n].name||("constructor"==n&&e?Object.defineProperty(t[n],"name",{value:e}):Object.defineProperty(t[n],"name",{value:n}))},JSON.toBase64=function(t){return btoa(JSON.stringify(t))},JSON.fromBase64=function(t){return JSON.parse(atob(t))},JSON.encode=function(t){return JSON.toBase64(t).toCharArray(!0)},JSON.decode=function(t){var e=String.fromCharArray(t);return JSON.fromBase64(e)},Math.toDegrees=function(t){return t*(180/this.PI)},Math.toRadians=function(t){return t*(this.PI/180)},Math.randomInt=function(t,e){return Math.floor(this.random()*(e-t+1))+t},("undefined"!=typeof ENVIRONMENT||(l="object"===("undefined"==typeof window?"undefined":a(window))?"WEB":"function"==typeof importScripts?"WORKER":"object"===("undefined"==typeof process?"undefined":a(process))?"NODE":"SHELL",Function.prototype.createEnum.call(globalThis,"EnvironmentType",["WEB","WORKER","NODE","SHELL"]),Object.defineProperty(globalThis,"ENVIRONMENT",{value:EnvironmentType[l],enumerable:!0})),ENVIRONMENT)==EnvironmentType.WEB){if(HTMLElement.prototype.getInlineStyle=function(t){return this.style[t]||this.style["-webkit-"+t]||this.style["-khtml-"+t]||this.style["-moz-"+t]||this.style["-ms-"+t]||this.style["-o-"+t]||""},HTMLElement.prototype.setStyle=function(t,e){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(n){this.style[n+"-"+t]=e}),this),this.style[t]=e},HTMLElement.prototype.getStyle=function(t){var e=t,n=t.startsWith("-");n&&(e=t.substring(1));for(var r=e.split("-"),i=r.length-1;i>0;i--)r[i]=r[i].substring(0,1).toUpperCase()+r[i].substring(1);e=r.join("");var o=window.getComputedStyle?document.defaultView.getComputedStyle(this,null)[e]:this.currentStyle[e];if(!n&&void 0===o)for(var a=["-webkit","-khtml","-moz","-ms","-o"],s=0;s<a.length&&"undefined"==(o=this.getStyle(a[s]+"-"+t));s++);return o},HTMLElement.prototype.getMathStyle=function(t,e){var n=e?this.getInlineStyle(t):this.getStyle(t);return"auto"==n&&(n=0),parseFloat(n)},HTMLElement.prototype.getTransformStyle=function(){var t={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},e=this.getStyle("transform");if("none"!=e){var n=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),r=parseFloat(n[0]),i=parseFloat(n[1]),o=parseFloat(n[2]),a=parseFloat(n[3]),s=parseFloat(n[4]),u=parseFloat(n[5]);t.scale={x:Math.sqrt(r*r+o*o),y:Math.sqrt(a*a+i*i)},t.skew={angleX:Math.tan(o),angleY:Math.tan(i)},t.rotate={angle:Math.atan2(i,r)},t.translate={x:s,y:u},t.matrix={a:r,b:i,c:o,d:a,tx:s,ty:u}}return t},HTMLElement.prototype.toRect=function(){var t=new Object,e=this.getBoundingClientRect();return t.width=this.offsetWidth,t.height=this.offsetHeight,t.left=this.offsetLeft,t.top=this.offsetTop,t.right=t.left+t.width,t.bottom=t.top+t.height,t.scaleFactor=Math.max(t.width,t.height)/Math.min(t.width,t.height),t.offsetWidth=this.offsetWidth,t.offsetHeight=this.offsetHeight,t.fullWidth=this.offsetWidth+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),t.fullHeight=this.offsetHeight+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom"),t.center={x:t.width/2,y:t.height/2},t.rotationFrameWidth=e.width,t.rotationFrameHeight=e.height,t.rotationCenter={x:e.width/2,y:e.height/2},Object.defineProperty(t,"x",{value:t.left,enumerable:!0}),Object.defineProperty(t,"y",{value:t.top,enumerable:!0}),t.centerOnParent={x:t.left+t.rotationCenter.x,y:t.top+t.rotationCenter.y},t.centerOnScreen={x:e.left+t.rotationCenter.x,y:e.top+t.rotationCenter.y},t},HTMLImageElement.prototype.toDataURL=function(t){var e=document.createElement("canvas");return e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0),e.toDataURL(t||"image/png")},HTMLImageElement.prototype.toBlob=function(t){return new Blob([this.getBytes(t).buffer],{type:t||"image/png"})},HTMLImageElement.prototype.getBytes=function(t){var e=this.toDataURL(t).split(",")[1];return atob(e).toCharArray(!0)},Image.fromBytes=function(t,e,n){var r=new Image;return r.onload=function(){URL.revokeObjectURL(this.src),e&&e.call(this)},r.src=URL.createObjectURL(new Blob([t.buffer||t],{type:"image/"+(n||"png")})),r},CanvasRenderingContext2D.prototype.clearCanvas=function(t){this.clearRect(0,0,this.canvas.width,this.canvas.height),t&&(this.fillStyle=t,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,n},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}var t=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}var t=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}),function(){try{"x"in document.createElement("div").getBoundingClientRect()||Object.extend(HTMLElement.prototype,{getBoundingClientRect:function(){var t=this.super.getBoundingClientRect();return t.x=t.left,t.y=t.top,t}})}catch(t){}}(),"undefined"==typeof createImageBitmap&&(window.createImageBitmap=function(t){return new Promise((function(e,n){var r,i=new Image;i.crossOrigin="anonymous",t instanceof HTMLCanvasElement?t.toBlob((function(t){r=t,i.src=URL.createObjectURL(r)})):t instanceof Blob?(r=t,i.src=URL.createObjectURL(r)):i.src=t,i.onload=function(){r&&URL.revokeObjectURL(r),e(i)},i.onerror=n}))}),"undefined"==typeof PointerEvent){var m=function(t){o(r,t);var n=y(r);function r(){return e(this,r),n.apply(this,arguments)}return r}(p(Event));window.PointerEvent=m}if("undefined"==typeof TouchEvent){var g=function(t){o(r,t);var n=y(r);function r(){return e(this,r),n.apply(this,arguments)}return r}(p(Event));window.TouchEvent=g}}var b={DEBUG:!1,GL_ANTI_ALIASING_SIZE:1.25,stroke:{generateID:void 0},setOwnBackbuffer:function(t){this.ownBackbuffer=t},setDefaultLayerSize:function(t,e){if(t>4e3)throw new Error("Max texture size width (4000) exceeded: ".concat(t));if(e>4e3)throw new Error("Max texture size height (4000) exceeded: ".concat(e));e||(e=t),this.DEFAULT_LAYER_SIZE={width:t,height:e}},setDefaultScaleFactor:function(t){if(!(t>0&&t<=1))throw new Error("Scale factor should be a number between 0 and 1: ".concat(t));this.DEFAULT_SCALE_FACTOR=t}};var x=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r};var E=function(t){if(Array.isArray(t))return x(t)};var w=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var R=function(t,e){if(t){if("string"==typeof t)return x(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?x(t,e):void 0}};var P=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var k=function(t){return E(t)||w(t)||R(t)||P()};function M(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var T,I=function(t,e,n){return e&&M(t.prototype,e),n&&M(t,n),t},S=function(){function t(){if(e(this,t),T)throw new Error("URIResolver instance already available");T=this,this.init()}return I(t,[{key:"init",value:function(){throw new Error("URIResolver: init should be implemented")}},{key:"get",value:function(t){return this[t]}},{key:"register",value:function(t,e){this[t]=e}},{key:"resolve",value:function(t){var e;if(t.includes("?")){var n=this[t.split("?")[0]];if(n){var r=t.split("?")[1],i=[];r.split("&").forEach((function(t){var e=t.split("=")[1],n=parseFloat(e);isFinite(n)?e=n:"true"==e?e=!0:"false"==e&&(e=!1),i.push(e)})),e=function(){return n.apply(void 0,k(Array.from(arguments).concat(i)))}}}else e=this[t];if(!e)throw new Error("Failed to resolve ".concat(t));return e}}]),t}();Object.defineProperty(S,"instance",{get:function(){return T},enumerable:!0});var A={TRANSPERENT:{red:0,green:0,blue:0,alpha:0},BLACK:{red:0,green:0,blue:0,alpha:1},WHITE:{red:255,green:255,blue:255,alpha:1},RED:{red:255,green:0,blue:0,alpha:1},GREEN:{red:0,green:255,blue:0,alpha:1},BLUE:{red:0,green:0,blue:255,alpha:1},init:function(t){t.ready||(Object.defineProperty(t,"ready",{value:!0}),Object.defineProperty(t,"asRGB",{get:function(){return A.from(this.red,this.green,this.blue)}}),Object.defineProperty(t,"asHSLA",{get:function(){return A.toHSLA(this)}}),Object.defineProperty(t,"asHex",{get:function(){return A.toHex(this)}}),Object.defineProperty(t,"asArray",{get:function(){return A.toArray(this)}}))},from:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=t;if(t instanceof Array){var o=t;i=o[0],e=o[1],n=o[2],r=o[3]}var a={red:i,green:e,blue:n,alpha:r};return this.init(a),a},premultiply:function(t){return{red:t.red/255*t.alpha,green:t.green/255*t.alpha,blue:t.blue/255*t.alpha,alpha:t.alpha}},postdivide:function(t,e,n,r){var i=parseInt(255*t/r),o=parseInt(255*e/r),a=parseInt(255*n/r);return A.from(i,o,a,r)},equals:function(t,e){return!(!A.is(t)&&!A.is(e))&&(t.red==e.red&&t.green==e.green&&t.blue==e.blue&&t.alpha==e.alpha)},is:function(t){return t&&"red"in t&&"green"in t&&"blue"in t},toArray:function(t){return[t.red,t.green,t.blue,t.alpha]},fromHSLA:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3?arguments[3]:void 0;t/=60,e/=100,n/=100;var i=(1-Math.abs(2*n-1))*e,o=i*(1-Math.abs(t%2-1)),a=0,s=0,u=0;t>=0&&t<1?(a=i,s=o):t>=1&&t<2?(a=o,s=i):t>=2&&t<3?(s=i,u=o):t>=3&&t<4?(s=o,u=i):t>=4&&t<5?(a=o,u=i):(a=i,u=o);var c=n-i/2;return a+=c,s+=c,u+=c,A.from(Math.round(255*a),Math.round(255*s),Math.round(255*u),r)},toHSLA:function(t){var e=t.red/255,n=t.green/255,r=t.blue/255,i=Math.min(e,n,r),o=Math.max(e,n,r),a=0,s=0,u=(o+i)/2;if(o!=i){var c=o-i;switch(s=c/(1-Math.abs(2*u-1)),o){case e:a=(n-r)/c%6;break;case n:a=(r-e)/c+2;break;case r:a=(e-n)/c+4}}return(a*=60)<0&&(a+=360),{hue:parseFloat(a.toFixed(0)),saturation:parseFloat((100*s).toFixed(2)),lightness:parseFloat((100*u).toFixed(2)),alpha:t.alpha}},fromHex:function(t){return t=t.substring(1),A.from(parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16))},toHex:function(t){return"#"+t.red.toString(16).pad(2,"0")+t.green.toString(16).pad(2,"0")+t.blue.toString(16).pad(2,"0")},random:function(t){return A.from(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),t?Math.random():1)}};!function(){for(var t in A)"object"==a(A[t])&&A.init(A[t])}();var C=1e-6,O="undefined"!=typeof Float32Array?Float32Array:Array,D=Math.random;var N=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var L=Object.freeze({__proto__:null,EPSILON:C,get ARRAY_TYPE(){return O},RANDOM:D,setMatrixArrayType:function(t){O=t},toRadian:function(t){return t*N},equals:function(t,e){return Math.abs(t-e)<=C*Math.max(1,Math.abs(t),Math.abs(e))}});function _(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=n[0],h=n[1],l=n[2],f=n[3],d=n[4],p=n[5];return t[0]=r*c+o*h,t[1]=i*c+a*h,t[2]=r*l+o*f,t[3]=i*l+a*f,t[4]=r*d+o*p+s,t[5]=i*d+a*p+u,t}function B(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}var F=_,U=B,j=Object.freeze({__proto__:null,create:function(){var t=new O(6);return O!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new O(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},fromValues:function(t,e,n,r,i,o){var a=new O(6);return a[0]=t,a[1]=e,a[2]=n,a[3]=r,a[4]=i,a[5]=o,a},set:function(t,e,n,r,i,o,a){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=a,t},invert:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=n*o-r*i;return u?(u=1/u,t[0]=o*u,t[1]=-r*u,t[2]=-i*u,t[3]=n*u,t[4]=(i*s-o*a)*u,t[5]=(r*a-n*s)*u,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:_,rotate:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=Math.sin(n),h=Math.cos(n);return t[0]=r*h+o*c,t[1]=i*h+a*c,t[2]=r*-c+o*h,t[3]=i*-c+a*h,t[4]=s,t[5]=u,t},scale:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=n[0],h=n[1];return t[0]=r*c,t[1]=i*c,t[2]=o*h,t[3]=a*h,t[4]=s,t[5]=u,t},translate:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=n[0],h=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=r*c+o*h+s,t[5]=i*c+a*h+u,t},fromRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=-n,t[3]=r,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t},subtract:B,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=e[0],c=e[1],h=e[2],l=e[3],f=e[4],d=e[5];return Math.abs(n-u)<=C*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(r-c)<=C*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(i-h)<=C*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(o-l)<=C*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(a-f)<=C*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(s-d)<=C*Math.max(1,Math.abs(s),Math.abs(d))},mul:F,sub:U});function Y(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function X(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=e[8],f=e[9],d=e[10],p=e[11],y=e[12],v=e[13],m=e[14],g=e[15],b=n[0],x=n[1],E=n[2],w=n[3];return t[0]=b*r+x*s+E*l+w*y,t[1]=b*i+x*u+E*f+w*v,t[2]=b*o+x*c+E*d+w*m,t[3]=b*a+x*h+E*p+w*g,b=n[4],x=n[5],E=n[6],w=n[7],t[4]=b*r+x*s+E*l+w*y,t[5]=b*i+x*u+E*f+w*v,t[6]=b*o+x*c+E*d+w*m,t[7]=b*a+x*h+E*p+w*g,b=n[8],x=n[9],E=n[10],w=n[11],t[8]=b*r+x*s+E*l+w*y,t[9]=b*i+x*u+E*f+w*v,t[10]=b*o+x*c+E*d+w*m,t[11]=b*a+x*h+E*p+w*g,b=n[12],x=n[13],E=n[14],w=n[15],t[12]=b*r+x*s+E*l+w*y,t[13]=b*i+x*u+E*f+w*v,t[14]=b*o+x*c+E*d+w*m,t[15]=b*a+x*h+E*p+w*g,t}function G(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=r+r,u=i+i,c=o+o,h=r*s,l=r*u,f=r*c,d=i*u,p=i*c,y=o*c,v=a*s,m=a*u,g=a*c;return t[0]=1-(d+y),t[1]=l+g,t[2]=f-m,t[3]=0,t[4]=l-g,t[5]=1-(h+y),t[6]=p+v,t[7]=0,t[8]=f+m,t[9]=p-v,t[10]=1-(h+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function z(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function V(t,e){var n=e[0],r=e[1],i=e[2],o=e[4],a=e[5],s=e[6],u=e[8],c=e[9],h=e[10];return t[0]=Math.hypot(n,r,i),t[1]=Math.hypot(o,a,s),t[2]=Math.hypot(u,c,h),t}function H(t,e){var n=new O(3);V(n,e);var r=1/n[0],i=1/n[1],o=1/n[2],a=e[0]*r,s=e[1]*i,u=e[2]*o,c=e[4]*r,h=e[5]*i,l=e[6]*o,f=e[8]*r,d=e[9]*i,p=e[10]*o,y=a+h+p,v=0;return y>0?(v=2*Math.sqrt(y+1),t[3]=.25*v,t[0]=(l-d)/v,t[1]=(f-u)/v,t[2]=(s-c)/v):a>h&&a>p?(v=2*Math.sqrt(1+a-h-p),t[3]=(l-d)/v,t[0]=.25*v,t[1]=(s+c)/v,t[2]=(f+u)/v):h>p?(v=2*Math.sqrt(1+h-a-p),t[3]=(f-u)/v,t[0]=(s+c)/v,t[1]=.25*v,t[2]=(l+d)/v):(v=2*Math.sqrt(1+p-a-h),t[3]=(s-c)/v,t[0]=(f+u)/v,t[1]=(l+d)/v,t[2]=.25*v),t}function W(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}var q=X,Z=W,K=Object.freeze({__proto__:null,create:function(){var t=new O(16);return O!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new O(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fromValues:function(t,e,n,r,i,o,a,s,u,c,h,l,f,d,p,y){var v=new O(16);return v[0]=t,v[1]=e,v[2]=n,v[3]=r,v[4]=i,v[5]=o,v[6]=a,v[7]=s,v[8]=u,v[9]=c,v[10]=h,v[11]=l,v[12]=f,v[13]=d,v[14]=p,v[15]=y,v},set:function(t,e,n,r,i,o,a,s,u,c,h,l,f,d,p,y,v){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=a,t[6]=s,t[7]=u,t[8]=c,t[9]=h,t[10]=l,t[11]=f,t[12]=d,t[13]=p,t[14]=y,t[15]=v,t},identity:Y,transpose:function(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],o=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],c=e[7],h=e[8],l=e[9],f=e[10],d=e[11],p=e[12],y=e[13],v=e[14],m=e[15],g=n*s-r*a,b=n*u-i*a,x=n*c-o*a,E=r*u-i*s,w=r*c-o*s,R=i*c-o*u,P=h*y-l*p,k=h*v-f*p,M=h*m-d*p,T=l*v-f*y,I=l*m-d*y,S=f*m-d*v,A=g*S-b*I+x*T+E*M-w*k+R*P;return A?(A=1/A,t[0]=(s*S-u*I+c*T)*A,t[1]=(i*I-r*S-o*T)*A,t[2]=(y*R-v*w+m*E)*A,t[3]=(f*w-l*R-d*E)*A,t[4]=(u*M-a*S-c*k)*A,t[5]=(n*S-i*M+o*k)*A,t[6]=(v*x-p*R-m*b)*A,t[7]=(h*R-f*x+d*b)*A,t[8]=(a*I-s*M+c*P)*A,t[9]=(r*M-n*I-o*P)*A,t[10]=(p*w-y*x+m*g)*A,t[11]=(l*x-h*w-d*g)*A,t[12]=(s*k-a*T-u*P)*A,t[13]=(n*T-r*k+i*P)*A,t[14]=(y*b-p*E-v*g)*A,t[15]=(h*E-l*b+f*g)*A,t):null},adjoint:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],c=e[7],h=e[8],l=e[9],f=e[10],d=e[11],p=e[12],y=e[13],v=e[14],m=e[15];return t[0]=s*(f*m-d*v)-l*(u*m-c*v)+y*(u*d-c*f),t[1]=-(r*(f*m-d*v)-l*(i*m-o*v)+y*(i*d-o*f)),t[2]=r*(u*m-c*v)-s*(i*m-o*v)+y*(i*c-o*u),t[3]=-(r*(u*d-c*f)-s*(i*d-o*f)+l*(i*c-o*u)),t[4]=-(a*(f*m-d*v)-h*(u*m-c*v)+p*(u*d-c*f)),t[5]=n*(f*m-d*v)-h*(i*m-o*v)+p*(i*d-o*f),t[6]=-(n*(u*m-c*v)-a*(i*m-o*v)+p*(i*c-o*u)),t[7]=n*(u*d-c*f)-a*(i*d-o*f)+h*(i*c-o*u),t[8]=a*(l*m-d*y)-h*(s*m-c*y)+p*(s*d-c*l),t[9]=-(n*(l*m-d*y)-h*(r*m-o*y)+p*(r*d-o*l)),t[10]=n*(s*m-c*y)-a*(r*m-o*y)+p*(r*c-o*s),t[11]=-(n*(s*d-c*l)-a*(r*d-o*l)+h*(r*c-o*s)),t[12]=-(a*(l*v-f*y)-h*(s*v-u*y)+p*(s*f-u*l)),t[13]=n*(l*v-f*y)-h*(r*v-i*y)+p*(r*f-i*l),t[14]=-(n*(s*v-u*y)-a*(r*v-i*y)+p*(r*u-i*s)),t[15]=n*(s*f-u*l)-a*(r*f-i*l)+h*(r*u-i*s),t},determinant:function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],c=t[8],h=t[9],l=t[10],f=t[11],d=t[12],p=t[13],y=t[14],v=t[15];return(e*a-n*o)*(l*v-f*y)-(e*s-r*o)*(h*v-f*p)+(e*u-i*o)*(h*y-l*p)+(n*s-r*a)*(c*v-f*d)-(n*u-i*a)*(c*y-l*d)+(r*u-i*s)*(c*p-h*d)},multiply:X,translate:function(t,e,n){var r,i,o,a,s,u,c,h,l,f,d,p,y=n[0],v=n[1],m=n[2];return e===t?(t[12]=e[0]*y+e[4]*v+e[8]*m+e[12],t[13]=e[1]*y+e[5]*v+e[9]*m+e[13],t[14]=e[2]*y+e[6]*v+e[10]*m+e[14],t[15]=e[3]*y+e[7]*v+e[11]*m+e[15]):(r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=e[8],f=e[9],d=e[10],p=e[11],t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=c,t[7]=h,t[8]=l,t[9]=f,t[10]=d,t[11]=p,t[12]=r*y+s*v+l*m+e[12],t[13]=i*y+u*v+f*m+e[13],t[14]=o*y+c*v+d*m+e[14],t[15]=a*y+h*v+p*m+e[15]),t},scale:function(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,e,n,r){var i,o,a,s,u,c,h,l,f,d,p,y,v,m,g,b,x,E,w,R,P,k,M,T,I=r[0],S=r[1],A=r[2],O=Math.hypot(I,S,A);return O<C?null:(I*=O=1/O,S*=O,A*=O,i=Math.sin(n),a=1-(o=Math.cos(n)),s=e[0],u=e[1],c=e[2],h=e[3],l=e[4],f=e[5],d=e[6],p=e[7],y=e[8],v=e[9],m=e[10],g=e[11],b=I*I*a+o,x=S*I*a+A*i,E=A*I*a-S*i,w=I*S*a-A*i,R=S*S*a+o,P=A*S*a+I*i,k=I*A*a+S*i,M=S*A*a-I*i,T=A*A*a+o,t[0]=s*b+l*x+y*E,t[1]=u*b+f*x+v*E,t[2]=c*b+d*x+m*E,t[3]=h*b+p*x+g*E,t[4]=s*w+l*R+y*P,t[5]=u*w+f*R+v*P,t[6]=c*w+d*R+m*P,t[7]=h*w+p*R+g*P,t[8]=s*k+l*M+y*T,t[9]=u*k+f*M+v*T,t[10]=c*k+d*M+m*T,t[11]=h*k+p*M+g*T,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},rotateX:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[4],a=e[5],s=e[6],u=e[7],c=e[8],h=e[9],l=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+c*r,t[5]=a*i+h*r,t[6]=s*i+l*r,t[7]=u*i+f*r,t[8]=c*i-o*r,t[9]=h*i-a*r,t[10]=l*i-s*r,t[11]=f*i-u*r,t},rotateY:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],c=e[8],h=e[9],l=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-c*r,t[1]=a*i-h*r,t[2]=s*i-l*r,t[3]=u*i-f*r,t[8]=o*r+c*i,t[9]=a*r+h*i,t[10]=s*r+l*i,t[11]=u*r+f*i,t},rotateZ:function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],c=e[4],h=e[5],l=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+c*r,t[1]=a*i+h*r,t[2]=s*i+l*r,t[3]=u*i+f*r,t[4]=c*i-o*r,t[5]=h*i-a*r,t[6]=l*i-s*r,t[7]=f*i-u*r,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,e,n){var r,i,o,a=n[0],s=n[1],u=n[2],c=Math.hypot(a,s,u);return c<C?null:(a*=c=1/c,s*=c,u*=c,r=Math.sin(e),o=1-(i=Math.cos(e)),t[0]=a*a*o+i,t[1]=s*a*o+u*r,t[2]=u*a*o-s*r,t[3]=0,t[4]=a*s*o-u*r,t[5]=s*s*o+i,t[6]=u*s*o+a*r,t[7]=0,t[8]=a*u*o+s*r,t[9]=s*u*o-a*r,t[10]=u*u*o+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:G,fromQuat2:function(t,e){var n=new O(3),r=-e[0],i=-e[1],o=-e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=r*r+i*i+o*o+a*a;return l>0?(n[0]=2*(s*a+h*r+u*o-c*i)/l,n[1]=2*(u*a+h*i+c*r-s*o)/l,n[2]=2*(c*a+h*o+s*i-u*r)/l):(n[0]=2*(s*a+h*r+u*o-c*i),n[1]=2*(u*a+h*i+c*r-s*o),n[2]=2*(c*a+h*o+s*i-u*r)),G(t,e,n),t},getTranslation:z,getScaling:V,getRotation:H,fromRotationTranslationScale:function(t,e,n,r){var i=e[0],o=e[1],a=e[2],s=e[3],u=i+i,c=o+o,h=a+a,l=i*u,f=i*c,d=i*h,p=o*c,y=o*h,v=a*h,m=s*u,g=s*c,b=s*h,x=r[0],E=r[1],w=r[2];return t[0]=(1-(p+v))*x,t[1]=(f+b)*x,t[2]=(d-g)*x,t[3]=0,t[4]=(f-b)*E,t[5]=(1-(l+v))*E,t[6]=(y+m)*E,t[7]=0,t[8]=(d+g)*w,t[9]=(y-m)*w,t[10]=(1-(l+p))*w,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},fromRotationTranslationScaleOrigin:function(t,e,n,r,i){var o=e[0],a=e[1],s=e[2],u=e[3],c=o+o,h=a+a,l=s+s,f=o*c,d=o*h,p=o*l,y=a*h,v=a*l,m=s*l,g=u*c,b=u*h,x=u*l,E=r[0],w=r[1],R=r[2],P=i[0],k=i[1],M=i[2],T=(1-(y+m))*E,I=(d+x)*E,S=(p-b)*E,A=(d-x)*w,C=(1-(f+m))*w,O=(v+g)*w,D=(p+b)*R,N=(v-g)*R,L=(1-(f+y))*R;return t[0]=T,t[1]=I,t[2]=S,t[3]=0,t[4]=A,t[5]=C,t[6]=O,t[7]=0,t[8]=D,t[9]=N,t[10]=L,t[11]=0,t[12]=n[0]+P-(T*P+A*k+D*M),t[13]=n[1]+k-(I*P+C*k+N*M),t[14]=n[2]+M-(S*P+O*k+L*M),t[15]=1,t},fromQuat:function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,s=r+r,u=i+i,c=n*a,h=r*a,l=r*s,f=i*a,d=i*s,p=i*u,y=o*a,v=o*s,m=o*u;return t[0]=1-l-p,t[1]=h+m,t[2]=f-v,t[3]=0,t[4]=h-m,t[5]=1-c-p,t[6]=d+y,t[7]=0,t[8]=f+v,t[9]=d-y,t[10]=1-c-l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,n,r,i,o,a){var s=1/(n-e),u=1/(i-r),c=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(n+e)*s,t[9]=(i+r)*u,t[10]=(a+o)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*c,t[15]=0,t},perspective:function(t,e,n,r,i){var o,a=1/Math.tan(e/2);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(r-i),t[10]=(i+r)*o,t[14]=2*i*r*o):(t[10]=-1,t[14]=-2*r),t},perspectiveFromFieldOfView:function(t,e,n,r){var i=Math.tan(e.upDegrees*Math.PI/180),o=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),u=2/(a+s),c=2/(i+o);return t[0]=u,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(a-s)*u*.5,t[9]=(i-o)*c*.5,t[10]=r/(n-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*n/(n-r),t[15]=0,t},ortho:function(t,e,n,r,i,o,a){var s=1/(e-n),u=1/(r-i),c=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+n)*s,t[13]=(i+r)*u,t[14]=(a+o)*c,t[15]=1,t},lookAt:function(t,e,n,r){var i,o,a,s,u,c,h,l,f,d,p=e[0],y=e[1],v=e[2],m=r[0],g=r[1],b=r[2],x=n[0],E=n[1],w=n[2];return Math.abs(p-x)<C&&Math.abs(y-E)<C&&Math.abs(v-w)<C?Y(t):(h=p-x,l=y-E,f=v-w,i=g*(f*=d=1/Math.hypot(h,l,f))-b*(l*=d),o=b*(h*=d)-m*f,a=m*l-g*h,(d=Math.hypot(i,o,a))?(i*=d=1/d,o*=d,a*=d):(i=0,o=0,a=0),s=l*a-f*o,u=f*i-h*a,c=h*o-l*i,(d=Math.hypot(s,u,c))?(s*=d=1/d,u*=d,c*=d):(s=0,u=0,c=0),t[0]=i,t[1]=s,t[2]=h,t[3]=0,t[4]=o,t[5]=u,t[6]=l,t[7]=0,t[8]=a,t[9]=c,t[10]=f,t[11]=0,t[12]=-(i*p+o*y+a*v),t[13]=-(s*p+u*y+c*v),t[14]=-(h*p+l*y+f*v),t[15]=1,t)},targetTo:function(t,e,n,r){var i=e[0],o=e[1],a=e[2],s=r[0],u=r[1],c=r[2],h=i-n[0],l=o-n[1],f=a-n[2],d=h*h+l*l+f*f;d>0&&(h*=d=1/Math.sqrt(d),l*=d,f*=d);var p=u*f-c*l,y=c*h-s*f,v=s*l-u*h;return(d=p*p+y*y+v*v)>0&&(p*=d=1/Math.sqrt(d),y*=d,v*=d),t[0]=p,t[1]=y,t[2]=v,t[3]=0,t[4]=l*v-f*y,t[5]=f*p-h*v,t[6]=h*y-l*p,t[7]=0,t[8]=h,t[9]=l,t[10]=f,t[11]=0,t[12]=i,t[13]=o,t[14]=a,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t},subtract:W,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t[9]=e[9]+n[9]*r,t[10]=e[10]+n[10]*r,t[11]=e[11]+n[11]*r,t[12]=e[12]+n[12]*r,t[13]=e[13]+n[13]*r,t[14]=e[14]+n[14]*r,t[15]=e[15]+n[15]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],c=t[7],h=t[8],l=t[9],f=t[10],d=t[11],p=t[12],y=t[13],v=t[14],m=t[15],g=e[0],b=e[1],x=e[2],E=e[3],w=e[4],R=e[5],P=e[6],k=e[7],M=e[8],T=e[9],I=e[10],S=e[11],A=e[12],O=e[13],D=e[14],N=e[15];return Math.abs(n-g)<=C*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(r-b)<=C*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(i-x)<=C*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(o-E)<=C*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(a-w)<=C*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(s-R)<=C*Math.max(1,Math.abs(s),Math.abs(R))&&Math.abs(u-P)<=C*Math.max(1,Math.abs(u),Math.abs(P))&&Math.abs(c-k)<=C*Math.max(1,Math.abs(c),Math.abs(k))&&Math.abs(h-M)<=C*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(l-T)<=C*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(f-I)<=C*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(d-S)<=C*Math.max(1,Math.abs(d),Math.abs(S))&&Math.abs(p-A)<=C*Math.max(1,Math.abs(p),Math.abs(A))&&Math.abs(y-O)<=C*Math.max(1,Math.abs(y),Math.abs(O))&&Math.abs(v-D)<=C*Math.max(1,Math.abs(v),Math.abs(D))&&Math.abs(m-N)<=C*Math.max(1,Math.abs(m),Math.abs(N))},mul:q,sub:Z});function J(){var t=new O(3);return O!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Q(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function $(t,e,n){var r=new O(3);return r[0]=t,r[1]=e,r[2]=n,r}function tt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function et(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function nt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function rt(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.hypot(n,r,i)}function it(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}function ot(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}function at(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function st(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ut(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t}var ct,ht=tt,lt=et,ft=nt,dt=rt,pt=it,yt=Q,vt=ot,mt=(ct=J(),function(t,e,n,r,i,o){var a,s;for(e||(e=3),n||(n=0),s=r?Math.min(r*e+n,t.length):t.length,a=n;a<s;a+=e)ct[0]=t[a],ct[1]=t[a+1],ct[2]=t[a+2],i(ct,ct,o),t[a]=ct[0],t[a+1]=ct[1],t[a+2]=ct[2];return t}),gt=Object.freeze({__proto__:null,create:J,clone:function(t){var e=new O(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:Q,fromValues:$,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},subtract:tt,multiply:et,divide:nt,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t},distance:rt,squaredDistance:it,squaredLength:ot,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:at,dot:st,cross:ut,lerp:function(t,e,n,r){var i=e[0],o=e[1],a=e[2];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=a+r*(n[2]-a),t},hermite:function(t,e,n,r,i,o){var a=o*o,s=a*(2*o-3)+1,u=a*(o-2)+o,c=a*(o-1),h=a*(3-2*o);return t[0]=e[0]*s+n[0]*u+r[0]*c+i[0]*h,t[1]=e[1]*s+n[1]*u+r[1]*c+i[1]*h,t[2]=e[2]*s+n[2]*u+r[2]*c+i[2]*h,t},bezier:function(t,e,n,r,i,o){var a=1-o,s=a*a,u=o*o,c=s*a,h=3*o*s,l=3*u*a,f=u*o;return t[0]=e[0]*c+n[0]*h+r[0]*l+i[0]*f,t[1]=e[1]*c+n[1]*h+r[1]*l+i[1]*f,t[2]=e[2]*c+n[2]*h+r[2]*l+i[2]*f,t},random:function(t,e){e=e||1;var n=2*D()*Math.PI,r=2*D()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t},transformMat4:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[3]*r+n[7]*i+n[11]*o+n[15];return a=a||1,t[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/a,t[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/a,t[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/a,t},transformMat3:function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=r*n[0]+i*n[3]+o*n[6],t[1]=r*n[1]+i*n[4]+o*n[7],t[2]=r*n[2]+i*n[5]+o*n[8],t},transformQuat:function(t,e,n){var r=n[0],i=n[1],o=n[2],a=n[3],s=e[0],u=e[1],c=e[2],h=i*c-o*u,l=o*s-r*c,f=r*u-i*s,d=i*f-o*l,p=o*h-r*f,y=r*l-i*h,v=2*a;return h*=v,l*=v,f*=v,d*=2,p*=2,y*=2,t[0]=s+h+d,t[1]=u+l+p,t[2]=c+f+y,t},rotateX:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},rotateY:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},rotateZ:function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},angle:function(t,e){var n=t[0],r=t[1],i=t[2],o=e[0],a=e[1],s=e[2],u=Math.sqrt(n*n+r*r+i*i)*Math.sqrt(o*o+a*a+s*s),c=u&&st(t,e)/u;return Math.acos(Math.min(Math.max(c,-1),1))},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=e[0],a=e[1],s=e[2];return Math.abs(n-o)<=C*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-a)<=C*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-s)<=C*Math.max(1,Math.abs(i),Math.abs(s))},sub:ht,mul:lt,div:ft,dist:dt,sqrDist:pt,len:yt,sqrLen:vt,forEach:mt});function bt(){var t=new O(4);return O!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function xt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Et(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function wt(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function Rt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function Pt(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return Math.hypot(n,r,i,o)}function kt(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return n*n+r*r+i*i+o*o}function Mt(t){var e=t[0],n=t[1],r=t[2],i=t[3];return Math.hypot(e,n,r,i)}function Tt(t){var e=t[0],n=t[1],r=t[2],i=t[3];return e*e+n*n+r*r+i*i}function It(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n*n+r*r+i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=r*a,t[2]=i*a,t[3]=o*a,t}function St(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}var At=Et,Ct=wt,Ot=Rt,Dt=Pt,Nt=kt,Lt=Mt,_t=Tt,Bt=function(){var t=bt();return function(e,n,r,i,o,a){var s,u;for(n||(n=4),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;s<u;s+=n)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],o(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),Ft=Object.freeze({__proto__:null,create:bt,clone:function(t){var e=new O(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:function(t,e,n,r){var i=new O(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i},copy:xt,set:function(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t},subtract:Et,multiply:wt,divide:Rt,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t},scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t},distance:Pt,squaredDistance:kt,length:Mt,squaredLength:Tt,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:It,dot:St,cross:function(t,e,n,r){var i=n[0]*r[1]-n[1]*r[0],o=n[0]*r[2]-n[2]*r[0],a=n[0]*r[3]-n[3]*r[0],s=n[1]*r[2]-n[2]*r[1],u=n[1]*r[3]-n[3]*r[1],c=n[2]*r[3]-n[3]*r[2],h=e[0],l=e[1],f=e[2],d=e[3];return t[0]=l*c-f*u+d*s,t[1]=-h*c+f*a-d*o,t[2]=h*u-l*a+d*i,t[3]=-h*s+l*o-f*i,t},lerp:function(t,e,n,r){var i=e[0],o=e[1],a=e[2],s=e[3];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=a+r*(n[2]-a),t[3]=s+r*(n[3]-s),t},random:function(t,e){var n,r,i,o,a,s;e=e||1;do{a=(n=2*D()-1)*n+(r=2*D()-1)*r}while(a>=1);do{s=(i=2*D()-1)*i+(o=2*D()-1)*o}while(s>=1);var u=Math.sqrt((1-a)/s);return t[0]=e*n,t[1]=e*r,t[2]=e*i*u,t[3]=e*o*u,t},transformMat4:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*a,t[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*a,t[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*a,t[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*a,t},transformQuat:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2],c=n[3],h=c*r+s*o-u*i,l=c*i+u*r-a*o,f=c*o+a*i-s*r,d=-a*r-s*i-u*o;return t[0]=h*c+d*-a+l*-u-f*-s,t[1]=l*c+d*-s+f*-a-h*-u,t[2]=f*c+d*-u+h*-s-l*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],a=e[0],s=e[1],u=e[2],c=e[3];return Math.abs(n-a)<=C*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-s)<=C*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-u)<=C*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(o-c)<=C*Math.max(1,Math.abs(o),Math.abs(c))},sub:At,mul:Ct,div:Ot,dist:Dt,sqrDist:Nt,len:Lt,sqrLen:_t,forEach:Bt});function Ut(){var t=new O(4);return O!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function jt(t,e,n,r){var i,o,a,s,u,c=e[0],h=e[1],l=e[2],f=e[3],d=n[0],p=n[1],y=n[2],v=n[3];return(o=c*d+h*p+l*y+f*v)<0&&(o=-o,d=-d,p=-p,y=-y,v=-v),1-o>C?(i=Math.acos(o),a=Math.sin(i),s=Math.sin((1-r)*i)/a,u=Math.sin(r*i)/a):(s=1-r,u=r),t[0]=s*c+u*d,t[1]=s*h+u*p,t[2]=s*l+u*y,t[3]=s*f+u*v,t}var Yt,Xt,Gt,zt,Vt,Ht,Wt,qt=xt,Zt=St,Kt=Mt,Jt=Tt,Qt=It;Yt=J(),Xt=$(1,0,0),Gt=$(0,1,0),zt=Ut(),Vt=Ut(),Ht=new O(9),O!=Float32Array&&(Ht[1]=0,Ht[2]=0,Ht[3]=0,Ht[5]=0,Ht[6]=0,Ht[7]=0),Ht[0]=1,Ht[4]=1,Ht[8]=1,Wt=Ht;function $t(t,e,n){var r=.5*n[0],i=.5*n[1],o=.5*n[2],a=e[0],s=e[1],u=e[2],c=e[3];return t[0]=a,t[1]=s,t[2]=u,t[3]=c,t[4]=r*c+i*u-o*s,t[5]=i*c+o*a-r*u,t[6]=o*c+r*s-i*a,t[7]=-r*a-i*s-o*u,t}function te(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var ee=qt;var ne=qt;function re(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=n[4],u=n[5],c=n[6],h=n[7],l=e[4],f=e[5],d=e[6],p=e[7],y=n[0],v=n[1],m=n[2],g=n[3];return t[0]=r*g+a*y+i*m-o*v,t[1]=i*g+a*v+o*y-r*m,t[2]=o*g+a*m+r*v-i*y,t[3]=a*g-r*y-i*v-o*m,t[4]=r*h+a*s+i*c-o*u+l*g+p*y+f*m-d*v,t[5]=i*h+a*u+o*s-r*c+f*g+p*v+d*y-l*m,t[6]=o*h+a*c+r*u-i*s+d*g+p*m+l*v-f*y,t[7]=a*h-r*s-i*u-o*c+p*g-l*y-f*v-d*m,t}var ie=re;var oe=Zt;var ae=Kt,se=ae,ue=Jt,ce=ue;var he=Object.freeze({__proto__:null,create:function(){var t=new O(8);return O!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},clone:function(t){var e=new O(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},fromValues:function(t,e,n,r,i,o,a,s){var u=new O(8);return u[0]=t,u[1]=e,u[2]=n,u[3]=r,u[4]=i,u[5]=o,u[6]=a,u[7]=s,u},fromRotationTranslationValues:function(t,e,n,r,i,o,a){var s=new O(8);s[0]=t,s[1]=e,s[2]=n,s[3]=r;var u=.5*i,c=.5*o,h=.5*a;return s[4]=u*r+c*n-h*e,s[5]=c*r+h*t-u*n,s[6]=h*r+u*e-c*t,s[7]=-u*t-c*e-h*n,s},fromRotationTranslation:$t,fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromMat4:function(t,e){var n=Ut();H(n,e);var r=new O(3);return z(r,e),$t(t,n,r),t},copy:te,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},set:function(t,e,n,r,i,o,a,s,u){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=o,t[5]=a,t[6]=s,t[7]=u,t},getReal:ee,getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},setReal:ne,setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},getTranslation:function(t,e){var n=e[4],r=e[5],i=e[6],o=e[7],a=-e[0],s=-e[1],u=-e[2],c=e[3];return t[0]=2*(n*c+o*a+r*u-i*s),t[1]=2*(r*c+o*s+i*a-n*u),t[2]=2*(i*c+o*u+n*s-r*a),t},translate:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=.5*n[0],u=.5*n[1],c=.5*n[2],h=e[4],l=e[5],f=e[6],d=e[7];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=a*s+i*c-o*u+h,t[5]=a*u+o*s-r*c+l,t[6]=a*c+r*u-i*s+f,t[7]=-r*s-i*u-o*c+d,t},rotateX:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=s*a+h*r+u*o-c*i,f=u*a+h*i+c*r-s*o,d=c*a+h*o+s*i-u*r,p=h*a-s*r-u*i-c*o;return function(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(n),u=Math.cos(n);t[0]=r*u+a*s,t[1]=i*u+o*s,t[2]=o*u-i*s,t[3]=a*u-r*s}(t,e,n),r=t[0],i=t[1],o=t[2],a=t[3],t[4]=l*a+p*r+f*o-d*i,t[5]=f*a+p*i+d*r-l*o,t[6]=d*a+p*o+l*i-f*r,t[7]=p*a-l*r-f*i-d*o,t},rotateY:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=s*a+h*r+u*o-c*i,f=u*a+h*i+c*r-s*o,d=c*a+h*o+s*i-u*r,p=h*a-s*r-u*i-c*o;return function(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(n),u=Math.cos(n);t[0]=r*u-o*s,t[1]=i*u+a*s,t[2]=o*u+r*s,t[3]=a*u-i*s}(t,e,n),r=t[0],i=t[1],o=t[2],a=t[3],t[4]=l*a+p*r+f*o-d*i,t[5]=f*a+p*i+d*r-l*o,t[6]=d*a+p*o+l*i-f*r,t[7]=p*a-l*r-f*i-d*o,t},rotateZ:function(t,e,n){var r=-e[0],i=-e[1],o=-e[2],a=e[3],s=e[4],u=e[5],c=e[6],h=e[7],l=s*a+h*r+u*o-c*i,f=u*a+h*i+c*r-s*o,d=c*a+h*o+s*i-u*r,p=h*a-s*r-u*i-c*o;return function(t,e,n){n*=.5;var r=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(n),u=Math.cos(n);t[0]=r*u+i*s,t[1]=i*u-r*s,t[2]=o*u+a*s,t[3]=a*u-o*s}(t,e,n),r=t[0],i=t[1],o=t[2],a=t[3],t[4]=l*a+p*r+f*o-d*i,t[5]=f*a+p*i+d*r-l*o,t[6]=d*a+p*o+l*i-f*r,t[7]=p*a-l*r-f*i-d*o,t},rotateByQuatAppend:function(t,e,n){var r=n[0],i=n[1],o=n[2],a=n[3],s=e[0],u=e[1],c=e[2],h=e[3];return t[0]=s*a+h*r+u*o-c*i,t[1]=u*a+h*i+c*r-s*o,t[2]=c*a+h*o+s*i-u*r,t[3]=h*a-s*r-u*i-c*o,s=e[4],u=e[5],c=e[6],h=e[7],t[4]=s*a+h*r+u*o-c*i,t[5]=u*a+h*i+c*r-s*o,t[6]=c*a+h*o+s*i-u*r,t[7]=h*a-s*r-u*i-c*o,t},rotateByQuatPrepend:function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=n[0],u=n[1],c=n[2],h=n[3];return t[0]=r*h+a*s+i*c-o*u,t[1]=i*h+a*u+o*s-r*c,t[2]=o*h+a*c+r*u-i*s,t[3]=a*h-r*s-i*u-o*c,s=n[4],u=n[5],c=n[6],h=n[7],t[4]=r*h+a*s+i*c-o*u,t[5]=i*h+a*u+o*s-r*c,t[6]=o*h+a*c+r*u-i*s,t[7]=a*h-r*s-i*u-o*c,t},rotateAroundAxis:function(t,e,n,r){if(Math.abs(r)<C)return te(t,e);var i=Math.hypot(n[0],n[1],n[2]);r*=.5;var o=Math.sin(r),a=o*n[0]/i,s=o*n[1]/i,u=o*n[2]/i,c=Math.cos(r),h=e[0],l=e[1],f=e[2],d=e[3];t[0]=h*c+d*a+l*u-f*s,t[1]=l*c+d*s+f*a-h*u,t[2]=f*c+d*u+h*s-l*a,t[3]=d*c-h*a-l*s-f*u;var p=e[4],y=e[5],v=e[6],m=e[7];return t[4]=p*c+m*a+y*u-v*s,t[5]=y*c+m*s+v*a-p*u,t[6]=v*c+m*u+p*s-y*a,t[7]=m*c-p*a-y*s-v*u,t},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t},multiply:re,mul:ie,scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t},dot:oe,lerp:function(t,e,n,r){var i=1-r;return oe(e,n)<0&&(r=-r),t[0]=e[0]*i+n[0]*r,t[1]=e[1]*i+n[1]*r,t[2]=e[2]*i+n[2]*r,t[3]=e[3]*i+n[3]*r,t[4]=e[4]*i+n[4]*r,t[5]=e[5]*i+n[5]*r,t[6]=e[6]*i+n[6]*r,t[7]=e[7]*i+n[7]*r,t},invert:function(t,e){var n=ue(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},length:ae,len:se,squaredLength:ue,sqrLen:ce,normalize:function(t,e){var n=ue(e);if(n>0){n=Math.sqrt(n);var r=e[0]/n,i=e[1]/n,o=e[2]/n,a=e[3]/n,s=e[4],u=e[5],c=e[6],h=e[7],l=r*s+i*u+o*c+a*h;t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=(s-r*l)/n,t[5]=(u-i*l)/n,t[6]=(c-o*l)/n,t[7]=(h-a*l)/n}return t},str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},equals:function(t,e){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],c=t[7],h=e[0],l=e[1],f=e[2],d=e[3],p=e[4],y=e[5],v=e[6],m=e[7];return Math.abs(n-h)<=C*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(r-l)<=C*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-f)<=C*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(o-d)<=C*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(a-p)<=C*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-y)<=C*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(u-v)<=C*Math.max(1,Math.abs(u),Math.abs(v))&&Math.abs(c-m)<=C*Math.max(1,Math.abs(c),Math.abs(m))}});function le(){var t=new O(2);return O!=Float32Array&&(t[0]=0,t[1]=0),t}function fe(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function de(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function pe(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function ye(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.hypot(n,r)}function ve(t,e){var n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r}function me(t){var e=t[0],n=t[1];return Math.hypot(e,n)}function ge(t){var e=t[0],n=t[1];return e*e+n*n}var be=me,xe=fe,Ee=de,we=pe,Re=ye,Pe=ve,ke=ge,Me=function(){var t=le();return function(e,n,r,i,o,a){var s,u;for(n||(n=2),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;s<u;s+=n)t[0]=e[s],t[1]=e[s+1],o(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),Te=Object.freeze({__proto__:null,create:le,clone:function(t){var e=new O(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var n=new O(2);return n[0]=t,n[1]=e,n},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,n){return t[0]=e,t[1]=n,t},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t},subtract:fe,multiply:de,divide:pe,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t},scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t},distance:ye,squaredDistance:ve,length:me,squaredLength:ge,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var n=e[0],r=e[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,n){var r=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=r,t},lerp:function(t,e,n,r){var i=e[0],o=e[1];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t},random:function(t,e){e=e||1;var n=2*D()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t},transformMat2:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i,t[1]=n[1]*r+n[3]*i,t},transformMat2d:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i+n[4],t[1]=n[1]*r+n[3]*i+n[5],t},transformMat3:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[3]*i+n[6],t[1]=n[1]*r+n[4]*i+n[7],t},transformMat4:function(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[4]*i+n[12],t[1]=n[1]*r+n[5]*i+n[13],t},rotate:function(t,e,n,r){var i=e[0]-n[0],o=e[1]-n[1],a=Math.sin(r),s=Math.cos(r);return t[0]=i*s-o*a+n[0],t[1]=i*a+o*s+n[1],t},angle:function(t,e){var n=t[0],r=t[1],i=e[0],o=e[1],a=Math.sqrt(n*n+r*r)*Math.sqrt(i*i+o*o),s=a&&(n*i+r*o)/a;return Math.acos(Math.min(Math.max(s,-1),1))},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,e){var n=t[0],r=t[1],i=e[0],o=e[1];return Math.abs(n-i)<=C*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(r-o)<=C*Math.max(1,Math.abs(r),Math.abs(o))},len:be,sub:xe,mul:Ee,div:we,dist:Re,sqrDist:Pe,sqrLen:ke,forEach:Me}),Ie=L,Se=j,Ae=K,Ce={m00:0,m01:1,m02:2,m03:3,m10:4,m11:5,m12:6,m13:7,m20:8,m21:9,m22:10,m23:11,m30:12,m31:13,m32:14,m33:15},Oe={a:0,b:1,c:4,d:5,dx:12,dy:13};function De(t,e){var n=Ae.create(),r=isNaN(t)?t.x:t,i=isNaN(t)?t.y:t;return n[Oe.a]=r,n[Oe.b]=0,n[Oe.c]=0,n[Oe.d]=i,n[Oe.dx]=e.x-e.x*r,n[Oe.dy]=e.y-e.y*i,n}function Ne(t,e){var n=Ae.create(),r=Math.sin(t),i=Math.cos(t);return n[Oe.a]=i,n[Oe.b]=r,n[Oe.c]=-r,n[Oe.d]=i,n[Oe.dx]=e.x-e.x*i+e.y*r,n[Oe.dy]=e.y-e.x*r-e.y*i,n}function Le(t,e,n){var r=Ae.create(),i=De(e,n),o=Ne(t,n);return Ae.multiply(r,i,o),r}function _e(t){var e=Ae.create(),n=t.getStyle("transform");return"none"!=n&&(n=n.substring(n.indexOf("(")+1,n.indexOf(")")).split(/,\s*/g),e[Oe.a]=parseFloat(n[0]),e[Oe.b]=parseFloat(n[1]),e[Oe.c]=parseFloat(n[2]),e[Oe.d]=parseFloat(n[3]),e[Oe.dx]=parseFloat(n[4]),e[Oe.dy]=parseFloat(n[5])),e}function Be(t){var e=Fe(t);return Ie.ARRAY_TYPE==Float32Array&&(e=e.toArray()),"matrix("+e.join(", ")+")"}function Fe(t){return Se.fromValues(t[Oe.a],t[Oe.b],t[Oe.c],t[Oe.d],t[Oe.dx],t[Oe.dy])}var Ue=Object.freeze({__proto__:null,MAT4_INDEX:Ce,MAT2D_INDEX:Oe,makeScaleAtPoint:De,makeRotationAroundPoint:Ne,makeTransformAroundPoint:Le,fromCSS:_e,toCSS:Be,toMat2D:Fe}),je=gt,Ye=function(){function t(n,r,i){e(this,t),this.x=n,this.y=r,isFinite(i)&&(this.z=i),this.red,this.green,this.blue,this.alpha,this.size,this.rotation,this.scaleX,this.scaleY,this.scaleZ,this.offsetX,this.offsetY,this.offsetZ,this.dX,this.dY}return I(t,[{key:"fill",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=t.length;t.forEach((function(t,o){return n.setProperty(t,e[r*i+o])}))}},{key:"getProperty",value:function(e){switch(e){case t.Property.X:return this.x;case t.Property.Y:return this.y;case t.Property.Z:return this.z;case t.Property.RED:return this.red;case t.Property.GREEN:return this.green;case t.Property.BLUE:return this.blue;case t.Property.ALPHA:return this.alpha;case t.Property.SIZE:return this.size;case t.Property.ROTATION:return this.rotation;case t.Property.SCALE_X:return this.scaleX;case t.Property.SCALE_Y:return this.scaleY;case t.Property.SCALE_Z:return this.scaleZ;case t.Property.OFFSET_X:return this.offsetX;case t.Property.OFFSET_Y:return this.offsetY;case t.Property.OFFSET_Z:return this.offsetZ;case t.Property.D_X:return this.dX;case t.Property.D_Y:return this.dY;default:throw console.warn(e),new Error("Invalid property found")}}},{key:"setProperty",value:function(e,n){switch(e){case t.Property.X:this.x=n;break;case t.Property.Y:this.y=n;break;case t.Property.Z:this.z=n;break;case t.Property.RED:this.red=n;break;case t.Property.GREEN:this.green=n;break;case t.Property.BLUE:this.blue=n;break;case t.Property.ALPHA:this.alpha=n;break;case t.Property.SIZE:this.size=n;break;case t.Property.ROTATION:this.rotation=n;break;case t.Property.SCALE_X:this.scaleX=n;break;case t.Property.SCALE_Y:this.scaleY=n;break;case t.Property.SCALE_Z:this.scaleZ=n;break;case t.Property.OFFSET_X:this.offsetX=n;break;case t.Property.OFFSET_Y:this.offsetY=n;break;case t.Property.OFFSET_Z:this.offsetZ=n;break;case t.Property.D_X:this.dX=n;break;case t.Property.D_Y:this.dY=n;break;default:throw console.warn(e),new Error("Invalid property found")}}},{key:"transform",value:function(t){var e=Math.pow(Math.pow(t[Oe.a],2)+Math.pow(t[Oe.c],2),.5),n=je.fromValues(this.x,this.y,this.z||0);je.transformMat4(n,n,t),this.x=n[0],this.y=n[1],this.z=n[2],this.size*=e,this.scaleX*=e,this.scaleY*=e,this.scaleZ*=e,this.offsetX*=e,this.offsetY*=e,this.offsetZ*=e}},{key:"asArray",value:function(t){var e=this;return t.map((function(t){var n=e.getProperty(t);if(null==n||!isFinite(n))throw new Error("Property ".concat(t.name," has invalid value ").concat(n));return n}))}},{key:"debug",value:function(){var e=this,n=[];return t.Property.values.forEach((function(t){var r=e.getProperty(t);null!=r&&isFinite(r)&&n.push(t.name,e.getProperty(t))})),n}}],[{key:"createInstance",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new t;return r.x=n.x,r.y=n.y,r.z=n.z,r.red=e.red,r.green=e.green,r.blue=e.blue,r.alpha=e.alpha,r.size=e.size,r.rotation=e.rotation||0,r.scaleX=e.scaleX||1,r.scaleY=e.scaleY||1,r.scaleZ=e.scaleZ||1,r.offsetX=e.offsetX||0,r.offsetY=e.offsetY||0,r.offsetZ=e.offsetZ||0,r}}]),t}();Ye.createEnum("Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);var Xe=he,Ge=Te,ze=K,Ve=function(){function t(n,r,i,o){e(this,t);var a=i-n,s=r-o,u=(n+i)/2,c=(o+r)/2;Object.defineProperties(this,{left:{value:n,enumerable:!0},x:{value:n,enumerable:!0},bottom:{value:r,enumerable:!0},y:{value:r,enumerable:!0},right:{value:i,enumerable:!0},top:{value:o,enumerable:!0},width:{value:i-n,enumerable:!0},height:{value:o-r,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},size:{value:{width:a,height:s},enumerable:!0}})}return I(t,[{key:"union",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of GLRect");return e?new t(Math.min(this.left,e.left),Math.min(this.bottom,e.bottom),Math.max(this.right,e.right),Math.max(this.top,e.top)):this}},{key:"intersect",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of GLRect");if(!e)return null;var n=new t(Math.max(this.left,e.left),Math.max(this.bottom,e.bottom),Math.min(this.right,e.right),Math.min(this.top,e.top));return n.width>0&&n.height>0?n:null}},{key:"ceil",value:function(){return new t(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}},{key:"floor",value:function(){return new t(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}},{key:"toQuad",value:function(t){var e;if(t){var n=Ge.fromValues(this.left,this.bottom),r=Ge.fromValues(this.right,this.bottom),i=Ge.fromValues(this.left,this.top),o=Ge.fromValues(this.right,this.top);Ge.transformMat4(n,n,t),Ge.transformMat4(r,r,t),Ge.transformMat4(i,i,t),Ge.transformMat4(o,o,t),e=Xe.fromValues(n[0],n[1],r[0],r[1],i[0],i[1],o[0],o[1])}else e=Xe.fromValues(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return e}}],[{key:"makeWithSize",value:function(e,n,r,i){return new t(e,n,e+r,n+i)}},{key:"calculateBrushGLSegmentBounds",value:function(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ze.create(),i=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}],o=.5*e.size,a=Math.abs(n*o),s=Ge.fromValues(e.x,e.y);Ge.transformMat4(s,s,r);var u=s[0],c=s[1],h=e.scaleX*o,l=e.scaleY*o,f=e.offsetX,d=-e.offsetY,p=Math.cos(e.rotation),y=Math.sin(e.rotation),v=Number.MAX_SAFE_INTEGER,m=Number.MIN_SAFE_INTEGER,g=Number.MAX_SAFE_INTEGER,b=Number.MIN_SAFE_INTEGER;return i.forEach((function(t){t.x=t.x*h+f,t.y=t.y*l+d;var e=p*t.x+y*t.y+u,n=-y*t.x+p*t.y+c,r=e-a;v=Math.min(v,r),m=Math.max(m,r),r=e+a,v=Math.min(v,r),m=Math.max(m,r);var i=n-a;g=Math.min(g,i),b=Math.max(b,i),i=n+a,g=Math.min(g,i),b=Math.max(b,i)})),t.makeWithSize(v,g,m-v,b-g)}}]),t}(),He=function(){function t(n,r,i,o){e(this,t);var a=i-n,s=o-r,u=(n+i)/2,c=(r+o)/2;Object.defineProperties(this,{left:{value:n,enumerable:!0},top:{value:r,enumerable:!0},right:{value:i,enumerable:!0},bottom:{value:o,enumerable:!0},x:{value:n,enumerable:!0},y:{value:r,enumerable:!0},width:{value:a,enumerable:!0},height:{value:s,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},size:{value:{width:a,height:s},enumerable:!0}})}return I(t,[{key:"union",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of Rect");return e?new t(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right),Math.max(this.bottom,e.bottom)):this}},{key:"intersect",value:function(e){if(!e)return null;if(!(e instanceof t))throw new TypeError("rect must be instance of Rect");var n=new t(Math.max(this.left,e.left),Math.max(this.top,e.top),Math.min(this.right,e.right),Math.min(this.bottom,e.bottom));return n.width>0&&n.height>0?n:null}},{key:"ceil",value:function(e){var n=Math.floor(this.left),r=Math.floor(this.top),i=Math.ceil(this.right),o=Math.ceil(this.bottom);if(e){var a=i-n,s=o-r;i=n+(a+=a%2),o=r+(s+=s%2)}return new t(n,r,i,o)}},{key:"floor",value:function(e){var n=Math.ceil(this.left),r=Math.ceil(this.top),i=Math.floor(this.right),o=Math.floor(this.bottom);if(e){var a=i-n,s=o-r;i=n+(a-=a%2),o=r+(s-=s%2)}return new t(n,r,i,o)}},{key:"contains",value:function(t){return this.left<=t.x&&this.right>=t.x&&this.top<=t.y&&this.bottom>=t.y}},{key:"toPath",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A.BLACK,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return{layout:[Ye.Property.X,Ye.Property.Y],size:e,color:t,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}},{key:"toGLRect",value:function(){return Ve.makeWithSize(this.x,this.y,this.width,this.height)}}],[{key:"fromGLRect",value:function(e){if(!e)return null;if(!(e instanceof Ve))throw new TypeError("rect must be instance of GLRect");return t.makeWithSize(e.left,e.bottom,e.width,e.height)}},{key:"ofPolygon",value:function(e){return t.ofPolygons([e])}},{key:"ofPolygons",value:function(e){if(!e.length)return null;var n=Number.MAX_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;return e.forEach((function(t){for(var e=0;e<t.length;e+=2){var a=t[e],s=t[e+1];n=Math.min(n,a),r=Math.min(r,s),i=Math.max(i,a),o=Math.max(o,s)}})),t.make(n,r,i,o)}},{key:"ofSpline",value:function(e,n,r){for(var i,o=0;o<e.length;o++)i=Ve.calculateBrushGLSegmentBounds(e.getPoint(o),n,r).union(i);return t.fromGLRect(i)}},{key:"ofEdges",value:function(e,n,r,i){return new t(e,n,r,i)}},{key:"create",value:function(e,n,r,i){return new t(e,n,e+r,n+i)}},{key:"make",value:function(e,n,r,i){return new t(e,n,r,i)}},{key:"makeWithSize",value:function(e,n,r,i){return new t(e,n,e+r,n+i)}},{key:"union",value:function(t,e){return t?e?t.union(e):t:e}},{key:"intersect",value:function(t,e){return t&&e?t.intersect(e):null}}]),t}(),We=(ENVIRONMENT,EnvironmentType.NODE,ClipperLib),qe=We.Clipper,Ze=We.Paths,Ke=We.Path,Je=We.ClipType,Qe=We.PolyType,$e=We.PolyFillType,tn=function(){function t(n){e(this,t);var r=new Ze;"number"==typeof n[0]&&(n=[n]);var i=He.ofPolygons(n),o=65534/(i.width+1e-16),a=65534/(i.height+1e-16),s=Math.floor(Math.min(o,a)),u=i.left+32767/s,c=i.top+32767/s;n.forEach((function(t){for(var e=new Ke,n=0;n<t.length;n+=2){var i=(t[n]-u)*s,o=(t[n+1]-c)*s,a=i<0?Math.ceil(i):Math.floor(i),h=o<0?Math.ceil(o):Math.floor(o);e.push({X:a,Y:h})}r.push(e)})),this.subject=r,this.solution=new Ze,this.bounds=i,this.transform={scale:s,offsetX:u,offsetY:c}}return I(t,[{key:"toPath2D",value:function(){var t=this;return this.lastPoint={},this.solution.map((function(e){return t.flatPath(e)}))}},{key:"flatPath",value:function(t){var e=this,n=[];return t.forEach((function(t){e.lastPoint.X==t.X&&e.lastPoint.Y==t.Y||(n.push(t.X/e.transform.scale+e.transform.offsetX,t.Y/e.transform.scale+e.transform.offsetY),e.lastPoint=t)})),n}},{key:"apply",value:function(t){var e=this,n=new Ze;return"number"==typeof t[0]&&(t=[t]),t.forEach((function(t){for(var r=new Ke,i=0;i<t.length;i+=2){var o=(t[i]-e.transform.offsetX)*e.transform.scale,a=(t[i+1]-e.transform.offsetY)*e.transform.scale,s=o<0?Math.ceil(o):Math.floor(o),u=a<0?Math.ceil(a):Math.floor(a);r.push({X:s,Y:u})}n.push(r)})),n}}]),t}(),en=function(){function t(){e(this,t)}return I(t,null,[{key:"union",value:function(t){var e=new tn(t),n=new qe;return n.StrictlySimple=!0,n.AddPaths(e.subject,Qe.ptSubject,!0),n.Execute(Je.ctUnion,e.solution,$e.pftNonZero,$e.pftNonZero),e.toPath2D()}},{key:"intersection",value:function(t,e){t instanceof tn||(t=new tn(t)),t.clip=t.apply(e);var n=new qe;return n.StrictlySimple=!0,n.AddPaths(t.subject,Qe.ptSubject,!0),n.AddPaths(t.clip,Qe.ptClip,!0),n.Execute(Je.ctIntersection,t.solution,$e.pftNonZero,$e.pftNonZero),t.solution.length>0?t:null}},{key:"createClipperPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,n=new Ke;n.scale=e;for(var r=0;r<t.length;r++){var i=r*t.stride;n.push({X:Math.round(t.points[i]*e),Y:Math.round(t.points[i+1]*e)})}return n}},{key:"containsPoint",value:function(t,e){var n={X:Math.round(e.x*t.scale),Y:Math.round(e.y*t.scale)};return 1==qe.PointInPolygon(n,t)}}]),t}(),nn=r((function(t){var e=function(t){var e=Object.prototype,n=e.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function s(t,e,n,r){var i=e&&e.prototype instanceof h?e:h,o=Object.create(i.prototype),a=new w(r||[]);return o._invoke=function(t,e,n){var r="suspendedStart";return function(i,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw o;return P()}for(n.method=i,n.arg=o;;){var a=n.delegate;if(a){var s=b(a,n);if(s){if(s===c)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var h=u(t,e,n);if("normal"===h.type){if(r=n.done?"completed":"suspendedYield",h.arg===c)continue;return{value:h.arg,done:n.done}}"throw"===h.type&&(r="completed",n.method="throw",n.arg=h.arg)}}}(t,n,a),o}function u(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=s;var c={};function h(){}function l(){}function f(){}var d={};d[i]=function(){return this};var p=Object.getPrototypeOf,y=p&&p(p(R([])));y&&y!==e&&n.call(y,i)&&(d=y);var v=f.prototype=h.prototype=Object.create(d);function m(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function g(t,e){var r;this._invoke=function(i,o){function a(){return new e((function(r,a){!function r(i,o,a,s){var c=u(t[i],t,o);if("throw"!==c.type){var h=c.arg,l=h.value;return l&&"object"==typeof l&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){h.value=t,a(h)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}(i,o,r,a)}))}return r=r?r.then(a,a):a()}}function b(t,e){var n=t.iterator[e.method];if(void 0===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return c;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var r=u(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,c;var i=r.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,c):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function x(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function E(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function w(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(x,this),this.reset(!0)}function R(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function e(){for(;++r<t.length;)if(n.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:P}}function P(){return{value:void 0,done:!0}}return l.prototype=v.constructor=f,f.constructor=l,f[a]=l.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===l||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,a in t||(t[a]="GeneratorFunction")),t.prototype=Object.create(v),t},t.awrap=function(t){return{__await:t}},m(g.prototype),g.prototype[o]=function(){return this},t.AsyncIterator=g,t.async=function(e,n,r,i,o){void 0===o&&(o=Promise);var a=new g(s(e,n,r,i),o);return t.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},m(v),v[a]="Generator",v[i]=function(){return this},v.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},t.values=R,w.prototype={constructor:w,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(n,r){return a.type="throw",a.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var s=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(s&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),E(n),c}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;E(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:R(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}));function rn(t,e,n,r,i,o,a){try{var s=t[o](a),u=s.value}catch(t){return void n(t)}s.done?e(u):Promise.resolve(u).then(r,i)}var on=function(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function a(t){rn(o,r,i,a,s,"next",t)}function s(t){rn(o,r,i,a,s,"throw",t)}a(void 0)}))}};function an(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return sn(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return sn(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function sn(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function un(t){return cn.apply(this,arguments)}function cn(){return(cn=on(nn.mark((function t(e){var n,r,i,o,a=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=a.length>1&&void 0!==a[1]?a[1]:"binary",!(e instanceof Uint8Array)){t.next=3;break}return t.abrupt("return",e);case 3:return t.next=5,fetch(e,{mode:"no-cors"});case 5:if(i=t.sent,"json"!=n){t.next=12;break}return t.next=9,i.json();case 9:r=t.sent,t.next=28;break;case 12:if("text"!=n){t.next=18;break}return t.next=15,i.text();case 15:r=t.sent,t.next=28;break;case 18:if("blob"!=n){t.next=24;break}return t.next=21,i.blob();case 21:r=t.sent,t.next=28;break;case 24:return t.next=26,i.arrayBuffer();case 26:o=t.sent,r=new Uint8Array(o);case 28:return t.abrupt("return",r);case 29:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function hn(t){return new Promise((function(e,n){var r=new Image;r.crossOrigin="anonymous",r.onload=function(){if(ENVIRONMENT==EnvironmentType.NODE){var t=new OffscreenCanvas(r.width,r.height);t.getContext("2d").drawImage(r,0,0),e(t)}else e(r)},r.onerror=n,"string"==typeof t?r.src=t:ENVIRONMENT==EnvironmentType.NODE?t instanceof Uint8Array?r.src=Buffer.from(t):r.src=t:r.src=URL.createObjectURL(t)}))}function ln(t){return fn.apply(this,arguments)}function fn(){return(fn=on(nn.mark((function t(e){var n;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("string"!=typeof e&&ENVIRONMENT!=EnvironmentType.NODE){t.next=6;break}return t.next=3,hn(e);case 3:n=t.sent,t.next=15;break;case 6:if(!(e instanceof ArrayBuffer||e instanceof Uint8Array)){t.next=12;break}return t.next=9,createImageBitmap(new Blob([e],{type:"image/png"}));case 9:n=t.sent,t.next=15;break;case 12:return t.next=14,createImageBitmap(e);case 14:n=t.sent;case 15:return t.abrupt("return",n);case 16:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function dn(t){return pn.apply(this,arguments)}function pn(){return(pn=on(nn.mark((function t(e){var n,r,i,o,a,s,u;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(e.shape)){t.next=24;break}i=[],o=an(e.shape),t.prev=3,o.s();case 5:if((a=o.n()).done){t.next=13;break}return s=a.value,t.next=9,un(s);case 9:u=t.sent,i.push(u);case 11:t.next=5;break;case 13:t.next=18;break;case 15:t.prev=15,t.t0=t.catch(3),o.e(t.t0);case 18:return t.prev=18,o.f(),t.finish(18);case 21:n=i,t.next=27;break;case 24:return t.next=26,un(e.shape);case 26:n=t.sent;case 27:return t.next=29,un(e.fill);case 29:return r=t.sent,t.abrupt("return",{shape:n,fill:r});case 31:case"end":return t.stop()}}),t,null,[[3,15,18,21]])})))).apply(this,arguments)}var yn=Object.freeze({__proto__:null,loadFile:un,loadImage:ln,loadBrushGLBinary:dn,saveAs:function(t,e){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/octet-stream";if(t instanceof Blob)n=URL.createObjectURL(t);else{var i;t instanceof ArrayBuffer?i=[t]:t.buffer?(t.byteLength<t.buffer.byteLength&&(t=new Uint8Array(t)),i=[t.buffer]):t instanceof Array&&(i=t);var o=new Blob(i,{type:r});n=URL.createObjectURL(o)}var a=document.createElement("a");a.href=n,a.download=e,a.appendChild(document.createTextNode(e)),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout((function(){URL.revokeObjectURL(n),a.remove()}),911)}});function vn(t,e){var n,r={};return Object.defineProperty(r,"x",{value:e.x-t.x,enumerable:!0}),Object.defineProperty(r,"y",{value:e.y-t.y,enumerable:!0}),Object.defineProperty(r,"length",{get:function(){return isNaN(n)&&(n=Math.sqrt(r.x*r.x+r.y*r.y)),n},enumerable:!0}),r}function mn(t,e){var n=t.x*e.x+t.y*e.y,r=t.x*e.y-t.y*e.x;return Math.atan2(r,n)}var gn=Object.freeze({__proto__:null,vector:vn,angle:mn}),bn=gt,xn=K,En=Oe;function wn(t){return bn.fromValues(t.x,t.y,t.z||0)}function Rn(t){var e=xn.create();return t&&(e[En.a]=t.a||1,e[En.b]=t.b||0,e[En.c]=t.c||0,e[En.d]=t.d||1,e[En.dx]=t.dx||t.tx||0,e[En.dy]=t.dy||t.ty||0),e}function Pn(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t;arguments.length>1&&(r={x:t,y:e,z:n});var i=Rn(),o=wn(r);return xn.fromTranslation(i,o),i}function kn(t,e,n){return Le(t,e,n)}function Mn(t,e){var n=wn(t);return bn.transformMat4(n,n,e),{x:n[0],y:n[1],z:n[2]}}function Tn(t,e){var n=Mn({x:t.left,y:t.top},e),r=Mn({x:t.right,y:t.top},e),i=Mn({x:t.left,y:t.bottom},e),o=Mn({x:t.right,y:t.bottom},e),a=Math.min(n.x,r.x,i.x,o.x),s=Math.min(n.y,r.y,i.y,o.y),u=Math.max(n.x,r.x,i.x,o.x),c=Math.max(n.y,r.y,i.y,o.y);return new He(a,s,u,c)}function In(t,e){var n=Rn();return xn.multiply(n,t,e),n}function Sn(t){var e=Rn();return xn.invert(e,t),e}var An=Object.freeze({__proto__:null,makeGLPoint:wn,makeGLMatrix:Rn,isIdentity:function(t){return 1==t[En.a]&&0==t[En.b]&&0==t[En.c]&&1==t[En.d]&&0==t[En.dx]&&0==t[En.dy]},makeTranslate:Pn,makeScaleAtPoint:function(t,e){return De(t,e)},makeRotationAroundPoint:function(t,e){return Ne(t,e)},makeTransformAroundPoint:kn,transformPoint:Mn,transformRect:Tn,multiply:In,invert:Sn}),Cn=function(){function t(n){var r=this;e(this,t),this.header=[],this.table=[],n.forEach((function(t){"string"==typeof t&&(t={name:t,title:t}),t.size=t.title.length,r.header.push(t)}))}return I(t,[{key:"insert",value:function(t){this.table.push(t),this.header.forEach((function(e){var n=t[e.name];null!=n&&(e.size=Math.max(e.size,n.toString().length))}))}},{key:"build",value:function(){var t=this,e=[],n=this.header.length+1,r=[];this.header.forEach((function(e){n+=e.size+2;var i=e.size-e.title.length,o=Math.floor(i/2),a=Math.ceil(i/2);r.push(t.getRepetedValue(o)+e.title+t.getRepetedValue(a))})),this.table.forEach((function(n){var r=[];t.header.forEach((function(e){var i=null==n[e.name]?"":n[e.name],o=e.size-i.toString().length;r.push(i+t.getRepetedValue(o))})),e.push(r)}));var i="";return i+=this.getRepetedValue(n,"="),i+="\n",i+=this.getFormattedRow(r),i+="\n",i+=this.getRepetedValue(n,"="),i+="\n",e.forEach((function(e){i+=t.getFormattedRow(e),i+="\n"})),i}},{key:"getFormattedRow",value:function(t){var e="| ";return t.forEach((function(t){e+=t,e+=" | "})),e.trim()}},{key:"getRepetedValue",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ";return new Array(t+1).join(e)}}]),t}(),On={longToByteArray:function(t){for(var e=[0,0,0,0,0,0,0,0],n=0;n<e.length;n++){var r=255&t;e[n]=r,t=(t-r)/256}return e},byteArrayToLong:function(t){for(var e=0,n=t.length-1;n>=0;n--)e=256*e+t[n];return e},crc32:function(){for(var t=new Uint32Array(256),e=256;e--;){for(var n=e,r=8;r--;)n=1&n?3988292384^n>>>1:n>>>1;t[e]=n}return function(e){for(var n=-1,r=0,i=e.length;r<i;r++)n=n>>>8^t[255&n^e[r]];return(-1^n)>>>0}}(),mapTo:function(t,e,n){return n.min+(On.clamp(t,e)-e.min)/(e.max-e.min)*(n.max-n.min)},clamp:function(t,e){return Math.min(Math.max(t,e.min),e.max)},comparator:function(){var t=Array.prototype.slice.call(arguments),e=function(t,e,n){var r="asc"===n?1:-1;return t>e?1*r:t<e?-1*r:0},n=function(t,e,n){return e.replace("[",".").replace("]","").split(".").forEach((function(e){return t=t[e]})),n?t.toLowerCase():t};return function(r,i){return t.map((function(t){return e(n(r,t.sortBy,t.ignoreCase),n(i,t.sortBy,t.ignoreCase),t.sortOrder)})).reduceRight((function(t,e){return e||t}))}},getPropName:function(t,e){var n=t.split("_"),r=n.first.toLowerCase();e&&(r=r.substring(0,1).toUpperCase()+r.substring(1));for(var i=1;i<n.length;i++)r+=n[i].substring(0,1),r+=n[i].substring(1).toLowerCase();return r},getEnumValueName:function(t){for(var e="",n=0;n<t.length;n++)n>0&&t[n]!=t[n].toLowerCase()&&(e+="_"),e+=t[n];return e.toUpperCase()}};var Dn=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t},Nn=function(){function t(){e(this,t)}return I(t,[{key:"getInkBuilder",value:function(){throw new Error("InkController.getInkBuilder(changedTouches = []) should be implemented")}},{key:"registerTouches",value:function(t){throw new Error("InkController.registerTouches(changedTouches) should be implemented")}},{key:"reset",value:function(t){throw new Error("InkController.reset(sensorPoint) should be implemented")}},{key:"begin",value:function(t){throw new Error("InkController.begin(sensorPoint) should be implemented")}},{key:"move",value:function(t){throw new Error("InkController.move(sensorPoint) should be implemented")}},{key:"end",value:function(t){throw new Error("InkController.end(sensorPoint) should be implemented")}},{key:"abort",value:function(){throw new Error("InkController.abort(sensorPoint) should be implemented")}},{key:"resize",value:function(){throw new Error("InkController.resize(sensorPoint) should be implemented")}}]),t}(),Ln=gt,_n=K,Bn={pointers:{pointer:["down","move","up"],mouse:["down","move","up"],touch:["start","move","end"]},open:function(t){if(!(t instanceof Nn))throw new Error("Argument doesn't implement InkController interface");this.inkController=t,this.canvas=t.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset:function(t){for(var e in this.pointers){var n="touch"==e?{passive:!0}:void 0,r=e+this.pointers[e][0];this.canvas.removeEventListener(r,this.begin),t.canvas.surface.addEventListener(r,this.begin,n)}this.dettachResize(),this.inkController=t,this.canvas=t.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start:function(t){var e=t?Dn({},t,this.pointers[t]):this.pointers;for(t in e)for(var n="touch"==t?{passive:!0}:void 0,r=0;r<e[t].length;r++){var i=t+e[t][r];0==r?this.canvas.addEventListener(i,this.begin,n):addEventListener(i,2==r?this.end:this.move,n)}},stop:function(t){var e=t?Dn({},t,this.pointers[t]):this.pointers;for(t in t&&"mouse"!=t||clearTimeout(this.timeoutID),e)for(var n=0;n<e[t].length;n++){var r=t+e[t][n];0==n?this.canvas.removeEventListener(r,this.begin):removeEventListener(r,2==n?this.end:this.move)}},attachResize:function(){var t,e,n,r=this;this.inkController.resize&&(this.resize=(t=function(){return r.inkController.resize()},e=200,n=null,function(){var r=this,i=arguments;clearTimeout(n),n=setTimeout((function(){t.apply(r,i)}),e)}),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(t){return this.provider==this.getInputProvider(t)&&(!t.pointerType||"pen"==t.pointerType)},isInputExpected:function(t){var e=!1,n=this.inkController.getInkBuilder(t.changedTouches);return n&&(e=t.type.endsWith("down")||t.type.endsWith("start")?!n.phase:!!n.phase),e},getSensorPoint:function(t){var e=void 0,n=this.inkController.getInkBuilder(t.changedTouches);if(n){var r=this.getOffset(t);e=n.createSensorPoint(t,r.x,r.y)}return e},getOffset:function(t){if(t.changedTouches){var e=this.inkController.getInkBuilder(t.changedTouches);t=e.touchID!=t.changedTouches.item(0).identifier?Array.from(t.changedTouches).filter((function(t){return t.identifier==e.touchID})).first:t.changedTouches.item(0)}var n=this.canvas.offsetParent;if(!n)return{x:0,y:0};var r=n.getBoundingClientRect(),i={x:t.pageX-r.x,y:t.pageY-r.y};if(this.inkController.transform){var o=_n.create();_n.invert(o,this.inkController.transform);var a=Ln.fromValues(i.x,i.y,0);Ln.transformMat4(a,a,o),i.x=a[0],i.y=a[1]}return i},getInputProvider:function(t){return t.pointerType?t.pointerType:t.type.replace(/down|start|move|up|end/g,"")},begin:function(t){if(!(t instanceof MouseEvent&&0!=t.button)&&(this.provider||(this.provider=this.getInputProvider(t)),this.isInputAllowed(t)&&(t instanceof TouchEvent&&this.inkController.registerTouches(t.changedTouches),this.isInputExpected(t)))){var e=this.getSensorPoint(t);e&&this.inkController.begin(e)}},move:function(t){if(this.isInputAllowed(t)&&this.isInputExpected(t)){var e=this.getSensorPoint(t);e&&this.inkController.move(e)}},end:function(t){var e=this;if(this.isInputAllowed(t)&&this.isInputExpected(t)){var n=this.getSensorPoint(t);n&&(this.inkController.end(n),t instanceof MouseEvent||(this.stop("mouse"),this.timeoutID=setTimeout((function(){return e.start("mouse")}),500))),t.touches&&0!=t.touches.length||delete this.provider}},abort:function(t){delete this.provider,this.inkController.abort&&this.inkController.abort(t)}},Fn={init:function(t){var e=[],n=t.options.Scale;return isNaN(n.MinWidth)&&(n.MinWidth=50),isNaN(n.MinHeight)&&(n.MinHeight=50),(n.KeepRatio?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]).forEach((function(n){var r=document.createElement("div");r.className="ResizeHandle "+n,r.type=n,r.root=t,r.onmouseover=function(){Fn.updateCursor(this)},t.appendChild(r),e.push(r)})),e},start:function(t){switch(this.origin=this.obj.frame.toRect(),this.center={x:this.origin.left+this.origin.width/2,y:this.origin.top+this.origin.height/2},this.offsetParent=this.obj.offsetParent.getBoundingClientRect(),t.currentTarget.type){case"TL":this.point={x:-this.origin.width/2,y:-this.origin.height/2};break;case"T":this.point={x:0,y:-this.origin.height/2};break;case"TR":this.point={x:this.origin.width/2,y:-this.origin.height/2};break;case"R":this.point={x:this.origin.width/2,y:0};break;case"BR":this.point={x:this.origin.width/2,y:this.origin.height/2};break;case"B":this.point={x:0,y:this.origin.height/2};break;case"BL":this.point={x:-this.origin.width/2,y:this.origin.height/2};break;case"L":this.point={x:-this.origin.width/2,y:0}}this.options.ExcludeRotation instanceof Function?this.excludeRotation=this.options.ExcludeRotation.call({}):this.excludeRotation=!!this.options.ExcludeRotation,this.excludeRotation=this.excludeRotation||0==this.point.x||0==this.point.y},move:function(t){var e=Fn.Transformer,n=Mn({x:0,y:0},e.transform),r=Mn(this.point,e.transform),i={x:2*n.x-r.x,y:2*n.y-r.y},o=vn(i,{x:t.clientX-this.offsetParent.x-this.center.x,y:t.clientY-this.offsetParent.y-this.center.y}),a=vn(i,r),s=this.excludeRotation?0:mn(a,o),u=o.length/a.length;0==this.point.x?u={x:1,y:u}:0==this.point.y&&(u={x:u,y:1});var c=kn(s,u,i),h=In(c,e.transform),l=Tn(this.origin,h);return(l.width<this.options.MinWidth||l.height<this.options.MinHeight)&&(c=null),c},end:function(t){},updateCursor:function(t){var e,n=t.root.getTransformStyle().rotate.angle;"TR"==t.type||"BL"==t.type?n+=Math.PI/4:"TL"==t.type||"BR"==t.type?n+=3*Math.PI/4:"L"!=t.type&&"R"!=t.type||(n+=Math.PI/2),n<0?n+=2*Math.PI:n>2*Math.PI&&(n-=2*Math.PI),e=n>Math.PI/8&&n<=3*Math.PI/8||n>=9*Math.PI/8&&n<=11*Math.PI/8?"nesw-resize":n>3*Math.PI/8&&n<=5*Math.PI/8||n>=11*Math.PI/8&&n<=13*Math.PI/8?"ew-resize":n>5*Math.PI/8&&n<=7*Math.PI/8||n>=13*Math.PI/8&&n<=15*Math.PI/8?"nwse-resize":"ns-resize",t.style.cursor=e}},Un={init:function(t){return t.options.Rotate.Handles},start:function(t){var e=this.obj.getBoundingClientRect();this.center={x:e.left+e.width/2,y:e.top+e.height/2},this.centerToMouse=vn(this.center,{x:t.clientX,y:t.clientY})},move:function(t){var e=vn(this.center,{x:t.clientX,y:t.clientY}),n=mn(this.centerToMouse,e);if(0==n)return null;this.centerToMouse=e;var r=Un.Transformer;return Ne(n,{x:r.transform[Oe.dx],y:r.transform[Oe.dy]})},end:function(t){}},jn=gt,Yn=K,Xn={elements:[],initEvents:function(t){t.addEventListener("touchstart",(function(t){2==t.touches.length&&(this!=t.touches[0].target&&!this.contains(t.touches[0].target)||this!=t.touches[1].target&&!this.contains(t.touches[1].target)||(Xn.element=this,Xn.options=this.options,Xn.start(t),Xn.fireEvent(t,"start")))}),{passive:!1}),t.addEventListener("touchmove",(function(t){if(Xn.element==this){var e=Xn.move(t);Xn.fireEvent(t,"",e)}}),{passive:!1}),t.addEventListener("touchend",(function(t){Xn.element&&Xn.element==this&&t.touches.length<2&&(Xn.end(t),Xn.fireEvent(t,"end"),Xn.element=null)}),{passive:!1})},start:function(t){var e=(this.element.frame||this.element).toRect();this.center={x:e.left+e.width/2,y:e.top+e.height/2},this.offsetParent=this.element.offsetParent.getBoundingClientRect(),this.lastPinch=this.createPinch(t),this.options.Transform.ExcludeRotation instanceof Function?this.excludeRotation=this.options.Transform.ExcludeRotation():this.excludeRotation=!!this.options.Transform.ExcludeRotation},move:function(t){var e=this.createPinch(t),n=vn(this.lastPinch[0],this.lastPinch[1]),r=vn(e[0],e[1]),i=(this.lastPinch[0].x+this.lastPinch[1].x)/2,o=(this.lastPinch[0].y+this.lastPinch[1].y)/2,a=(e[0].x+e[1].x)/2,s=(e[0].y+e[1].y)/2,u={x:a-i,y:s-o},c=this.excludeRotation?0:mn(n,r),h=r.length/n.length,l={x:a-this.offsetParent.x-this.center.x,y:s-this.offsetParent.y-this.center.y};this.lastPinch=e;var f,d={pin:l,origin:this.center,scale:h,rotation:c,translation:u};return Object.defineProperty(d,"transform",{get:function(){return f||(f=Le(this.rotation,this.scale,this.pin),Yn.translate(f,f,jn.fromValues(this.translation.x,this.translation.y,0))),f}}),d},end:function(t){},createPinch:function(t){var e=[];return e[0]={x:t.touches[0].clientX,y:t.touches[0].clientY},e[1]={x:t.touches[1].clientX,y:t.touches[1].clientY},e},fireEvent:function(t,e,n){t.cancelable&&t.preventDefault(),t.stopPropagation();var r=new CustomEvent("pinch"+e,{detail:n});r.touches=t.touches,r.changedTouches=t.changedTouches,this.element.dispatchEvent(r)}},Gn={register:function(t,e){return Xn.elements.contains(t)?(t.options.Transform=Object.assign(t.options.Transform,e),!1):(t.options||(t.options={}),t.options.Transform=e||{},Xn.elements.push(t),Xn.initEvents(t),!0)}},zn={Translate:{init:function(t){return[t.options.Translate.Handle||t]},start:function(t){this.lastPoint={x:t.clientX,y:t.clientY}},move:function(t){return this.delta={x:t.clientX-this.lastPoint.x,y:t.clientY-this.lastPoint.y},this.lastPoint={x:t.clientX,y:t.clientY},Pn(this.delta)},end:function(t){}},Scale:Fn,Rotate:Un,Transform:{start:function(t){},move:function(t){return t.detail.transform},end:function(t){}},add:function(t,e,n){if(e.options||(e.options={}),t in e.options)throw new Error(t+" transform already added on this object");e.options[t]=n||{},zn.initTransformFrame(e),zn[t].Transformer=zn.Transformer;var r=zn[t].init(e);zn.attachEvents(r,t,e)},attachEvents:function(t,e,n){t.forEach((function(t){t.addEventListener("dragstart",(function(t){t.preventDefault(),t.stopPropagation()})),t.addEventListener("mousedown",(function(t){0==t.button&&zn.start(t,e,n)})),document.addEventListener("mousemove",(function(t){zn.move(t,e)})),document.addEventListener("mouseup",(function(t){zn.end(t,e)})),t.addEventListener("touchstart",(function(t){zn.TransformTransform||zn.start(t,e,n)}),{passive:!1}),document.addEventListener("touchmove",(function(t){zn.move(t,e)}),{passive:!1}),document.addEventListener("touchend",(function(t){zn.end(t,e)}),{passive:!1})}));var r=!1;n.options.Scale&&(r=n.options.Scale.ExcludeRotation),r||(r=!n.options.Rotate),Gn.register(n,{ExcludeRotation:r})&&(n.addEventListener("pinchstart",(function(t){zn.TranslateTransform&&zn.end(t,"Translate",!0),zn.ScaleTransform&&zn.end(t,"Scale",!0),zn.RotateTransform&&zn.end(t,"Rotate",!0),zn.start(t,"Transform",n)})),n.addEventListener("pinch",(function(t){zn.move(t,"Transform")})),n.addEventListener("pinchend",(function(t){zn.end(t,"Transform")})))},start:function(t,e,n){if(!(zn.TransformTransform||zn.TranslateTransform||zn.ScaleTransform||zn.RotateTransform)){t=this.fixE(t,e);var r=zn[e];r.obj=n,r.options=n.options[e],r.transform=Rn();var i=n.frame.toRect();r.originCenter={x:i.left+i.width/2,y:i.top+i.height/2},zn.Transformer.transform=_e(n.frame);var o=zn[e].start(t),a=new CustomEvent("TransformStart",{detail:o});r.obj.dispatchEvent(a),this[e+"Transform"]=!0}},move:function(t,e){if(this[e+"Transform"]&&("Transform"==e||!t.touches||t.touches[0].identifier==t.changedTouches[0].identifier)){t=this.fixE(t,e);var n=zn[e],r=n.move(t);if(r){var i=zn.Transformer;i.transform=In(r,i.transform);var o=Rn(),a=Pn(-n.originCenter.x,-n.originCenter.y);n.obj.transform&&(o=In(n.obj.transform,o)),o=In(a,o),o=In(r,o),o=In(Sn(a),o),n.obj.transform&&(o=In(Sn(n.obj.transform),o));var s=new CustomEvent("Transform",{detail:o});n.obj.dispatchEvent(s),n.obj.frame.style.transform=Be(i.transform),this.applyUI(n.obj)}}},end:function(t,e,n){if(this[e+"Transform"]&&(n||"Transform"==e||!t.touches||!t.touches[0]||t.touches[0].identifier==t.changedTouches[0].identifier)){t=this.fixE(t,e);var r=zn[e],i=r.end(t),o=new CustomEvent("TransformEnd",{detail:i});r.obj.dispatchEvent(o),this[e+"Transform"]=!1}},initTransformFrame:function(t){t.frame||(t.frame=document.createElement("div"),t.frame.style.display=t.style.display,t.frame.style.position="absolute",t.frame.style.left=t.style.left,t.frame.style.top=t.style.top,t.frame.style.width=t.style.width,t.frame.style.height=t.style.height,t.parentNode.insertBefore(t.frame,t),new MutationObserver((function(e){var n={};e.last.oldValue.split("; ").forEach((function(t){var e=t.replace(";","").split(": ");n[e[0]]=e[1]}));var r=e.last.target.style.display,i=n.display||"";r!=i&&("none"==i?(t.frame.style.left=t.style.left,t.frame.style.top=t.style.top,t.frame.style.width=t.style.width,t.frame.style.height=t.style.height,t.style.transform&&(t.frame.style.transform=t.style.transform,t.style.transform=""),t.frame.style.visibility="hidden",t.frame.style.display="",zn.applyUI(t),t.frame.style.visibility=""):t.frame.style.display="none")})).observe(t,{attributes:!0,attributeOldValue:!0,attributeFilter:["style"]}))},applyUI:function(t){var e=t.frame.getTransformStyle(),n=t.frame.getMathStyle("left"),r=t.frame.getMathStyle("top"),i=t.frame.getMathStyle("width"),o=t.frame.getMathStyle("height"),a=n+i/2,s=r+o/2;i*=e.scale.x,o*=e.scale.y,n=a-i/2+e.translate.x,r=s-o/2+e.translate.y,t.style.left=n+"px",t.style.top=r+"px",t.style.width=i+"px",t.style.height=o+"px",0==e.rotate.angle?t.style.transform="":t.style.transform="rotate("+e.rotate.angle+"rad)"},fixE:function(t,e){if(t.preventDefault(),t.stopPropagation(),"Transform"!=e&&t.changedTouches){var n=t.changedTouches[0];n.currentTarget=n.target,t=n}return t}},Vn={addTranslate:function(t,e){zn.add("Translate",t,e)},addScale:function(t,e){zn.add("Scale",t,e)},addRotate:function(t,e){zn.add("Rotate",t,e)}};zn.Transformer=Vn;var Hn={init:function(t,e,n){e.removeEventListener("mousedown",t.start),e.addEventListener("mousedown",t.start),e.removeEventListener("touchstart",t.start),e.addEventListener("touchstart",t.start),n||this.attachOnTransformEvents(t,e.root)},attachOnTransformEvents:function(t,e){e["on"+t.name+"Start"]=new Function,e["on"+t.name+"End"]=new Function,e["on"+t.name]=new Function},onStart:function(t){document.addEventListener("mousemove",t.move),document.addEventListener("mouseup",t.end),document.addEventListener("touchmove",t.move),document.addEventListener("touchend",t.end)},onEnd:function(t){document.removeEventListener("mousemove",t.move),document.removeEventListener("mouseup",t.end),document.removeEventListener("touchmove",t.move),document.removeEventListener("touchend",t.end)},fixE:function(t){return(t=t||window.event).changedTouches&&(t=t.changedTouches[0]),t}},Wn={name:"Drag",obj:null,init:function(t,e,n){n||(n={}),n.Axis||(n.Axis="XY"),t.options=n,t.root=e||t,t.hmode=!!n.SwapHorzRef,t.vmode=!!n.SwapVertRef,Hn.init(Wn,t)},start:function(t){t=Hn.fixE(t);var e=Wn.obj=this,n=e.root.toRect((e.vmode?"T":"B")+(e.hmode?"L":"R")),r=parseInt(n.x),i=parseInt(n.y);return e.sx=r,e.sy=i,e.lx=t.clientX,e.ly=t.clientY,e.root.onDragStart(r,i,e),Hn.onStart(Wn),!1},move:function(t){t=Hn.fixE(t);var e=Wn.obj,n=e.root.toRect((e.vmode?"T":"B")+(e.hmode?"L":"R")),r=parseInt(n.x),i=parseInt(n.y),o=e.options.Axis.contains("X")?r+(t.clientX-e.lx)*(e.hmode?1:-1):e.sx,a=e.options.Axis.contains("Y")?i+(t.clientY-e.ly)*(e.vmode?1:-1):e.sy;return!isNaN(e.options.MinX)&&o<e.options.MinX?o=e.options.MinX:isNaN(e.options.MaxX)||(e.options.MaxPreserveSize&&e.options.MaxX<o+n.offsetWidth?o=e.options.MaxX-n.offsetWidth:o>e.options.MaxX&&(o=e.options.MaxX)),!isNaN(e.options.MinY)&&a<e.options.MinY?a=e.options.MinY:isNaN(e.options.MaxY)||(e.options.MaxPreserveSize&&e.options.MaxY<a+n.offsetHeight?a=e.options.MaxY-n.offsetHeight:a>e.options.MaxY&&(a=e.options.MaxY)),e.options.XMapper?o=e.options.XMapper(i):e.options.YMapper&&(a=e.options.YMapper(r)),o||(o=r),a||(a=i),e.root.style[e.hmode?"left":"right"]=o+"px",e.root.style[e.vmode?"top":"bottom"]=a+"px",e.lx=t.clientX,e.ly=t.clientY,e.root.onDrag(o,a,e),!1},end:function(){var t=Wn.obj;Hn.onEnd(Wn),t.root.onDragEnd(parseInt(t.root.style[t.hmode?"left":"right"]),parseInt(t.root.style[t.vmode?"top":"bottom"]),t),Wn.obj=null}},qn={name:"Resize",handle:null,init:function(t,e){if(!t.options){e||(e={}),isNaN(e.MinWidth)&&(e.MinWidth=50),isNaN(e.MinHeight)&&(e.MinHeight=50),t.options=e;for(var n=e.Handles||(e.KeepRatio?["TL","TR","BR","BL"]:["TL","T","TR","R","BR","B","BL","L"]),r=0;r<n.length;r++){var i=document.createElement("div");i.className="ResizeHandle "+n[r],i.type=n[r],i.root=t,t.appendChild(i),Hn.init(qn,i,!0)}Hn.attachOnTransformEvents(qn,t)}},start:function(t){t=Hn.fixE(t);var e=qn.handle=this,n=this.root,r=n.toRect();return n.sw=r.width,n.sh=r.height,n.sx=r.left,n.sy=r.top,n.lx=t.clientX,n.ly=t.clientY,n.onResizeStart(n.sx,n.sy,n.sw,n.sh,e),Hn.onStart(qn),!1},move:function(t){t=Hn.fixE(t);var e=qn.handle,n=e.root,r=n.toRect(),i=t.clientX-n.lx,o=t.clientY-n.ly,a=r.left,s=r.top,u=r.width,c=r.height;if(e.type.endsWith("L")&&(a+=i,u-=i),e.type.startsWith("T")&&(s+=o,c-=o),e.type.endsWith("R")&&(u+=i),e.type.startsWith("B")&&(c+=o),!isNaN(n.options.MinX)&&a<n.options.MinX?(e.type.endsWith("L")&&(u+=a-n.options.MinX),a=n.options.MinX):!isNaN(n.options.MaxX)&&n.options.MaxX<a+u&&(u=n.options.MaxX-a),!isNaN(n.options.MinY)&&s<n.options.MinY?(e.type.startsWith("T")&&(c+=s-n.options.MinY),s=n.options.MinY):!isNaN(n.options.MaxY)&&n.options.MaxY<s+c&&(c=n.options.MaxY-s),u<n.options.MinWidth?(e.type.endsWith("L")&&(a+=u-n.options.MinWidth),u=n.options.MinWidth):!isNaN(n.options.MaxWidth)&&u>n.options.MaxWidth&&(e.type.endsWith("L")&&(a+=u-n.options.MaxWidth),u=n.options.MaxWidth),c<n.options.MinHeight?(e.type.startsWith("T")&&(s+=c-n.options.MinHeight),c=n.options.MinHeight):n.options.MaxHeight&&c>n.options.MaxHeight&&(e.type.startsWith("T")&&(s+=c-n.options.MaxHeight),c=n.options.MaxHeight),n.options.KeepRatio){var h={x:a,y:s,width:u,height:c};Math.abs(i)>Math.abs(o)?qn.keepRatioByWidth(h,u):Math.abs(i)<Math.abs(o)&&qn.keepRatioByHeight(h,c),a=h.x,s=h.y,u=h.width,c=h.height}return n.style.left=a+"px",n.style.top=s+"px",n.style.width=u+"px",n.style.height=c+"px",n.onResize(a,s,u,c,e),n.lx=t.clientX,n.ly=t.clientY,!1},end:function(){var t=qn.handle,e=t.root;Hn.onEnd(qn);var n=e.toRect();e.onResizeEnd(n.left,n.top,n.width,n.height,t),qn.handle=null},keepRatioByWidth:function(t,e,n){var r=qn.handle,i=r.root,o=e/i.sw*i.sh,a=t.y;n||(o<i.options.MinHeight?(o=i.options.MinHeight,qn.keepRatioByHeight(t,o,!0)):o>i.options.MaxHeight&&(o=i.options.MaxHeight,qn.keepRatioByHeight(t,o,!0))),r.type.startsWith("T")&&(a-=o-t.height,!n&&!isNaN(i.options.MinY)&&a<i.options.MinY&&(o+=a-i.options.MinY,a=i.options.MinY,qn.keepRatioByHeight(t,o,!0))),!n&&!isNaN(i.options.MaxY)&&i.options.MaxY<a+o&&(o=i.options.MaxY-a,qn.keepRatioByHeight(t,o,!0)),t.y=a,t.height=o},keepRatioByHeight:function(t,e,n){var r=qn.handle,i=r.root,o=e/i.sh*i.sw,a=t.x;n||(o<i.options.MinWidth?(o=i.options.MinWidth,qn.keepRatioByWidth(t,o,!0)):o>i.options.MaxWidth&&(o=i.options.MaxWidth,qn.keepRatioByWidth(t,o,!0))),r.type.endsWith("L")&&(a-=o-t.width,!n&&!isNaN(i.options.MinX)&&a<i.options.MinX&&(o+=a-i.options.MinX,a=i.options.MinX,qn.keepRatioByWidth(t,o,!0))),!n&&!isNaN(i.options.MaxX)&&i.options.MaxX<a+o&&(o=i.options.MaxX-a,qn.keepRatioByWidth(t,o,!0)),t.x=a,t.width=o}},Zn=96/("undefined"==typeof window?1:window.devicePixelRatio),Kn={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*Zn},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*Zn},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*Zn},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*Zn},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*Zn},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*Zn},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*Zn},DIP:{METER:.0254/Zn,CENTIMETER:2.54/Zn,MILLIMETER:25.4/Zn,MICROMETER:25400/Zn,INCH:1/Zn,POINT:72/Zn,PICA:6/Zn,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Function.createEnum.call(Kn,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Function.createEnum.call(Kn,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);var Jn=Object.freeze({LENGTH:Kn.Unit.METER,TIME:Kn.Unit.SECOND,FORCE:Kn.Unit.NEWTON,ANGLE:Kn.Unit.RADIAN,NORMALIZED:Kn.Unit.NORMALIZED,LOGICAL:Kn.Unit.LOGICAL});Kn.getChannelResolution=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=1,r=Kn.getUnitMetric(t);return r!=Kn.Metric.NORMALIZED&&r!=Kn.Metric.LOGICAL&&(n=Kn[Jn[r.name].name][t.name]/e),n},Kn.convert=function(t,e,n,r){return e?n*Kn[Jn[t.name].name][r.name]/e:n},Kn.convertAny=function(t,e,n,r){return t*Kn[e.name][n.name]/r},Kn.getUnitMetric=function(t){switch(t){case Kn.Unit.METER:case Kn.Unit.CENTIMETER:case Kn.Unit.MILLIMETER:case Kn.Unit.MICROMETER:case Kn.Unit.INCH:case Kn.Unit.POINT:case Kn.Unit.PICA:case Kn.Unit.DIP:return Kn.Metric.LENGTH;case Kn.Unit.SECOND:case Kn.Unit.MILLISECOND:case Kn.Unit.MICROSECOND:case Kn.Unit.NANOSECOND:return Kn.Metric.TIME;case Kn.Unit.RADIAN:case Kn.Unit.DEGREE:return Kn.Metric.ANGLE;case Kn.Unit.NEWTON:return Kn.Metric.FORCE;case Kn.Unit.NORMALIZED:return Kn.Metric.NORMALIZED;case Kn.Unit.LOGICAL:return Kn.Metric.LOGICAL;default:throw console.warn(t),new Error("Invalid unit found")}},Kn.getUnit=function(t){return Jn[t.name]},Kn.convertValue=function(t,e,n){return t*Kn[e.name][n.name]},Object.freeze(Kn);var Qn={};ENVIRONMENT==EnvironmentType.NODE&&(Qn=systeminformation);var $n=Qn,tr=(ENVIRONMENT,EnvironmentType.NODE,md5),er=(ENVIRONMENT,EnvironmentType.NODE,Long),nr={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate:function(){var t=Date.now();return this.mask.replace(/[xy]/g,(function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)}))},fromString:function(t){return this.fromBytes(new Uint8Array(tr.arrayBuffer(t)))},toBytes:function(t){var e=[];return t.split("-").map((function(t,n){(n<3?t.match(/.{1,2}/g).reverse():t.match(/.{1,2}/g)).map((function(t){return e.push(parseInt(t,16))}))})),new Uint8Array(e)},fromBytes:function(t){var e=Array.from(t).map((function(t){return t.toString(16)})).map((function(t){return(1==t.length?"0":"")+t}));return e.slice(0,4).reverse().join("")+"-"+e.slice(4,6).reverse().join("")+"-"+e.slice(6,8).reverse().join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")},toUint32Array:function(t){var e=new Uint32Array(4),n=this.toBytes(t);return e[0]=new Uint32Array(n.slice(0,4).buffer)[0],e[1]=new Uint32Array(n.slice(4,8).buffer)[0],e[2]=new Uint32Array(n.slice(8,12).buffer)[0],e[3]=new Uint32Array(n.slice(12).buffer)[0],e},fromUint32Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toUint64Array:function(t){var e=new BigUint64Array(2),n=this.toBytes(t);return e[0]=new BigUint64Array(n.slice(0,8).buffer)[0],e[1]=new BigUint64Array(n.slice(8).buffer)[0],e},fromUint64Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toLongArray:function(t){var e=new Array(2),n=this.toBytes(t);return e[0]=er.fromBytes(n.slice(0,8)),e[1]=er.fromBytes(n.slice(8)),e},fromLongArray:function(t){var e=t[0].toBytes().concat(t[1].toBytes());return this.fromBytes(e)}};function rr(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return ir(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ir(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function ir(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var or=function(){function t(n){var r=this;e(this,t),Object.defineProperty(this,"id",{get:function(){return n||(n=this.resolveID()),n},set:function(t){var e=n;n=t,this.updateID(e,n)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:function(){return"function"==typeof r.getMD5Message?t.Algorithm.MD5:t.Algorithm.GUID},enumerable:!0})}return I(t,null,[{key:"SEPARATOR",get:function(){return"\n"}}]),I(t,[{key:"resolveID",value:function(){if(this.algorithm==t.Algorithm.MD5){var e,n="",r=rr(this.getMD5Message());try{for(r.s();!(e=r.n()).done;){var i=e.value;if(Array.isArray(i)){var o,a=rr(i);try{for(a.s();!(o=a.n()).done;){n+=o.value,n+="\n"}}catch(t){a.e(t)}finally{a.f()}}else n+=i;n+="\n"}}catch(t){r.e(t)}finally{r.f()}if(!n)throw new Error("Empty MD5 message container found");return tr(n)}return nr.generate()}},{key:"updateID",value:function(t,e){}},{key:"invalidateID",value:function(){this.id=void 0}}],[{key:"getMD5Tokens",value:function(t){var e=[];return Object.keys(t).sort().forEach((function(n){return e.push(n,t[n])})),e}}]),t}();function ar(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}or.createEnum("Algorithm",["GUID","MD5"]);var sr=function(t){o(a,t);var n,r,i=(n=a,function(){var t,e=c(n);if(ar()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).props={},t}return I(a,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",or.getMD5Tokens(this.props)]}}],[{key:"createInstance",value:(r=on(nn.mark((function t(){var e,n,r=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=r.length>0&&void 0!==r[0]?r[0]:{},(n=new a).props["env.name"]=ENVIRONMENT.name,ENVIRONMENT!=EnvironmentType.WEB&&ENVIRONMENT!=EnvironmentType.WORKER){t.next=7;break}n.props["user.agent"]=navigator.userAgent,t.next=13;break;case 7:if(ENVIRONMENT!=EnvironmentType.NODE){t.next=12;break}return t.next=10,$n.osInfo().then((function(t){n.props["os.id"]=t.serial.toLowerCase(),n.props["os.name"]=t.codename,n.props["os.version"]=t.release,n.props["os.build"]=t.build,n.props["os.platform"]="".concat(t.distro," (").concat(t.platform," ").concat(t.arch,")")}));case 10:t.next=13;break;case 12:throw new Error("Environment.createDefaultInstance is not supported under ".concat(ENVIRONMENT.name," environment"));case 13:return Object.keys(e).forEach((function(t){return n.props[t]=e[t]})),t.abrupt("return",n);case 15:case"end":return t.stop()}}),t)}))),function(){return r.apply(this,arguments)})}]),a}(or);function ur(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var cr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(ur()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e(this,i),(n=r.call(this)).type=t,n.props=Object.assign({},o),n}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,or.getMD5Tokens(this.props)]}}]),i}(or);function hr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}cr.createEnum("Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);var lr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(hr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n,o,a,u){var c;if(e(this,i),c=r.call(this),n==i.Metric.DIMENSIONLESS)o=1;else if(isNaN(o)){var h=Kn.getUnit(n);o=Kn.getChannelResolution(h)}return c.type=t,c.metric=n,c.resolution=o,c.min=a,c.max=u,t==i.Type.TIMESTAMP?c.precision=0:c.precision=2,Object.defineProperty(s(c),"name",{get:function(){return On.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}}),c}return I(i,[{key:"getMD5Message",value:function(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");var t=[];return t.push("SensorChannel"),t.push(this.context.inkProvider?this.context.inkProvider.id:""),t.push(this.context.device.id),t.push(this.type),t.push(this.metric.name),t.push(this.resolution.toFixed(4)),t.push((this.min||0).toFixed(4)),t.push((this.max||0).toFixed(4)),t.push(this.precision.toString()),t}}],[{key:"createCustomChannel",value:function(t,e,n,r,o,a){var s=new i(t,n,r,o,a);return s.precision=e,s}},{key:"createDefaultInstance",value:function(t,e){var n,r,o;switch(t){case i.Type.X:case i.Type.Y:case i.Type.Z:case i.Type.RADIUS_X:case i.Type.RADIUS_Y:n=Kn.Unit.DIP;break;case i.Type.TIMESTAMP:n=Kn.Unit.MILLISECOND;break;case i.Type.PRESSURE:n=Kn.Unit.NORMALIZED,r=0,o=1;break;case i.Type.ALTITUDE:case i.Type.AZIMUTH:case i.Type.ROTATION:n=Kn.Unit.RADIAN,r=0,o=2*Math.PI;break;default:console.error("SensorChannel: createDefaultInstance fails with ".concat(t," type"))}var a=Kn.getChannelResolution(n),s=new i(t,Kn.getUnitMetric(n),a,r,o);return s.unit=n,t!=i.Type.X&&t!=i.Type.Y||e.type!=cr.Type.MOUSE||(s.precision=0),s}}]),i}(or);function fr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}lr.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),lr.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},lr.Metric=Kn.Metric;var dr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(fr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n){var o;e(this,i),(o=r.call(this)).device=t.freeze(),o.inkProvider=Object.freeze(n);var a,u,c=[];return Object.defineProperty(s(o),"channels",{get:function(){return c},set:function(t){var e=this;this.invalidateID(),c=[],t.forEach((function(t){return e.add(t)}))},enumerable:!0}),Object.defineProperty(s(o),"layout",{get:function(){return c.map((function(t){return t.name}))},set:function(t){this.invalidateID(),c=c.filter((function(e){return t.includes(e.name)}))},enumerable:!0}),Object.defineProperty(s(o),"samplingRate",{get:function(){return a},set:function(t){this.invalidateID(),a=t},enumerable:!0}),Object.defineProperty(s(o),"latency",{get:function(){return u},set:function(t){this.invalidateID(),u=t},enumerable:!0}),o}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");var t=["SensorChannelsContext"].concat(k(this.channels.map((function(t){return t.id}))));return t.push(this.samplingRate||""),t.push(this.latency||""),t.push(this.inkProvider?this.inkProvider.id:""),t.push(this.device.id),t}},{key:"add",value:function(t){if((t.type==lr.Type.X||t.type==lr.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");t.context=this,Object.freeze(t),this.channels.push(t)}},{key:"get",value:function(t){return this.channels.filter((function(e){return e.id==t})).first}}],[{key:"createDefaultInstance",value:function(t,e){var n=new i(t,e);return n.channels=lr.defaults[e.type.name].map((function(t){return lr.createDefaultInstance(lr.Type[t],e)})),n}}]),i}(or);function pr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var yr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(pr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;e(this,i),t=r.call(this);var n=[];return Object.defineProperty(s(t),"channelsContexts",{get:function(){return n},set:function(t){this.invalidateID(),n=t},enumerable:!0}),t}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext"].concat(k(this.channelsContexts.map((function(t){return t.id}))))}},{key:"addContext",value:function(t){if(!this.channelsContexts.includes(t)){if(this.channelsContexts.filter((function(e){return e.device==t.device})).length>0)throw new Error("Already exists channelsContext with device ".concat(t.device.id,". Device should be unique in scope of SensorContext."));t.inkProvider&&(this.inkChannelsContext=t),Object.freeze(t),this.channelsContexts.push(t)}}},{key:"getContext",value:function(t){return this.channelsContexts.filter((function(e){return e.id==t})).first}},{key:"getContextByChannelID",value:function(t){return this.channelsContexts.filter((function(e){return e.get(t)})).first}}],[{key:"createDefaultInstance",value:function(t,e){var n=new i;return n.addContext(dr.createDefaultInstance(t,e)),n}}]),i}(or);function vr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var mr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(vr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n){var o;return e(this,i),(o=r.call(this)).environment=Object.freeze(t),o.sensorContext=Object.freeze(n),o}return I(i,[{key:"getMD5Message",value:function(){return["InputContext",this.environment.id,this.sensorContext.id]}},{key:"addChannelsContext",value:function(t){this.sensorContext.addContext(t)}}],[{key:"createDefaultInstance",value:function(t,e,n){return new i(t,yr.createDefaultInstance(e,n))}}]),i}(or);function gr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var br=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(gr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),(n=r.call(this)).created=Date.now(),n.inkState=i.InkState.PLANE,n.context=t,n.streams=[],n}return I(i,[{key:"add",value:function(t){if(!this.context.sensorContext.getContextByChannelID(t.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");t.ink&&(this.inkStream=t),this.streams.push(t)}}]),i}(or);br.createEnum("InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);var xr=function(){function t(n){e(this,t),this.channels=n,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:n.map((function(t){return t.name})),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}return I(t,[{key:"add",value:function(t,e){var n=this;e&&this.ignoredIndex.push(this.length),this.channels.forEach((function(e){var r=On.getPropName(e.name),i=t[r];if(e.type==lr.Type.ALTITUDE&&!("altitude"in t))throw new Error("SensorStream input data do not provides altitude");if(e.type==lr.Type.AZIMUTH&&!("azimuth"in t))throw new Error("SensorStream input data do not provides azimuth");n.data.push(i)}))}},{key:"get",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));for(var e={},n=0;n<this.stride;n++){var r=this.channels[n],i=On.getPropName(r.name),o=t*this.stride;"force"==i?(e.pressure=this.data[o+n],Object.defineProperty(e,"force",{value:this.pressure,enumerable:!0})):e[i]=this.data[o+n]}return e}},{key:"getPipelineMapping",value:function(){var t=[];if(this.ignoredIndex.length>0)for(var e=0;e<this.length;e++)this.ignoredIndex.includes(e)||t.push(e);return t}}]),t}();function Er(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var wr=function(t){o(a,t);var n,r,i=(n=a,function(){var t,e=c(n);if(Er()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).props={},t.devices=[],t}return I(a,[{key:"freeze",value:function(){return Object.freeze(this.props),this}},{key:"getMD5Message",value:function(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",or.getMD5Tokens(this.props)]}},{key:"link",value:function(t){this.devices.push(t)}},{key:"getInkInputProvider",value:function(t){return new cr(t)}},{key:"getInkSensorContext",value:function(t){var e=this.getInkInputProvider(t);return yr.createDefaultInstance(this,e)}},{key:"openStream",value:function(t){var e=this;if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");var n=cr.Type[t.pointer.type.toUpperCase()],r=this.getInkSensorContext(n),i=new mr(this.environment,r);r.inkChannelsContext.layout=a.getLayout(t),this.sensorData=new br(i),this.sensorData.add(new xr(r.inkChannelsContext.channels)),this.sampleTimestamp=t.timestamp,this.devices.forEach((function(t){return t.openStream(e.sensorData)}))}},{key:"add",value:function(t,e){if(!this.sensorData)throw new Error("Open ink stream not found");this.sensorData.inkStream.add(Object.assign({},t,{timestamp:t.timestamp-this.sampleTimestamp}),e)}},{key:"closeStream",value:function(t){var e=this.sensorData;return this.devices.forEach((function(e){return e.closeStream(t)})),this.sensorData=null,this.sampleTimestamp=0,t?null:e}}],[{key:"getLayout",value:function(t){var e=[];return Object.keys(lr.Type).forEach((function(n){var r,i=lr.Type[n];r=i==lr.Type.ALTITUDE?"tiltX":i==lr.Type.AZIMUTH?"tiltY":On.getPropName(n),isFinite(t[r])&&e.push(n)})),e}},{key:"createInstance",value:(r=on(nn.mark((function t(e){var n,r=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=d(this,k(Array.from(r).slice(1))),ENVIRONMENT!=EnvironmentType.WEB){t.next=5;break}n.props["dev.graphics.resolution"]="".concat(screen.width,"x").concat(screen.height),t.next=12;break;case 5:if(ENVIRONMENT!=EnvironmentType.NODE){t.next=10;break}return t.next=8,$n.system().then((function(t){return n.props["dev.id"]=t.uuid.toLowerCase(),n.props["dev.manufacturer"]=t.manufacturer,n.props["dev.model"]=t.model,$n.cpu()})).then((function(t){return n.props["dev.cpu"]="".concat(t.manufacturer," ").concat(t.brand," ").concat(t.speed," - ").concat(t.cores," core(s)"),$n.graphics()})).then((function(t){var e=t.displays.filter((function(t){return t.main}))[0],r=t.controllers[0];return n.props["dev.graphics.display"]="".concat(e.model," ").concat(e.currentResX,"x").concat(e.currentResY," (").concat(e.pixeldepth," bit)"),n.props["dev.graphics.adapter"]="".concat(r.model," ").concat(r.vram," GB"),$n.osInfo()}));case 8:t.next=12;break;case 10:if(ENVIRONMENT!=EnvironmentType.WORKER){t.next=12;break}throw new Error("InputDevice.createDefaultInstance is not supported under ".concat(ENVIRONMENT.name," environment"));case 12:return t.next=14,sr.createInstance(e);case 14:return n.environment=t.sent,t.abrupt("return",n);case 16:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})}]),a}(or),Rr=function(){function t(n){var r,i=this;e(this,t),this.phase=n.phase,Object.defineProperty(this,"x",{value:n.x,enumerable:!0}),Object.defineProperty(this,"y",{value:n.y,enumerable:!0}),Object.defineProperty(this,"z",{value:n.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:n.timestamp,enumerable:!0}),Object.defineProperty(this,"force",{value:n.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:n.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:n.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:n.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:n.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:function(){return r||(r=i.computeTilt(n.tiltX,n.tiltY)||{}),r.altitude},enumerable:!0}),Object.defineProperty(this,"azimuth",{get:function(){return r||(r=i.computeTilt(n.tiltX,n.tiltY)||{}),r.azimuth},enumerable:!0}),n.pointer&&Object.defineProperty(this,"pointer",{value:n.pointer,enumerable:!0}),this.computedAzimuth=void 0}return I(t,[{key:"createPathPoint",value:function(){return new Ye(this.x,this.y,this.z)}},{key:"computeTilt",value:function(t,e){if(isFinite(t)&&isFinite(e)){var n=Math.tan(Math.toRadians(t)),r=Math.tan(Math.toRadians(e)),i=Math.sqrt(n*n+r*r);return{altitude:Math.atan2(1,i),azimuth:Math.atan2(r,n)}}}},{key:"speed",value:function(e,n){var r={x:0,y:0,time:0};if((r=e&&!n?this.minus(e):n&&!e?n.minus(this):n.minus(e)).time>0)return t.getMagnitude(r.x,r.y)/(r.time/1e3);if(0==r.time)return 0;throw new Error("Out of range ".concat(r.time))}},{key:"computeNearestAzimuthAngle",value:function(t){var e;if(isNaN(this.azimuth))return 0;if(t){if(isNaN(t.azimuth))return 0;var n=2*Math.PI,r=t.computedAzimuth||t.azimuth,i=parseInt(r/n),o=(e=this.azimuth+i*n)-r;o>=Math.PI?e-=n:o<-Math.PI&&(e+=n)}else e=this.azimuth;return this.computedAzimuth=e,e}},{key:"minus",value:function(t){return{x:this.x-t.x,y:this.y-t.y,time:this.timestamp-t.timestamp}}}],[{key:"getMagnitude",value:function(t,e){return Math.sqrt(t*t+e*e)}}]),t}();Rr.createEnum("Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);var Pr=function(){function t(){e(this,t)}return I(t,null,[{key:"createCircle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};return t.createEllipse(e,n,n,r)}},{key:"createEllipse",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:0,y:0},i=[],o=2*Math.PI/t,a=0;a<t;a++){var s=a*o,u=e*Math.cos(s),c=n*Math.sin(s);i.push(r.x+u,r.y+c)}return i.toFloat32Array()}},{key:"createStar",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=[],r=1,i=2*Math.PI/t,o=0;o<t;o++){var a=o*i,s=r*Math.cos(a),u=r*Math.sin(a),c=e*Math.cos(a+i/2),h=e*Math.sin(a+i/2);n.push(s,u,c,h)}return n.toFloat32Array()}}]),t}(),kr=function(){function t(){e(this,t)}return I(t,null,[{key:"encode",value:function(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.Encoding.AUTO;if(r==t.Encoding.AUTO&&(r="undefined"==typeof Buffer?t.Encoding.ARRAY:t.Encoding.BUFFER),r==t.Encoding.NONE)n=e;else if(r==t.Encoding.ARRAY)n=e.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");var i=Buffer.from(e.buffer);switch(r){case t.Encoding.BUFFER:n=i.toJSON();break;case t.Encoding.BASE64:n=i.toString("base64");break;default:throw new Error("Invalid encoding provided: ".concat(r.name))}}return{encoding:r.name,type:e.constructor.name,points:n}}},{key:"decode",value:function(e){var n,r=t.Encoding[e.encoding];if(r==t.Encoding.NONE)n=e.points;else if(r==t.Encoding.ARRAY)n=e.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");var i;switch(r){case t.Encoding.BUFFER:i=Buffer.from(e.points);break;case t.Encoding.BASE64:i=Buffer.from(e.points,"base64");break;default:throw new Error("Invalid encoding provided: ".concat(r.name))}var o=new Uint8Array(i);n=new globalThis[e.type](o.buffer)}return n}},{key:"isTypedArrayData",value:function(t){return t&&t.encoding&&t.type&&t.type.endsWith("Array")}}]),t}();kr.createEnum("Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);var Mr=function(){function t(n,r){e(this,t),this.name=n,Object.defineProperty(this,"value",{get:function(){if(!r){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(r=this.resolve(this.name)),!r){if(!S.instance)throw new Error("Resource URI ".concat(this.name," cannot be resolved. URIResolver not implemented yet. Please implement and instantiate."));r=S.instance.resolve(this.name)}if(!r)throw new Error("Resource URI ".concat(this.name," cannot be resolved. Please provide resource definition in URIResolver init implementation."))}return r},set:function(t){r=t},enumerable:!0})}return I(t,[{key:"toJSON",value:function(){var t=this.value;return ArrayBuffer.isTypedArray(t)?t=kr.encode(t,this.encoding):"function"==typeof t&&(t=t()),{name:this.name,value:t}}}],[{key:"fromJSON",value:function(e){var n=e.value;return kr.isTypedArrayData(n)&&(n=kr.decode(n)),new t(e.name,n)}},{key:"getInstance",value:function(e,n){return new t(n,e)}}]),t}(),Tr=function(){function t(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e(this,t),this.size=r,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return n||("function"==typeof(n=this.descriptor.shape.value)&&(n=n()),t.fitShape(n)),n},set:function(e){var r=this;if(!e)throw new Error("BrushPrototype: shape not found");Array.isArray(e)&&(e=e.toFloat32Array()),"string"==typeof e?e=new Mr(e):e instanceof Float32Array?e=Mr.getInstance(e):e instanceof Mr||(e=new Mr(e.name,e.value)),n=null,this.descriptor.shape=e,this.descriptor.shape.resolve=t.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:function(){return r.encoding},enumerable:!0})},enumerable:!0}),this.shape=n}return I(t,[{key:"toJSON",value:function(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}}],[{key:"fromJSON",value:function(e){return new t(Mr.fromJSON(e.shape),e.size)}},{key:"create",value:function(e){for(var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e,o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];switch(e){case t.Type.CIRCLE:n=Pr.createCircle.apply(Pr,a),i+="?precision=".concat(a[0]||"","&radius=").concat(a[1]||"");break;case t.Type.ELLIPSE:n=Pr.createEllipse.apply(Pr,a),i+="?precision=".concat(a[0]||"","&radiusX=").concat(a[1]||"","&radiusY=").concat(a[2]||"");break;case t.Type.STAR:n=Pr.createStar.apply(Pr,a),i+="?points=".concat(a[0]||"","&internalRadius=").concat(a[1]||"");break;default:console.error("Brush2D: createShape fails with ".concat(e," type"))}return new t({name:i,shape:n},r)}},{key:"resolve",value:function(e){var n,r=e.split("?"),i=r.first;if(Object.values(t.Type).includes(i)){var o=r.last.split("&"),a={};switch(o.forEach((function(t){a[t.substring(0,t.indexOf("="))]=t.substring(t.indexOf("=")+1)})),i){case t.Type.CIRCLE:var s=a.precision?parseInt(a.precision):void 0;n=Pr.createCircle(s);break;case t.Type.ELLIPSE:var u=a.precision?parseInt(a.precision):void 0,c=a.radiusX?parseFloat(a.radiusX):void 0,h=a.radiusY?parseFloat(a.radiusY):void 0;n=Pr.createEllipse(u,c,h);break;case t.Type.STAR:var l=a.points?parseInt(a.points):void 0,f=a.internalRadius?parseFloat(a.internalRadius):void 0;n=Pr.createStar(l,f);break;default:console.error("Brush2D: createShape fails with ".concat(i," type"))}}return n}},{key:"fitShape",value:function(e){t.centerShape(e);for(var n=new He(-1,-1,1,1),r=He.ofPolygon(e),i=n.width/r.width,o=n.height/r.height,a=i>0&&o>0?Math.min(i,o):Math.max(i,o),s=0;s<e.length;s+=2)e[s]*=a,e[s+1]*=a}},{key:"centerShape",value:function(t){for(var e=He.ofPolygon(t),n=0;n<t.length;n+=2)t[n]-=e.center.x,t[n+1]-=e.center.y}}]),t}();function Ir(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Sr(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Sr(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function Sr(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}Tr.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var Ar=function(){function t(n,r,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e(this,t),isFinite(i)&&(a=i,i=void 0),a<=0&&(console.warn("Invalid spacing found ".concat(a,". It should be positive number.")),a=1),this.name=n,Object.defineProperty(this,"shape",{get:function(){return r},set:function(t){if(t instanceof Float32Array&&(t=new Tr(t)),!this.validate(t))throw console.warn(t),new Error("Brush2D: Invalid shape found");Array.isArray(t)&&(1==t.length?t=t.first:t.sort(On.comparator({sortBy:"size",sortOrder:"asc"}))),r=t},enumerable:!0}),this.shape=r,this.fill=i,this.spacing=a,Object.defineProperty(this,"encoding",{get:function(){return o},set:function(t){if(Array.isArray(this.shape)){var e,n=Ir(this.shape);try{for(n.s();!(e=n.n()).done;){e.value.encoding=t}}catch(t){n.e(t)}finally{n.f()}}else this.shape.encoding=t},enumerable:!0})}var n;return I(t,[{key:"validate",value:function(t){var e=!1;if(Array.isArray(t)){var n,r=Ir(t);try{for(r.s();!(n=r.n()).done;){if(!(e=n.value instanceof Tr))break}}catch(t){r.e(t)}finally{r.f()}}else e=t instanceof Tr;return e}},{key:"configure",value:(n=on(nn.mark((function t(e){var n;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.pattern&&this.fill){t.next=2;break}return t.abrupt("return");case 2:if(e instanceof CanvasRenderingContext2D||e instanceof OffscreenCanvasRenderingContext2D){t.next=4;break}throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");case 4:return t.next=6,ln(this.fill);case 6:n=t.sent,this.pattern=e.createPattern(n,"repeat");case 8:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"selectShape",value:function(t){var e;if(Array.isArray(this.shape)){for(var n=1;n<this.shape.length;n++)if(this.shape[n].size>t){e=this.shape[n-1];break}e||(e=this.shape.last)}else e=this.shape;return e.shape}},{key:"toJSON",value:function(){var t=Array.isArray(this.shape)?this.shape:[this.shape];return{type:this.constructor.name,name:this.name,spacing:this.spacing,shape:t.map((function(t){return t.toJSON()}))}}}],[{key:"fromJSON",value:function(e){var n=1==e.shape.length?Tr.fromJSON(e.shape[0]):e.shape.map((function(t){return Tr.fromJSON(t)}));return new t(e.name,n,e.spacing)}}]),t}(),Cr=function(){function t(){e(this,t),this.state={}}return I(t,null,[{key:"excludedProps",get:function(){return[Ye.Property.D_X,Ye.Property.D_Y]}},{key:"posProps",get:function(){return[Ye.Property.X,Ye.Property.Y,Ye.Property.Z]}},{key:"colorProps",get:function(){return[Ye.Property.RED,Ye.Property.GREEN,Ye.Property.BLUE,Ye.Property.ALPHA]}},{key:"transformProps",get:function(){return[Ye.Property.ROTATION,Ye.Property.SCALE_X,Ye.Property.SCALE_Y,Ye.Property.SCALE_Z,Ye.Property.OFFSET_X,Ye.Property.OFFSET_Y,Ye.Property.OFFSET_Z]}}]),I(t,[{key:"isLayoutPart",value:function(e){if(t.posProps.includes(e))return this.inputLayout.includes(e.name);if(this.brush instanceof Ar&&t.colorProps.includes(e))return!1;if(t.excludedProps.includes(e))return!1;if(this.basicMode&&t.transformProps.includes(e))return!1;var n=!1,r=On.getPropName(e.name),i=this.dynamics[r];if(i&&!i.disabled)if(i.dependencies){var o=this.inputLayout.map((function(t){return lr.Type[t]}));n=i.dependencies.filter((function(t){return o.includes(t)})).length>0}else n=!0;return n}},{key:"calculate",value:function(e,n,r){var i=this;for(var o in this.point=n.createPathPoint(),this.statics)this.point[o]=this.statics[o];return this.calculateProperty(Ye.Property.SIZE,e,n,r),t.colorProps.forEach((function(t){return i.calculateProperty(t,e,n,r)})),t.transformProps.forEach((function(t){return i.calculateTransform(t,e,n,r)})),this.point}},{key:"calculateProperty",value:function(e,n,r,i){if(this.layout.includes(e)){var o,a=On.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(n,r,i);else if(isFinite(r.pressure)||n&&isFinite(n.pressure)){var c=r.pressure||n.pressure/2;o=t.mapTo(c,u.pressure,s.value)}else{var h=r.speed(n,i);o=t.mapTo(h,u.velocity,s.value)}this.point[On.getPropName(e.name)]=o}}},{key:"calculateTransform",value:function(e,n,r,i){if(this.layout.includes(e)){var o,a=On.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(n,r,i);else if(s.dependencies)if(e==Ye.Property.ROTATION)isFinite(r.rotation)?o=r.rotation:isFinite(r.azimuth)&&(o=r.computeNearestAzimuthAngle(n));else if(s.dependencies.includes(lr.Type.ALTITUDE)&&isFinite(r.altitude)){r.cosAltitude||(r.cosAltitude=Math.cos(r.altitude));var c=r.cosAltitude;o=t.mapTo(c,u.altitude,s.value)}else if((e==Ye.Property.SCALE_X||e==Ye.Property.SCALE_Y)&&(s.dependencies.includes(lr.Type.RADIUS_X)||s.dependencies.includes(lr.Type.RADIUS_Y)))if(isFinite(r.radiusX)&&isFinite(r.radiusY)){var h=e==Ye.Property.SCALE_X?"radiusX":"radiusY",l=r[h];o=t.mapTo(l,u[h],s.value)}else o=1;if(!isFinite(o))throw new Error("Property ".concat(e.name," has no value"));this.point[On.getPropName(e.name)]=o}}},{key:"reset",value:function(e,n,r){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.brush=n,this.dynamics=o,this.statics={},this.color={},this.inputLayout=wr.getLayout(e),this.layout=Ye.Property.values.filter((function(t){return i.isLayoutPart(t)})),"size"in a){if(this.isLayoutPart(Ye.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=a.size}else if(!this.isLayoutPart(Ye.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");t.colorProps.forEach((function(t){var e=On.getPropName(t.name);i.isLayoutPart(t)?i.color[e]=r[e]:(i.statics[e]=isFinite(a[e])?a[e]:r[e],i.color[e]=i.statics[e])})),A.init(this.color),t.transformProps.forEach((function(t){if(!i.isLayoutPart(t)){var e=On.getPropName(t.name);isFinite(a[e])&&(i.statics[e]=a[e])}})),this.resetState()}},{key:"resetState",value:function(){var e=this;this.state={},[Ye.Property.SIZE].concat(t.colorProps).forEach((function(n){if(e.layout.includes(n)){var r=On.getPropName(n.name),i=e.dynamics[r],o={};if(i.resolve)o.resolve=t.resolveAction(i.resolve);else{if(!i.value)throw new Error("PathPointContext: dynamics ".concat(r," value property not found"));var a=Object.clone(i.velocity)||{min:0,max:4e3};a.remap=t.resolveAction(a.remap||i.value.remap);var s=Object.clone(i.pressure)||{min:0,max:1};s.remap=t.resolveAction(s.remap||i.value.remap),o.velocity=t.validateRange(r,a,{min:0,max:3e4}),o.pressure=t.validateRange(r,s,{min:0,max:1})}e.state[r]=o}})),t.transformProps.forEach((function(n){if(e.layout.includes(n)){var r=On.getPropName(n.name),i=e.dynamics[r],o={};if(i.resolve)o.resolve=t.resolveAction(i.resolve);else if(i.dependencies){if(i.dependencies.includes(lr.Type.ALTITUDE)){if(!i.value)throw new Error("PathPointContext: dynamics ".concat(r," value property not found"));var a=Object.clone(i.altitude)||{min:0,max:Math.PI/2};a.remap=t.resolveAction(a.remap||i.value.remap),o.altitude=t.validateRange(r,a,{min:0,max:Math.PI/2})}if(n==Ye.Property.SCALE_X&&i.dependencies.includes(lr.Type.RADIUS_X)||n==Ye.Property.SCALE_Y&&i.dependencies.includes(lr.Type.RADIUS_Y)){if(!i.value)throw new Error("PathPointContext: dynamics ".concat(r," value property not found"));var s=n==Ye.Property.SCALE_X?"radiusX":"radiusY",u=Object.clone(i[s])||{min:0,max:50};u.remap=t.resolveAction(u.remap||i.value.remap),o[s]=t.validateRange(r,u,{min:0,max:50})}}e.state[r]=o}}))}}],[{key:"resolveAction",value:function(t){if(t)return"string"==typeof t?t=new Mr(t):"function"==typeof t?t=Mr.getInstance(t):t instanceof Mr||(t=new Mr(t.name,t.value)),t.value}},{key:"validateRange",value:function(t,e,n){if(e.min<n.min||e.max>n.max)throw new Error("".concat(t," config is out of range - (").concat(e.min,", ").concat(e.max,"), expected values interval - (").concat(n.min,", ").concat(n.max,")"));if(e.min>e.max)throw new Error("".concat(t," min ").concat(e.min," exceeds max ").concat(e.max));return e}},{key:"mapTo",value:function(t,e,n){var r=(On.clamp(t,e)-e.min)/(e.max-e.min);return e.remap&&(r=e.remap(r)),n.min+r*(n.max-n.min)}}]),t}(),Or=function(){function t(){e(this,t),this.path=[],this.phase=t.Phase.END;var n=!1;Object.defineProperty(this,"keepAllData",{get:function(){return n},set:function(t){n=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return I(t,[{key:"add",value:function(e,n,r){var i;if(!this.move(e))throw new Error("Cannot move from phase ".concat(this.phase.name," to phase ").concat(e.name));var o=this.addImpl(n,r);return this.keepAllData&&(i=this.path).push.apply(i,k(o.added)),{added:this.getOutput(o.added,t.OutputType.ADDITION),predicted:this.getOutput(o.predicted,t.OutputType.PREDICTION)}}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"move",value:function(e){return(this.phase!=t.Phase.END||e==t.Phase.BEGIN)&&((this.phase!=t.Phase.BEGIN||e==t.Phase.UPDATE||e==t.Phase.END)&&((this.phase!=t.Phase.UPDATE||e==t.Phase.UPDATE||e==t.Phase.END)&&(e==t.Phase.BEGIN&&this.reset(),this.phase=e,!0)))}},{key:"reset",value:function(){this.path.clear(),this.phase=t.Phase.END}}]),t}();Or.createEnum("Phase",["BEGIN","UPDATE","END"]),Or.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA"]);var Dr=function(){function t(){e(this,t),this.reset()}return I(t,[{key:"add",value:function(t,e,n){var r;t==Or.Phase.BEGIN?this.reset(!0):t==Or.Phase.END&&(this.last=!0),e&&(r=this.accumulatedAddition).push.apply(r,k(e)),n&&(this.lastPrediction=n)}},{key:"reset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.first=t,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}]),t}(),Nr=function(){function t(n,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;e(this,t),Array.isArray(r)&&(r=r.toFloat32Array()),Object.defineProperty(this,"layout",{value:n,enumerable:!0}),Object.defineProperty(this,"points",{get:function(){return r},enumerable:!0}),Object.defineProperty(this,"stride",{value:n.length,enumerable:!0}),Object.defineProperty(this,"length",{value:r.length/n.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:i,enumerable:!0}),this.ts=o,this.tf=a,this.restoreBuffer=function(t){return r=new Float32Array(t)},Object.defineProperty(this,"color",{get:function(){var t=this.pointProps,e=t.red,n=t.green,r=t.blue,i=t.alpha;return isFinite(e)&&isFinite(n)&&isFinite(r)?A.from(e,n,r,i):void 0},set:function(t){t?(i.red=t.red,i.green=t.green,i.blue=t.blue,i.alpha=t.alpha):(i.red=void 0,i.green=void 0,i.blue=void 0,i.alpha=void 0)},enumerable:!0}),Object.defineProperty(this,"size",{get:function(){return i.size},set:function(t){i.size=t},enumerable:!0}),this.validate()}return I(t,[{key:"validate",value:function(){if(!this.layout.includes(Ye.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(Ye.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(Ye.Property.SIZE)&&isNaN(this.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}},{key:"validateSegmentsCount",value:function(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}},{key:"clone",value:function(){return new t(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}},{key:"getPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e=Ye.createInstance(this.pointProps);return e.fill(this.layout,this.points,t),this.transform&&e.transform(this.transform),e}},{key:"getPath",value:function(){for(var t=[],e=this.layout.indexOf(Ye.Property.X),n=this.layout.indexOf(Ye.Property.Y),r=0;r<this.length;r++)t.push(this.points[r*this.stride+e],this.points[r*this.stride+n]);return t}},{key:"slice",value:function(e,n,r,i){if(e<0||e>this.length-4)throw new Error("Invalid fromIndex ".concat(e," found. Ensure that fromIndex range is {0, ").concat(this.length-4,"}."));if(n<1||n+1>this.length)throw new Error("Invalid toIndex ".concat(n," found. Ensure that fromIndex range is {1, ").concat(this.length,"}."));if(n+1-e<4)throw new Error("Invalid range {".concat(e,", ").concat(n,"} found. At least 4 points are needed to define spline."));var o=this.points.slice(e*this.stride,(n+1)*this.stride),a=new t(this.layout.slice(),o,Object.clone(this.pointProps),r,i);return a.randomSeed=this.randomSeed,a}},{key:"toJSON",value:function(){return{layout:this.layout.map((function(t){return t.name})),points:kr.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}}],[{key:"fromJSON",value:function(e){var n=kr.decode(e.points),r=new t(e.layout.map((function(t){return Ye.Property[t]})),n,e.pointProps,e.ts,e.tf);return r.randomSeed=e.randomSeed,r}},{key:"createRect",value:function(e,n,r){var i=e.toPath(n,r);return new t(i.layout,i.points,{size:i.size,red:n.red,green:n.green,blue:n.blue,alpha:n.alpha})}}]),t}();function Lr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var _r=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Lr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n,o){var a,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return e(this,i),a=r.call(this,t,n,o),Object.defineProperty(s(a),"tValues",{value:Object.freeze(u),enumerable:!0}),Object.defineProperty(s(a),"ts",{get:function(){return u.first},enumerable:!0}),Object.defineProperty(s(a),"tf",{get:function(){return u.last},enumerable:!0}),delete a.segmentsCount,a}return I(i,[{key:"slice",get:function(){}}]),I(i,[{key:"validateSegmentsCount",value:function(){}},{key:"getPointT",value:function(t){return this.tValues[t]}},{key:"getBounds",value:function(t){return He.ofSpline(this,t)}},{key:"toJSON",value:function(){return{layout:this.layout.map((function(t){return t.name})),points:kr.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}}],[{key:"fromJSON",value:function(t){var e=kr.decode(t.points);return new i(t.layout.map((function(t){return Ye.Property[t]})),e,t.pointProps,t.tValues)}}]),i}(Nr),Br={stride:2,sort:function(t,e){return this.sortArrayPart(t,0,t.length-this.stride,e),t},partition:function(t,e,n,r){for(var i=t[n],o=t[n+1],a=e-this.stride,s=e;s<n;s+=2)r?r(i,o,t[s],t[s+1])&&(a+=this.stride,this.swap(t,a,s)):(i>t[s]||i==t[s]&&o>t[s+1])&&(a+=this.stride,this.swap(t,a,s));return this.swap(t,a+this.stride,n),a+this.stride},swap:function(t,e,n){var r=t[e],i=t[e+1];return t[e]=t[n],t[e+1]=t[n+1],t[n]=r,t[n+1]=i,t},sortArrayPart:function(t,e,n,r){if(e<n){var i=this.partition(t,e,n,r);this.sortArrayPart(t,e,i-this.stride,r),this.sortArrayPart(t,i+this.stride,n,r)}}},Fr={monotoneChain:function(t){var e=Fr.ARRAY_TYPE;if(e||(e=Array),t.length<=0)return new e;Br.sort(t);for(var n=new e(t.length),r=0,i=0;i<t.length;i+=2){for(;r>=4&&this.cross(n[r-4],n[r-3],n[r-2],n[r-1],t[i],t[i+1])<=0;)r-=2;n[r]=t[i],n[r+1]=t[i+1],r+=2}n=n.slice(0,r);var o,a=new e(t.length);r=0;for(var s=t.length-2;s>=0;s-=2){for(;r>=4&&this.cross(a[r-4],a[r-3],a[r-2],a[r-1],t[s],t[s+1])<=0;)r-=2;a[r]=t[s],a[r+1]=t[s+1],r+=2}return a=a.slice(0,r-2),e==Float32Array?((o=new Float32Array(a.length+n.length)).set(a),o.set(n,a.length)):o=a.concat(n),o},cross:function(t,e,n,r,i,o){return(n-t)*(o-e)-(r-e)*(i-t)}};var Ur=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t},jr=r((function(t){function e(n,r,i){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=e=Reflect.get:t.exports=e=function(t,e,n){var r=Ur(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(n):i.value}},e(n,r,i||n)}t.exports=e}));function Yr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Xr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Yr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n){var o;return e(this,i),(o=r.call(this)).inputBuffer=[],o.hasPrediction=!0,Object.defineProperty(s(o),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(s(o),"pathPointCalculator",{get:function(){return n},set:function(t){n=t,this.reset()},enumerable:!0}),o}return I(i,[{key:"togglePrediction",value:function(t){this.hasPrediction=t}},{key:"addImpl",value:function(t,e){if(t.phase!=this.phase)throw new Error("The phase of the addition (".concat(t.phase.name,") doesn't match the phase of the PathProducer (").concat(this.phase.name,")"));var n=[],r=[];t&&this.inputBuffer.push(t);var i=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,o=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,a=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,s=this.calculate(i,o,a);return t&&s&&n.push.apply(n,k(s.asArray(this.layout))),this.phase==Or.Phase.END?(s=this.calculate(o,a,null))&&n.push.apply(n,k(s.asArray(this.layout))):!this.hasPrediction||this.phase!=Or.Phase.UPDATE&&null==e||(s=this.calculate(o,a,e))&&(r.push.apply(r,k(s.asArray(this.layout))),(s=this.calculate(a,e,null))&&r.push.apply(r,k(s.asArray(this.layout)))),{added:n,predicted:r}}},{key:"calculate",value:function(t,e,n){return e?this.pathPointCalculator(t,e,n):null}},{key:"reset",value:function(){jr(c(i.prototype),"reset",this).call(this),this.inputBuffer.clear()}}]),i}(Or),Gr=function(){function t(){e(this,t),this.path=[],this.firstSegment=!1,this.lastSegment=!0;var n=!1;Object.defineProperty(this,"keepAllData",{get:function(){return n},set:function(t){n=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return I(t,[{key:"add",value:function(e,n,r,i){var o;if(e&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");e&&this.path.clear(),this.firstSegment=e,this.lastSegment=n;var a=this.addImpl(r,i);return this.keepAllData&&(o=this.path).push.apply(o,k(a.added)),{added:this.getOutput(a.added,t.OutputType.ADDITION),predicted:this.getOutput(a.predicted,t.OutputType.PREDICTION)}}},{key:"get",value:function(e){this.reset(),this.firstSegment=!0,this.lastSegment=!0;var n=this.getImpl(e);return this.getOutput(n,t.OutputType.PROCESSOR)}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}},{key:"getImpl",value:function(t){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"reset",value:function(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}]),t}();function zr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Gr.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);var Vr=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933],Hr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(zr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15;return e(this,i),(n=r.call(this)).buffer=[],n.pointsCount=0,n.filter=Vr.slice(),Object.defineProperty(s(n),"dimsCount",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(s(n),"movingAverageWindowSize",{get:function(){return o},set:function(t){o=t,this.filter.length!=t&&(this.filter=i.resample(Vr,t)),this.predictionPointsCount=4*t/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),n.movingAverageWindowSize=o,n}return I(i,[{key:"addImpl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return{added:this.lastSegment?this.project(t):this.addSequence(t),predicted:this.project(e)}}},{key:"getImpl",value:function(t){return this.project(t)}},{key:"project",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));if(0==t.length)return[];var e=[],n=this.buffer.slice(),r=t.slice(0,t.length-this.dimsCount),i=this.addSequence(r);e.push.apply(e,k(i));for(var o=t.slice(t.length-this.dimsCount,t.length),a=this.predictionPointsCount,s=0;s<a;s++){var u=this.addPoint(o);a-s<=this.pointsCount&&e.push.apply(e,k(u))}return this.buffer=n,e}},{key:"addSequence",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));for(var e=[],n=t.length/this.dimsCount,r=0;r<n;r++){var i=this.addPoint(t.slice(r*this.dimsCount,(r+1)*this.dimsCount));e.push.apply(e,k(i))}return this.pointsCount+=n,e}},{key:"addPoint",value:function(t){var e;for((e=this.buffer).push.apply(e,k(t));this.buffer.length<this.windowSize*this.dimsCount;){var n;(n=this.buffer).unshift.apply(n,k(this.buffer.slice(0,this.dimsCount)))}for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}},{key:"filterBuffer",value:function(){for(var t=[],e=0;e<this.windowSize;e++)for(var n=0;n<this.dimsCount;n++)isNaN(t[n])&&(t[n]=0),t[n]+=this.buffer[e*this.dimsCount+n]*this.filter[e];return t}},{key:"reset",value:function(){jr(c(i.prototype),"reset",this).call(this),this.pointsCount=0,this.buffer.clear()}}],[{key:"resample",value:function(t,e){for(var n=new Array(e),r=t.length/e,i=0;i<e;i++){var o=(t.length-1)*i/(e-1),a=Math.floor(o),s=Math.ceil(o),u=o-a,c=t[a]*(1-u)+t[s]*u;c*=r,n[i]=c}return n}}]),i}(Gr);function Wr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var qr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Wr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),(n=r.call(this)).pathPointProps={},n.lastSpline=[],Object.defineProperty(s(n),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),n}return I(i,[{key:"addImpl",value:function(t,e){0==this.lastSpline.length&&t.length>0&&t.unshift.apply(t,k(t.slice(0,this.layout.length))),this.lastSegment&&(t.length>=this.layout.length?t.push.apply(t,k(t.slice(t.length-this.layout.length,t.length))):t.push.apply(t,k(this.getLastPart())));var n=this.getFirstPart();return this.lastSpline=n.concat(t),{added:t,predicted:this.getPredictedSpline(e)}}},{key:"getImpl",value:function(t){var e=[];return t.length>0&&(e.push.apply(e,k(t.slice(0,this.layout.length))),e.push.apply(e,k(t)),t.length>=this.layout.length&&e.push.apply(e,k(t.slice(t.length-this.layout.length,t.length)))),t}},{key:"getOutput",value:function(t,e){var n=e==Gr.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:t;return 0==n.length?void 0:new Nr(this.layout,n,this.pathPointProps,0,1)}},{key:"getFirstPart",value:function(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}},{key:"getLastPart",value:function(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}},{key:"getPredictedSpline",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];if(t.length>0){var n=this.getFirstPart();for(e.push.apply(e,k(n)),e.push.apply(e,k(t)),e.push.apply(e,k(e.slice(e.length-this.layout.length,e.length)));e.length<4*this.layout.length;)e.unshift(e.slice(0,this.layout.length))}return e}},{key:"reset",value:function(){jr(c(i.prototype),"reset",this).call(this),this.lastSpline.clear()}}]),i}(Gr);function Zr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Kr=Ft,Jr=K.fromValues(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5),Qr=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Zr()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t,n,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,u=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return e(this,i),(t=r.call(this)).spacing=o,t.splitCount=a,t.interpolateByLength=u,t.calculateDerivates=c,t.sizeScaleFactor=1,t.lastPoint=[],Object.defineProperty(s(t),"inputLayout",{get:function(){return n},set:function(t){n=t,this.inputStride=t.length,this.layout=this.calculateDerivates?t.concat([Ye.Property.D_X,Ye.Property.D_Y]):t,this.layoutIndex={},this.layout.indexed||(this.layout=new Proxy(this.layout,{get:function(t,e,n){if("indexed"==e)return!0;if("target"==e)return t;if("getIndex"==e){var r=t.index;return r||(r={},t.forEach((function(t,e){return r[t.name]=e})),t.index=r),function(t){return t.name in r?r[t.name]:-1}}return Reflect.get.apply(Reflect,arguments)}})),this.polynomials=[];for(var e=0;e<this.inputStride;e++)this.polynomials.push(Kr.create())},enumerable:!0}),t.c=Kr.create(),t.coefficientsVector=Kr.create(),t.coefficientDerivatesVector=Kr.create(),t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.getDiscretizedPath(t,!0),predicted:this.getDiscretizedPath(e,!1)}}},{key:"getImpl",value:function(t){return this.getDiscretizedPath(t)}},{key:"getOutput",value:function(t){return 0==t.length?void 0:new _r(this.layout.target,t,this.pathPointProps,this.tValues)}},{key:"getDiscretizedPath",value:function(t,e){if(this.keepTValues&&(this.tValues=[]),!t)return[];var n=this.discretize(t);return e&&n.length>0&&(this.lastPoint=n.slice(n.length-this.layout.length,n.length)),n}},{key:"discretize",value:function(t){if(this.lastPoint.length>0&&this.lastPoint.length!=this.layout.length)throw new Error("Incorrect or missing last point");0==this.lastPoint.length&&(this.inputLayout=t.layout,this.pathPointProps=t.pointProps);for(var e=[],n=this.splitCount,r=Math.max(1,10*(this.spacing>1?1:this.spacing)),i=this.lastPoint,o=0;o<t.segmentsCount;o++){for(var a=this.inputStride*(o+0),s=this.inputStride*(o+1),u=this.inputStride*(o+2),c=this.inputStride*(o+3),h=0;h<this.inputStride;h++){var l=t.points[a+h],f=t.points[s+h],d=t.points[u+h],p=t.points[c+h];Kr.set(this.c,l,f,d,p),Kr.transformMat4(this.polynomials[h],this.c,Jr)}if(this.interpolateByLength){var y=t.points[s+this.layout.getIndex(Ye.Property.X)],v=t.points[s+this.layout.getIndex(Ye.Property.Y)],m=t.points[u+this.layout.getIndex(Ye.Property.X)],g=t.points[u+this.layout.getIndex(Ye.Property.Y)],b=Math.sqrt((m-y)*(m-y)+(g-v)*(g-v)),x=this.pathPointProps.size;if(-1!=this.layout.getIndex(Ye.Property.SIZE)){var E=t.points[s+this.layout.getIndex(Ye.Property.SIZE)],w=t.points[u+this.layout.getIndex(Ye.Property.SIZE)];x=Math.min(E,w)}n=Math.floor(r*(b/x)/this.spacing)+1}for(var R=1/n,P=0;P<=n;P++){var M=0==i.length,T=P/n;if(0==o&&T<t.ts){if(!(T+R>=t.ts))continue;T=t.ts,M=this.spacing<=1}if(o==t.segmentsCount-1&&T>=t.tf){if(!(T<t.tf+R))continue;T=t.tf,M=this.lastSegment&&this.spacing<=1}if(!(o>0&&0==T)){var I=this.samplePoint(T);if(!M&&i.length>0){var S=this.distanceSqrd(i,I,this.inputLayout),A=this.layout.getIndex(Ye.Property.SIZE),C=(-1==A?this.pathPointProps.size:(i[A]+I[A])/2)*this.spacing;M=S>=C*C}M&&(e.push.apply(e,k(I)),i=I,this.keepTValues&&this.tValues.push(T))}}}return this.keepTValues&&(0!=e.length&&this.tValues.first==t.ts||(e.unshift.apply(e,k(this.samplePoint(t.ts))),this.tValues.unshift(t.ts)),this.tValues.last!=t.tf&&(e.push.apply(e,k(this.samplePoint(t.tf))),this.tValues.push(t.tf))),e}},{key:"samplePoint",value:function(t){var e=[];Kr.set(this.coefficientsVector,1,t,t*t,t*t*t);for(var n=0;n<this.inputStride;n++){var r=this.polynomials[n],i=Kr.dot(r,this.coefficientsVector);n==this.layout.getIndex(Ye.Property.SIZE)&&(i*=this.sizeScaleFactor),e.push(i)}return this.calculateDerivates&&(e.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(Ye.Property.X)])),e.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(Ye.Property.Y)]))),e}},{key:"getDerivativeOf",value:function(t){return Kr.set(this.coefficientDerivatesVector,t[1],2*t[2],3*t[3],0),Kr.dot(this.coefficientDerivatesVector,this.coefficientsVector)}},{key:"distanceSqrd",value:function(t,e){var n=t[this.layout.getIndex(Ye.Property.X)]-e[this.layout.getIndex(Ye.Property.X)],r=t[this.layout.getIndex(Ye.Property.Y)]-e[this.layout.getIndex(Ye.Property.Y)];return n*n+r*r}},{key:"reset",value:function(){jr(c(i.prototype),"reset",this).call(this),this.lastPoint.clear()}}]),i}(Gr);function $r(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ti=gt,ei=Ft,ni=K,ri=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if($r()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),n=r.call(this),Object.defineProperty(s(n),"brush",{get:function(){if(!t)throw new Error("brush not found");return t},set:function(e){t=e,this.reset()},enumerable:!0}),n}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.generatePolygons(t),predicted:this.generatePolygons(e)}}},{key:"getImpl",value:function(t){return this.generatePolygons(t)}},{key:"generatePolygons",value:function(t){if(!t)return[];for(var e=[],n=0;n<t.length;n++){var r=t.getPoint(n),i=this.applyBrush(r);e.push(i)}return e}},{key:"applyBrush",value:function(t){for(var e=[],n=this.createTransform(t),r=this.brush.selectShape(n.maxScale),i=0;i<r.length;i+=2){var o=ei.create(),a=ei.fromValues(r[i],r[i+1],0,1);ei.transformMat4(o,a,n),e.push(o[0]/o[3],o[1]/o[3])}return e}},{key:"createTransform",value:function(t){if(isNaN(t.size))throw new Error("Size information not found.");var e=ni.create(),n=t.size*t.scaleX,r=t.size*t.scaleY,i=t.size*t.scaleZ;return e.maxScale=Math.max(n,r,i),ni.translate(e,e,ti.fromValues(t.x,t.y,t.z||0)),ni.rotateZ(e,e,t.rotation),ni.translate(e,e,ti.fromValues(t.offsetX,t.offsetY,t.offsetZ)),ni.scale(e,e,ti.fromValues(n,r,i)),e}}]),i}(Gr);function ii(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var oi=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(ii()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=r.call(this)).lastPolygon=[],t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.getConvexHulls(t,!0),predicted:this.getConvexHulls(e)}}},{key:"getImpl",value:function(t){return this.getConvexHulls(t)}},{key:"getConvexHulls",value:function(t,e){var n=[],r=this.lastPolygon;return t.forEach((function(t){var e;(e=r).push.apply(e,k(t)),n.push(Fr.monotoneChain(r)),r=t})),e&&t.length>0&&(this.lastPolygon=t.last.slice()),n}},{key:"reset",value:function(){jr(c(i.prototype),"reset",this).call(this),this.lastPolygon.clear()}}]),i}(Gr);function ai(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var si=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(ai()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=r.call(this)).processPrediction=!1,t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.merge(t),predicted:this.processPrediction?this.merge(e):e}}},{key:"getImpl",value:function(t){return this.merge(t)}},{key:"merge",value:function(t){return t.length?en.union(t):[]}}]),i}(Gr);function ui(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ci=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(ui()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return e(this,i),(t=r.call(this)).epsilon=n,t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.simplify(t),predicted:e}}},{key:"getImpl",value:function(t){return this.simplify(t)}},{key:"simplify",value:function(t){var e=this;return t.map((function(t){return e.simplifyPolygonDouglasPeucker(t)}))}},{key:"simplifyPolygonDouglasPeucker",value:function(t){if(t.length<6)return t;t instanceof Float32Array&&(t=t.toArray());var e=this.simplifyPolylineDouglasPeucker(t.concat([t[0],t[1]]));return e.length<8?t:e.slice(0,e.length-2)}},{key:"simplifyPolylineDouglasPeucker",value:function(t){if(this.epsilon<=0)return[];if(t.length<4)return t;for(var e,n=0,r=0,o=2;o<t.length-2;o+=2){var a=i.perpendicularDistance(t[o],t[o+1],t[0],t[1],t[t.length-2],t[t.length-1]);a>n&&(r=o,n=a)}if(n>this.epsilon){var s=this.simplifyPolylineDouglasPeucker(t.slice(0,r+2)),u=this.simplifyPolylineDouglasPeucker(t.slice(r,t.length));e=s.concat(u.slice(2,u.length))}else e=[t[0],t[1],t[t.length-2],t[t.length-1]];return e}}],[{key:"perpendicularDistance",value:function(t,e,n,r,i,o){var a=t-n,s=i-n,u=a*(o-r)-s*(e-r);u*=u;var c=(a=i-n)*a+(s=o-r)*s;return c>0?Math.sqrt(u/c):Math.sqrt((n-t)*(n-t)+(r-e)*(r-e))}}]),i}(Gr),hi=function(){function t(){var n=this;e(this,t),this.layout=[Ye.Property.X,Ye.Property.Y],this.pathSegment=new Dr,this.pathProducer=new Xr(this.layout,(function(t,e,n){return e.createPathPoint()})),this.smoother=new Hr(this.layout.length),this.splineProducer=new qr(this.layout),this.splineInterpolator=new Qr,this.brushApplier=new ri,this.polygonMerger=new si,this.polygonSimplifier=new ci,this.splineProducer.keepAllData=!0,this.phase=null,this.raster=!1,this.pathPointProps={},this.queue=Promise.resolve(),Object.defineProperty(this,"settings",{get:function(){return{brush:n.brush,layout:n.layout,pathPointProps:n.pathPointProps,pathPointCalculator:n.calculator,movingAverageWindowSize:n.smoother.movingAverageWindowSize,splitCount:n.splineInterpolator.splitCount,epsilon:n.polygonSimplifier.epsilon,mergePrediction:n.polygonMerger.processPrediction}},enumerable:!0})}return I(t,[{key:"configure",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.splineInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,t.brush&&(this.brush=t.brush,this.raster=!(this.brush instanceof Ar),this.splineInterpolator.calculateDerivates=this.raster,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.interpolateByLength=this.raster,this.raster?this.splineInterpolator.keepAllData=!0:(this.brushApplier.brush=this.brush,this.brush.spacing>1?this.brushApplier.keepAllData=!0:this.polygonSimplifier.keepAllData=!0)),"basicMode"in t){if(t.basicMode&&this.raster)throw new Error("Basic mode is not supported for particles strokes");this.basicMode=t.basicMode}if(t.pathPointProps&&(this.pathPointProps=t.pathPointProps,this.splineProducer.pathPointProps=this.pathPointProps),t.pathPointCalculator&&(this.calculator=t.pathPointCalculator,this.pathProducer.pathPointCalculator=t.pathPointCalculator),t.layout){if(this.layout=t.layout,!this.raster){if(this.layout.includes(Ye.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(Ye.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(Ye.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(Ye.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(Ye.Property.RED)&&isNaN(this.pathPointProps.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(Ye.Property.GREEN)&&isNaN(this.pathPointProps.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(Ye.Property.BLUE)&&isNaN(this.pathPointProps.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(Ye.Property.ALPHA)&&isNaN(this.pathPointProps.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(Ye.Property.SIZE)&&isNaN(this.pathPointProps.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout}t.movingAverageWindowSize>0&&(this.smoother.movingAverageWindowSize=t.movingAverageWindowSize),t.splitCount>0&&(this.splineInterpolator.splitCount=t.splitCount),t.epsilon>0&&(this.polygonSimplifier.epsilon=t.epsilon),"interpolateByLength"in t&&(this.splineInterpolator.interpolateByLength=t.interpolateByLength),"mergePrediction"in t&&(this.polygonMerger.processPrediction=t.mergePrediction),t.onBuildComplete&&(this.onComplete=t.onBuildComplete),this.reset()}},{key:"createSensorPoint",value:function(e,n,r){var i={x:n,y:r,touchID:this.touchID};return t.createPoint(e,i)}},{key:"add",value:function(t,e){if(!this.brush)throw new Error("InkBuilder instance is not configured properly, brush is not found");if(!this.layout)throw new Error("InkBuilder instance is not configured properly, layout is not found");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator is not found");if(!t.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=t.phase;var n=new Rr(t),r=e?new Rr(e):null;this.device&&(this.phase==Or.Phase.BEGIN&&this.device.openStream(t),this.device.add(n),this.phase==Or.Phase.END&&(this.sensorData=this.device.closeStream()));var i=this.pathProducer.add(this.phase,n,r);this.pathSegment.add(this.phase,i.added,i.predicted)}},{key:"ignore",value:function(t){if(!t.phase)throw new Error("SensorPoint phase is not found");this.device&&t&&t.phase==Or.Phase.UPDATE&&this.device.add(new Rr(t),!0)}},{key:"build",value:function(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}},{key:"processSpline",value:function(t,e,n,r){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}},{key:"mergeAndSimplify",value:function(t,e,n){return n=this.polygonMerger.add(t,e,n.added,n.predicted),n=this.polygonSimplifier.add(t,e,n.added,n.predicted)}},{key:"getSensorData",value:function(){return this.sensorData}},{key:"getSpline",value:function(){return new Nr(this.layout,this.splineProducer.allData.points,this.pathPointProps)}},{key:"getInkPath",value:function(t){var e;return this.raster?e=this.splineInterpolator.allData:this.basicMode||(this.splineInterpolator.spacing>1?e=this.brushApplier.allData:(e=this.polygonSimplifier.allData,t&&(e=this.polygonMerger.merge(e),e=this.polygonSimplifier.simplify(e)))),e}},{key:"abort",value:function(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}},{key:"reset",value:function(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.splineInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}},{key:"restart",value:function(){this.phase=void 0,this.touchID=void 0}}],[{key:"createPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={x:e.x||t.offsetX||t.clientX,y:e.y||t.offsetY||t.clientY,z:void 0,timestamp:Math.floor(t.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0},r={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(n,"phase",{value:Or.Phase[t.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(n,"force",{get:function(){return this.pressure},enumerable:!0}),Object.defineProperty(n,"pointer",{value:r,enumerable:!0}),Object.defineProperty(n.pointer,"provider",{get:function(){return cr.Type[this.type.toUpperCase()]},enumerable:!0}),t instanceof PointerEvent)r.id=t.pointerId,r.type=t.pointerType,"pen"!=t.pointerType&&"mouse"!=t.pointerType||(r.button=t.button,r.buttons=t.buttons),"pen"!=t.pointerType&&"touch"!=t.pointerType||t.twist>0&&(n.rotation=Math.toRadians(t.twist)),"pen"==t.pointerType?(n.pressure=t.pressure,n.tiltX=t.tiltX,n.tiltY=t.tiltY):"touch"==t.pointerType&&t.pressure>0&&(n.pressure=t.pressure);else if(t instanceof MouseEvent)r.type="mouse",r.button=t.button,r.buttons=t.buttons;else{if(!(t instanceof TouchEvent))throw new Error("Unexpected event detected: ".concat(t.constructor.name,". Expected event should be instance of PointerEvent, MouseEvent or TouchEvent."));if(!("touchID"in e))throw new Error("props.touchID is required for touch event");if(!(t=Array.from(t.changedTouches).filter((function(t){return t.identifier==e.touchID})).first))return null;n.x||(n.x=t.offsetX||t.clientX),n.y||(n.y=t.offsetY||t.clientY),r.id=t.identifier,r.type="touch",t.force>0&&.5!==t.force&&(n.pressure=t.force),t.radiusX>0&&t.radiusY>0&&t.radiusX!=t.radiusY&&(n.radiusX=t.radiusX,n.radiusY=t.radiusY),t.rotationAngle>0&&(n.rotation=Math.toRadians(t.rotationAngle))}return n}}]),t}();function li(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}hi.Phase=Or.Phase;var fi=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(li()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=r.call(this)).convexHullChainProducer=new oi,t}return I(i,[{key:"build",value:function(){var t=this.buildSegment();return t.phase=this.phase,t.predicted&&(t.predicted.predicted=!0),this.onComplete&&this.onComplete(t),this.phase==Or.Phase.END&&this.restart(),t}},{key:"buildSegment",value:function(){var t={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return this.basicMode||(t=this.smoother.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted)),t=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),t=this.processSegment(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),this.pathSegment.reset(),t}},{key:"processSegment",value:function(t,e,n,r){var i=this.splineInterpolator.add(t,e,n,r);return this.raster||this.basicMode||(i.added||i.predicted?(i=this.brushApplier.add(t,e,i.added,i.predicted),this.splineInterpolator.spacing<=1&&(i=this.convexHullChainProducer.add(t,e,i.added,i.predicted),i=this.mergeAndSimplify(t,e,i))):i={added:i.added?i.added.points:[],predicted:i.predicted?i.predicted.points:[]}),i}},{key:"processSpline",value:function(t){return this.processSegment(!0,!0,t).added}}]),i}(hi),di=0,pi=function(){function t(){e(this,t),this.results={},this.next=0,this.lastPolygon,this.init()}return I(t,[{key:"init",value:function(){var t=this,e=new Blob(['\n// let workerID;\n\nlet QuickSort;\nlet ConvexHullProducer;\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.init) {\n\t\t// workerID = message.index;\n\t\timportClasses(message.imports);\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data, message.type);\n\tself.postMessage({key: message.key, type: message.type, index: message.index, data: result}, [result.buffer]);\n}\n\nfunction importClasses(imports) {\n\tlet blob = new Blob(imports, {type: "application/javascript"});\n\tlet url = URL.createObjectURL(blob);\n\n\tself.importScripts(url);\n\n\tURL.revokeObjectURL(url);\n}\n'],{type:"application/javascript"}),n=URL.createObjectURL(e);this.workers=[new Worker(n),new Worker(n),new Worker(n),new Worker(n)],URL.revokeObjectURL(n);var r=[Object.toSource(Br,"QuickSort"),Object.toSource(Fr,"ConvexHullProducer")];this.workers.forEach((function(e,n){e.addEventListener("message",(function(e){return t.recieve(e.data)})),e.addEventListener("error",(function(e){return t.recieveError(e,n)}),!1),e.postMessage({init:!0,index:n,imports:r})}))}},{key:"add",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=di++,o=this.lastPolygon;return e.length>0&&(this.lastPolygon=e.last),t==Or.Phase.END&&(this.lastPolygon=null),this.results[i]={added:[],predicted:[],expected:e.length+r.length,processed:0},new Promise((function(t,a){n.results[i].resolve=t,n.send(i,"added",o,e),n.send(i,"predicted",e.last,r)}))}},{key:"reset",value:function(){this.lastPolygon=null}},{key:"send",value:function(t,e,n,r){var i=this,o=[];n&&(o=n),r.forEach((function(n,r){var a;(a=o).push.apply(a,k(n));var s=i.workers[i.next%i.workers.length];i.next++,s.postMessage({key:t,type:e,index:r,data:o}),o=n}))}},{key:"recieve",value:function(t){var e=this.results[t.key];e[t.type][t.index]=t.data,e.processed++,e.processed==e.expected&&(delete this.results[t.key],e.resolve({added:e.added,predicted:e.predicted}))}},{key:"recieveError",value:function(t,e){console.warn("worker ".concat(e)),console.error(t)}},{key:"close",value:function(){this.workers.forEach((function(t){return t.terminate()}))}}]),t}(),yi=function(){function t(){e(this,t),this.queue=Promise.resolve(),this.thenables=[]}var n;return I(t,[{key:"then",value:function(t,e,n){var r=this;return this.thenables.push(t),this.queue=this.queue.then((function(){return r.thenables.shift(),t.canceled?Promise.resolve():t.apply(void 0,arguments)})),e&&this.then((function(t){return e(t,n)})),this}},{key:"catch",value:function(t){return this.queue=this.queue.catch(t),this}},{key:"cancel",value:function(){this.thenables.forEach((function(t){return t.canceled=!0}))}},{key:"isEmpty",value:function(){return 0==this.thenables.length}}],[{key:"serial",value:(n=on(nn.mark((function e(n,r){var i;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new t,n.forEach((function(t,e){return i.then(t,r,e)})),e.abrupt("return",i.queue);case 3:case"end":return e.stop()}}),e)}))),function(t,e){return n.apply(this,arguments)})}]),t}();function vi(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var mi=[],gi=function(t){o(a,t);var n,r,i=(n=a,function(){var t,e=c(n);if(vi()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).convexHullChainProducer=new pi,mi.push(t.convexHullChainProducer),t.queue=Promise.resolve(),t.chainQueue=new yi,t}return I(a,[{key:"add",value:function(t,e){if(!this.onComplete)throw new Error("InkBuilder instance is not configured properly, onBuildComplete is not found");this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),jr(c(a.prototype),"add",this).call(this,t,e)}},{key:"configure",value:function(t){var e=this;this.chainQueue.isEmpty()?jr(c(a.prototype),"configure",this).call(this,t):this.chainQueue.then((function(){return jr(c(a.prototype),"configure",e).call(e,t)}))}},{key:"build",value:function(){var t=this;if(this.phase){var e=this.phase;this.phase==Or.Phase.END&&this.restart();var n=function(){return Promise.resolve().then((function(){return t.buildPhase=e,t.buildSegment()})).then((function(n){t.building=!1,t.aborted||(n.phase=e,n.predicted.predicted=!0,t.onComplete(n))}))};e==Or.Phase.END?this.queue=this.queue.then(n):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=n())}}},{key:"buildChain",value:function(){var t=this;if(this.phase){var e=this.phase,n=this.getLastPathSegment();this.phase==Or.Phase.END&&this.restart(),this.chainQueue.then((function(){return t.buildPhase=e,t.buildSegment(n)})).then((function(n){n.phase=e,n.predicted.predicted=!0,t.onComplete(n)}))}return this.chainQueue}},{key:"getLastPathSegment",value:function(){var t=this.pathSegment;return this.pathSegment=new Dr,t}},{key:"buildSegment",value:function(t){var e;t||(t=this.pathSegment),e=this.smoother.add(t.first,t.last,t.accumulatedAddition,t.lastPrediction),e=this.splineProducer.add(t.first,t.last,e.added,e.predicted);var n=t.first,r=t.last;return t.reset(),this.processSegment(n,r,e.added,e.predicted)}},{key:"processSegment",value:function(t,e,n,r){var i=this,o=this.splineInterpolator.add(t,e,n,r);return this.raster?Promise.resolve(o):o.added||o.predicted?(o=this.brushApplier.add(t,e,o.added,o.predicted),this.splineInterpolator.spacing<=1?this.convexHullChainProducer.add(this.phase,o.added,o.predicted).then((function(n){return i.mergeAndSimplify(t,e,n)})):Promise.resolve(o)):Promise.resolve({added:o.added?o.added.points:[],predicted:o.predicted?o.predicted.points:[]})}},{key:"processSpline",value:(r=on(nn.mark((function t(e){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.processSegment(!0,!0,e).added;case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"abort",value:function(){jr(c(a.prototype),"abort",this).call(this),this.buildPhase=null,this.chainQueue.cancel()}}],[{key:"closeAll",value:function(){mi.forEach((function(t){return t.close()})),mi.clear()}}]),a}(hi);function bi(){}bi.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};var xi=bi.BlendMode;function Ei(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return wi(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return wi(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function wi(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Ri={createTexture:function(t,e,n){e||(e=t.CLAMP_TO_EDGE),n||(n=t.NEAREST);var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.bindTexture(t.TEXTURE_2D,null),r},fillTexture:function(t,e,n){return on(nn.mark((function r(){var i,o,a,s,u,c,h;return nn.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!Array.isArray(n)){r.next=27;break}i=[],o=Ei(n),r.prev=4,o.s();case 6:if((a=o.n()).done){r.next=14;break}return s=a.value,r.next=10,ln(s);case 10:u=r.sent,i.push(u);case 12:r.next=6;break;case 14:r.next=19;break;case 16:r.prev=16,r.t0=r.catch(4),o.e(r.t0);case 19:return r.prev=19,o.f(),r.finish(19);case 22:return r.next=24,Ri.completeMipMap(i);case 24:Ri.initTexture(t,e,i),r.next=32;break;case 27:return c=n,r.next=30,ln(c);case 30:h=r.sent,Ri.initTexture(t,e,h);case 32:case"end":return r.stop()}}),r,null,[[4,16,19,22]])})))()},completeMipMap:function(t){return on(nn.mark((function e(){var n,r,i;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.sort((function(t,e){return e.width-t.width})),1!=t.last.width){e.next=3;break}return e.abrupt("return");case 3:n=t.last.width;case 4:if(!(n>1)){e.next=14;break}return n/=2,(r=new OffscreenCanvas(t.last.width/2,t.last.height/2)).getContext("2d").drawImage(t.last,0,0,r.width,r.height),e.next=10,createImageBitmap(r);case 10:i=e.sent,t.push(i),e.next=4;break;case 14:case"end":return e.stop()}}),e)})))()},initTexture:function(t,e,n){if(t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(n)){var r=n;e.size=[],r.forEach((function(n,r){t.texImage2D(t.TEXTURE_2D,r,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),e.size.push({width:n.width,height:n.height}),n.close&&n.close()})),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)}else t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),e.size={width:n.width,height:n.height},n.close&&n.close();t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.bindTexture(t.TEXTURE_2D,null),this.logGLError(t,e.name)},readTexturePixels:function(t,e,n){var r=new Uint8Array(n.width*n.height*4),i=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),t.readPixels(n.left,n.top,n.width,n.height,t.RGBA,t.UNSIGNED_BYTE,r),t.deleteFramebuffer(i),r},logGLError:function(t,e){var n=t.getError();n>0&&console.error("WebGL error - "+e+": "+n)}},Pi=function(){function t(n,r,i){var o=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};e(this,t),this.name=n,this.spacing=a.spacing||.15,this.scattering=a.scattering||0,this.blendMode=a.blendMode||xi.SOURCE_OVER,this.rotationMode=a.rotationMode||t.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:function(){return{spacing:o.spacing,scattering:o.scattering,blendMode:o.blendMode,rotationMode:o.rotationMode}},enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:function(){return{randomize:o.randomizeFill,size:o.fillTextureSize,offset:o.fillTextureOffset}},enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return Array.isArray(o.descriptor.shape)?o.descriptor.shape.map((function(t){return t.value})):o.descriptor.shape.value},enumerable:!0}),Object.defineProperty(this,"fill",{get:function(){return o.descriptor.fill.value},enumerable:!0}),this.updateShape(r),this.updateFill(i,s)}var n,r,i,o,a;return I(t,[{key:"updateShape",value:(a=on(nn.mark((function t(e){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Array.isArray(e)?e=e.map((function(t){return"string"==typeof t?Mr.getInstance(t):t instanceof Mr?t:new Mr(t.name,t.src)})):"string"==typeof e?e=Mr.getInstance(e):e instanceof Mr||(e=new Mr(e.name,e.value)),this.descriptor.shape=e,!this.ctx){t.next=5;break}return t.next=5,this.configureShape();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"updateFill",value:(o=on(nn.mark((function t(e){var n,r=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:{},this.randomizeFill=!("randomize"in n)||n.randomize,this.fillTextureSize=n.size,this.fillTextureOffset=n.offset||{x:0,y:0},!Array.isArray(e)){t.next=6;break}throw new Error("Mipmap is not compatible whith fill texture");case 6:if("string"==typeof e?e=Mr.getInstance(e):e instanceof Mr||(e=new Mr(e.name,e.value)),this.descriptor.fill=e,!this.ctx){t.next=11;break}return t.next=11,this.configureFill();case 11:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})},{key:"configure",value:(i=on(nn.mark((function t(e){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.ctx=e,t.next=3,this.configureShape();case 3:return t.next=5,this.configureFill();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"configureShape",value:(r=on(nn.mark((function t(){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.shapeTexture||(this.shapeTexture=Ri.createTexture(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),t.next=3,Ri.fillTexture(this.ctx,this.shapeTexture,this.shape);case 3:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"configureFill",value:(n=on(nn.mark((function t(){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.fillTexture||(this.fillTexture=Ri.createTexture(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),t.next=3,Ri.fillTexture(this.ctx,this.fillTexture,this.fill);case 3:this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size);case 4:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"toJSON",value:function(){return{type:this.constructor.name,name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map((function(t){return t.toJSON()})):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}},{key:"equals",value:function(t){return t==this&&t.shapeTexture==this.shapeTexture&&t.fillTexture==this.fillTexture}},{key:"delete",value:function(){this.deleteShape(),this.deleteFill()}},{key:"deleteShape",value:function(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}},{key:"deleteFill",value:function(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}],[{key:"fromJSON",value:function(e){e.particleSettings.blendMode=xi[e.particleSettings.blendMode],e.particleSettings.rotationMode=t.RotationMode[e.particleSettings.rotationMode];var n=Array.isArray(e.shape)?e.shape.map((function(t){return Mr.fromJSON(t)})):Mr.fromJSON(e.shape),r=Mr.fromJSON(e.fill);return new t(e.name,n,r,e.particleSettings,e.fillTextureSettings)}}]),t}();function ki(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Pi.createEnum("RotationMode",["NONE","RANDOM","TRAJECTORY"]);var Mi,Ti,Ii=K,Si=function(t){o(a,t);var n,r,i=(n=a,function(){var t,e=c(n);if(ki()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function a(t,n,r,o){var u,c;return e(this,a),u=i.call(this,n.id),Object.defineProperty(s(u),"layout",{value:n.layout,enumerable:!0}),Object.defineProperty(s(u),"points",{get:function(){return n.points},enumerable:!0}),Object.defineProperty(s(u),"pointProps",{value:n.pointProps,enumerable:!0}),Object.defineProperty(s(u),"ts",{value:n.ts,enumerable:!0}),Object.defineProperty(s(u),"tf",{value:n.tf,enumerable:!0}),Object.defineProperty(s(u),"stride",{value:n.stride,enumerable:!0}),Object.defineProperty(s(u),"length",{value:n.length,enumerable:!0}),Object.defineProperty(s(u),"segmentsCount",{value:n.segmentsCount,enumerable:!0}),n.randomSeed&&Object.defineProperty(s(u),"randomSeed",{value:n.randomSeed,enumerable:!0}),Object.defineProperty(s(u),"color",{get:function(){return n.color},set:function(t){n.color=t,r&&(r.color=t)},enumerable:!0}),Object.defineProperty(s(u),"sensorData",{value:o,enumerable:!0}),Object.defineProperty(s(u),"spline",{value:n,enumerable:!0}),Object.defineProperty(s(u),"path",{get:function(){return r||this.buildPath(),r},set:function(t){r=t},enumerable:!0}),Object.defineProperty(s(u),"bounds",{get:function(){return c||(c=(c=this.brush instanceof Pi?this.path.getBounds(this.brush.scattering):He.ofPolygons(this.path)).ceil()),this.matrix?Tn(c,this.matrix):c},enumerable:!0}),u.reset=function(){r=null,c=null},Object.defineProperty(s(u),"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(s(u),"brush",{get:function(){return t||(t=this.descriptor.brush.value),t},set:function(e){if(this.reset(),"string"==typeof e?e=new Mr(e):e instanceof Ar||e instanceof Pi?e=new Mr(e.name,e):e instanceof Mr||(e=new Mr(e.name,e.value)),e instanceof Pi&&!n.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");t=null,this.descriptor.brush=e},enumerable:!0}),u.brush=t,u.renderMode=void 0,u.sensorDataOffset=0,u.sensorDataMapping=[],u}return I(a,null,[{key:"config",get:function(){return b.stroke}}]),I(a,[{key:"resolveID",value:function(){return"function"==a.config.generateID?a.config.generateID(this):jr(c(a.prototype),"resolveID",this).call(this)}},{key:"clone",value:function(){var t=new a(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return t.renderMode=this.renderMode,t.sensorDataOffset=this.sensorDataOffset,t.sensorDataMapping=this.sensorDataMapping.clone(),t}},{key:"init",value:(r=on(nn.mark((function t(e){return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.pathProceessInProgress=!0,Ti||(Ti=new gi),Ti.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&Ti.configure(e),t.next=6,Ti.processSpline(this.spline);case 6:this.path=t.sent,delete this.pathProceessInProgress;case 8:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"buildPath",value:function(t){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");Mi||(Mi=new fi),Mi.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),t&&Mi.configure(t),this.path=Mi.processSpline(this.spline)}},{key:"getSegment",value:function(t){var e=t,n=t+3,r=0==e?this.ts:0,i=n+1==this.length?this.tf:1;return this.spline.slice(e,n,r,i)}},{key:"getSensorPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e;if(this.sensorData){var n,r=this.sensorData.inkStream;if(r)this.sensorDataMapping.length>0?n=t>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[t]:(n=this.sensorDataOffset+t)>=r.length&&(n=r.length-1),(e=r.get(n)).index=n}return e}},{key:"getPoint",value:function(t){return this.spline.getPoint(t)}},{key:"setPoint",value:function(t,e){var n=this,r=t*this.stride;this.layout.forEach((function(t,i){return n.points[r+i]=e.getProperty(t)}))}},{key:"pointAt",value:function(t){return this.getPoint(t)}},{key:"getAverageWidth",value:function(){var t=0;if(this.layout.includes(Ye.Property.SIZE)){for(var e=0,n=0;n<this.length;n++)e+=this.getPoint(n).size;t=e/this.length}else t=this.pointProps.size;return t}},{key:"split",value:function(t){var e=this,n=t.map((function(t){return e.subStroke(t)}));return n.includes(this)||0==n.length?void 0:n}},{key:"subStroke",value:function(t){var e=t.fromIndex,n=t.toIndex,r=t.fromTValue,i=t.toTValue;if(0==e&&n+1==this.length&&r==this.ts&&i==this.tf)return this;var o=this.spline.slice(e,n,r,i),s=new a(this.descriptor.brush,o,void 0,this.sensorData);return s.renderMode=this.renderMode,this.sensorData&&(s.sensorDataOffset=this.sensorDataOffset+e,this.sensorDataMapping.length>0?s.sensorDataMapping=this.sensorDataMapping.slice(e,n+1):s.sensorDataMapping=[]),s}},{key:"transform",value:function(t){if(t||(t=this.matrix,delete this.matrix),t){for(var e=0;e<this.length;e++){var n=this.getPoint(e);n.transform(t),this.setPoint(e,n)}this.reset()}}},{key:"updateTransform",value:function(t){this.matrix||(this.matrix=Ii.create()),Ii.multiply(this.matrix,this.matrix,t)}},{key:"setTransform",value:function(t){this.matrix=t}}],[{key:"createInstance",value:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4?arguments[4]:void 0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=r.color;u&&(delete(r=Object.assign({},r)).color,r.red=u.red,r.green=u.green,r.blue=u.blue,r.alpha=u.alpha);var c=new Nr(n,e,r,o,s);return c.randomSeed=i,new a(t,c)}},{key:"validatePath",value:function(t){if(!t)return!1;if(0==t.length)return!1;if(Array.isArray(t))return!0;var e=!1,n=0,r=!1,i=t.pointProps,o=i.size,a=i.red,s=i.green,u=i.blue,c=i.alpha;if(!(t instanceof _r)){var h=t.points.length,l=t.layout.length;r=0==h||h<4*l,n=h%l}return 0!=n?console.error("The points array (length: ".concat(t.points.length,") does not refer to provided layout (").concat(t.layout.map((function(t){return t.name})).join(", "),")")):r?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!t.layout.includes(Ye.Property.SIZE)&&isNaN(o)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!t.layout.includes(Ye.Property.RED)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a RED property"):!t.layout.includes(Ye.Property.GREEN)&&isNaN(s)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!t.layout.includes(Ye.Property.BLUE)&&isNaN(u)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!t.layout.includes(Ye.Property.ALPHA)&&isNaN(c)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):e=!0,e}},{key:"configure",value:function(t,e){b[t]=e}}]),a}(or);Si.RenderMode=Object.assign.apply(Object,[{}].concat(k(Object.keys(xi).map((function(t){return Dn({},t,"will://rasterization/3.0/blend-mode/".concat(On.getPropName(t,!0)))}))))),Si.RenderMode.get=function(t){return Si.RenderMode[On.getEnumValueName(t.replace(/-/g,"_"))]},Si.RenderMode.getBlendMode=function(t){return xi[Object.keys(Si.RenderMode).filter((function(e){return Si.RenderMode[e]==t})).first]};if(ENVIRONMENT==EnvironmentType.NODE){var Ai=canvas,Ci=Ai.Canvas,Oi=Ai.ImageData,Di=Ai.Image;global.OffscreenCanvas=Ci,global.ImageData=Oi,global.Image=Di}var Ni=function(){function t(){e(this,t)}var n,r;return I(t,[{key:"getExportCanvas",value:function(t){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}},{key:"toBlob",value:(r=on(nn.mark((function t(e){var n,r,i,o=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=o.length>1&&void 0!==o[1]?o[1]:"image/png",r=o.length>2&&void 0!==o[2]?o[2]:.92,"undefined"!=typeof Blob){t.next=8;break}if("undefined"!=typeof Buffer){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");case 8:if(!(i=this.getExportCanvas(e)).toBlob){t.next=13;break}return t.abrupt("return",new Promise((function(t,e){return i.toBlob(t,n,r)})));case 13:return t.abrupt("return",i.convertToBlob({type:n,quality:r}));case 14:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"toBuffer",value:(n=on(nn.mark((function t(e){var n,r,i,o,a,s=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=s.length>1&&void 0!==s[1]?s[1]:"image/png",r=s.length>2&&void 0!==s[2]?s[2]:{},"undefined"!=typeof Buffer){t.next=8;break}if("undefined"!=typeof Blob){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");case 8:return i=this.getExportCanvas(e),r.filters&&(o=Array.isArray(r.filters)?r.filters.slice():[r.filters],a=0,o.forEach((function(t){a|=i["PNG_FILTER_".concat(t.name)]})),Object.assign({},r,{filters:a})),t.abrupt("return",new Promise((function(t,e){return i.toBuffer((function(n,r){return n?e(n):t(r)}),n,r)})));case 11:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})}]),t}();function Li(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Ni.createEnum("PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);var _i=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Li()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),n=r.call(this),Object.defineProperty(s(n),"surface",{value:t.canvas}),Object.defineProperty(s(n),"ctx",{value:t}),Object.defineProperty(s(n),"bounds",{get:function(){return He.create(0,0,n.width,n.height)},enumerable:!0}),n}return I(i,[{key:"width",get:function(){return this.surface.width}},{key:"height",get:function(){return this.surface.height}}]),I(i,[{key:"clear",value:function(t,e){if(e){if(A.is(t))throw new Error("`clear` first argument should be Rectangle")}else A.is(t)&&(e=t,t=null);t||(t=this.bounds),this.ctx.clearRect(t.left,t.top,t.width,t.height),e&&(this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.fillRect(t.left,t.top,t.width,t.height))}},{key:"draw",value:function(t){return this.drawStroke(t.brush,t.path,t.color,t.matrix)}},{key:"drawStroke",value:function(t,e,n,r){if(e instanceof _r)return this.drawSpline(e,n);if(!Si.validatePath(e))return null;var i=He.ofPolygons(e);return(i=this.bounds.intersect(i))&&(i=i.ceil(),this.ctx.save(),r?(i=Tn(i,r),this.ctx.setTransform(r[Oe.a],r[Oe.b],r[Oe.c],r[Oe.d],r[Oe.dx],r[Oe.dy])):(this.ctx.rect(i.left,i.top,i.width,i.height),this.ctx.clip()),e.holesClockwise=!0,this.drawPath(e,"rgb(".concat(n.red,", ").concat(n.green,", ").concat(n.blue,")")),t.pattern&&this.drawPath(e,t.pattern),this.ctx.restore()),i}},{key:"drawPath",value:function(t,e){var n=this;this.ctx.beginPath(),t.forEach((function(e,r){if(n.ctx.moveTo(e[0],e[1]),t.holesClockwise||0==r)for(var i=2;i<e.length;i+=2)n.ctx.lineTo(e[i],e[i+1]);else for(var o=e.length-2;o>=0;o-=2)n.ctx.lineTo(e[o],e[o+1]);n.ctx.closePath()})),e&&(this.ctx.fillStyle=e),this.ctx.fill()}},{key:"drawSpline",value:function(t,e){var n;e||(e=t.color),this.ctx.save(),this.ctx.fillStyle="rgb(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,")");for(var r=0;r<t.length;r++){var i=t.getPoint(r),o=i.size/2;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),n=He.create(i.x-o,i.y-o,i.size,i.size).union(n)}return this.ctx.restore(),n.ceil()}},{key:"fill",value:function(t,e){var n;return t instanceof He?n=t:("number"==typeof t[0]&&(t=[t]),n=He.ofPolygons(t)),(n=this.bounds.intersect(n))&&(n=n.ceil(),this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),t instanceof He?this.ctx.fillRect(t.left,t.top,t.width,t.height):(this.ctx.save(),this.ctx.rect(n.left,n.top,n.width,n.height),this.ctx.clip(),this.drawPath(t),this.ctx.restore())),n}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=xi.SOURCE_OVER),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");e.rect&&(e.sourceRect=e.rect,e.destinationRect=e.rect),this.ctx.save(),e.transform?this.ctx.setTransform(e.transform[Oe.a],e.transform[Oe.b],e.transform[Oe.c],e.transform[Oe.d],e.transform[Oe.dx],e.transform[Oe.dy]):e.clipRect&&(this.ctx.rect(e.clipRect.left,e.clipRect.top,e.clipRect.width,e.clipRect.height),this.ctx.clip()),this.ctx.globalCompositeOperation=e.mode,e.sourceRect&&e.destinationRect?this.ctx.drawImage(t.ctx.canvas,e.sourceRect.left,e.sourceRect.top,e.sourceRect.width,e.sourceRect.height,e.destinationRect.left,e.destinationRect.top,e.destinationRect.width,e.destinationRect.height):this.ctx.drawImage(t.ctx.canvas,0,0),this.ctx.restore()}},{key:"createImageData",value:function(t,e,n){return new ImageData(t,e,n)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.ctx.getImageData(t.x,t.y,t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.ctx.putImageData(t,e,n)}},{key:"readPixels",value:function(t){return this.getImageData(t).data}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e||(e=this.bounds),this.putImageData(this.createImageData(t,e.width,e.height),e.x,e.y)}},{key:"getExportCanvas",value:function(t){var e=this.surface;return t&&(t=t.intersect(this.bounds).ceil(),(e=new OffscreenCanvas(t.width,t.height)).getContext("2d").putImageData(this.getImageData(t),0,0)),e}},{key:"resize",value:function(t,e){this.surface.width=t,this.surface.height=e}}]),i}(Ni);function Bi(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Fi=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Bi()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),r.call(this,t)}return I(i,[{key:"createLayer",value:function(t,e){t&&e||("undefined"==typeof screen?(t=this.surface.width,e=this.surface.height):e=t=Math.max(screen.width,screen.height));var n=new OffscreenCanvas(t,e);return new _i(n.getContext("2d"))}}],[{key:"createInstance",value:function(t,e,n){if(!t||"function"!=typeof t.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(!(e>0&&n>0))throw new Error("width and height are required and should be positive whole numbers");if("undefined"!=typeof screen){var r=Math.max(screen.width,screen.height);t.width=r,t.height=r}return t.width=e,t.height=n,new i(t.getContext("2d"))}}]),i}(_i),Ui=function(){function t(n,r){var i=this;e(this,t),this.canvas=n,this.layer=r||n.createLayer(),this.ownLayer=!r,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=A.TRANSPERENT,this.blendMode=xi.SOURCE_OVER,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:i.brush,color:i.color,backgroundColor:i.backgroundColor,blendMode:i.blendMode}},enumerable:!0})}return I(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),this.restart=!0}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t instanceof Si){var n=t,r=xi.SOURCE_OVER;if(n.renderMode&&!(r=Si.RenderMode.getBlendMode(n.renderMode)))return void console.warn("Cannot process ".concat(n.renderMode," render mode. Requres custom processing."));this.color=n.color,this.blendMode=r,this.reset();var i=this.layer.draw(n);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(t)){var o=this.layer.drawStroke(this.brush,t,this.color);o&&(this.incompleteStrokeBounds=o.union(this.incompleteStrokeBounds),this.strokeBounds=o.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.clear()),e=this.preliminaryLayer):e=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:xi.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=e.drawStroke(this.brush,t,this.color),this.updatedArea=He.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer||(this.alphaLayer=this.canvas.createLayer())),this.restart=!1}},{key:"validate",value:function(t){return t&&t.length>0}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=t||this.canvas,n=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=e.bounds.intersect(this.updatedArea);if(r){var i=this.color.alpha;i<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(e,{rect:r}),this.alphaLayer.ctx.globalAlpha=i,this.alphaLayer.blend(n,{mode:this.blendMode,rect:r}),e.clear(r),e.blend(this.alphaLayer,{rect:r})):e.blend(n,{mode:this.blendMode,rect:r.ceil()})}this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,n){if(this.strokeBounds){n||(n=this.blendMode);var r=this.layer,i=t||this.canvas;if(e=i.bounds.intersect(e||this.strokeBounds)){var o=this.color.alpha;o<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=o,this.alphaLayer.blend(r,{rect:e}),i.blend(this.alphaLayer,{mode:n,rect:e})):i.blend(r,{mode:n,rect:e.ceil()})}}}},{key:"toStroke",value:function(t,e){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");var n=t.getSensorData(),r=t.getSpline(),i=t.getInkPath(e),o=new Si(this.brush,r,i,n);return n&&(o.sensorDataMapping=n.inkStream.getPipelineMapping()),this.blendMode!=xi.SOURCE_OVER&&(o.renderMode=Si.RenderMode.get(this.blendMode)),o}},{key:"delete",value:function(){console.warn("Not applicable with 2D API")}}]),t}(),ji={};ENVIRONMENT==EnvironmentType.NODE&&(ji=gl);var Yi=ji,Xi=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e(this,t),this.width=n,this.height=r}return I(t,[{key:"getContext",value:function(t,e){if(!this.context){var n=this.width,r=this.height;this.context=Yi(n,r,e),this.context.canvas=this;var i=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:function(){return n},set:function(t){n=t,i.resize(n,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:function(){return n},set:function(t){r=t,i.resize(n,r)},enumerable:!0})}return this.context}},{key:"destroy",value:function(){this.context&&(this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context)}}]),t}();function Gi(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var zi=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Gi()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(e(this,i),(n=r.call(this)).inkGLContext=t,n.gl=t.gl,n.scaleFactor=o.scaleFactor||1,n.flipY=!!o.flipY,n.useTextureStorage=!1,o.renderbuffer){if(!o.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");var s=n.initWithGLBuffers(o.framebuffer,o.renderbuffer);n.flipY=!0,n.ownGLResources=!!o.ownGLResources,n.setDimensions(s.width,s.height)}else if(o.framebuffer){var u=n.initWithGLFramebuffer(o.framebuffer);n.flipY=!0,n.ownGLResources=!!o.ownGLResources,n.setDimensions(u.width,u.height)}else if(o.texture){if(!(o.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");var c;if(n.texture=o.texture,n.useTextureStorage=!0,o.width>0&&o.height>0)c={width:o.width,height:o.height};else{if(!n.texture.image)throw new Error("`width` and `height` are required when `texture` is available");c={width:n.texture.image.width,height:n.texture.image.height}}n.ownGLResources=!!o.ownGLResources,n.setDimensions(c.width,c.height)}else{var h=o.width||a.width,l=o.height||a.height;if(!h)throw new Error("width is required");if(!l)throw new Error("height is required");if(n.setDimensions(h,l),o.display)n.framebuffer=null,n.renderbuffer=null,n.texture=null;else if(n.useTextureStorage=!o.useBuffersStorage,n.ownGLResources=!0,n.useTextureStorage){var f=n.inkGLContext.generateBuffersExt(n.storageWidth,n.storageHeight,n.gl.LINEAR,n.gl.UNSIGNED_BYTE);n.framebuffer=f.framebuffer,n.texture=f.texture}else{var d=n.inkGLContext.genFrameAndRenders(n.gl.RGBA8||n.gl.RGBA4,n.storageWidth,n.storageHeight);n.framebuffer=d.framebuffer,n.renderbuffer=d.renderbuffer}}return n.releaseRenderbuffer=!1,n.deleted=!1,n}return I(i,[{key:"initWithGLFramebuffer",value:function(t){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");var e,n=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return e=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n),this.initWithGLBuffers(t,e)}},{key:"initWithGLBuffers",value:function(t,e){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(e instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");var n=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,e);var r=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.framebuffer=t,this.renderbuffer=e,{width:r,height:i}}},{key:"setDimensions",value:function(t,e){var n=Math.ceil(t*this.scaleFactor),r=Math.ceil(e*this.scaleFactor),i=Ve.makeWithSize(0,0,t,e),o=Ve.makeWithSize(0,0,n,r);Object.defineProperties(this,{width:{value:t,enumerable:!0,configurable:!0},height:{value:e,enumerable:!0,configurable:!0},graphicsBounds:{value:i,enumerable:!0,configurable:!0},storageWidth:{value:n,enumerable:!0,configurable:!0},storageHeight:{value:r,enumerable:!0,configurable:!0},storageBounds:{value:o,enumerable:!0,configurable:!0}})}},{key:"resize",value:function(t,e){t>0&&e>0&&(this.width!=t||this.height!=e)&&(this.setDimensions(t,e),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}},{key:"delete",value:function(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}},{key:"deleteLater",value:function(){var t=this;setTimeout((function(){return t.delete()}),0)}},{key:"isDeleted",value:function(){return this.deleted}}]),i}(Ni),Vi=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();e(this,t),this.randomSeed=n}return I(t,[{key:"copyTo",value:function(t){t.randomSeed=this.randomSeed}}]),t}();function Hi(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Wi=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Hi()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t,n,o){var a;return e(this,i),(a=r.call(this,t.inkGLContext,n,o)).convexHullChainProducer=new oi,a.polygonSimplifier=new ci,Object.defineProperty(s(a),"inkContext",{value:t,enumerable:!0}),Object.defineProperty(s(a),"bounds",{get:function(){return He.fromGLRect(a.graphicsBounds)},enumerable:!0}),a}return I(i,[{key:"clear",value:function(t,e){if(e){if(A.is(t))throw new Error("`clear` first argument should be Rect")}else A.is(t)?(e=t,t=null):e=A.TRANSPERENT;var n;t instanceof He&&(n=t.toGLRect()),Array.isArray(t)||t instanceof Float32Array?this.fill(t,e,!1):(this.inkContext.setTarget(this,n),this.inkContext.clearColor(e)),n&&this.inkContext.disableTargetClipRect()}},{key:"draw",value:function(t){var e,n=t.brush;return n instanceof Pi?isFinite(t.randomSeed)&&(e=new Vi(t.randomSeed)):e=t.color,this.drawStroke(n,t.path,e)}},{key:"drawStroke",value:function(t,e,n){if(!Si.validatePath(e))return null;this.inkContext.setTarget(this);var r=this.inkContext.drawStroke(t,e,n);return t instanceof Pi?He.fromGLRect(r):He.ofPolygons(e).ceil()}},{key:"fill",value:function(t,e){var n,r,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t instanceof He?(n=[t.toPath().points],r=t):("number"==typeof t[0]&&(t=[t]),n=t,r=He.ofPolygons(n)),r=this.bounds.intersect(r)){var o=n;Array.isArray(t)&&(o=this.convexHullChainProducer.get(o)),o=this.polygonSimplifier.get(o);var a=this.inkContext.triangulate(o);a.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(a,e,i)):r=void 0}return r?r.ceil():void 0}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=xi.SOURCE_OVER),e.rect&&!e.transform&&(e.sourceRect=e.rect,e.destinationRect=e.rect),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,e.clipRect?e.clipRect.toGLRect():void 0),"boolean"==typeof e.flipY&&(t.flipY=e.flipY),e.transform&&e.rect){var n=e.rect.toGLRect().toQuad(),r=e.rect.toGLRect().toQuad(e.transform);this.inkContext.drawLayer(t,n,r,e.mode)}else e.transform?this.inkContext.drawLayerWithTransform(t,e.transform,e.mode):e.sourceRect&&e.destinationRect?this.inkContext.drawLayer(t,e.sourceRect.toGLRect().toQuad(),e.destinationRect.toGLRect().toQuad(),e.mode):this.inkContext.drawLayerWithTransform(t,null,e.mode)}},{key:"createImageData",value:function(t,e,n){return t instanceof Uint8Array&&(t=new Uint8ClampedArray(t.buffer)),new ImageData(t,e,n)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.createImageData(this.readPixels(t,!0),t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.writePixels(t.data,He.create(e,n,t.width,t.height))}},{key:"readPixels",value:function(t,e){t&&(t=t.toGLRect()),this.inkContext.setTarget(this);var n=this.inkContext.readPixels(t);if(e)for(var r=0;r<n.length;r+=4){var i=n[r+3];n[r]=parseInt(255*n[r]/i),n[r+1]=parseInt(255*n[r+1]/i),n[r+2]=parseInt(255*n[r+2]/i)}return n}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e&&(e=e.toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(e,t)}},{key:"getExportCanvas",value:function(t){t=t?t.intersect(this.bounds).ceil():this.bounds;var e=new OffscreenCanvas(t.width,t.height);return e.getContext("2d").putImageData(this.getImageData(t),0,0),e}}]),i}(zi),qi=(ENVIRONMENT,EnvironmentType.NODE,poly2tri),Zi=qi.SweepContext,Ki=qi.Point,Ji=K,Qi=function(){function t(n){if(e(this,t),!n)throw new Error("GL context is not available in current environment");this.gl=n,this.currentProgram=null,this.programs=[],Object.defineProperty(t,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(t,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0})}return I(t,[{key:"init",value:function(t,e){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.bUseStencilBufferForBlending=!1,this.currentBlendMode=xi.COPY,this.resize(t,e),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.genStaticVBOs(),this.onChange();for(var n=0;n<this.programs.length;n++)this.programs[n].init()}},{key:"getSupportedFloatPrecision",value:function(t){return this.gl.getShaderPrecisionFormat(t,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(t,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}},{key:"random",value:function(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}},{key:"setUniforms",value:function(t){var e=Ji.create();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),t?Ji.ortho(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):Ji.ortho(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=e,this.onChange()}},{key:"resize",value:function(t,e){this.textureWidth=parseInt(Math.ceil(t.width)),this.textureHeight=parseInt(Math.ceil(t.height)),this.gl.viewport(t.x,t.y,t.width,t.height),this.bounds=t,this.graphicsBox=e,this._clipRect=this.graphicsBox}},{key:"genStaticVBOs",value:function(){this.fullScreenQuad2dBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.fullScreenQuad2dBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.gl.STATIC_DRAW);for(var t=[],e=0;e<=1024;e++)t.push(e,1,1),t.push(e,-1,1);for(var n=0;n<=1024;n++)t.push(n,1,1),t.push(n,1,0);for(var r=0;r<=1024;r++)t.push(r,-1,1),t.push(r,-1,0);this.strokeSegmentBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.strokeSegmentBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW),t=[-1,1];for(var i=0;i<=1024;i++)t.push(i,1);for(var o=0;o<=1024;o++)t.push(o,1),t.push(o,0);this.circleBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.circleBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW),this.destBuffer=this.gl.createBuffer(),this.srcBuffer=this.gl.createBuffer(),this.vertsBuffer=this.gl.createBuffer(),this.colorsBuffer=this.gl.createBuffer()}},{key:"blendMode",value:function(t){if(t!=this.currentBlendMode){switch(t){case xi.COPY:this.gl.disable(this.gl.BLEND);break;case xi.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case xi.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case xi.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case xi.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case xi.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case xi.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case xi.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case xi.MIN:this.gl.enable(this.gl.BLEND),this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case xi.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case xi.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case xi.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: ".concat(t))}this.currentBlendMode=t}}},{key:"clearColorbuffer",value:function(t){this.gl.clearColor(t.red*t.alpha/255,t.green*t.alpha/255,t.blue*t.alpha/255,t.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"scissors",value:function(t){if(t&&!(t instanceof Ve))throw new TypeError("rect must be undefined or instanceof GLRect");var e=this.gl.isEnabled(this.gl.SCISSOR_TEST);t?(e||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(t.x,t.y,t.width,t.height)):e&&this.gl.disable(this.gl.SCISSOR_TEST)}},{key:"isProgramActive",value:function(t){return this.currentProgram==t}},{key:"activateProgram",value:function(t){this.isProgramActive(t)?t.contextChanged&&(t.onContextChange(),t.contextChanged=!1):(this.currentProgram&&this.currentProgram.onDeactivate(),this.gl.useProgram(t.program),this.currentProgram=t,t.onActivate(),t.onContextChange(),t.contextChanged=!1)}},{key:"generateBuffersExt",value:function(t,e,n,r){var i=this.gl,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);var a=i.createTexture();return i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,n),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,n),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,r,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),{framebuffer:o,texture:a}}},{key:"genFrameAndRenders",value:function(t,e,n){var r=this.gl.createFramebuffer(),i=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,i),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,t,e,n),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,i),{framebuffer:r,renderbuffer:i}}},{key:"deleteBuffers",value:function(t,e){e&&this.gl.deleteTexture(e),t&&this.gl.deleteFramebuffer(t)}},{key:"deleteFrameAndRender",value:function(t,e){e&&this.gl.deleteRenderbuffer(e),t&&this.gl.deleteFramebuffer(t)}},{key:"onChange",value:function(){for(var t=0;t<this.programs.length;t++)this.programs[t].contextChanged=!0}},{key:"isStencilBufferAvailable",value:function(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}},{key:"enableStencilBufferForBlending",value:function(){this.bUseStencilBufferForBlending=!0,this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)}},{key:"disableStencilBufferForBlending",value:function(){this.bUseStencilBufferForBlending=!1}},{key:"shouldUseStencilBufferForBlending",value:function(){return this.bUseStencilBufferForBlending}},{key:"drawArrays",value:function(t,e,n){this.currentBlendMode!=xi.MAX||this.blendMinMaxExt?this.gl.drawArrays(t,e,n):(this.shouldUseStencilBufferForBlending()&&(this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(t,e,n),this.shouldUseStencilBufferForBlending()&&(this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(t,e,n),this.shouldUseStencilBufferForBlending()&&this.gl.disable(this.gl.STENCIL_TEST))}}],[{key:"random",value:function(t){return(1103515245*t+12345&2147483647)/2147483647}}]),t}(),$i=function(){function t(n){e(this,t),Object.defineProperties(this,{inkGLContext:{value:n},gl:{value:n.gl}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}return I(t,[{key:"init",value:function(){}},{key:"compileShader",value:function(t,e){var n=this.inkGLContext.gl,r=n.createShader(e);if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS))throw new Error("could not compile shader:"+n.getShaderInfoLog(r));return r}},{key:"createProgram",value:function(t,e){var n=this.inkGLContext.gl,r=n.createProgram();if(n.attachShader(r,t),n.attachShader(r,e),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw new Error("program filed to link:"+n.getProgramInfoLog(r));return r}},{key:"onActivate",value:function(){}},{key:"onDeactivate",value:function(){}},{key:"onContextChange",value:function(){}},{key:"activate",value:function(){this.inkGLContext.activateProgram(this)}}]),t}();function to(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var eo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(to()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),r.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawVertices",value:function(t,e,n){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),t.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,t.length/2)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Qi.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}]),i}($i);function no(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ro=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(no()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),r.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawTexture",value:function(t,e,n,r,i){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,n,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,r),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,i),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Qi.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tprecision ".concat(Qi.FRAGMENT_SHADER_PRECISION," float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t")}}]),i}($i);function io(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var oo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(io()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),r.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}},{key:"setBrush",value:function(t){this.brush=t,this.brushChanged=!0}},{key:"onActivate",value:function(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.fullScreenQuad2dBuffer),this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_color)}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawSprite",value:function(t){this.activate(),this.brushChanged&&(this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture),this.gl.uniform1i(this.u_fillTexture,1),this.brushChanged=!1);var e=Math.min(1,Math.max(0,t.alpha)),n=t.red/255*e,r=t.green/255*e,i=t.blue/255*e;this.gl.vertexAttrib4f(this.a_color,n,r,i,e),0==t.dX&&0==t.dY&&(t.dX=2*this.inkGLContext.random()-1,t.dY=2*this.inkGLContext.random()-1),this.gl.vertexAttrib2f(this.a_velocity,t.dX,t.dY);var o=this.brush.rotationMode==Pi.RotationMode.TRAJECTORY?1:0,a=this.brush.rotationMode==Pi.RotationMode.RANDOM?2*this.inkGLContext.random()*Math.PI:0,s=(2*this.inkGLContext.random()-1)*this.brush.scattering;this.gl.vertexAttrib3f(this.a_transformParams,o,a,s),this.gl.vertexAttrib1f(this.a_spriteRotation,t.rotation),this.gl.vertexAttrib4f(this.a_spriteScaleAndOffset,t.scaleX,t.scaleY,t.offsetX,t.offsetY),this.gl.vertexAttrib3f(this.a_xys,t.x,t.y,t.size),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Qi.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(t){return"\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ".concat(t?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)",";\n\n\t\t\t}\n\t\t")}}]),i}($i),ao=K,so=function(){function t(n,r){e(this,t);var i=n.getContext("webgl2",r)||n.getContext("webgl",r);this.inkGLContext=new Qi(i),this.gl=this.inkGLContext.gl,this.simpleProgram=new eo(this.inkGLContext),this.textureProgram=new ro(this.inkGLContext),this.spriteProgram=new oo(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new Ve(0,0,0,0),new Ve(0,0,0,0))}return I(t,[{key:"createLayer",value:function(t,e){return new zi(this.inkGLContext,t,e)}},{key:"drawLayerWithTransform",value:function(t,e,n){if(this.currentTarget){var r=t.graphicsBounds.toQuad(),i=t.graphicsBounds.toQuad(e);this.drawLayer(t,r,i,n)}}},{key:"drawLayer",value:function(t,e,n,r){if(this.currentTarget&&t.useTextureStorage){var i=ao.create(),o=ao.create(),a=this.currentTarget;a.flipY?ao.ortho(o,0,a.width,a.height,0,1,-1):ao.ortho(o,0,a.width,0,a.height,1,-1),t.flipY?ao.ortho(i,-t.width,t.width,2*t.height,0,0,1):ao.ortho(i,-t.width,t.width,-t.height,t.height,0,1),this.inkGLContext.blendMode(r),this.textureProgram.drawTexture(t.texture,n,e,o,i)}}},{key:"setTarget",value:function(t,e){var n=this.inkGLContext,r=n.gl;if(t&&!(t instanceof zi))throw new TypeError("layer must be unset or instanceof InkLayer");if(e&&!(e instanceof Ve))throw new TypeError("clipRect must be unset or instanceof GLRect");if(t){this.currentTarget=t;var i=new Ve(0,0,t.storageWidth,t.storageHeight),o=new Ve(0,0,t.width,t.height);n.resize(i,o),n.setUniforms(t.flipY),e?this.setTargetClipRect(e):this.disableTargetClipRect(),r.bindFramebuffer(r.FRAMEBUFFER,t.framebuffer)}}},{key:"clearColor",value:function(t){this.inkGLContext.clearColorbuffer(t)}},{key:"setTargetClipRect",value:function(t){var e=this.inkGLContext;t=t.floor().intersect(this.currentTarget.graphicsBounds),e._clipRect=t;var n=this.currentTarget.scaleFactor;t=this.currentTarget.flipY?Ve.makeWithSize(t.x,this.currentTarget.storageHeight-t.top,t.width,t.height):Ve.makeWithSize(t.x*n,t.y*n,t.width*n,t.height*n),e.scissors(t)}},{key:"disableTargetClipRect",value:function(){var t=this.inkGLContext;t.scissors(null),t._clipRect=t.graphicsBox}},{key:"drawStroke",value:function(t,e,n){return this.currentTarget?0==e.length?null:t instanceof Pi?this.drawGL(t,e,n):this.draw2D(t,e,n):null}},{key:"drawGL",value:function(t,e,n){var r,i=null,o=this.inkGLContext._clipRect;n&&(r=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=n.randomSeed),t.randomizeFill&&(t.fillTextureOffset={x:this.inkGLContext.random(),y:this.inkGLContext.random()}),t.blendMode?this.inkGLContext.blendMode(t.blendMode):this.inkGLContext.blendMode(xi.SOURCE_OVER),this.spriteProgram.setBrush(t);for(var a=0;a<e.length;a++){var s=e.getPoint(a),u=Ve.calculateBrushGLSegmentBounds(s,t.scattering).intersect(o);u&&(this.spriteProgram.drawSprite(s),i=u.union(i))}return n&&(n.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r),i?i.ceil():null}},{key:"draw2D",value:function(t,e,n){var r=this;if(t.spacing>1)e.forEach((function(t){var e=r.triangulate([t]);r.fillStroke(e,n)}));else{var i=this.triangulate(e);this.fillStroke(i,n)}}},{key:"triangulate",value:function(t){var e=[],n=[];t.forEach((function(t){for(var e=[],r=0;r<t.length;r+=2)e.push(new Ki(t[r],t[r+1]));n.push(e)}));var r=new Zi(n.shift());n.forEach((function(t){return r.addHole(t)}));var i=[];try{r.triangulate(),i=r.getTriangles()}catch(t){console.warn(t)}return i.forEach((function(t){t.getPoints().forEach((function(t){e.push(t.x,t.y)}))})),e}},{key:"fillStroke",value:function(t,e){this.fill(t,e,!0,!0)}},{key:"fill",value:function(t,e,n,r){e=A.premultiply(e);for(var i=n?4:1,o=b.GL_ANTI_ALIASING_SIZE,a=i*i,s=1.01/a,u=o/i,c=new Float32Array(t.length*a),h=new Float32Array(2*t.length*a),l=0,f=0,d=0;d<i;d++)for(var p=0;p<i;p++)for(var y=s,v={x:d*u-(o-u)/2,y:p*u-(o-u)/2},m=0;m<t.length;m+=6)for(var g=[{x:t[m],y:t[m+1]},{x:t[m+2],y:t[m+3]},{x:t[m+4],y:t[m+5]}],x=0;x<3;x++)c[l++]=g[x%3].x+v.x,c[l++]=g[x%3].y+v.y,h[f++]=y*e.red,h[f++]=y*e.green,h[f++]=y*e.blue,h[f++]=y*e.alpha;var E=xi.SOURCE_OVER;r?E=xi.MAX:n?E=xi.LIGHTER:A.equals(e,A.TRANSPERENT)&&(E=xi.COPY),this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),this.inkGLContext.blendMode(E),this.simpleProgram.drawVertices(c,h)}},{key:"readPixels",value:function(t){var e=this.currentTarget,n=this.inkGLContext.gl;if(t){if(!(t instanceof Ve))throw new TypeError("box must be instance of GLRect")}else t=e.graphicsBounds;e.flipY&&(t=Ve.makeWithSize(t.x,e.height-t.y-t.height,t.width,t.height)),this.setTarget(e);var r=new Uint8Array(t.width*t.height*4);return n.readPixels(parseInt(t.x*e.scaleFactor),parseInt(t.y*e.scaleFactor),parseInt(t.width*e.scaleFactor),parseInt(t.height*e.scaleFactor),n.RGBA,n.UNSIGNED_BYTE,r),r}},{key:"writePixels",value:function(t,e){if(t&&!(t instanceof Ve))throw new TypeError("rect must be instance of GLRect");var n=this.currentTarget,r=this.inkGLContext.gl;if(t||(t=Ve.makeWithSize(0,0,n.width,n.height)),!n.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");n.flipY&&(t=Ve.makeWithSize(t.x,n.height-t.y-t.height,t.width,t.height));var i=Ve.makeWithSize(t.x*n.scaleFactor,t.y*n.scaleFactor,t.width*n.scaleFactor,t.height*n.scaleFactor);r.finish(),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,n.texture),r.texSubImage2D(r.TEXTURE_2D,0,parseInt(i.x),parseInt(i.y),parseInt(i.width),parseInt(i.height),r.RGBA,r.UNSIGNED_BYTE,e)}}]),t}();function uo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var co=function(t){o(h,t);var n,r,i=(n=h,function(){var t,e=c(n);if(uo()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function h(t){var n;if(e(this,h),n=i.call(this,t,{display:!0,width:t.inkGLContext.gl.canvas.width,height:t.inkGLContext.gl.canvas.height,flipY:ENVIRONMENT==EnvironmentType.WEB||ENVIRONMENT==EnvironmentType.WORKER}),Object.defineProperty(s(n),"surface",{value:t.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(s(n),"ctx",{value:t.inkGLContext.gl,enumerable:!0}),"function"==typeof requestAnimationFrame&&!t.attributes.preserveDrawingBuffer&&!b.ownBackbuffer){var r=n.createLayer();Object.defineProperty(s(n),"backbuffer",{value:r,enumerable:!0});n.frameID=requestAnimationFrame((function t(e){n.present&&(delete n.present,jr(c(h.prototype),"blend",s(n)).call(s(n),r,{mode:xi.COPY})),n.frameID=requestAnimationFrame(t)}))}return n}return I(h,[{key:"test",value:function(){var t=this;this.testBuffer||(this.testCnt=0,this.testBuffer=this.ctx.createBuffer()),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.testBuffer);var e=Date.now();this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([0,0,0,0,0,0,0,0]),this.ctx.DYNAMIC_DRAW),(e=Date.now()-e)>5&&this.testCnt<100?setTimeout((function(){t.testCnt++,t.test()}),100):(this.ctx.deleteBuffer(this.testBuffer),delete this.testBuffer,delete this.testCnt)}},{key:"createLayer",value:function(t){return new Wi(this.inkContext,t,{width:b.DEFAULT_LAYER_SIZE.width,height:b.DEFAULT_LAYER_SIZE.height,scaleFactor:b.DEFAULT_SCALE_FACTOR})}},{key:"clear",value:function(t,e){this.backbuffer?(this.backbuffer.clear(t,e),this.present=!0):jr(c(h.prototype),"clear",this).call(this,t,e)}},{key:"draw",value:function(t,e){var n;return this.backbuffer?(n=this.backbuffer.draw(t,e),this.present=!0):n=jr(c(h.prototype),"draw",this).call(this,t,e),n}},{key:"drawStroke",value:function(t,e,n){var r;return this.backbuffer?(r=this.backbuffer.drawStroke(t,e,n),this.present=!0):r=jr(c(h.prototype),"drawStroke",this).call(this,t,e,n),r}},{key:"fill",value:function(t,e,n){var r;return this.backbuffer?(r=this.backbuffer.fill(t,e,n),this.present=!0):r=jr(c(h.prototype),"fill",this).call(this,t,e,n),r}},{key:"blend",value:function(t,e){this.backbuffer?(this.backbuffer.blend(t,e),this.present=!0):jr(c(h.prototype),"blend",this).call(this,t,e)}},{key:"readPixels",value:function(t,e){return this.backbuffer?this.backbuffer.readPixels(t,e):jr(c(h.prototype),"readPixels",this).call(this,t,e)}},{key:"writePixels",value:function(t,e){this.backbuffer?(this.backbuffer.writePixels(t,e),this.present=!0):jr(c(h.prototype),"writePixels",this).call(this,t,e)}},{key:"toBlob",value:(r=on(nn.mark((function t(){var e,n,r,i=arguments;return nn.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=i.length>0&&void 0!==i[0]?i[0]:this.bounds,n=i.length>1?i[1]:void 0,r=i.length>2?i[2]:void 0,!this.backbuffer){t.next=9;break}return t.next=6,this.backbuffer.toBlob(e,n,r);case 6:return t.abrupt("return",t.sent);case 9:return t.next=11,jr(c(h.prototype),"toBlob",this).call(this,e,n,r);case 11:return t.abrupt("return",t.sent);case 12:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"resize",value:function(t,e){jr(c(h.prototype),"resize",this).call(this,t,e),this.surface.width=t,this.surface.height=e}},{key:"delete",value:function(){ENVIRONMENT==EnvironmentType.WEB&&cancelAnimationFrame(this.frameID),jr(c(h.prototype),"delete",this).call(this),this.backbuffer&&this.backbuffer.delete()}},{key:"deleteLater",value:function(){return jr(c(h.prototype),"deleteLater",this).call(this),this.backbuffer&&this.backbuffer.deleteLater(),this}}],[{key:"createInstance",value:function(t,e,n,r){if(!t||"function"!=typeof t.getContext)throw new Error("WebGL context provider is required");if(!(e>0&&n>0))throw new Error("width and height are required and should be positive whole numbers");if("object"==("undefined"==typeof screen?"undefined":a(screen))){var i=Math.max(screen.width,screen.height);t.width=i,t.height=i}t.width=e,t.height=n,b.DEFAULT_LAYER_SIZE||("object"==("undefined"==typeof screen?"undefined":a(screen))?b.setDefaultLayerSize(Math.max(screen.width,screen.height)):b.setDefaultLayerSize(e,n)),b.DEFAULT_SCALE_FACTOR||b.setDefaultScaleFactor(1);var o=new so(t,r);return o.attributes=r||{},new h(o)}}]),h}(Wi),ho=function(){function t(n,r){var i=this;e(this,t),this.canvas=n;var o=r instanceof Wi?r:void 0,a=r&&!o?r:new Object;this.layer=o||n.createLayer(a),this.layerOptions=a,this.ownLayer=!o,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=A.TRANSPERENT,this.blendMode=xi.SOURCE_OVER,this.randomSeed=void 0,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:i.brush,color:i.color,backgroundColor:i.backgroundColor,blendMode:i.blendMode,randomSeed:i.initialRandomSeed}},enumerable:!0})}return I(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),this.brush instanceof Pi&&isFinite(t.randomSeed)&&(this.initialRandomSeed=t.randomSeed),this.restart=!0}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),t instanceof Si){var n=t,r=xi.SOURCE_OVER;if(n.renderMode&&!(r=Si.RenderMode.getBlendMode(n.renderMode)))return void console.warn("Cannot process ".concat(n.renderMode," render mode. Requres custom processing."));this.blendMode=r;var i=this.layer.draw(n);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(this.validate(t)){var o=this.brush instanceof Pi?this.strokeLastRendererdDrawContext:this.color,a=this.layer.drawStroke(this.brush,t,o);a&&(this.incompleteStrokeBounds=a.union(this.incompleteStrokeBounds),this.strokeBounds=a.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null,n=null;this.brush instanceof Pi?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),e=this.strokePrelimLastRenderedDrawContext):e=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.clear()),n=this.preliminaryLayer):n=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:xi.COPY,rect:this.updatedArea}),this.preliminaryDirtyArea=n.drawStroke(this.brush,t,e),this.updatedArea=He.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof Pi?(this.strokeLastRendererdDrawContext=new Vi(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new Vi),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}},{key:"validate",value:function(t){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return!!t}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,n=t||this.canvas,r=n.bounds.intersect(this.updatedArea);r&&(r=r.ceil(),"function"==typeof this.streamUpdatedArea?this.stream(e,r,!1):n.blend(e,{mode:this.blendMode,rect:r})),this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,n){if(this.strokeBounds){n||(n=this.blendMode);var r=this.layer,i=t||this.canvas;(e=i.bounds.intersect(e||this.strokeBounds))&&(e=e.ceil(),"function"==typeof this.streamUpdatedArea?this.stream(r,e,!0):i.blend(r,{mode:n,rect:e}))}}},{key:"stream",value:function(t,e,n){var r=new OffscreenCanvas(e.width,e.height).getContext("2d"),i=t.readPixels(e,!0),o=r.createImageData(e.width,e.height);o.data.set(i),this.streamUpdatedArea(o,e,n)}},{key:"toStroke",value:function(t){var e=t.getSensorData(),n=t.getSpline(),r=t.getInkPath();n.randomSeed=this.randomSeed;var i=new Si(this.brush,n,r,e);return e&&(i.sensorDataMapping=e.inkStream.getPipelineMapping()),this.blendMode!=xi.SOURCE_OVER&&(i.renderMode=Si.RenderMode.get(this.blendMode)),i}},{key:"delete",value:function(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}]),t}(),lo=function t(n,r,i){e(this,t),this.subject=n,this.predicate=r,this.object=i},fo=function(){function t(){e(this,t),this.statements=[]}return I(t,[{key:"add",value:function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];n.forEach((function(e){return t.statements.push(e)}))}},{key:"remove",value:function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];n.forEach((function(e){return t.statements.remove(e)}))}},{key:"addTriple",value:function(t,e,n){this.statements.push(new lo(t,e,n))}},{key:"search",value:function(t){return this.statements.filter((function(e){var n=!0;return Object.keys(t).forEach((function(r){n=n&&e[r]==t[r]})),n}))}}]),t}(),po=(ENVIRONMENT,EnvironmentType.NODE,protobuf),yo={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};function vo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var mo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(vo()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),r.call(this,t)}return i}(or);function go(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var bo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(go()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n,o;return e(this,i),n=r.call(this,t),Object.defineProperty(s(n),"bounds",{get:function(){return o||(o=this.getBounds()),o},set:function(t){o=t},enumerable:!0}),Object.defineProperty(s(n),"root",{get:function(){for(var t=this.parent,e=this;t;)e=t,t=t.parent;return e},enumerable:!0}),n}return I(i,[{key:"updateID",value:function(t,e){var n=this.root.model;n&&n.updateRegistry(t,e)}},{key:"getBounds",value:function(){return this.content.bounds}},{key:"invalidateBounds",value:function(){this.bounds=void 0}},{key:"remove",value:function(){this.parent.removeChild(this)}}]),i}(mo);function xo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Eo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(xo()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),(n=r.call(this,t)).children=[],Object.defineProperty(s(n),"content",{value:n.children,enumerable:!0}),n}return I(i,[{key:"getBounds",value:function(){var t;return this.children.forEach((function(e){t=t?t.union(e.bounds):e.bounds})),t}},{key:"appendChild",value:function(t,e){if(!(t instanceof bo))throw new Error("Incompatible node found - ".concat(t.constructor.name,". It should be ink model Element."));if(e<0)throw new Error("Index should be a positive number");var n=t.parent;if(n&&t.parent.children.remove(t),t.parent=this,"number"==typeof e&&e<this.children.length?this.children.insert(e,t):this.children.push(t),!n){var r=this.root.model;r&&r.register(t)}return this.invalidateBounds(),t}},{key:"removeChild",value:function(t){if(!this.children.includes(t))throw new Error("Node was not found");var e=this.root.model;e&&e.unregister(t),this.invalidateBounds(),this.children.remove(t)}},{key:"remove",value:function(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}]),i}(bo);function wo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ro=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(wo()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var n;return e(this,i),n=r.call(this),Object.defineProperty(s(n),"content",{value:t,enumerable:!0}),n}return i}(bo),Po=function(){function t(n,r,i){e(this,t),this.model=n,this.type=r||n.type,this.tree=this.createGroup(i),this.tree.model=this,this.register(this.tree)}return I(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"createElement",value:function(t,e,n){var r=this.model.createElement(t,this);return r.fromPointIndex=e,r.toPointIndex=n,r}},{key:"createGroup",value:function(t){return this.model.createGroup(t,this)}},{key:"register",value:function(e){var n=this;if(e instanceof Eo)e.children.forEach((function(t){return n.register(t)}));else if(e instanceof Ro){if(e.content instanceof Si){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof br))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - ".concat(e.content.id))}this.model.index(e),this.updateKnowledgeGraph(e.id)}},{key:"unregister",value:function(t){var e=this;t instanceof Eo&&t.children.forEach((function(t){return e.unregister(t)})),delete this.model.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t){if(t){var e=this.model.uriBuilder.buildNodeURI(t);if(this.model.registry[t]){var n,r;if(!this.knowledgeGraph)return;(n=this.model.knowledgeGraph).add.apply(n,k(this.knowledgeGraph.search({subject:e}))),(r=this.model.knowledgeGraph).add.apply(r,k(this.knowledgeGraph.search({object:e})))}else{var i,o;(i=this.model.knowledgeGraph).remove.apply(i,k(this.model.knowledgeGraph.search({subject:e}))),(o=this.model.knowledgeGraph).remove.apply(o,k(this.model.knowledgeGraph.search({object:e})))}}}}]),t}(),ko=function(){function t(){e(this,t)}return I(t,[{key:"setInkModelURI",value:function(t){return this.inkModelURI=t,this}},{key:"setNodeID",value:function(t){return this.inkNodeID=t,this}},{key:"buildNodeURI",value:function(t,e){return this.reset().setInkModelURI(e).setNodeID(t).build()}},{key:"build",value:function(){var t="",e="";return this.inkModelURI&&(t=this.fixedEncodeURIComponent(this.inkModelURI),e="/"),e+="node/"+this.inkNodeID,"".concat("uim:").concat(t).concat(e)}},{key:"fixedEncodeURIComponent",value:function(t){return encodeURIComponent(t).replace(/[!'()*]/g,(function(t){return"%"+t.charCodeAt(0).toString(16)}))}},{key:"reset",value:function(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}]),t}(),Mo=function(){function t(){var n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Type.STROKE,i=arguments.length>1?arguments[1]:void 0;e(this,t),this.type=r,this.tree=this.createGroup(i),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new fo,this.uriBuilder=new ko,this.registry={},this.registry[this.tree.id]=this.tree,Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:function(){return n.type==t.Type.STROKE?n.content:[]},enumerable:!0}),Object.defineProperty(this,"sensorData",{get:function(){return n.type==t.Type.STROKE?n.content.map((function(t){return t.sensorData})).filter((function(t){return!!t})):n.content},enumerable:!0}),Object.defineProperty(this,"brushes",{get:function(){var t={};return n.strokes.forEach((function(e){return t[e.brush.name]=n.registry[e.brush.name]||e.brush})),Object.values(t)},set:function(t){t.forEach((function(t){return n.registry[t.name]=t}))},enumerable:!0})}return I(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"removePath",value:function(t){t.nodeID&&this.registry[t.nodeID].remove()}},{key:"replacePath",value:function(t,e,n){var r=this;if(t.nodeID){var i=this.getItem(t.nodeID),o=i.parent||this.tree,a=e.map((function(t){return r.createElement(t)})),s=o.children.indexOf(i);if(n){var u=o.appendChild(this.createGroup(),s);a.forEach((function(t){return u.appendChild(t)}))}else a.forEach((function(t,e){return o.appendChild(t,s+e)}));this.removePath(t)}}},{key:"createElement",value:function(e,n){if(!e)throw new Error("Element content not found");var r=n?n.type:this.type;switch(r){case t.Type.STROKE:if(!(e instanceof Si))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of Stroke."));break;case t.Type.SENSOR_DATA:if(!(e instanceof br))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of SensorData."));break;default:throw console.warn(r),new Error("Invalid ink model type found")}return new Ro(e)}},{key:"createGroup",value:function(t,e){return new Eo(t)}},{key:"getItem",value:function(t){return this.registry[t]}},{key:"register",value:function(e){var n=this;if(e instanceof Eo)e.children.forEach((function(t){return n.register(t)}));else if(e instanceof Ro){if(e.content instanceof Si){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof br))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),this.content.push(e.content),this.index(e.content)}this.index(e),e instanceof mo&&!this.keepViews&&this.resetViews()}},{key:"updateRegistry",value:function(t,e){var n=this.registry[t];delete this.registry[t],this.registry[n.id]=n,this.updateKnowledgeGraph(t,e)}},{key:"unregister",value:function(t){var e=this;t instanceof mo&&this.resetViews(),t instanceof Eo?t.children.forEach((function(t){return e.unregister(t)})):t instanceof Ro&&(delete t.content.nodeID,delete this.registry[t.content.id],this.content.remove(t.content)),t==this.tree?t.children.clear():delete this.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t,e){var n,r,i=this.uriBuilder.buildNodeURI(t),o=this.uriBuilder.buildNodeURI(e);o?(this.knowledgeGraph.search({subject:i}).forEach((function(t){return t.subject=o})),this.knowledgeGraph.search({object:i}).forEach((function(t){return t.object=o}))):((n=this.knowledgeGraph).remove.apply(n,k(this.knowledgeGraph.search({subject:i}))),(r=this.knowledgeGraph).remove.apply(r,k(this.knowledgeGraph.search({object:i}))))}},{key:"index",value:function(t){if(this.registry[t.id])throw new Error("Cannot register item with id ".concat(t.id,". Already is available item with such identifier."));this.registry[t.id]=t}},{key:"createView",value:function(t,e,n,r){var i=new Po(this,e,n);return i.name=t,this.views[t]=i,r&&(i.knowledgeGraph=r,i.updateKnowledgeGraph(n)),i}},{key:"resetViews",value:function(){for(var t in this.views)this.views[t].tree.remove(),delete this.views[t]}}]),t}();Mo.createEnum("Type",["STROKE","SENSOR_DATA"]),Po.Type=Mo.Type;var To={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}},Io=function(){function t(){e(this,t),this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}return I(t,[{key:"encodeInk",value:function(t){t&&this.encode(To.headers.inkChunkFourCC,t)}},{key:"encode",value:function(t,e){var n=t instanceof Uint8Array?t:t.toCharArray().toUint8Array();if(n.length!=To.fourCCLength)throw new Error('Invalid fourCC: "'.concat(t,'"'));if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(n,e))}},{key:"build",value:function(){var t=this,e=To.headers,n=0;this.chunks.unshift(this.createChunk(To.headers.headChunkFourCC,To.version)),this.chunks.forEach((function(t){n+=t.length}));var r=e.formatFourCC.length+n,i=e.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+r,o=new ArrayBuffer(i);this.fileBytes=new Uint8Array(o),this.dataView=new DataView(o),this.byteOffset=0,this.fileBytes.set(e.riffFourCC,this.byteOffset),this.byteOffset+=e.riffFourCC.length,this.dataView.setUint32(this.byteOffset,r,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.formatFourCC,this.byteOffset),this.byteOffset+=e.formatFourCC.length,this.chunks.forEach((function(e){t.appendChunk(e),t.byteOffset+=e.length}))}},{key:"createChunk",value:function(t,e){var n=e.length,r=n%2;return{fourCC:t,bytes:e,size:n,length:t.length+Uint32Array.BYTES_PER_ELEMENT+n+r}}},{key:"appendChunk",value:function(t){this.fileBytes.set(t.fourCC,this.byteOffset);var e=this.byteOffset+t.fourCC.length;this.dataView.setUint32(e,t.size,!0),e+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(t.bytes,e)}},{key:"reset",value:function(){this.chunks=[],this.fileBytes=null}}]),t}(),So=function(){function t(){e(this,t)}return I(t,[{key:"decode",value:function(t){var e=To.headers;this.reset(t);var n=this.byteOffset+e.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,n),e.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=n,n=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;var r=this.dataView.getUint32(this.byteOffset,!0)+n;if(r%2!=0)throw new Error("Invalid RIFF file size");if(r!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=n,n=this.byteOffset+e.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,n),e.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=n;this.byteOffset<r;){var i=this.extractChunk();this.byteOffset+=i.length,Object.equals(i.fourCC,e.headChunkFourCC)?this.version=[i.bytes[0],i.bytes[1],i.bytes[2]]:Object.equals(i.fourCC,e.inkChunkFourCC)?this.ink=i.bytes:this.chunks.push({fourCC:String.fromCharArray(i.fourCC),bytes:i.bytes})}}},{key:"extractChunk",value:function(){var t,e,n=this.fileBytes.subarray(this.byteOffset,this.byteOffset+To.fourCCLength),r=null,i=this.byteOffset+n.length,o=i;return i=o+Uint32Array.BYTES_PER_ELEMENT,t=this.dataView.getUint32(o,!0),i=(o=i)+t,t>0?(r=this.fileBytes.subarray(o,i),r=new Uint8Array(r,r.byteOffset,r.length)):r=new Uint8Array(0),{fourCC:n,bytes:r,size:t,length:(e=n.length+Uint32Array.BYTES_PER_ELEMENT+t)+e%2}}},{key:"reset",value:function(t){this.fileBytes=t,this.dataView=new DataView(t.buffer),this.byteOffset=0,this.chunks=[]}}]),t}();function Ao(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Co(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Co(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function Co(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Oo=K,Do=function(){function t(){e(this,t),t.format||(t.format=po.Root.fromJSON(yo).WacomInkFormat3),this.riffEncoder=new Io,this.riffDecoder=new So}var n,r,i,o;return I(t,[{key:"encodeInkModel",value:(o=on(nn.mark((function e(n){var r,i,o=this;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.structure=!0,e.t0=t.format.InkObject,e.t1=this.encodeInkInput(n.sensorData),e.t2=this.encodeInkData(n.strokes),e.next=6,this.encodeBrushes(n.brushes);case 6:return e.t3=e.sent,e.t4=this.encodeNodeTree(n),e.t5=Object.values(n.views).map((function(t){return o.encodeView(t)})),e.t6=this.encodeKnowledgeGraph(n.knowledgeGraph),e.t7=this.encodeMat4(n.transform),e.t8=this.encodeProperties(n.props),e.t9={inputData:e.t1,inkData:e.t2,brushes:e.t3,inkTree:e.t4,views:e.t5,knowledgeGraph:e.t6,transform:e.t7,properties:e.t8},r=e.t0.create.call(e.t0,e.t9),this.structure=!1,i=t.encode(r),this.riffEncoder.reset(),this.riffEncoder.encodeInk(i),e.abrupt("return",this.riffEncoder.data);case 19:case"end":return e.stop()}}),e,this)}))),function(t){return o.apply(this,arguments)})},{key:"decodeInkModel",value:function(e,n){var r=this;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.riffDecoder.decode(e);var i=t.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=!0,n){var o=this.decodeKnowledgeGraph(i.knowledgeGraph);i.views.forEach((function(t){return r.decodeView(t,n,o)}))}else{var a=this.decodeInkInput(i.inputData),s=this.decodeBrushes(i.brushes),u=this.decodeInkData(i.inkData,s,a),c=i.inkTree.first,h=c.type==t.format.NodeType.STROKE_GROUP?Mo.Type.STROKE:Mo.Type.SENSOR_DATA,l=c.type==t.format.NodeType.STROKE_GROUP?u:Object.values(a);n=new Mo(h,c.id),this.decodeNodeTree(n,i.inkTree.slice(1),l),i.views.forEach((function(t){return r.decodeView(t,n)})),n.knowledgeGraph=this.decodeKnowledgeGraph(i.knowledgeGraph),n.props=this.decodeProperties(i.properties),n.transform=this.decodeMat4(i.transform),n.brushes=Object.values(s)}return this.structure=!1,n}},{key:"encodeInkInput",value:function(e){var n=this,r={},i={},o={},a={},s={};e.forEach((function(t){var e=t.context;r[e.id]||(r[e.id]=e,s[e.environment.id]||(s[e.environment.id]=e.environment),i[e.sensorContext.id]||(i[e.sensorContext.id]=e.sensorContext,e.sensorContext.channelsContexts.forEach((function(t){o[t.device.id]||(o[t.device.id]=t.device),t.inkProvider&&(a[t.inkProvider.id]||(a[t.inkProvider.id]=t.inkProvider))}))))}));var u=t.format.InputData.create({sensorData:e.map((function(t){return n.encodeSensorData(t)})),inputContextData:t.format.InputContextData.create({inputContexts:Object.values(r).map((function(e){return t.format.InputContext.create({id:e.id,environmentID:e.environment.id,sensorContextID:e.sensorContext.id})})),sensorContexts:Object.values(i).map((function(e){return t.format.SensorContext.create({id:e.id,sensorChannelsContext:e.channelsContexts.map((function(e){return t.format.SensorChannelsContext.create({id:e.id,channels:e.channels.map((function(e){return t.format.SensorChannel.create({id:e.id,type:e.type,metric:t.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})})),samplingRateHint:isFinite(e.samplingRate)?t.format.Uint32.create({value:e.samplingRate}):void 0,latency:isFinite(e.latency)?t.format.Uint32.create({value:e.latency}):void 0,inkInputProviderID:e.inkProvider?e.inkProvider.id:null,inputDeviceID:e.device.id})}))})})),inkInputProviders:Object.values(a).map((function(e){return t.format.InkInputProvider.create({id:e.id,type:t.format.InkInputProviderType[e.type.name],properties:n.encodeProperties(e.props)})})),inputDevices:Object.values(o).map((function(e){return t.format.InputDevice.create({id:e.id,properties:n.encodeProperties(e.props)})})),environments:Object.values(s).map((function(e){return t.format.Environment.create({id:e.id,properties:n.encodeProperties(e.props)})}))})});return this.structure?u:t.encode(u)}},{key:"decodeInkInput",value:function(e){var n=this;if(e){var r=this.structure?e:t.format.InputData.decode(e),i={},o={},a={},s={},u={};if(r.inputContextData.environments.forEach((function(t){var e=new sr;n.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("Environment decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),u[e.id]=e})),r.inputContextData.inkInputProviders.forEach((function(e){var r=n.decodeProperties(e.properties),i=new cr(cr.Type[t.format.InkInputProviderType[e.type]],r);Object.freeze(i),i.id!=e.id&&console.warn("InkInputProvider decode id missmatch - found ".concat(e.id,", expected ").concat(i.id)),s[i.id]=i})),r.inputContextData.inputDevices.forEach((function(t){var e=new wr;n.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("InputDevice decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),a[e.id]=e})),r.inputContextData.sensorContexts.forEach((function(e){var n=new yr;e.sensorChannelsContext.forEach((function(e){var r=new dr(a[e.inputDeviceID],s[e.inkInputProviderID]);e.samplingRateHint&&(r.samplingRate=e.samplingRateHint.value),e.latency&&(r.latency=e.latency.value),e.channels.forEach((function(e){var n=lr.Metric[t.format.InkSensorMetricType[e.metric]],i=new lr(e.type,n,e.resolution,e.min,e.max);i.precision=e.precision,r.add(i),i.id!=e.id&&console.warn("SensorChannel decode id missmatch - found ".concat(e.id,", expected ").concat(i.id))})),n.addContext(r),r.id!=e.id&&console.warn("SensorChannelsContext decode id missmatch - found ".concat(e.id,", expected ").concat(r.id))})),Object.freeze(n),o[n.id]=n,n.id!=e.id&&console.warn("SensorContext decode id missmatch - found ".concat(e.id,", expected ").concat(n.id))})),r.inputContextData.inputContexts.forEach((function(t){var e=new mr(u[t.environmentID],o[t.sensorContextID]);Object.freeze(e),e.id!=t.id&&console.warn("InputContext decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),i[e.id]=e})),this.structure){var c={};return r.sensorData.forEach((function(t){return c[t.id]=n.decodeSensorData(t,i[t.inputContextID])})),c}return r.sensorData.map((function(t){return n.decodeSensorData(t,i[t.inputContextID])}))}}},{key:"encodeSensorData",value:function(e){var n=t.format.SensorData.create({id:e.id,inputContextID:e.context.id,state:t.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach((function(e){var r={};e.channels.forEach((function(t){return r[t.id]=[]}));for(var i=function(t){var n=e.get(t);e.channels.forEach((function(t){r[t.id].push(n[On.getPropName(t.name)])}))},o=0;o<e.length;o++)i(o);e.channels.forEach((function(e){if(!("precision"in e))throw new Error("Precision not found for channel with id: ".concat(e.id));var i=t.format.ChannelData.create({sensorChannelID:e.id}),o=r[e.id],a=Math.pow(10,e.precision),s=Math.round(o[0]*a);i.values.push(s);for(var u=1;u<o.length;u++){var c=Math.round(o[u]*a);i.values.push(c-s),s=c}n.dataChannels.push(i)}))})),n}},{key:"decodeSensorData",value:function(e,n){var r=new br(n);r.id=e.id,r.created=e.created,r.inkState=br.InkState[t.format.InkState[e.state]];var i={};return e.dataChannels.forEach((function(t){var e=n.sensorContext.getContextByChannelID(t.sensorChannelID);if(!e)throw new Error("Not found corresponding channel context for data with channelID ".concat(t.sensorChannelID));var r=e.get(t.sensorChannelID),o=Math.pow(10,r.precision),a=t.values[0],s=[];s.push(a/o);for(var u=1;u<t.values.length;u++){var c=a+t.values[u];s.push(c/o),a=c}i[t.sensorChannelID]=s})),n.sensorContext.channelsContexts.forEach((function(t){for(var e=i[t.channels.first.id].length,n=new xr(t.channels),o=function(e){t.channels.forEach((function(t){var r=i[t.id];n.data.push(r[e])}))},a=0;a<e;a++)o(a);r.add(n)})),r}},{key:"encodeInkData",value:function(e){var n=this,r=t.format.InkData.create({strokes:e.map((function(t){return n.encodeStroke(t)}))});return this.structure?r:t.encode(r)}},{key:"decodeInkData",value:function(e,n,r){var i=this;if(e)return(this.structure?e:t.format.InkData.decode(e)).strokes.map((function(t){return i.decodeStroke(t,n,r)}))}},{key:"encodeStroke",value:function(e){for(var n=t.format.Stroke.create({id:e.id,startParameter:e.ts,endParameter:e.tf}),r=function(t){var r=e.pointAt(t);e.layout.forEach((function(t){switch(t){case Ye.Property.X:n.splineX.push(r.x);break;case Ye.Property.Y:n.splineY.push(r.y);break;case Ye.Property.Z:n.splineZ.push(r.z);break;case Ye.Property.RED:n.red.push(r.red/255);break;case Ye.Property.GREEN:n.green.push(r.green/255);break;case Ye.Property.BLUE:n.blue.push(r.blue/255);break;case Ye.Property.ALPHA:n.alpha.push(r.alpha);break;case Ye.Property.SIZE:n.size.push(r.size);break;case Ye.Property.ROTATION:n.rotation.push(r.rotation);break;case Ye.Property.SCALE_X:n.scaleX.push(r.scaleX);break;case Ye.Property.SCALE_Y:n.scaleY.push(r.scaleY);break;case Ye.Property.SCALE_Z:n.scaleZ.push(r.scaleZ);break;case Ye.Property.OFFSET_X:n.offsetX.push(r.offsetX);break;case Ye.Property.OFFSET_Y:n.offsetY.push(r.offsetY);break;case Ye.Property.OFFSET_Z:n.offsetZ.push(r.offsetZ);break;default:throw new Error("Invalid layout property provided: ".concat(t))}}))},i=0;i<e.length;i++)r(i);return e.sensorData&&(n.sensorDataID=e.sensorData.id,n.sensorDataOffset=e.sensorDataOffset,n.sensorDataMapping=e.sensorDataMapping),n.style=t.format.Style.create({brushURI:e.brush.name,renderModeURI:e.renderMode,particlesRandomSeed:e.randomSeed,properties:this.encodePathPointProperties(e.pointProps)}),n}},{key:"decodeStroke",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0==t.splineX.length||0==t.splineY.length)throw new Error("Incomplete path definition");var r=[Ye.Property.X,Ye.Property.Y];t.splineZ.length>0&&r.push(Ye.Property.Z),t.red&&t.red.length>0&&r.push(Ye.Property.RED),t.green&&t.green.length>0&&r.push(Ye.Property.GREEN),t.blue&&t.blue.length>0&&r.push(Ye.Property.BLUE),t.alpha&&t.alpha.length>0&&r.push(Ye.Property.ALPHA),t.size.length>0&&r.push(Ye.Property.SIZE),t.rotation.length>0&&r.push(Ye.Property.ROTATION),t.scaleX.length>0&&r.push(Ye.Property.SCALE_X),t.scaleY.length>0&&r.push(Ye.Property.SCALE_Y),t.scaleZ.length>0&&r.push(Ye.Property.SCALE_Z),t.offsetX.length>0&&r.push(Ye.Property.OFFSET_X),t.offsetY.length>0&&r.push(Ye.Property.OFFSET_Y),t.offsetZ.length>0&&r.push(Ye.Property.OFFSET_Z);for(var i=t.splineX.length,o=r.length,a=new Float32Array(i*o),s=function(e){r.forEach((function(n,r){var i;switch(n){case Ye.Property.X:i=t.splineX[e];break;case Ye.Property.Y:i=t.splineY[e];break;case Ye.Property.Z:i=t.splineZ[e];break;case Ye.Property.RED:i=Math.round(255*t.red[e]);break;case Ye.Property.GREEN:i=Math.round(255*t.green[e]);break;case Ye.Property.BLUE:i=Math.round(255*t.blue[e]);break;case Ye.Property.ALPHA:i=t.alpha[e];break;case Ye.Property.SIZE:i=t.size[e];break;case Ye.Property.ROTATION:i=t.rotation[e];break;case Ye.Property.SCALE_X:i=t.scaleX[e];break;case Ye.Property.SCALE_Y:i=t.scaleY[e];break;case Ye.Property.SCALE_Z:i=t.scaleZ[e];break;case Ye.Property.OFFSET_X:i=t.offsetX[e];break;case Ye.Property.OFFSET_Y:i=t.offsetY[e];break;case Ye.Property.OFFSET_Z:i=t.offsetZ[e];break;default:throw new Error("Invalid layout property provided: ".concat(n.name))}a[e*o+r]=i}))},u=0;u<i;u++)s(u);var c=e[t.style.brushURI]||t.style.brushURI,h=this.decodePathPointProperties(t.style.properties),l=n[t.sensorDataID],f=new Nr(r,a,h,t.startParameter,t.endParameter);f.randomSeed=t.style.particlesRandomSeed;var d=new Si(c,f,void 0,l);return d.id=t.id,d.renderMode=t.style.renderModeURI,d.sensorDataOffset=t.sensorDataOffset,d.sensorDataMapping=t.sensorDataMapping,d}},{key:"encodeBrushes",value:(i=on(nn.mark((function e(n){var r,i,o,a,s,u;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.format.Brushes.create(),i=Ao(n),e.prev=2,i.s();case 4:if((o=i.n()).done){e.next=17;break}if(!((a=o.value)instanceof Ar)){e.next=11;break}s=this.encodeBrush2D(a),r.vectorBrushes.push(s),e.next=15;break;case 11:return e.next=13,this.encodeBrushGL(a);case 13:u=e.sent,r.rasterBrushes.push(u);case 15:e.next=4;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),i.e(e.t0);case 22:return e.prev=22,i.f(),e.finish(22);case 25:return e.abrupt("return",this.structure?r:t.encode(r));case 26:case"end":return e.stop()}}),e,this,[[2,19,22,25]])}))),function(t){return i.apply(this,arguments)})},{key:"decodeBrushes",value:function(e){var n=this;if(e){var r=this.structure?e:t.format.Brushes.decode(e),i={};return r.vectorBrushes.forEach((function(t){return i[t.name]=n.decodeBrush2D(t)})),r.rasterBrushes.forEach((function(t){return i[t.name]=n.decodeBrushGL(t)})),this.structure?i:Object.values(i)}}},{key:"encodeBrush2D",value:function(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");var n=t.format.VectorBrush.create({name:e.name,spacing:e.spacing});return(Array.isArray(e.shape)?e.shape:[e.shape]).forEach((function(e){var r=t.format.BrushPrototype.create({size:e.size});if(e.descriptor.shape.name)r.shapeURI=e.descriptor.shape.name;else for(var i=0;i<e.shape.length;i+=2)r.coordX.push(e.shape[i]),r.coordY.push(e.shape[i+1]);n.prototype.push(r)})),n}},{key:"decodeBrush2D",value:function(t){var e=[];return t.prototype.forEach((function(t){var n;if(t.shapeURI)n=t.shapeURI;else{n=new Float32Array(2*t.coordX.length);for(var r=0;r<n.length/2;r++)n[2*r]=t.coordX[r],n[2*r+1]=t.coordY[r]}e.push(new Tr(n,t.size))})),new Ar(t.name,e,t.spacing)}},{key:"encodeBrushGL",value:(r=on(nn.mark((function e(n){var r,i,o,a;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.name){e.next=2;break}throw new Error("Encode BrushGL failed. name property is required.");case 2:if(r={shape:[],shapeURI:[],fill:void 0,filleURI:void 0},!Array.isArray(n.shape)){e.next=11;break}if(!((i=n.descriptor.shape.map((function(t){return t.name})).filter((function(t){return t}))).length>0)){e.next=9;break}if(i.length==n.shape.length){e.next=8;break}throw new Error("Brush ".concat(n.name," shape names length do not match with brush mipmap"));case 8:r.shapeURI=i;case 9:e.next=12;break;case 11:n.descriptor.shape.name&&r.shapeURI.push(n.descriptor.shape.name);case 12:if(r.fillURI=n.descriptor.fill.name,0!=r.shapeURI.length&&r.fillURI){e.next=19;break}return e.next=16,dn(n);case 16:o=e.sent,0==r.shapeURI.length&&(Array.isArray(n.shape)?r.shape=o.shape:r.shape.push(o.shape)),r.fillURI||(r.fill=o.fill);case 19:return a=n.blendMode.replace(/-/g,"_").toUpperCase(),e.abrupt("return",t.format.RasterBrush.create({name:n.name,spacing:n.spacing,scattering:n.scattering,blendMode:t.format.BlendMode[a],rotationMode:t.format.RotationMode[n.rotationMode.name],shapeTexture:r.shape,shapeTextureURI:r.shapeURI,fillTexture:r.fill,fillTextureURI:r.fillURI,fillWidth:n.fillTextureSize.width,fillHeight:n.fillTextureSize.height,randomizeFill:n.randomizeFill}));case 21:case"end":return e.stop()}}),e)}))),function(t){return r.apply(this,arguments)})},{key:"decodeBrushGL",value:function(e){var n,r;if(e.shapeTextureURI.length>0)n=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map((function(t){return{name:t}}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");n=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map((function(t){return{value:t}}))}if(e.fillTextureURI)r={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");r={value:e.fillTexture}}return new Pi(e.name,n,r,{spacing:e.spacing,scattering:e.scattering,blendMode:xi[t.format.BlendMode[e.blendMode]],rotationMode:Pi.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}},{key:"encodeView",value:function(e){return t.format.View.create({name:e.name,tree:this.encodeNodeTree(e)})}},{key:"decodeView",value:function(e,n,r){var i=e.tree.first,o=i.type==t.format.NodeType.STROKE_GROUP?Mo.Type.STROKE:Mo.Type.SENSOR_DATA,a=i.type==t.format.NodeType.STROKE_GROUP?n.strokes:n.sensorData;if(!n.views[e.name]||n.views[e.name].tree.id!=e.tree[0].id){var s=n.createView(e.name,o,i.name,r);this.decodeNodeTree(s,e.tree.slice(1),a)}}},{key:"encodeNodeTree",value:function(t){var e=[];return e.push(this.encodeNode(t.type,t.tree,0)),this.addChildren(e,t,t.tree.children,1),e}},{key:"addChildren",value:function(t,e,n,r){var i=this;n.forEach((function(n){var o=n instanceof Ro?(e.model||e).content.indexOf(n.content):void 0;t.push(i.encodeNode(e.type,n,r,o)),n instanceof Eo&&i.addChildren(t,e,n.children,r+1)}))}},{key:"encodeNode",value:function(e,n,r,i){var o=e.name;return n instanceof Eo&&(o+="_GROUP"),t.format.Node.create({id:n.id,type:t.format.NodeType[o],depth:r,index:i,groupBoundingBox:n.bounds,chunkFromIndex:n.fromPointIndex,chunkToIndex:n.toPointIndex})}},{key:"decodeNodeTree",value:function(e,n,r){var i,o=e.tree,a=0,s=Ao(n);try{for(s.s();!(i=s.n()).done;){for(var u=i.value;a>=u.depth;)o=o.parent,a--;if(u.type==t.format.NodeType.STROKE_GROUP||u.type==t.format.NodeType.SENSOR_DATA_GROUP)o=o.appendChild(e.createGroup(u.id)),u.groupBoundingBox&&(o.bounds=He.create(u.groupBoundingBox.x,u.groupBoundingBox.y,u.groupBoundingBox.width,u.groupBoundingBox.height));else{var c=void 0;(c=u.chunkToIndex>u.chunkFromIndex?e.createElement(r[u.index],u.chunkFromIndex,u.chunkToIndex):e.createElement(r[u.index])).id=u.id,o=o.appendChild(c)}a=u.depth}}catch(t){s.e(t)}finally{s.f()}}},{key:"encodeProperties",value:function(e){return Object.keys(e).map((function(n){return t.format.Property.create({name:n,value:e[n]})}))}},{key:"decodeProperties",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.forEach((function(t){return e[t.name]=t.value})),e}},{key:"encodeKnowledgeGraph",value:function(e){if(e){var n=t.format.TripleStore.create({statements:e.statements.map((function(e){return t.format.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object})}))});return this.structure?n:t.encode(n)}}},{key:"decodeKnowledgeGraph",value:function(e){if(e){var n=new fo,r=this.structure?e:t.format.TripleStore.decode(e);return r&&r.statements.forEach((function(t){return n.addTriple(t.subject,t.predicate,t.object)})),n}}},{key:"encodeMat4",value:function(e){if(e)return t.format.Matrix4.create({m00:e[Ce.m00],m01:e[Ce.m01],m02:e[Ce.m02],m03:e[Ce.m03],m10:e[Ce.m10],m11:e[Ce.m11],m12:e[Ce.m12],m13:e[Ce.m13],m20:e[Ce.m20],m21:e[Ce.m21],m22:e[Ce.m22],m23:e[Ce.m23],m30:e[Ce.m30],m31:e[Ce.m31],m32:e[Ce.m32],m33:e[Ce.m33]})}},{key:"decodeMat4",value:function(t){if(t)return Oo.fromValues(t.m00,t.m01,t.m02,t.m03,t.m10,t.m11,t.m12,t.m13,t.m20,t.m21,t.m22,t.m23,t.m30,t.m31,t.m32,t.m33)}},{key:"encodeTool",value:(n=on(nn.mark((function e(n){var r,i,o,a,s,u=arguments;return nn.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},i=u.length>2&&void 0!==u[2]?u[2]:{},o=u.length>3&&void 0!==u[3]?u[3]:xi.SOURCE_OVER,e.t0=t.format.Tool,e.t1=n instanceof Ar?this.encodeBrush2D(n):void 0,!(n instanceof Pi)){e.next=11;break}return e.next=8,this.encodeBrushGL(n);case 8:e.t2=e.sent,e.next=12;break;case 11:e.t2=void 0;case 12:return e.t3=e.t2,e.t4=t.format.PathPointContext.create({statics:this.encodePathPointProperties(i),dynamics:this.encodePathPointSettings(r)}),e.t5={vectorBrush:e.t1,rasterBrush:e.t3,context:e.t4},a=e.t0.create.call(e.t0,e.t5),o!=xi.SOURCE_OVER&&(s=o.replace(/-/g,"_").toUpperCase(),a.blendMode=t.format.BlendMode[s]),e.abrupt("return",t.encode(a));case 18:case"end":return e.stop()}}),e,this)}))),function(t){return n.apply(this,arguments)})},{key:"decodeTool",value:function(e){if(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var n=t.format.Tool.decode(e);return{brush:"vectorBrush"==n.brush?this.decodeBrush2D(n.vectorBrush):this.decodeBrushGL(n.rasterBrush),blendMode:xi[t.format.BlendMode[n.blendMode]],statics:this.decodePathPointProperties(n.context.statics),dynamics:this.decodePathPointSettings(n.context.dynamics)}}}},{key:"encodePathPointProperties",value:function(e){var n=t.format.PathPointProperties.create();for(var r in t.format.PathPointProperties.fields){var i=e[r];isFinite(i)&&("red"!=r&&"green"!=r&&"blue"!=r||(i/=255),n[r]=t.format.Float32.create({value:i}))}return n}},{key:"decodePathPointProperties",value:function(e){if(e){var n={};for(var r in t.format.PathPointProperties.fields){var i=e[r];if(i){var o=i.value;"red"!=r&&"green"!=r&&"blue"!=r||(o=Math.round(255*o)),n[r]=o}}return n}}},{key:"encodePathPointSettings",value:function(e){var n=t.format.PathPointSettings.create();for(var r in t.format.PathPointSettings.fields)e[r]&&!e[r].disabled&&(n[r]=this.encodePropertySettings(r,e[r]));return n}},{key:"decodePathPointSettings",value:function(e){if(e){var n={};for(var r in t.format.PathPointSettings.fields)e[r]&&(n[r]=this.decodePropertySettings(e[r]));return n}}},{key:"encodePropertySettings",value:function(e,n){var r=this,i=function(n){if(n)return t.format.Range.create({min:n.min,max:n.max,remapURI:r.getActionDescriptorName(e,"Remap",n.remap)})};return t.format.PropertySettings.create({value:i(n.value),velocity:i(n.velocity),pressure:i(n.pressure),altitude:i(n.altitude),radiusX:i(n.radiusX),radiusY:i(n.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",n.resolve),dependencies:(n.dependencies||[]).map((function(e){return t.format.InputPropertyType[e.name]}))})}},{key:"getActionDescriptorName",value:function(t,e,n){if(n){if("function"==typeof n)throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."));if("string"==typeof n)return n;if(n.name)return n.name;throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."))}}},{key:"decodePropertySettings",value:function(e){var n={},r=function(t,e){e&&(n[t]={min:e.min,max:e.max,remap:e.remapURI})};return r("value",e.value),r("velocity",e.velocity),r("pressure",e.pressure),r("altitude",e.altitude),r("radiusX",e.radiusX),r("radiusY",e.radiusY),n.resolve=e.resolveURI,e.dependencies.length>0&&(n.dependencies=e.dependencies.map((function(e){return lr.Type[t.format.InputPropertyType[e]]}))),n}}],[{key:"encode",value:function(t){return t.constructor.encode(t).finish()}}]),t}(),No=r((function(t,e){t.exports=function(){function t(t,r,i,o,a){!function t(n,r,i,o,a){for(;o>i;){if(o-i>600){var s=o-i+1,u=r-i+1,c=Math.log(s),h=.5*Math.exp(2*c/3),l=.5*Math.sqrt(c*h*(s-h)/s)*(u-s/2<0?-1:1);t(n,r,Math.max(i,Math.floor(r-u*h/s+l)),Math.min(o,Math.floor(r+(s-u)*h/s+l)),a)}var f=n[r],d=i,p=o;for(e(n,i,r),a(n[o],f)>0&&e(n,i,o);d<p;){for(e(n,d,p),d++,p--;a(n[d],f)<0;)d++;for(;a(n[p],f)>0;)p--}0===a(n[i],f)?e(n,i,p):e(n,++p,o),p<=r&&(i=p+1),r<=p&&(o=p-1)}}(t,r,i||0,o||t.length-1,a||n)}function e(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function n(t,e){return t<e?-1:t>e?1:0}var r=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function i(t,e,n){if(!n)return e.indexOf(t);for(var r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function o(t,e){a(t,0,t.children.length,e,t)}function a(t,e,n,r,i){i||(i=p(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o=e;o<n;o++){var a=t.children[o];s(i,t.leaf?r(a):a)}return i}function s(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function u(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function h(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function l(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function d(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(e,n,r,i,o){for(var a=[n,r];a.length;)if(!((r=a.pop())-(n=a.pop())<=i)){var s=n+Math.ceil((r-n)/i/2)*i;t(e,s,n,r,o),a.push(n,s,s,r)}}return r.prototype.all=function(){return this._all(this.data,[])},r.prototype.search=function(t){var e=this.data,n=[];if(!d(t,e))return n;for(var r=this.toBBox,i=[];e;){for(var o=0;o<e.children.length;o++){var a=e.children[o],s=e.leaf?r(a):a;d(t,s)&&(e.leaf?n.push(a):f(t,s)?this._all(a,n):i.push(a))}e=i.pop()}return n},r.prototype.collides=function(t){var e=this.data;if(!d(t,e))return!1;for(var n=[];e;){for(var r=0;r<e.children.length;r++){var i=e.children[r],o=e.leaf?this.toBBox(i):i;if(d(t,o)){if(e.leaf||f(t,o))return!0;n.push(i)}}e=n.pop()}return!1},r.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},r.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},r.prototype.clear=function(){return this.data=p([]),this},r.prototype.remove=function(t,e){if(!t)return this;for(var n,r,o,a=this.data,s=this.toBBox(t),u=[],c=[];a||u.length;){if(a||(a=u.pop(),r=u[u.length-1],n=c.pop(),o=!0),a.leaf){var h=i(t,a.children,e);if(-1!==h)return a.children.splice(h,1),u.push(a),this._condense(u),this}o||a.leaf||!f(a,s)?r?(n++,a=r.children[n],o=!1):a=null:(u.push(a),c.push(n),n=0,r=a,a=a.children[0])}return this},r.prototype.toBBox=function(t){return t},r.prototype.compareMinX=function(t,e){return t.minX-e.minX},r.prototype.compareMinY=function(t,e){return t.minY-e.minY},r.prototype.toJSON=function(){return this.data},r.prototype.fromJSON=function(t){return this.data=t,this},r.prototype._all=function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},r.prototype._build=function(t,e,n,r){var i,a=n-e+1,s=this._maxEntries;if(a<=s)return o(i=p(t.slice(e,n+1)),this.toBBox),i;r||(r=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,r-1))),(i=p([])).leaf=!1,i.height=r;var u=Math.ceil(a/s),c=u*Math.ceil(Math.sqrt(s));y(t,e,n,c,this.compareMinX);for(var h=e;h<=n;h+=c){var l=Math.min(h+c-1,n);y(t,h,l,u,this.compareMinY);for(var f=h;f<=l;f+=u){var d=Math.min(f+u-1,l);i.children.push(this._build(t,f,d,r-1))}}return o(i,this.toBBox),i},r.prototype._chooseSubtree=function(t,e,n,r){for(;r.push(e),!e.leaf&&r.length-1!==n;){for(var i=1/0,o=1/0,a=void 0,s=0;s<e.children.length;s++){var u=e.children[s],c=h(u),l=(f=t,d=u,(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-c);l<o?(o=l,i=c<i?c:i,a=u):l===o&&c<i&&(i=c,a=u)}e=a||e.children[0]}var f,d;return e},r.prototype._insert=function(t,e,n){var r=n?t:this.toBBox(t),i=[],o=this._chooseSubtree(r,this.data,e,i);for(o.children.push(t),s(o,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)},r.prototype._split=function(t,e){var n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);var a=this._chooseSplitIndex(n,i,r),s=p(n.children.splice(a,n.children.length-a));s.height=n.height,s.leaf=n.leaf,o(n,this.toBBox),o(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(n,s)},r.prototype._splitRoot=function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},r.prototype._chooseSplitIndex=function(t,e,n){for(var r,i,o,s,u,c,l,f=1/0,d=1/0,p=e;p<=n-e;p++){var y=a(t,0,p,this.toBBox),v=a(t,p,n,this.toBBox),m=(i=y,o=v,s=Math.max(i.minX,o.minX),u=Math.max(i.minY,o.minY),c=Math.min(i.maxX,o.maxX),l=Math.min(i.maxY,o.maxY),Math.max(0,c-s)*Math.max(0,l-u)),g=h(y)+h(v);m<f?(f=m,r=p,d=g<d?g:d):m===f&&g<d&&(d=g,r=p)}return r||n-e},r.prototype._chooseSplitAxis=function(t,e,n){var r=t.leaf?this.compareMinX:u,i=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)},r.prototype._allDistMargin=function(t,e,n,r){t.children.sort(r);for(var i=this.toBBox,o=a(t,0,e,i),u=a(t,n-e,n,i),c=l(o)+l(u),h=e;h<n-e;h++){var f=t.children[h];s(o,t.leaf?i(f):f),c+=l(o)}for(var d=n-e-1;d>=e;d--){var p=t.children[d];s(u,t.leaf?i(p):p),c+=l(u)}return c},r.prototype._adjustParentBBoxes=function(t,e,n){for(var r=n;r>=0;r--)s(e[r],t)},r.prototype._condense=function(t){for(var e=t.length-1,n=void 0;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children).splice(n.indexOf(t[e]),1):this.clear():o(t[e],this.toBBox)},r}()})),Lo=function(){function t(n){e(this,t),this.tree=n,this.attach()}return I(t,[{key:"attach",value:function(){var t=this;"loading"==document.readyState?addEventListener("DOMContentLoaded",(function(e){return t.attach()})):(this.canvas=document.getElementById("rbush"),this.ctx=this.canvas.getContext("2d"))}},{key:"refresh",value:function(e){var n=this,r=[];t.allocateSegments(r,this.tree.data,0),this.ctx.clearRect(0,0,this.canvas.width+1,this.canvas.height+1);for(var i=function(t){var e=r[t];e.hulls?e.hulls.forEach((function(t){return n.drawShape(t,e.color)})):n.drawRect(e.bounds,e.color)},o=r.length-1;o>=0;o--)i(o)}},{key:"drawRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.from(128,128,128,.3);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.strokeRect(t.left,t.top,t.width,t.height)}},{key:"fillRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.from(128,128,128,.3);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.fillRect(t.left,t.top,t.width,t.height)}},{key:"fillPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:A.BLACK;this.ctx.fillStyle="rgba(".concat(n.red,", ").concat(n.green,", ").concat(n.blue,", ").concat(n.alpha,")"),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}},{key:"drawShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.from(139,0,139,.5);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.stroke()}},{key:"fillShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:A.from(236,189,50,.6);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.fill()}},{key:"drawPath",value:function(t){var e=this;"number"==typeof t[0]&&(t=[t]),this.ctx.beginPath(),t.forEach((function(t){e.ctx.moveTo(t[0],t[1]);for(var n=2;n<t.length;n+=2)e.ctx.lineTo(t[n],t[n+1]);e.ctx.closePath()}))}},{key:"drawRange",value:function(t){var e=this;t.forEach((function(t){return e.drawRect(t.bounds,A.fromHex("#800080"))}))}},{key:"drawIntersection",value:function(t,e){var n=this;this.drawShape(t,A.fromHex("#ffc0cb")),e.forEach((function(e){n.fillShape(e.shape,A.fromHex("#ffff00"));var r=en.intersection(e.shape,t);if(r){var i=r.toPath2D();n.fillShape(i,A.BLACK)}}))}},{key:"drawSelection",value:function(t,e,n){this.fillRect(t),this.fillShape(e,A.from(139,0,139,.5)),this.fillShape(n)}}],[{key:"allocateSegments",value:function(e,n,r){if(n){if(n.bounds){var i=n;1==n.depth?i.color=A.RED:2==n.depth?i.color=A.BLUE:3==n.depth?i.color=A.RED:4==n.depth?i.color=A.GREEN:n.depth,e.push(i)}if(n.children)if(10!==r)for(var o=0;o<n.children.length;o++)t.allocateSegments(e,n.children[o],r+1);else console.warn("depth 10")}}},{key:"getInstance",value:function(e){return t.instance||(t.instance=new t(e)),t.instance}}]),t}();function _o(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Bo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(_o()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;e(this,i);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(t=r.call.apply(r,[this].concat(o))).detachCanvas(),t}return I(i,[{key:"toBBox",value:function(t){return{minX:t.bounds.left,minY:t.bounds.top,maxX:t.bounds.right,maxY:t.bounds.bottom}}},{key:"compareMinX",value:function(t,e){return t.bounds.x-e.bounds.x}},{key:"compareMinY",value:function(t,e){return t.bounds.y-e.bounds.y}},{key:"search",value:function(t){return jr(c(i.prototype),"search",this).call(this,{minX:t.left,minY:t.top,maxX:t.right,maxY:t.bottom})}},{key:"find",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.data,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(e){if(e.stroke){var i=!0;Object.keys(t).forEach((function(n){i=i&&e[n]==t[n]})),i&&r.push(e)}if(e.children){if(6!==n){for(var o=0;o<e.children.length;o++)this.find(t,e.children[o]||null,n+1,r);return r}console.warn("depth 6")}}}},{key:"attachCanvas",value:function(){this.canvas=Lo.getInstance(this)}},{key:"detachCanvas",value:function(){var t=this;this.canvas={},Object.getOwnPropertyNames(Lo.prototype).filter((function(t){return!["constructor","attach"].includes(t)})).forEach((function(e){t.canvas[e]=function(){}}))}}]),i}(No),Fo=function(){function t(){e(this,t),this.tree=new Bo,this.strokes={},this.brushAppliers={},this.nodes={}}return I(t,[{key:"add",value:function(t){if(!(t.brush instanceof Pi)){this.strokes[t.id]=t;var e=this.buildStrokeSegments(t);this.load(e)}}},{key:"buildStrokeSegments",value:function(t){var e=[];this.nodes[t.id]=e;for(var n=0;n<t.segmentsCount;n++){var r=this.buildStrokeSegment(t,n);e.push(r)}return e}},{key:"buildStrokeSegment",value:function(t,e){if(e<0||e>=t.segmentsCount)throw new Error("Invalid index ".concat(e," found. Ensure that index range is {0, ").concat(t.segmentsCount-1,"}."));var n=.166666666666,r=t.getSegment(e),i=r.getPoint(0),o=r.getPoint(1),a=r.getPoint(2),s=r.getPoint(3),u=-n*i.x+o.x+n*a.x,c=-n*i.y+o.y+n*a.y,h=+n*o.x+a.x-n*s.x,l=+n*o.y+a.y-n*s.y,f=o.asArray(t.layout).concat(a.asArray(t.layout)),d=new _r(t.layout,f,t.pointProps),p=this.getBrushApplier(t.id).get(d),y=He.ofPolygon(p.first),v=He.ofPolygon(p.last),m=Math.max(y.width,v.height),g=Math.max(y.height,v.height),b=Math.max(m,g),x=He.create(u-b/2,c-g/2,b,b),E=He.create(h-b/2,l-g/2,b,b),w=y.union(v).union(x).union(E);return{strokeID:t.id,segmentIndex:e,bounds:w,point:r.getPoint(0),spline:r,shapesPath:p,depth:1}}},{key:"getStroke",value:function(t){return this.strokes[t]}},{key:"getBrushApplier",value:function(t){var e=this.strokes[t].brush;return this.brushAppliers[e.name]||(this.brushAppliers[e.name]=new ri(e)),this.brushAppliers[e.name]}},{key:"getNodes",value:function(t){return this.nodes[t]}},{key:"reload",value:function(t){this.unload(this.nodes[t.id]);var e=this.buildStrokeSegments(t);this.load(e)}},{key:"remove",value:function(t){this.unload(this.nodes[t.id]),delete this.nodes[t.id],delete this.strokes[t.id]}},{key:"update",value:function(t){var e=this,n={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(t).forEach((function(r){var i=e.strokes[r],o=e.split(i,t[r]);o&&(n.intersected.push({stroke:i,strokes:o}),n.dirtyArea=i.bounds.union(n.dirtyArea),t[r].intervals.forEach((function(t,e){t.inside&&n.selected.push(o[e])})))})),n}},{key:"split",value:function(t,e){var n=this,r=e.intervals,i=e.dropoutSegments;if(0==r.length)return[];var o=t.split(r);if(o){o.forEach((function(t){n.strokes[t.id]=t}));var a=[],s=[];return r.map((function(e){return n.nodes[t.id].slice(e.fromNodeIndex,e.toNodeIndex+1)})).forEach((function(e,i){var u,c,h=o[i],l=r[i].fromIndex,f=r[i].toIndex-3;if(h.ts!=e.first.spline.ts){var d=e.first.segmentIndex,p=n.nodes[t.id].filter((function(t){return t.segmentIndex==d}));e=e.filter((function(t){return t.segmentIndex!=d})),d>=l&&(u=n.buildStrokeSegment(h,d-l),a.push(u)),s.push.apply(s,k(p))}if(e.length>0&&h.tf!=e.last.spline.tf){var y=e.last.segmentIndex,v=n.nodes[t.id].filter((function(t){return t.segmentIndex==y}));e=e.filter((function(t){return t.segmentIndex!=y})),y<=f&&(c=n.buildStrokeSegment(h,y-l),a.push(c)),s.push.apply(s,k(v))}e.forEach((function(t){t.strokeID=h.id,t.segmentIndex-=l})),u&&e.unshift(u),c&&e.push(c),n.nodes[h.id]=e})),i.push.apply(i,s),this.unload(i),this.load(a),delete this.nodes[t.id],delete this.strokes[t.id],o}}},{key:"replace",value:function(t,e){var n=this;e.forEach((function(t){return n.add(t)})),this.remove(t)}},{key:"load",value:function(t){0!=t.length&&(this.tree.load(t),this.tree.canvas.refresh())}},{key:"updateTree",value:function(t,e){this.tree.remove(t),this.nodes[t.strokeID].replace(t,e)}},{key:"unload",value:function(t){var e=this;Array.isArray(t)||(t=[t]),t.forEach((function(t){return e.tree.remove(t)})),this.tree.canvas.refresh()}},{key:"search",value:function(t){return this.tree.search(t)}},{key:"reset",value:function(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas.refresh()}}]),t}(),Uo=function(){function t(n){e(this,t),this.interpolator=n}return I(t,[{key:"build",value:function(t,e,n){var r=this;return this.context=t,this.pathContext=new tn(n),this.result={},this.holes=[],(e=e.unique()).sort(On.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),e.forEach((function(t){r.isHolePart(t)?r.update(t):r.add(t)})),this.narrow(),this.result}},{key:"add",value:function(t){this.holes=this.result[t.strokeID],this.holes||(this.holes=[],this.result[t.strokeID]=this.holes);var e=t.segmentIndex,n=t.segmentIndex,r=this.context.getNodes(t.strokeID).indexOf(t);this.holes.push({fromIndex:e,toIndex:n,fromTValue:t.prevT,toTValue:t.nextT,fromNodeIndex:r,toNodeIndex:r,strokeID:t.strokeID,nodes:[t]})}},{key:"update",value:function(t){var e=this.holes.last;e.toIndex=t.segmentIndex,e.toTValue=t.nextT,e.toNodeIndex=this.context.getNodes(t.strokeID).indexOf(t),e.nodes.push(t)}},{key:"isHolePart",value:function(t){var e=this.holes.last;return!(!e||e.strokeID!=t.strokeID)&&(t.segmentIndex==e.toIndex&&t.prevT<=e.toTValue||t.segmentIndex==e.toIndex+1&&1==e.toTValue&&0==t.prevT)}},{key:"narrow",value:function(){var t=this;this.holes.forEach((function(e){var n,r=e.nodes.first,i=e.nodes.last;n=e.nodes.length<=2?t.extractT(r,"sf",r.prevT,i.nextT):{s:t.extractT(r,"s",r.prevT,r.nextT).s,f:t.extractT(i,"f",i.prevT,i.nextT).f},r.ts=n.s,i.tf=n.f,e.fromTValue=n.s,e.toTValue=n.f}))}},{key:"extractT",value:function(t,e,n,r){if(n==r)return{};var i,o={},a=e.startsWith("s");this.interpolator.spacing=.1;for(var s=new Nr(t.spline.layout,t.spline.points,t.spline.pointProps,n,r),u=this.interpolator.get(s),c=0;c<u.length;c++){var h=u.getPoint(c),l=this.context.getBrushApplier(t.strokeID).applyBrush(h);if(en.intersection(this.pathContext,l)){if(a){if(o.s=i,e.endsWith("f")){i=u.getPointT(c),a=!1;continue}break}i=u.getPointT(c)}else if(a&&(i=u.getPointT(c)),!a&&(o.f=i,i))break}if(isNaN(o.s)&&(o.s=n),isNaN(o.f)&&(o.f=r),o.s==o.f){var f=u.tValues.indexOf(o.s);0==f?o.f=u.tValues[f+1]:o.s=u.tValues[f-1]}return o}}]),t}();function jo(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Yo(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Yo(t,e)}(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i,o=!0,a=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function Yo(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Xo=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Mode.WHOLE_STROKE;e(this,t),this.mode=n,this.splineInterpolator=new Qr(1,8,!1),this.splineInterpolator.keepTValues=!0,this.segmentInterpolator=new Qr(1,8,!0),this.segmentInterpolator.keepTValues=!0,this.convexHullChainProducer=new oi,this.holesBuilder=new Uo(this.segmentInterpolator)}return I(t,[{key:"updateSegmentation",value:function(e){var n,r=[],i=!1,o=jo(e);try{for(o.s();!(n=o.n()).done;){var a=n.value;if(0!=a.length){var s=He.ofPolygon(a),u=this.context.search(s);if(u.length>0){var c,h,l=[],f=jo(u);try{for(f.s();!(h=f.n()).done;){var d=h.value;if(1==d.depth){for(var p=[],y=this.splineInterpolator.get(d.spline),v=this.context.getBrushApplier(d.strokeID).get(y),m=0;m<y.length-1;m++){var g=[v[m],v[m+1]];p.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:m,bounds:He.ofPolygons(g),point:y.getPoint(m),spline:new Nr(d.spline.layout,d.spline.points,d.spline.pointProps,y.getPointT(m),y.getPointT(m+1)),shapesPath:g,depth:2})}this.context.updateTree(d,p),l=l.concat(p),i=!0}else if(2==d.depth){this.convexHullChainProducer.reset();var b=this.convexHullChainProducer.get(d.shapesPath);d.depth=3,d.hulls=b,this.context.tree.canvas.refresh(),i=!0}else if(3==d.depth){if(en.intersection(d.hulls,a))if(this.mode==t.Mode.PARTIAL_STROKE){var x=[];this.segmentInterpolator.spacing=1;for(var E=this.segmentInterpolator.get(d.spline),w=this.context.getBrushApplier(d.strokeID).get(E),R=0;R<E.length;R++){var P=He.ofPolygon(w[R]),k=P,M=d.spline,T=E.getPointT(R),I=E.getPointT(R-1),S=E.getPointT(R+1);if(isNaN(I)&&(I=d.spline.ts),isNaN(S)&&(S=d.spline.tf),P.width!=P.height){var A=Math.max(P.width,P.height);P=He.create(P.center.x-A/2,P.center.y-A/2,A,A)}x.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:d.splineIndex,pointIndex:R,bounds:P,point:E.getPoint(R),spline:M,prevT:I,t:T,nextT:S,shape:w[R],shapeBounds:k,depth:4})}this.context.updateTree(d,x),l=l.concat(x),i=!0}else r.push(d)}else He.intersect(s,d.bounds)&&(d.affected=!0),r.push(d)}}catch(t){f.e(t)}finally{f.f()}if(l.length>0&&this.context.load(l),i)return this.updateSegmentation(e);(c=this.nodes).push.apply(c,r)}}}}catch(t){o.e(t)}finally{o.f()}}},{key:"createIntervals",value:function(t,e){var n=this,r={intersected:{},selected:[]};if(0==e.length)return r;var i=this.holesBuilder.build(this.context,t,e),o=function(t){var e=n.context.getNodes(t),o=[],a=[];r.intersected[t]={intervals:o,dropoutSegments:a},i[t].forEach((function(n,s){var u,c=0==n.fromIndex&&n.fromTValue==e.first.ts,h=n.toIndex==e.last.segmentIndex&&n.toTValue==e.last.tf;if(c&&h)return r.selected.push(t),void delete r.intersected[t];a.push.apply(a,k(n.nodes)),c?u={fromIndex:n.toIndex,fromTValue:n.toTValue,fromNodeIndex:n.toNodeIndex}:h?(o.last||o.push({fromIndex:0,fromTValue:e.first.spline.ts,fromNodeIndex:0}),o.last.toIndex=n.fromIndex+3,o.last.toTValue=n.fromTValue,o.last.toNodeIndex=n.fromNodeIndex):o.last?(o.last.toIndex=n.fromIndex+3,o.last.toTValue=n.fromTValue,o.last.toNodeIndex=n.fromNodeIndex,u={fromIndex:n.toIndex,fromTValue:n.toTValue,fromNodeIndex:n.toNodeIndex}):(o.push({fromIndex:0,fromTValue:e.first.spline.ts,toIndex:n.fromIndex+3,toTValue:n.fromTValue,fromNodeIndex:0,toNodeIndex:n.fromNodeIndex}),u={fromIndex:n.toIndex,fromTValue:n.toTValue,fromNodeIndex:n.toNodeIndex}),u&&o.push(u),s!=i[t].length-1||h||(o.last.toIndex=e.last.segmentIndex+3,o.last.toTValue=e.last.spline.tf,o.last.toNodeIndex=e.length-1);var l=[];o.forEach((function(t){if(1==t.fromTValue){var n=e.filter((function(e){return e.segmentIndex==t.fromIndex+1})).first,r=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push.apply(a,k(r)),t.fromIndex++,t.fromTValue=0,t.fromNodeIndex=e.indexOf(n)}if(0==t.toTValue){var i=t.toIndex-3,o=e.filter((function(t){return t.segmentIndex==i-1})).last,s=e.filter((function(t){return t.segmentIndex==i}));a.push.apply(a,k(s)),t.toIndex--,t.toTValue=1,t.toNodeIndex=e.indexOf(o)}if(t.toIndex-t.fromIndex<3)l.push(t);else if(t.toIndex-t.fromIndex==3&&t.fromTValue==t.toTValue){var u=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push.apply(a,k(u)),l.push(t)}})),l.forEach((function(t){o.remove(t)}))}))};for(var a in i)o(a);return r}},{key:"reset",value:function(t){if(!t)throw new Error("Required spatial context not found");this.context=t,this.nodes=[]}}]),t}();function Go(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Xo.createEnum("Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);var zo=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Go()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),r.call(this,t)}return I(i,[{key:"intersect2",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,t)}},{key:"intersect",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(t),this.mode==i.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,t):{intersected:{},selected:this.nodes.map((function(t){return t.strokeID}))}}}]),i}(Xo);function Vo(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ho=function(t){o(i,t);var n,r=(n=i,function(){var t,e=c(n);if(Vo()){var r=c(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),r.call(this,t)}return I(i,[{key:"select",value:function(t){var e=this;if(!this.context)throw new Error("Required spatial context not found");var n={intersected:{},selected:[]},r=t.bounds,o=en.createClipperPath(t.spline);setTimeout((function(){return e.context.tree.canvas.drawSelection(r,t.points,t.path.first)}),1e3);var a=this.context.search(r),s=this.nodes.map((function(t){return t.strokeID})).unique(),u=a.map((function(t){return t.strokeID})).unique().filter((function(t){return!s.includes(t)}));if(this.mode==i.Mode.PARTIAL_STROKE){var c=this.createIntervals(this.nodes,t.path);n=c,s.forEach((function(t){var n=[];c.intersected[t]&&(n=c.intersected[t].intervals),n.forEach((function(n){var r=e.context.getNodes(t)[n.fromNodeIndex];n.inside=en.containsPoint(o,r.point)}))}))}else n.selected=s;return u.forEach((function(t){var r=e.context.getNodes(t)[0];en.containsPoint(o,r.point)&&n.selected.push(t)})),n}}]),i}(Xo);return t.BlendMode=xi,t.Brush2D=Ar,t.BrushApplier=ri,t.BrushGL=Pi,t.BrushPrototype=Tr,t.Color=A,t.ConvexHullChainProducer=oi,t.ConvexHullProducer=Fr,t.Drag=Wn,t.Environment=sr,t.GLTools=Ri,t.InkBuilder=fi,t.InkBuilderAsync=gi,t.InkCanvas2D=Fi,t.InkCanvasGL=co,t.InkCodec=Do,t.InkController=Nn,t.InkInputProvider=cr,t.InkModel=Mo,t.InputContext=mr,t.InputDevice=wr,t.InputListener=Bn,t.InterpolatedSpline=_r,t.Intersector=zo,t.MatTools=An,t.OffscreenCanvasGL=Xi,t.PathPoint=Ye,t.PathPointContext=Cr,t.PathProducer=Xr,t.PathSegment=Dr,t.PinchEvent=Gn,t.PointerData=Rr,t.Poly=en,t.PolygonMerger=si,t.PolygonSimplifier=ci,t.Rect=He,t.Resize=qn,t.Scalar=Kn,t.Selector=Ho,t.SemanticTriple=lo,t.SensorChannel=lr,t.SensorChannelsContext=dr,t.SensorContext=yr,t.SensorData=br,t.SensorStream=xr,t.ShapeFactory=Pr,t.Smoother=Hr,t.SpatialContext=Fo,t.Spline=Nr,t.SplineInterpolator=Qr,t.SplineProducer=qr,t.Stroke=Si,t.StrokeRenderer2D=Ui,t.StrokeRendererGL=ho,t.TextTable=Cn,t.Transformer=Vn,t.TripleStore=fo,t.TypedArrayCodec=kr,t.URIResolver=S,t.config=b,t.fsx=yn,t.mat4x=Ue,t.math=gn,t.utils=On,t}({});
